<!DOCTYPE html>
<html>
  <head>
    

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<!-- The above 3 meta tags *must* come first in the head; any other head
      content must come *after* these tags -->

<meta name="description"
      content="This is Julio Merino's homepage.  This site is primarily my personal blog and, secondarily, a gateway to my presence in the web.
">
<meta name="author" content="Julio Merino">

<meta content="http://julio.meroh.net/page27/" property="og:url">

<link rel="canonical" href="http://julio.meroh.net/page27/">
<link rel="alternate" type="application/rss+xml" title="Julio Merino" href="http://julio.meroh.net/feed.xml" />

<link rel="stylesheet" href="/css/main.css">

<!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
<!--[if lt IE 9]>
  <script src="/js/html5shiv-3.7.2.min.js"></script>
  <script src="/js/respond-1.4.2.min.js"></script>
<![endif]-->

    <title>Julio Merino</title>
    <meta content="Julio Merino" property="og:title">
  </head>

  <body>
    <header class="site-header">

<nav class="navbar navbar-default navbar-fixed-top">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed"
              data-toggle="collapse" data-target="#navbar"
              aria-expanded="false" aria-controls="navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">Julio Merino</a>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        
          
            
              
                <li><a class="page-link"
                href="/about/"
                >About</a></li>
              
            
          
        
          
            
          
        
          
            
          
        
          
            
              
                <li><a class="page-link"
                href="/essays/"
                >Essays</a></li>
              
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
              
                <li><a class="page-link"
                href="/software/"
                >Software</a></li>
              
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
              
                <li><a class="page-link"
                href="/work/"
                >Work</a></li>
              
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
      </ul>

      <form class="navbar-form navbar-right" method="get" role="search"
            action="http://www.google.com/search">
          <div class="form-group">
            <input type="text" name="query" class="form-control"
                   placeholder="Search">
            <input type="hidden" name="sitesearch" value="http://julio.meroh.net">
          </div>
          <button type="submit" value="Search" class="btn btn-default">
            <span class="glyphicon glyphicon-search" aria-hidden="true"></span>
          </button>
      </form>
    </div>
  </div>
</nav>

</header>


    <!-- We need these to be present early during load so we can avoid hiding
     or showing elements once the page has already been rendered. -->
<script src="/js/jquery-1.11.2.min.js">
</script>
<script src="/js/js.cookie-2.1.1.min.js">
</script>

<script>
  function loadMarketing() {
      var cookie = Cookies.get("marketing-visible");
      if (cookie === undefined || cookie === "true") {
        toggleMarketing(true);
      } else {
        toggleMarketing(false);
      }
  }

  function toggleMarketing(action) {
    if (action) {
      $("#collapse-row").show();
      $("#buttons").show();
      $("#expand-row").hide();
      Cookies.set("marketing-visible", "true", {path: ""});
    } else {
      $("#expand-row").show();
      $("#buttons").hide();
      $("#collapse-row").hide();
      Cookies.set("marketing-visible", "false", {path: ""});
    }
  }
</script>

<div class="page-header">
  <div class="container">
    <h1>Julio Merino</h1>

    <p>Software artist.  Writer aficionado.  Open source enthusiast.
    Runner.  Father of two.<br/>
    <strong>Currently:</strong> Senior Software Engineer at Google,
    New York City.</p>

    <div class="marketing row" style="display: none" id="buttons">
      <div class="col-md-3">
        <a href="/essays/">
          <span class="glyphicon glyphicon-print" aria-hidden="true"></span>
        </a>
        <h2>Author</h2>

        <p>Writer by hobby, typically covering programming topics.
        No fiction.  Find below for the most recent posts or
        open this section for general highlights.</p>
      </div>

      <div class="col-md-3">
        <a href="/software/">
          <span class="glyphicon glyphicon-cog" aria-hidden="true"></span>
        </a>
        <h2>Developer</h2>

        <p>Author of various Open Source projects and contributor to many
        more.  BSD enthusiast.  Motto: production software can be
        beautiful.</p>
      </div>

      <div class="col-md-3">
        <a href="/work/">
          <span class="glyphicon glyphicon-briefcase" aria-hidden="true"></span>
        </a>
        <h2>Engineer</h2>

        <p>Senior Software Engineer (and, previously, Senior Site Reliability
        Engineer) at Google in New York City.</p>
      </div>

      <div class="col-md-3">
        <a href="/about/">
          <span class="glyphicon glyphicon-envelope" aria-hidden="true"></span>
        </a>
        <h2>Social</h2>

        <p>Reachable via all the traditional contact mechanisms and the major
        social networks.  See my about page for all the references.</p>
      </div>
    </div>

    <div class="row" style="display: none" id="collapse-row">
      <p class="text-center"><small>
        <a href="javascript:toggleMarketing(false)">
          <span class="glyphicon glyphicon-chevron-up"
                aria-hidden="true"></span>
          Collapse
          <span class="glyphicon glyphicon-chevron-up"
                aria-hidden="true"></span>
        </a>
      </small></p>
    </div>

    <div class="row" style="display: none" id="expand-row">
      <p class="text-center"><small>
        <a href="javascript:toggleMarketing(true)">
          <span class="glyphicon glyphicon-chevron-down"
                aria-hidden="true"></span>
          Expand
          <span class="glyphicon glyphicon-chevron-down"
                aria-hidden="true"></span>
        </a>
      </small></p>
    </div>

    <!-- All the rows above were loaded hidden, so display only the needed
         ones now.  This ensures that we are able to render the page
         sequentially and prevent strange jumps during rendering. -->
    <script>loadMarketing();</script>
  </div>
</div>

<div class="container">
  <div class="row">
    <div class="col-md-9">
      

<ul class="post-list">
  
    <li>
      <h2>
        <a class="post-link" href="/2011/04/kyua-weekly-status-report.html">Kyua: Weekly status report</a>
      </h2>
      <span class="post-meta"><!-- From http://alanwsmith.com/jekyll-liquid-date-formatting-examples -->

April

3rd,
  
2011
at
19:00 UTC
        &middot;
        <a href="/2011/04/kyua-weekly-status-report.html#disqus_thread">
          <span class="disqus-comment-count"
                data-disqus-url="http://julio.meroh.net/2011/04/kyua-weekly-status-report.html">Comments</span>
        </a>
      </span>
      
      <p>
        This week's work has been quite active on the ATF front but not so much in the Kyua one. I keep being incredibly busy on the weekends (read: traveling!) so it's hard to get any serious development work done.What has happened?Finally tracked down and fixed some random atf-run crashes that had been hunting the NetBSD test suite for months (see PR bin/44176). The fix is in reality an ugly workaround for the fact that a work directory cannot be considered "stable" even after the test case terminates. There may be dying processes around that touch the work directory contents, and the cleanup code in atf-run was not coping well with those. As it turns out, this problem also exists in Kyua (even though it's not as pronounced because arbitrary failures when running a test case do not crash the runtime engine) so I filed issue 17 to address it.Released ATF 0.13 and imported it both to NetBSD-current and pkgsrc. As a side note, Kyua requires the new features in this release, so putting it out there is a requirement to release Kyua 0.1. This new release does not have a big effect on NetBSD though, because the copy of ATF in NetBSD has been constantly receiving cherry-picks of the upstream fixes.Replaced several TODO items in the Kyua code with proper calls to the logging subsystem. These TODO items were referring to conditions in the code that should not happen, but for which we cannot do any proper recovery (like errors in a destructor). Sure, these could be better signaled as an assertion... but these code paths can be triggered in extremely-tricky conditions and having Kyua crash because of them is not nice (particularly when the side-effects of executing that code paths are non-critical).So, in retrospect, I have fulfilled the goal set past week of releasing ATF 0.13, but I haven't got to the addition of integration tests. Oh well... let's see if this upcoming week provides more spare time.

        <a href="/2011/04/kyua-weekly-status-report.html">[Continue reading]</a>
      </p>
      
    </li>
  
    <li>
      <h2>
        <a class="post-link" href="/2011/03/kyua-weekly-status-report_27.html">Kyua: Weekly status report</a>
      </h2>
      <span class="post-meta"><!-- From http://alanwsmith.com/jekyll-liquid-date-formatting-examples -->

March

27th,
  
2011
at
19:00 UTC
        &middot;
        <a href="/2011/03/kyua-weekly-status-report_27.html#disqus_thread">
          <span class="disqus-comment-count"
                data-disqus-url="http://julio.meroh.net/2011/03/kyua-weekly-status-report_27.html">Comments</span>
        </a>
      </span>
      
      <p>
        This has been a slow week. In the previous report, I set the goal of&nbsp;getting Kyua to run the NetBSD test suite accurately (i.e. to report the same results as atf-run), and this has been accomplished. Actually, the changes required in Kyua to make this happen were minimal, but I got side-tracked fixing issues in NetBSD itself (both in the test suite and in the kernel!). So, the things done:Fixed Kyua to correctly kill any dangling subprocesses of a test case and thus match the behavior of atf-run. This was the only change required to make issue 16 happen: i.e. to get Kyua to report the same results as atf-run for the NetBSD test suite.Based on a suggestion from Antti Kantee, an alternative way to handle this would be to not kill any processes and just report the test case as broken if it fails to clean itself up. The rationale being that the runtime engine can kill dangling subprocesses in 99% of the occasions, but not always. The exception are those subprocesses that change their process group. It'd be better to make all cleanups explicit instead of hiding this corner case, as it can lead to confusion. Addressing this will have to wait though, as it is a pretty invasive change.Before closing issue 16, I want to implement some integration tests for Kyua to ensure that the whole system behaves as we expect (which is what the NetBSD test suite is currently doing implicitly).Kyua is pickier than atf-run: if a cleanup routine of a test case fails or crashes, Kyua will (correctly) report the test case as broken while atf-run will silently ignore this situation. Some NetBSD tests had crashing cleanup parts, so I fixed them.Some test programs in NetBSD were leaving unkilled subprocesses behind. These subprocesses are daemons and thus fall out of the scope of what Kyua can detect and kill during the cleanup phase. I mistakenly tracked down the problem to rump, but Antti Kantee kindly found the real problem in the kernel (not in rump!).As a side effect of processes being left behind, I extended the functionality of pidfile(3) and implemented pid file support in bozohttpd. &nbsp;This is to make the tests that spawn a bozohttpd in the background more robust, by giving them a way to forcibly kill the server during cleanup.These changes are still under review and not committed yet.For the upcoming week, I plan to add some basic integration tests to Kyua and release ATF 0.13. I've been running a NetBSD system with the latest ATF code integrated for a while (because Kyua requires it) and things have been working well.

        <a href="/2011/03/kyua-weekly-status-report_27.html">[Continue reading]</a>
      </p>
      
    </li>
  
    <li>
      <h2>
        <a class="post-link" href="/2011/03/kyua-weekly-status-report.html">Kyua: Weekly status report</a>
      </h2>
      <span class="post-meta"><!-- From http://alanwsmith.com/jekyll-liquid-date-formatting-examples -->

March

20th,
  
2011
at
15:58 UTC
        &middot;
        <a href="/2011/03/kyua-weekly-status-report.html#disqus_thread">
          <span class="disqus-comment-count"
                data-disqus-url="http://julio.meroh.net/2011/03/kyua-weekly-status-report.html">Comments</span>
        </a>
      </span>
      
      <p>
        These days, I find myself talking about Kyua to "many" people.  In particular, whenever a new feature request for ATF comes in, I promise the requester that the feature will be addressed as part of Kyua.  However, I can imagine that this behavior leaves the requester with mixed feelings: it is nice that the feature will be implemented but, at the same time, it is very hard to know when because the web site of Kyua does not provide many details about its current status.In an attempt to give Kyua some more visibility, I will start posting weekly activity reports in this blog.  These reports will also include any work done on the ATF front, as the two projects are highly related at this point.  I write these reports regularly at work and I feel like it is a pretty good habit: every week, you have to spend some time thinking about what you did for the project and you feel guilty if the list of tasks is ~zero ;-)  It also, as I said, gives more visibility to the work being done so that outsiders know that the project is not being ignored.Before starting with what has happened this week, a bit of context.  I have been traveling like crazy and hosting guests over for the last 2 months.  This has given me virtually no time to work on Kyua but, finally, I have got a chance to do some work this past week.So, what are the news?Implemented the --loglevel command line flag, which closes issue 14.  Kyua now generates run-time logs of its internal activity to aid in postmortem debugging and this flag allows the user to control the verbosity of such logs.Antti Kantee hacked support for atf-run in the NetBSD source tree to dump a stack trace of any crashing test program.  I have backported this code to the upstream ATF code and filed issue 15 to implement this same functionality in Kyua.Fixed a hang in atf-run that made it get stuck when a test case spawned a child processes and atf-run failed to terminate it.  A quick test seems to indicate that Kyua is affected by a similar problem: it does not get stuck but it does not correctly kill the subprocesses.  The problem will be addressed as part of issue 16.Oh, and by the way: Kyua will be presented at BSDCan 2011.My plans for this week are to make Kyua run the full NetBSD test suite without regressions when compared to ATF.  Basically, the results of a test run with Kyua should be exactly the same as those of a test run with ATF.  No dangling processes should be left behind.Lastly, if you are interested in these reports and other Kyua news, you can subscribe to the kyua label feed and, if you want to stay up to date with any changes performed to the code, subscribe to the kyua-log mailing list.

        <a href="/2011/03/kyua-weekly-status-report.html">[Continue reading]</a>
      </p>
      
    </li>
  
    <li>
      <h2>
        <a class="post-link" href="/2011/01/teeny-tiny-review-of-twitterville.html">A teeny tiny review of Twitterville</a>
      </h2>
      <span class="post-meta"><!-- From http://alanwsmith.com/jekyll-liquid-date-formatting-examples -->

January

27th,
  
2011
at
21:12 UTC
        &middot;
        <a href="/2011/01/teeny-tiny-review-of-twitterville.html#disqus_thread">
          <span class="disqus-comment-count"
                data-disqus-url="http://julio.meroh.net/2011/01/teeny-tiny-review-of-twitterville.html">Comments</span>
        </a>
      </span>
      
      <p>
        After about two months, I finally finished reading Twitterville by Shel Israel (@shelisrael).  One of my followers (@drio) asked for a review of the book, so here is my attempt to do so.But first, a quick summary: Twitterville is a book that focuses on the dynamics of Twitter.  It starts by explaining how Twitter works, but that is only a tiny introductory part of the book.  The majority of the contents explain how people and business interact with each other by means of Twitter, and it does so by providing lots of real-life stories.  The stories range from topics as diverse as businesses offering deals, to individuals raising funds for specific causes.The book is easy to read and is well structured, and as you read through it you will realize that the author had to do some major research efforts to collect all the stories that he presents.  I personally enjoyed the first half of the book a lot, but at some point I ran out of time for reading and my interest dropped.  It was hard to pick on reading again because the book becomes quite repetitive after a few chapters; just keep in mind that it is a collection of personal experiences organized by different major topics and you won't be disappointed.Twitterville has changed my view on Twitter.  I have discovered many "use cases" for Twitter that I could not imagine and, as many people do, I used to disregard Twitter as a useless "status updates" system.  Today, however, I have set up several Twitter searches to monitor some topics of my interest and I engage with people that I did not know beforehand.  It kinda feels like a world-wide unorganized chat room to me... but, as the author mentions many times, the way you see and use Twitter is up to you and you alone!

        <a href="/2011/01/teeny-tiny-review-of-twitterville.html">[Continue reading]</a>
      </p>
      
    </li>
  
    <li>
      <h2>
        <a class="post-link" href="/2011/01/injecting-c-functions-into-lua.html">Injecting C++ functions into Lua</a>
      </h2>
      <span class="post-meta"><!-- From http://alanwsmith.com/jekyll-liquid-date-formatting-examples -->

January

17th,
  
2011
at
16:09 UTC
        &middot;
        <a href="/2011/01/injecting-c-functions-into-lua.html#disqus_thread">
          <span class="disqus-comment-count"
                data-disqus-url="http://julio.meroh.net/2011/01/injecting-c-functions-into-lua.html">Comments</span>
        </a>
      </span>
      
      <p>
        The C++ interface to Lua implemented in Kyua exposes a lua::state class that wraps the lower-level lua_State* type. This class completely hides the internal C type of Lua to ensure that all calls that affect the state go through the lua::state class.Things get a bit messy when we want to inject native functions into the Lua environment. These functions follow the prototype represented by the lua_CFunction type:typedef int (*lua_CFunction)(lua_State*);Now, let's consider this code:intawesome_native_function(lua_State* state){    // Uh, we have access to s, so we bypass the lua::state!    ... do something nasty ...    // Oh, and we can throw an exception here...    //with bad consequences.}voidsetup(...){    lua::state state;    state.push_c_function(awesome_native_function);    state.set_global("myfunc");    ... run some script ...}The fact that we must pass a lua_CFunction prototype to the lua_pushcfunction object means that such function must have access to the raw lua_State* pointer... which we want to avoid.What we really want is the caller code to define a function such as:typedef int (*cxx_function)(lua::state&)In an ideal world, the lua::state class would implement a push_cxx_function that took a cxx_function, generated a thin C wrapper and injected such generated wrapper into Lua.  Unfortunately, we are not in an ideal world: C++ does not have high-order functions and thus the "generate a wrapper function" part of the previous proposal does not really work.What we can do instead, though, is to make the creation of C wrappers for these C++ functions trivial. And this is what r42 did.  The approach I took is similar to this overly-simplified (and broken) example:template&lt; cxx_function Function &gt;intwrap_cxx_function(lua_State* state){    try {        lua::state state_wrapper(state);        return Function(state_wrapper);    } catch (...) {        luaL_error(state, "Geez, don't go into C's land!");    }}This template wrapper takes a cxx_function object and generates a corresponding C function at compile time. This wrapper function ensures that C++ state does not propagate into the C world, as that often has catastrophical consequences. (Due to language limitations, the input function must have external linkage.  So no, it cannot be static.)As a result, we can rewrite our original snippet as:intawesome_native_function(lua::state& state){    // See, we cannot access lua_State* now.    ... do something ...    throw std::runtime_error("And we can even do this!");}voidsetup(...){    lua::state state;    state.push_c_function(        wrap_cxx_function);    state.set_global("myfunc");    ... run some script ...}Neat? I think so, but maybe not so much. I'm pretty sure there are cooler ways of achieving the above purpose in a cleaner way, but this one works nicely and has few overhead.

        <a href="/2011/01/injecting-c-functions-into-lua.html">[Continue reading]</a>
      </p>
      
    </li>
  
    <li>
      <h2>
        <a class="post-link" href="/2011/01/error-handling-in-lua-kyua-approach.html">Error handling in Lua: the Kyua approach</a>
      </h2>
      <span class="post-meta"><!-- From http://alanwsmith.com/jekyll-liquid-date-formatting-examples -->

January

14th,
  
2011
at
08:04 UTC
        &middot;
        <a href="/2011/01/error-handling-in-lua-kyua-approach.html#disqus_thread">
          <span class="disqus-comment-count"
                data-disqus-url="http://julio.meroh.net/2011/01/error-handling-in-lua-kyua-approach.html">Comments</span>
        </a>
      </span>
      
      <p>
        About a week ago, I detailed the different approaches I encountered to deal with errors raised by the Lua C API. Later, I announced the new C++ interface for Lua implemented within Kyua. And today, I would like to talk about the specific mechanism I implemented in this library to deal with the Lua errors.The first thing to keep in mind is that the whole purpose of Lua in the context of Kyua is to parse configuration files. This is an infrequent operation, so high performance does not matter: it is more valuable to me to be able to write robust algorithms fast than to have them run at optimal speed. The other key point to consider is that I want Kyua to be able to use prebuilt Lua libraries, which are built as C binaries.The approach I took is to wrap every single unsafe Lua C API call in a "thin" (FSVO thin depending on the case) wrapper that gets called by lua_pcall. Anything that runs inside the wrapper is safe to Lua errors, as they are caught and safely reported to the caller.Lets examine how this works by taking a look at an example: the wrapping of lua_getglobal. We have the following code (copy pasted from the utils/lua/wrap.cpp file but hand-edited for publishing here):static intprotected_getglobal(lua_State* state){    lua_getglobal(state, lua_tostring(state, -1));    return 1;}voidlua::state::get_global(const std::string& name){    lua_pushcfunction(_pimpl->lua_state, protected_getglobal);    lua_pushstring(_pimpl->lua_state, name.c_str());    if (lua_pcall(_pimpl->lua_state, 1, 1, 0) != 0)        throw lua::api_error::from_stack(_pimpl->lua_state,            "lua_getglobal");}The state::get_global method is my public wrapper for the lua_getglobal Lua C API call. This wrapper first prepares the Lua stack by pushing the address of the C function to call and its parameters and then issues a lua_pcall call that executes the C function in a Lua protected environment.In this case, the argument preparation for protected_getglobal is trivial because the lua_getglobal call does not require access to any preexisting values on the Lua stack. Things get much trickier when that happens as in the case of the lua_getglobal wrapper. I'll leave understanding how to do this as an exercise to the reader (but you can cheat by looking at line 154).Anyway. The above looks all very nice and safe and the tests for the state::get_global function, even the ones that intentionally cause a failure, all work fine. So we are good, right? Nope! Unfortunately, the code above is not fully safe to Lua errors.In order to prepare the lua_pcall execution, the code must push values on the stack. As it turns out, both lua_pushcfunction and lua_pushstring can fail if they run out of memory (OOM). Such failure would of course be captured inside a protected environment... but we have a little chicken'n'egg problem here. That said, OOM failures are rare so I'm going to leverage this fact and not worry about it.  (Note to self: install a lua_atpanic handler to complain loudly if that ever happens.)Addendum: Bundling Lua within my program and building it as a C++ binary with exception reporting enabled in luaconf.h would magically solve all my issues. I know. But I don't fancy the idea of bundling the library into my source tree for a variety of reasons.

        <a href="/2011/01/error-handling-in-lua-kyua-approach.html">[Continue reading]</a>
      </p>
      
    </li>
  
    <li>
      <h2>
        <a class="post-link" href="/2011/01/c-interface-to-lua.html">C++ interface to Lua for Kyua</a>
      </h2>
      <span class="post-meta"><!-- From http://alanwsmith.com/jekyll-liquid-date-formatting-examples -->

January

8th,
  
2011
at
13:17 UTC
        &middot;
        <a href="/2011/01/c-interface-to-lua.html#disqus_thread">
          <span class="disqus-comment-count"
                data-disqus-url="http://julio.meroh.net/2011/01/c-interface-to-lua.html">Comments</span>
        </a>
      </span>
      
      <p>
        Finally! After two weeks of holidays work, I have finally been able to submit Kyua's r39: a generic library that implements a C++ interface to Lua. The code is hosted in the utils/lua/ subdirectory.From the revision description:The utils::lua library provides thin C++ wrappers around the Lua C API to ease the interaction between C++ and Lua.  These wrappers make intensive use of RAII to prevent resource leakage, expose C++-friendly data types, report errors by means of exceptions and ensure that the Lua stack is always left untouched in the face of errors.  The library also provides a place (the operations module) to add miscellaneous utility functions built on top of the wrappers.In other words: this code aims to decouple all details of the interaction with the Lua C API from the main code of Kyua so that the high level algorithms do not have to worry about Lua C API idiosyncrasies.Further changes to Kyua to implement the new configuration system will follow soon as all the basic code to talk to Lua has been ironed out. Also expect some extra posts regarding the design decisions that went on this helper code and, in particular, about error reporting as mentioned in the previous post.(Yep, Lua and Kyua sound similar. But that was never intended; promise!)

        <a href="/2011/01/c-interface-to-lua.html">[Continue reading]</a>
      </p>
      
    </li>
  
</ul>


<script id="dsq-count-scr" src="//jmmv.disqus.com/count.js" async></script>



      <div class="pagination">
        
          <span class="previous"><a
          href="/page26">&laquo;
          Newer posts</a></span>
        

        <!-- Disabled to not show a page count, which is meaningless.
        <span class="current">Page 27 of
        101</span>
        -->

        
          <span class="next"><a
          href="/page28">Older posts
          &raquo;</a></span>
        
      </div>
    </div>
    <div class="col-md-3 sidebar">
      <div class="row">
  <h2>Blog subscription</h2>

  <form class="feedburner form-horizontal"
        action="https://feedburner.google.com/fb/a/mailverify"
        method="post"
        target="popupwindow"
        onsubmit="window.open('https://feedburner.google.com/fb/a/mailverify?uri=jmmv', 'popupwindow', 'scrollbars=yes,width=550,height=520');return true">
    <div class="form-group">
      <div class="col-sm-10">
        <input type="text" name="email"
               placeholder="Enter your email" class="form-control"/>
      </div>
      <button type="submit" value="Subscribe" class="btn btn-default col-sm-2">
        <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>
      </button>
    </div>
    <input type="hidden" value="jmmv" name="uri"/>
    <input type="hidden" name="loc" value="en_US"/>
    <p>
      <small>Subscription by
      <a href="https://feedburner.google.com"
      target="_blank">FeedBurner</a></small>
    </p>
  </form>

  <p class="text-center"><a
  href="/feed.xml">RSS feed</a></p>

  <p class="text-center">
    <a href="https://twitter.com/jmmv"
    class="twitter-follow-button"
    data-show-count="false"
    data-size="large">Follow @jmmv</a>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
  </p>
</div>

<div class="row archive">
  <h2>Archive</h2>

  

  <ul>
  <li>
    <a data-toggle="collapse" href="#archive-year-2017">2017</a> (4)
     
    <ul id="archive-year-2017" class="collapse">
     
      <li><a href="/2017/07">July 2017</a> (1)</li>
      <li><a href="/2017/02">February 2017</a> (3)</li>
      <li><a href="/2017">All year</a></li>
    </ul>
  </li>
  <li>
    <a data-toggle="collapse" href="#archive-year-2016">2016</a> (8)
     
    <ul id="archive-year-2016" class="collapse">
     
      <li><a href="/2016/09">September 2016</a> (1)</li>
      <li><a href="/2016/05">May 2016</a> (1)</li>
      <li><a href="/2016/04">April 2016</a> (1)</li>
      <li><a href="/2016/03">March 2016</a> (2)</li>
      <li><a href="/2016/02">February 2016</a> (1)</li>
      <li><a href="/2016/01">January 2016</a> (2)</li>
      <li><a href="/2016">All year</a></li>
    </ul>
  </li>
  <li>
    <a data-toggle="collapse" href="#archive-year-2015">2015</a> (17)
     
    <ul id="archive-year-2015" class="collapse">
     
      <li><a href="/2015/12">December 2015</a> (2)</li>
      <li><a href="/2015/10">October 2015</a> (2)</li>
      <li><a href="/2015/09">September 2015</a> (3)</li>
      <li><a href="/2015/06">June 2015</a> (2)</li>
      <li><a href="/2015/05">May 2015</a> (3)</li>
      <li><a href="/2015/04">April 2015</a> (1)</li>
      <li><a href="/2015/03">March 2015</a> (1)</li>
      <li><a href="/2015/02">February 2015</a> (3)</li>
      <li><a href="/2015">All year</a></li>
    </ul>
  </li>
  <li>
    <a data-toggle="collapse" href="#archive-year-2014">2014</a> (12)
     
    <ul id="archive-year-2014" class="collapse">
     
      <li><a href="/2014/11">November 2014</a> (2)</li>
      <li><a href="/2014/06">June 2014</a> (1)</li>
      <li><a href="/2014/05">May 2014</a> (2)</li>
      <li><a href="/2014/03">March 2014</a> (1)</li>
      <li><a href="/2014/02">February 2014</a> (3)</li>
      <li><a href="/2014/01">January 2014</a> (3)</li>
      <li><a href="/2014">All year</a></li>
    </ul>
  </li>
  <li>
    <a data-toggle="collapse" href="#archive-year-2013">2013</a> (62)
     
    <ul id="archive-year-2013" class="collapse">
     
      <li><a href="/2013/12">December 2013</a> (7)</li>
      <li><a href="/2013/11">November 2013</a> (7)</li>
      <li><a href="/2013/10">October 2013</a> (7)</li>
      <li><a href="/2013/09">September 2013</a> (13)</li>
      <li><a href="/2013/08">August 2013</a> (9)</li>
      <li><a href="/2013/07">July 2013</a> (10)</li>
      <li><a href="/2013/06">June 2013</a> (9)</li>
      <li><a href="/2013">All year</a></li>
    </ul>
  </li>
  <li>
    <a data-toggle="collapse" href="#archive-year-2012">2012</a> (29)
     
    <ul id="archive-year-2012" class="collapse">
     
      <li><a href="/2012/10">October 2012</a> (1)</li>
      <li><a href="/2012/09">September 2012</a> (1)</li>
      <li><a href="/2012/08">August 2012</a> (3)</li>
      <li><a href="/2012/07">July 2012</a> (2)</li>
      <li><a href="/2012/06">June 2012</a> (2)</li>
      <li><a href="/2012/05">May 2012</a> (3)</li>
      <li><a href="/2012/04">April 2012</a> (1)</li>
      <li><a href="/2012/03">March 2012</a> (1)</li>
      <li><a href="/2012/02">February 2012</a> (10)</li>
      <li><a href="/2012/01">January 2012</a> (5)</li>
      <li><a href="/2012">All year</a></li>
    </ul>
  </li>
  <li>
    <a data-toggle="collapse" href="#archive-year-2011">2011</a> (60)
     
    <ul id="archive-year-2011" class="collapse">
     
      <li><a href="/2011/12">December 2011</a> (4)</li>
      <li><a href="/2011/11">November 2011</a> (4)</li>
      <li><a href="/2011/10">October 2011</a> (5)</li>
      <li><a href="/2011/09">September 2011</a> (11)</li>
      <li><a href="/2011/08">August 2011</a> (6)</li>
      <li><a href="/2011/07">July 2011</a> (4)</li>
      <li><a href="/2011/06">June 2011</a> (6)</li>
      <li><a href="/2011/05">May 2011</a> (6)</li>
      <li><a href="/2011/04">April 2011</a> (5)</li>
      <li><a href="/2011/03">March 2011</a> (2)</li>
      <li><a href="/2011/01">January 2011</a> (7)</li>
      <li><a href="/2011">All year</a></li>
    </ul>
  </li>
  <li>
    <a data-toggle="collapse" href="#archive-year-2010">2010</a> (26)
     
    <ul id="archive-year-2010" class="collapse">
     
      <li><a href="/2010/12">December 2010</a> (7)</li>
      <li><a href="/2010/09">September 2010</a> (1)</li>
      <li><a href="/2010/07">July 2010</a> (1)</li>
      <li><a href="/2010/06">June 2010</a> (2)</li>
      <li><a href="/2010/05">May 2010</a> (5)</li>
      <li><a href="/2010/04">April 2010</a> (5)</li>
      <li><a href="/2010/03">March 2010</a> (3)</li>
      <li><a href="/2010/01">January 2010</a> (2)</li>
      <li><a href="/2010">All year</a></li>
    </ul>
  </li>
  <li>
    <a data-toggle="collapse" href="#archive-year-2009">2009</a> (31)
     
    <ul id="archive-year-2009" class="collapse">
     
      <li><a href="/2009/10">October 2009</a> (1)</li>
      <li><a href="/2009/09">September 2009</a> (1)</li>
      <li><a href="/2009/08">August 2009</a> (3)</li>
      <li><a href="/2009/07">July 2009</a> (2)</li>
      <li><a href="/2009/06">June 2009</a> (4)</li>
      <li><a href="/2009/05">May 2009</a> (6)</li>
      <li><a href="/2009/04">April 2009</a> (2)</li>
      <li><a href="/2009/03">March 2009</a> (4)</li>
      <li><a href="/2009/01">January 2009</a> (8)</li>
      <li><a href="/2009">All year</a></li>
    </ul>
  </li>
  <li>
    <a data-toggle="collapse" href="#archive-year-2008">2008</a> (61)
     
    <ul id="archive-year-2008" class="collapse">
     
      <li><a href="/2008/12">December 2008</a> (1)</li>
      <li><a href="/2008/11">November 2008</a> (4)</li>
      <li><a href="/2008/10">October 2008</a> (6)</li>
      <li><a href="/2008/09">September 2008</a> (1)</li>
      <li><a href="/2008/08">August 2008</a> (6)</li>
      <li><a href="/2008/07">July 2008</a> (14)</li>
      <li><a href="/2008/06">June 2008</a> (3)</li>
      <li><a href="/2008/05">May 2008</a> (1)</li>
      <li><a href="/2008/04">April 2008</a> (3)</li>
      <li><a href="/2008/03">March 2008</a> (3)</li>
      <li><a href="/2008/02">February 2008</a> (9)</li>
      <li><a href="/2008/01">January 2008</a> (10)</li>
      <li><a href="/2008">All year</a></li>
    </ul>
  </li>
  <li>
    <a data-toggle="collapse" href="#archive-year-2007">2007</a> (85)
     
    <ul id="archive-year-2007" class="collapse">
     
      <li><a href="/2007/12">December 2007</a> (4)</li>
      <li><a href="/2007/11">November 2007</a> (7)</li>
      <li><a href="/2007/10">October 2007</a> (2)</li>
      <li><a href="/2007/09">September 2007</a> (8)</li>
      <li><a href="/2007/08">August 2007</a> (6)</li>
      <li><a href="/2007/07">July 2007</a> (15)</li>
      <li><a href="/2007/06">June 2007</a> (15)</li>
      <li><a href="/2007/05">May 2007</a> (4)</li>
      <li><a href="/2007/04">April 2007</a> (10)</li>
      <li><a href="/2007/03">March 2007</a> (7)</li>
      <li><a href="/2007/02">February 2007</a> (1)</li>
      <li><a href="/2007/01">January 2007</a> (6)</li>
      <li><a href="/2007">All year</a></li>
    </ul>
  </li>
  <li>
    <a data-toggle="collapse" href="#archive-year-2006">2006</a> (102)
     
    <ul id="archive-year-2006" class="collapse">
     
      <li><a href="/2006/12">December 2006</a> (4)</li>
      <li><a href="/2006/11">November 2006</a> (3)</li>
      <li><a href="/2006/10">October 2006</a> (7)</li>
      <li><a href="/2006/09">September 2006</a> (6)</li>
      <li><a href="/2006/08">August 2006</a> (13)</li>
      <li><a href="/2006/07">July 2006</a> (4)</li>
      <li><a href="/2006/06">June 2006</a> (13)</li>
      <li><a href="/2006/05">May 2006</a> (6)</li>
      <li><a href="/2006/04">April 2006</a> (9)</li>
      <li><a href="/2006/03">March 2006</a> (6)</li>
      <li><a href="/2006/02">February 2006</a> (13)</li>
      <li><a href="/2006/01">January 2006</a> (18)</li>
      <li><a href="/2006">All year</a></li>
    </ul>
  </li>
  <li>
    <a data-toggle="collapse" href="#archive-year-2005">2005</a> (126)
     
    <ul id="archive-year-2005" class="collapse">
     
      <li><a href="/2005/12">December 2005</a> (9)</li>
      <li><a href="/2005/11">November 2005</a> (7)</li>
      <li><a href="/2005/10">October 2005</a> (22)</li>
      <li><a href="/2005/09">September 2005</a> (10)</li>
      <li><a href="/2005/08">August 2005</a> (14)</li>
      <li><a href="/2005/07">July 2005</a> (5)</li>
      <li><a href="/2005/06">June 2005</a> (12)</li>
      <li><a href="/2005/05">May 2005</a> (6)</li>
      <li><a href="/2005/04">April 2005</a> (5)</li>
      <li><a href="/2005/03">March 2005</a> (12)</li>
      <li><a href="/2005/02">February 2005</a> (11)</li>
      <li><a href="/2005/01">January 2005</a> (13)</li>
      <li><a href="/2005">All year</a></li>
    </ul>
  </li>
  <li>
    <a data-toggle="collapse" href="#archive-year-2004">2004</a> (84)
     
    <ul id="archive-year-2004" class="collapse">
     
      <li><a href="/2004/12">December 2004</a> (9)</li>
      <li><a href="/2004/11">November 2004</a> (6)</li>
      <li><a href="/2004/10">October 2004</a> (11)</li>
      <li><a href="/2004/09">September 2004</a> (19)</li>
      <li><a href="/2004/07">July 2004</a> (29)</li>
      <li><a href="/2004/06">June 2004</a> (10)</li>
      <li><a href="/2004">All year</a></li>
    </ul>
  </li>
</ul>

</div>

    </div>
  </div>
</div>


    <div class="container">
  <footer>
    <p class="pull-right"><a href="#">Back to top</a></p>
    <p>Copyright 2016 Julio Merino</p>
  </footer>
</div>

<script src="/js/jquery-1.11.2.min.js">
</script>
<script
  src="/css/bootstrap.min.js">
</script>

<script src="/js/auto-toc-1.0.0.dist.js">
</script>

<script>
$("p:contains('NOTE: ')").addClass("callout callout-info");
$("p:contains('IMPORTANT: ')").addClass("callout callout-info");
$("p:contains('WARNING: ')").addClass("callout callout-warning");
$("p:contains('DANGER: ')").addClass("callout callout-danger");
</script>


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;
  m.parentNode.insertBefore(a,m)})(window,document,'script',
  '//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-63557333-1', 'auto');
  ga('send', 'pageview');
</script>


  </body>
</html>
