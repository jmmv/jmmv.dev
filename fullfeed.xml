<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Julio Merino (jmmv.dev)</title><link>https://jmmv.dev/</link><description>Recent content on Julio Merino (jmmv.dev)</description><generator>Hugo -- gohugo.io</generator><language>en-us</language><lastBuildDate>Fri, 27 Oct 2023 16:14:00 +0200</lastBuildDate><atom:link href="https://jmmv.dev/feed.xml" rel="self" type="application/rss+xml"/><item><title>Hello, Blog System/5!</title><link>https://jmmv.dev/2023/10/hello-blog-system5.html</link><pubDate>Fri, 27 Oct 2023 16:14:00 +0200</pubDate><guid>https://jmmv.dev/2023/10/hello-blog-system5.html</guid><description>&lt;p>&lt;a href="https://blogsystem5.substack.com/">Blog System/5&lt;/a> is my new Substack publication in which I write about the variety of software and systems engineering topics that pique my interest. If that sounds too generic to you, it&amp;rsquo;s because it is: there are too many cool things to write about!&lt;/p>
&lt;p>But in particular, I&amp;rsquo;ll be covering:&lt;/p>
&lt;ul>
&lt;li>
&lt;p>operating systems, including the BSDs, Linux, macOS and maybe Windows;&lt;/p>
&lt;/li>
&lt;li>
&lt;p>build systems, which mostly means Bazel;&lt;/p>
&lt;/li>
&lt;li>
&lt;p>programming languages, including Rust and shell (talk about opposites!);&lt;/p>
&lt;/li>
&lt;li>
&lt;p>and general engineering practices to build sustainable, high-quality systems.&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>My essays are based on my day-to-day professional experiences at Google as an SRE in the storage stack and SWE in Blaze; Microsoft as an SDE in Azure Storage; and Snowflake as a SWE in developer productivity. But also, these essays are based on my own side projects like &lt;a href="https://www.endbasic.dev/">EndBASIC&lt;/a> or &lt;a href="https://shtk.jmmv.dev/">shtk&lt;/a>, and on my distant past contributions to FreeBSD, NetBSD and Gnome.&lt;/p>
&lt;blockquote>
&lt;p>Subscribe now to help build a community of like-minded individuals. It&amp;rsquo;s free, and a stable subscribers group makes a difference!&lt;/p>
&lt;p>&lt;a href="https://blogsystem5.substack.com/">https://blogsystem5.substack.com/&lt;/a>&lt;/p>
&lt;/blockquote>
&lt;h1 id="but-why">But why?&lt;/h1>
&lt;p>You may have read my blog at &lt;a href="https://jmmv.dev/">https://jmmv.dev/&lt;/a> (this site), which is still alive and kicking, so what&amp;rsquo;s up with this newsletter? Doesn&amp;rsquo;t the introduction above sound exactly like what my blog is about?&lt;/p>
&lt;p>Well&amp;hellip; yeah, but I want to run an experiment. Growing the readership of my home-grown blog has been extremely hard: some of my articles occasionally end up in the Hacker News front page, but those only result in one-off traffic spikes with no recurrent engagement, which is a tad sad. I&amp;rsquo;ve witnessed other authors build nice communities around their publications in Substack, so I want to check first-hand how this platform helps achieve those goals.&lt;/p>
&lt;p>My tentative plan is to post new articles here first and then re-post them to my personal blog a few days later. The reasons for this structure are two: first, because I want to &lt;a href="/2016/01/medium-experiment-wrapup.html">own my content long-term&lt;/a>; and, second, because I do not want to force you all to subscribe to Substack if you don&amp;rsquo;t want to: the usual &lt;a href="/feed.xml">RSS&lt;/a> and &lt;a href="/2023/06/in-house-email-subscriptions.html">email subscription mechanism&lt;/a> will continue to work.&lt;/p>
&lt;p>But&amp;hellip; I can imagine sending you some &amp;ldquo;fresh&amp;rdquo; content that wouldn&amp;rsquo;t really fit as a long-form blog article, but I&amp;rsquo;m not sure yet. So, we&amp;rsquo;ll see.&lt;/p>
&lt;h1 id="whats-in-the-name">What&amp;rsquo;s in the name?&lt;/h1>
&lt;p>It&amp;rsquo;s weird, isn&amp;rsquo;t it? Where does it come from? Simply put, I like original blog titles that refer to technology products or concepts, so I wanted one like those too. OS/2 Warp 3 was the alternate operating system that led me into my adventure away from Windows and towards great outcomes back in 1995, so Blog System/5 pays a tribute to that even if I likely won&amp;rsquo;t be blogging about OS/2 at all.&lt;/p>
&lt;p>So what about the 5? As it turns out, this is the fifth (I &lt;em>think&lt;/em>) iteration of my blog. Going back almost 20 years, my writing journey started in LiveJournal, then moved onto Blogger, then onto a brief stint with Medium, then onto my self-hosted site, and then onto here. If this experiment goes sideways&amp;hellip; well, I&amp;rsquo;ll just keep the title and number for the blog. I like odd numbers.&lt;/p>
&lt;h1 id="whats-next">What&amp;rsquo;s next?&lt;/h1>
&lt;p>Easy. You &lt;em>subscribe now&lt;/em> and you receive my detailed recap of BazelCon 2023 as soon as I finish writing it in the next few days. Plus, of course, you&amp;rsquo;ll also receive all future articles and maybe we can build a community around those topics. Don&amp;rsquo;t hesitate to share your thoughts along the way!&lt;/p></description><enclosure url="https://jmmv.dev/images/2023-10-28-blog-system5-logo.png" length="76109" type="image/jpeg"/></item><item><title>Unit-testing shell scripts and tools with shtk</title><link>https://jmmv.dev/2023/10/unit-testing-with-shtk.html</link><pubDate>Wed, 11 Oct 2023 08:30:00 -0700</pubDate><guid>https://jmmv.dev/2023/10/unit-testing-with-shtk.html</guid><description>&lt;p>While working on this static blog a few days ago, I made a change to its templates that warranted an automated test. I could have written a trivial shell script to do it, but instead I reached out for shtk&amp;rsquo;s unit-testing module. I &lt;a href="https://twitter.com/jmmv/status/1710309896670081083">tweeted about it&lt;/a> right away to just say that you can, in fact, write tests in shell because lots of developers are skeptical about any script longer than 10 lines of code.&lt;/p>
&lt;p>Interestingly, this reply came through: a pointer to a contemporary, under-development library for writing tests in Bash. Which made me think: &amp;ldquo;Hey, I had already done that years ago&amp;hellip; but nobody knows about it. Gotta fix that with a blog post!&amp;rdquo; But first, I had to bring shtk back from its ashes because I had not touched it for more than 6 years and it wasn&amp;rsquo;t read for show and tell. So I did something that I wanted to do back in the day but never did: I put together &lt;a href="https://shtk.jmmv.dev/">a website for shtk&lt;/a> to host its &lt;a href="https://shtk.jmmv.dev/docs.html">reference manual&lt;/a> and I fixed a few obvious rough edges.&lt;/p>
&lt;p>With those tweaks out of the way, we come to this article. In here, I want to show you how writing decent tests in shell is entirely possible and how shtk&amp;rsquo;s testing platform provides unique features to do integration testing of CLI apps written in any language.&lt;/p>
&lt;div class="container action-highlight p-4 my-4 d-md-none">
&lt;div class="row text-center">
&lt;p>A blog on operating systems, programming languages, testing, build systems, my own software
projects and even personal productivity. Specifics include FreeBSD, Linux, Rust, Bazel and
EndBASIC.&lt;/p>
&lt;/div>
&lt;div class="row">
&lt;div class="col">
&lt;div class="form-group">
&lt;form action="https://endtracker.azurewebsites.net/api/sites/e8da9f62-b7ac-4fe9-bf20-7c527199a376/subscribers/add" method="post">
&lt;input type="text" name="email"
placeholder="Enter your email"
class="form-control input-sm text-center my-1"/>
&lt;button type="submit" class="btn btn-primary btn-block my-1">Subscribe&lt;/button>
&lt;/form>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;div class="row px-2">
&lt;div class="col col-sm-5 text-left">
&lt;small>&lt;span class="subscriber-count">0&lt;/span> subscribers&lt;/small>
&lt;/div>
&lt;div class="col col-sm-7 text-right">
&lt;p>
&lt;a rel="me" href="https://mastodon.online/@jmmv">
&lt;img src="/images/badges/mastodon-logo.svg" width="32px" height="32px" alt="Follow @jmmv on Mastodon">
&lt;/a>
&lt;a href="https://twitter.com/intent/follow?original_referer=https%3A%2F%2Fjmmv.dev%2F&amp;amp;screen_name=jmmv">
&lt;img src="/images/badges/Twitter_logo_blue.svg" width="32px" height="32px" alt="Follow @jmmv on Twitter">
&lt;/a>
&lt;a href="/feed.xml">&lt;img src="/images/badges/feed-icon-28x28.png" alt="RSS feed">&lt;/a>
&lt;/p>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;h1 id="what-is-shtk-anyway">What is shtk anyway?&lt;/h1>
&lt;p>The Shell Toolkit, or shtk for short, is a collection of libraries to support the writing of portable shell scripts. shtk grew out of &lt;a href="http://blog.netbsd.org/tnf/entry/introducing_sysbuild_and_sysupgrade">sysbuild and sysupgrade&lt;/a>&amp;rsquo;s common code, a couple of tools I wrote over 10 years ago for NetBSD and that are fully written in shell because of the constraints of the NetBSD base system. In turn, this means that shtk is &lt;em>not&lt;/em> Bash-specific so it avoids imposing a &lt;a href="/2021/08/useless-use-of-gnu.html">useless use of GNU&lt;/a>.&lt;/p>
&lt;p>From the get go, all of shtk, sysbuild, and sysupgrade had unit tests written with atf-sh, the shell testing library of the &lt;a href="/software/atf.html">Automated Testing Framework&lt;/a>. atf-sh was a rather simplistic library created by yours truly in 2007 and required a complex runtime (atf-run or, later, &lt;a href="/software/kyua.html">Kyua&lt;/a>) to be functional. By 2014, while working at Google, I had been exposed to better ways of writing tests that blended better with the languages they supported (pyUnit and JUnit), and I knew that I needed a replacement for atf-sh.&lt;/p>
&lt;p>Hence, in 2014, I took the best parts of atf-sh, the core concepts of the xUnit test frameworks, and I created shtk&amp;rsquo;s &lt;code>unittest&lt;/code> module. I then proceeded to migrate all existing tests to this new framework and also used shtk to &lt;a href="/2017/02/introducing-pkg_comp-2.0.html">build pkg_comp 2.x later on in 2017&lt;/a>. But I failed to publicize the library because I didn&amp;rsquo;t quite know how to put together a cool-looking website and I didn&amp;rsquo;t have a good platform to talk about it&amp;mdash;both of which are fixed now.&lt;/p>
&lt;h1 id="installing-shtk">Installing shtk&lt;/h1>
&lt;p>If you are on NetBSD or on FreeBSD, you are in luck! There are packages for shtk ready to install, so go ahead and use those.&lt;/p>
&lt;p>On any other system, you&amp;rsquo;ll have to build shtk from source. Fear not, it&amp;rsquo;s easy:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-text" data-lang="text">&lt;span class="line">&lt;span class="cl">$ curl -LO https://github.com/jmmv/shtk/releases/download/shtk-1.7/shtk-1.7.tar.gz
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ tar xzf shtk-1.7.tar.gz
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ cd shtk-1.7
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ ./configure --prefix ~/.local
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ make
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ make install
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>After a successful installation, you should have the &lt;code>shtk&lt;/code> tool in your path. If that&amp;rsquo;s not the case, do this:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-text" data-lang="text">&lt;span class="line">&lt;span class="cl">$ PATH=&amp;#34;${HOME}/.local/bin:${PATH}&amp;#34;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ export MANPATH=&amp;#34;${HOME}/.local/share/man:${MANPATH}&amp;#34;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Setting up the &lt;code>MANPATH&lt;/code> is important. shtk&amp;rsquo;s official documentation is written as manual pages to seamlessly integrate with the Unix-y environment it&amp;rsquo;s intended to complement, so you&amp;rsquo;ll want &lt;code>man&lt;/code> invocations to work. If you are curious, start by peeking into &lt;a href="https://shtk.jmmv.dev/shtk.1.html">&lt;code>shtk(1)&lt;/code>&lt;/a> and &lt;a href="https://shtk.jmmv.dev/shtk.3.html">&lt;code>shtk(3)&lt;/code>&lt;/a>.&lt;/p>
&lt;h1 id="creating-our-first-test">Creating our first test&lt;/h1>
&lt;p>Now that we have shtk up and running, let&amp;rsquo;s create a test. Write the following contents to a file named &lt;code>demo_test.sh&lt;/code>:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">shtk_import unittest
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">shtk_unittest_add_test always_fails
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">always_fails_test&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> assert_equal &lt;span class="m">2&lt;/span> &lt;span class="m">3&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;NOT REACHED!&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Done? OK. Something looks funny, doesn&amp;rsquo;t it? &lt;code>shtk_import&lt;/code> is a shell function that brings the &lt;code>unittest&lt;/code> module into scope. But&amp;hellip; where does that function come from? Well, here is the thing: shtk scripts need to be &amp;ldquo;built&amp;rdquo; before they can run. In order for the above to become a runnable test program, you have to do the following:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-text" data-lang="text">&lt;span class="line">&lt;span class="cl">$ shtk build -m shtk_unittest_main demo_test.sh
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>After running the above, you&amp;rsquo;ll end up with a &lt;code>demo_test&lt;/code> executable. This &amp;ldquo;executable&amp;rdquo; is essentially the same as &lt;code>demo_test.sh&lt;/code> but with some preamble code to set up the module import features and a call to the &lt;code>shtk_unittest_main&lt;/code> entry point to execute the tests.&lt;/p>
&lt;p>Once the script is built, run it and see the single test fail:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-text" data-lang="text">&lt;span class="line">&lt;span class="cl">$ ./demo_test
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">demo_test: I: Testing always_fails...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">demo_test: E: Expected value 2 but got 3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">demo_test: W: Testing always_fails... FAILED
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">demo_test: W: Ran 1 tests; 1 FAILED
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h1 id="advanced-xunit-like-features">Advanced xUnit-like features&lt;/h1>
&lt;p>The above is nice but&amp;hellip; pretty&amp;hellip; simple? Anyone can write a conditional to check if two values are equal without the need for &amp;ldquo;fancy frameworks&amp;rdquo;, right? Right. But shtk provides much more.&lt;/p>
&lt;p>Just like asserts, shtk also comes with expects to record soft failures: all &lt;code>assert_*&lt;/code> functions have an &lt;code>expect_*&lt;/code> counterpart. If we tweak our previous test to look like this:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">shtk_import unittest
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">shtk_unittest_add_test always_fails
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">always_fails_test&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> expect_equal &lt;span class="m">2&lt;/span> &lt;span class="m">3&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;REACHED!&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> expect_equal &lt;span class="m">4&lt;/span> &lt;span class="m">5&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>We get the following, which shows how the two expect commands ran and detected a failure but didn&amp;rsquo;t stop execution:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-text" data-lang="text">&lt;span class="line">&lt;span class="cl">$ shtk build -m shtk_unittest_main demo_test.sh
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ ./demo_test
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">demo_test: I: Testing always_fails...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">demo_test: W: Delayed failure: Expected value 2 but got 3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">REACHED!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">demo_test: W: Delayed failure: Expected value 4 but got 5
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">demo_test: W: Testing always_fails... FAILED (2 delayed failures)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">demo_test: W: Ran 1 tests; 1 FAILED
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>In general, when writing a test, you use asserts for any step that prepares the test scenario, and you use expects for the test scenario itself. This way, the test fails early if it is unable to set up the scenario (because it makes no sense to continue if the scenario is not set up), but it prints as much diagnostic information as possible if the actual test detects problems half-way through.&lt;/p>
&lt;p>What about fixtures? Setup and teardown routines? shtk has got you covered too:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">shtk_import unittest
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">shtk_unittest_add_fixture sample
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sample_fixture&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> setup&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;Common setup code&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="m">123&lt;/span> &amp;gt;data.txt
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> teardown&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;Common cleanup code&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> rm -f data.txt
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> shtk_unittest_add_test ok
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ok_test&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> assert_equal &lt;span class="m">123&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="k">$(&lt;/span>cat data.txt&lt;span class="k">)&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="m">125&lt;/span> &amp;gt;data.txt &lt;span class="c1"># Overwrites transient file.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> shtk_unittest_add_test not_ok
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> not_ok_test&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> assert_equal &lt;span class="m">125&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="k">$(&lt;/span>cat data.txt&lt;span class="k">)&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Running the above does as you would expect:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-text" data-lang="text">&lt;span class="line">&lt;span class="cl">$ shtk build -m shtk_unittest_main demo_test.sh
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ ./demo_test
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">demo_test: I: Testing sample__ok...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Common setup code
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Common cleanup code
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">demo_test: I: Testing sample__ok... PASSED
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">demo_test: I: Testing sample__not_ok...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Common setup code
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">demo_test: E: Expected value 125 but got 123
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Common cleanup code
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">demo_test: W: Testing sample__not_ok... FAILED
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">demo_test: W: Ran 2 tests; 1 FAILED
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Note how the setup and teardown routines were executed for each test, which means that the &lt;code>data.txt&lt;/code> file was recreated for every test case and the modifications to the file from one test didn&amp;rsquo;t impact the outcome of the other.&lt;/p>
&lt;h1 id="the-secret-sauce-assert_command">The secret sauce: assert_command&lt;/h1>
&lt;p>So far, everything looks very xUnit-like. We have asserts and expects; we have test setup and teardown hooks; we have fixtures. But shell scripts are uniquely suited to test the user interface of a CLI app: after all, users interact with CLI apps from the shell, so it&amp;rsquo;s only natural to use the shell to test arbitrary tools no matter what language they are written in. This is where shtk&amp;rsquo;s magic sauce comes into play.&lt;/p>
&lt;p>shtk&amp;rsquo;s &lt;code>assert_command&lt;/code> check allows you to run an arbitrary command and to declaratively check its exit condition and its side-effects on stdout and stderr. The feature is inspired by &lt;a href="https://www.gnu.org/software/autoconf/manual/autoconf-2.68/html_node/Writing-Testsuites.html">&lt;code>AT_CHECK&lt;/code> in GNU Autoconf&lt;/a>, to which I was exposed even longer ago (circa 2005) while working on the Monotone project.&lt;/p>
&lt;p>Take a look at these tests that exercise the &lt;code>cp&lt;/code> tool and pay close attention to the &lt;code>assert_command&lt;/code> calls:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">shtk_import unittest
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">shtk_unittest_add_test cp_ok
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cp_ok_test&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> touch a
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> assert_command cp a b
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">[&lt;/span> -f b &lt;span class="o">]&lt;/span> &lt;span class="o">||&lt;/span> fail &lt;span class="s2">&amp;#34;b was not created&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">shtk_unittest_add_test cp_missing_source
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cp_missing_source_test&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> assert_command -s exit:1 -e match:&lt;span class="s2">&amp;#34;No such file&amp;#34;&lt;/span> cp a b
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">shtk_unittest_add_test cp_unexpected_output
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cp_unexpected_output_test&lt;span class="o">()&lt;/span> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> assert_command -s exit:1 -o match:&lt;span class="s2">&amp;#34;Hello&amp;#34;&lt;/span> cp a b
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>In the first test, &lt;code>cp_ok&lt;/code>, the call to &lt;code>assert_command&lt;/code> has no flags. This means that we expect the command given to the assert to finish successfully and quietly: the exit code of &lt;code>cp a b&lt;/code> should be 0, and both stdout and stderr should be silent.&lt;/p>
&lt;p>In the second test, &lt;code>cp_missing_source&lt;/code>, the call to &lt;code>assert_command&lt;/code> specifies that the command under test has to terminate with an exit code of 1, and that stderr has match the &lt;code>No such file&lt;/code> regular expression.&lt;/p>
&lt;p>In the third test, &lt;code>cp_unexpected_output&lt;/code>, the call to &lt;code>assert_command&lt;/code> expects a message to stdout that &lt;code>cp&lt;/code> will not print, and also implies that stderr should be empty.&lt;/p>
&lt;p>When we run the above after compilation, we get:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-text" data-lang="text">&lt;span class="line">&lt;span class="cl">$ shtk build -m shtk_unittest_main demo_test.sh
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ ./demo_test
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">demo_test: I: Testing cp_ok...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Running checked command: cp a b
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">demo_test: I: Testing cp_ok... PASSED
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">demo_test: I: Testing cp_missing_source...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Running checked command: cp a b
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">demo_test: I: Testing cp_missing_source... PASSED
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">demo_test: I: Testing cp_unexpected_output...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Running checked command: cp a b
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Expected regexp &amp;#39;Hello&amp;#39; not found in standard output:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Expected standard error to be empty; found:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cp: a: No such file or directory
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">demo_test: E: Check of &amp;#39;cp a b&amp;#39; failed; see stdout for details
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">demo_test: W: Testing cp_unexpected_output... FAILED
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">demo_test: W: Ran 3 tests; 1 FAILED
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Note that the first two tests passed, but pay attention to the output of the third failed test: the call to &lt;code>assert_command&lt;/code> reports that neither stdout nor stderr matched what we expected and provides details on why.&lt;/p>
&lt;p>I invite you to take a look at the documentation in &lt;a href="https://shtk.jmmv.dev/shtk_unittest_assert_command.3.html">&lt;code>shtk_unittest_assert_command(3)&lt;/code>&lt;/a> and its supporting &lt;a href="https://shtk.jmmv.dev/shtk_unittest_assert_file.3.html">&lt;code>shtk_unittest_assert_file(3)&lt;/code>&lt;/a> as the features they provide are too numerous to be captured in this post.&lt;/p>
&lt;h1 id="using-gnu-automake-as-a-test-runner">Using GNU Automake as a test runner&lt;/h1>
&lt;p>Up until here, I have shown you the features that the shtk library itself provides&amp;hellip; but a testing library to write test programs with is not very useful on its own. What happens when you want to run more than one test program at once? How do you set up the test environment so that tests always run in a consistent manner, free from side-effects? How do you collect results for reporting?&lt;/p>
&lt;p>This is where test runners come into play, and there are many to choose from. But again, given the nature of shtk and its desire to blend into Unix-y environments, integrating with the de-facto build system of all foundational software is important. So, yes, shtk tests can run via GNU Automake. The test runner provided by this build system isn&amp;rsquo;t state-of-the-art, but it is more than enough for most situations.&lt;/p>
&lt;p>Here is all it takes to hook the earlier &lt;code>demo_test.sh&lt;/code> shtk-based test into an Automake project:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-makefile" data-lang="makefile">&lt;span class="line">&lt;span class="cl">&lt;span class="nv">TESTS&lt;/span> &lt;span class="o">=&lt;/span> demo_test
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">check_SCRIPTS&lt;/span> &lt;span class="o">=&lt;/span> demo_test
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">CLEANFILES&lt;/span> &lt;span class="o">+=&lt;/span> demo_test
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">EXTRA_DIST&lt;/span> &lt;span class="o">+=&lt;/span> demo_test.sh
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nf">demo_test&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="k">$(&lt;/span>&lt;span class="nv">srcdir&lt;/span>&lt;span class="k">)&lt;/span>/&lt;span class="n">demo_test&lt;/span>.&lt;span class="n">sh&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">$(&lt;/span>AM_V_GEN&lt;span class="k">)&lt;/span>shtk build -m shtk_unittest_main -o &lt;span class="nv">$@&lt;/span> $&amp;lt;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>You&amp;rsquo;d probably want to add a pkg-config check in &lt;code>configure.ac&lt;/code> to load the path to shtk from the provided &lt;code>shtk.pc&lt;/code> and reference it from here as &lt;code>$(SHTK)&lt;/code>, but I&amp;rsquo;ll leave that as an exercise for you, dear reader.&lt;/p>
&lt;p>After that, if we run &lt;code>make check&lt;/code>, we&amp;rsquo;ll see something like this:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-text" data-lang="text">&lt;span class="line">&lt;span class="cl">make check-TESTS
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">PASS: demo_test
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">============================================================================
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Testsuite summary for Demo
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">============================================================================
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"># TOTAL: 1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"># PASS: 1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"># SKIP: 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"># XFAIL: 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"># FAIL: 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"># XPASS: 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"># ERROR: 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">============================================================================
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Neat. Take a look at the &lt;a href="https://www.gnu.org/software/automake/manual/html_node/Tests.html">test suites documentation for GNU Automake&lt;/a> for more details on how to communicate specific return codes (such as &amp;ldquo;skip&amp;rdquo;) to the runner.&lt;/p>
&lt;h1 id="integrating-with-bazel">Integrating with Bazel&lt;/h1>
&lt;p>GNU Automake is the de-facto build system for open source projects but it&amp;rsquo;s also&amp;hellip; far from great. This is why I &lt;a href="/2022/05/remembering-buildtool.html">created Buildtool eons ago&lt;/a> and why I got interested in Bazel in the first place. So the question is: can we integrate shtk with Bazel? Of course we can!&lt;/p>
&lt;p>For the purposes of this post, I hacked up a Bazel rule to show off how running shtk tests with it would look like. And it looks exactly like you would expect:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="n">load&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;shtk.bzl&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;shtk_test&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">shtk_test&lt;/span>&lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;demo_test&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">src&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;demo_test.sh&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Followed by:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-text" data-lang="text">&lt;span class="line">&lt;span class="cl">$ bazel test --test_output=streamed :faulty_test
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">WARNING: Streamed test output requested. All tests will be run locally, without sharding, one at a time
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">INFO: Analyzed target //:faulty_test (0 packages loaded, 2 targets configured).
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">INFO: Found 1 test target...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">faulty_test: I: Testing faulty...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">faulty_test: E: This test fails
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">faulty_test: W: Testing faulty... FAILED
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">faulty_test: W: Ran 1 tests; 1 FAILED
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">FAIL: //:faulty_test (see /home/jmmv/.cache/bazel/_bazel_jmmv/828d51923bded9f03acff0119df51adc/execroot/demo/bazel-out/k8-fastbuild/testlogs/faulty_test/test.log)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Target //:faulty_test up-to-date:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> bazel-bin/faulty_test
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">INFO: Elapsed time: 0.355s, Critical Path: 0.14s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">INFO: 2 processes: 2 linux-sandbox.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">INFO: Build completed, 1 test FAILED, 2 total actions
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">//:faulty_test FAILED in 0.0s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> /home/jmmv/.cache/bazel/_bazel_jmmv/828d51923bded9f03acff0119df51adc/execroot/demo/bazel-out/k8-fastbuild/testlogs/faulty_test/test.log
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Executed 1 out of 1 test: 1 fails locally.
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Some of the benefits of the Bazel test runner over GNU Automake&amp;rsquo;s are that Bazel adds proper test isolation and cleanup via its local sandboxing feature and that Bazel provides fine-grained test invalidation when dependencies change. These are the two primary properties you want in a modern test runner because they ensure that only the minimum subset of tests run on a given source code change, and that the test results are deterministic across invocations and machines.&lt;/p>
&lt;h1 id="the-future">The future&lt;/h1>
&lt;p>Despite its many haters, the shell is a pretty OK language &lt;em>if you treat it as such&lt;/em>. You must learn its syntax and its oddities, but once you do, you can write maintainable and moderately-long programs that are, often enough, much simpler than their Python counterparts. These programs have few dependencies and, given sufficient test coverage, can be as robust as other tools. shtk is just an ingredient that can help you in writing such large scripts in a principled manner and, especially, in testing them.&lt;/p>
&lt;p>As for what the future will bring for shtk&amp;hellip; &lt;strong>you tell me!&lt;/strong> I had not worked on this project for 6 years and absolutely nobody asked about it during this time. But&amp;hellip; things have changed a lot since then and there might actually be some interest out there. In preparation for this blog post, I migrated shtk&amp;rsquo;s CI system from Travis to GitHub Actions, created a simple website to serve the API documentation&amp;mdash;which was previously locked behind &lt;code>man&lt;/code> invocations in a terminal&amp;mdash;and moved off from Kyua to GNU Automake as the test runner for simplicity.&lt;/p>
&lt;p>Some ideas about what could be done: additional library modules/functions; a &amp;ldquo;static build&amp;rdquo; feature where the built scripts don&amp;rsquo;t require shtk to be pre-installed; and real Bazel rules (what I showed above was a macro-based hack) to incorporate shtk into your projects so that you can test your command-line tools end-to-end no matter what language they are written in.&lt;/p>
&lt;p>Please let me know if you have any interest by either voting/replying below or reaching out via social media! And don&amp;rsquo;t forget to visit the brand-new homepage at &lt;a href="https://shtk.jmmv.dev/">https://shtk.jmmv.dev/&lt;/a> to read the documentation.&lt;/p></description><enclosure url="https://jmmv.dev/images/2023-10-11-shell-hammer-wrench.jpg" length="398237" type="image/jpeg"/></item><item><title>5 ways to instantiate Rust structs in tests</title><link>https://jmmv.dev/2023/10/rust-test-structs.html</link><pubDate>Fri, 06 Oct 2023 09:00:00 -0700</pubDate><guid>https://jmmv.dev/2023/10/rust-test-structs.html</guid><description>&lt;p>I&amp;rsquo;m a big fan of static typing and I&amp;rsquo;ve found that using narrow types for each entity in the object model of my programs reduces errors. Rust is particularly well-suited at this task: its lack of implicit type conversions eliminates surprises, and its ownership semantics allow type transformations with zero cost.&lt;/p>
&lt;p>Unfortunately, (ab)using narrow types in an app&amp;rsquo;s domain is &lt;em>really&lt;/em> annoying when writing tests. While non-test code rarely instantiates new objects&amp;mdash;in the case of a REST service, this would only happen at the service&amp;rsquo;s boundaries&amp;mdash;tests instantiate objects infinitely more times than non-test code. Code patterns that may seem reasonable in non-test code can become unbearable in tests.&lt;/p>
&lt;p>In this post, I want to look into the various ways in which you can instantiate strongly-typed objects. For each, I show examples and describe their pros and cons. And yes, as a matter of fact, I have tried them all before&amp;hellip; and I can&amp;rsquo;t yet make my mind as to which one is best.&lt;/p>
&lt;div class="container action-highlight p-4 my-4 d-md-none">
&lt;div class="row text-center">
&lt;p>A blog on operating systems, programming languages, testing, build systems, my own software
projects and even personal productivity. Specifics include FreeBSD, Linux, Rust, Bazel and
EndBASIC.&lt;/p>
&lt;/div>
&lt;div class="row">
&lt;div class="col">
&lt;div class="form-group">
&lt;form action="https://endtracker.azurewebsites.net/api/sites/e8da9f62-b7ac-4fe9-bf20-7c527199a376/subscribers/add" method="post">
&lt;input type="text" name="email"
placeholder="Enter your email"
class="form-control input-sm text-center my-1"/>
&lt;button type="submit" class="btn btn-primary btn-block my-1">Subscribe&lt;/button>
&lt;/form>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;div class="row px-2">
&lt;div class="col col-sm-5 text-left">
&lt;small>&lt;span class="subscriber-count">0&lt;/span> subscribers&lt;/small>
&lt;/div>
&lt;div class="col col-sm-7 text-right">
&lt;p>
&lt;a rel="me" href="https://mastodon.online/@jmmv">
&lt;img src="/images/badges/mastodon-logo.svg" width="32px" height="32px" alt="Follow @jmmv on Mastodon">
&lt;/a>
&lt;a href="https://twitter.com/intent/follow?original_referer=https%3A%2F%2Fjmmv.dev%2F&amp;amp;screen_name=jmmv">
&lt;img src="/images/badges/Twitter_logo_blue.svg" width="32px" height="32px" alt="Follow @jmmv on Twitter">
&lt;/a>
&lt;a href="/feed.xml">&lt;img src="/images/badges/feed-icon-28x28.png" alt="RSS feed">&lt;/a>
&lt;/p>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;h1 id="context-setting">Context-setting&lt;/h1>
&lt;p>Let me introduce you to the &lt;code>Comment&lt;/code> type from the EndTRACKER codebase&amp;mdash;a type that represents a textual comment that someone left on a webpage. I&amp;rsquo;ve simplified it a little for illustration purposes, but the core properties of the type remain:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-rust" data-lang="rust">&lt;span class="line">&lt;span class="cl">&lt;span class="k">struct&lt;/span> &lt;span class="nc">Comment&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">site_id&lt;/span>: &lt;span class="nc">Uuid&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">path&lt;/span>: &lt;span class="nc">Url&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">timestamp&lt;/span>: &lt;span class="nc">OffsetDateTime&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">content&lt;/span>: &lt;span class="nb">String&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">author&lt;/span>: &lt;span class="nb">Option&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="nb">String&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">email&lt;/span>: &lt;span class="nb">Option&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">EmailAddress&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Said core properties are:&lt;/p>
&lt;ul>
&lt;li>
&lt;p>Four required fields for every comment: &lt;code>site_id&lt;/code>, &lt;code>path&lt;/code>, &lt;code>timestamp&lt;/code> and &lt;code>content&lt;/code>.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Two optional fields that are only present if the user writing the comment chose to provide them: &lt;code>author&lt;/code> and &lt;code>email&lt;/code>.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Strongly-typed fields. Note that only two of them are raw strings; the rest are &lt;em>narrower&lt;/em> types that enforce structure on their values.&lt;/p>
&lt;p>This is important because, for example, while URLs can be represented as strings, they are &lt;em>not&lt;/em> strings. The domain of all possible URLs is narrower than the domain of all possible strings because URLs have internal structure. Using a narrow type to represent URLs enforces that, once a URL object exists, we can pass it around and all consumers can assume it has undergone proper validation.&lt;/p>
&lt;p>Note that strong typing can be done in pretty much any language, really, but Rust shines here. It also helps that using narrow types is common practice in this language: in JavaScript, for example, the above would probably have been represented as a loosely-typed &lt;code>Object&lt;/code>; and in Python, it would have been shoehorned into a string-to-whatever dictionary.&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>Let&amp;rsquo;s look at the ways in which &lt;code>Comment&lt;/code> objects can be constructed. Remember that I&amp;rsquo;m focusing on object creation as part of tests. For this reason, it is not necessary to propagate errors to the caller: panicking internally to fail the test is just fine, which simplifies the design a lot.&lt;/p>
&lt;h1 id="option-1-struct-literals">Option 1: Struct literals&lt;/h1>
&lt;p>In the most simple form, a test instantiates a &lt;code>Comment&lt;/code> object by specifying &lt;em>all&lt;/em> fields:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-rust" data-lang="rust">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">let&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">comment&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Comment&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">site_id&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">path&lt;/span>: &lt;span class="nc">url&lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;http://example.com/post.html&amp;#34;&lt;/span>&lt;span class="p">),&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">timestamp&lt;/span>: &lt;span class="nc">datetime&lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">2023&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">10&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">03&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">19&lt;/span>:&lt;span class="mi">25&lt;/span>:&lt;span class="mi">00&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="no">UTC&lt;/span>&lt;span class="p">),&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">content&lt;/span>: &lt;span class="s">&amp;#34;Irrelevant text&amp;#34;&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">to_owned&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">author&lt;/span>: &lt;span class="nb">Some&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;The Author&amp;#34;&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">to_owned&lt;/span>&lt;span class="p">()),&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">email&lt;/span>: &lt;span class="nb">Some&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;the-email@example.com&amp;#34;&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">into&lt;/span>&lt;span class="p">()),&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">};&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Pros:&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;strong>Clarity.&lt;/strong> It&amp;rsquo;s painfully obvious what each field contains in every test object.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>Refactor-proof.&lt;/strong> When modifying the &lt;code>Comment&lt;/code> definition, you are forced to revise all places where the object is constructed. This makes you reassess whether existing tests need to care about the changes or not.&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>Cons:&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;strong>Lack of conciseness.&lt;/strong> Not all tests care about all possible fields of a type. Some tests may want to validate ordering, in which case they care about specific &lt;code>timestamp&lt;/code> values, whereas other tests may want to check protections against HTML injection, in which case they care about &lt;code>content&lt;/code>. But this is not clear in the test because the test is forced to specify values for all fields even if they are irrelevant.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>Refactoring difficulties.&lt;/strong> Even though I listed refactoring in the pros, refactoring is also a con. Having to adjust tens or hundreds of tests every time the struct definition changes is a daunting task, particularly when, in general, existing tests do not care about new fields.&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h1 id="option-2-the-default-trait">Option 2: The Default trait&lt;/h1>
&lt;p>The standard answer to the cons listed above is to implement &lt;code>Default&lt;/code> for the type and thus rely on default values for all fields that are irrelevant in a given context. Ideally, by deriving or implementing &lt;code>Default&lt;/code>, we would do something like this:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-rust" data-lang="rust">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">let&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">comment&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Comment&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">site_id&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">path&lt;/span>: &lt;span class="nc">url&lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;http://example.com/post.html&amp;#34;&lt;/span>&lt;span class="p">),&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">..&lt;/span>&lt;span class="nb">Default&lt;/span>::&lt;span class="nb">Default&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">};&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Unfortunately, this does not work other than for trivial structs. The problem here is that not all types in the &lt;code>Comment&lt;/code> struct implement &lt;code>Default&lt;/code>, and this problem compounds with any additional type you nest. In this particular example, a &lt;code>Url&lt;/code> cannot be empty and an &lt;code>OffsetDateTime&lt;/code> does not have a reasonable zero value.&lt;/p>
&lt;p>One possible solution to this issue is fabricate fake values for all fields. To do this, you can rely on the &lt;code>derivative&lt;/code> crate and use it to supply alternate default values for those fields that don&amp;rsquo;t have one of their own. It is critical to do this &lt;em>only&lt;/em> for debug builds so that these fake definitions never taint production. Here is how this would look like:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-rust" data-lang="rust">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#[cfg_attr(test, derive(Derivative))]&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="cp">#[cfg_attr(test, derivative(Default))]&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">pub&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">struct&lt;/span> &lt;span class="nc">Comment&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="cp">#[cfg_attr(test, derivative(Default(value = &lt;/span>&lt;span class="s">&amp;#34;Uuid::new_v4()&amp;#34;&lt;/span>&lt;span class="cp">)))]&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">pub&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">site_id&lt;/span>: &lt;span class="nc">Uuid&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="cp">#[cfg_attr(test, derivative(Default(value = r#&lt;/span>&lt;span class="s">&amp;#34;url!(&amp;#34;&lt;/span>&lt;span class="cp">https://UNSET/&lt;/span>&lt;span class="s">&amp;#34;)&amp;#34;&lt;/span>&lt;span class="cp">#)))]&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">pub&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">path&lt;/span>: &lt;span class="nc">Url&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="cp">#[cfg_attr(test, derivative(Default(value = &lt;/span>&lt;span class="s">&amp;#34;OffsetDateTime::UNIX_EPOCH&amp;#34;&lt;/span>&lt;span class="cp">)))]&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">pub&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">timestamp&lt;/span>: &lt;span class="nc">OffsetDateTime&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="cp">#[cfg_attr(test, derivative(Default(value = r#&lt;/span>&lt;span class="s">&amp;#34;&amp;#34;&lt;/span>&lt;span class="cp">Irrelevant&lt;/span>&lt;span class="s">&amp;#34;.to_owned()&amp;#34;&lt;/span>&lt;span class="cp">#)))]&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">pub&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">content&lt;/span>: &lt;span class="nb">String&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">pub&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">author&lt;/span>: &lt;span class="nb">Option&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="nb">String&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">pub&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">email&lt;/span>: &lt;span class="nb">Option&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">EmailAddress&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>With this, the above instantiation of a &lt;code>Comment&lt;/code> with partial defaults becomes possible.&lt;/p>
&lt;p>Pros:&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;strong>Concise and refactor-friendly.&lt;/strong> Tests can now declare objects with only the few properties they care about. Due to this, adding new fields to the &lt;code>Comment&lt;/code> struct does not require modifying the majority of existing tests.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>Standard.&lt;/strong> Deriving &lt;code>Default&lt;/code> is a common idiom in Rust, so this leads to few surprises.&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>Cons:&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;strong>Complexity.&lt;/strong> The type definitions are quite convoluted, particularly due to the need to couple these fake values to debug builds only.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>Noisy.&lt;/strong> Having to call &lt;code>..Default::default()&lt;/code> each time we instantiate a struct is annoying and adds a lot of visual noise.&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h1 id="option-3-macros">Option 3: Macros&lt;/h1>
&lt;p>Using macros to instantiate test data is a common idiom in Rust: the macros provide a simpler syntax to instantiate objects and they forcibly unwrap result values because it&amp;rsquo;s OK to panic tests on invalid data. In fact, note that in the above examples I&amp;rsquo;ve already used two macros: &lt;code>url!&lt;/code> to construct &lt;code>Url&lt;/code> values from hardcoded strings assumed to be valid, and &lt;code>datetime!&lt;/code> to construct &lt;code>OffsetDateTime&lt;/code> values from a readable mini-DSL.&lt;/p>
&lt;p>We could define a &lt;code>comment!&lt;/code> macro that allowed &amp;ldquo;keyword-like&amp;rdquo; arguments to instantiate a test &lt;code>Comment&lt;/code> object, like this:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-rust" data-lang="rust">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">let&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">comment&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="fm">comment!&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">site_id&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">path&lt;/span>: &lt;span class="nc">url&lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;http://example.com/post.html&amp;#34;&lt;/span>&lt;span class="p">),&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Pros:&lt;/p>
&lt;ul>
&lt;li>&lt;strong>Concise.&lt;/strong> Same as the &lt;code>Default&lt;/code> approach: tests only declare the properties they must declare for the test to pass.&lt;/li>
&lt;/ul>
&lt;p>Cons:&lt;/p>
&lt;ul>
&lt;li>&lt;strong>Refactoring-unfriendly.&lt;/strong> The Rust auto-formatter does not reformat code inside macros. I rely on this feature too much these days because it&amp;rsquo;s very liberating to not have to care about manual formatting, so this is a non-option for me.&lt;/li>
&lt;/ul>
&lt;h1 id="option-4-the-builder-pattern">Option 4: The builder pattern&lt;/h1>
&lt;p>The next possibility is to use the builder pattern, which I have &lt;a href="/2020/12/builder-pattern-for-tests.html">previously leveraged to define declarative tests&lt;/a>. Constructing a &lt;code>Comment&lt;/code> would then look something like this and, in fact, that&amp;rsquo;s what I had in the code for a little while:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-rust" data-lang="rust">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">let&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">comment&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">CommentBuilder&lt;/span>::&lt;span class="n">new&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">site_id&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="fm">url!&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;https://example.com/page.html&amp;#34;&lt;/span>&lt;span class="p">),&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="fm">datetime!&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">2023&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">10&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">03&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">19&lt;/span>:&lt;span class="mi">25&lt;/span>:&lt;span class="mi">00&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="no">UTC&lt;/span>&lt;span class="p">),&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;Irrelevant text&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">unwrap&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">with_author&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;The author&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">unwrap&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">with_email&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;the-email@example.com&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">unwrap&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">build&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>This usage of a builder is a bit unorthodox and&amp;hellip; really ugly: the constructor takes positional arguments for all required fields and the various setters return errors when the input values cannot be converted to the inner types that back them. These design decisions came from the fact that I used this builder in non-test code too, so errors had to be propagated.&lt;/p>
&lt;p>But this is not the only way to define a builder. A more traditional application of the builder pattern would result in:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-rust" data-lang="rust">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">let&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">comment&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">CommentBuilder&lt;/span>::&lt;span class="n">default&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">site_id&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">site_id&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">url&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="fm">url!&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;https://example.com/page.html&amp;#34;&lt;/span>&lt;span class="p">)))&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">timestamp&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="fm">datetime!&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">2023&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">10&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">03&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">19&lt;/span>:&lt;span class="mi">25&lt;/span>:&lt;span class="mi">00&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="no">UTC&lt;/span>&lt;span class="p">))&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">content&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Irrelevant text&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">author&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;The author&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">email&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;the-email@example.com&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">build&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">unwrap&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>This second version of the pattern looks better in general (and you could argue that the original version was a mistake). So let&amp;rsquo;s analyze this second version.&lt;/p>
&lt;p>Pros:&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;strong>Automatic type conversions.&lt;/strong> The setters can &lt;a href="/2020/04/rust-into-trait.html">leverage &lt;code>Into&lt;/code>&lt;/a> and &lt;code>AsRef&lt;/code>, making it possible to call them quite naturally without needing to create auxiliary types by hand. Note how, for example, &lt;code>email()&lt;/code> takes a string even if the backing type is &lt;code>EmailAddress&lt;/code> because the setter accepts &lt;code>Into&amp;lt;EmailAddress&amp;gt;&lt;/code> and the type implements &lt;code>From&amp;lt;&amp;amp;'static str&amp;gt;&lt;/code> (in test builds &lt;em>only&lt;/em>).&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>Conciseness.&lt;/strong> As is the case for the &lt;code>Default&lt;/code> and the macro options, this solution also accepts specifying only the fields that are required for each test. The builder can set defaults for everything else.&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>Cons:&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;strong>Verbosity.&lt;/strong> This is no simpler than the &lt;code>Default&lt;/code> option and requires non-trivial code to implement the builder itself.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>Delayed validation.&lt;/strong> Delaying validation until the call to &lt;code>build()&lt;/code> isn&amp;rsquo;t always easy. Consider &lt;code>email&lt;/code> again: if we make the &lt;code>email()&lt;/code> setter construct the internal &lt;code>EmailAddress&lt;/code> object, then &lt;code>email()&lt;/code> has to either return an error (a requirement for production usage) or panic (if the builder is exclusively for tests). But if we try to delay error reporting until &lt;code>build()&lt;/code> is called, then the setter cannot leverage &lt;code>Into&lt;/code> and needs to either accept strings alone or already-constructed &lt;code>EmailAddress&lt;/code> objects.&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h1 id="option-5-helper-functions">Option 5: Helper functions&lt;/h1>
&lt;p>The final possibility is to define helper functions to instantiate our test objects. And if we are defining helper functions, those can do additional work like storing the objects in a database (which is what most of my tests need to do anyway). Here is an example of such a function:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-rust" data-lang="rust">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">let&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">mut&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">TestContext&lt;/span>::&lt;span class="n">setup&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c1">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kd">let&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">comment&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">put_comment&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">site_id&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="fm">url!&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;https://example.com/page.html&amp;#34;&lt;/span>&lt;span class="p">),&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="fm">datetime!&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">2023&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">10&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">03&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">19&lt;/span>:&lt;span class="mi">25&lt;/span>:&lt;span class="mi">00&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="no">UTC&lt;/span>&lt;span class="p">),&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;Hello&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nb">None&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">await&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Pros:&lt;/p>
&lt;ul>
&lt;li>&lt;strong>Extra logic.&lt;/strong> A helper function can take care of instantiating the test object, but can &lt;em>also&lt;/em> perform other operations such as persisting the object. For tests, this can turn out to be very useful in encapsulating sequences of operations.&lt;/li>
&lt;/ul>
&lt;p>Cons:&lt;/p>
&lt;ul>
&lt;li>&lt;strong>Inflexibility.&lt;/strong> Helper functions sound nice at first because they only take the fewest arguments possible to satisfy the needs of the tests. But things get unwieldy quickly: in the example above, you can already see a wart in the API because there is a confusing &lt;code>None&lt;/code> that should probably not be there. This ends happening because different tests need different properties to be set and a single function won&amp;rsquo;t satisfy them all, so you end up with parameterized helper functions that contain superfluous in the common case, or with multiple helper functions targeted at different test scenarios.&lt;/li>
&lt;/ul>
&lt;p>This approach is very tempting to use because declaring new functions is easy and looks simple, but I&amp;rsquo;ve &lt;em>never ever&lt;/em> seen it evolve well long-term in any language. Stay away except for the most trivial cases.&lt;/p>
&lt;h1 id="whats-best">What&amp;rsquo;s best?&lt;/h1>
&lt;p>To be honest&amp;hellip; I do not know. I have tried all of the above and I&amp;rsquo;m not completely satisfied with any option. To let you into a secret, the EndTRACKER data model currently contains a mishmash of all these options because I&amp;rsquo;ve been experimenting with new ideas over time and haven&amp;rsquo;t yet settled on the one I like the best. (Yes, yes, I know. Consistency should have trumped &amp;ldquo;prettiness&amp;rdquo;, but hey, I write side projects because I enjoy exploring different dark corners of my tech of choice.)&lt;/p>
&lt;p>Right now my thoughts are these: the builder pattern seems to be the nicest option &lt;em>if&lt;/em> you restrict it to tests, because then the builder can encapsulate error unwrapping and callers set all fields by name. However, I&amp;rsquo;m having a hard time justifying this option in favor of the &lt;code>Default&lt;/code> option, because callers look equally complex and the builder option requires a lot of boilerplate to write the builders themselves. And I kinda would like to use the macro option, but the fact that it doesn&amp;rsquo;t work well with auto-formatting is a deal breaker.&lt;/p>
&lt;p>What are &lt;em>your&lt;/em> thoughts?&lt;/p></description><enclosure url="https://jmmv.dev/images/2023-10-06-rust-test-structs.png" length="138979" type="image/jpeg"/></item><item><title>Good performance is not just big O</title><link>https://jmmv.dev/2023/09/performance-is-not-big-o.html</link><pubDate>Fri, 08 Sep 2023 10:00:00 -0700</pubDate><guid>https://jmmv.dev/2023/09/performance-is-not-big-o.html</guid><description>&lt;p>Having a fast and responsive app is orthogonal to &amp;ldquo;knowing your big &lt;i>O&lt;/i>s&amp;rdquo;. Unfortunately, most tech companies over-emphasize algorithms in interviews and downplay systems knowledge, and I believe that&amp;rsquo;s one reason behind sluggish apps and bloated systems.&lt;/p>
&lt;p>I&amp;rsquo;ve seen this play out repeatedly. Interviewers ask a LeetCode-style coding question, which is then followed by the ritual of discussing time and memory complexity. Candidates ace the answers. But then&amp;hellip; their &amp;ldquo;real&amp;rdquo; code suffers from subtle yet impactful performance problems.&lt;/p>
&lt;p>Focusing on big &lt;em>O&lt;/em> complexity rarely matters in most apps. Sure, it&amp;rsquo;s important to think about your algorithmic choices, but there are so many more details to worry about that have a direct impact on app performance and responsiveness. Let&amp;rsquo;s look at a bunch of them!&lt;/p>
&lt;div class="container action-highlight p-4 my-4 d-md-none">
&lt;div class="row text-center">
&lt;p>A blog on operating systems, programming languages, testing, build systems, my own software
projects and even personal productivity. Specifics include FreeBSD, Linux, Rust, Bazel and
EndBASIC.&lt;/p>
&lt;/div>
&lt;div class="row">
&lt;div class="col">
&lt;div class="form-group">
&lt;form action="https://endtracker.azurewebsites.net/api/sites/e8da9f62-b7ac-4fe9-bf20-7c527199a376/subscribers/add" method="post">
&lt;input type="text" name="email"
placeholder="Enter your email"
class="form-control input-sm text-center my-1"/>
&lt;button type="submit" class="btn btn-primary btn-block my-1">Subscribe&lt;/button>
&lt;/form>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;div class="row px-2">
&lt;div class="col col-sm-5 text-left">
&lt;small>&lt;span class="subscriber-count">0&lt;/span> subscribers&lt;/small>
&lt;/div>
&lt;div class="col col-sm-7 text-right">
&lt;p>
&lt;a rel="me" href="https://mastodon.online/@jmmv">
&lt;img src="/images/badges/mastodon-logo.svg" width="32px" height="32px" alt="Follow @jmmv on Mastodon">
&lt;/a>
&lt;a href="https://twitter.com/intent/follow?original_referer=https%3A%2F%2Fjmmv.dev%2F&amp;amp;screen_name=jmmv">
&lt;img src="/images/badges/Twitter_logo_blue.svg" width="32px" height="32px" alt="Follow @jmmv on Twitter">
&lt;/a>
&lt;a href="/feed.xml">&lt;img src="/images/badges/feed-icon-28x28.png" alt="RSS feed">&lt;/a>
&lt;/p>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;ul>
&lt;li>
&lt;p>&lt;strong>On algorithms&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>
&lt;p>📜 Is your complex O(n) algorithm faster than the trivial O(n&lt;sup>2&lt;/sup>)? Theoretical complexity matters, but know your expected value of &amp;ldquo;n&amp;rdquo;. The linear algorithm may be slower than the quadratic one for your specific scenarios and harder to prove correct.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>📜 Are you aware of how interfaces can bite you? E.g. in Java, the &lt;code>List.get&lt;/code> generic method will run in O(1) time for &lt;code>ArrayList&lt;/code> but in O(n) time for &lt;code>LinkedList&lt;/code>, and computing dict hash keys is likely not O(1). These are &lt;em>not&lt;/em> obvious at the call site.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>📜 Do you grasp how much work fits in short periods of time? 1ps, 1ns, 1us, 1ms, 1s&amp;hellip; they all sound small but their relative differences are huge. Map them to 1 second, 16 minutes, 277 hours, 380 months, and 317 centuries respectively. Not the same, huh?&lt;/p>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>On storage&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>
&lt;p>💾 Where does your data live? Different memory/storage mediums have vastly different access times. Know the relative differences in speed between register accesses (ps), L1/L2/L3 (few ns), RAM (many ns), SSD (us), HDD (few ms), and network (many ms).&lt;/p>
&lt;/li>
&lt;li>
&lt;p>💾 How do you access storage drives? Large sequential I/O operations are faster than lots of random small ones. This is true of HDDs (seek time is ~3-10ms), but also of SSDs due to the fact that processing more ops takes more processing time.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>💾 What about the file system on top of those drives? ext4, ZFS, NTFS&amp;hellip; they are all vastly different, and the types of I/O patterns that work well in one may be slow in another.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>💾 Are you accessing an SSD or an old spinning hard disk? Hard disks still exist. It might be safe to assume SSDs for certain apps, but not always. E.g. users may store large photo libraries in HDDs: can you handle I/O from those efficiently?&lt;/p>
&lt;/li>
&lt;li>
&lt;p>💾 Are you doing pure data copies via the CPU? There are features like DMA to offload data transfers to I/O devices, and there are features to minimize userspace&amp;lt;-&amp;gt;kernel copies. But, in any case, memory bandwidth isn&amp;rsquo;t free and is rarely thought about.&lt;/p>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>On networking&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>
&lt;p>🌐 Do you know that high latency usually limits max bandwidth? Bandwidth and latency are two orthogonal metrics. Most networked apps will probably feel fine on a low-bandwidth connection but will feel terrible on a high-latency one. Simulate these scenarios.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>🌐 How do you handle high network latency? Does your code block, slowing down everything else? Do you really have to block the UI? Can you schedule other work too happen in the meantime?&lt;/p>
&lt;/li>
&lt;li>
&lt;p>🌐 How many network requests do you need per interaction? Each request adds a multi-ms penalty and every request increases the chances of hitting high latency. If a service you depend on gives you p50=10ms and p99=1s, you&amp;rsquo;ll hit a 1s delay if you send 100 requests.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>🌐 How do you handle retries on failed requests? Any retry will tank performance and how you expose or hide what&amp;rsquo;s going on can make a world of a difference. Perception matters.&lt;/p>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>On data handling&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>
&lt;p>❄️ Are you using your database&amp;rsquo;s query facilities or are you fetching all data and then filtering on your own? Databases can perform elaborate queries. Favor running those on the database: the server is closer to the data and you&amp;rsquo;ll minimize network transfers.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>❄️ Are your database queries degrading to full table scans? Maybe you don&amp;rsquo;t have the right indexes or partitioning schemes to support the common queries that your app needs. Analyze and profile query execution. You probably don&amp;rsquo;t need to jump to NoSQL.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>🪵 How many log messages do you emit? Logging is not free. It has a cost on performance (I&amp;rsquo;ve seen servers spend ~20% of their CPU &lt;em>just&lt;/em> for background logging, all the time), and noisy logs also have an operational cost.&lt;/p>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>On CPU and memory&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>
&lt;p>🖥️ How do you lay large amounts of data in memory? What are the access patterns? Cache locality matters. Remember the relative differences in access times between the L1, L2 and L3 caches vs. main memory (days vs. years if scaled up).&lt;/p>
&lt;/li>
&lt;li>
&lt;p>🖥️ How data-intensive are your tight loops? It&amp;rsquo;s easy to think about CPU speed, RAM usage and I/O times&amp;hellip; but memory bandwidth is a fourth dimension that almost nobody thinks about, and it is becoming scarcer with faster CPUs and I/O.&lt;/p>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>On concurrency&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>
&lt;p>🧵 Do you take advantage of multiple cores? Single cores aren&amp;rsquo;t getting faster fast enough anymore, but computers usually have cores to spare. Can you use them at all? Effectively?&lt;/p>
&lt;/li>
&lt;li>
&lt;p>🧵 Do you use multiple threads to parallelize CPU-intensive operations, or do you use them to handle blocking I/O? In the former case, you want as many threads as cores. In the latter, switching to an event loop model may work better than a large thread pool.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>🧵 Do you perform expensive computation on the thread that&amp;rsquo;s responsive for the app&amp;rsquo;s UI? This will introduce pauses and render your app unusable for periods of time, which will make it feel slow. Perception matters.&lt;/p>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>On graphics&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>
&lt;p>✏️ Are you rendering directly onto the screen? Flushing your drawing operations right away? Read on double buffering, but beware of the latency you introduce by delaying the final display.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>✏️ Are you leveraging your graphic card&amp;rsquo;s features, or are you drawing on the CPU? Contrary to popular belief, fancy desktop effects are not expensive if done on the GPU&amp;mdash;and, actually, doing them on the GPU frees CPU resources.&lt;/p>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>On development time&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>
&lt;p>🗣️ How much performance are you leaving on the table by &amp;ldquo;coding faster&amp;rdquo; in an interpreted language? Computers might be &amp;ldquo;fast enough&amp;rdquo; now, but interpreted languages tend to be slower than compiled ones and may make the overall system sluggish.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>🪨 How big is your compiled app? Multi-MB apps are a problem when downloaded over the network, but they are also a problem on disk because they are slow to install and uninstall. Big apps may run fast, but they start slow. Perception matters.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>⌚ How long does your code take to compile? If it takes too long, the team suffers and features and bug fixes will be delayed. Different choices in how you write code and how you modularize it can bring big differences in productivity.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>⌚ How long do the tests take to run? If they take too long, they won&amp;rsquo;t be run on every commit, introducing friction for everyone else down the road and delaying product launches.&lt;/p>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>That&amp;rsquo;s all I could think of for now! I&amp;rsquo;m not a performance expert at all, but I do like systems and enjoy thinking about their holistic behavior. If you have any more tips, feel free to add them to the thread and I may incorporate them into the list!&lt;/p></description><enclosure url="https://jmmv.dev/images/2023-09-08-speed-bumps-limit.jpg" length="372231" type="image/jpeg"/></item><item><title>Costs exposed: Frameworks</title><link>https://jmmv.dev/2023/08/costs-exposed-frameworks.html</link><pubDate>Thu, 31 Aug 2023 07:00:00 -0700</pubDate><guid>https://jmmv.dev/2023/08/costs-exposed-frameworks.html</guid><description>&lt;p>&lt;a href="/2023/06/fast-machines-slow-machines.html">&amp;ldquo;Fast machines, slow machines&amp;rdquo;&lt;/a>&amp;hellip; ah, the post that spawned these series. As I frantically typed that article while replying to angry tweets, the thought came to mind: software engineering as a whole is hyper-focused on lowering the costs to write new code, yet there is a disregard for the costs that these improvements bring to other disciplines in a company on even to end users.&lt;/p>
&lt;p>So, in this series finale, I want to compare how some choices that apparently lower development costs actually increase costs elsewhere. I also want to highlight how, if we made different decisions during development, we could possibly expose those extra costs early on. This is beneficial because exposing costs upfront allows us to make tough choices when there is still a chance of changing course.&lt;/p>
&lt;p>To make things specific, I will look at how the use of modern frameworks that facilitate development can end up hurting performance, reliability, and usability. So let&amp;rsquo;s start with a three-part rant first (sorry) and then let&amp;rsquo;s look at what we might do.&lt;/p>
&lt;div class="container action-highlight p-4 my-4 d-md-none">
&lt;div class="row text-center">
&lt;p>A blog on operating systems, programming languages, testing, build systems, my own software
projects and even personal productivity. Specifics include FreeBSD, Linux, Rust, Bazel and
EndBASIC.&lt;/p>
&lt;/div>
&lt;div class="row">
&lt;div class="col">
&lt;div class="form-group">
&lt;form action="https://endtracker.azurewebsites.net/api/sites/e8da9f62-b7ac-4fe9-bf20-7c527199a376/subscribers/add" method="post">
&lt;input type="text" name="email"
placeholder="Enter your email"
class="form-control input-sm text-center my-1"/>
&lt;button type="submit" class="btn btn-primary btn-block my-1">Subscribe&lt;/button>
&lt;/form>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;div class="row px-2">
&lt;div class="col col-sm-5 text-left">
&lt;small>&lt;span class="subscriber-count">0&lt;/span> subscribers&lt;/small>
&lt;/div>
&lt;div class="col col-sm-7 text-right">
&lt;p>
&lt;a rel="me" href="https://mastodon.online/@jmmv">
&lt;img src="/images/badges/mastodon-logo.svg" width="32px" height="32px" alt="Follow @jmmv on Mastodon">
&lt;/a>
&lt;a href="https://twitter.com/intent/follow?original_referer=https%3A%2F%2Fjmmv.dev%2F&amp;amp;screen_name=jmmv">
&lt;img src="/images/badges/Twitter_logo_blue.svg" width="32px" height="32px" alt="Follow @jmmv on Twitter">
&lt;/a>
&lt;a href="/feed.xml">&lt;img src="/images/badges/feed-icon-28x28.png" alt="RSS feed">&lt;/a>
&lt;/p>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;hr>
&lt;p>First, we have performance problems caused by the layers upon layers of &lt;a href="https://www.joelonsoftware.com/2002/11/11/the-law-of-leaky-abstractions/">leaky abstractions&lt;/a> that frameworks add.&lt;/p>
&lt;p>Every layer of abstraction that we add to a piece of software hurts performance: each layer adds code and, with very few exceptions, more code requires more cycles to build and run. As an example, think about the ever-increasing network round trips that the simplest interaction with an app has to perform and how poorly these degrade with bad network conditions. Or think about how slowly a run-of-the-mill Electron app starts and how much disk space it takes.&lt;/p>
&lt;p>Sadly, this piling of abstraction layers has been happening for years. One possible rationale: the benefits of adding one more layer look great on paper and the incremental cost of such layer tends to be small, so the cost is easy to justify. It makes sense every time. Unfortunately, when many of these seemingly-small costs compound, systems become sluggish.&lt;/p>
&lt;p>&amp;ldquo;But the developers saved some time!&amp;rdquo; I hear&amp;hellip; while these savings in coding costs transform into &lt;em>everyone else&lt;/em> requiring more powerful machines over time. End users have to upgrade their phones and laptops periodically just to keep up with the software bloat treadmill, and what they can do with their newer hardware isn&amp;rsquo;t massively different from what they could do with the iteration that came right before.&lt;/p>
&lt;p>Plus these slowdowns impact production servers as well, not just end users, and the extra costs in the datacenter are orders of magnitude larger than what a single user will experience. I&amp;rsquo;m still shocked by how, for example, Google has insanely-fast internal infrastructure&amp;hellip; yet those incredible systems exist to support huge binaries and highly-coupled micro-services that maybe shouldn&amp;rsquo;t have existed in their current form. For example, we did have discussions in the Bazel team about adding limits to what a build should support, and we did start &lt;a href="/2021/03/build-time-slis-slos.html">measuring costs&lt;/a> to try to address those&amp;hellip; but it was too late to tame the beast.&lt;/p>
&lt;hr>
&lt;p>Second, we have &amp;ldquo;DevOps problems&amp;rdquo; caused by the &amp;ldquo;easy-to-use&amp;rdquo; frameworks and their tooling.&lt;/p>
&lt;p>The fact that writing code is easier than before does not necessarily mean that deploying and maintaining the resulting systems is easier too. In fact, the opposite tends to happen: these days it sounds inconceivable to launch a service on just one machine, while it was the norm not so long ago. &amp;ldquo;How will it scale to billions of users? How will it have 100 9s of reliability?&amp;rdquo; everyone asks, without facing the reality that scaling needs may never arise or that occasional downtime is acceptable.&lt;/p>
&lt;p>Instead, we adopt languages with complex runtimes and fragile and dog-slow tooling, and we push micro-service architectures from the get go. We end up with systems that require cluster orchestrators like Kubernetes, distributed storage, messaging queues, complex monitoring systems, containers&amp;hellip; or, in other words, a myriad of dependencies, each needing a different language runtime, deployment practices, and operational checklists. Running these systems now requires multiple large SRE teams.&lt;/p>
&lt;p>Paradoxically, I would even say that the risk of downtime in these often-over-engineered systems is higher than the simpler alternatives. Operating a single machine exposed the cost of needing reliable hardware, power, and a few sysadmins, while operating large distributed systems hides such cost behind &amp;ldquo;unavoidable&amp;rdquo; cloud bills, confusing reporting structures, and a bunch of &lt;a href="/2023/08/costs-exposed-on-call-ticket-handling.html">poorly-run support rotations&lt;/a>. But hey, these problems are so detached from the initial coding activities&amp;mdash;and sometimes from the developers themselves!&amp;mdash;that it&amp;rsquo;s hard to think about the consequences of favoring certain languages or frameworks.&lt;/p>
&lt;hr>
&lt;p>And third, we have extra usability costs caused by unification where unification wasn&amp;rsquo;t asked for.&lt;/p>
&lt;p>The obvious example here is the push towards single codebases that can run on the web, iOS, and Android, ranging from large wide-screen monitors to tiny portrait phone screens. Developers rejoice in their ability to share code&amp;mdash;they can ship faster!&amp;mdash;but&amp;hellip; are users happy? Apps are now their own silos that behave differently from all others and don&amp;rsquo;t integrate with the platforms their run on. &amp;ldquo;Too much whitespace&amp;rdquo; is a common cry.&lt;/p>
&lt;p>Now, don&amp;rsquo;t get me wrong. I am a developer too, and &lt;em>of course&lt;/em> I like frameworks that allow me to avoid code duplication. In fact, code duplication is a problem from a usability perspective too because bugs and features will differ in different versions of the same app. But why should we, the users, pay for a loss of platform uniformity and usability so that companies can ship a product faster?&lt;/p>
&lt;hr>
&lt;p>Anyhow, enough for the rant.&lt;/p>
&lt;p>What can we do about this? I&amp;rsquo;m not sure if there is much we &lt;em>can&lt;/em> do. The incentives just aren&amp;rsquo;t there as Luke Plant claims in &lt;a href="https://lukeplant.me.uk/blog/posts/no-one-actually-wants-simplicity/">&amp;ldquo;No one actually wants simplicity&amp;rdquo;&lt;/a>. And even if we &lt;em>could&lt;/em> do something, we may not be able to like Yossi Kreinin describes in &lt;a href="https://yosefk.com/blog/dont-ask-if-a-monorepo-is-good-for-you-ask-if-youre-good-enough-for-a-monorepo.html">&amp;ldquo;Don&amp;rsquo;t ask if a monorepo is good for you&amp;mdash;ask if you&amp;rsquo;re good enough for a monorepo&amp;rdquo;&lt;/a>.&lt;/p>
&lt;p>But here is the thing: it is &lt;em>good&lt;/em> that building prototypes for new apps and features is cheaper and faster than ever before. Companies can quickly try and validate new products and features. Solo developers can launch apps in just a few days and have them reach thousands or millions of people. Yet&amp;hellip; do the benefits really last? These initial cost-saving measures end up hiding bigger costs down the road. Initial prototypes are never thrown away in favor of a rewrite&amp;mdash;as everyone says you should really do&amp;mdash;and once the ball of mud grows, it&amp;rsquo;s too expensive and too late to tame it.&lt;/p>
&lt;p>Another problem is that most engineers haven&amp;rsquo;t done any performance work. It is common, based on my observations in dozens of interviews, to believe that performance is about big-O notation. But, usually, that doesn&amp;rsquo;t matter. What matters to deliver a great user experience lies in other dimensions like minimizing I/O operations, tuning indexes in a database, caring about cache locality, or keeping binary sizes under control. There is a real need for mentoring&amp;hellip; but these activities are rarely rewarded organizationally.&lt;/p>
&lt;p>I would ask that, if you happen to do project planning or headcount allocation, do not treat coding as special. Yes, coding is important, but the cost of writing &lt;em>new&lt;/em> code is only a small fraction of delivering a product. Once a product is past a certain size, all other costs like refactoring or servicing become more important, and the costs that were saved by easing coding come to smear everything else. And, please, remember about the impact that these choices have on end user performance.&lt;/p>
&lt;hr>
&lt;p>Let&amp;rsquo;s end on a positive tone because we do have some nice things.&lt;/p>
&lt;p>I&amp;rsquo;m happy that Go has brought back the idea that trivial deployments and software distribution are beneficial thanks to its push for static binaries. Developers have lost some of their freedom by how opinionated Go is, but everyone else has gained something.&lt;/p>
&lt;p>I&amp;rsquo;m happy that some companies push for homogenization to reduce operational costs at the expense of limiting development choices. See how Google is famous for only allowing certain programming languages in production services, or how Snowflake is adopting Bazel to remove moving parts from the build process. These actions reduce developer choice (a cost to them) but bring savings elsewhere.&lt;/p>
&lt;p>And I&amp;rsquo;m happy that Rust&amp;rsquo;s memory safety and zero-cost abstractions increase initial development cost at the expense of faster and more reliable apps for end users. Oh, and it simplifies future maintenance costs for developers too! Refactorings are a joy to execute in a Rust code base.&lt;/p>
&lt;p>Now pardon me while I go back to work unironically on &lt;a href="/software/iii-iv.html">my framework&lt;/a>.&lt;/p></description><enclosure url="https://jmmv.dev/images/2023-08-31-dirt-pile.jpg" length="773447" type="image/jpeg"/></item><item><title>Costs exposed: On-call ticket handling</title><link>https://jmmv.dev/2023/08/costs-exposed-on-call-ticket-handling.html</link><pubDate>Sat, 26 Aug 2023 07:20:00 -0700</pubDate><guid>https://jmmv.dev/2023/08/costs-exposed-on-call-ticket-handling.html</guid><description>&lt;p>In the previous post, I proposed that certain engineering practices expose systemic costs and help with planning while other practices hide those same costs and disturb ongoing plans.&lt;/p>
&lt;p>The idea I&amp;rsquo;m trying to convey is hard to communicate in the abstract so, in that post, I used the differences between a monorepo and a multirepo setup as an example. Today, I&amp;rsquo;ll expore a different scenario to support the same idea. I&amp;rsquo;m going to talk about how certain ticket assignment practices during on-call operations can expose service support costs vs. how other practices hide them.&lt;/p>
&lt;p>Keep in mind that, just like in the previous post, I do not want to compare the general merits of one approach vs. the other. The &lt;em>only&lt;/em> thing I want to compare is whether one approach centralizes toil and allows management to quantify its cost vs. how another approach hides toil by smearing it over the whole team in hard-to-quantify ways. Whether management &lt;em>actually does something&lt;/em> to correct the situation once the costs are exposed is a different story.&lt;/p>
&lt;div class="container action-highlight p-4 my-4 d-md-none">
&lt;div class="row text-center">
&lt;p>A blog on operating systems, programming languages, testing, build systems, my own software
projects and even personal productivity. Specifics include FreeBSD, Linux, Rust, Bazel and
EndBASIC.&lt;/p>
&lt;/div>
&lt;div class="row">
&lt;div class="col">
&lt;div class="form-group">
&lt;form action="https://endtracker.azurewebsites.net/api/sites/e8da9f62-b7ac-4fe9-bf20-7c527199a376/subscribers/add" method="post">
&lt;input type="text" name="email"
placeholder="Enter your email"
class="form-control input-sm text-center my-1"/>
&lt;button type="submit" class="btn btn-primary btn-block my-1">Subscribe&lt;/button>
&lt;/form>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;div class="row px-2">
&lt;div class="col col-sm-5 text-left">
&lt;small>&lt;span class="subscriber-count">0&lt;/span> subscribers&lt;/small>
&lt;/div>
&lt;div class="col col-sm-7 text-right">
&lt;p>
&lt;a rel="me" href="https://mastodon.online/@jmmv">
&lt;img src="/images/badges/mastodon-logo.svg" width="32px" height="32px" alt="Follow @jmmv on Mastodon">
&lt;/a>
&lt;a href="https://twitter.com/intent/follow?original_referer=https%3A%2F%2Fjmmv.dev%2F&amp;amp;screen_name=jmmv">
&lt;img src="/images/badges/Twitter_logo_blue.svg" width="32px" height="32px" alt="Follow @jmmv on Twitter">
&lt;/a>
&lt;a href="/feed.xml">&lt;img src="/images/badges/feed-icon-28x28.png" alt="RSS feed">&lt;/a>
&lt;/p>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;p>Let&amp;rsquo;s begin.&lt;/p>
&lt;hr>
&lt;p>On-call shifts are common in software development teams, yet I think it&amp;rsquo;s fair to say that most developers hate and fear them. Which is a natural reaction because, in general, on-call rotations are haphazardly run.&lt;/p>
&lt;p>In a well-functional on-call rotation, individuals are either &amp;ldquo;on&amp;rdquo; or &amp;ldquo;off&amp;rdquo;. When they are &amp;ldquo;on&amp;rdquo;, their only responsibility is to attend to incoming tickets: they are not expected to work on their deliverables. When they are &amp;ldquo;off&amp;rdquo;, their only responsibility is to attend to their deliverables: they can rest assured that the current on-call will shield them from production fires.&lt;/p>
&lt;p>Now, it &lt;em>is&lt;/em> possible that the team&amp;rsquo;s deliverables will have to change &lt;em>because of&lt;/em> production incidents, but those changes in the plan will be factored into the schedule, say, in the following sprint or quarterly planning meeting. Until that happens, the &amp;ldquo;off&amp;rdquo; people don&amp;rsquo;t have to be distracted by ongoing fires. I know, I know, this is an extremely hard-to-achieve ideal, but I&amp;rsquo;ve seen it work in mature SRE teams and being on-call for those was a reasonable experience. I highly recommend watching the &lt;a href="https://www.usenix.org/conference/srecon15europe/program/presentation/oconnor">&amp;ldquo;Bad Machinery - Managing Interrupts Under Load&amp;rdquo;&lt;/a> presentation by Dave O&amp;rsquo;Connor on this topic.&lt;/p>
&lt;p>Unfortunately, while most on-call rotations are well-intentioned, they are &lt;em>not&lt;/em> well-functioning. This is particularly true of large teams (30+ people) divided in subteams (4-10 people each). In such a large organization, no single individual can realistically be on-call for the whole service due to its scope&amp;mdash;yet teams insist on putting a single person on-call. But is that person the only one that&amp;rsquo;s &amp;ldquo;on&amp;rdquo;? Nope. In reality, many more team members are busy with past incidents.&lt;/p>
&lt;hr>
&lt;p>Here is how that happens: the policy for incoming tickets is to assign them to the current on-call individual in a sticky manner: said individual &amp;ldquo;owns&amp;rdquo; those tickets until they are either resolved or are transferred to a Subject Matter Expert (SME)&amp;mdash;no matter if they are on-call or not. This fire-hose approach &lt;em>seems&lt;/em> to work&amp;hellip; but it has a draining cost on the individual team members and impacts overall team productivity, leading to delayed deliverables and production issues that are never fixed.&lt;/p>
&lt;p>These are the reasons that are often cited to justify this fire-hose approach&amp;hellip; along with why they aren&amp;rsquo;t a great idea:&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;em>&amp;ldquo;The process is &lt;strong>fair&lt;/strong> from a time-sharing perspective!&amp;rdquo;&lt;/em>&lt;/p>
&lt;p>Well, no, it just &lt;em>looks&lt;/em> fair on paper. What this practice does is push operations under the rug. Incoming issues are randomly spread across team members. It is very likely that those issues will &lt;em>not&lt;/em> be resolved during the on-call&amp;rsquo;s scheduled shift. As a result, every individual continues to own incidents well-past their &amp;ldquo;on&amp;rdquo; time, and because those are production incidents, the assignees are obviously expected to work and resolve &amp;ldquo;their&amp;rdquo; incidents &amp;ldquo;with priority&amp;rdquo;, preempting their project work.&lt;/p>
&lt;p>Now, the counter-argument to this is to say that these individuals should transfer incidents to the SME as soon as their &amp;ldquo;on&amp;rdquo; shift ends. But there are two problems with this. The first is that an SME may not even exist in the team anymore. The second is that this assignment process is adversarial: junior folks will almost-never transfer an incident to a senior person because&amp;hellip; of the next point.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;em>&amp;ldquo;Everyone should be able to be on-call for the whole service!&amp;rdquo;&lt;/em>&lt;/p>
&lt;p>Yeah, that&amp;rsquo;s a great ideal: it&amp;rsquo;d be awesome if everyone in the team were able to handle any incoming incident, but that is not what happens. Large teams tend to grow to cover too many responsibilities too fast, so it ends up being impossible for any one individual to know everything about the system.&lt;/p>
&lt;p>There are select exceptions though: the leads that &lt;em>created&lt;/em> the product. These folks&amp;mdash;if they are still around&amp;mdash;have grown with the product and have sufficient knowledge to troubleshoot most problems under the pressure of a production outage. Unfortunately, these outlier folks tend to be the ones with the power to change the status quo. In turn, this makes change harder because they don&amp;rsquo;t realize that there is a problem.&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>As a result of these two attitudes, on-call operations seem &lt;em>cheap&lt;/em> from the management&amp;rsquo;s perspective: there is only one person on-call at any given time for the whole team who, somehow, manages to resolve all issues assigned to them. There are often delays in resolving incidents and there are repeats of those outages, sure, but they aren&amp;rsquo;t large enough or frequent enough to be concerning. (Narrator voice: until they are.)&lt;/p>
&lt;p>What&amp;rsquo;s not so clear is that &lt;em>every other team member&lt;/em> that is not on-call is also wasting time to resolve incidents because they are keeping an eye on past and ongoing issues. First, previous on-call individuals carry past issues well into their &amp;ldquo;off&amp;rdquo; periods, disturbing their deliverables. Remember that context switches are harmful to productivity, and those switches are even worse if they require talking to customers. And, second, past and new incidents pull random engineers from the team to help, preempting their assigned work.&lt;/p>
&lt;p>Under this model, it is really difficult to quantify how much time is spent caring for production, so it is impossible to properly budget such time against feature work. &amp;ldquo;Just put one person on-call&amp;rdquo; should not be a convincing argument without data. It is also hard to identify recurring issues and follow up on them with long-term fixes, so the service&amp;rsquo;s quality degrades over time.&lt;/p>
&lt;hr>
&lt;p>What&amp;rsquo;s the alternative, assuming there is one? It turns out that there is, and it is what I mentioned at the beginning of the post:&lt;/p>
&lt;ol>
&lt;li>a clear &amp;ldquo;on&amp;rdquo; / &amp;ldquo;off&amp;rdquo; split for operational support;&lt;/li>
&lt;li>a clear process to transfer ongoing incidents to the following on-call person, along with an expectation that this is the normal thing to do; and&lt;/li>
&lt;li>a clear distinction between mitigation practices and resolution efforts.&lt;/li>
&lt;/ol>
&lt;p>Simply put: whenever a person is on-call, all incidents come to this person and this person owns them until they are mitigated &lt;em>or&lt;/em> until their shift ends, whatever happens first. Once mitigated, the on-call files follow-up repair tasks, and these tasks are assessed against other priorities in the following planning meeting. The main difference from the fire-hose approach is that, once a person&amp;rsquo;s &amp;ldquo;on&amp;rdquo; shift ends, they can get back to their past-assigned and pre-planned work.&lt;/p>
&lt;p>If these practices are strictly followed, it quickly becomes clear whether a single on-call person can sustain the health of the service or not. If a single person cannot, incidents will backlog or they will not be mitigated correctly. At that point, management will have to allocate additional people to handle incidents. And if they assign extra people to on-call operations, they can also choose to invest in root cause resolution to reduce overall service load, reducing the total number of people assigned to operations at any given time. (But yes, whether this extra investment happens or not is orthogonal to &lt;em>exposing costs&lt;/em> and I don&amp;rsquo;t want to get into that. Sometimes management will simply not want to invest in extra reliability and on-call health will be terrible. Run if you can?)&lt;/p>
&lt;hr>
&lt;p>To summarize: this is yet another case where the practice of doing &amp;ldquo;the right thing&amp;rdquo; (in SRE terms) by forcing a strict &amp;ldquo;on&amp;rdquo; / &amp;ldquo;off&amp;rdquo; division exposes the reality that a system may be more expensive to operate than previously believed, whereas the common practice of assigning tickets in a sticky manner is equally expensive, if not more so, while also causing dissatisfaction.&lt;/p>
&lt;p>In the next post, I&amp;rsquo;ll conclude this series by looking at how fancy software frameworks hide non-programming costs and how those costs are often eaten by people that may not have a choice.&lt;/p></description><enclosure url="https://jmmv.dev/images/2023-08-26-tickets-phone.jpg" length="539252" type="image/jpeg"/></item><item><title>Costs exposed: Monorepo vs. multirepo</title><link>https://jmmv.dev/2023/08/costs-exposed-monorepo-multirepo.html</link><pubDate>Wed, 23 Aug 2023 06:00:00 -0700</pubDate><guid>https://jmmv.dev/2023/08/costs-exposed-monorepo-multirepo.html</guid><description>&lt;p>In software engineering organizations, there are certain practices that keep costs under control even if those &lt;em>seem&lt;/em> more expensive at first. Unfortunately, because such practices &lt;em>feel&lt;/em> more expensive, teams choose to keep their status quo even when they know it is suboptimal. This choice ends up hurting productivity and morale because planned work is continuously interrupted, which in turn drags project completion.&lt;/p>
&lt;p>The reason I say &lt;em>seem&lt;/em> and not &lt;em>are&lt;/em> is because the alternatives to these cost-exposing practices also suffer from costs. The difference is that, while the former surface costs, leading to the need to allocate time and people to infrastructure work, the latter keeps the costs smeared over teams and individuals in ways that are difficult to account and plan for.&lt;/p>
&lt;p>To illustrate what I&amp;rsquo;m trying to say, I&amp;rsquo;ll present three different scenarios in which this opinion applies. All of these case studies come from past personal experiences while working in different teams and projects. The first one covered in this post is about the adoption of a monorepo vs. the use of multiple different repositories. The other two will come in follow-up articles.&lt;/p>
&lt;div class="container action-highlight p-4 my-4 d-md-none">
&lt;div class="row text-center">
&lt;p>A blog on operating systems, programming languages, testing, build systems, my own software
projects and even personal productivity. Specifics include FreeBSD, Linux, Rust, Bazel and
EndBASIC.&lt;/p>
&lt;/div>
&lt;div class="row">
&lt;div class="col">
&lt;div class="form-group">
&lt;form action="https://endtracker.azurewebsites.net/api/sites/e8da9f62-b7ac-4fe9-bf20-7c527199a376/subscribers/add" method="post">
&lt;input type="text" name="email"
placeholder="Enter your email"
class="form-control input-sm text-center my-1"/>
&lt;button type="submit" class="btn btn-primary btn-block my-1">Subscribe&lt;/button>
&lt;/form>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;div class="row px-2">
&lt;div class="col col-sm-5 text-left">
&lt;small>&lt;span class="subscriber-count">0&lt;/span> subscribers&lt;/small>
&lt;/div>
&lt;div class="col col-sm-7 text-right">
&lt;p>
&lt;a rel="me" href="https://mastodon.online/@jmmv">
&lt;img src="/images/badges/mastodon-logo.svg" width="32px" height="32px" alt="Follow @jmmv on Mastodon">
&lt;/a>
&lt;a href="https://twitter.com/intent/follow?original_referer=https%3A%2F%2Fjmmv.dev%2F&amp;amp;screen_name=jmmv">
&lt;img src="/images/badges/Twitter_logo_blue.svg" width="32px" height="32px" alt="Follow @jmmv on Twitter">
&lt;/a>
&lt;a href="/feed.xml">&lt;img src="/images/badges/feed-icon-28x28.png" alt="RSS feed">&lt;/a>
&lt;/p>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;hr>
&lt;p>Monorepos are in fashion. In fact, I like to think that they have been a good idea for large organizations since before Google made them popular: the BSDs have followed this model from their inception in the 1970s even if the &amp;ldquo;monorepo&amp;rdquo; term wasn&amp;rsquo;t coined yet. But I&amp;rsquo;m not writing about this topic just because of the BSDs. I&amp;rsquo;m writing about this topic because I previously worked at Google, and Google made the conscious choice to fund a monorepo for the benefit of everyone in the company. I&amp;rsquo;m writing about this because I also worked in the Azure Storage team, which ran a monorepo and a bunch of ancillary repos but with a small team to support them. And I&amp;rsquo;m writing about this because I&amp;rsquo;m now at Snowflake, helping with the adoption of monorepo tooling with a well-staffed team.&lt;/p>
&lt;p>Adopting a monorepo can bring advantages such as code sharing, unified tooling, and a standardized development experience. However, monorepos are also &lt;em>&lt;strong>visibly expensive&lt;/strong>&lt;/em>. And because they seem expensive, cost is often an objection to adopting one. And for good reason: if you decide to migrate to a monorepo without proper funding to maintain the build system, the language toolchains, the CI system, the release process, the practices to follow, etc. the monorepo will eventually collapse under its own weight.&lt;/p>
&lt;p>What&amp;rsquo;s not so obvious&amp;mdash;and what the objectors are missing&amp;mdash;is that these maintenance costs exist in multirepo environments too. The difference is that, in multirepo setups, these costs fly under the radar because they are smeared across &lt;em>every&lt;/em> repo. When taken individually, the costs seem insignificant, but in unison, they make a taxing impact on every team member.&lt;/p>
&lt;hr>
&lt;p>Here is what happens in the typical multirepo scenario: different teams own different repos and are responsible for their maintenance. Two arguments that arise in their favor when proposing a switch to a monorepo are:&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;em>&amp;ldquo;Repo maintenance is a shared responsibility. We should all care about their health!&amp;rdquo;&lt;/em>&lt;/p>
&lt;p>When ownership is shared&amp;hellip; nobody owns anything. When the repos are small and the teams are small, there is no designated individual to mend them. Build breakages will arise, modernization changes will be necessary, flaky tests will grow out of control&amp;hellip; and at some point, when things have gotten so bad that productivity grinds to a halt, &amp;ldquo;someone&amp;rdquo; will have to do something.&lt;/p>
&lt;p>Who will? In the best case, the &amp;ldquo;person or people that care&amp;rdquo; will take it upon themselves to resolve these issues in their &amp;ldquo;free time&amp;rdquo;. But because maintaining the repository is not their primary job, these issues will be preempting their assigned tasks. In the worst case&amp;hellip; well, there is nobody that cares or nobody with the expertise to do anything, thus the problems may go unfixed or they may be &amp;ldquo;fixed&amp;rdquo; in a haphazard way, causing toil for everyone else.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;em>&amp;ldquo;These side repos are not that important&amp;hellip; don&amp;rsquo;t waste time on them!&amp;rdquo;&lt;/em>&lt;/p>
&lt;p>Eventually, though, some repos become more important than others: maybe because they are used more, maybe because they contain the majority of the company&amp;rsquo;s product code, or maybe because your ongoing migration to the monorepo stops halfway through.&lt;/p>
&lt;p>The important repos see more care in their tooling&amp;mdash;they probably have a dedicated team to maintain them&amp;mdash;but the others lag behind. Maybe these side repos get stuck with an old version of the compiler because upgrading them wasn&amp;rsquo;t done in the past and doing so now is difficult. Maybe they do not have the right PR validation checks set up, which causes their tests to rot. Maybe there are no enforced coding standards, so their contents are a mess. Maybe they just are &lt;em>different&lt;/em> than the main repo&amp;mdash;different build system, different language&amp;mdash;requiring a different skillset to interact with them.&lt;/p>
&lt;p>Whatever the reasons are, these side repos are full of sharp corners that slow down any activities to change them. People dread doing such changes or they do the wrong thing because there is no incentive to keep things tidy.&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>While these arguments in defense of monorepos sound reasonable, they end up causing a continuous drag on team productivity and morale. When engineers work with suboptimal tooling day in and day out without any clear path to make things better, they grow disillusioned with the engineering practices and will eventually want to jump ship.&lt;/p>
&lt;hr>
&lt;p>Compare these issues to a monorepo setup: when the infrastructure breaks, it is clear which team to call; after all, it is their mandate to budget time to fix problems and to plan and execute major quality-of-life improvements. And when the infrastructure team performs a change, the change benefits &lt;em>everyone&lt;/em> without requiring all of the smaller teams to do anything on their own. As an engineer, it is much easier to feel accomplished due to the larger-scope task and it is easier to justify impact at performance review time.&lt;/p>
&lt;p>The costs that the monorepo brings to light are clear, while the costs of the multirepo approach are pushed under the rug and slowly become a source of toil paid by all teams. This toil usually falls under the radar because there is no single front-line manager that can assess the systemic problems company-wide, so the problems never get resolved. And because every team is only impacted &amp;ldquo;a little bit&amp;rdquo;, it is difficult to quantify how much this type of toil costs in terms of productivity in the organization.&lt;/p>
&lt;p>So, while adopting a monorepo isn&amp;rsquo;t the right choice for everyone, do not glance over the option to migrate to one just because you think it&amp;rsquo;s more expensive to run. Look at your current practices and see how much effort your engineers waste dealing with suboptimal tooling because nobody has the chance to make things better in a significant manner.&lt;/p>
&lt;p>And if you &lt;em>do&lt;/em> decide to migrate to a monorepo without knowing any of this upfront, know that these cost issues become obvious really quickly because the monorepo helps expose them. Once that happens, you&amp;rsquo;ll have to staff teams to manage these problems. And if done right, those teams will have well-defined charters and full responsibility for their part of the monorepo experience. As you move towards the monorepo, you&amp;rsquo;ll see time freed from everyone not directly responsible for the monorepo maintenance.&lt;/p>
&lt;p>Still not convinced? Stay tuned for the next part, in which I will look into the costs that different ticket assignment practices have in on-call rotations.&lt;/p></description><enclosure url="https://jmmv.dev/images/2023-08-23-freebsd-gnome-repos.png" length="162711" type="image/jpeg"/></item><item><title>Raspberry Pi 3, rfkill, and real root causing</title><link>https://jmmv.dev/2023/08/rpi3-rfkill-root-causing.html</link><pubDate>Wed, 16 Aug 2023 06:20:00 -0700</pubDate><guid>https://jmmv.dev/2023/08/rpi3-rfkill-root-causing.html</guid><description>&lt;p>I&amp;rsquo;ve had a Raspberry Pi 3 in the garage running Raspbian so it was attached to Ethernet for a long time. A few weeks ago, however, I wanted to bring the Pi into the house so that my kid, who was showing interest in robotics, and I could play with it. That required having the ability to place the device onto the dining table, next to a laptop, which meant connecting it to WiFi. Easy peasy, right?&lt;/p>
&lt;p>Well&amp;hellip; while that should have been trivial, it did not work right away and the solutions I found online back then were all nonsensical. I gave up in desperation because I did not have enough time to find the root cause, and all interest was lost. Until last weekend when I gave this ordeal another try. At this point, I found once again the same nonsensical solutions online, got equally frustrated about the fact that they even existed, and decided to find the real answer to my problem on my own.&lt;/p>
&lt;p>Yes, this is mostly a rant about the Internet being littered with misleading answers of the kind &amp;ldquo;I reinstalled glibc and my problem is gone!&amp;rdquo;. But this is also the tale of a troubleshooting session&amp;mdash;and you know I like to blog about those.&lt;/p>
&lt;div class="container action-highlight p-4 my-4 d-md-none">
&lt;div class="row text-center">
&lt;p>A blog on operating systems, programming languages, testing, build systems, my own software
projects and even personal productivity. Specifics include FreeBSD, Linux, Rust, Bazel and
EndBASIC.&lt;/p>
&lt;/div>
&lt;div class="row">
&lt;div class="col">
&lt;div class="form-group">
&lt;form action="https://endtracker.azurewebsites.net/api/sites/e8da9f62-b7ac-4fe9-bf20-7c527199a376/subscribers/add" method="post">
&lt;input type="text" name="email"
placeholder="Enter your email"
class="form-control input-sm text-center my-1"/>
&lt;button type="submit" class="btn btn-primary btn-block my-1">Subscribe&lt;/button>
&lt;/form>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;div class="row px-2">
&lt;div class="col col-sm-5 text-left">
&lt;small>&lt;span class="subscriber-count">0&lt;/span> subscribers&lt;/small>
&lt;/div>
&lt;div class="col col-sm-7 text-right">
&lt;p>
&lt;a rel="me" href="https://mastodon.online/@jmmv">
&lt;img src="/images/badges/mastodon-logo.svg" width="32px" height="32px" alt="Follow @jmmv on Mastodon">
&lt;/a>
&lt;a href="https://twitter.com/intent/follow?original_referer=https%3A%2F%2Fjmmv.dev%2F&amp;amp;screen_name=jmmv">
&lt;img src="/images/badges/Twitter_logo_blue.svg" width="32px" height="32px" alt="Follow @jmmv on Twitter">
&lt;/a>
&lt;a href="/feed.xml">&lt;img src="/images/badges/feed-icon-28x28.png" alt="RSS feed">&lt;/a>
&lt;/p>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;h1 id="first-steps">First steps&lt;/h1>
&lt;p>Before even unplugging the Pi from its physical network link, I had to configure its WiFi connection so that I could use it on the dining table. To do so, I was going to need to run more than one command as root so, in preparation for that, I started a root shell. I was helpfully greeted by the following:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plain" data-lang="plain">&lt;span class="line">&lt;span class="cl">jmmv@rpi3:~$ sudo su -
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Wi-Fi is currently blocked by rfkill.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Use raspi-config to set the country before use.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">jmmv@rpi3:~#
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Nice. Somehow Raspbian expects that what one most likely wants to do after becoming root is to configure the WiFi and it points us in the right direction. That&amp;rsquo;s&amp;hellip; a bold assumption, but hey, it was pretty accurate.&lt;/p>
&lt;p>In any case, this was the first time I heard of rfkill. From the name, I assumed that this controlled some kind of kill switch for all radio devices in the system&amp;mdash;the kind of switch you would need to implement an &amp;ldquo;airplane mode&amp;rdquo; feature. I further assumed, based on this message, that rfkill was active because one needs to know the location of the device to decide which radio frequencies can be used.&lt;/p>
&lt;p>I did as told: I ran &lt;code>raspi-config&lt;/code>, went into the network configuration options to set up the WiFi, selected the right country, joined a WiFi network, and dropped back into the shell. As I did that, the WiFi connection was up and running and &lt;code>rfkill&lt;/code> reported the right thing:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plain" data-lang="plain">&lt;span class="line">&lt;span class="cl">root@rpi3:~# ifconfig | grep wlan0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">wlan0: flags=4163&amp;lt;UP,BROADCAST,RUNNING,MULTICAST&amp;gt; mtu 1500
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@rpi3:~# rfkill
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ID TYPE DEVICE SOFT HARD
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 0 wlan phy0 unblocked unblocked
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 1 bluetooth hci0 blocked unblocked
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Seeing this and knowing from past experience that the &lt;code>raspi-config&lt;/code> setting changes are permanent, I tried to SSH into the Pi over the WiFi adapter, confirmed that it was working, shut the system down, unplugged the Raspberry Pi from the network, brought it into the house from the garage, turned it on and&amp;hellip; it wasn&amp;rsquo;t reachable over WiFi anymore. What the&amp;hellip;!?&lt;/p>
&lt;h1 id="thinking-about-the-problem">Thinking about the problem&lt;/h1>
&lt;p>This did not make any sense. The instructions told me to configure a country and I had set one up, but somehow that was insufficient. Interestingly, though, logging back in as &lt;code>root&lt;/code> showed me the same warning about having to configure a country&amp;hellip; so I double-checked things.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plain" data-lang="plain">&lt;span class="line">&lt;span class="cl">jmmv@rpi3:~$ sudo su -
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Wi-Fi is currently blocked by rfkill.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Use raspi-config to set the country before use.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@rpi3:~# rg country /etc/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/etc/wpa_supplicant/wpa_supplicant.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">3:country=US
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">... and more matches ...
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>The country seemed to be configured properly in persistent storage in a place that made sense but:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plain" data-lang="plain">&lt;span class="line">&lt;span class="cl">root@rpi3:~# rfkill
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ID TYPE DEVICE SOFT HARD
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 0 wlan phy0 blocked unblocked
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 1 bluetooth hci0 blocked unblocked
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>The WiFi adapter was indeed back to the blocked state. Why? As you might imagine, running the Raspberry Pi in a headless state and with a WiFi connection &lt;em>surely&lt;/em> has to be a well-anticipated scenario, which explains why logging in as root has, of all things, a check for the WiFi state and a pointer to configure it. The WiFi should work without extra effort.&lt;/p>
&lt;h1 id="initial-research">Initial research&lt;/h1>
&lt;p>I don&amp;rsquo;t remember how exactly I came across this, but I ended up noticing the following files:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plain" data-lang="plain">&lt;span class="line">&lt;span class="cl">jmmv@rpi3:~# fd rfkill /lib/systemd/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/lib/systemd/system/systemd-rfkill.service
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/lib/systemd/system/systemd-rfkill.socket
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/lib/systemd/systemd-rfkill
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>As it turns out, there is a systemd service to manage the rfkill state. Looking at its manual page (while shocked that one even existed):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-plain" data-lang="plain">&lt;span class="line">&lt;span class="cl">SYSTEMD-RFKILL.SERVICE(8) systemd-rfkill.service SYSTEMD-RFKILL.SERVICE(8)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> systemd-rfkill.service, systemd-rfkill.socket, systemd-rfkill – Load
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> and save the RF kill switch state at boot and change
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>systemd-rfkill&lt;/code> is a shutdown service that saves the blocked/unblocked state of rfkill and restores it at system startup time. It seems that this whole rfkill thing was well-thought after all. But this finding meant that rfkill should have remained unblocked after the reboot. And it didn&amp;rsquo;t. So &lt;em>this&lt;/em> is the question that had to be answered.&lt;/p>
&lt;h1 id="trying-to-find-an-answer-online">Trying to find an answer online&lt;/h1>
&lt;p>Searching online for a solution, using obvious queries like &lt;code>raspberry pi enable wifi boot rfkill&lt;/code>, resulted in me finding the following &amp;ldquo;solutions&amp;rdquo;:&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;strong>Disable rfkill via a kernel command line setting and ask systemd to not restore state.&lt;/strong> Sure, that&amp;rsquo;ll work. But it&amp;rsquo;s&amp;hellip; drastic? Why would I have to do that when the system seems to be prepared to &amp;ldquo;just work&amp;rdquo; after a &lt;code>raspi-config&lt;/code>? Why should I disable a core feature that&amp;rsquo;s installed by default to make headless WiFi work? This will &amp;ldquo;break&amp;rdquo; whatever thing is using rfkill during the boot process to disable the network, and it will possibly break any &amp;ldquo;airplane mode&amp;rdquo;-like toggles that might exist in the UI. Not that I care about the UI, but still.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>Add a systemd startup script to force rfkill to the unblocked state.&lt;/strong> Another thing that will work. But why should I do that? This will just paper over whatever exists in the boot process that disables the network after &lt;code>systemd-rfkill&lt;/code> has done its thing. It does not address the root cause.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>Create a WiFi configuration file in the boot partition.&lt;/strong> OK, maybe this one makes sense. Maybe if the system knows to configure the WiFi early enough during the boot process, it knows that the WiFi must remain enabled later on. A bit of research proved this solution wrong too though. I stumbled upon &lt;code>/lib/systemd/system/raspberrypi-net-mods.service&lt;/code>, which is the boot code that handles this feature, and it reads like this:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-ini" data-lang="ini">&lt;span class="line">&lt;span class="cl">&lt;span class="k">[Unit]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">Description&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">Copy user wpa_supplicant.conf&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">ConditionPathExists&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">/boot/wpa_supplicant.conf&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">Before&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">dhcpcd.service&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">After&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">systemd-rfkill.service&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">[Service]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">Type&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">oneshot&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">RemainAfterExit&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">yes&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">ExecStart&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">/bin/mv /boot/wpa_supplicant.conf /etc/wpa_supplicant/wpa_supplicant.conf&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">ExecStartPost&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">/bin/chmod 600 /etc/wpa_supplicant/wpa_supplicant.conf&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">ExecStartPost&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">/usr/sbin/rfkill unblock wifi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">[Install]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">WantedBy&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">multi-user.target&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>This snippet runs when &lt;code>/boot/wpa_supplicant.conf&lt;/code> is present (&lt;code>ConditionPathExists&lt;/code>), but all it does is move that file to the right place and unblocks the WiFi using the &lt;code>rfkill unblock wifi&lt;/code> command&amp;mdash;the same one that &lt;code>raspi-config&lt;/code> invokes and the command I had already tried to run by hand. The key insight is that because this unit moves the file, &lt;em>it only runs once&lt;/em>. That makes sense if you look at this unit as a first-time setup action for headless installations, but it had no chance of fixing my problem.&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>So no. None of these &amp;ldquo;solutions&amp;rdquo; address the root cause. They are hacks and workarounds that may achieve the desired outcome, but they don&amp;rsquo;t explain &lt;em>why&lt;/em> the &lt;code>systemd-rfkill&lt;/code> automation, which is built into the system and should restore the changes made by &lt;code>raspbi-config&lt;/code>, isn&amp;rsquo;t working as designed.&lt;/p>
&lt;h1 id="proper-troubleshooting">Proper troubleshooting&lt;/h1>
&lt;p>Given that these answers were all misguided, I had to do some extra work to reach the true solution.&lt;/p>
&lt;p>The first question to answer was: did the &lt;code>systemd-rfkill&lt;/code> service even work fine? It took me a bit of fiddling to discover how to enable debug logging in systemd, but once I did that, I could confirm that this service was indeed working fine. The service correctly persisted the disabled state to a file and restored it on the next boot.&lt;/p>
&lt;p>This meant that there had to be &lt;em>something else&lt;/em> in the boot process that disabled the WiFi after &lt;code>systemd-rfkill&lt;/code> had run. The question was finding what that was, and having this knowledge meant I could better scope my next searches a bit more accurately.&lt;/p>
&lt;p>My next thought took me to NetworkManager. I have had my previous fights with this service in the past, so I thought that maybe this was installed on the system to handle the state of network connections in the UI. I do have the standard Raspbian desktop installed but I had no easy way to log into it&amp;hellip; so verifying this wasn&amp;rsquo;t exactly trivial. (In retrospect, I think that if I had gone through the hassle of logging into the UI and clicked on whichever button exists to enable the WiFi, my problems would have been resolved immediately. But then I wouldn&amp;rsquo;t have gained all of this knowledge.)&lt;/p>
&lt;p>Fear not though. NetworkManager has a CLI to manipulate its state so I could use that. Except for the fact that NetworkManager was nowhere to be seen on the system. Dead end.&lt;/p>
&lt;p>My next step was to look into the standard Debian configuration under &lt;code>/etc/network/&lt;/code>, but I couldn&amp;rsquo;t find anything obvious either. Actually, I couldn&amp;rsquo;t find &lt;em>anything&lt;/em> because the interfaces aren&amp;rsquo;t apparently configured there at all anymore. Yay for modern Linux?&lt;/p>
&lt;p>It is then that I reverted to searching online (I don&amp;rsquo;t remember the right search terms though) and I ended in yet another forum that talked about connman. And bingo! I did have connman installed and it sounded like the same NetworkManager thing I had seen before. Running a &lt;code>connman enable wifi&lt;/code> was all it took to mark the WiFi link enabled and get the right fix in place. And by &amp;ldquo;right fix&amp;rdquo; I mean a fix that works in conjuction with the way the whole system is expected to run, not in spite of it.&lt;/p>
&lt;p>In other words: it was connman that was kicking in after the &lt;code>systemd-rfkill&lt;/code> startup script, and it was connman the one that was re-disabling the WiFi because connman thought that it had to be disabled. Now, as to why I have connman installed and whether it should be there or not&amp;hellip; I do not know. This Raspbian installation has been in place for years now and has been upgraded a few times, so my guess is that &lt;code>connman&lt;/code> is there to support the lightweight Raspbian desktop, and at some point in the past I logged into it and clicked on the button to disable the WiFi.&lt;/p>
&lt;h1 id="the-ai-future">The AI future&lt;/h1>
&lt;p>The Internet being polluted by wrong answers obviously impacts everyone, from beginner engineers and sysadmins that will not know/care enough to find the true root causes behind problems, to our new AI overlords which will outright lie to us.&lt;/p>
&lt;p>Or will they? Let&amp;rsquo;s try to get an answer from Bing&amp;rsquo;s AI-powered new search engine:&lt;/p>
&lt;blockquote>
&lt;p>Q: I enabled the WiFi on the Raspberry Pi with raspi-config but, after a reboot, rfkill reports that the WiFi is blocked. How do I fix it?&lt;/p>
&lt;p>A: You can try running the command sudo rfkill unblock wifi to unblock the wifi. If that doesn’t work, you can try adding the command rfkill unblock all to /etc/rc.local file before the line that says exit 0. This will ensure that the command is run at boot time and should unblock the wifi.&lt;/p>
&lt;/blockquote>
&lt;p>Yeah, no. While that might have the right effect as described earlier, it&amp;rsquo;s not the correct answer. But I &lt;em>know&lt;/em> the answer, so I can cheat and prompt the question towards what I think the problem really is:&lt;/p>
&lt;blockquote>
&lt;p>Q: But why doesn&amp;rsquo;t the rfkill unblocked state persist after the reboot? The systemd unit says it should.&lt;/p>
&lt;p>A: The reason why the rfkill unblocked state doesn&amp;rsquo;t persist after reboot is because the Network Manager is blocking it back¹. You can try creating a service to unblock the wifi devices at boot time. Here&amp;rsquo;s how you can do it:
&amp;hellip; snippet to modify systemd &amp;hellip;&lt;/p>
&lt;/blockquote>
&lt;p>Oh wow, I&amp;rsquo;m actually surprised. This answer was pretty close!&lt;/p>
&lt;blockquote>
&lt;p>Q: But I do not have NetworkManager installed. What else could it be?&lt;/p>
&lt;p>A: If you don&amp;rsquo;t have NetworkManager installed, then it could be that the wifi is being blocked by the kernel. You can try adding the following line to &lt;code>/etc/modprobe.d/raspi-blacklist.conf&lt;/code> file:
&amp;hellip; more steps &amp;hellip;&lt;/p>
&lt;/blockquote>
&lt;p>Back to the wrong heavy-handed solution of fully disabling rfkill. Bing&amp;hellip; you were soooo close, but yet so far. Finally:&lt;/p>
&lt;blockquote>
&lt;p>Q: Could it be connman?&lt;/p>
&lt;p>A: Yes, it could be connman. You can try disabling connman by running the following command:
&amp;hellip; steps to fully disable &amp;hellip;&lt;/p>
&lt;/blockquote>
&lt;p>Of course it could obviously be connman&amp;rsquo;s fault, but the answer is wrong. I might want to have connman installed and the system ought to work with it (it was there by default after all). Uninstalling random system components isn&amp;rsquo;t usually the answer.&lt;/p>
&lt;hr>
&lt;p>Is there any moral to this story? Sure there is, the usual one: in order to solve a problem, you must always understand what the root cause really is. This typically requires understanding how the system works top-to-bottom and reasoning about what the behavior should be end-to-end. Only then you can come up with the right fix. Asking &amp;ldquo;why&amp;rdquo; several times in a row tends to work well in discovering what you might be missing. Oh, and this all applies to software bugs as well: the next time you find yourself adding a nullness check to fix a crash&amp;hellip; keep digging.&lt;/p>
&lt;p>It would be pretty funny if &lt;em>my&lt;/em> root-causing in this post was &lt;em>also&lt;/em> wrong. If that&amp;rsquo;s the case, don&amp;rsquo;t hesitate to say so!&lt;/p></description><enclosure url="https://jmmv.dev/images/2023-08-16-rpi3-go2-gpio.jpg" length="346217" type="image/jpeg"/></item><item><title>A failed experiment with Rust static dispatch</title><link>https://jmmv.dev/2023/08/rust-static-dispatch-failed-experiment.html</link><pubDate>Sun, 06 Aug 2023 05:30:00 -0700</pubDate><guid>https://jmmv.dev/2023/08/rust-static-dispatch-failed-experiment.html</guid><description>&lt;p>Initial versions of the EndBASIC Service, and therefore initial versions of EndTRACKER, used dynamic dispatch to support abstract definitions of system services such as the database they talk to and the clock they use. This looked like a bunch of &lt;code>Arc&amp;lt;dyn Foo&amp;gt;&lt;/code> objects passed around and was done to &lt;a href="/2023/07/unit-testing-a-web-service.html">support extremely fast unit testing&lt;/a>.&lt;/p>
&lt;p>When I generalized the core logic of these services into the &lt;a href="/2023/03/introducing-iii-iv.html">III-IV framework&lt;/a>, I decided to experiment with a switch to static dispatch. The rationale was that using static dispatch better aligns with the design of well-regarded crates in the Rust ecosystem, and also because I wanted to avoid unnecessary runtime costs in the foundational pieces of my web services.&lt;/p>
&lt;p>Let me tell you that this decision was a huge mistake and that the experiment has utterly failed. Using static dispatch has been a constant source of frustration due to the difficulty in passing types around and reasoning about trait bounds. The situation had gotten so bad that I dreaded adding new functionality to my services whenever a change to a statically-typed &lt;code>struct&lt;/code> was needed, because that meant adding yet another type parameter and plumbing it through tens of source files.&lt;/p>
&lt;p>In lieu of the difficulties, which eventually turned into blockers to implementing new features, I made the choice of going back to dynamic dispatch. The goal was to gain ergonomics at the expense of a supposedly-negligible runtime cost. Let me tell you about the problems I faced, the refactoring journey, and some measurements I gathered after the rewrite.&lt;/p>
&lt;div class="container action-highlight p-4 my-4 d-md-none">
&lt;div class="row text-center">
&lt;p>A blog on operating systems, programming languages, testing, build systems, my own software
projects and even personal productivity. Specifics include FreeBSD, Linux, Rust, Bazel and
EndBASIC.&lt;/p>
&lt;/div>
&lt;div class="row">
&lt;div class="col">
&lt;div class="form-group">
&lt;form action="https://endtracker.azurewebsites.net/api/sites/e8da9f62-b7ac-4fe9-bf20-7c527199a376/subscribers/add" method="post">
&lt;input type="text" name="email"
placeholder="Enter your email"
class="form-control input-sm text-center my-1"/>
&lt;button type="submit" class="btn btn-primary btn-block my-1">Subscribe&lt;/button>
&lt;/form>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;div class="row px-2">
&lt;div class="col col-sm-5 text-left">
&lt;small>&lt;span class="subscriber-count">0&lt;/span> subscribers&lt;/small>
&lt;/div>
&lt;div class="col col-sm-7 text-right">
&lt;p>
&lt;a rel="me" href="https://mastodon.online/@jmmv">
&lt;img src="/images/badges/mastodon-logo.svg" width="32px" height="32px" alt="Follow @jmmv on Mastodon">
&lt;/a>
&lt;a href="https://twitter.com/intent/follow?original_referer=https%3A%2F%2Fjmmv.dev%2F&amp;amp;screen_name=jmmv">
&lt;img src="/images/badges/Twitter_logo_blue.svg" width="32px" height="32px" alt="Follow @jmmv on Twitter">
&lt;/a>
&lt;a href="/feed.xml">&lt;img src="/images/badges/feed-icon-28x28.png" alt="RSS feed">&lt;/a>
&lt;/p>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;h1 id="initial-impressions">Initial impressions&lt;/h1>
&lt;p>The adoption of static dispatch in III-IV started pretty simple and it did the job well. Even though it took me days of fighting with the Rust type system, I eventually got it to work. The production binary was statically bound to the PostgreSQL database backend and the unit tests were bound to SQLite, all while respecting the type safety offered by &lt;code>sqlx&lt;/code> and without having virtual function calls anywhere.&lt;/p>
&lt;p>Let&amp;rsquo;s take a peek at what the &lt;a href="https://github.com/jmmv/iii-iv/tree/cba6775e489d2e015a5919b086278ee486589ee5/example/src">sample key/value store&lt;/a> core pieces looked like by going through the architectural layers described in &lt;a href="/2023/06/mvc-non-ui-apps.html">MVC but for non-UI apps&lt;/a>.&lt;/p>
&lt;p>At the bottom layer, the database, there was a transaction trait to supply the operations required by the business logic layer:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-rust" data-lang="rust">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#[async_trait]&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">trait&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Tx&lt;/span>: &lt;span class="nc">BareTx&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">async&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">fn&lt;/span> &lt;span class="nf">get_keys&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="k">mut&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>-&amp;gt; &lt;span class="nc">DbResult&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">BTreeSet&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Key&lt;/span>&lt;span class="o">&amp;gt;&amp;gt;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// ... more database operations ...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>This trait was separately implemented for PostgreSQL and SQLite by providing separate &lt;code>PostgresTx&lt;/code> and &lt;code>SqliteTx&lt;/code> specific types, and both the specific transaction type and the database backing it were chosen at build time where the database connection was established.&lt;/p>
&lt;p>Moving up to the business-logic layer, the &lt;code>Driver&lt;/code> was parameterized on the domain-specific &lt;code>Tx&lt;/code> so that it could have access to those operations (and only those):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-rust" data-lang="rust">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#[derive(Clone)]&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">struct&lt;/span> &lt;span class="nc">Driver&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">D&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">where&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">D&lt;/span>: &lt;span class="nc">Db&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Clone&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Send&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Sync&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">&amp;#39;static&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">D&lt;/span>::&lt;span class="n">Tx&lt;/span>: &lt;span class="nc">Tx&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Send&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Sync&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">&amp;#39;static&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">db&lt;/span>: &lt;span class="nc">D&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">impl&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">D&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Driver&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">D&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">where&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">D&lt;/span>: &lt;span class="nc">Db&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Clone&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Send&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Sync&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">&amp;#39;static&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">D&lt;/span>::&lt;span class="n">Tx&lt;/span>: &lt;span class="nc">Tx&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Send&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Sync&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">&amp;#39;static&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">async&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">fn&lt;/span> &lt;span class="nf">get_keys&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>-&amp;gt; &lt;span class="nc">DriverResult&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">BTreeSet&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Key&lt;/span>&lt;span class="o">&amp;gt;&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">let&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">mut&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">tx&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">begin&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="k">await&lt;/span>&lt;span class="o">?&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">let&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">keys&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">tx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">get_keys&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="k">await&lt;/span>&lt;span class="o">?&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">tx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">commit&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="k">await&lt;/span>&lt;span class="o">?&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nb">Ok&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">keys&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c1">// ... more impl blocks for different driver operations ...
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Note how, in the above, the &lt;code>db.begin()&lt;/code> method call returns an instance of a &lt;code>Tx&lt;/code> right away, ensuring that callers always issue database operations as part of a transaction. This had been a deliberate decision from the very beginning to prevent issuing standalone database calls that could compromise the correctness of the data, because there was no scenario in which a transaction was &lt;em>not&lt;/em> necessary.&lt;/p>
&lt;p>Finally, the upper REST layer took a &lt;code>Driver&lt;/code> as the engine to run the API requests through and, as a consequence, the REST handlers all had to be parameterized like the underlying &lt;code>Driver&lt;/code>:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-rust" data-lang="rust">&lt;span class="line">&lt;span class="cl">&lt;span class="k">async&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">fn&lt;/span> &lt;span class="nf">handler&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">D&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">State&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">driver&lt;/span>&lt;span class="p">)&lt;/span>: &lt;span class="nc">State&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Driver&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">D&lt;/span>&lt;span class="o">&amp;gt;&amp;gt;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>-&amp;gt; &lt;span class="nb">Result&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="k">impl&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">IntoResponse&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">RestError&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">where&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">D&lt;/span>: &lt;span class="nc">Db&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Clone&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Send&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Sync&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">&amp;#39;static&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">D&lt;/span>::&lt;span class="n">Tx&lt;/span>: &lt;span class="nc">Tx&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Send&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Sync&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">&amp;#39;static&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">let&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">keys&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">driver&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">get_keys&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="k">await&lt;/span>&lt;span class="o">?&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nb">Ok&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Json&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">keys&lt;/span>&lt;span class="p">))&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>This is where things started to look finicky because the REST layer now had to spell out the internals of the &lt;code>Driver&lt;/code>&amp;hellip; but it didn&amp;rsquo;t look so bad at the beginning. Combining this, the &lt;a href="https://en.wikipedia.org/wiki/Sunk_cost">sunken cost fallacy&lt;/a>&amp;mdash;it had taken me days to devise how to make the above work&amp;mdash;and the idea of avoiding an unnecessary abstraction at runtime made me plough ahead with this implementation.&lt;/p>
&lt;h1 id="the-problems">The problems&lt;/h1>
&lt;p>It soon wasn&amp;rsquo;t all roses. What you could see above was an extremely simplified view of how things ended looking like in a real service with more than just the database dependency. Without further ado, let me present to you the monstrosity that I ended up with in EndTRACKER. Here is the &lt;code>Driver&lt;/code> definition for the data plane microservice:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-rust" data-lang="rust">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#[derive(Derivative)]&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="cp">#[derivative(Clone(bound = &lt;/span>&lt;span class="s">&amp;#34;&amp;#34;&lt;/span>&lt;span class="cp">))]&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">struct&lt;/span> &lt;span class="nc">Driver&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">A&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">C&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">D&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">G&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="no">QD&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">where&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">A&lt;/span>: &lt;span class="nc">AbusePolicy&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">D&lt;/span>::&lt;span class="n">Tx&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Clone&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Send&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Sync&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">&amp;#39;static&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">C&lt;/span>: &lt;span class="nc">Clock&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Clone&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Send&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Sync&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">&amp;#39;static&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">D&lt;/span>: &lt;span class="nc">Db&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Clone&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Send&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Sync&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">&amp;#39;static&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">D&lt;/span>::&lt;span class="n">Tx&lt;/span>: &lt;span class="nc">DataTx&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">From&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">D&lt;/span>::&lt;span class="n">SqlxTx&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Send&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Sync&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">&amp;#39;static&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">G&lt;/span>: &lt;span class="nc">GeoLocator&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Clone&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Send&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Sync&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">&amp;#39;static&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="no">QD&lt;/span>: &lt;span class="nc">Db&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Clone&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Send&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Sync&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">&amp;#39;static&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="no">QD&lt;/span>::&lt;span class="n">Tx&lt;/span>: &lt;span class="nc">ClientTx&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">T&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">BatchTask&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">From&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="no">QD&lt;/span>::&lt;span class="n">SqlxTx&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Send&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Sync&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">&amp;#39;static&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">db&lt;/span>: &lt;span class="nc">D&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">clock&lt;/span>: &lt;span class="nc">C&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// ... more fields ...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>But that&amp;rsquo;s not all, oh no. This chunk also infected the REST layer, which in theory should not care about the specifics of the driver layer. Here, look at this &lt;code>RestState&lt;/code> type, which is a wrapper over the data that the REST API handlers need to operate:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-rust" data-lang="rust">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#[derive(Derivative)]&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="cp">#[derivative(Clone(bound = &lt;/span>&lt;span class="s">&amp;#34;&amp;#34;&lt;/span>&lt;span class="cp">))]&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">struct&lt;/span> &lt;span class="nc">RestState&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">A&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">C&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">D&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">G&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="no">QD&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">where&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">A&lt;/span>: &lt;span class="nc">AbusePolicy&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">D&lt;/span>::&lt;span class="n">Tx&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Clone&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Send&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Sync&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">&amp;#39;static&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">C&lt;/span>: &lt;span class="nc">Clock&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Clone&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Send&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Sync&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">&amp;#39;static&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">D&lt;/span>: &lt;span class="nc">Db&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Clone&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Send&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Sync&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">&amp;#39;static&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">D&lt;/span>::&lt;span class="n">Tx&lt;/span>: &lt;span class="nc">DataTx&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">From&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">D&lt;/span>::&lt;span class="n">SqlxTx&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Send&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Sync&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">&amp;#39;static&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">G&lt;/span>: &lt;span class="nc">GeoLocator&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Clone&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Send&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Sync&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">&amp;#39;static&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="no">QD&lt;/span>: &lt;span class="nc">Db&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Clone&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Send&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Sync&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">&amp;#39;static&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="no">QD&lt;/span>::&lt;span class="n">Tx&lt;/span>: &lt;span class="nc">ClientTx&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">T&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">BatchTask&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">From&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="no">QD&lt;/span>::&lt;span class="n">SqlxTx&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Send&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Sync&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">&amp;#39;static&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">driver&lt;/span>: &lt;span class="nc">Driver&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">A&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">C&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">D&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">G&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="no">QD&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// ... more fields ...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>There are several problems with the above:&lt;/p>
&lt;ol>
&lt;li>
&lt;p>It is Super Ugly (TM). There is no other way to put it. As much as I like Rust, things like this are painful and scary&amp;mdash;but not as painful as deranged modern C++.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>These &lt;code>where&lt;/code> declarations where repeated 44 times in 37 different files (that is, almost &lt;em>all&lt;/em> files). This polluted source files with details they don&amp;rsquo;t care about. Any small change to the &lt;code>Driver&lt;/code> required updating all these repeated chunks in sync. I&amp;rsquo;m not even sure why Rust requires the duplication and why it&amp;rsquo;s sometimes OK for the trait bounds to diverge among the various &lt;code>impl&lt;/code> blocks, but the duplication is necessary.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>It poisoned the REST layer. As mentioned above, the REST layer wants to pass around a &lt;code>RestState&lt;/code> object that contains the &lt;code>Driver&lt;/code> and other data fields that are only necessary at that level. Yet&amp;hellip; to achieve this the &lt;code>REST&lt;/code> layer had to replicate all of the internal details of the &lt;code>Driver&lt;/code>.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>I had to use &lt;code>derivative&lt;/code> to remove unnecessary (?) clone trait bounds. The need to have a cloneable &lt;code>Driver&lt;/code> and &lt;code>RestState&lt;/code> comes from how the &lt;code>axum&lt;/code> HTTP framework dispatches route execution, and figuring this out took quite a while. Furthermore&amp;hellip; the way this &amp;ldquo;works&amp;rdquo; is still obscure to me.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>It became impossible to compose transaction types. This is a problem with my design and not an inherent issue with static dispatch, but the use of static dispatch guided me towards this design. Note that, in the above, there are two database instances: &lt;code>D&lt;/code> and &lt;code>QD&lt;/code>, each with a different associated &lt;code>Tx&lt;/code> type. While I wrote some contortions to support sharing the same underlying database connection between them, I never got to replicating those to also share an open transaction. The complexity was already at unmanageable levels to push this design any further. But I needed a solution to this problem.&lt;/p>
&lt;/li>
&lt;/ol>
&lt;p>All in all, the use of static dispatch was slowing me down in building new features as these constructs made me dread modifying certain aspects of the code. And what&amp;rsquo;s worse: certain initial design choices started showing up as true inefficiencies in production like the inability to issue standalone database calls outside of a transaction. The original goal of minimizing runtime costs was made significantly &lt;em>worse&lt;/em>. Fixing these issues required a redesign so it was time for a change.&lt;/p>
&lt;h1 id="switching-to-dynamic-dispatch">Switching to dynamic dispatch&lt;/h1>
&lt;p>The goal with the redesign was to drop all static type parameters and replace them with &lt;code>dyn&lt;/code> trait objects. In this way, the &lt;code>Driver&lt;/code> would encapsulate these details in just one place and all other code would not have to care about the specific field definitions within this type.&lt;/p>
&lt;p>It is easier said than done, but the results speak for themselves. Here is how the new &lt;code>Driver&lt;/code> for the &lt;a href="https://github.com/jmmv/iii-iv/tree/ba7aaf151fab3ff7aa1defde2454eab1550bda32/example/src">simplified key/value store&lt;/a> looks like:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-rust" data-lang="rust">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#[derive(Clone)]&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">struct&lt;/span> &lt;span class="nc">Driver&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">db&lt;/span>: &lt;span class="nc">Arc&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="k">dyn&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Db&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Send&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Sync&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">impl&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Driver&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">async&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">fn&lt;/span> &lt;span class="nf">get_keys&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>-&amp;gt; &lt;span class="nc">DriverResult&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">BTreeSet&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Key&lt;/span>&lt;span class="o">&amp;gt;&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">let&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">mut&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">tx&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">begin&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="k">await&lt;/span>&lt;span class="o">?&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">let&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">keys&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">db&lt;/span>::&lt;span class="n">get_keys&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">tx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">ex&lt;/span>&lt;span class="p">()).&lt;/span>&lt;span class="k">await&lt;/span>&lt;span class="o">?&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">tx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">commit&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="k">await&lt;/span>&lt;span class="o">?&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nb">Ok&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">keys&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>And, similarly, this is how one of the REST API handlers looks like:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-rust" data-lang="rust">&lt;span class="line">&lt;span class="cl">&lt;span class="k">async&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">fn&lt;/span> &lt;span class="nf">handler&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">State&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">driver&lt;/span>&lt;span class="p">)&lt;/span>: &lt;span class="nc">State&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Driver&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>-&amp;gt; &lt;span class="nb">Result&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="k">impl&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">IntoResponse&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">RestError&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">let&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">keys&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">driver&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">get_keys&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="k">await&lt;/span>&lt;span class="o">?&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nb">Ok&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Json&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">keys&lt;/span>&lt;span class="p">))&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>That&amp;rsquo;s it. This is the way to declare the &lt;code>Driver&lt;/code> over a generic database, the way to write a business-logic operation on top of this database, and the way to write a REST API handler that calls into this operation. The &lt;code>Arc&lt;/code>s and the &lt;code>Send + Sync&lt;/code> annotations are somewhat ugly but they are nowhere as ugly as the previous disaster. In this version, there is no noise.&lt;/p>
&lt;p>What&amp;rsquo;s more: as part of the redesign, I could throw away the &amp;ldquo;everything behind a transaction&amp;rdquo; idea and allow the caller to choose the best execution mode for its needs. Note the &lt;code>tx.ex()&lt;/code> call above, which obtains an &amp;ldquo;executor&amp;rdquo; from the database and that can be used to talk to the database. This specific call obtains an executor from a transaction, but the same &lt;code>db.ex()&lt;/code> method also exists to obtain a standalone executor. Describing how this works is out of the scope of this post though.&lt;/p>
&lt;h1 id="show-me-the-metrics">Show me the metrics&lt;/h1>
&lt;p>The pervasiveness of static dispatch in the Rust ecosystem helps leverage &amp;ldquo;zero-cost abstractions&amp;rdquo;, but it &lt;em>does&lt;/em> come with a cost. Namely: programming time cost. It is great to have a choice, and it is great that many general-purpose Rust crates use static dispatch so that you don&amp;rsquo;t have to pay unnecessary taxes&amp;hellip; but it was not the right choice for me. I might have done things really wrong in my original design and these measurements may not be sustained for other projects, but let&amp;rsquo;s look at some numbers anyway.&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;strong>Code size.&lt;/strong> This is how the refactoring looks like according to a &lt;code>git diff --stat&lt;/code>:&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>Project&lt;/th>
&lt;th style="text-align:right">Files changed&lt;/th>
&lt;th style="text-align:right">Lines added&lt;/th>
&lt;th style="text-align:right">Lines deleted&lt;/th>
&lt;th style="text-align:right">Diff&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>iii-iv&lt;/td>
&lt;td style="text-align:right">32&lt;/td>
&lt;td style="text-align:right">1691&lt;/td>
&lt;td style="text-align:right">2115&lt;/td>
&lt;td style="text-align:right">-242 (-3%)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>endtracker&lt;/td>
&lt;td style="text-align:right">74&lt;/td>
&lt;td style="text-align:right">3751&lt;/td>
&lt;td style="text-align:right">4963&lt;/td>
&lt;td style="text-align:right">-1212 (-11%)&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>The changes to the III-IV framework are small because the use of static typing within the framework itself wasn&amp;rsquo;t pervasive: after all, the framework was just exposing the building blocks and not using them on its own. But the 11% code reduction in EndTRACKER alone is &lt;em>very&lt;/em> significant.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>Binary size.&lt;/strong> Looking at the sizes of the main EndTRACKER binary and the supporting unit testing binaries, both under the &lt;code>release&lt;/code> and &lt;code>debug&lt;/code> configurations, we observe:&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>Binary&lt;/th>
&lt;th>Mode&lt;/th>
&lt;th style="text-align:right">Before (MBs)&lt;/th>
&lt;th style="text-align:right">After (MBs)&lt;/th>
&lt;th style="text-align:right">Diff&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>&lt;strong>main binary&lt;/strong>&lt;/td>
&lt;td>release&lt;/td>
&lt;td style="text-align:right">23.30&lt;/td>
&lt;td style="text-align:right">26.47&lt;/td>
&lt;td style="text-align:right">+3.17&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>common tests&lt;/td>
&lt;td>release&lt;/td>
&lt;td style="text-align:right">16.75&lt;/td>
&lt;td style="text-align:right">17.11&lt;/td>
&lt;td style="text-align:right">+0.36&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>batch tests&lt;/td>
&lt;td>release&lt;/td>
&lt;td style="text-align:right">25.45&lt;/td>
&lt;td style="text-align:right">24.96&lt;/td>
&lt;td style="text-align:right">-0.49&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>control tests&lt;/td>
&lt;td>release&lt;/td>
&lt;td style="text-align:right">19.10&lt;/td>
&lt;td style="text-align:right">18.77&lt;/td>
&lt;td style="text-align:right">-0.33&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>data tests&lt;/td>
&lt;td>release&lt;/td>
&lt;td style="text-align:right">20.90&lt;/td>
&lt;td style="text-align:right">20.89&lt;/td>
&lt;td style="text-align:right">-0.01&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;strong>main binary&lt;/strong>&lt;/td>
&lt;td>debug&lt;/td>
&lt;td style="text-align:right">261.14&lt;/td>
&lt;td style="text-align:right">280.62&lt;/td>
&lt;td style="text-align:right">+19.48&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>common tests&lt;/td>
&lt;td>debug&lt;/td>
&lt;td style="text-align:right">169.27&lt;/td>
&lt;td style="text-align:right">171.62&lt;/td>
&lt;td style="text-align:right">+2.35&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>batch tests&lt;/td>
&lt;td>debug&lt;/td>
&lt;td style="text-align:right">239.72&lt;/td>
&lt;td style="text-align:right">238.07&lt;/td>
&lt;td style="text-align:right">-1.65&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>control tests&lt;/td>
&lt;td>debug&lt;/td>
&lt;td style="text-align:right">192.06&lt;/td>
&lt;td style="text-align:right">192.21&lt;/td>
&lt;td style="text-align:right">+0.15&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>data tests&lt;/td>
&lt;td>debug&lt;/td>
&lt;td style="text-align:right">208.40&lt;/td>
&lt;td style="text-align:right">207.93&lt;/td>
&lt;td style="text-align:right">-0.47&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>I was expecting a slight increase in binary size with the move to dynamic dispatch because the compiler and linker don&amp;rsquo;t have as many opportunities for inlining and optimizing code. While the results seem to be all over the place, they seem to agree with my expectations: the binary sizes are larger when using dynamic dispatch. Some test binaries are smaller indeed, but this is most likely due to how the tests changed and not necessarily because of the switch from static to dynamic dispatch.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>Compilation time.&lt;/strong> I measured an incremental build after modifying a core type in the EndTRACKER codebase to change its internal layout, starting from a &lt;code>cargo clean&lt;/code> slate and using the mold linker. With static dispatch, the incremental build times of the binary and tests were somewhere between 12 to 13 seconds, and with dynamic dispatch they dropped to just below 12 seconds. The difference is minimal, and the codebase isn&amp;rsquo;t large enough to obtain a good signal out of this metric.&lt;/p>
&lt;p>To be honest, I was hoping for a much larger improvement in incremental compilation times. My reasoning was that dealing with the type constraints that existed before must have been expensive, so removing them should reduce compiler execution times. My measurements did not prove this true, unfortunately. Or if they did, the improvements are negligible in this small codebase.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>Refactoring effort.&lt;/strong> I spent a couple of days figuring out what the best abstraction was and then I spent many hours during a recent long flight doing all of the mostly-mechanical changes to the EndTRACKER codebase. As usual, updating the tests was the most painful part of all&amp;mdash;but also the one that gave me confidence to deploy a new build to production with ease.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>Runtime cost.&lt;/strong> This one&amp;hellip; well, I haven&amp;rsquo;t been able to measure it. None of my web services are CPU-bound so the cost of the virtual function dispatch is negligible.&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>To summarize: not much seems to have changed with this rewrite. Binaries are slightly larger indeed, but not by a lot. However&amp;hellip; the benefits in productivity are massive already.&lt;/p>
&lt;h1 id="productivity-benefits">Productivity benefits&lt;/h1>
&lt;p>One of the benefits of this rewrite is that I&amp;rsquo;ve been able to finally resolve a long-standing deficiency in test coverage, which I briefly mentioned it in the conclusion of the &lt;a href="/2023/07/unit-testing-a-web-service.html">Unit testing a web service&lt;/a> post. This deficiency was that the test suites for the driver and the REST layer ran against SQLite unconditionally and I did not have a way to run them against a real PostgreSQL instance. Well, I have an answer now. All it took after the switch to dynamic dispatch was to introduce a helper function like this one:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-rust" data-lang="rust">&lt;span class="line">&lt;span class="cl">&lt;span class="k">async&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">fn&lt;/span> &lt;span class="nf">connect_to_test_db&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>-&amp;gt; &lt;span class="nc">Arc&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="k">dyn&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Db&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Send&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Sync&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">let&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">db&lt;/span>: &lt;span class="nc">Arc&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="k">dyn&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Db&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Send&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Sync&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">let&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">get_optional_var&lt;/span>::&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="nb">String&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;TEST&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s">&amp;#34;DB&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">expect&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;TEST_DB must be a string&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">match&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">as_deref&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nb">Some&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;postgres&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Arc&lt;/span>::&lt;span class="n">from&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">postgres&lt;/span>::&lt;span class="n">testutils&lt;/span>::&lt;span class="n">setup&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="k">await&lt;/span>&lt;span class="p">),&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nb">Some&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;sqlite&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">None&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Arc&lt;/span>::&lt;span class="n">from&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">sqlite&lt;/span>::&lt;span class="n">testutils&lt;/span>::&lt;span class="n">setup&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="k">await&lt;/span>&lt;span class="p">),&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nb">Some&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="fm">panic!&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Invalid TEST_DB &lt;/span>&lt;span class="si">{}&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">),&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">};&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">super&lt;/span>::&lt;span class="n">init_schema&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="k">mut&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">ex&lt;/span>&lt;span class="p">()).&lt;/span>&lt;span class="k">await&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">unwrap&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">db&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&amp;hellip; use it to connect to the database in all tests, and configure a GitHub Actions job with &lt;code>TEST_DB=postgres&lt;/code> to run the test suites against the production database.&lt;/p>
&lt;p>Another benefit is that I have finally unstuck something I&amp;rsquo;ve been working on-and-off for months and that I had been procrastinating on due to its difficulty. That is: I&amp;rsquo;ve been trying to generalize the account creation and session management pieces of the EndBASIC Service into III-IV so that I can reuse those in EndTRACKER. This was made &lt;em>really&lt;/em> difficult due to static dispatch, but now it&amp;rsquo;s a piece of cake. Which means I should be able to add user accounts in EndTRACKER really soon now and maybe finally open it up to the public.&lt;/p>
&lt;p>All in all, I&amp;rsquo;m satisfied with the change. The code is much simpler now and I do not foresee the small costs at runtime nor in binary size to be problematic &lt;em>at all&lt;/em> for my specific use cases.&lt;/p></description></item><item><title>Unit-testing a web service in Rust</title><link>https://jmmv.dev/2023/07/unit-testing-a-web-service.html</link><pubDate>Fri, 07 Jul 2023 06:30:00 -0700</pubDate><guid>https://jmmv.dev/2023/07/unit-testing-a-web-service.html</guid><description>&lt;p>One of the things I&amp;rsquo;m most proud of the Rust web services I have written is how I can run their tests with zero setup and within milliseconds, all while making me confident that &lt;code>main&lt;/code> can always be shipped to production. I&amp;rsquo;ve previously touched upon how this all works in other articles, but it&amp;rsquo;s time for a deep dive.&lt;/p>
&lt;p>To make things specific, I&amp;rsquo;ll be describing the testing infrastructure of &lt;a href="/software/endtracker.html">EndTRACKER&lt;/a>, the &lt;a href="/2021/07/endbasic-0.7.html">EndBASIC Service&lt;/a>, and the &lt;a href="https://github.com/jmmv/iii-iv/tree/eec320cd02149f223d8a9c7f8d697845ec2114d8/example/">sample key/value store app of III-IV&lt;/a>. These services are all structured in three separate layers, and I&amp;rsquo;ll be covering the testing strategy for each of them.&lt;/p>
&lt;p>But before getting into how each layer is exercised on its way to production, let&amp;rsquo;s talk about external dependencies&amp;hellip; because dependencies are the root of all evil when it comes to the usual poor testing strategies you may encounter.&lt;/p>
&lt;div class="container action-highlight p-4 my-4 d-md-none">
&lt;div class="row text-center">
&lt;p>A blog on operating systems, programming languages, testing, build systems, my own software
projects and even personal productivity. Specifics include FreeBSD, Linux, Rust, Bazel and
EndBASIC.&lt;/p>
&lt;/div>
&lt;div class="row">
&lt;div class="col">
&lt;div class="form-group">
&lt;form action="https://endtracker.azurewebsites.net/api/sites/e8da9f62-b7ac-4fe9-bf20-7c527199a376/subscribers/add" method="post">
&lt;input type="text" name="email"
placeholder="Enter your email"
class="form-control input-sm text-center my-1"/>
&lt;button type="submit" class="btn btn-primary btn-block my-1">Subscribe&lt;/button>
&lt;/form>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;div class="row px-2">
&lt;div class="col col-sm-5 text-left">
&lt;small>&lt;span class="subscriber-count">0&lt;/span> subscribers&lt;/small>
&lt;/div>
&lt;div class="col col-sm-7 text-right">
&lt;p>
&lt;a rel="me" href="https://mastodon.online/@jmmv">
&lt;img src="/images/badges/mastodon-logo.svg" width="32px" height="32px" alt="Follow @jmmv on Mastodon">
&lt;/a>
&lt;a href="https://twitter.com/intent/follow?original_referer=https%3A%2F%2Fjmmv.dev%2F&amp;amp;screen_name=jmmv">
&lt;img src="/images/badges/Twitter_logo_blue.svg" width="32px" height="32px" alt="Follow @jmmv on Twitter">
&lt;/a>
&lt;a href="/feed.xml">&lt;img src="/images/badges/feed-icon-28x28.png" alt="RSS feed">&lt;/a>
&lt;/p>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;h1 id="interacting-with-dependencies">Interacting with dependencies&lt;/h1>
&lt;p>Pretty much any web service relies on other services, which I&amp;rsquo;ll call &lt;em>dependencies&lt;/em>. These include databases, queuing systems, distributed storage, remote logging&amp;hellip; you name it. The list of dependencies may be long, and their direct use in tests is typically where the friction in testing comes from: most service implementations are unable to stub their dependencies out, so the developers end up having to run the real dependencies to execute any test.&lt;/p>
&lt;p>If you have worked on the development of any modern web service, particularly in a corporate environment, you&amp;rsquo;ve witnessed the issues that running real dependencies causes:&lt;/p>
&lt;ul>
&lt;li>
&lt;p>You have had to carefully set up your development environment with the right versions of tools and services, wasting hours (or days!) of productive time.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>You have had to troubleshoot test failures caused by problems in your development environment. Any small deviation from the blessed configuration can lead to mysterious problems and you are on your own to figure them out. &amp;ldquo;Works on my machine!&amp;rdquo; is a common excuse to not get involved in solving a coworker&amp;rsquo;s issue.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>You have had to rely on overly powerful machines to run the tests because all the dependencies are huge and consume large amounts of RAM and CPU. After all, each dependency assumes it will be running on its own server(s) and is likely written in a language different from all other dependencies, thus requiring its own heavy runtime. &lt;a href="/2023/06/fast-machines-slow-machines.html">Talk about waste, huh.&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>You have had to patiently wait for many minutes every time you run tests while Docker downloads multi-GB images, starts the dependencies, and waits for them to be ready to serve requests after (re)starting from scratch.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>You have had to suffer from flaky tests because the connections to the dependent services sometimes fail or the state of the dependent services has somehow been polluted by other tests.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>You have had to witness entire teams being spun up and funded to deal with slow CI runs and flaky tests, all while spending countless machines to support these resource-hungry tests.&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>These issues are all avoidable with proper &lt;em>upfront care&lt;/em>. I&amp;rsquo;m convinced that most developers want to do the right thing, but: one, many times they don&amp;rsquo;t &lt;em>know&lt;/em> what the right thing &lt;em>even is&lt;/em>; and, two, the pressure to &amp;ldquo;launch and iterate&amp;rdquo; often comes with an empty promise that there will be time &amp;ldquo;later&amp;rdquo; to address past cut corners. And you well know that automated tests are often ignored until they become truly necessary&amp;mdash;that is, when the product is crashing left and right and customers are threatening to leave&amp;mdash;at which point a solid testing infrastructure is non-existent and cannot be easily retrofit.&lt;/p>
&lt;p>A key foundation to avoid these problems is to architect the system in a way that puts all external dependencies behind interfaces from the ground up. These interfaces then let you plug in different implementations of the dependencies such that most tests can skip using the real dependencies. In other words, the key foundation is &lt;strong>Dependency Injection (DI)&lt;/strong>. And no, I&amp;rsquo;m not talking about fancy DI frameworks: all I&amp;rsquo;m talking about is the very basics of defining interfaces or traits and passing instances of those to constructors and functions.&lt;/p>
&lt;p>Now, of course, there is a balance between A) fast and deterministic tests that rely on fake services and B) slow and accurate tests that rely on real services: the more you stub out real dependencies, the less accurate tests become. The idea, though, is to have the &lt;em>choice&lt;/em> to pick one or the other on a test by test basis depending on the scenario to validate. And to make that choice, the system architecture must be in place to support it from the very beginning. With that in place, you can come up with the best testing strategy for each scenario, and you can choose how much of test collateral has to run every time you run tests and how much of it can be postponed to PR merge time or nightly runs.&lt;/p>
&lt;p>In my services, my goal is to make the vast majority of tests run with a simple &lt;code>cargo test&lt;/code> after a &lt;code>git clone&lt;/code>. No configuration necessary. A small subset of tests &lt;em>do&lt;/em> talk to the real dependencies and require configuration but, while these can run locally, I rarely need to do so because they are automated to run in CI at PR merge time.&lt;/p>
&lt;p>Let&amp;rsquo;s dive into the different layers of the architecture to see how these ideas play out. The layers are one for database access, one for business logic, and one for REST handling. You may want to read &lt;a href="/2023/03/introducing-iii-iv.html">&amp;ldquo;Introducing III-IV&amp;rdquo;&lt;/a> and &lt;a href="/2023/06/mvc-non-ui-apps.html">&amp;ldquo;MVC but for non-UI apps&amp;rdquo;&lt;/a> beforehand, both of which describe the general architecture of these services.&lt;/p>
&lt;h1 id="database-layer-testing">Database layer testing&lt;/h1>
&lt;p>My services use PostgreSQL in production. While setting up a local instance of this database is not difficult and it doesn&amp;rsquo;t consume any meaningful resources when idle, it&amp;rsquo;s still far from the zero setup experience I strive to achieve. So the first thing I had to do was hide the database queries behind an interface. The basic building blocks look like this and can be found in the &lt;a href="https://github.com/jmmv/iii-iv/blob/eec320cd02149f223d8a9c7f8d697845ec2114d8/core/src/db.rs">&lt;code>iii_iv_core::db&lt;/code>&lt;/a> module:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-rust" data-lang="rust">&lt;span class="line">&lt;span class="cl">&lt;span class="sd">/// Abstraction over the database connection.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd">&lt;/span>&lt;span class="cp">#[async_trait]&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">trait&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Db&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="sd">/// Type of the transaction wrapper type to generate.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd">&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">type&lt;/span> &lt;span class="nc">Tx&lt;/span>: &lt;span class="nc">BareTx&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Send&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Sync&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">&amp;#39;static&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="sd">/// Begins a transaction.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd">&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">async&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">fn&lt;/span> &lt;span class="nf">begin&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>-&amp;gt; &lt;span class="nc">DbResult&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="bp">Self&lt;/span>::&lt;span class="n">Tx&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="sd">/// Common operations for all transactions.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd">&lt;/span>&lt;span class="cp">#[async_trait]&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">trait&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">BareTx&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="sd">/// Commits the transaction.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd">&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">async&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">fn&lt;/span> &lt;span class="nf">commit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">mut&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>-&amp;gt; &lt;span class="nc">DbResult&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>The &lt;code>Db&lt;/code> trait exposes a generic mechanism to open a transaction against a database via its &lt;code>begin&lt;/code> method. The returned transaction type is parameterized on &lt;code>Db::Tx&lt;/code>, which has to be a subtrait of &lt;code>BareTx&lt;/code>. In turn, &lt;code>BareTx&lt;/code> represents the common operations one can do with a generic transaction but does not have any domain-specific knowledge.&lt;/p>
&lt;p>Each web service is responsible for supplying its own transaction trait that extends &lt;code>BareTx&lt;/code> with the operations that make sense in its domain. For example, here is how the sample key/value store service that ships with III-IV exposes the database operations needed to implement the key retrieval and storage operations. Note that the upstream code uses the name &lt;code>Tx&lt;/code> for this trait, but I&amp;rsquo;ve renamed it to &lt;code>KVStoreTx&lt;/code> in this text for clarity:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-rust" data-lang="rust">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#[async_trait]&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">trait&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">KVStoreTx&lt;/span>: &lt;span class="nc">BareTx&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="sd">/// Gets the current value of the given `key`.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd">&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">async&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">fn&lt;/span> &lt;span class="nf">get_key&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="k">mut&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">key&lt;/span>: &lt;span class="kp">&amp;amp;&lt;/span>&lt;span class="nc">Key&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>-&amp;gt; &lt;span class="nc">DbResult&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Entry&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="sd">/// Sets `key` to `entry`, which includes its value and version.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd">&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">async&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">fn&lt;/span> &lt;span class="nf">set_key&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="k">mut&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">key&lt;/span>: &lt;span class="kp">&amp;amp;&lt;/span>&lt;span class="nc">Key&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">entry&lt;/span>: &lt;span class="kp">&amp;amp;&lt;/span>&lt;span class="nc">Entry&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>-&amp;gt; &lt;span class="nc">DbResult&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// ... and several more ...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>There is nothing in these interfaces that points to database-specific behavior, which is intentional. The only thing that client code is allowed to do is create a transaction and call the business-specific methods on it, without knowing what the transaction is talking to. Going back to the example above, this snippet would fetch the value of a key from the key/value store:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-rust" data-lang="rust">&lt;span class="line">&lt;span class="cl">&lt;span class="kd">let&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">mut&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">tx&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">begin&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="k">await&lt;/span>&lt;span class="o">?&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">let&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">value&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">tx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">get_key&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="k">await&lt;/span>&lt;span class="o">?&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">tx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">commit&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="k">await&lt;/span>&lt;span class="o">?&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>With the service-specific transaction type in place (&lt;code>KVStoreTx&lt;/code>), the service is also responsible for supplying separate implementations of it for all databases the service wishes to support. As mentioned earlier, this means providing a variant for PostgreSQL for production usage. But what about tests? Tests could use their own database-less implementation&amp;mdash;for this trivial example, a &lt;code>HashMap&lt;/code> would suffice&amp;mdash;but going this route becomes tricky once you want to reproduce more realistic OLTP database behavior, especially when concurrent operations take place. The other obvious alternative is to use SQLite: a real database that requires zero configuration, which fits the perfect bill for unit tests.&lt;/p>
&lt;p>As a result, I end up with the following types in the system:&lt;/p>
&lt;ul>
&lt;li>A generic &lt;code>PostgresDb&lt;/code> (provided by &lt;a href="https://github.com/jmmv/iii-iv/tree/eec320cd02149f223d8a9c7f8d697845ec2114d8/postgres/">&lt;code>iii_iv_postgres&lt;/code>&lt;/a>) and a service-specific &lt;code>PostgresKVStoreTx&lt;/code> for production.&lt;/li>
&lt;li>A generic &lt;code>SqliteDb&lt;/code> (provided by &lt;a href="https://github.com/jmmv/iii-iv/tree/eec320cd02149f223d8a9c7f8d697845ec2114d8/sqlite/">&lt;code>iii_iv_sqlite&lt;/code>&lt;/a>) and service-specific &lt;code>SqliteKVStoreTx&lt;/code> for tests.&lt;/li>
&lt;/ul>
&lt;p>Implementing the same database queries against two different database systems is annoying indeed, but forcing myself to do this keeps me honest in maintaining true abstractions. However, it is critical that these implementations behave as similarly as possible and, to guarantee this, I write extensive unit tests in a separate &lt;code>db/tests.rs&lt;/code> file. These tests look like this:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-rust" data-lang="rust">&lt;span class="line">&lt;span class="cl">&lt;span class="k">async&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">fn&lt;/span> &lt;span class="nf">test_simplified_get_after_set&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">D&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">db&lt;/span>: &lt;span class="nc">D&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">where&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">D&lt;/span>: &lt;span class="nc">Db&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">D&lt;/span>::&lt;span class="n">Tx&lt;/span>: &lt;span class="nc">KVStoreTx&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">let&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">mut&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">tx&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">db&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">begin&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="k">await&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">unwrap&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">let&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Key&lt;/span>::&lt;span class="n">new&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;the-key&amp;#34;&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">to_owned&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">let&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">entry&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Entry&lt;/span>::&lt;span class="n">new&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;insert&amp;#34;&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">to_owned&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Version&lt;/span>::&lt;span class="n">from_u32&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="n">unwrap&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">tx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">set_key&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">entry&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="k">await&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">unwrap&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="fm">assert_eq!&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">entry&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">tx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">get_key&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="k">await&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">unwrap&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">tx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">commit&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="k">await&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">unwrap&lt;/span>&lt;span class="p">();&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>As you can see, each tests is parameterized on a &lt;code>D&lt;/code> type. The &lt;code>D&lt;/code> type is an implementation of the &lt;code>Db&lt;/code> trait presented earlier, whose only purpose is to yield new transactions of its inner &lt;code>D::Tx&lt;/code> type based on a pre-established connection. The &lt;code>D::Tx&lt;/code> type is mapped to the domain-specific &lt;code>KVStoreTx&lt;/code> type so that tests have access to the primitives to be tested. Notably, though, the tests have no way of knowing which database they are talking to.&lt;/p>
&lt;p>With these generic tests in place, the question is: how are they executed against the individual database implementations? The &lt;code>db/postgres.rs&lt;/code> and &lt;code>db/sqlite.rs&lt;/code> modules of each service define &lt;code>#[test]&lt;/code> entry points for each test. These entry points are thin wrappers for the common test code in &lt;code>db/tests.rs&lt;/code> and their sole purpose is to establish a connection to the database and then delegate to the test implementation. Basically, each wrapper looks like this:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-rust" data-lang="rust">&lt;span class="line">&lt;span class="cl">&lt;span class="sd">/// This is the specialization of a test for SQLite.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd">&lt;/span>&lt;span class="cp">#[tokio::test]&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">async&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">fn&lt;/span> &lt;span class="nf">test_simplified_get_after_set&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// Create a connection to the SQLite in-memory database.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">let&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">db&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">iii_iv_sqlite&lt;/span>::&lt;span class="n">testutils&lt;/span>::&lt;span class="n">setup&lt;/span>::&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">SqliteKVStoreTX&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="k">await&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// Delegate to the common test code.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">crate&lt;/span>::&lt;span class="n">db&lt;/span>::&lt;span class="n">tests&lt;/span>::&lt;span class="n">test_simplified_get_after_set&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">db&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="k">await&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="sd">/// This is the specialization of a test for PostgreSQL.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd">///
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd">/// Note how the test is marked `ignore`. We&amp;#39;ll see why that is later on.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd">&lt;/span>&lt;span class="cp">#[tokio::test]&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="cp">#[ignore = &lt;/span>&lt;span class="s">&amp;#34;Requires environment configuration and is expensive&amp;#34;&lt;/span>&lt;span class="cp">]&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">async&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">fn&lt;/span> &lt;span class="nf">test_simplified_get_after_set&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// Create a connection to PostgreSQL using the configuration specified via
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c1">// environment variables. The connection is set up to use a temporary
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c1">// schema so that tests are isolated from each other and don&amp;#39;t leave garbage
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c1">// behind.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kd">let&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">db&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">iii_iv_postgres&lt;/span>::&lt;span class="n">testutils&lt;/span>::&lt;span class="n">setup&lt;/span>::&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">PostgresKVStoreTx&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="k">await&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// Delegate to the common test code.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">crate&lt;/span>::&lt;span class="n">db&lt;/span>::&lt;span class="n">tests&lt;/span>::&lt;span class="n">test_simplified_get_after_set&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">db&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="k">await&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>For a long while, this is actually how the test wrappers looked like and&amp;hellip; they were written by hand. At some point, I grew tired of copy/pasting these snippets over and over again and invested a wee bit of time learning how to leverage macros to cut down the repetition. It wasn&amp;rsquo;t as difficult as I imagined. You can see how this works in practice in the sample key/value store &lt;a href="https://github.com/jmmv/iii-iv/blob/eec320cd02149f223d8a9c7f8d697845ec2114d8/example/src/db/tests.rs">tests&lt;/a> and their &lt;a href="https://github.com/jmmv/iii-iv/blob/eec320cd02149f223d8a9c7f8d697845ec2114d8/example/src/db/sqlite.rs#L150">instantiation for SQLite&lt;/a>.&lt;/p>
&lt;h1 id="driver-layer-testing">Driver layer testing&lt;/h1>
&lt;p>Let&amp;rsquo;s jump one level up and look at the testing approach for the driver layer.&lt;/p>
&lt;p>The driver layer of each service typically exposes a single &lt;code>Driver&lt;/code> type. The &lt;code>Driver&lt;/code> maintains the state of the application and provides entry points for all REST operations, usually with a 1:1 mapping between REST API and driver method.&lt;/p>
&lt;p>To instantiate a &lt;code>Driver&lt;/code>, all service dependencies are injected at creation time. Here is an example of how the &lt;code>Driver&lt;/code> constructor looks like for the EndTRACKER data plane service, which is more interesting to analyze than the driver for the sample key/value store:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-rust" data-lang="rust">&lt;span class="line">&lt;span class="cl">&lt;span class="k">pub&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">crate&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">fn&lt;/span> &lt;span class="nf">new&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">db&lt;/span>: &lt;span class="nc">D&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">clock&lt;/span>: &lt;span class="nc">C&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">geolocator&lt;/span>: &lt;span class="nc">G&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">abuse_policy&lt;/span>: &lt;span class="nc">A&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">queue_client&lt;/span>: &lt;span class="nc">Client&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">BatchTask&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">C&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="no">QD&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>-&amp;gt; &lt;span class="nc">Self&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="bp">Self&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">db&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">clock&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">geolocator&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">abuse_policy&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">queue_client&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>See? A trivial constructor that &lt;em>does no work&lt;/em>, as it shall be done. Neat&amp;hellip; but what are all these type parameters? These type parameters are what allow injecting the different implementations of each dependency into the service for testing purposes.&lt;/p>
&lt;p>Now, why are they are type parameters? Simply because I wanted to &lt;em>try&lt;/em> using static dispatch, and&amp;hellip; things have gotten unwieldy. All references to the &lt;code>Driver&lt;/code> type in &lt;code>impl&lt;/code> blocks look like this awful chunk:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-rust" data-lang="rust">&lt;span class="line">&lt;span class="cl">&lt;span class="k">impl&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">A&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">C&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">D&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">G&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="no">QD&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Driver&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">A&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">C&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">D&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">G&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="no">QD&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">where&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">A&lt;/span>: &lt;span class="nc">AbusePolicy&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">D&lt;/span>::&lt;span class="n">Tx&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Clone&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Send&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Sync&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">&amp;#39;static&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">C&lt;/span>: &lt;span class="nc">Clock&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Clone&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Send&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Sync&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">&amp;#39;static&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">D&lt;/span>: &lt;span class="nc">Db&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Clone&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Send&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Sync&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">&amp;#39;static&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">D&lt;/span>::&lt;span class="n">Tx&lt;/span>: &lt;span class="nc">DataTx&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">From&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">D&lt;/span>::&lt;span class="n">SqlxTx&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Send&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Sync&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">&amp;#39;static&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">G&lt;/span>: &lt;span class="nc">GeoLocator&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Clone&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Send&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Sync&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">&amp;#39;static&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="no">QD&lt;/span>: &lt;span class="nc">Db&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Clone&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Send&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Sync&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">&amp;#39;static&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="no">QD&lt;/span>::&lt;span class="n">Tx&lt;/span>: &lt;span class="nc">ClientTx&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">T&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">BatchTask&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">From&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="no">QD&lt;/span>::&lt;span class="n">SqlxTx&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Send&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Sync&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">&amp;#39;static&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c1">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>If I had to write this monstrosity &lt;em>just once&lt;/em>, it could be tolerable. But because I split the implementation of the &lt;code>Driver&lt;/code> across different files to keep them short&amp;hellip; this chunk is repeated across many files and keeping them in sync is a humongous hassle. I&amp;rsquo;m&amp;hellip; not happy. Fear not though: the alternative is to use &lt;code>Arc&amp;lt;Mutex&amp;lt;T&amp;gt;&amp;gt;&lt;/code> everywhere with &lt;code>T&lt;/code> being a type alias over the trait, which keeps the noise down significantly. Mind you, I used to do this and I&amp;rsquo;m not sure the switch to static dispatch was worth it. But I digress&amp;hellip;&lt;/p>
&lt;p>Because all these types are parameterized, it means I can instantiate a &lt;code>Driver&lt;/code> and back it by different implementations of each dependency. For example:&lt;/p>
&lt;ul>
&lt;li>The &lt;code>db&lt;/code> can be backed by PostgreSQL in production and SQLite in tests as I have already covered in the database layer section.&lt;/li>
&lt;li>The &lt;code>clock&lt;/code> can be backed by a &lt;code>SystemClock&lt;/code> that returns the system time, and also by a &lt;code>MonotonicClock&lt;/code> that exposes fake (and deterministic!) time.&lt;/li>
&lt;li>The &lt;code>geolocator&lt;/code> can be backed by an &lt;code>AzureGeoLocator&lt;/code> that talks to Azure Maps, and also by a &lt;code>MockGeoLocator&lt;/code> that returns pre-configured results and errors.&lt;/li>
&lt;/ul>
&lt;p>&amp;hellip; and similarly for any other resource needed by the &lt;code>Driver&lt;/code>.&lt;/p>
&lt;p>This, once again, allows: writing super-fast non-flaky unit tests because they do not reach out to real resources; running the tests with zero configuration; and avoiding the need to spawn resource-hungry dependencies on the local machine.&lt;/p>
&lt;p>So what do tests in the driver layer actually test? These tests are mostly responsible for validating the business logic. They cover all happy paths but, critically, they &lt;em>also&lt;/em> cover all error paths I can think about&amp;mdash;something that&amp;rsquo;s made trivial by the use of fake dependencies. These tests do not cover any HTTP interactions though; for those, we have to move up one layer.&lt;/p>
&lt;h1 id="rest-layer-testing">REST layer testing&lt;/h1>
&lt;p>The REST layer is the one interfacing with the user of the web services via the network. This is the layer where requests are deserialized, validated, routed to the driver, and where responses or errors are serialized back to the user with the correct HTTP status codes.&lt;/p>
&lt;p>This layer is currently written using the &lt;code>axum&lt;/code> web framework, whose fundamental building block is the &lt;code>Router&lt;/code>. Each web service creates a new &lt;code>Router&lt;/code> and registers all API endpoints plus an instance of the &lt;code>Driver&lt;/code> that gets passed to the API handlers as a state parameter. Take a look at the &lt;a href="https://github.com/jmmv/iii-iv/blob/eec320cd02149f223d8a9c7f8d697845ec2114d8/example/src/rest/mod.rs#L37">sample key/value store router creation&lt;/a>.&lt;/p>
&lt;p>Because the &lt;code>Driver&lt;/code> is injected into the REST &lt;code>Router&lt;/code>, it can be parameterized with all the non-production dependencies as described earlier&amp;mdash;and it is. Now, the question is: what do the tests of the REST layer look like and what do they do?&lt;/p>
&lt;p>For these, I used to spawn a local instance of the HTTP server, listening on a random unused port, and then made the tests call HTTP endpoints over the loopback interface with the &lt;code>reqwest&lt;/code> crate. Once I moved to &lt;code>axum&lt;/code> from &lt;code>warp&lt;/code>, things improved. I could start relying on the one-shot testing feature exposed by this framework, which allows calling the router endpoints without going through the network. Not a revolutionary change, but a nice improvement for simplicity indeed.&lt;/p>
&lt;p>To test this layer, I apply the &lt;a href="/2020/12/builder-pattern-for-tests.html">builder pattern to define test scenarios&lt;/a>. With this idiom, I can capture the parameters to an API call and the expectations of what it should return in a declarative manner. Here is one example of a test for the &amp;ldquo;put key&amp;rdquo; operation of the sample key/value store:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-rust" data-lang="rust">&lt;span class="line">&lt;span class="cl">&lt;span class="k">fn&lt;/span> &lt;span class="nf">route&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">key&lt;/span>: &lt;span class="kp">&amp;amp;&lt;/span>&lt;span class="kt">str&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>-&amp;gt; &lt;span class="p">(&lt;/span>&lt;span class="n">http&lt;/span>::&lt;span class="n">Method&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">String&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">http&lt;/span>::&lt;span class="n">Method&lt;/span>::&lt;span class="no">PUT&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="fm">format!&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;/api/v1/keys/&lt;/span>&lt;span class="si">{}&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="p">))&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="cp">#[tokio::test]&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">async&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">fn&lt;/span> &lt;span class="nf">test_create&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">let&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">TestContext&lt;/span>::&lt;span class="n">setup&lt;/span>&lt;span class="p">().&lt;/span>&lt;span class="k">await&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">let&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">response&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">OneShotBuilder&lt;/span>::&lt;span class="n">new&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">app&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">route&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;first&amp;#34;&lt;/span>&lt;span class="p">))&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">send_text&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;new value&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">await&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">expect_status&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">http&lt;/span>::&lt;span class="n">StatusCode&lt;/span>::&lt;span class="no">CREATED&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">expect_json&lt;/span>::&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Entry&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">await&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kd">let&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">exp_response&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Entry&lt;/span>::&lt;span class="n">new&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;new value&amp;#34;&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">to_owned&lt;/span>&lt;span class="p">(),&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Version&lt;/span>::&lt;span class="n">initial&lt;/span>&lt;span class="p">());&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="fm">assert_eq!&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">exp_response&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">response&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="fm">assert_eq!&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">exp_response&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">context&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">get_key&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;first&amp;#34;&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="k">await&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>In this test, &lt;code>TestContext&lt;/code> is a container that helps set up the &lt;code>Driver&lt;/code> with fake dependencies and instantiates the &lt;code>Router&lt;/code> around it. The most interesting part is the use of my own &lt;a href="https://github.com/jmmv/iii-iv/blob/eec320cd02149f223d8a9c7f8d697845ec2114d8/core/src/rest.rs#L223">&lt;code>OneShotBuilder&lt;/code>&lt;/a>, which implements the builder pattern for one-shot calls. With this at hand, the test says that it has to send a specific text document to a specific &lt;code>PUT&lt;/code> endpoint and then expects that the HTTP API call returns a &lt;code>CREATED&lt;/code> status code with a valid JSON response of type &lt;code>Entry&lt;/code>. Finally, the &lt;code>context.get_key&lt;/code> call is a helper method that &lt;em>pokes directly into the database&lt;/em> to see if the key is set, which validates the side-effects of the API call on persistent storage.&lt;/p>
&lt;p>The tests in this layer are responsible for validating anything that&amp;rsquo;s specific to the interactions with the user over HTTP, but these tests assume that both the driver and database layers work correctly. This is why these tests do not validate in excruciating detail all the possible corner cases that we can face in the driver or its interactions with external dependencies: the driver tests have that responsibility.&lt;/p>
&lt;h1 id="fidelity-problems">Fidelity problems&lt;/h1>
&lt;p>Alright, so that&amp;rsquo;s the majority of the current testing approach. We have seen how the foundational database layer is architected to support dual implementations via PostgreSQL and SQLite, how other supporting services are modeled with the same duality, and how the driver and REST layers leverage the in-memory / fake implementations to provide logical test coverage at all layers. As is, these provide very good coverage of the functionality of the web services and give me almost full confidence that &lt;code>main&lt;/code> is release-quality at any given time.&lt;/p>
&lt;p>But there are still some risks.&lt;/p>
&lt;p>The major risk in using SQLite for tests vs. PostgreSQL for production is that they are very different databases. Sure, they are both OLTP SQL databases, but their SQL languages are distinct dialects and SQLite is in-process whereas PostgreSQL runs on a server. Dealing with slightly-different SQL queries is easy because the differences are obvious, but there are subtle differences in behavior that influence how calls behave, especially in error conditions. For example: you will never experience a &amp;ldquo;maximum connections reached&amp;rdquo; error with SQLite, but you surely will with PostgreSQL. Similarly, SQLite might give you trouble with concurrent writes while PostgreSQL won&amp;rsquo;t. There are also risks when replacing the clock with a fake one, or when replacing other services such as the Azure Maps or SMTP clients with stub implementations.&lt;/p>
&lt;p>Now, you&amp;rsquo;d say: &lt;em>&amp;ldquo;Well, you are facing these fidelity issues because you don&amp;rsquo;t test against the real thing, duh. If all your tests used the real dependencies, then you&amp;rsquo;d be fine!&amp;rdquo;&lt;/em> Except&amp;hellip; that&amp;rsquo;s not how testing works. When writing a test, you can do two things:&lt;/p>
&lt;ul>
&lt;li>
&lt;p>You can write tests for the &amp;ldquo;known knowns&amp;rdquo;: the happy and failure paths that you know can happen.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>You can write tests for the &amp;ldquo;known unknowns&amp;rdquo;: the scenarios you think might happen but for which you have no good answers and you need to discover what their behavior is.&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>These are easy to model in tests, and if you are writing these tests, then you can make sure your real and fake dependencies behave in the same way.&lt;/p>
&lt;p>But there is another class of failures that you cannot test for with unit tests: the &amp;ldquo;unknown unknowns&amp;rdquo;. These are the situations you do not anticipate, and because you do not anticipate them, you cannot write tests for them. It doesn&amp;rsquo;t matter that you are using the real dependencies or fake dependencies. If you cannot imagine these scenarios, no test will cover them. And this is where I have encountered interesting bugs in production before.&lt;/p>
&lt;h1 id="real-system-testing">Real system testing&lt;/h1>
&lt;p>Thus, even though most of the testing I do in the web services is fast and requires no setup, there is still a need to validate &amp;ldquo;the real thing&amp;rdquo;: that is, the service talking to the real dependencies under real world conditions and usage.&lt;/p>
&lt;p>To accomplish this, I do two things.&lt;/p>
&lt;p>The first is I write tests that actually talk to the real services (oops). These tests all require manual configuration and are marked with &lt;code>#[ignore]&lt;/code> as we saw earlier so that a &lt;code>cargo test&lt;/code> won&amp;rsquo;t pick them up by default. The CI jobs are configured to supply the right settings for these tests, and the PR merge checks forcibly run these ignored tests. It is also possible to run these tests locally by manually configuring the environment in a &lt;code>config.env&lt;/code> file and using a trivial &lt;code>test.sh&lt;/code> script that hooks things up with &lt;code>cargo test&lt;/code>, but as said earlier, I rarely have to do so.&lt;/p>
&lt;p>The second is I deploy to a staging environment and do manual testing on it. Every commit merged into &lt;code>main&lt;/code> gets automatically deployed to a staging instance of the service (which is made easy by Azure Functions&amp;rsquo; slot feature), and I do some manual validation that things work. I could automate this testing, of course, but it is something that can still wait.&lt;/p>
&lt;h1 id="is-this-enough">Is this enough?&lt;/h1>
&lt;p>I know this is an overly simplistic view of the world, and that this testing approach can let some subtle bugs slip through. It has actually happened before. But thanks to this testing approach&amp;mdash;and Rust&amp;rsquo;s type system, whose help cannot be overstated&amp;mdash;every new feature I have launched &lt;em>has worked on the first try&lt;/em> and the web services have kept happily chugging along the years. This is critical to me because these web services are just side projects of mine, so I must ensure they cause me the least trouble possible in production.&lt;/p>
&lt;p>Finally, let me clarify one thing: I&amp;rsquo;ve been talking about &amp;ldquo;unit tests&amp;rdquo; throughout this post, but if we want to be pedantic, almost nothing of what I described are pure unit tests. Every test at every layer relies on the layers below it to behave correctly: the service&amp;rsquo;s own code is never stubbed out so, for example, a test for the REST layer will run code in the driver and database layers. The only thing that&amp;rsquo;s stubbed out are the connections to external services. I believe this style of testing provides much more realistic scenarios at the expense of making them more subtle to breakage when code changes.&lt;/p>
&lt;p>And that&amp;rsquo;s it for today. If you liked this post, you may also enjoy &lt;a href="/2020/12/unit-testing-a-console-app.html">&amp;ldquo;Unit-testing a console app (a text editor)&amp;rdquo;&lt;/a> from over 2 years ago. It is then that I came up with the idea of using the builder pattern to define tests, and that idea still proves very useful to this day.&lt;/p></description></item><item><title>ldd(1) and untrusted binaries</title><link>https://jmmv.dev/2023/07/ldd-untrusted-binaries.html</link><pubDate>Sat, 01 Jul 2023 16:30:00 -0700</pubDate><guid>https://jmmv.dev/2023/07/ldd-untrusted-binaries.html</guid><description>&lt;p>While diagnosing a non-determinism Bazel issue at work, I had to compare the dynamic libraries used by two builds of the same binary. To do so, I used &lt;code>ldd(1)&lt;/code>. The list of libraries printed by the tool was the same between the two builds, but the numbers next to them were different. Which numbers, you ask? Well, take a look at this sample output:&lt;/p>
&lt;pre tabindex="0">&lt;code>$ ldd /bin/ls
linux-vdso.so.1 (0x00007fff5bbed000)
libselinux.so.1 =&amp;gt; /lib64/libselinux.so.1 (0x00007f7786f48000)
libcap.so.2 =&amp;gt; /lib64/libcap.so.2 (0x00007f7786f3e000)
libc.so.6 =&amp;gt; /lib64/libc.so.6 (0x00007f7786d60000)
libpcre2-8.so.0 =&amp;gt; /lib64/libpcre2-8.so.0 (0x00007f7786cc6000)
/lib64/ld-linux-x86-64.so.2 (0x00007f7786fad000)
&lt;/code>&lt;/pre>&lt;p>Without prior knowledge, the numbers next to each library seemed to be the base addresses of the libraries once loaded into memory, and they probably differed across builds because of &lt;a href="https://en.wikipedia.org/wiki/Address_space_layout_randomization">ASLR&lt;/a>. If this was true, it meant that the differences were irrelevant from a build determinism perspective, but I had to confirm this claim because I had never given these numbers a second thought.&lt;/p>
&lt;div class="container action-highlight p-4 my-4 d-md-none">
&lt;div class="row text-center">
&lt;p>A blog on operating systems, programming languages, testing, build systems, my own software
projects and even personal productivity. Specifics include FreeBSD, Linux, Rust, Bazel and
EndBASIC.&lt;/p>
&lt;/div>
&lt;div class="row">
&lt;div class="col">
&lt;div class="form-group">
&lt;form action="https://endtracker.azurewebsites.net/api/sites/e8da9f62-b7ac-4fe9-bf20-7c527199a376/subscribers/add" method="post">
&lt;input type="text" name="email"
placeholder="Enter your email"
class="form-control input-sm text-center my-1"/>
&lt;button type="submit" class="btn btn-primary btn-block my-1">Subscribe&lt;/button>
&lt;/form>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;div class="row px-2">
&lt;div class="col col-sm-5 text-left">
&lt;small>&lt;span class="subscriber-count">0&lt;/span> subscribers&lt;/small>
&lt;/div>
&lt;div class="col col-sm-7 text-right">
&lt;p>
&lt;a rel="me" href="https://mastodon.online/@jmmv">
&lt;img src="/images/badges/mastodon-logo.svg" width="32px" height="32px" alt="Follow @jmmv on Mastodon">
&lt;/a>
&lt;a href="https://twitter.com/intent/follow?original_referer=https%3A%2F%2Fjmmv.dev%2F&amp;amp;screen_name=jmmv">
&lt;img src="/images/badges/Twitter_logo_blue.svg" width="32px" height="32px" alt="Follow @jmmv on Twitter">
&lt;/a>
&lt;a href="/feed.xml">&lt;img src="/images/badges/feed-icon-28x28.png" alt="RSS feed">&lt;/a>
&lt;/p>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;p>To answer the question, I did what one should always do: read the official documentation. I typed &lt;code>man ldd&lt;/code> and was greeted by the following on the CentOS 7 machine I was working on:&lt;/p>
&lt;figure>
&lt;img src="/images/2023-07-01-ldd-manpage.png" width="100%">
&lt;figcaption>Screenshot of the beginning of the &lt;tt>ldd(1)&lt;/tt> manual page on CentOS 7 with the following text highlighted by me: "&lt;i>Be aware, however, that in some circumestances, some versions of &lt;tt>ldd&lt;/tt> may attempt to obtain the dependency information by directly executing the program. Thus, you should &lt;b>never&lt;/b> employ &lt;tt>ldd&lt;/tt> on an untrusted executable&lt;/i>."&lt;/figcaption>
&lt;/figure>
&lt;p>Wait, what? Under some circumstances (which ones?) and with some versions of &lt;code>ldd&lt;/code> (which ones again?&lt;sup id="fnref:1">&lt;a href="#fn:1" class="footnote-ref" role="doc-noteref">1&lt;/a>&lt;/sup>), &lt;code>ldd&lt;/code> may &lt;em>execute&lt;/em> the given binary to determine the libraries it uses. Which means that running &lt;code>ldd&lt;/code> on an untrusted binary could compromise your system. The manual page goes on to say that you should never run &lt;code>ldd&lt;/code> against untrusted binaries.&lt;/p>
&lt;p>Needless to say, this was really surprising to see. Why would &lt;code>ldd&lt;/code> execute &lt;em>anything&lt;/em> to print details about a file? I quickly posted this on &lt;a href="https://twitter.com/jmmv/status/1674889696294621184">Twitter&lt;/a> and &lt;a href="https://mastodon.online/@jmmv/110635380384812322">Mastodon&lt;/a>, and the higher-than-usual engagement made me think that many more people than I weren&amp;rsquo;t aware of this behavior&amp;hellip; so I had to investigate a bit more.&lt;/p>
&lt;hr>
&lt;p>This behavior was originally reported as a security vulnerability in &lt;a href="https://www.cvedetails.com/cve/CVE-2009-5064/">CVE-2009-5064&lt;/a> and the report was closed with the rationale: &lt;em>&amp;ldquo;not a security vulnerability because &lt;code>ldd&lt;/code> must not be run on untrusted binaries&amp;rdquo;&lt;/em>. While this may be literally true, I find the answer quite dismissive: how does one &lt;em>know&lt;/em> that, say, &lt;code>readelf&lt;/code> or &lt;code>objdump&lt;/code> can be run against untrusted binaries but &lt;code>ldd&lt;/code> cannot? When giving a file to a tool, the common expectation is that the tool will read and parse the file&lt;sup id="fnref:2">&lt;a href="#fn:2" class="footnote-ref" role="doc-noteref">2&lt;/a>&lt;/sup>, not &lt;em>run&lt;/em> it. This violates the &lt;a href="https://en.wikipedia.org/wiki/Principle_of_least_astonishment">Principle of least astonishment (POLA)&lt;/a>, for me at least.&lt;/p>
&lt;p>Even though upstream did not agree to the security vulnerability report, various people thought there was a real problem, so some Linux distributions &lt;em>did&lt;/em> patch &lt;code>ldd&lt;/code> to not execute binaries directly. I do not have access to an old-enough unpatched Linux system to verify this surprising behavior, but there is a trivial repro in the &lt;a href="https://www.openwall.com/lists/oss-security/2011/03/07/13">&amp;ldquo;ldd can execute an app unexpectedly&amp;rdquo;&lt;/a> email thread along with a simple fix.&lt;/p>
&lt;p>And if my reading is correct, this surprising behavior was removed from the upstream sources back in 2017 (eight years after the original report) in commit &lt;a href="https://sourceware.org/git/?p=glibc.git;a=commit;h=eedca9772e99c72ab4c3c34e43cc764250aa3e3c">&lt;code>eedca9772e&lt;/code>&lt;/a>. It&amp;rsquo;s quite hard to tell if this change was addressing the reported security issue because the commit has no written rationale nor reference to the CVE. Which makes the whole thing feel worse: what I sense is a security-fix-in-disguise begrudgingly accepted after many years of saying this was not a problem&amp;hellip; which is never great. But that&amp;rsquo;s just my read of the whole thing and I&amp;rsquo;m probably wrong.&lt;/p>
&lt;p>In any case, even if &lt;em>this&lt;/em> particular issue is fixed, &lt;strong>it is still unsafe to run &lt;code>ldd&lt;/code> against untrusted binaries&lt;/strong>. &lt;code>ldd&lt;/code> uses the dynamic linker to &lt;em>load&lt;/em> the binary and its dependencies into memory, and then relies on the dynamic linker itself to print details to the console. And because of this, this process can be abused in other working-as-intended ways to trigger code injection as explained in &lt;a href="https://www.cvedetails.com/cve/CVE-2019-1010023">CVE-2019-1010023&lt;/a>. All of these require social engineering though&amp;hellip; but we all know that humans are often the weakest link in security.&lt;/p>
&lt;hr>
&lt;p>So why does &lt;code>ldd&lt;/code> look so problematic anyway? Let&amp;rsquo;s look at the internals of this tool.&lt;/p>
&lt;p>My first surprise was to see that, on Linux, &lt;code>ldd&lt;/code> is a shell script&lt;sup id="fnref:3">&lt;a href="#fn:3" class="footnote-ref" role="doc-noteref">3&lt;/a>&lt;/sup>&amp;mdash;and a very simple one at that. Poking through &lt;a href="https://sourceware.org/git/?p=glibc.git;a=blob;f=elf/ldd.bash.in;h=e45dec5894fe561585da01ea64b651663128e8d5;hb=HEAD">the contents of &lt;code>/usr/bin/ldd&lt;/code>&lt;/a>, you&amp;rsquo;ll notice that all this script does is pass the given binary to a collection of built-in dynamic linkers (stored in &lt;code>RTLDLIST&lt;/code>) and, once it finds a dynamic linker that can process the binary, it runs the linker against the binary with the &lt;code>LD_TRACE_LOADED_OBJECTS=1&lt;/code> setting. The linker then lays out the binary inside a new process along &lt;em>all&lt;/em> the direct and indirect libraries it requires, dumps information to the console, and exits.&lt;/p>
&lt;p>We can do the same by hand:&lt;/p>
&lt;pre tabindex="0">&lt;code>$ /lib64/ld-linux-x86-64.so.2 --verify /bin/ls &amp;amp;&amp;amp; echo &amp;#39;Supported!&amp;#39;
Supported!
$ LD_TRACE_LOADED_OBJECTS=1 /lib64/ld-linux-x86-64.so.2 /bin/ls
linux-vdso.so.1 (0x00007ffd28dc4000)
libselinux.so.1 =&amp;gt; /lib64/libselinux.so.1 (0x00007feb357d8000)
libcap.so.2 =&amp;gt; /lib64/libcap.so.2 (0x00007feb357ce000)
libc.so.6 =&amp;gt; /lib64/libc.so.6 (0x00007feb355f0000)
libpcre2-8.so.0 =&amp;gt; /lib64/libpcre2-8.so.0 (0x00007feb35556000)
/lib64/ld-linux-x86-64.so.2 (0x00007feb3583d000)
&lt;/code>&lt;/pre>&lt;p>Voila! We get the exact same output that &lt;code>ldd&lt;/code> would produce modulo differences in the addresses across different executions.&lt;/p>
&lt;hr>
&lt;p>I&amp;rsquo;ll probably continue to use &lt;code>ldd&lt;/code> because it is very convenient and I rarely face situations where I have to analyze untrusted binaries. But if those situations ever arise, here are some alternatives:&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://github.com/haampie/libtree">&lt;code>libtree the-binary&lt;/code>&lt;/a>, which displays the direct and indirect libraries required by a binary as a tree.&lt;/li>
&lt;li>&lt;code>objdump -p the-binary | grep NEEDED&lt;/code>, which is the solution provided in the &lt;code>ldd(1)&lt;/code> manual page I quoted earlier but is not equivalent to &lt;code>ldd&lt;/code> because it can only handle direct dependencies.&lt;/li>
&lt;li>&lt;code>readelf -d the-binary | grep NEEDED&lt;/code>, which is a similar solution to the previous one with the same caveats.&lt;/li>
&lt;/ul>
&lt;p>Before parting, the question I have is: why doesn&amp;rsquo;t &lt;code>ldd&lt;/code> walk the library tree by inspecting ELF headers instead of loading the libraries into a process? The answer might be in the name: I&amp;rsquo;m guessing that &lt;code>ldd&lt;/code> stands for &amp;ldquo;&lt;code>ld&lt;/code> dump&amp;rdquo; and thus it is &lt;em>supposed&lt;/em> to run the dynamic linker.&lt;/p>
&lt;div class="footnotes" role="doc-endnotes">
&lt;hr>
&lt;ol>
&lt;li id="fn:1">
&lt;p>This type of unspecific language is what you get when the manual pages are written by a different set of people than those that write the code and when the manual pages are shipped separately from the tools they document. Thanks Linux. This type of nonsense does not happen on the BSDs.&amp;#160;&lt;a href="#fnref:1" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;li id="fn:2">
&lt;p>There is always the risk that the parser has bugs that can be exploited by a malicious file, resulting in untrusted code execution, but that&amp;rsquo;s a different class of issue than &amp;ldquo;let&amp;rsquo;s just run the binary!&amp;rdquo;.&amp;#160;&lt;a href="#fnref:2" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;li id="fn:3">
&lt;p>This might help explain my long-standing question on why macOS does not ship with &lt;code>ldd&lt;/code> and why I always had to use &lt;code>otool&lt;/code>.&amp;#160;&lt;a href="#fnref:3" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;/ol>
&lt;/div></description></item><item><title>Fast machines, slow machines</title><link>https://jmmv.dev/2023/06/fast-machines-slow-machines.html</link><pubDate>Tue, 27 Jun 2023 06:50:00 -0700</pubDate><guid>https://jmmv.dev/2023/06/fast-machines-slow-machines.html</guid><description>&lt;p>Well, &lt;em>that&lt;/em> was unexpected. I recorded a couple of crappy videos in 5 minutes, &lt;a href="https://twitter.com/jmmv/status/1671670996921896960">posted them on a Twitter thread&lt;/a>, and went viral with 8.8K likes at this point. I really could not have predicted that, given that I&amp;rsquo;ve been posting what-I-believe-is interesting content for years and&amp;hellip; nothing, almost-zero interest. Now that things have cooled down, it&amp;rsquo;s time to stir the pot and elaborate on those thoughts a bit more rationally.&lt;/p>
&lt;p>To summarize, the Twitter thread shows two videos: one of an old computer running Windows NT 3.51 and one of a new computer running Windows 11. In each video, I opened and closed a command prompt, File Explorer, Notepad, and Paint. You can clearly see how apps on the old computer open up instantly whereas apps on the new computer show significant lag as they load. I questioned how computers are actually getting better when trivial things like this have regressed. And boom, the likes and reshares started coming in. Obviously some people had issues with my claims, but there seems to be an overwhelming majority of people that agree we have a problem.&lt;/p>
&lt;p>To open up, I&amp;rsquo;ll stand my ground: latency in modern computer interfaces, with modern OSes and modern applications, is terrible and getting worse. This applies to smartphones as well. At the same time, while UIs were much more responsible on computers of the past, those computers were also awful in many ways: new systems have changed our lives substantially. So, what gives?&lt;/p>
&lt;div class="container action-highlight p-4 my-4 d-md-none">
&lt;div class="row text-center">
&lt;p>A blog on operating systems, programming languages, testing, build systems, my own software
projects and even personal productivity. Specifics include FreeBSD, Linux, Rust, Bazel and
EndBASIC.&lt;/p>
&lt;/div>
&lt;div class="row">
&lt;div class="col">
&lt;div class="form-group">
&lt;form action="https://endtracker.azurewebsites.net/api/sites/e8da9f62-b7ac-4fe9-bf20-7c527199a376/subscribers/add" method="post">
&lt;input type="text" name="email"
placeholder="Enter your email"
class="form-control input-sm text-center my-1"/>
&lt;button type="submit" class="btn btn-primary btn-block my-1">Subscribe&lt;/button>
&lt;/form>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;div class="row px-2">
&lt;div class="col col-sm-5 text-left">
&lt;small>&lt;span class="subscriber-count">0&lt;/span> subscribers&lt;/small>
&lt;/div>
&lt;div class="col col-sm-7 text-right">
&lt;p>
&lt;a rel="me" href="https://mastodon.online/@jmmv">
&lt;img src="/images/badges/mastodon-logo.svg" width="32px" height="32px" alt="Follow @jmmv on Mastodon">
&lt;/a>
&lt;a href="https://twitter.com/intent/follow?original_referer=https%3A%2F%2Fjmmv.dev%2F&amp;amp;screen_name=jmmv">
&lt;img src="/images/badges/Twitter_logo_blue.svg" width="32px" height="32px" alt="Follow @jmmv on Twitter">
&lt;/a>
&lt;a href="/feed.xml">&lt;img src="/images/badges/feed-icon-28x28.png" alt="RSS feed">&lt;/a>
&lt;/p>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;script async src="https://platform.twitter.com/widgets.js" charset="utf-8">&lt;/script>
&lt;h1 id="the-original-comparison">The original comparison&lt;/h1>
&lt;p>Let&amp;rsquo;s address the elephant in the room first. The initial comparison I posted &lt;em>wasn&amp;rsquo;t&lt;/em> fair and I was aware of that going in. That said, I &lt;em>knew&lt;/em> repeating the experiment &amp;ldquo;properly&amp;rdquo; would yield the same results, so I plowed ahead with whatever I had right then. The videos were unplanned because the idea for the Tweets came to mind when I booted the old machine, clicked on Command Prompt, and was blown away by the immediacy to start the app.&lt;/p>
&lt;p>The original comparison videos showed:&lt;/p>
&lt;ul>
&lt;li>
&lt;p>An AMD K7-600 with 128MB of RAM and a 5400 RPM HDD running Windows NT 3.51. This was a machine from the year 1999-2000 with an OS that was about 5 years older than it. Hardware was experiencing really fast improvements back then, particularly in CPU speeds, and you were kinda expected to keep up with the 2-year upgrade treadmill or suffer from incredibly slowness. All this is to say that this machine was indeed overpowered for the OS I used.&lt;/p>
&lt;blockquote class="twitter-tweet" data-conversation="none">&lt;p lang="en" dir="ltr">Please remind me how we are moving forward. In this video, a machine from the year ~2000 (600MHz, 128MB RAM, spinning-rust hard disk) running Windows NT 3.51. Note how incredibly snappy opening apps is. 👇 &lt;a href="https://t.co/YEO824vIqI">pic.twitter.com/YEO824vIqI&lt;/a>&lt;/p>&amp;mdash; Julio Merino (@jmmv) &lt;a href="https://twitter.com/jmmv/status/1671670996921896960?ref_src=twsrc%5Etfw">June 22, 2023&lt;/a>&lt;/blockquote>
&lt;/li>
&lt;li>
&lt;p>A Surface Go 2 with an Intel Core m3 CPU, 8GB of RAM, and an SSD running Windows 11. This is a 3-year old machine that shipped with Windows 10, but Windows 11 is officially supported on it&amp;mdash;and as you know, that means you are tricked into upgrading. This is &lt;em>not&lt;/em> a powerful machine by any means, but: first, it&amp;rsquo;s running the verbatim Microsoft experience, and second, it &lt;em>should&lt;/em> be much more powerful than the K7 system, shouldn&amp;rsquo;t it? We are continuously reminded that any computer or phone today has orders of magnitude more power than past machines.&lt;/p>
&lt;blockquote class="twitter-tweet" data-conversation="none">&lt;p lang="en" dir="ltr">Now look at opening the same apps on Windows 11 on a Surface Go 2 (quad-core i5 processor at 2.4GHz, 8GB RAM, SSD). Everything is super sluggish. &lt;a href="https://t.co/W722PNEGv0">pic.twitter.com/W722PNEGv0&lt;/a>&lt;/p>&amp;mdash; Julio Merino (@jmmv) &lt;a href="https://twitter.com/jmmv/status/1671671000730316800?ref_src=twsrc%5Etfw">June 22, 2023&lt;/a>&lt;/blockquote>
&lt;p>Oh, and yes, I quoted the wrong hardware specs in the original tweet. Looking again on how I made that mistake: I searched for &amp;ldquo;Surface Go 2&amp;rdquo; in Bing, I landed on the &amp;ldquo;Surface &lt;em>Laptop&lt;/em> Go 2&amp;rdquo; page, and copied what I saw there without noticing that it wasn&amp;rsquo;t accurate.&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>All apps had been previously open, so they should all have been comfortably sitting in RAM.&lt;/p>
&lt;h1 id="the-better-comparison">The better comparison&lt;/h1>
&lt;p>Obviously various people noticed that there was something off with my comparison (unfair hardware configurations, wrong specs), so I redid the comparison once the thread started gaining attention:&lt;/p>
&lt;ul>
&lt;li>
&lt;p>Windows 2000 on the K7-600 machine (see &lt;a href="https://twitter.com/jmmv/status/1672046102923837440">installation thread&lt;/a>). This is an OS from 1999 running on hardware from that same year. And, if you ask me, this was the best Windows release of all times: super-clean UI on an NT core, carrying all of the features you would want around performance and stability (except with terrible boot times). As you can see, things still fare &lt;em>very&lt;/em> well for the old machine in terms of UI responsiveness.&lt;/p>
&lt;blockquote class="twitter-tweet" data-conversation="none">&lt;p lang="en" dir="ltr">For those thinking that the comparison was unfair, here is Windows 2000 on the same 600MHz machine. Both are from the same year, 1999. Note how the immediacy is still exactly the same and hadn’t been ruined yet. &lt;a href="https://t.co/Tpks2Hd1Id">pic.twitter.com/Tpks2Hd1Id&lt;/a>&lt;/p>&amp;mdash; Julio Merino (@jmmv) &lt;a href="https://twitter.com/jmmv/status/1672073678102872065?ref_src=twsrc%5Etfw">June 23, 2023&lt;/a>&lt;/blockquote>
&lt;/li>
&lt;li>
&lt;p>Windows 11 on a Mac Pro 2013 (see &lt;a href="/2022/03/windows-10-mac-pro-2013.html">installation instructions&lt;/a>) with a 6-core Xeon E5-1650v2 at 3.5GHz, 32GB of RAM, dual GPUs, and an SSD that can sustain up to 1GB/s. I know, this is a 10-year old machine at this point running a more modern OS. But please, go ahead, tell me with a straight face how hardware with these specs cannot handle opening trivial desktop applications without delay. I&amp;rsquo;ll wait.&lt;/p>
&lt;blockquote class="twitter-tweet" data-conversation="none">&lt;p lang="en" dir="ltr">Oh, and one more thing. Yes, yes, the Surface Go 2 is underpowered and all you want. But look at this video. Same steps on a 6-core Mac Pro @ 3.5GHz with 32GB of RAM. All apps cached. Note how they get painted in chunks. It&amp;#39;s not because of animations or mediocre hardware. &lt;a href="https://t.co/9TOGAdaTXO">pic.twitter.com/9TOGAdaTXO&lt;/a>&lt;/p>&amp;mdash; Julio Merino (@jmmv) &lt;a href="https://twitter.com/jmmv/status/1672385064490127360?ref_src=twsrc%5Etfw">June 23, 2023&lt;/a>&lt;/blockquote>
&lt;p>The reason I used the Mac Pro is because it is the best machine I have running Windows right now and, in fact, it&amp;rsquo;s my daily driver. But again, I do not care about how running this comparison on an &amp;ldquo;old&amp;rdquo; machine might be &amp;ldquo;inaccurate&amp;rdquo;. Back when &lt;a href="/2022/10/bye-microsoft-hi-snowflake.html">I left Microsoft last year&lt;/a>, I was regularly using a Z4 desktop from 2022, a maxed-out quad-core i7 ThinkPad with 32GB of RAM, and an i7 Surface Laptop 3 with 16GB of RAM. Delays were shorter on these, of course, but interactions were still noticeably slow.&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>So, in any case: I agree the original comparison was potentially flawed, but as you can see, a better comparison yields the same results&amp;mdash;which I knew it would. After years upon years of computer usage, you gain intuition on how things should behave, and trusting such intuition tends to work well as long as you &lt;em>validate&lt;/em> your assumptions later, don&amp;rsquo;t get me wrong!&lt;/p>
&lt;h1 id="computer-advancements">Computer advancements&lt;/h1>
&lt;p>Let&amp;rsquo;s put the tweets aside and talk about how things have changed since the 2000s. I jokingly asked how we are &amp;ldquo;moving forward&amp;rdquo; as an industry, so it&amp;rsquo;s worth looking into it.&lt;/p>
&lt;p>Indeed, we &lt;em>have&lt;/em> moved forward in many aspects: we now have incredible graphics and high-resolution monitors, super-fast networks, real-time video editing, and much more. All of these have improved over the years and it is very true that these advancements have allowed for certain life transformations to happen. Some examples: the ability to communicate with loved ones much more easily thanks to great-quality videoconferencing; the ability to have a streaming &amp;ldquo;cinema at home&amp;rdquo;; and the painless switch to remote work during the pandemic&lt;sup id="fnref:1">&lt;a href="#fn:1" class="footnote-ref" role="doc-noteref">1&lt;/a>&lt;/sup>.&lt;/p>
&lt;p>We have also moved forward on the I/O side. Disk I/O had always been the weakest spot on past systems. Floppy disks were unreliable and slow. CDs and DVDs were slightly-more-reliable but also slow. HDDs were the bottleneck for lots of things: their throughput improved over time, allowing things like higher-resolution video editing and the like, but random I/O hit physical limits&amp;mdash;and fast random I/O is what essentially drives desktop responsiveness.&lt;/p>
&lt;p>Then, boom, SSDs appeared and started showing up on desktops. These were a game-changer because they fixed the problem of random I/O. All of a sudden, booting a computer, launching a heavy game, opening folders with lots of small photos, or simply just using your computer&amp;hellip; all improved massively. It&amp;rsquo;s hard to explain the usability improvements that these brought if you did not live through this transition, and it&amp;rsquo;s scary how those improvements are almost gone; more on that later.&lt;/p>
&lt;p>Other stuff also improved, like the simplicity to install new hardware, the pervasiveness of wireless connections and devices, the internationalization of text and apps (Unicode isn&amp;rsquo;t easy nor cheap, I&amp;rsquo;ll grant that)&amp;hellip; all providing more usable machines in more contexts than ever.&lt;/p>
&lt;p>So yeah, things are better in many areas and we have more power than ever. Otherwise, we couldn&amp;rsquo;t do things like ML-assisted photo processing on a tiny phone, which was unimaginable in the 2000s.&lt;/p>
&lt;h1 id="terrible-latency">Terrible latency&lt;/h1>
&lt;p>Yet&amp;hellip; none of these advancements justify why things are as excruciatingly slow as they are today in terms of UI latency. Old hardware from the year 1999, combined with an OS from that same year, shows that responsive systems have existed&lt;sup id="fnref:2">&lt;a href="#fn:2" class="footnote-ref" role="doc-noteref">2&lt;/a>&lt;/sup>. If anything, all these hardware improvements I described should have made things &lt;em>better&lt;/em>, not worse, shouldn&amp;rsquo;t they?&lt;/p>
&lt;p>Some replied to the comparison telling me that graphical animations and bigger screens are &amp;ldquo;at fault&amp;rdquo; because we have to draw more pixels, and thus the fact that we have these new niceties means we have to tolerate slowness. Well, not quite. Witness for yourself:&lt;/p>
&lt;blockquote class="twitter-tweet" data-conversation="none">&lt;p lang="en" dir="ltr">And... one more thing? To those saying: &amp;quot;it&amp;#39;s the higher 4K resolution!&amp;quot; or &amp;quot;it&amp;#39;s the good-looking animations!&amp;quot; or &amp;quot;it&amp;#39;s the pretty desktop background!&amp;quot;—no, they aren&amp;#39;t at fault. See, the slowness is still visible with all of these disabled. In the end... blog post coming soon. &lt;a href="https://t.co/9BQy6IpK6a">pic.twitter.com/9BQy6IpK6a&lt;/a>&lt;/p>&amp;mdash; Julio Merino (@jmmv) &lt;a href="https://twitter.com/jmmv/status/1673326555702120448?ref_src=twsrc%5Etfw">June 26, 2023&lt;/a>&lt;/blockquote>
&lt;p>GPUs are a commodity now, and they lift the heavy burden of graphics management from the CPU. The kinds of graphical animations that a desktop renders are extremely cheap to compute, and this has been proven by macOS since its launch: all graphical effects on a macOS desktop feel instant. The effects &lt;em>do&lt;/em> delay interactions though&amp;mdash;the desktop switching animation is particularly intrusive, oh god how I hate that thing&amp;mdash;but the delays generally come from intentional pauses during the animation. And when the effects introduce latency because the GPU cannot keep up, such as when you attach a 4K display to a really old Mac, then it&amp;rsquo;s painfully obvious that animations stutter due to lack of power. I haven&amp;rsquo;t encountered the latter in any of the videos above though, which is why animations and the like have nothing to do with my concerns.&lt;/p>
&lt;p>So, please, think about it with a critical mind. How is the ability to edit multiple 4K video streams in real time or the ability to stream a 4K movie supposed to make starting apps like Notepad slower? Or opening the context menu in the desktop? Or reading your email? The new abilities we acquired much more power from the CPU and GPU, but they shouldn&amp;rsquo;t remove performance from tasks that are essentially I/O-bound. Opening a simple app shouldn&amp;rsquo;t be slower than it was more than 20 years ago; it really shouldn&amp;rsquo;t be. Yet here we are. The reasons for the desktop latency come from elsewhere, and I have some guesses for those. But first, a look at a couple of examples.&lt;/p>
&lt;h1 id="examples">Examples&lt;/h1>
&lt;p>On Windows land, there are two obvious examples I want to bring up and that were mentioned in the Twitter thread:&lt;/p>
&lt;ul>
&lt;li>
&lt;p>Notepad had been a native app until very recently, and it still opened pretty much instantaneously. With its rewrite as a UWP app, things went downhill. The before and after are apparent, and yet&amp;hellip; the app continues to be as unfeatureful as it had always been. This is extra slowness for no user benefit.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>As for Windows Terminal, sure, it is nicer than anything that came before it, but it is visibly much, much heavier than the old Command Prompt. And if you add PowerShell into the mix, we are talking about multiple &lt;em>seconds&lt;/em> for a new terminal window to be operational unless you have top-of-the-line hardware.&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>macOS fares better than Windows indeed, but it still has its issues. See this example contributed by @AlexRugerMusic. Even the mighty M1 has trouble opening up the system settings app:&lt;/p>
&lt;blockquote class="twitter-tweet" data-conversation="none">&lt;p lang="en" dir="ltr">Another example:&lt;br>&lt;br>Left: 2006 MBP (2GHz Core 2 Duo, 2GB DDR2 RAM, Max OS X 10.6.8; has SSD)&lt;br>&lt;br>Right: 2021 MacBook Air (M1, 16GB RAM, macOS 13)&lt;br>&lt;br>Apps open about twice as fast on the Pro as they do on the Air (most, not just System Preferences/Settings). &lt;a href="https://t.co/PjMX1DI4uz">pic.twitter.com/PjMX1DI4uz&lt;/a>&lt;/p>&amp;mdash; rewgs (@AlexRugerMusic) &lt;a href="https://twitter.com/AlexRugerMusic/status/1673550864366309376?ref_src=twsrc%5Etfw">June 27, 2023&lt;/a>&lt;/blockquote>
&lt;p>Linux is probably the system that suffers the least from these issues as it still feels pretty snappy on modest hardware. Fedora Linux 38, released in April 2023, runs really well on a micro PC from 11 years ago&amp;mdash;even if Gnome or KDE had been resource hogs back in the day. That said, this is only an illusion. As soon as you start installing any modern app that wasn&amp;rsquo;t developed exclusively for Linux&amp;hellip; the slow app start times and generally poor performance show up.&lt;/p>
&lt;p>Related, but I feel this needs saying: the biggest shock for me was when I joined Google back in 2009. At the time, Google Search and GMail had stellar performance: they were examples to follow. From the inside though&amp;hellip; I was quite shocked by how all internal tools crawled, and in particular by how slow the in-house command line tools were. I actually fault Google for the situation we are in today due to their impressive internal systems and their relentless push for web apps at all costs, which brings us to&amp;hellip;&lt;/p>
&lt;h1 id="causes">Causes&lt;/h1>
&lt;p>How does this all happen? It&amp;rsquo;s easy to say &amp;ldquo;Bloat!&amp;rdquo;, but that&amp;rsquo;s a hard thing to define because bloat can be justified: what one person considers as bloat is not the same as what another person considers as bloat. After all, &amp;ldquo;80% of users only use 20% of the software they consume&amp;rdquo; (see &lt;a href="https://en.wikipedia.org/wiki/Pareto_principle">Pareto principle&lt;/a>), but the key insight is that the 20% that each user consumes is different from one another. So bloat isn&amp;rsquo;t necessarily in the features offered by the software; it&amp;rsquo;s elsewhere.&lt;/p>
&lt;p>So then we have frameworks and layers of abstraction, which seem to introduce bloat for bloat&amp;rsquo;s sake. But I&amp;rsquo;m not sure this is correct either: abstraction doesn&amp;rsquo;t inherently have to make things slower, as Rust has proven. What makes things slower are priorities. Nobody prioritizes performance anymore unless for the critical cases where it matters (video games, transcoding video, and the like). What people (companies) prioritize is developer time. For example: you might not want to use Rust because its steep learning curve means you&amp;rsquo;ll spend more time learning than delivering, or its higher compiler times mean that you&amp;rsquo;ll spend more time waiting for the compiler than &lt;del>shipping&lt;/del> debugging production. Or another example: you might not want to develop native apps because that means &amp;ldquo;duplicate work&amp;rdquo;, so you reach out for a cross-platform web framework. That is, Electron.&lt;/p>
&lt;p>I know it&amp;rsquo;s easy to dunk on Electron, but there are clear telltale signs that this platform is at fault for a lot of the damage done to desktop latency. Take 1Password&amp;rsquo;s 8th version, which many of users that migrated from the 7th version despise due to the slowness of the new interface. Or take Spotify, which used to prioritize startup and playback latency over anything else in its inception and, as you know if you use it, that&amp;rsquo;s not true any more:&lt;/p>
&lt;blockquote class="twitter-tweet">&lt;p lang="en" dir="ltr">2009 version: 20MB fully native cocoa app, launches in less than a second, instant feedback when you click stuff, playback usually starts within 50ms &lt;a href="https://t.co/Enzi40PDCX">pic.twitter.com/Enzi40PDCX&lt;/a>&lt;/p>&amp;mdash; Rasmus Andersson (@rsms) &lt;a href="https://twitter.com/rsms/status/1656340616731840513?ref_src=twsrc%5Etfw">May 10, 2023&lt;/a>&lt;/blockquote>
&lt;p>These apps were rewritten in Electron to offer a unified experience across desktops and to cut down costs&amp;hellip; but for whom? The cost cuts were for the companies owning the products, not for the users. Such cuts impose a tax on &lt;em>every one of us&lt;/em> due to our day-to-day frustrations and the need to unnecessarily upgrade our hardware. Couple these rewrites with the fact that OSes cannot reuse the heavy framework across apps (same idea as how &lt;a href="/2021/08/using-all-memory-as-a-cache.html">using all RAM as a cache&lt;/a> is a flawed premise)&amp;hellip; and the bloat quickly adds up when you run these apps concurrently.&lt;/p>
&lt;p>Leaving Electron aside, another decision that likely introduces latency is the mass adoption of managed and interpreted languages. I know these are easy to dunk on as well, but that&amp;rsquo;s because we have reasons to do so. Take Java or .NET: several Windows apps have been slowly rewritten in C# and, while I have no proof of this, I&amp;rsquo;m convinced from past experience that this can be behind the sluggishness we notice. The JDK and the CLR do amazing jobs at optimizing long-running processes (their &lt;a href="https://en.wikipedia.org/wiki/Just-in-time_compilation">JIT&lt;/a> can do &lt;a href="https://en.wikipedia.org/wiki/Profile-guided_optimization">PGO&lt;/a> with real time data), but handling quick startup times is not something they manage well. This is why, for example, Bazel spawns a background server process to paper over startup latency and why Android has gone through multiple iterations of &lt;a href="https://en.wikipedia.org/wiki/Ahead-of-time_compilation">AOT&lt;/a> compilation. (Edit: there must be other reasons though that I have not researched. As &lt;a href="https://news.ycombinator.com/item?id=36508282">someone pointed out&lt;/a>, my assumption that Windows Terminal was mostly C# is not true.)&lt;/p>
&lt;p>More on this in &lt;a href="https://en.wikipedia.org/wiki/Wirth%27s_law">Wirth&amp;rsquo;s law&lt;/a>.&lt;/p>
&lt;h1 id="one-off-improvements-eaten-away">One-off improvements eaten away&lt;/h1>
&lt;p>To conclude, let me end with a pessimistic note by going back to hardware advancements.&lt;/p>
&lt;p>The particular improvement that SSDs brought us was a one-off &lt;em>transformation&lt;/em>. HDDs kept getting faster for years indeed, but they never could deliver the kind of random I/O that desktops require to be snappy. The switch to SSDs brought a kind of improvement that was at a different level. Unfortunately&amp;hellip; we could only buy those benefits &lt;em>once&lt;/em>: there is no other technology to switch to that provides such a transformative experience. And thus, once the benefits brought by the new technology were eaten away by careless software, we are almost back to square one. Yes, SSDs are getting faster, but newer drives won&amp;rsquo;t bring the kind of massive differences that the change from HDDs to SSDs brought.&lt;/p>
&lt;p>You can see this yourself if you try using recent versions of Windows or macOS &lt;em>without&lt;/em> an SSD: it is nigh impossible. These systems now assume that computers have SSDs in them, which is a fair assumption, but a problematic one due to what I mentioned above. The same applies to &amp;ldquo;bloat&amp;rdquo; in apps: open up your favorite resource monitor, look for the disk I/O bandwidth graph, and launch any modern app. You&amp;rsquo;ll see a stream of MBs upon MBs being loaded from disk into memory, all of which must complete before the app is responsive. This is the kind of bloat that Electron adds and that SSDs permitted, but that could be avoided altogether with different design decisions.&lt;/p>
&lt;p>Which makes me worried about Apple Silicon. Remember all the rage with the M1 launch and how these new machines had superb performance, extremely long battery life, and no fan noise? Well, wait and see: these benefits will be eaten away if we continue on the same careless path. And once that has happened, it&amp;rsquo;ll be too late. Retrofitting performance into existing applications is very difficult technically, and almost impossible to prioritize organizationally.&lt;/p>
&lt;p>So&amp;hellip; will computer architects be able to save us with other revolutionary technology shifts? I wouldn&amp;rsquo;t want to rely on that. Not because the shifts might not exist, but because we &lt;em>shouldn&amp;rsquo;t need them&lt;/em>.&lt;/p>
&lt;div class="footnotes" role="doc-endnotes">
&lt;hr>
&lt;ol>
&lt;li id="fn:1">
&lt;p>Oh wait: remote work does not qualify. I&amp;rsquo;m sorry: if you did any kind of open source development in the 90s or 2000s, you &lt;em>know&lt;/em> that fully-distributed &lt;em>and&lt;/em> truly-async work was perfectly possible back then.&amp;#160;&lt;a href="#fnref:1" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;li id="fn:2">
&lt;p>For a more detailed analysis, Dan Luu already covered this type of slowdown introduced by latency in his famous article &amp;ldquo;&lt;a href="http://danluu.com/input-lag/">Computer latency: 1977-2017&lt;/a>&amp;rdquo;. Note how the article goes further back than 1999 and that the computer with the best latency he found is from 1983. But, yeah, that old computer cannot match the workloads we put our computers through these days, so I don&amp;rsquo;t think comparing it to a modern desktop would be fair.&amp;#160;&lt;a href="#fnref:2" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;/ol>
&lt;/div></description></item><item><title>A persistent task queue in Rust</title><link>https://jmmv.dev/2023/06/iii-iv-task-queue.html</link><pubDate>Fri, 23 Jun 2023 06:35:00 -0700</pubDate><guid>https://jmmv.dev/2023/06/iii-iv-task-queue.html</guid><description>&lt;p>In a recent post, I announced the very non-exciting feature of having &lt;a href="/2023/06/in-house-email-subscriptions.html">custom-built email subscriptions&lt;/a> for this blog. Writing the subscription flow was easy, but developing the automation to, first, periodically scrape the blog&amp;rsquo;s RSS feed and, second, schedule email notifications to readers based on the items in the feed was really time-consuming and tricky to implement.&lt;/p>
&lt;p>You would say: &lt;em>&amp;ldquo;How is that hard? Just &lt;a href="https://github.com/rss2email/rss2email">set up a cron job&lt;/a> that fetches the RSS feed and sends emails!&amp;rdquo;&lt;/em> Yeah, yeah, of course, that can work. But when you add in other requirements, this approach is not so simple. Note a few things: you need to determine which posts in the feed are new and which aren&amp;rsquo;t, which means you have to keep track of all past-seen posts; my email gateway has daily limits on how many emails I can send, so I need to schedule the submissions across multiple days; and if the submission of one email fails, I want to retry sending that one email only. Add to that the fact that I run not one but multiple sites with their own subscription features, and these processes&amp;mdash;in particular, the email quota controls&amp;mdash;all have to somehow agree.&lt;/p>
&lt;p>The more you think about this problem, the more you realize having some sort of queue to track which emails have to be sent and which haven&amp;rsquo;t been sent yet could be very useful. At that point, you might as well realize that such a queuing system can also support all kinds of background operations that happen in a web service, not just email submissions, and I have been needing that ability for a while now.&lt;/p>
&lt;div class="container action-highlight p-4 my-4 d-md-none">
&lt;div class="row text-center">
&lt;p>A blog on operating systems, programming languages, testing, build systems, my own software
projects and even personal productivity. Specifics include FreeBSD, Linux, Rust, Bazel and
EndBASIC.&lt;/p>
&lt;/div>
&lt;div class="row">
&lt;div class="col">
&lt;div class="form-group">
&lt;form action="https://endtracker.azurewebsites.net/api/sites/e8da9f62-b7ac-4fe9-bf20-7c527199a376/subscribers/add" method="post">
&lt;input type="text" name="email"
placeholder="Enter your email"
class="form-control input-sm text-center my-1"/>
&lt;button type="submit" class="btn btn-primary btn-block my-1">Subscribe&lt;/button>
&lt;/form>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;div class="row px-2">
&lt;div class="col col-sm-5 text-left">
&lt;small>&lt;span class="subscriber-count">0&lt;/span> subscribers&lt;/small>
&lt;/div>
&lt;div class="col col-sm-7 text-right">
&lt;p>
&lt;a rel="me" href="https://mastodon.online/@jmmv">
&lt;img src="/images/badges/mastodon-logo.svg" width="32px" height="32px" alt="Follow @jmmv on Mastodon">
&lt;/a>
&lt;a href="https://twitter.com/intent/follow?original_referer=https%3A%2F%2Fjmmv.dev%2F&amp;amp;screen_name=jmmv">
&lt;img src="/images/badges/Twitter_logo_blue.svg" width="32px" height="32px" alt="Follow @jmmv on Twitter">
&lt;/a>
&lt;a href="/feed.xml">&lt;img src="/images/badges/feed-icon-28x28.png" alt="RSS feed">&lt;/a>
&lt;/p>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;p>So let&amp;rsquo;s get into specifics. Here are the conceptual tasks I envisioned within the context of &lt;a href="/software/endtracker.html">EndTRACKER&lt;/a> (terrible name, I know), along with the names they actually got in the code, to convert an RSS feed into email notifications:&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;code>ProcessFeeds&lt;/code>: Loads all feeds from the database and enqueues new &lt;code>ScrapeFeed&lt;/code> and &lt;code>ProcessFeed&lt;/code> tasks for every feed. This is the entry point to the system, and this task is enqueued by a timer once an hour to start the processing flow.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>ScrapeFeed(feed)&lt;/code>: Loads the details for &lt;code>feed&lt;/code>, downloads its registered RSS feed, and computes the delta against previously-known items. Newly-discovered feed items are inserted into a database and marked as &amp;ldquo;not yet notified&amp;rdquo;.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>ProcessFeed(feed)&lt;/code>: Loads all &amp;ldquo;not yet notified&amp;rdquo; posts for &lt;code>feed&lt;/code> from the database plus the list of verified email subscribers for the site that owns the feed. It then schedules one &lt;code>SendFeedItem&lt;/code> task for every post/subscriber pair and finally marks the feed item as notified.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>SendEmailItem(feed, item, subscriber)&lt;/code>: Loads the &lt;code>feed&lt;/code>&amp;rsquo;s &lt;code>item&lt;/code> details from the database, composes an email for the &lt;code>subscriber&lt;/code> by formatting arbitrary HTML into text, and sends the result to them. This is where sanity-checks happen, such as ensuring we have enough email submission quota left or that the subscriber hasn&amp;rsquo;t unsubscribed, and thus this task must be retried at a later stage if it fails.&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>With these task definitions in mind, it was time to go to the drawing board and design a queuing system to support them.&lt;/p>
&lt;hr>
&lt;p>Now, the question you surely have is: &lt;em>&amp;ldquo;Why bother? There are plenty of queuing services out there!&amp;rdquo;&lt;/em> And my answer is: &lt;em>&amp;quot;&lt;a href="/2021/01/why-endbasic.html">Because why not&lt;/a>&amp;quot;&lt;/em>. I wanted to have some fun designing and implementing this feature, and I don&amp;rsquo;t fancy the idea of marrying a specific cloud provider by relying on their cloud-native services: so far, the only thing I depend on for my web services is a hosted PostgreSQL instance and a bunch of Azure Functions deployments, and I could trivially move these to a VM in my home server if I had to.&lt;/p>
&lt;p>Anyhow. What &lt;em>is&lt;/em> a &amp;ldquo;persistent task queue&amp;rdquo; anyway, other than a mouthful? Let&amp;rsquo;s look at the words: it is a &lt;strong>queue&lt;/strong>, so it is an ordered record of &amp;ldquo;things&amp;rdquo;; it is &lt;strong>for tasks&lt;/strong>, so it needs to offer task-specific execution logic and tracking to ensure at-most-once semantics and the like; and it is &lt;strong>persistent&lt;/strong>, so the tasks and their statuses need to be stored somewhere.&lt;/p>
&lt;h1 id="key-ideas">Key ideas&lt;/h1>
&lt;p>As in any design, we have to start by enumerating the specific requirements I had for the solution to put the various design choices in context. These are:&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;strong>Service-agnostic.&lt;/strong> I run a few web services, all of which share common logic via &lt;a href="/software/iii-iv.html">the III-IV framework&lt;/a>. The queue implementation must live in this open-source framework. The framework must not know anything about the task specifics, so &lt;em>task descriptors&lt;/em> must be defined by the services and they need to be persisted in some generic way (JSON serialization).&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>Client and worker separation.&lt;/strong> Clients enqueuing tasks must not know anything about how to run them. Only the worker processes need to contain the code that processes the tasks. This means there ought to be two separate APIs, and there can be one or more client and/or workers running at any given time.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>Azure Functions deployment.&lt;/strong> The queue must run within existing services, not as a new standalone deployment. This is a restrictive requirement because my existing services are run by a serverless runtime, so the queue operations cannot rely on long-running processes.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>At-most once execution.&lt;/strong> Tasks have side-effects so they must run at most once. It is OK if some are lost as long as it&amp;rsquo;s a rare occurrence, but it is &lt;em>not acceptable&lt;/em> to run the same task twice. The fact that we run in a serverless environment helps with this because Azure Functions enforces a maximum runtime for processes, which we will take advantage of.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>Ability to retry tasks that fail.&lt;/strong> Some tasks will fail for expected reasons, such as when we have run out of outbound email quota for the day, and these must be postponed and retried at a later time. But some failures are not retriable, so whether a task needs to be retried or not has to be decided on an error-by-error basis.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>Quarantining of problematic tasks.&lt;/strong> Tasks that fail repeatedly or that cause the queue worker to crash in unexpected ways need to be moved out of the way after a few execution attempts so that they do not cause future trouble.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>Database-agnostic.&lt;/strong> As is the case for all of III-IV-based services, the choice of the database must be independent from the queue logic and both PostgreSQL (for production) and SQLite (for lightning-fast tests) must be supported. However, the database must be ACID because it will be used for synchronization.&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>With these, you can start envisioning how the queue looks like. Beware that I&amp;rsquo;m no expert in queuing systems, so this design and implementation are possibly flawed or incomplete in various ways&amp;hellip; but it does the job for now. Let&amp;rsquo;s dive into its specifics.&lt;/p>
&lt;h1 id="azure-functions-integration">Azure Functions integration&lt;/h1>
&lt;p>The first consumer of the task queue was going to be EndTRACKER and, right now, EndTRACKER runs as an Azure Functions serverless service: I upload a tiny Rust binary that exposes an HTTP interface and the cloud runtime takes care of spinning up short-lived containers whenever the configured HTTP routes are accessed. The only magic involved is making the Rust HTTP server expose itself via the TCP/IP port given to it in the &lt;code>FUNCTIONS_CUSTOMHANDLER_PORT&lt;/code> environment variable&amp;mdash;and, after that, all communication between the Azure Functions runtime and the Rust binary happens over HTTP.&lt;/p>
&lt;p>This is great, but&amp;hellip; I had to clear some questions before even attempting to write the queue service in this environment.&lt;/p>
&lt;p>The first question was: was it even possible to build the queue runtime in a serverless environment? A worker is, in theory, a long-lived process that polls the queue every few seconds or minutes to detect work to do and executes such work. The answer is obviously &amp;ldquo;yes, you can do that&amp;rdquo;. Imagine exposing a &lt;code>/queue-loop&lt;/code> HTTP endpoint and having a timer that calls this endpoint periodically to trigger the queue&amp;rsquo;s processing loop. As long as the loop can execute at least one task within the maximum allowed container run time, the queue will make forward progress.&lt;/p>
&lt;p>The second question was: can we integrate this timer into Azure Functions without needing a separate cron job that pokes &lt;code>/queue-loop&lt;/code> every few minutes? The answer also seemed to be yes: Azure Functions endpoints can be exposed via different triggers. Some triggers are HTTP endpoint calls, but other triggers, such as timers, can be used. If we define a trigger like the following in a &lt;code>functions/queue-loop.json&lt;/code> file:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;bindings&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;type&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;timerTrigger&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;direction&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;in&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;name&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;req&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;schedule&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;0 */10 * * * *&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Then the Azure Functions runtime will call this &lt;code>queue-loop&lt;/code> function every 10 minutes given the &lt;code>schedule&lt;/code> stanza above.&lt;/p>
&lt;p>But then the third question was: this is not an HTTP trigger&amp;hellip; can it be processed at all from a custom Rust binary, or are the officially supported SDKs relying on some &lt;em>other&lt;/em> communication mechanism with the runtime engine to react to non-HTTP triggers?&lt;/p>
&lt;p>Fortunately, the answer is also yes. It took me a bit of fiddling, but in the end I found that the runtime will invoke the &lt;code>/queue-loop&lt;/code> POST HTTP handler (outside of the default &lt;code>/api&lt;/code> namespace for user-supplied handlers). However, after I got this hooked up, I noticed that the Azure Functions runtime claimed that my handler failed (even when it did return a &lt;code>200 OK&lt;/code> code) and kept re-invoking it every few seconds&amp;mdash;as if previous calls had been lost. This took some more effort to figure out, and I had to peek into the C# SDK code to find the answer: the endpoint needs to return a valid JSON payload, not an empty document. After figuring this out, changing the endpoint to return an empty &lt;code>{}&lt;/code> dictionary allowed the runtime to interact with my handler just fine.&lt;/p>
&lt;p>I was cleared to proceed with the original idea.&lt;/p>
&lt;h1 id="the-client-interface">The client interface&lt;/h1>
&lt;p>Defining the right interface for tasks, especially the internal interface to process them, took many iterations. As mentioned earlier, clients must not know anything about how tasks are executed, so there have to be two separate APIs: one that is public for clients, and one that is internal to the workers.&lt;/p>
&lt;p>In the end, I settled on the following client operations. Note that this is missing &lt;em>a ton&lt;/em> of details, so don&amp;rsquo;t take the Rust code too literally here:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-rust" data-lang="rust">&lt;span class="line">&lt;span class="cl">&lt;span class="k">enum&lt;/span> &lt;span class="nc">TaskResult&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="sd">/// The task succeeded with an optional diagnostic/status message.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd">&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Done&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">Option&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="nb">String&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">),&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="sd">/// The task failed hard with the given error message.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd">&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Failed&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">String&lt;/span>&lt;span class="p">),&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="sd">/// The task was abandoned after N failed retries with the given error message.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd">&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Abandoned&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">String&lt;/span>&lt;span class="p">),&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">impl&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="no">DB&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Task&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Client&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="no">DB&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Task&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">where&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="no">DB&lt;/span>: &lt;span class="nc">Database&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Task&lt;/span>: &lt;span class="nc">Serialize&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="sd">/// Creates a new client that uses the `db` database for task persistence.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd">&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">fn&lt;/span> &lt;span class="nf">new&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">db&lt;/span>: &lt;span class="nc">DB&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>-&amp;gt; &lt;span class="nc">Self&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">..&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="sd">/// Enqueues a new `task` and returns the identifier assigned to it.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd">&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">async&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">fn&lt;/span> &lt;span class="nf">enqueue&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="k">mut&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">task&lt;/span>: &lt;span class="kp">&amp;amp;&lt;/span>&lt;span class="nc">T&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>-&amp;gt; &lt;span class="nb">Result&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Uuid&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">..&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="sd">/// Checks if the task `id` has finished execution by querying the database.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd">&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">async&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">fn&lt;/span> &lt;span class="nf">poll&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="k">mut&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">id&lt;/span>: &lt;span class="nc">Uuid&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>-&amp;gt; &lt;span class="nb">Result&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="nb">Option&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">TaskResult&lt;/span>&lt;span class="o">&amp;gt;&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">..&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="sd">/// Waits for the task `id` to finish execution by polling it every `period`.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd">&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">async&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">fn&lt;/span> &lt;span class="nf">wait&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="k">mut&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">id&lt;/span>: &lt;span class="nc">Uuid&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">period&lt;/span>: &lt;span class="nc">Duration&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>-&amp;gt; &lt;span class="nb">Result&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">TaskResult&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">..&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>We have a &lt;code>Client&lt;/code> that is connected to a database of a generic type at construction time. This client provides a mechanism to enqueue a JSON-serializable task via an &lt;code>enqueue&lt;/code> method, which returns the identifier of the enqueued task, and also offers methods to &lt;code>poll&lt;/code> for the task&amp;rsquo;s status as it runs and to &lt;code>wait&lt;/code> until the task completes.&lt;/p>
&lt;p>All operations issued by the client happen by talking to the database. To avoid a potential hot spot in inserting tasks, tasks cannot be identified by a globally-unique counter because, otherwise, multiple concurrent clients would need to synchronize on that datum. This is why tasks use UUIDs as identifiers. (I suppose using the default &amp;ldquo;row id&amp;rdquo; of the database could have also worked here just fine, but I&amp;rsquo;m already using UUIDs for many other things, so that&amp;rsquo;s what I picked.)&lt;/p>
&lt;p>The above is the essence of the &lt;code>Client&lt;/code>, but it has other methods. Take a look at &lt;a href="https://github.com/jmmv/iii-iv/blob/eec320cd02149f223d8a9c7f8d697845ec2114d8/queue/src/driver/client.rs">the &lt;code>client&lt;/code> module&lt;/a> for more details.&lt;/p>
&lt;h1 id="the-worker-service-not-a-microservice">The worker service: not a microservice&lt;/h1>
&lt;p>The worker is exposed as a &lt;code>Worker&amp;lt;Task&amp;gt;&lt;/code> type which looks like this. Pardon my over-simplified Rust:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-rust" data-lang="rust">&lt;span class="line">&lt;span class="cl">&lt;span class="k">impl&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Task&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Worker&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Task&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">where&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Task&lt;/span>: &lt;span class="nc">Deserialize&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="sd">/// Creates a new worker process that uses the `db` database to extract
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd">&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="sd">/// tasks and persist task state, uses `opts` for configuration, and
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd">&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="sd">/// relies on `exec` for the task execution logic.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd">&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">fn&lt;/span> &lt;span class="nf">new&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Exec&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ExecFut&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">db&lt;/span>: &lt;span class="nc">DB&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">opts&lt;/span>: &lt;span class="nc">WorkerOptions&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">exec&lt;/span>: &lt;span class="nc">Exec&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>-&amp;gt; &lt;span class="nc">Self&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">where&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="no">DB&lt;/span>: &lt;span class="nc">Database&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Exec&lt;/span>: &lt;span class="nb">Fn&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">T&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>-&amp;gt; &lt;span class="nc">ExecFut&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">ExecFut&lt;/span>: &lt;span class="nc">Future&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">Output&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ExecResult&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">..&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="sd">/// Tells the worker to look for runnable tasks in the database and to
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd">&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="sd">/// run them.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd">&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">async&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">fn&lt;/span> &lt;span class="nf">notify&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="k">mut&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>-&amp;gt; &lt;span class="nb">Result&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">..&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>The worker&amp;rsquo;s &lt;code>new&lt;/code> constructor spawns a Tokio background task that loops infinitely, polling tasks from the database &lt;code>db&lt;/code> and using the &lt;code>exec&lt;/code> closure to execute each runnable task. The user-configurable options provided in &lt;code>opts&lt;/code> tune the behavior of the loop, and all of these options can be provided via environment variables.&lt;/p>
&lt;p>But the infinite loop does nothing on its own. The worker loop starts idle and it only runs tasks whenever the &lt;code>notify&lt;/code> method is called. There is an async channel between the Tokio background task and the &lt;code>Worker&lt;/code> instance, which &lt;code>notify&lt;/code> uses to awaken the loop. This is where the previously-described HTTP API handler &lt;code>/queue-loop&lt;/code> comes into play: this handler wraps a &lt;code>Worker&lt;/code> and simply invokes &lt;code>notify&lt;/code> on it to trigger the processing loop.&lt;/p>
&lt;p>As for the &lt;code>exec&lt;/code> suppliers, these closures are intended to be stateless in memory, which simplifies their design. Remember that tasks can be executed from different workers, more than once if they have to be retried, and that the worker processes can die at any time&amp;hellip; so keeping state in memory is nonsensical. It &lt;em>is&lt;/em> possible to maintain state in memory in a very convoluted way, which I had to do for unit-testing purposes, but such difficulty is tolerable given this rationale.&lt;/p>
&lt;p>The most interesting thing about the &lt;code>exec&lt;/code> closure is its return type, which looks like the following:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-rust" data-lang="rust">&lt;span class="line">&lt;span class="cl">&lt;span class="k">enum&lt;/span> &lt;span class="nc">ExecError&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="sd">/// The task hard-failed with the given error message.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd">&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Failed&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">String&lt;/span>&lt;span class="p">),&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="sd">/// The task asked to be retried after a certain delay with a diagnostic
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd">&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="sd">/// message.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd">&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">RetryAfterDelay&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Duration&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">String&lt;/span>&lt;span class="p">),&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="sd">/// The task asked to be retried after a specific timestamp with a
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd">&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="sd">/// diagnostic message.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sd">&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">RetryAfterTimestamp&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">OffsetDateTime&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">String&lt;/span>&lt;span class="p">),&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">type&lt;/span> &lt;span class="nc">ExecResult&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">Result&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="nb">Option&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="nb">String&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ExecError&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>There are blanket conversions from database-layer errors (&lt;code>DbError&lt;/code>) and business logic errors (&lt;code>DriverError&lt;/code>) into &lt;code>ExecError&lt;/code> that classify these error types into either fatal failures or retriable failures. This allows the Rust try operator &lt;code>?&lt;/code> to do the right thing by default.&lt;/p>
&lt;p>As in the client section, the above is just a sketch of the &lt;code>Worker&lt;/code>. Take a look at &lt;a href="https://github.com/jmmv/iii-iv/blob/eec320cd02149f223d8a9c7f8d697845ec2114d8/queue/src/driver/worker.rs">the &lt;code>worker&lt;/code> module&lt;/a> for the real details.&lt;/p>
&lt;h1 id="safe-retries">Safe retries&lt;/h1>
&lt;p>One key requirement we haven&amp;rsquo;t covered yet is how to achieve at-most-once execution guarantees. For this, we need to ensure that only one worker can pick up a task at any given time.&lt;/p>
&lt;p>This is easy, right? We can implement a write-ahead journal for task processing, like this:&lt;/p>
&lt;ol>
&lt;li>Load a runnable (not-yet-running) task from the queue.&lt;/li>
&lt;li>Atomically mark the task as running (thanks, ACID transactions!).&lt;/li>
&lt;li>Run the task processing logic.&lt;/li>
&lt;li>If the task fails, atomically mark it as failed so that it can be retried later after a configurable delay.&lt;/li>
&lt;li>If the task succeeds, atomically mark it as done so that it is never considered as runnable again.&lt;/li>
&lt;/ol>
&lt;p>This ensures that only one worker will ever pick up a task so we are protected against multiple concurrent executions. All good, right? Well&amp;hellip; but what happens if the worker dies at any point after marking the task as running, for whatever reason? We will leave the task &amp;ldquo;running&amp;rdquo; so it won&amp;rsquo;t ever be considered as runnable again, which means it&amp;rsquo;ll never complete!&lt;/p>
&lt;p>Thankfully, this is where the serverless runtime provided by Azure Functions comes in very handy. We can rely on the fact that the runtime enforces a maximum runtime limit for any request and use that fact to detect &amp;ldquo;lost&amp;rdquo; tasks. In other words: if we find a task in the running state that has been running for longer than the maximum allowed runtime (5 minutes by default), then we can conclude that the worker was lost and that the task has to be retried.&lt;/p>
&lt;p>Which finally brings us to quarantining. A worker can die due to external reasons (exceeding its maximum runtime, hardware failure&amp;hellip;) or it can die because the &lt;code>exec&lt;/code> handler for the task crashed. It&amp;rsquo;s the latter case that&amp;rsquo;s worrying because we could have an ill-defined task that causes a repeated crash every time a worker picks it up. Such cases are rather common in large queuing systems and can cause slowdowns in task processing or a complete DOS of the service. This is why it&amp;rsquo;s important to discard a task if it has been retried more than N times, which is what&amp;rsquo;s represented by the &lt;code>Abandoned&lt;/code> task state.&lt;/p>
&lt;h1 id="putting-it-all-together">Putting it all together&lt;/h1>
&lt;p>Two requirements of the design were to separate the queue logic from the consumer services and to &lt;em>not&lt;/em> need extra services to be running. This posed an interesting problem.&lt;/p>
&lt;p>The queue processing loop (aka the &lt;code>Worker&lt;/code>) has to run in-process with the actual service. Now, while I do like a microservice-oriented design because it keeps responsibilities clear across components, deploying a bunch of services comes at a high maintenance cost&amp;mdash;one that I am not willing to pay for my side projects. This is why, in EndTRACKER, I have opted for a microservice-like design with a monolithic deployment. The way this works is that the &lt;em>code&lt;/em> in EndTRACKER is split into various REST services, and these services all get combined into one single HTTP router from &lt;code>main.rs&lt;/code>. The result is a single binary with trivial deployment practices, but leaving an easy way out of a monolith if the need to scale any of the internal services arises.&lt;/p>
&lt;p>In actual terms, this means that EndTRACKER now has an in-process &lt;code>batch&lt;/code> &amp;ldquo;microservice&amp;rdquo; that simply spawns the generic &lt;code>Worker&lt;/code> and exposes the &lt;code>/queue-loop&lt;/code> endpoint into the HTTP router, like this:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-rust" data-lang="rust">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// Spawn the worker, connecting it to system services and the `run_task`
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// execution logic.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kd">let&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">worker&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">iii_iv_queue&lt;/span>::&lt;span class="n">driver&lt;/span>::&lt;span class="n">Worker&lt;/span>::&lt;span class="n">new&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">worker_db&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">clock&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">worker_opts&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">move&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="n">t&lt;/span>&lt;span class="o">|&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">run_task&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">..&lt;/span>&lt;span class="p">.)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">});&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="kd">let&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">worker&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Arc&lt;/span>::&lt;span class="n">from&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Mutex&lt;/span>::&lt;span class="n">from&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">worker&lt;/span>&lt;span class="p">));&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c1">// Instantiate the service-independent queue worker from III-IV.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// This is the `/queue-loop` handler, essentially.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kd">let&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">queue_router&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">iii_iv_queue&lt;/span>::&lt;span class="n">rest&lt;/span>::&lt;span class="n">worker_cron_app&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">worker&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c1">// Create the HTTP router for the microservice, bundling the generic
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// III-IV endpoints with ours.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kd">let&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">router&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Router&lt;/span>::&lt;span class="n">new&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">route&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;/hourly&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">axum&lt;/span>::&lt;span class="n">routing&lt;/span>::&lt;span class="n">post&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">hourly&lt;/span>::&lt;span class="n">cron_post_handler&lt;/span>&lt;span class="p">))&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">merge&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">queue_router&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Verbose&amp;hellip; but not too complicated.&lt;/p>
&lt;p>But wait, what is that &lt;code>/hourly&lt;/code> endpoint that just showed up? That&amp;rsquo;s &lt;em>another&lt;/em> Azure Functions timer trigger that gets called every hour. &lt;em>This&lt;/em> is where the service injects the &lt;code>ProcessFeeds&lt;/code> master task into the queue to trigger the whole processing flow. With that task injected into the queue, the &lt;code>/queue-loop&lt;/code> then takes over every 10 minutes to discover and process all dependent tasks as they show up.&lt;/p>
&lt;h1 id="future-use-cases">Future use cases&lt;/h1>
&lt;p>Before concluding, let me briefly mention a couple of additional use cases that the queue could serve. It&amp;rsquo;s because these use cases exist that I pursued the queue solution instead of simply deploying &lt;code>rss2email&lt;/code> as a cron job in my home server.&lt;/p>
&lt;p>The first use case is going back to this long-standing to-do in the EndTRACKER codebase:&lt;/p>
&lt;pre tabindex="0">&lt;code>// Ideally we should get full visibility into all history, but that
// can be very costly and we can tolerate some error here. To fix
// this properly, though, we&amp;#39;d need some offline data preprocessing,
// which would benefit this whole function anyway.
&lt;/code>&lt;/pre>&lt;p>This comment is referring to the logic that computes the historical page views graphs &lt;em>on demand&lt;/em>. Right now, historical queries are limited to just one month because of this, but with deferred task processing, you can imagine having a daily task that calculates which data points are missing in a timeseries and spawns tasks to generate those precomputed data points&amp;hellip; which should be trivial to implement at this point. Furthermore, having this ability to compute summarized timeseries means I could change the service to fully discard request data after processing, further reducing the risk of keeping &lt;em>any&lt;/em> private data in the database.&lt;/p>
&lt;p>The other use case would arise if I start accepting &amp;ldquo;customers&amp;rdquo; in EndTRACKER. If that were the case, one feature I&amp;rsquo;d want to expose is an &amp;ldquo;export your data as a SQLite database&amp;rdquo; button so that you wouldn&amp;rsquo;t feel trapped in the platform. Implementing such a data dump cannot happen as part of a server request, so it would also benefit from happening via a deferred task.&lt;/p>
&lt;p>Finally, that&amp;rsquo;s all for today. Remember that &lt;a href="https://github.com/jmmv/iii-iv/">III-IV is open source&lt;/a>, so this queuing system is as well. Maybe you can now find use cases for this little framework yourself!&lt;/p></description></item><item><title>MVC but for non-UI apps</title><link>https://jmmv.dev/2023/06/mvc-non-ui-apps.html</link><pubDate>Tue, 20 Jun 2023 10:00:00 -0700</pubDate><guid>https://jmmv.dev/2023/06/mvc-non-ui-apps.html</guid><description>&lt;p>In &lt;a href="https://collindonnell.com/mvc-isnt-mvc">MVC isn&amp;rsquo;t MVC&lt;/a>, which hit the &lt;a href="https://news.ycombinator.com/item?id=36397058">Hacker News front page overnight&lt;/a>, Collin Donnell describes how the MVC design pattern that we use today isn&amp;rsquo;t really what was originally &lt;a href="https://folk.universitetetioslo.no/trygver/1979/mvc-2/1979-12-MVC.pdf">envisioned in 1979 by Tyrgve Reenskaug&lt;/a>. This prompted me to think about how this architecture, if tweaked even further, maps pretty well to today&amp;rsquo;s designs of &lt;em>other kinds&lt;/em> of programs, and I want to explore two cases in this post: web services and CLI apps. I know I promised a post on the task queuing system I have written in Rust, but that will have to wait for a couple more days.&lt;/p>
&lt;p>To recap, MVC stands for &lt;a href="https://en.wikipedia.org/wiki/Model%E2%80%93view%E2%80%93controller">Model-View-Controller&lt;/a> and is a software design pattern to structure the implementation of apps that provide a &amp;ldquo;user interface&amp;rdquo;. The core idea of this pattern is to separate the presentation of the app from its business logic, and this same idea can be applied to other types of apps as well.&lt;/p>
&lt;div class="container action-highlight p-4 my-4 d-md-none">
&lt;div class="row text-center">
&lt;p>A blog on operating systems, programming languages, testing, build systems, my own software
projects and even personal productivity. Specifics include FreeBSD, Linux, Rust, Bazel and
EndBASIC.&lt;/p>
&lt;/div>
&lt;div class="row">
&lt;div class="col">
&lt;div class="form-group">
&lt;form action="https://endtracker.azurewebsites.net/api/sites/e8da9f62-b7ac-4fe9-bf20-7c527199a376/subscribers/add" method="post">
&lt;input type="text" name="email"
placeholder="Enter your email"
class="form-control input-sm text-center my-1"/>
&lt;button type="submit" class="btn btn-primary btn-block my-1">Subscribe&lt;/button>
&lt;/form>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;div class="row px-2">
&lt;div class="col col-sm-5 text-left">
&lt;small>&lt;span class="subscriber-count">0&lt;/span> subscribers&lt;/small>
&lt;/div>
&lt;div class="col col-sm-7 text-right">
&lt;p>
&lt;a rel="me" href="https://mastodon.online/@jmmv">
&lt;img src="/images/badges/mastodon-logo.svg" width="32px" height="32px" alt="Follow @jmmv on Mastodon">
&lt;/a>
&lt;a href="https://twitter.com/intent/follow?original_referer=https%3A%2F%2Fjmmv.dev%2F&amp;amp;screen_name=jmmv">
&lt;img src="/images/badges/Twitter_logo_blue.svg" width="32px" height="32px" alt="Follow @jmmv on Twitter">
&lt;/a>
&lt;a href="/feed.xml">&lt;img src="/images/badges/feed-icon-28x28.png" alt="RSS feed">&lt;/a>
&lt;/p>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;h1 id="mvc-in-web-services">MVC in web services&lt;/h1>
&lt;p>If we take a look at a web service&amp;mdash;not a web app; we are talking about the server side only here&amp;mdash;we can map the layers of the MVC pattern as follows:&lt;/p>
&lt;ol>
&lt;li>
&lt;p>The View layer is where communication with the world happens. This layer contains the code that receives inbound network requests and writes their responses. This layer is purely in charge of deserializing and validating requests, and serializing responses in whichever protocol the service exposes. The code in this layer must restrict itself to, for example, parsing and emitting JSON, obtaining session details, or converting error types (such as exceptions or &lt;code>Result&lt;/code>s) to HTTP status codes.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>The Controller layer is where business logic is implemented and is sometimes called the &amp;ldquo;service layer&amp;rdquo; or, as I call it, the &amp;ldquo;driver&amp;rdquo;. Oftentimes there will be a 1:1 mapping from APIs exposed through the View layer and entry points to the Controller, but not always. This is where all kinds of decisions happen, including authorization checks and coordination of access to the various external resources that the service may need. For example, if various database operations need to be grouped in a transaction and retried on failure, this is where the transaction is created and where the retry logic (policy) lives.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>The Model layer is where access to the persisted data happens and is where the high level data types for the application may be defined. This is often an abstraction over a database, but it could also be an abstraction over whichever other dependent system the service needs to talk to. For this reason, this layer may also be referred to as the &amp;ldquo;data access&amp;rdquo; layer or, more generally, the &amp;ldquo;provider&amp;rdquo; layer because it&amp;rsquo;s where the service talks to other services that provide data.&lt;/p>
&lt;/li>
&lt;/ol>
&lt;p>I saw this design in practice during my time in the Azure Storage team, where our frontend exposed the same set of storage facilities through a multitude of protocols with high code reuse. I have replicated this same design in my own web services with great results and factored out common code in the &lt;a href="/software/iii-iv.html">III-IV framework&lt;/a>, whose name is a direct direct reference to this architecture. See &lt;a href="https://github.com/jmmv/iii-iv/tree/main/example/src">the sample application sources&lt;/a> to witness the three layers in action.&lt;/p>
&lt;p>But careful: note that just because a piece of code &lt;em>formats data&lt;/em> does not make that code belong to the View layer. Imagine, for example, a web service that has an API to format HTML content as a PDF file. In such a service, the Controller layer would be the one fetching the HTML document and transforming it into the PDF (even if the PDF is a &amp;ldquo;view&amp;rdquo; of some data). The View layer would be in charge of taking the PDF as a blob from the Controller layer and bundling it in whichever output format the API exposes which, in this particular case, might be emitting the blob verbatim with an &lt;code>application/pdf&lt;/code> content type header.&lt;/p>
&lt;h1 id="mvc-in-cli-apps">MVC in CLI apps&lt;/h1>
&lt;p>If we take a look at a CLI app&amp;mdash;without a TUI, because if it has a TUI the original concept of &amp;ldquo;views&amp;rdquo; applies quite literally&amp;mdash;we can map the layers of the MVC pattern as follows:&lt;/p>
&lt;ol>
&lt;li>
&lt;p>The View layer is where interactions with the user happen. This is where the app processes the command line flags and arguments and converts them to internal data structures. This is also where help requests are handled, where input data is gathered if the app is interactive, and where progress reporting and error messages are formatted for display. I already &lt;a href="/2013/08/cli-design-cli-is-presentation-layer.html">mentioned this back in 2013&lt;/a>.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>The Controller layer is where the application logic belongs. Notably, this layer must not interact with the console at all: &lt;code>printf&lt;/code>s of any kind do not belong here.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>The Model layer is where abstractions around the file system&amp;mdash;or whichever other external system the app talks to&amp;mdash;may live. For CLI apps wrapping a web service or a database, this is where the calls to those systems happen.&lt;/p>
&lt;/li>
&lt;/ol>
&lt;p>CLI apps vary in complexity, however, so structuring the code in these layers may result in overengineering and not be a reasonable thing to do. That said, it is often possible to organize any kind of app in these layers and it is good to &lt;em>think about&lt;/em> how the code could be structured, because this thought process can lead to better design decisions. Take two examples:&lt;/p>
&lt;ul>
&lt;li>
&lt;p>Something as &amp;ldquo;simple&amp;rdquo; as &lt;code>ls(1)&lt;/code> could be organized into these three layers: it has a complex UI due to the myriad flags it supports; it has a certain high-level logic to coordinate various disk operations such as &lt;code>readdir(3)&lt;/code> and &lt;code>stat(2)&lt;/code> calls and order the results based on whichever criteria the user requested; and it needs to access the disk via the libc operations already mentioned.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Something as complex as Git could also be organized into these three layers if it&amp;rsquo;s already not so: the View layer could implement the code to handle the many different commands that the CLI has; the Model layer could implement the core worktree, repository, and index structures and the primitives to manipulate them; and the Controller layer could implement the business logic to do things like commit a change or coordinate with a remote server to synchronize repository contents.&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>I am of the strong opinion that separating the View-specific code (command line handling) from the rest of the app is a good practice in general, and is critical to allow easier automated testing of the app&amp;rsquo;s logic. As for the separation of Controller and Model in a CLI app, well, it depends on the size of the codebase really.&lt;/p>
&lt;h1 id="tweaks">Tweaks&lt;/h1>
&lt;p>Now, in theory, given that MVC is a layered design, the View layer can only interact with the Controller layer, and the Controller layer can only interact with the Model layer. This sounds nice, but in practice, expressing these layers in code becomes tricky as soon as you introduce high-level data types to represent the in-memory state of the program. And I&amp;rsquo;m a fan of using high-level types to validate program correctness at compile time as much as possible.&lt;/p>
&lt;p>Consider this example: your service has a &lt;code>Person&lt;/code> structure. &lt;code>Person&lt;/code> instances are created in the Model layer based on a query to the database. The Controller layer calls into the model layer to obtain &lt;code>Person&lt;/code> instances, and returns those to the View layer. The View layer serializes those objects as JSON to return them as part of an API call. So, the question is: where is the &lt;code>Person&lt;/code> type defined? It needs to be defined under the Model layer because this is the lowest layer that needs the type&amp;hellip; but then&amp;hellip; the View layer must skip the Controller layer in order to reach for the &lt;code>Person&lt;/code> type definition. Conceptually that&amp;rsquo;s probably OK, but in code this means adding a build-time dependency between the View and Model layers&amp;mdash;a dependency that should not exist.&lt;/p>
&lt;p>This is why I have found it useful to extend this layered architecture with two extra &amp;ldquo;layers&amp;rdquo;: a Data model layer which provides dumb high-level data types to represent the data the application manages, and a Utilities layer that encapsulates code that&amp;rsquo;s not specific to the app and that could/should well live in a separate (possibly third-party) library. With these in mind, we end up with the following code structure:&lt;/p>
&lt;figure>
&lt;img src="/images/2023-06-20-mvc-layers.svg" class="with-border">
&lt;figcaption>Structure of the MVC layers with other layers.&lt;/figcaption>
&lt;/figure>
&lt;p>It&amp;rsquo;s critical to note that the objects in the Data model do &lt;em>not&lt;/em> encapsulate data access operations: &lt;em>they are not&lt;/em> &lt;a href="https://en.wikipedia.org/wiki/Data_access_object">DAOs&lt;/a> in the traditional sense of OOO programming. These types are pure in-memory representations of application data with no logic in them. Obtaining instances of these objects from storage and modifying their persisted representation must all happen via direct calls to database layer operations.&lt;/p>
&lt;p>Anyway. I do not like to get hung up with naming and trying to shoehorn designs into strict &amp;ldquo;patterns&amp;rdquo; when those do not apply. What I described isn&amp;rsquo;t really MVC if you are a purist, but it&amp;rsquo;s nice to see how old concepts from the 70s&amp;ndash;80s still make sense today with minor tweaks. What I will say, though, is that every time I&amp;rsquo;ve sensed this split made sense and cut corners anway because the split seemed to complicate things upfront&amp;hellip; I ended up suffering the consequences very quickly. In particular, development agility slows downs as it becomes hard to reason about changes, and unit testing soon becomes impossible.&lt;/p></description></item><item><title>In-house email subscriptions</title><link>https://jmmv.dev/2023/06/in-house-email-subscriptions.html</link><pubDate>Fri, 16 Jun 2023 06:30:00 -0700</pubDate><guid>https://jmmv.dev/2023/06/in-house-email-subscriptions.html</guid><description>&lt;p>In a move that&amp;rsquo;s &lt;a href="https://killedbygoogle.com/">typical of Google&lt;/a>, Feedburner received the &amp;ldquo;update&amp;rdquo; treatment two years ago: its support for RSS-to-email notifications was turned down. I had been relying on this service to offer email subscriptions for this blog for many years, but as the service vanished, I had to find a replacement.&lt;/p>
&lt;p>As I did not have a lot of time nor desire to assess alternatives, I took the bait from a salesperson from follow.it and I &lt;a href="/2021/07/feedburner-to-follow-it-migration.html">moved my subscribers to their free service&lt;/a>. And let me tell you that&amp;hellip; I have not been happy with it. If you have received any of their emails, you well know that they look like spam: my content appears as just one tiny text line among various sketchy links and large unrelated images. In fact, I have been ashamed of these emails.&lt;/p>
&lt;p>Was there an easy solution to this problem? Sure. I could have upgraded to the &amp;ldquo;Super-cool&amp;rdquo; follow.it plan in order to customize the look-and-feel of the emails&amp;hellip; but paying a subscription &lt;em>just for that one feature&lt;/em> seemed out of proportion: there are other features I want to offer in this blog that a static site cannot provide, and if I had to pay for one, I&amp;rsquo;d rather get others too.&lt;/p>
&lt;div class="container action-highlight p-4 my-4 d-md-none">
&lt;div class="row text-center">
&lt;p>A blog on operating systems, programming languages, testing, build systems, my own software
projects and even personal productivity. Specifics include FreeBSD, Linux, Rust, Bazel and
EndBASIC.&lt;/p>
&lt;/div>
&lt;div class="row">
&lt;div class="col">
&lt;div class="form-group">
&lt;form action="https://endtracker.azurewebsites.net/api/sites/e8da9f62-b7ac-4fe9-bf20-7c527199a376/subscribers/add" method="post">
&lt;input type="text" name="email"
placeholder="Enter your email"
class="form-control input-sm text-center my-1"/>
&lt;button type="submit" class="btn btn-primary btn-block my-1">Subscribe&lt;/button>
&lt;/form>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;div class="row px-2">
&lt;div class="col col-sm-5 text-left">
&lt;small>&lt;span class="subscriber-count">0&lt;/span> subscribers&lt;/small>
&lt;/div>
&lt;div class="col col-sm-7 text-right">
&lt;p>
&lt;a rel="me" href="https://mastodon.online/@jmmv">
&lt;img src="/images/badges/mastodon-logo.svg" width="32px" height="32px" alt="Follow @jmmv on Mastodon">
&lt;/a>
&lt;a href="https://twitter.com/intent/follow?original_referer=https%3A%2F%2Fjmmv.dev%2F&amp;amp;screen_name=jmmv">
&lt;img src="/images/badges/Twitter_logo_blue.svg" width="32px" height="32px" alt="Follow @jmmv on Twitter">
&lt;/a>
&lt;a href="/feed.xml">&lt;img src="/images/badges/feed-icon-28x28.png" alt="RSS feed">&lt;/a>
&lt;/p>
&lt;/div>
&lt;/div>
&lt;/div>
&lt;hr>
&lt;p>Over this same time period, you might recall that I have been working on a little service to support the dynamic aspects of this blog. In particular, this service has been taking care of &lt;a href="/2022/02/diy-web-analytics.html">privacy-respecting analytics&lt;/a>, post voting, and &lt;a href="/2022/02/comments-and-ids.html">comments&lt;/a>. Its name: EndTRACKER&amp;mdash;an awful name in retrospect because invasively tracking readers is the last thing I want to do, so the name has to change.&lt;/p>
&lt;p>Given that I already had a custom service supporting this blog, I thought the obvious: why not make it handle email subscriptions too? That would be the last feature I needed to have a dynamic-feeling blog without abandoning &lt;a href="/2018/02/from-jekyll-to-hugo.html">the static page builder I use&lt;/a>. And thus I got my hands dirty to make this work.&lt;/p>
&lt;p>The first thing I did was to add the subscription and unsubscription flows. This was ready pretty quickly because I could reuse code from the EndBASIC Service. Thus, at the beginning of May, I dropped follow.it altogether. As a little bonus of this migration, I was able to display the total number of subscribers next to the subscription box, and also add a subscription box to &lt;a href="https://endbasic.dev/">the EndBASIC web site&lt;/a> &amp;ldquo;for free&amp;rdquo;.&lt;/p>
&lt;p>But then what? After I made that (premature) move to a custom subscription process&amp;hellip; the next problem arose: how could I actually &lt;em>send&lt;/em> notifications to you all every time there is a new post?&lt;/p>
&lt;p>There are many trivial solutions to this problem, like manually copying the (small) list of subscribers into Outlook and composing an email, or creating a Google Groups read-only mailing list, or giving up altogether on self-hosting and moving to Substack. But&amp;hellip; none of these felt right. I wanted automation, so automation I built.&lt;/p>
&lt;hr>
&lt;p>Since then, I&amp;rsquo;ve been busy &lt;del>at work&lt;/del> in my very-limited free time coming up with the necessary automation to scrape the RSS feed of an arbitrary site and to reliably send email notifications for any new entries to that site&amp;rsquo;s subscribers.&lt;/p>
&lt;p>Does that sound like a trivial (and fun!) feature to build? Yes, yes it does. But making it work reliably and safely has been incredibly time-consuming. To give you a glimpse of what was involved:&lt;/p>
&lt;ul>
&lt;li>I started by creating a persistent task processing queue (because why not): a service that monitors a stored description of tasks and executes them in the context of a serverless runtime engine, with automatic retries if things go wrong.&lt;/li>
&lt;li>Then I bundled this new service into EndTRACKER to run periodic tasks and defined 1. a task to scrape RSS feeds, storing their processed contents into a database, and 2. another task that fans out and schedules finer-grained tasks for individual email notifications.&lt;/li>
&lt;li>Then I had to add safety measures to abort early if the notification logic decides to do the wrong thing (just in case).&lt;/li>
&lt;li>Then I had to add throttles to not exceed daily email submission limits.&lt;/li>
&lt;li>Then I had to write a small HTML processor to sanitize the content of the feed items before injecting them into emails.&lt;/li>
&lt;li>While, all along, writing a lot of test cases: 40% of the code supporting this feature are tests because I&amp;rsquo;m really concerned about the automation going rogue and spamming you all. And I still feel that test coverage is insufficient.&lt;/li>
&lt;/ul>
&lt;p>All of this so that you can be notified of this and future posts in the form of concise, spam-free emails. Yay?&lt;/p>
&lt;hr>
&lt;p>In the next post, I&amp;rsquo;ll take a deep dive into the teeny-tiny persistent task queue service I wrote, which I&amp;rsquo;ve open-sourced as part of &lt;a href="/software/iii-iv.html">III-IV&lt;/a>. This service is written in Rust, runs in the context of the Azure Functions serverless runtime, and is backed by PostgreSQL.&lt;/p>
&lt;p>Oh, and by the way: I&amp;rsquo;m planning on opening up EndTRACKER to fellow static site creators: if you have a static blog and have wanted to add select dynamic features to it, this may be the right choice for you! EndTRACKER is intended to be a collection of REST services you can pick and choose from, allowing you to integrate them into your site with whatever look-and-feel you like, all while providing a hosted admin interface. Take a look at the &lt;a href="https://endtracker.azurewebsites.net/">new WIP website&lt;/a>, which currently (only) includes a demo of the statistics features. Subscribe to updates to receive an early-adopter invite when it&amp;rsquo;s ready to launch!&lt;/p></description></item></channel></rss>