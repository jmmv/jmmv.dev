<!doctype html><html lang=en xmlns=http://www.w3.org/1999/xhtml xmlns:fb=http://ogp.me/ns/fb#><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta property="og:site_name" content="Julio Merino (jmmv.dev)"><meta property="twitter:site" content="@jmmv"><title>Bazel - Julio Merino (jmmv.dev)</title>
<meta property="og:title" content="Bazel - Julio Merino (jmmv.dev)"><meta property="twitter:title" content="Bazel - Julio Merino (jmmv.dev)"><meta name=description content><meta property="og:description" content><meta property="twitter:description" content><meta name=author content="Julio Merino"><meta property="twitter:creator" content="@jmmv"><meta name=generator content="Hugo 0.145.0"><meta property="og:url" content="https://jmmv.dev/tags/bazel/index.html"><meta property="og:type" content="blog"><meta property="twitter:card" content="summary"><link rel=canonical href=https://jmmv.dev/tags/bazel/index.html><link rel=alternate type=application/rss+xml title="Julio Merino (jmmv.dev)" href=/feed.xml><link rel=stylesheet href=/sass/main.min.cb91349cd93211a37e7d5dc131c35a170fc795721c03373cd05571327eea206b.css><link rel=stylesheet href=/css/chroma.css><link rel=icon type=image/png href=/images/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/images/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicons/favicon-96x96.png sizes=96x96><meta property="og:image" content="/images/favicons/favicon-1200x1200.png"><meta property="twitter:image" content="https://jmmv.dev/images/favicons/favicon-1200x1200.png"><script>const SITE_ID="e8da9f62-b7ac-4fe9-bf20-7c527199a376",BASE_URL="https://jmmv.dev/"</script></head><body><header class=site-header><nav class="navbar navbar-expand-md fixed-top navbar-dark bg-primary"><a class=navbar-brand href=/><img src=/images/favicons/favicon-30x30.png width=30 height=30 class="d-inline-block align-top" alt>
&nbsp;jmmv.dev
</a><button class=navbar-toggler type=button data-toggle=collapse data-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarSupportedContent><ul class="navbar-nav mr-auto"><li class=nav-item><a class=nav-link href=/about.html>About</a></li><li class=nav-item><a class=nav-link href=/blog.html>Blog</a></li><li class=nav-item><a class=nav-link href=/resume.html>Resume</a></li><li class=nav-item><a class=nav-link href=/software.html>Software</a></li></ul><ul class="navbar-nav mr-4"><li class=nav-item><a class=nav-link href=/archive.html>Archive</a></li><li class=nav-item><a class=nav-link href=/series.html>Series</a></li><li class=nav-item><a class=nav-link href=/tags.html>Tags</a></li></ul><form class=form-inline method=get role=search action=https://www.google.com/search><div class=input-group><input type=search name=query class=form-control placeholder=Search aria-label=Search><div class=input-group-append><button type=submit value=Search class="btn btn-light">
<img src=/octicons/search.svg></button></div></div><input type=hidden name=sitesearch value=https://jmmv.dev/></form></div></nav></header><div class=page-header><div class=container><h1>Posts: Bazel</h1><p>Showing 53 posts</p></div></div><div class=container><div class=row><div class=col-md-9><div class="media my-4"><img class=mr-3 src=/octicons/note.svg width=32px height=32px><div class=media-body><h2 class=mt-0><a href=/2025/09/you-are-holding-build-files-wrong.html>You are holding BUILD files wrong</a></h2><p><p>I&rsquo;ve heard it from people new to Bazel but also from people very familiar with the Bazel ecosystem: BUILD files must go away. And they must go away because they are redundant: they just repeat the dependency information that&rsquo;s already encoded in the in-code import/use statements.</p><p>Hearing this from newcomers to Bazel isn&rsquo;t surprising: after all, most newcomers are used to build tools that provide zero facilities to express dependencies across the sources of your own project. Hearing it from old-timers, however, is disappointing because it misses the point of what BUILD files can truly offer.</p></p><p class=text-muted>September 26, 2025
&#183;
Tags:
<a href=/tags/bazel>bazel</a>, <a href=/tags/blogsystem5>blogsystem5</a>, <a href=/tags/opinion>opinion</a><br><a class=text-reset href=/2025/09/you-are-holding-build-files-wrong.html>Continue reading (about
7 minutes)</a></p></div></div><div class="media my-4"><img class=mr-3 src=/octicons/note.svg width=32px height=32px><div class=media-body><h2 class=mt-0><a href=/2025/09/glibc-versions-bazel.html>Bazel and glibc versions</a></h2><p><p>Imagine this scenario: your team uses Bazel for fast, distributed C++ builds. A developer builds a change on their workstation, all tests pass, and the change is merged. The CI system picks it up, gets a cache hit from the developer&rsquo;s build, and produces a release artifact. Everything looks green. But when you deploy to production, the service crashes with a mysterious error: <code>version 'GLIBC_2.28' not found</code>. What went wrong?</p></p><p class=text-muted>September 19, 2025
&#183;
Tags:
<a href=/tags/bazel>bazel</a>, <a href=/tags/blogsystem5>blogsystem5</a>, <a href=/tags/unix>unix</a><br><a class=text-reset href=/2025/09/glibc-versions-bazel.html>Continue reading (about
11 minutes)</a></p></div></div><div class="media my-4"><img class=mr-3 src=/octicons/note.svg width=32px height=32px><div class=media-body><h2 class=mt-0><a href=/2025/09/bazel-remote-execution.html>Trusting builds with Bazel remote execution</a></h2><p><p>The previous article on <a href=/2025/09/bazel-remote-caching.html>Bazel remote caching</a> concluded that using <em>just</em> a remote cache for Bazel builds was suboptimal due to limitations in what can and cannot be cached for security reasons. The reason behind the restrictions was that it is impossible to safely reuse a cache across users. Or is it?</p><p>In this article, we&rsquo;ll see how leveraging remote execution in conjunction with a remote cache opens the door to safely sharing the cache across users. The reason is that remote execution provides a trusted execution environment for actions, and this opens the door to cross-user result sharing. Let&rsquo;s see why and how.</p></p><p class=text-muted>September 12, 2025
&#183;
Tags:
<a href=/tags/bazel>bazel</a>, <a href=/tags/blogsystem5>blogsystem5</a><br><a class=text-reset href=/2025/09/bazel-remote-execution.html>Continue reading (about
12 minutes)</a></p></div></div><div class="media my-4"><img class=mr-3 src=/octicons/note.svg width=32px height=32px><div class=media-body><h2 class=mt-0><a href=/2025/09/bazel-remote-caching.html>Understanding Bazel remote caching</a></h2><p><p>The previous article on <a href=/2025/07/bazel-action-determinism.html>Bazel action non-determinism</a> provided an introduction to actions: what they are, how they are defined, and how they act as the fundamental unit of execution in Bazel. What the article did not mention is that actions are <em>also</em> the fundamental unit of caching during execution to avoid doing already-done work.</p><p>In this second part of the series, I want to revisit the very basics of how Bazel runs actions and how remote caching (<em>not</em> remote execution, because that&rsquo;ll come later) works. The goal here is to introduce the <strong>Action Cache (AC)</strong>, the <strong>Content Addressable Storage (CAS)</strong>, how they play together, and then have some fun in describing the many ways in which it&rsquo;s possible to poison such a cache in an accidental or malicious manner.</p></p><p class=text-muted>September 5, 2025
&#183;
Tags:
<a href=/tags/bazel>bazel</a>, <a href=/tags/blogsystem5>blogsystem5</a><br><a class=text-reset href=/2025/09/bazel-remote-caching.html>Continue reading (about
12 minutes)</a></p></div></div><div class="media my-4"><img class=mr-3 src=/octicons/note.svg width=32px height=32px><div class=media-body><h2 class=mt-0><a href=/2025/07/bazel-action-determinism.html>Bazel and action (non-) determinism</a></h2><p><p>A key feature of Bazel is its ability to produce fast, reliable builds by caching the output of actions. This system, however, relies on a fundamental principle: build actions must be deterministic. For the most part, Bazel helps ensure that they are, but in the odd cases when they aren&rsquo;t, builds can fail in subtle and frustrating ways, eroding trust in the build system.</p><p>This article is the first in a series on Bazel&rsquo;s execution model. Having explained these concepts many times, I want to provide a detailed reference before explaining a cool solution to a problem I recently developed at work. We will start with action non-determinism, then cover remote caching and execution, and finally, explore the security implications of these features.</p><p>This first article explains what non-determinism is, how it manifests, and how you can diagnose and prevent it in your own builds. Let&rsquo;s begin.</p></p><p class=text-muted>July 21, 2025
&#183;
Tags:
<a href=/tags/bazel>bazel</a>, <a href=/tags/blogsystem5>blogsystem5</a><br><a class=text-reset href=/2025/07/bazel-action-determinism.html>Continue reading (about
15 minutes)</a></p></div></div><div class="media my-4"><img class=mr-3 src=/octicons/note.svg width=32px height=32px><div class=media-body><h2 class=mt-0><a href=/2025/06/whatever-happened-to-sandboxfs.html>Whatever happened to sandboxfs?</a></h2><p><p>Back in 2017&ndash;2020, while I was on the Blaze team at Google, I took on a 20% project that turned into a bit of an obsession: <a href=https://github.com/bazelbuild/sandboxfs>sandboxfs</a>. Born out of my work supporting iOS development, it was my attempt to solve a persistent pain point that frustrated both internal teams and external users alike: Bazel&rsquo;s <a href=https://github.com/bazelbuild/bazel/issues/8230>poor sandboxing performance on macOS</a>.</p><p>sandboxfs was a user-space file system designed to efficiently create virtual file hierarchies backed by real files&mdash;a faster alternative to the &ldquo;symlink forests&rdquo; that Bazel uses to prepare per-action sandboxes. The idea was simple: if we could lower sandbox creation overhead, we could make Bazel&rsquo;s sandboxing actually usable on macOS.</p><p>Unfortunately, things didn&rsquo;t play out as I dreamed. Today, sandboxfs is effectively abandoned, and macOS sandboxing performance remains an unsolved problem. In this post, I&rsquo;ll walk you through why I built sandboxfs, what worked, what didn&rsquo;t, and why&mdash;despite its failure&mdash;I still think the core idea holds promise.</p></p><p class=text-muted>June 11, 2025
&#183;
Tags:
<a href=/tags/bazel>bazel</a>, <a href=/tags/blogsystem5>blogsystem5</a>, <a href=/tags/sandboxfs>sandboxfs</a><br><a class=text-reset href=/2025/06/whatever-happened-to-sandboxfs.html>Continue reading (about
10 minutes)</a></p></div></div><div class="media my-4"><img class=mr-3 src=/octicons/note.svg width=32px height=32px><div class=media-body><h2 class=mt-0><a href=/2025/03/bazel-next-generation.html>The next generation of Bazel builds</a></h2><p><p>Today marks the 10th anniversary of <a href=https://blog.engflow.com/2024/10/01/birth-of-the-bazel/>Bazel&rsquo;s public announcement</a> so this is the perfect moment to reflect on what the next generation of build systems in the Bazel ecosystem may look like.</p><p>I write this with the inspiration that comes from attending <a href=https://www.linkedin.com/feed/update/urn:li:activity:7295871444343734272/>the first ever conference on Buildbarn</a>, one of the many remote execution systems for Bazel. In the conference, Ed Schouten, the creator of <a href=https://github.com/buildbarn>Buildbarn</a>, presented Bonanza: a skunkworks reimagination of Bazel for truly large builds.</p></p><p class=text-muted>March 24, 2025
&#183;
Tags:
<a href=/tags/bazel>bazel</a>, <a href=/tags/blogsystem5>blogsystem5</a><br><a class=text-reset href=/2025/03/bazel-next-generation.html>Continue reading (about
12 minutes)</a></p></div></div><div class="media my-4"><img class=mr-3 src=/octicons/note.svg width=32px height=32px><div class=media-body><h2 class=mt-0><a href=/2025/03/bazel-at-snowflake-two-years-in.html>Bazel at Snowflake two years in</a></h2><p><p>Two and a half years ago, I <a href=/2022/10/bye-microsoft-hi-snowflake.html>joined Snowflake</a> to help their mission of migrating to Bazel. I spent the first year of this period as an Individual Contributor (IC) diving deep into the migration tasks, and then I took over the Tech Lead (TL) role of the team to see the project through completion.</p><p>This week, we publicly announced that we completed our migration to Bazel for the largest part of our codebase and we provided details on our journey. I did not publish that article here for obvious reasons, so&mldr; today&rsquo;s entry is going to be a light one: all I want to do is point you at our announcement as well as the various <em>other</em> related articles that came before it.</p></p><p class=text-muted>March 14, 2025
&#183;
Tags:
<a href=/tags/bazel>bazel</a>, <a href=/tags/blogsystem5>blogsystem5</a>, <a href=/tags/snowflake>snowflake</a><br><a class=text-reset href=/2025/03/bazel-at-snowflake-two-years-in.html>Continue reading (about
4 minutes)</a></p></div></div><div class="media my-4"><img class=mr-3 src=/octicons/note.svg width=32px height=32px><div class=media-body><h2 class=mt-0><a href=/2024/10/bazelcon-2024-recap.html>BazelCon 2024 recap</a></h2><p>Just like that, BazelCon 2024 came and went. So&mldr; it&rsquo;s obviously time to summarize the two events of last week: BazelCon 2024 and the adjacent Build Meetup. There is A LOT to cover, but everything is here in just one article!</p><p class=text-muted>October 22, 2024
&#183;
Tags:
<a href=/tags/bazel>bazel</a>, <a href=/tags/blogsystem5>blogsystem5</a>, <a href=/tags/snowflake>snowflake</a><br><a class=text-reset href=/2024/10/bazelcon-2024-recap.html>Continue reading (about
42 minutes)</a></p></div></div><div class="media my-4"><img class=mr-3 src=/octicons/note.svg width=32px height=32px><div class=media-body><h2 class=mt-0><a href=/2023/12/bazel-interview-at-software-engineering.html>Bazel interview at Software Engineering Daily</a></h2><p><p>Just a bit over 2 months ago, on October 5th, 2023, Jordi Mon Companys interviewed me about Bazel for an episode in the <a href=https://softwareengineeringdaily.com/>Software Engineering Daily</a> podcast. The episode finally came out on December 18th, 2023, so here is your announcement to stop by and listen to it!</p><figure><a href=https://softwareengineeringdaily.com/2023/12/18/bonus-episode-bazel-with-julio-merino/ target=_blank><img src=/images/2023-12-21-bazel-interview-cover.jpg class=with-border></a><figcaption><a href=https://softwareengineeringdaily.com/2023/12/18/bonus-episode-bazel-with-julio-merino/ target=_blank>Cover image (and link) to the Bazel interview in Software Engineering Daily.</a></figcaption></figure><p>If you don&rsquo;t have time to listen to the whole 45 minutes, or if you want to get a sense of what you will get out of it, here is a recap of everything we touched on. Every paragraph is annotated with the rough time where the discussion starts so that you can jump right in to whatever interests you the most.</p></p><p class=text-muted>December 21, 2023
&#183;
Tags:
<a href=/tags/bazel>bazel</a>, <a href=/tags/blogsystem5>blogsystem5</a><br><a class=text-reset href=/2023/12/bazel-interview-at-software-engineering.html>Continue reading (about
5 minutes)</a></p></div></div><div class="media my-4"><img class=mr-3 src=/octicons/note.svg width=32px height=32px><div class=media-body><h2 class=mt-0><a href=/2023/12/strings-encodings-nuls-and-bazel.html>Strings, encodings, NULs and Bazel</a></h2><p><p>Just yesterday, <a href=https://twitter.com/vkrajacic/status/1730891609191981305>Twitter user @vkrajacic wrote</a>:</p><blockquote><p>Advice for new C programmers: &ldquo;Avoid null-terminated strings; they&rsquo;re outdated, inefficient and impractical.&rdquo;</p><p>Create your own type with basic functions. It&rsquo;s not that hard, and it goes a long way. One of the benefits of this approach, among others, is slicing without copying.</p></blockquote><p>This suggestion has its merits and I understand where it is coming from: <em>performance</em>. You see: the traditional way to represent strings in C is to use <a href=https://en.wikipedia.org/wiki/Null_character>NUL-terminated byte arrays</a>. Yet&mldr; this has deemed to be <a href="https://queue.acm.org/detail.cfm?id=2010365">the most expensive one-byte mistake</a> because of the adverse performance implications that this carries. (NUL, <em>not</em> NULL, is the better name for the <code>\0</code> byte by the way.)</p></p><p class=text-muted>December 3, 2023
&#183;
Tags:
<a href=/tags/bazel>bazel</a>, <a href=/tags/blogsystem5>blogsystem5</a>, <a href=/tags/java>java</a><br><a class=text-reset href=/2023/12/strings-encodings-nuls-and-bazel.html>Continue reading (about
4 minutes)</a></p></div></div><div class="media my-4"><img class=mr-3 src=/octicons/note.svg width=32px height=32px><div class=media-body><h2 class=mt-0><a href=/2023/11/end-to-end-tool-testing-with-bazel.html>End-to-end tool testing with Bazel and shtk</a></h2><p><p>If you use Bazel, your project is of moderate size. And because your project is of moderate size, it almost-certainly builds one or more binaries, at least one of which is a CLI tool. But let&rsquo;s face it: you don&rsquo;t have end-to-end testing for those tools, do you?</p><p>I&rsquo;m <em>sure</em> you have split the binary&rsquo;s <code>main</code> function into its own file so that the rest of the tool can be put in a library, and I&rsquo;m <em>extra-sure</em> that you have unit tests for such library. But&mldr; those tests do little to verify the functionality and quality of the tool <em>as experienced by the end user</em>. Consider: What exactly does the tool print to the console on success? Does it show errors nicely when they happen, or does it dump internal stack traces? How does it handle unknown flags or bad arguments? Is the built-in help message nicely rendered when your terminal is really wide? What if the terminal is narrow?</p><p>You must write end-to-end tests for your tools but, usually, that isn’t easy to do. Until today. Combining shtk with Bazel via the new <code>rules_shtk</code> ruleset makes it trivial to write tests that verify the behavior of your CLI tools&mdash;no matter what language they are written in&mdash;and in this article I’m going to show you how.</p></p><p class=text-muted>November 4, 2023
&#183;
Tags:
<a href=/tags/bazel>bazel</a>, <a href=/tags/blogsystem5>blogsystem5</a>, <a href=/tags/shell>shell</a>, <a href=/tags/shtk>shtk</a>, <a href=/tags/testing>testing</a><br><a class=text-reset href=/2023/11/end-to-end-tool-testing-with-bazel.html>Continue reading (about
7 minutes)</a></p></div></div><div class="media my-4"><img class=mr-3 src=/octicons/note.svg width=32px height=32px><div class=media-body><h2 class=mt-0><a href=/2023/10/bazelcon-2023-et-al-trip-report.html>BazelCon 2023 et al. trip report</a></h2><p><p>I&rsquo;m exhausted. I just came back to Seattle from a 10-day trip in which I attended three different Bazel events: the Build Meetup in Reykjavik, the Bazel Community Day in Munich, and BazelCon 2023 in Munich too. Oh, and because I was on the other side of the world, I also paid a visit to my family in Spain.</p><p>Attending these events has been incredibly useful and productive: I got exposure to many ideas and discussions that would just not happen online, I got to build connections with very interesting people and, of course, it has also been super fun too to reconnect with old coworkers and friends.</p><p>This article contains the summary of the things I learned and the things I want to follow up on. These are just a bunch of cleaned-up notes which I took and are in the context of <em>my</em> work with <a href=https://bazel.build/>Bazel</a> at <a href=https://www.snowflake.com/>Snowflake</a> and <em>my</em> interests on build tools, so this is not endorsed by Snowflake.</p></p><p class=text-muted>October 30, 2023
&#183;
Tags:
<a href=/tags/bazel>bazel</a>, <a href=/tags/blogsystem5>blogsystem5</a>, <a href=/tags/snowflake>snowflake</a><br><a class=text-reset href=/2023/10/bazelcon-2023-et-al-trip-report.html>Continue reading (about
15 minutes)</a></p></div></div><div class="media my-4"><img class=mr-3 src=/octicons/note.svg width=32px height=32px><div class=media-body><h2 class=mt-0><a href=/2023/10/build-farm-visualizations.html>Build farm visualizations</a></h2><p><p>If you have followed our <a href=https://medium.com/snowflake/tagged/infrastructure>recent infrastructure posts</a>, you know by now that we are actively migrating Snowflake&rsquo;s build to Bazel. What we haven&rsquo;t shared yet is that we have deployed our own <a href=https://github.com/buildbarn>Build Barn</a> cluster to support Bazel&rsquo;s remote execution features. We have chosen to run our own build farm service for resource governance and security purposes, but also because the behavior of this system impacts the developer experience so directly that we want to have full in-house control and knowledge of it.</p></p><p class=text-muted>October 20, 2023
&#183;
Tags:
<a href=/tags/bazel>bazel</a>, <a href=/tags/snowflake>snowflake</a><br><a class=text-reset href=/2023/10/build-farm-visualizations.html>Continue reading (about
10 minutes)</a></p></div></div><div class="media my-4"><img class=mr-3 src=/octicons/note.svg width=32px height=32px><div class=media-body><h2 class=mt-0><a href=/2023/10/analyzing-ooms-in-intellij-with-bazel.html>Analyzing OOMs in IntelliJ with Bazel</a></h2><p><p>A few months ago, we described how we fixed <a href=/2023/03/addressing-bazel-ooms.html>three different OOM scenarios</a> in our ongoing migration to the Bazel build system here at Snowflake. Things had been sailing along just fine since then&mldr; but a new issue showed up recently: our <a href=https://ij.bazel.build/>IntelliJ with Bazel (IjwB)</a> Java project started showing OOMs during its sync phase.</p><p>The reason this issue surfaced now is because, as we continue our migration to Bazel, our IjwB project has grown in size. Months ago, our project only covered a Java binary, but now that we have migrated all of its unit and integration tests as well, the project covers them too. It is common for tests to be more expensive to build and run than the binary they validate&mdash;tests depend on the binary&rsquo;s dependencies <em>plus</em> many other helper tools for testing&mdash;and these caused the project to grow too big to fit in our development environments. Or did they?</p></p><p class=text-muted>October 7, 2023
&#183;
Tags:
<a href=/tags/bazel>bazel</a>, <a href=/tags/snowflake>snowflake</a><br><a class=text-reset href=/2023/10/analyzing-ooms-in-intellij-with-bazel.html>Continue reading (about
9 minutes)</a></p></div></div><div class="media my-4"><img class=mr-3 src=/octicons/note.svg width=32px height=32px><div class=media-body><h2 class=mt-0><a href=/2023/03/addressing-bazel-ooms.html>Addressing Bazel OOMs</a></h2><p><p>Here at Snowflake, the Developer Productivity organization (DPE for short) is tackling some important problems we face as a company: namely, lengthening build times and complex development environments. A key strategy we are pursuing to resolve these is the migration of key build processes from CMake and Maven to <a href=https://bazel.build/>Bazel</a>.</p><p>We are still in the early stages of this migration and cannot yet share many details or a success story, but we can start explaining some of the issues we encounter as we work through this ambitious project.</p></p><p class=text-muted>March 16, 2023
&#183;
Tags:
<a href=/tags/bazel>bazel</a>, <a href=/tags/snowflake>snowflake</a><br><a class=text-reset href=/2023/03/addressing-bazel-ooms.html>Continue reading (about
16 minutes)</a></p></div></div><div class="media my-4"><img class=mr-3 src=/octicons/note.svg width=32px height=32px><div class=media-body><h2 class=mt-0><a href=/2021/03/build-time-slis-slos.html>Defining build time SLIs and SLOs</a></h2><p>Companies grow, and with them do the software projects that support them. It should be no surprise that larger programs require longer build times. And, if I had to guess, you have seen how those build times eventually grow to unbearable levels, reducing productivity and degrading quality. In this post, I examine how we can leverage the common techniques we use for production services&mdash;namely SLIs and SLOs&mdash;to keep build times on track.</p><p class=text-muted>March 12, 2021
&#183;
Tags:
<a href=/tags/bazel>bazel</a>, <a href=/tags/development>development</a>, <a href=/tags/monorepo>monorepo</a><br><a class=text-reset href=/2021/03/build-time-slis-slos.html>Continue reading (about
16 minutes)</a></p></div></div><div class="media my-4"><img class=mr-3 src=/octicons/star.svg width=32px height=32px><div class=media-body><h2 class=mt-0><a href=/2021/02/google-monorepos-and-caching.html>How does Google keep build times low?</a></h2><p>Monorepos are an interesting beast. If mended properly, they enable a level of uniformity and code quality that is hard to achieve otherwise. If left unattended, however, they become unmanageable monsters of tangled dependencies, slow builds, and frustrating developer experiences. Whether you have a good or bad experience directly depends on the level of engineering support behind the monorepo. Simply put, monorepos require dedicated teams and tools to run nicely. In this post, I will look at how almost-perfect caching plays a key role in keeping build times manageable under such an environment.</p><p class=text-muted>February 26, 2021
&#183;
Tags:
<a href=/tags/bazel>bazel</a>, <a href=/tags/featured>featured</a>, <a href=/tags/monorepo>monorepo</a>, <a href=/tags/opinion>opinion</a><br><a class=text-reset href=/2021/02/google-monorepos-and-caching.html>Continue reading (about
11 minutes)</a></p></div></div><div class="media my-4"><img class=mr-3 src=/octicons/star.svg width=32px height=32px><div class=media-body><h2 class=mt-0><a href=/2020/12/google-no-clean-builds.html>How does Google avoid clean builds?</a></h2><p>During my 11 years at Google, I can confidently count the number of times I had to do a &ldquo;clean build&rdquo; with one hand: their build system is so robust that incremental builds always work. Phrases like &ldquo;clean everything and try building from scratch&rdquo; are unheard of. So&mldr; you can color me skeptical when someone says that incremental build problems are due to bugs in the build files and not due to a suboptimal build system. The answer lies in having a robust build system, and in this post I&rsquo;ll examine the common causes behind incremental build breakages, what the build system can do to avoid them, and how Bazel accomplishes most of them.</p><p class=text-muted>December 31, 2020
&#183;
Tags:
<a href=/tags/bazel>bazel</a>, <a href=/tags/featured>featured</a>, <a href=/tags/google>google</a>, <a href=/tags/monorepo>monorepo</a>, <a href=/tags/opinion>opinion</a><br><a class=text-reset href=/2020/12/google-no-clean-builds.html>Continue reading (about
20 minutes)</a></p></div></div><div class="media my-4"><img class=mr-3 src=/octicons/note.svg width=32px height=32px><div class=media-body><h2 class=mt-0><a href=/2020/10/bazel-jni.html>The final boss: Bazel's own JNI code</a></h2><p><p>As you might have <a href=https://twitter.com/jmmv/status/1313196763524689920>read elsewhere</a>, I&rsquo;m leaving the Bazel team and Google in about a week. My plan for these last few weeks was to hand things off as cleanly as possible&mldr; but I was also nerd-sniped by a bug that came my way a fortnight ago. Fixing it has been my self-inflicted punishment for leaving, and oh my, it has been painful. Very painful.</p><p>Let me tell you the story of this final boss.</p></p><p class=text-muted>October 9, 2020
&#183;
Tags:
<a href=/tags/bazel>bazel</a>, <a href=/tags/bug>bug</a><br><a class=text-reset href=/2020/10/bazel-jni.html>Continue reading (about
13 minutes)</a></p></div></div><div class="media my-4"><img class=mr-3 src=/octicons/note.svg width=32px height=32px><div class=media-body><h2 class=mt-0><a href=/2020/09/bazel-test-streaming-bug.html>Bazel output streaming, Ctrl+C, and test flakiness</a></h2><p><p>About two weeks ago, I found a very interesting bug in Bazel&rsquo;s test output streaming functionality while writing tests for a new feature related to Ctrl+C interrupts. I fixed the bug, wrote a test for it, and&mldr; the test itself came back as flaky, which made me find another very subtle bug in the test that needed a one-line fix. This is the story of both.</p><hr><p>Bazel has a feature known as <strong>test output streaming</strong>: by default, Bazel captures the outputs (stdout and stderr) of the tests it runs, saves those in local log files, and tells the user where they are when a test fails. This is not very ergonomic when you are iterating on a test, so you can make Bazel print the output of the test as it runs by passing <code>--test_output=streamed</code> to the invocation.</p></p><p class=text-muted>September 18, 2020
&#183;
Tags:
<a href=/tags/bazel>bazel</a>, <a href=/tags/bug>bug</a><br><a class=text-reset href=/2020/09/bazel-test-streaming-bug.html>Continue reading (about
9 minutes)</a></p></div></div><div class="media my-4"><img class=mr-3 src=/octicons/note.svg width=32px height=32px><div class=media-body><h2 class=mt-0><a href=/2020/09/bazel-ui-locking.html>Bazel UI locking and file downloads</a></h2><p><p>About a month ago, I was benchmarking the impact of a new Bazel feature and I noticed that a test build that should have taken only a few seconds took almost 10 minutes. My Internet connection was flaking out indeed, but something else didn&rsquo;t seem right. So I looked and found that Bazel was doing network calls within a critical section, and these were the root cause behind the massive slowdown. But how did we get such an obvious no-no into the codebase? Read on to see how this happened and how gnarly it was to fix!</p></p><p class=text-muted>September 1, 2020
&#183;
Tags:
<a href=/tags/bazel>bazel</a>, <a href=/tags/bug>bug</a><br><a class=text-reset href=/2020/09/bazel-ui-locking.html>Continue reading (about
12 minutes)</a></p></div></div><div class="media my-4"><img class=mr-3 src=/octicons/note.svg width=32px height=32px><div class=media-body><h2 class=mt-0><a href=/2020/06/shipping-bazel-new-dynamic-scheduler.html>Shipping Bazel's new dynamic scheduler</a></h2><p><p>Back in September 2019, I embarked into the task of rewriting <a href=/2019/12/bazel-dynamic-execution-introduction.html>Bazel&rsquo;s dynamic scheduler</a> to deal with slow and flaky networks. Initial testing had shown that dynamic builds might become slower, and it was all due to this feature having been designed for a different use case (in-office, high-speed network). We had to fix two different issues in the scheduler.</p><p>The first fix was making the downloads of the remote artifacts happen without holding the output lock. In this way, a local action would be allowed to execute while the remote action was still fetching outputs (possibly never terminating if the connection was flaky). This took several attempts to get to a stable fix, but I could eventually ship this by November which in turn unblocked us to roll out the real feature we wanted to deliver to our iOS user base.</p></p><p class=text-muted>June 12, 2020
&#183;
Tags:
<a href=/tags/bazel>bazel</a><br><a class=text-reset href=/2020/06/shipping-bazel-new-dynamic-scheduler.html>Continue reading (about
10 minutes)</a></p></div></div><div class="media my-4"><img class=mr-3 src=/octicons/note.svg width=32px height=32px><div class=media-body><h2 class=mt-0><a href=/2020/05/codesign-and-ssh.html>Running codesign over SSH with a new key</a></h2><p><p>I just spent sometime between 30 minutes and 1 hour convincing the Mac Pro that sits in my office to successfully <code>codesign</code> an iOS app via Bazel. This was after having to update the signing key to a newer one and after rebooting the machine due to the macOS 10.15.5 upgrade—all remotely thanks to COVID-19.</p><p>The build of the app was failing with an <code>errSecInternalComponent</code> error printed by <code>codesign</code>. It is not the first time I face this, but in all previous cases, I had either been at the computer to click through security popups, had had functional Chrome Remote Desktop access, or did not have to install a new signing key remotely.</p></p><p class=text-muted>May 29, 2020
&#183;
Tags:
<a href=/tags/bazel>bazel</a>, <a href=/tags/macos>macos</a><br><a class=text-reset href=/2020/05/codesign-and-ssh.html>Continue reading (about
3 minutes)</a></p></div></div><div class="media my-4"><img class=mr-3 src=/octicons/star.svg width=32px height=32px><div class=media-body><h2 class=mt-0><a href=/2020/01/system-rewrites-and-tuning.html>Ensuring system rewrites are truly necessary</a></h2><p>You probably know that software rewrites, while very tempting, are expensive and can be the mistake that kills a project or a company. Yet they are routinely proposed as the solution to all problems. Is there anything you can do to minimize the risk? In this post, I propose that you actively improve the old system to ensure the new system cannot make progress in a haphazard way. This forces the new system to be designed in such a way that delivers breakthrough improvements and not just incremental improvements.</p><p class=text-muted>January 24, 2020
&#183;
Tags:
<a href=/tags/bazel>bazel</a>, <a href=/tags/essay>essay</a>, <a href=/tags/featured>featured</a>, <a href=/tags/sre>sre</a><br><a class=text-reset href=/2020/01/system-rewrites-and-tuning.html>Continue reading (about
7 minutes)</a></p></div></div><div class="media my-4"><img class=mr-3 src=/octicons/note.svg width=32px height=32px><div class=media-body><h2 class=mt-0><a href=/2020/01/osxfuse-hardlinks-dladdr.html>The OSXFUSE, hard links, and dladdr puzzle</a></h2><p><p>Hello everyone and welcome to this new decade!</p><p>It&rsquo;s already 2020 and I&rsquo;m only 17 days late in writing a first post. I was planning to start with an opinion article, but as its draft is taking longer than I wanted&mldr; I&rsquo;ll present you the story of a recent crazy bug that has <a href=https://twitter.com/jmmv/status/1217276457648521216>kept me busy</a> for the last couple of days.</p><h1 id=java-crashes-with-bazel-and-sandboxfs>Java crashes with Bazel and sandboxfs</h1><p>On a machine running macOS Catalina, install <a href=https://github.com/bazelbuild/sandboxfs>sandboxfs</a> and build Bazel with sandboxfs enabled, like this:</p></p><p class=text-muted>January 17, 2020
&#183;
Tags:
<a href=/tags/bazel>bazel</a>, <a href=/tags/fuse>fuse</a>, <a href=/tags/internals>internals</a>, <a href=/tags/programming>programming</a>, <a href=/tags/sandboxfs>sandboxfs</a><br><a class=text-reset href=/2020/01/osxfuse-hardlinks-dladdr.html>Continue reading (about
13 minutes)</a></p></div></div><div class="media my-4"><img class=mr-3 src=/octicons/note.svg width=32px height=32px><div class=media-body><h2 class=mt-0><a href=/2019/12/bazel-dynamic-execution-tree-artifacts.html>Tree artifacts and transient files</a></h2><p><p>To conclude the deep dive into Bazel&rsquo;s dynamic spawn strategy, let&rsquo;s look at the nightmare that tree artifacts have been with the <a href=/2019/12/bazel-dynamic-execution-local-lockfree.html>local lock-free feature</a>. And, yes, I&rsquo;m double-posting today because I really want to finish these series before the end of the decade<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>!</p><hr><p><strong>Tree artifacts</strong> are a fancy name for action outputs that are directories, not files. What&rsquo;s special about them is that Bazel does not know <em>a priori</em> what the directory <em>contents</em> are: the rule behind the action just specifies that there will be a directory with files, and Bazel has to treat that as the unit of output from the action. Other than that, tree artifacts are &ldquo;just&rdquo; a different kind of output<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>.</p></p><p class=text-muted>December 31, 2019
&#183;
Tags:
<a href=/tags/bazel>bazel</a><br><a class=text-reset href=/2019/12/bazel-dynamic-execution-tree-artifacts.html>Continue reading (about
4 minutes)</a></p></div></div><div class="media my-4"><img class=mr-3 src=/octicons/note.svg width=32px height=32px><div class=media-body><h2 class=mt-0><a href=/2019/12/bazel-dynamic-execution-local-lockfree.html>Lifting the local lock for dynamic execution</a></h2><p><p>In the <a href=/2019/12/bazel-dynamic-execution-download-times.html>previous post</a>, we saw how accounting for artifact download times makes the dynamic strategy live to its promise of delivering the best of local and remote build times.</p><p>Or does it? If you think about it closely, that change made it so that builds that were purely local couldn&rsquo;t be made worse by enabling the dynamic scheduler: the dynamic strategy would always favor the local branch of a spawn if the remote one took a long time. But for builds that were better off when they were fully remote (think of a fully-cached build with great networking), this is not true: the dynamic strategy might hurt them because because we may discard some of those remote cache hits.</p></p><p class=text-muted>December 31, 2019
&#183;
Tags:
<a href=/tags/bazel>bazel</a><br><a class=text-reset href=/2019/12/bazel-dynamic-execution-local-lockfree.html>Continue reading (about
4 minutes)</a></p></div></div><div class="media my-4"><img class=mr-3 src=/octicons/note.svg width=32px height=32px><div class=media-body><h2 class=mt-0><a href=/2019/12/bazel-dynamic-execution-download-times.html>Artifact downloads and dynamic execution</a></h2><p><p>In the <a href=/2019/12/bazel-dynamic-execution-output-locking.html>previous post</a> of this series, we looked at how the now-legacy implementation of the dynamic strategy uses a per-spawn lock to guard accesses to the output tree. This lock is problematic for a variety of reasons and we are going to peek into one of those here.</p><p>To recap, the remote strategy does the following:</p><ol><li>Send spawn execution RPC to the remote service.</li><li>Wait for successful execution (which can come quickly from a cache hit).</li><li><strong>Lock the output tree</strong> (only when run within the dynamic strategy).</li><li>Download the spawn&rsquo;s outputs directly into the output tree.</li></ol><p>Note how we lock the output tree <em>before</em> we have downloaded any outputs, and taking the lock means that the local branch of the same spawn cannot start or complete <em>even if there are plenty of local resources available to run it</em>.</p></p><p class=text-muted>December 30, 2019
&#183;
Tags:
<a href=/tags/bazel>bazel</a><br><a class=text-reset href=/2019/12/bazel-dynamic-execution-download-times.html>Continue reading (about
5 minutes)</a></p></div></div><div class="media my-4"><img class=mr-3 src=/octicons/note.svg width=32px height=32px><div class=media-body><h2 class=mt-0><a href=/2019/12/bazel-dynamic-execution-output-locking.html>Output conflicts and dynamic execution</a></h2><p><p>When the dynamic scheduler is active, Bazel runs the same <em>spawn</em> (aka command line) remotely and locally at the same time via <a href=/2019/12/bazel-dynamic-execution-strategy.html>two separate strategies</a>. These two strategies want to write to the same output files (e.g. object files, archives, or final binaries) on the local disk. In computing, two things trying to affect the same thing require some kind of coördination.</p><p>You might think, however, that because we assume that both strategies are equivalent and will write the same contents to disk<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>, this is not problematic. But, in fact, it <em>can</em> be, because file creations/writes are not atomic. So we need some form of mutual exclusion in place to avoid races.</p></p><p class=text-muted>December 27, 2019
&#183;
Tags:
<a href=/tags/bazel>bazel</a>, <a href=/tags/sandboxfs>sandboxfs</a><br><a class=text-reset href=/2019/12/bazel-dynamic-execution-output-locking.html>Continue reading (about
4 minutes)</a></p></div></div><div class="media my-4"><img class=mr-3 src=/octicons/note.svg width=32px height=32px><div class=media-body><h2 class=mt-0><a href=/2019/12/bazel-dynamic-execution-strategy.html>Bazel's dynamic strategy</a></h2><p><p>After <a href=/2019/12/bazel-dynamic-execution-introduction.html>introducing Bazel&rsquo;s dynamic execution</a> a couple of posts ago, it&rsquo;s time to dive into its actual implementation details as promised. But pardon for the interruption in the last post, as I had to take a little detour to cover a necessary topic (<a href=/2019/12/bazel-local-resources.html>local resources</a>) for today&rsquo;s article.</p><p>Simply put, dynamic execution is implemented as &ldquo;just&rdquo; one more <a href=/2019/12/bazel-strategies.html>strategy</a> called <code>dynamic</code>. The dynamic strategy, however, is different from all others because it does <em>not</em> have a corresponding spawn runner. Instead, the <code>dynamic</code> strategy <em>wraps</em> two different strategies: one for local execution and one for remote execution.</p></p><p class=text-muted>December 26, 2019
&#183;
Tags:
<a href=/tags/bazel>bazel</a><br><a class=text-reset href=/2019/12/bazel-dynamic-execution-strategy.html>Continue reading (about
3 minutes)</a></p></div></div><div class="media my-4"><img class=mr-3 src=/octicons/note.svg width=32px height=32px><div class=media-body><h2 class=mt-0><a href=/2019/12/bazel-local-resources.html>How does Bazel track local resource usage?</a></h2><p><p>How does Bazel avoid melting your workstation with concurrent subprocesses? Or&mldr; tries to, because I know it still does that sometimes? There are two mechanisms as play: the jobs number and the local resources tracker. Let&rsquo;s dive into them.</p><p>The <strong>jobs number</strong>, given by the <code>--jobs</code> flag, configures the number of concurrent Skyframe evaluators during the execution phase<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>. What a mouthful. What this essentially means is that <code>jobs</code> indicates the number of threads used to walk the graph looking for actions to execute&mdash;and also executing them. So if we have <code>N</code> threads, each of which processes one node of the graph at a time, and we know that the most nodes trigger process executions, we have at most <code>N</code> concurrent spawns.</p></p><p class=text-muted>December 23, 2019
&#183;
Tags:
<a href=/tags/bazel>bazel</a><br><a class=text-reset href=/2019/12/bazel-local-resources.html>Continue reading (about
5 minutes)</a></p></div></div><div class="media my-4"><img class=mr-3 src=/octicons/note.svg width=32px height=32px><div class=media-body><h2 class=mt-0><a href=/2019/12/bazel-dynamic-execution-introduction.html>Introduction to Bazel's dynamic execution</a></h2><p><p>Bazel&rsquo;s <strong>dynamic execution</strong> is a feature that makes your builds faster by using remote <em>and</em> local resources, transparently and at the same time. We launched this feature in Bazel 0.21 back in February 2019 along an <a href=https://blog.bazel.build/2019/02/01/dynamic-spawn-scheduler.html>introductory blog post</a> and have been hard at work since then to improve it.</p><p>The reason dynamic execution makes builds faster is two-fold:</p><ul><li>first, because we can hide hiccups in the connectivity to the remote build service; and,</li><li>second, because we can take advantage of things like <a href=https://blog.bazel.build/2015/12/10/java-workers.html>persistent workers</a>, which are designed to offer super-fast edit/build/test cycles.</li></ul><p>Put in numbers, here is what dynamic execution looks like for a relatively large iOS build I measured at Google a few months ago:</p></p><p class=text-muted>December 20, 2019
&#183;
Tags:
<a href=/tags/bazel>bazel</a><br><a class=text-reset href=/2019/12/bazel-dynamic-execution-introduction.html>Continue reading (about
3 minutes)</a></p></div></div><div class="media my-4"><img class=mr-3 src=/octicons/note.svg width=32px height=32px><div class=media-body><h2 class=mt-0><a href=/2019/12/bazel-strategies.html>What are Bazel's strategies?</a></h2><p><p>&ldquo;Strategies? Will you talk about Bazel&rsquo;s strategy for world domination 🙀?&rdquo; No&mldr; not exactly that.</p><p>Dynamic execution has been quite a hot topic in my work over the last few months and I am getting ready to publish a series of posts on it soon. But before I do that, I need to first review Bazel&rsquo;s execution strategies because they play a big role in understanding what dynamic execution <em>is</em> and how it&rsquo;s <em>implemented</em>.</p></p><p class=text-muted>December 14, 2019
&#183;
Tags:
<a href=/tags/bazel>bazel</a>, <a href=/tags/sandboxfs>sandboxfs</a><br><a class=text-reset href=/2019/12/bazel-strategies.html>Continue reading (about
6 minutes)</a></p></div></div><div class="media my-4"><img class=mr-3 src=/octicons/note.svg width=32px height=32px><div class=media-body><h2 class=mt-0><a href=/2019/11/wait-for-process-group-darwin.html>Waiting for process groups, macOS edition</a></h2><p><p>In the previous posts, we saw why <a href=/2019/11/wait-for-process-group.html>waiting for a process group is complicated</a> and we covered a specific, bullet-proof mechanism to <a href=/2019/11/wait-for-process-group-linux.html>accomplish this on Linux</a>. Now is the time to investigate this same topic on macOS. Remember that the problem we are trying to solve (<a href=https://github.com/bazelbuild/bazel/issues/10245>#10245</a>) is the following: given a process group, wait for all of its processes to fully terminate.</p><p>macOS has a bunch of fancy features that <a href=/2019/03/macos-threads-qos-and-bazel.html>other systems do not have</a>, but process control is not among them. We do not have features like Linux&rsquo;s child subreaper or PID namespaces to keep track of process groups. Therefore, we&rsquo;ll have to roll our own. And the only way to do this is to scan the process table looking for processes with the desired process group identifier (PGID) and waiting until they are gone.</p></p><p class=text-muted>November 15, 2019
&#183;
Tags:
<a href=/tags/bazel>bazel</a>, <a href=/tags/darwin>darwin</a>, <a href=/tags/macos>macos</a>, <a href=/tags/unix>unix</a><br><a class=text-reset href=/2019/11/wait-for-process-group-darwin.html>Continue reading (about
8 minutes)</a></p></div></div><div class="media my-4"><img class=mr-3 src=/octicons/note.svg width=32px height=32px><div class=media-body><h2 class=mt-0><a href=/2019/11/wait-for-process-group-linux.html>Waiting for process groups, Linux edition</a></h2><p><p>In the <a href=/2019/11/wait-for-process-group.html>previous post</a>, we saw why waiting for a process group to terminate is important (at least in the context of Bazel), and we also saw why this is a difficult thing to do in a portable manner. So today, let&rsquo;s dive into how to do this properly on a Linux system.</p><p>On Linux, we have two routes: using the <strong>child subreaper</strong> feature or using <strong>PID namespaces</strong>. We&rsquo;ll focus on the former because that&rsquo;s what we&rsquo;ll use to fix (<a href=https://github.com/bazelbuild/bazel/issues/10245>#10245</a>) the process wrapper<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>, and because they are sufficient to fully address our problem.</p></p><p class=text-muted>November 14, 2019
&#183;
Tags:
<a href=/tags/bazel>bazel</a>, <a href=/tags/linux>linux</a>, <a href=/tags/unix>unix</a><br><a class=text-reset href=/2019/11/wait-for-process-group-linux.html>Continue reading (about
4 minutes)</a></p></div></div><div class="media my-4"><img class=mr-3 src=/octicons/note.svg width=32px height=32px><div class=media-body><h2 class=mt-0><a href=/2019/11/wait-for-process-group.html>Waiting for process groups, introduction</a></h2><p><p><strong>Process groups</strong> are a feature of Unix systems to group related processes under a common identifier, known as the <strong>PGID</strong>. Using the PGID, one can look for these related process and send signals in unison to them. This is typically used by shell interpreters to manage processes.</p><p>For example, let&rsquo;s launch a shell command that puts two <code>sleep</code> invocations in the background (those with the 10- and 20-second delays) and then sleeps the direct child (with a 5-second delay)&mdash;while also putting the whole invocation in the background so that we can inspect what&rsquo;s going on:</p></p><p class=text-muted>November 12, 2019
&#183;
Tags:
<a href=/tags/bazel>bazel</a>, <a href=/tags/unix>unix</a><br><a class=text-reset href=/2019/11/wait-for-process-group.html>Continue reading (about
6 minutes)</a></p></div></div><div class="media my-4"><img class=mr-3 src=/octicons/note.svg width=32px height=32px><div class=media-body><h2 class=mt-0><a href=/2019/11/bazel-process-wrapper.html>Bazel's process-wrapper helper tool</a></h2><p><p>As strange as it may sound, a very important job of any build tool is to orchestrate the execution of lots of other programs&mdash;and <a href=https://bazel.build/>Bazel</a> is no exception.</p><p>Once Bazel has finished <em>loading</em> and <em>analyzing</em> the build graph, Bazel enters the <em>execution phase</em>. In this phase, the primary thing that Bazel does is walk the graph looking for actions to execute. Then, for each action, Bazel invokes its commands&mdash;things like compiler and linker invocations&mdash;as subprocesses. Under the default configuration<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>, all of these commands run on your machine.</p></p><p class=text-muted>November 8, 2019
&#183;
Tags:
<a href=/tags/bazel>bazel</a>, <a href=/tags/internals>internals</a>, <a href=/tags/unix>unix</a><br><a class=text-reset href=/2019/11/bazel-process-wrapper.html>Continue reading (about
6 minutes)</a></p></div></div><div class="media my-4"><img class=mr-3 src=/octicons/note.svg width=32px height=32px><div class=media-body><h2 class=mt-0><a href=/2019/11/macos-sandbox-exec.html>A quick glance at macOS' sandbox-exec</a></h2><p><p>macOS includes a sandboxing mechanism to closely control what processes can do on the system. Sandboxing can restrict file system accesses on a path level, control which host/port pairs can be reached over the network, limit which binaries can be executed, and much more. All applications installed via the App Store are subject to sandboxing.</p><p>This sandboxing functionality is exposed via the <code>sandbox-exec(1)</code> command-line utility, which unfortunately has been listed as deprecated for at least the last two major versions of macOS. It is still there, however, and the supplemental manual pages like <code>sandbox(7)</code> or <code>sandboxd(8)</code> do not mention the deprecation&mldr; which makes me think that the new <a href=https://developer.apple.com/app-sandboxing/>App Sandboxing</a> feature is built on the same kernel subsystem as <code>sandbox-exec(1)</code>.</p></p><p class=text-muted>November 1, 2019
&#183;
Tags:
<a href=/tags/bazel>bazel</a>, <a href=/tags/macos>macos</a><br><a class=text-reset href=/2019/11/macos-sandbox-exec.html>Continue reading (about
3 minutes)</a></p></div></div><div class="media my-4"><img class=mr-3 src=/octicons/note.svg width=32px height=32px><div class=media-body><h2 class=mt-0><a href=/2019/03/optimizing-tree-deletions.html>Optimizing tree deletions in Bazel</a></h2><p><p>Bazel likes creating very deep and large trees on disk during a build. One example is the output tree, which naturally contains all the artifacts of your build. Another, more problematic example is the symlink forest trees created for every action when sandboxing is enabled. As garbage gets created, it must be deleted.</p><p>It turns out, however, that deleting file system trees can be very expensive&mdash;and especially so on macOS. In fact, calls to our <code>deleteTree</code> algorithm routinely showed up in my profiling runs when trying to diagnose slowdowns using the <a href=https://blog.bazel.build/2019/02/01/dynamic-spawn-scheduler.html>dynamic scheduler</a>. One thing I quickly wondered is: why can I easily catch Bazel stuck in the tree deletion but I can never catch it busily creating such a tree? Is tree deletion inherently slow or are we doing something stupid?</p></p><p class=text-muted>March 22, 2019
&#183;
Tags:
<a href=/tags/bazel>bazel</a>, <a href=/tags/macos>macos</a>, <a href=/tags/performance>performance</a><br><a class=text-reset href=/2019/03/optimizing-tree-deletions.html>Continue reading (about
4 minutes)</a></p></div></div><div class="media my-4"><img class=mr-3 src=/octicons/star.svg width=32px height=32px><div class=media-body><h2 class=mt-0><a href=/2019/03/macos-threads-qos-and-bazel.html>Darwin's QoS service classes and performance</a></h2><p><p>Since the publication of Bazel a few years ago, users have reported (and I myself have experienced) general slowdowns when Bazel is running on Macs: things like the window manager stutter and others like the web browser cannot load new pages. Similarly, after the introduction of the <a href=https://blog.bazel.build/2019/02/01/dynamic-spawn-scheduler.html>dynamic spawn scheduler</a>, some users reported <em>slower</em> builds than pure remote or pure local builds, which made no sense.</p><p>All along we guessed that these problems were caused by Bazel&rsquo;s abuse of system threads, as it used to spawn 200 <em>runnable</em> threads during analysis and used to run 200 concurrent compiler subprocesses. We tackled the problem by reducing Bazel&rsquo;s abuse (e.g. <a href=https://github.com/bazelbuild/bazel/commit/ac880418885061d1039ad6b3d8c28949782e02d6>commit ac88041</a>) of system resources&mldr; and while we saw an improvement, the issue remained.</p></p><p class=text-muted>March 6, 2019
&#183;
Tags:
<a href=/tags/bazel>bazel</a>, <a href=/tags/featured>featured</a>, <a href=/tags/macos>macos</a>, <a href=/tags/performance>performance</a><br><a class=text-reset href=/2019/03/macos-threads-qos-and-bazel.html>Continue reading (about
6 minutes)</a></p></div></div><div class="media my-4"><img class=mr-3 src=/octicons/note.svg width=32px height=32px><div class=media-body><h2 class=mt-0><a href=/2019/02/setenv-and-global-variables.html>Using setenv equals setting global variables</a></h2><p>This is the tale of yet another Bazel bug, this time involving environment variables, global state, and gRPC. Through it, I&rsquo;ll argue that you should never use setenv within a program unless you are doing so to execute something else.</p><p class=text-muted>February 22, 2019
&#183;
Tags:
<a href=/tags/bazel>bazel</a><br><a class=text-reset href=/2019/02/setenv-and-global-variables.html>Continue reading (about
4 minutes)</a></p></div></div><div class="media my-4"><img class=mr-3 src=/octicons/note.svg width=32px height=32px><div class=media-body><h2 class=mt-0><a href=/2019/02/encode-your-assumptions.html>Encode your assumptions</a></h2><p><p>The point of this post is simple and I&rsquo;ll spoil it from the get go: <strong>every time you make an assumption in a piece of code, make such assumption explicit in the form of an assertion or error check</strong>. If you cannot do that (are you sure?), then write a detailed comment.</p><p>In fact, I&rsquo;m exceedingly convinced that the amount of assertion-like checks in a piece of code is a good indicator of the programmer&rsquo;s expertise.</p></p><p class=text-muted>February 7, 2019
&#183;
Tags:
<a href=/tags/bazel>bazel</a>, <a href=/tags/production-software>production-software</a>, <a href=/tags/readability>readability</a>, <a href=/tags/software>software</a><br><a class=text-reset href=/2019/02/encode-your-assumptions.html>Continue reading (about
4 minutes)</a></p></div></div><div class="media my-4"><img class=mr-3 src=/octicons/star.svg width=32px height=32px><div class=media-body><h2 class=mt-0><a href=/2019/02/sandboxfs-0-1-0.html>Hello, sandboxfs 0.1.0</a></h2><p><p>I am pleased to announce that the first release of <a href=https://github.com/bazelbuild/sandboxfs>sandboxfs</a>, 0.1.0, is <em>finally</em> here! You can download the sources and prebuilt binaries from the <a href=https://github.com/bazelbuild/sandboxfs/releases/tag/sandboxfs-0.1.0>0.1.0 release page</a> and you can read the <a href=https://github.com/bazelbuild/sandboxfs/blob/master/INSTALL.md>installation instructions</a> for more details.</p><p>The journey to this first release has been a long one. sandboxfs was first conceived over two years ago, was <a href=/2017/08/introducing-sandboxfs.html>first announced in August 2017</a>, showed its <a href=https://blog.bazel.build/2018/04/13/preliminary-sandboxfs-support.html>first promising results in April 2018</a>, and has been undergoing a rewrite from Go to Rust. (And by the way, this has been my 20% project at Google so rest assured that they are still possible!)</p></p><p class=text-muted>February 5, 2019
&#183;
Tags:
<a href=/tags/bazel>bazel</a>, <a href=/tags/featured>featured</a>, <a href=/tags/pkg_comp>pkg_comp</a>, <a href=/tags/sandboxctl>sandboxctl</a>, <a href=/tags/sandboxfs>sandboxfs</a>, <a href=/tags/software>software</a><br><a class=text-reset href=/2019/02/sandboxfs-0-1-0.html>Continue reading (about
7 minutes)</a></p></div></div><div class="media my-4"><img class=mr-3 src=/octicons/note.svg width=32px height=32px><div class=media-body><h2 class=mt-0><a href=/2019/01/open-files-limit-macos-and-jvm.html>Open files limit, macOS, and the JVM</a></h2><p><p>Bazel&rsquo;s original <a href=https://www.dictionary.com/browse/raison-d-etre>raison d&rsquo;etre</a> was to support Google&rsquo;s monorepo. A consequence of using a monorepo is that some builds will become very large. And large builds can be very resource hungry, especially when using a tool like Bazel that tries to parallelize as many actions as possible for efficiency reasons. There are many resource types in a system, but today I&rsquo;d like to focus on the number of open files at any given time (<code>nofiles</code>).</p></p><p class=text-muted>January 29, 2019
&#183;
Tags:
<a href=/tags/bazel>bazel</a>, <a href=/tags/jvm>jvm</a>, <a href=/tags/macos>macos</a>, <a href=/tags/monorepo>monorepo</a>, <a href=/tags/portability>portability</a><br><a class=text-reset href=/2019/01/open-files-limit-macos-and-jvm.html>Continue reading (about
3 minutes)</a></p></div></div><div class="media my-4"><img class=mr-3 src=/octicons/note.svg width=32px height=32px><div class=media-body><h2 class=mt-0><a href=/2018/04/bazel-xcode-locations-cache.html>A few extra system calls... and you lose 1% build time</a></h2><p><p>Blaze—the variant of <a href=https://bazel.build/>Bazel</a> used internally at Google—was originally designed to build the <a href=https://cacm.acm.org/magazines/2016/7/204032-why-google-stores-billions-of-lines-of-code-in-a-single-repository/fulltext>Google monorepo</a>. One of the beauties of sticking to a monorepo is code reuse, but this has the unfortunate side-effect of dependency bloat. As a result, Bazel and Blaze have evolved to support ever-increasingly-bigger pieces of software.</p><p>The growth of the projects built by Bazel and Blaze has had the unsurprising consequence that our engineers all now have high-end workstations with access to massive amounts of distributed resources. And, as you can imagine, this has had an impact in the design of Blaze: many chunks of our codebase can—and do—assume that everyone has powerful hardware. These assumptions break down as soon as you move into Bazel&rsquo;s open source land: while knowing where the product really runs is out of hand, we can safely assume it is certainly being used on slow<em>er</em> hardware.</p></p><p class=text-muted>April 30, 2018
&#183;
Tags:
<a href=/tags/bazel>bazel</a>, <a href=/tags/google>google</a>, <a href=/tags/monorepo>monorepo</a>, <a href=/tags/software>software</a><br><a class=text-reset href=/2018/04/bazel-xcode-locations-cache.html>Continue reading (about
4 minutes)</a></p></div></div><div class="media my-4"><img class=mr-3 src=/octicons/note.svg width=32px height=32px><div class=media-body><h2 class=mt-0><a href=/2018/04/preliminary-sandboxfs-support-in-bazel.html>Preliminary sandboxfs support in Bazel</a></h2><p><p>During the summer of last year, <a href=/2017/08/introducing-sandboxfs.html>I hosted an intern who implemented sandboxfs</a>: a FUSE-based file system that exposes an arbitrary view of the host&rsquo;s file system under the mount point. At the end of his internship, we had a functional sandboxfs implementation and some draft patches for integration in Bazel.</p><p>The goal of sandboxfs in the context of Bazel is to improve the performance of builds when action sandboxing is enabled. The way in which we try to do so is by replacing the costly process of setting up the file system for each action using symlinks with a file system that does so &ldquo;instantaneously&rdquo;.</p></p><p class=text-muted>April 13, 2018
&#183;
Tags:
<a href=/tags/bazel>bazel</a>, <a href=/tags/google>google</a>, <a href=/tags/sandboxfs>sandboxfs</a>, <a href=/tags/software>software</a><br><a class=text-reset href=/2018/04/preliminary-sandboxfs-support-in-bazel.html>Continue reading (about
2 minutes)</a></p></div></div><div class="media my-4"><img class=mr-3 src=/octicons/star.svg width=32px height=32px><div class=media-body><h2 class=mt-0><a href=/2018/03/stick-to-projects-core-language-in-tests.html>Stick to your project's core language in your tests</a></h2><p><p><em>This post is a short, generalized summary of the preceeding two. I believe those two posts put readers off due to their massive length and the fact that they were seemingly tied to Bazel and Java, thus failing to communicate the larger point I wanted to make. Let&rsquo;s try to distill their key points here in a language- and project-agnostic manner.</em></p><hr></p><p class=text-muted>March 27, 2018
&#183;
Tags:
<a href=/tags/bazel>bazel</a>, <a href=/tags/featured>featured</a>, <a href=/tags/google>google</a>, <a href=/tags/software>software</a><br><a class=text-reset href=/2018/03/stick-to-projects-core-language-in-tests.html>Continue reading (about
3 minutes)</a></p></div></div><div class="media my-4"><img class=mr-3 src=/octicons/note.svg width=32px height=32px><div class=media-body><h2 class=mt-0><a href=/2018/03/bazel-tests-in-java-part-2.html>A case for writing Bazel's integration tests in Java, part 2</a></h2><p><p>In <a href=/2018/03/bazel-tests-in-java-part-1.html>part 1 of this series</a>, I made the case that you should <strong>run away from the shell when writing integration tests</strong> for your software and that you should <strong>embrace the primary language of your project</strong> to write those.</p><p>Depending on the language you are using, doing this will mean significant more work upfront to lay out the foundations for your tests, but this work will pay off. You may also <em>feel</em> that the tests could be more verbose than if they were in shell, though that&rsquo;s not necessarily the case.</p></p><p class=text-muted>March 19, 2018
&#183;
Tags:
<a href=/tags/bazel>bazel</a>, <a href=/tags/google>google</a>, <a href=/tags/sandboxfs>sandboxfs</a>, <a href=/tags/software>software</a><br><a class=text-reset href=/2018/03/bazel-tests-in-java-part-2.html>Continue reading (about
12 minutes)</a></p></div></div><div class="media my-4"><img class=mr-3 src=/octicons/note.svg width=32px height=32px><div class=media-body><h2 class=mt-0><a href=/2018/03/bazel-tests-in-java-part-1.html>A case for writing Bazel's integration tests in Java, part 1</a></h2><p><p>My latest developer productivity <del>rant</del> thesis is that <strong>integration tests should be written in the exact same language as the thing they test</strong>. Specifically, <strong>not</strong> shell.</p><p>This theory applies mostly to tests that verify infrastructure software like servers or command line tools. It is too easy to fall into the trap of using the shell because it feels like the natural choice to interact with tools. But I argue that this is a big mistake that hurts the long-term health of the project, and once trapped, it&rsquo;s hard to escape.</p></p><p class=text-muted>March 16, 2018
&#183;
Tags:
<a href=/tags/bazel>bazel</a>, <a href=/tags/google>google</a>, <a href=/tags/software>software</a><br><a class=text-reset href=/2018/03/bazel-tests-in-java-part-1.html>Continue reading (about
14 minutes)</a></p></div></div><div class="media my-4"><img class=mr-3 src=/octicons/note.svg width=32px height=32px><div class=media-body><h2 class=mt-0><a href=/2017/08/introducing-sandboxfs.html>Introducing sandboxfs</a></h2><p><p>sandboxfs is a FUSE-based file system that exposes an arbitrary view of the
host&rsquo;s file system under the mount point, and offers access controls that
differ from those of the host. You can think of sandboxfs as an advanced
version of <a href=https://bindfs.org/>bindfs</a> (or <code>mount --bind</code> or <code>mount_null(8)</code>
depending on your system) in which you can combine and nest directories under
an arbitrary layout.</p><p>The primary use case for this project is to provide a better file system
sandboxing technique for the Bazel build system. The goal here is to run each
build action (think compiler invocation) in a sandbox so that its inputs and
outputs are tightly controlled, and sandboxfs attempts to do this in a more
efficient manner than the current symlinks-based implementation.</p></p><p class=text-muted>August 25, 2017
&#183;
Tags:
<a href=/tags/bazel>bazel</a>, <a href=/tags/pkg_comp>pkg_comp</a>, <a href=/tags/sandboxfs>sandboxfs</a>, <a href=/tags/software>software</a>, <a href=/tags/sourcachefs>sourcachefs</a><br><a class=text-reset href=/2017/08/introducing-sandboxfs.html>Continue reading (about
2 minutes)</a></p></div></div><div class="media my-4"><img class=mr-3 src=/octicons/note.svg width=32px height=32px><div class=media-body><h2 class=mt-0><a href=/2016/01/joining-blaze-team.html>Joining the Blaze team</a></h2><p><p>It has been <a href=https://medium.com/@jmmv/six-years-at-google-8b06563fab08>over 6 years since I joined
Google</a> and
throughout this time I have been in the Storage SRE family: first with GFS,
then with Colossus, and last with Persistent Disk. Even though this counts as
3 different teams, the reality is that I have been doing mostly the same type
of work all around.</p><p>I had pondered the idea of switching to a pure Software Engineer (SWE) role for
all these years and never taken any action. Until now. Things change, and the
time has come for me to make a move and pursue that thought in an effort to
grow in a different direction. And why now, you ask? Well, simply because I
have found a role in the NYC office for a project that I am personally
passionate about.</p></p><p class=text-muted>January 19, 2016
&#183;
Tags:
<a href=/tags/bazel>bazel</a>, <a href=/tags/google>google</a>, <a href=/tags/work>work</a><br><a class=text-reset href=/2016/01/joining-blaze-team.html>Continue reading (about
3 minutes)</a></p></div></div><div class="media my-4"><img class=mr-3 src=/octicons/star.svg width=32px height=32px><div class=media-body><h2 class=mt-0><a href=/2015/04/on-bazel-and-open-source.html>On Bazel and Open Source</a></h2><p><p>This is a rare post because I don&rsquo;t usually talk about Google stuff
here, and this post is about Bazel: a tool recently published by Google.
Why? Because I love its internal counterpart, Blaze, and believe that
Bazel has the potential to be one of the best build tools if it is not
already.</p><p>However, Bazel currently has some shortcomings to cater to a certain
kind of important projects in the open source ecosystem: the projects
that form the foundation of open source operating systems. This post is,
exclusively, about this kind of project.</p></p><p class=text-muted>April 14, 2015
&#183;
Tags:
<a href=/tags/bazel>bazel</a>, <a href=/tags/featured>featured</a>, <a href=/tags/google>google</a>, <a href=/tags/software>software</a><br><a class=text-reset href=/2015/04/on-bazel-and-open-source.html>Continue reading (about
17 minutes)</a></p></div></div></div><div class="col-md-3 sidebar d-none d-md-block"><div class=row><div class="col text-center p-2"><p><a href=/about.html class=clear-link><img src=/images/avatars/20181124-snow.jpg class="rounded-circle shadow my-2" style=width:100px><br><b>Julio Merino</b><br>A blog on operating systems, programming languages, testing, build systems, my own software
projects and even personal productivity. Specifics include FreeBSD, Linux, Rust, Bazel and
EndBASIC.</a></p><div class=row><div class=col><div class=form-group><form action=https://endtracker.azurewebsites.net/api/sites/e8da9f62-b7ac-4fe9-bf20-7c527199a376/subscribers/add method=post><input type=text name=email placeholder="Enter your email" class="form-control input-sm text-center my-1">
<button type=submit class="btn btn-primary btn-block my-1">Subscribe</button></form></div></div></div><div class="row px-2"><div class="col-sm-5 text-left"><small><span class=subscriber-count>0</span> subscribers</small></div><div class="col-sm-7 text-right"><p><a rel=me href=https://mastodon.online/@jmmv><img src=/images/badges/mastodon-logo.svg width=32px height=32px alt="Follow @jmmv on Mastodon">
</a><a href="https://twitter.com/intent/follow?original_referer=https%3A%2F%2Fjmmv.dev%2F&amp;screen_name=jmmv"><img src=/images/badges/Twitter_logo_blue.svg width=32px height=32px alt="Follow @jmmv on Twitter">
</a><a href=/feed.xml><img src=/images/badges/feed-icon-28x28.png alt="RSS feed"></a></p></div></div></div></div><div class=row><div class=col><h2>Featured software</h2><ul><li class=overflow-ellipsis><a href=https://www.endbasic.dev/ target=_blank>EndBASIC: Online BASIC+DOS env</a></li><li class=overflow-ellipsis><a href=https://endtracker.azurewebsites.net/ target=_blank>EndTRACKER: Services for static sites</a></li></ul></div></div><div class=row><div class=col><h2>Featured posts</h2><ul><li class=overflow-ellipsis><a href=/2023/06/fast-machines-slow-machines.html>Fast machines, slow machines</a></li><li class=overflow-ellipsis><a href=/2022/12/endbasic-0.10.html>EndBASIC 0.10: Core language, evolved</a></li><li class=overflow-ellipsis><a href=/2022/10/bye-microsoft-hi-snowflake.html>Farewell, Microsoft; hello, Snowflake!</a></li><li class=overflow-ellipsis><a href=/2022/05/rust-is-hard-but-does-it-matter.html>Rust is hard, yes, but does it matter?</a></li><li class=overflow-ellipsis><a href=/2022/04/rust-traits-and-dependency-injection.html>Rust traits and dependency injection</a></li><li class=overflow-ellipsis><a href=/2022/03/a-year-on-windows-intro.html>A year on Windows: Introduction</a></li><li class=overflow-ellipsis><a href=/2021/04/always-be-quitting.html>Always be quitting</a></li><li class=overflow-ellipsis><a href=/2021/02/google-monorepos-and-caching.html>How does Google keep build times low?</a></li><li class=overflow-ellipsis><a href=/2020/12/google-no-clean-builds.html>How does Google avoid clean builds?</a></li><li class=overflow-ellipsis><a href=/2020/12/unit-testing-a-console-app.html>Unit-testing a console app (a text editor)</a></li><li class=overflow-ellipsis><a href=/essays.html#featured>More...</a></li></ul></div></div></div></div></div><footer class=container-fluid><div class=row><div class="col-4 order-2 text-right"><p class=float-right><a href=#>Back to top</a></p></div><div class="col-8 order-1 mr-auto"><p>Copyright 2004&ndash;2025
Julio Merino</p></div></div></footer><script type=module>
  import { addAnchorsToHeaders, addElementClasses, BatchClient } from "\/js\/main.0de73782e9e0fbcb4184fb5793949b3b0d0ada16455df89320415b4dcc052f88.js";

  var batchClient = new BatchClient(SITE_ID);
  batchClient.doAll({
    put_request: true, get_comments: true, get_subscriber_count: true, get_votes: true });

  window.voteThumbsUp = function() { batchClient.voteThumbsUp(); }
  window.voteThumbsDown = function() { batchClient.voteThumbsDown(); }

  window.postComment = function(...args) {
    batchClient.postComment(...args);
  };

  addAnchorsToHeaders();
  addElementClasses();
</script><noscript><img src="https://hugo-dynamic.jmmv.dev/api/sites/e8da9f62-b7ac-4fe9-bf20-7c527199a376/pages/aHR0cHM6Ly9qbW12LmRldi90YWdzL2JhemVsL2luZGV4Lmh0bWw=/stamp.gif" style=display:none></noscript></body></html>