<!doctype html><html lang=en xmlns=http://www.w3.org/1999/xhtml xmlns:fb=http://ogp.me/ns/fb#><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta property="og:site_name" content="Julio Merino (jmmv.dev)"><meta property="twitter:site" content="@jmmv"><title>Lutok - Julio Merino (jmmv.dev)</title>
<meta property="og:title" content="Lutok - Julio Merino (jmmv.dev)"><meta property="twitter:title" content="Lutok - Julio Merino (jmmv.dev)"><meta name=description content><meta property="og:description" content><meta property="twitter:description" content><meta name=author content="Julio Merino"><meta property="twitter:creator" content="@jmmv"><meta name=generator content="Hugo 0.145.0"><meta property="og:url" content="https://jmmv.dev/tags/lutok/index.html"><meta property="og:type" content="blog"><meta property="twitter:card" content="summary"><link rel=canonical href=https://jmmv.dev/tags/lutok/index.html><link rel=alternate type=application/rss+xml title="Julio Merino (jmmv.dev)" href=/feed.xml><link rel=stylesheet href=/sass/main.min.cb91349cd93211a37e7d5dc131c35a170fc795721c03373cd05571327eea206b.css><link rel=stylesheet href=/css/chroma.css><link rel=icon type=image/png href=/images/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/images/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicons/favicon-96x96.png sizes=96x96><meta property="og:image" content="/images/favicons/favicon-1200x1200.png"><meta property="twitter:image" content="https://jmmv.dev/images/favicons/favicon-1200x1200.png"><script>const SITE_ID="e8da9f62-b7ac-4fe9-bf20-7c527199a376",BASE_URL="https://jmmv.dev/"</script></head><body><header class=site-header><nav class="navbar navbar-expand-md fixed-top navbar-dark bg-primary"><a class=navbar-brand href=/><img src=/images/favicons/favicon-30x30.png width=30 height=30 class="d-inline-block align-top" alt>
&nbsp;jmmv.dev
</a><button class=navbar-toggler type=button data-toggle=collapse data-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarSupportedContent><ul class="navbar-nav mr-auto"><li class=nav-item><a class=nav-link href=/about.html>About</a></li><li class=nav-item><a class=nav-link href=/blog.html>Blog</a></li><li class=nav-item><a class=nav-link href=/resume.html>Resume</a></li><li class=nav-item><a class=nav-link href=/software.html>Software</a></li></ul><ul class="navbar-nav mr-4"><li class=nav-item><a class=nav-link href=/archive.html>Archive</a></li><li class=nav-item><a class=nav-link href=/series.html>Series</a></li><li class=nav-item><a class=nav-link href=/tags.html>Tags</a></li></ul><form class=form-inline method=get role=search action=https://www.google.com/search><div class=input-group><input type=search name=query class=form-control placeholder=Search aria-label=Search><div class=input-group-append><button type=submit value=Search class="btn btn-light">
<img src=/octicons/search.svg></button></div></div><input type=hidden name=sitesearch value=https://jmmv.dev/></form></div></nav></header><div class=page-header><div class=container><h1>Posts: Lutok</h1><p>Showing 10 posts</p></div></div><div class=container><div class=row><div class=col-md-9><div class="media my-4"><img class=mr-3 src=/octicons/note.svg width=32px height=32px><div class=media-body><h2 class=mt-0><a href=/2013/12/lutok-03-kyua-testers-02-and-kyua-cli-08.html>lutok-0.3, kyua-testers-0.2 and kyua-cli-0.8</a></h2><p><p>Yesterday was release day: I pushed out <a href="https://code.google.com/p/lutok/downloads/detail?name=lutok-0.4.tar.g">Lutok 0.3</a>, <a href="https://code.google.com/p/kyua/downloads/detail?name=kyua-testers-0.2.tar.gz">Kyua Testers 0.2</a> and <a href="https://code.google.com/p/kyua/downloads/detail?name=kyua-cli-0.8.tar.gz">Kyua CLI 0.8</a>.</p><p>There are not a lot of changes in these new releases. The reason I cut them was to publish the new TAP-compliant tester and make it available for use in FreeBSD as soon as possible. I will be using this new feature as part of the <a href=http://wiki.freebsd.org/TestSuite>FreeBSD Test Suite</a> in order to <a href=http://lists.freebsd.org/pipermail/freebsd-testing/2013-November/000095.html>hook existing test programs without having to rewrite</a> them to use the ATF libraries (or at least not as a first step).</p></p><p class=text-muted>December 8, 2013
&#183;
Tags:
<a href=/tags/kyua>kyua</a>, <a href=/tags/lutok>lutok</a>, <a href=/tags/release>release</a><br><a class=text-reset href=/2013/12/lutok-03-kyua-testers-02-and-kyua-cli-08.html>Continue reading (about
2 minutes)</a></p></div></div><div class="media my-4"><img class=mr-3 src=/octicons/note.svg width=32px height=32px><div class=media-body><h2 class=mt-0><a href=/2013/06/lutok-03-released.html>Lutok 0.3 released</a></h2><p><p><a href="https://code.google.com/p/lutok/downloads/detail?name=lutok-0.3.tar.gz">Lutok 0.3</a> was released yesterday evening. The packages in pkgsrc-current, Fedora 19 and Fedora rawhide have all been updated accordingly.</p><p>The major highlight of this new release is support for Lua 5.2 while retaining backwards compatibility with Lua 5.1. The incompatible changes between 5.1 and 5.2 only affected a small subset of the functionality in Lutok, which made this dual support possible.</p><p>For those that don't know what this project is about: Lutok is a lightweight C++ API for Lua. It is lightweight because it's an almost 1:1 mapping of the C API into C++. However, the major design criterion behind Lutok is to provide an interface that is fully C++ native and that is safe to use in the face of exceptions. For this reason, Lutok is not as performant as the native C library, which is OK for many use cases out there.</p></p><p class=text-muted>June 15, 2013
&#183;
Tags:
<a href=/tags/lutok>lutok</a>, <a href=/tags/release>release</a><br><a class=text-reset href=/2013/06/lutok-03-released.html>Continue reading (about
2 minutes)</a></p></div></div><div class="media my-4"><img class=mr-3 src=/octicons/note.svg width=32px height=32px><div class=media-body><h2 class=mt-0><a href=/2012/02/projects-migrated-to-git.html>Projects migrated to Git</a></h2><p>I finally took the plunge. Yesterday night, I migrated the <a href=http://code.google.com/p/kyua/>Kyua</a> and <a href=http://code.google.com/p/lutok/>Lutok</a> repositories from Subversion to Git. And this morning I migrated ATF from Monotone and custom hosting to Git and Google Code; oh, and this took way longer than expected.<br><br><b>Migration of Kyua and Lutok</b><br><br>Migrating these two projects was straightforward. After preparing a fresh local Git repository following the <a href=/2012/02/converting-subversion-repository-to-git.html>instructions posted yesterday</a>, pushing to Google Code is a simple matter:<br><br><pre>$ git remote add googlecode https://code.google.com/p/your-project<br>$ git push googlecode --all<br>$ git push googlecode --tags</pre><br>One of the nice things I discovered while doing this is that a Google Code project supports multiple repositories when the VCS system is set to Git or Mercurial. By default, the system creates the <tt>default</tt> and <tt>wiki</tt> repositories, but you can add more at will. This is understandable given that, in Subversion, you have the ability to check out individual directories of a project whereas you cannot do that in the other supported VCSs: you actually need different repositories to group different parts of the project.<br><br>I performed the full migration under a Linux box so that I could avail of the most recent Git version along with a proven binary package. The migration went alright, but I encountered a little problem when attempting a fresh checkout from NetBSD: git under NetBSD will <i>not</i> work correctly against SSL servers because it lacks the necessary CA certificates. The solution is to install the <tt>security/mozilla-rootcerts</tt> package and follow the instructions printed during installation; why this does not happen automatically escapes my mind.<br><br><b>Migration of ATF</b><br><br>I had been having doubts about migrating ATF itself, although if Kyua was moved to Git, it was a prerequisite to move ATF as well. &nbsp;Certainly I could convert the repository to Git, but where could I host it afterwards? &nbsp;Creating a new Google Code project just for this seemed too much of a hassle. My illumination came when I found out, as above, that Google Code supports an arbitrary amount of repositories in a particular project when converting it to Git.<br><br>So, for ATF, I just ran <tt>mtn git_export</tt> with appropriate flags, created a new <tt>atf</tt> repository on the Kyua site, and pushed the contents there. Along the way, I also decided to kill the home-grown ATF web site and replace it by a <a href=http://code.google.com/p/kyua/wiki/ATF>single page</a> containing all the relevant information. At this point, ATF and Kyua are supposed to work together quite tightly (in the sense that ATF is just a "subcomponent" of Kyua), so coupling the two projects on the same site makes sense.<br><br>Now, let's drink the kool aid.</p><p class=text-muted>February 26, 2012
&#183;
Tags:
<a href=/tags/atf>atf</a>, <a href=/tags/git>git</a>, <a href=/tags/kyua>kyua</a>, <a href=/tags/lutok>lutok</a><br><a class=text-reset href=/2012/02/projects-migrated-to-git.html>Continue reading (about
3 minutes)</a></p></div></div><div class="media my-4"><img class=mr-3 src=/octicons/note.svg width=32px height=32px><div class=media-body><h2 class=mt-0><a href=/2012/02/switching-projects-to-git.html>Switching projects to Git</a></h2><p>The purpose of this post is to tell you the story of the Version Control System (VCS) choices I have made while maintaining my open source projects ATF, Kyua and Lutok. It also details where my thoughts are headed to these days.<br><br>This is not a description of centralized vs. distributed VCSs, and it does not intend to be one. This does not intend to compare Monotone to Git either, although you'll probably feel like it while reading the text.&nbsp;Note that I have fully known the advantages of DVCSs over centralized systems for many years, but for some reason or another I have been "forced" to use centralized systems on and off. The Subversion hiccup explained below is... well... regrettable, but it's all part of the story!<br><br>Hope you enjoy the read.<br><b><br></b><br><b>Looking back at Monotone (and ATF)</b><br><br>I still remember the moment&nbsp;<a href=/2004/11/impressions-on-monotone.html>I discovered Monotone in 2004</a>: simply put, it blew my mind. It was clear to me that Distributed Version Control Systems (DVCSs) were going to be the future, and I eagerly adopted Monotone for my own projects. A year later, Git appeared and it took all the praise for DVCSs: developers all around started migrating en masse to Git, leaving behind other (D)VCSs. Many of these developers then went on to make Git usable (it certainly wasn't at first) and&nbsp;well-documented.&nbsp;(Note: I really dislike Git's origins... but I won't get into details; it has been many years since that happened.)<br><br>One of the projects in which I chose to use <a href=http://monotone.ca/>Monotone</a> was <a href=http://www.netbsd.org/~jmmv/atf/>ATF</a>. That might have been a good choice at the time despite being very biased, but it has caused problems over time. These have been:<br><ul><li>Difficulty to get Monotone installed: While most Linux distributions come with a Monotone binary package these days, it was not the case years ago. But even nowadays if all Linux distributions have binary packages, the main consumers of ATF are NetBSD users, and their only choice is to build their own binaries. This generates discomfort because there is a lot of FUD surrounding C++ and Boost.</li><li>High entry barrier to potential contributors: It is a fact that Monotone is not popular, which means that nobody is familiar with it. Monotone's CLI is very similar to CVS, and I'd say the knowledge transition for basic usage is trivial, but the process of cloning a remote project was really convoluted until "recently". The lack of binary packages, combined with complex instructions on just how to <i>fetch</i> the sources of a project only help in scaring people away.</li><li>Missing features: Despite years have passed, Monotone still lacks some important features that impact its usability. For example, to my knowledge, it's still not possible to do work-directory merges and, while the interactive merges offered by the tool seem like a cool idea, they are not really practical as you get no chance to validate the merge. It is also not possible, for example, to reference the parent commit of any given commit without looking at the parent's ID. (Yeah, yeah, in a DAG there may be more than one parent, but that's not the common case.) Or know what a push/pull operation is going to change on both sides of the connection. And key management and trust has been broken since day one and is still not fixed. Etc, etc, etc.</li><li>No hosting: None of the major project hosting sites support Monotone. While there are some playground hosting sites, they are toys. I have also maintained my own servers sometimes, but it's certainly inconvenient and annoying.</li><li>No tools support: Pretty much no major development tools support Monotone as a VCS backend. Consider Ohloh, your favorite bug tracking system or your editor/IDE. (I attempted to install Trac with some alpha plugin to add Monotone support and it was a huge mess.)</li><li>No more active development: This is the drop that spills the cup. The developers of Monotone that created the foundations of the project left years ago. While the rest of the developers did a good job in coming up with a 1.0 release by March 2011, nothing else has happened since then. To me, it looks like a dead project at this point :-(</li></ul>Despite all this, I have been maintaining ATF in its Monotone repository, but I have felt the pain points above for years.<br><br>Furthermore, the few times some end user has approached ATF to offer some contribution, he has had tons of trouble getting a fresh checkout of the repository and given up. So staying with Monotone hurts the project more than it helps.<br><br><b>The adoption of Subversion (in Kyua)</b><br><br>To fix this mess, when I created the <a href=http://code.google.com/p/kyua/>Kyua</a> project two years ago, I decided to use Subversion instead of a DVCS. I knew upfront that it was a clear regression from a functionality point of view, but I was going to live with it. The rationale for this decision was to make the entry barrier to Kyua much lower by using off-the-shelf project hosting. And, because NetBSD developers use CVS (<i>shrugh</i>), choosing Subversion was a reasonable choice because of the workflow similarities to CVS and thus, supposedly, the low entry barrier.<br><br>Sincerely, the choice of Subversion has not fixed anything, and it has introduced its own trouble. Let's see why:<br><ul><li>ATF continues to be hosted in a Monotone repository, and Kyua depends on ATF. You can spot the problem, can't you? It's a nightmare to check out all the dependencies of Kyua, using different tools, just to get the thing working.</li><li>As of today, Git is as popular, if not more, than Subversion. All the major operating systems have binary packages for Git and/or bundle Git in their base installation (hello, OS X!). Installing Git on NetBSD is arguably easier (at least faster!) than Subversion. Developers are used to Git. Or let me fix that: developers <i>love</i> Git.</li><li>Subversion gets on the way more than it helps; it really does once you have experienced what other VCSs have to offer. I currently maintain independent checkouts of the repository (appropriately named 1, 2 and 3) so that I can develop different patches on each before committing the changes. This gets old really quickly. Not to mention when I have to fly for hours, as being stuck without an internet connection and plain-old Subversion... is suboptimal. Disconnected operation is key.</li></ul><div>The fact that Subversion is slowing down development, and the fact that it really does not help in getting new contributors more than Git would, make me feel it is time to say Subversion goodbye.</div><div><br></div><div><b>The migration to Git</b></div><div><b><br></b></div><div>At this point, I am seriously considering switching all of ATF, Lutok and Kyua to Git. No Mercurial, no Bazaar, no Fossil, no anything else. Git.<br><br>I am still not decided, and at this point all I am doing is toying around the migration process of the existing Monotone and Subversion repositories to Git while preserving as much of the history as possible. (It's not that hard, but there are a couple of details I want to sort out first.)</div><div><br></div><div>But why Git?</div><div><ul><li>First and foremost, because it is the most popular DVCS. I really want to have the advantages of disconnected development back. (I have tried git-svn and svk and they don't make the cut.)</li><li>At work, I have been using Git for a while to cope with the "deficiencies" of the centralized VCS of choice. We use the squashing functionality intensively, and I find this invaluable to constantly and shamelessly commit incomplete/broken pieces of code that no-one will ever see. Not everything deserves being in the recorded history!</li><li>Related to the above, I've grown accustomed to keeping unnamed, private branches in my local copy of the repository. These branches needn't match the public repository. In Monotone, you had this functionality in the form of "multiple heads for a given branch", but this approach is not as flexible as named private branches.</li><li>Monotone is able to export a repository to Git, so the transition is easy for ATF. I have actually been doing this periodically so that Ohloh can gather stats for ATF.</li><li>Lutok and ATF are hosted in Google Code, and this hosting platform now supports Git out of the box.</li><li>No Mercurial? Mercurial looks a lot like Monotone, and it is indeed very tempting. However, the dependency on Python is not that appropriate in the NetBSD context. Git, without its documentation, builds very quickly and is lightweight enough. Plus, if I have to change my habits, I would rather go with Git given that the other open source projects I am interested in use Git.</li><li>No Bazaar? No, not that popular. And the fact that this is based on GNU arch makes me cringe.</li><li>No Fossil? This tool looks awesome and provides much more than DVCS functionality: think about distributed wiki and bug tracking; cool, huh? It also appears to be a strong contender in the current discussions of what system should NetBSD choose to replace CVS. <i>However</i>, it is a one-man effort, much like Monotone was. And few people are familiar with it, so Fossil wouldn't solve the issue of lowering the entry barrier. Choosing Fossil would mean repeating the same mistake as choosing Monotone.</li></ul><div>So, while Git has its own deficiencies — e.g. I still don't like the fact that it is unable to record file moves (heuristics are not the same) — it seems like a very good choice. The truth is, it will ease development by a factor of a million (OK, maybe not that much) and, because the only person (right?) that currently cares about the upstream sources for any of these projects is me, nobody should be affected by the change.<br><br>The decision may seem a bit arbitrary given that the points above don't provide too much rationale to compare Git against the other alternatives. But if I want to migrate, I have to make a choice and this is the one that seems most reasonable.<br><br>Comments? Encouragements? Criticisms?</div></div></p><p class=text-muted>February 11, 2012
&#183;
Tags:
<a href=/tags/atf>atf</a>, <a href=/tags/git>git</a>, <a href=/tags/kyua>kyua</a>, <a href=/tags/lutok>lutok</a>, <a href=/tags/monotone>monotone</a>, <a href=/tags/vcs>vcs</a><br><a class=text-reset href=/2012/02/switching-projects-to-git.html>Continue reading (about
8 minutes)</a></p></div></div><div class="media my-4"><img class=mr-3 src=/octicons/note.svg width=32px height=32px><div class=media-body><h2 class=mt-0><a href=/2012/02/kyua-weekly-status-report_207.html>Kyua: Weekly status report</a></h2><p><br><ul><li>Created an RPM package for Lutok for inclusion in Fedora.</li><li>Created a preliminary RPM spec for ATF for Fedora. Now in discussions with the FPC to figure out how to install the tests on a Fedora system, as <tt>/usr/tests</tt> may not be appropriate.</li><li>No activity on Kyua itself though, unfortunately.</li></ul></p><p class=text-muted>February 7, 2012
&#183;
Tags:
<a href=/tags/atf>atf</a>, <a href=/tags/kyua>kyua</a>, <a href=/tags/lutok>lutok</a>, <a href=/tags/report>report</a><br><a class=text-reset href=/2012/02/kyua-weekly-status-report_207.html>Continue reading (about
1 minute)</a></p></div></div><div class="media my-4"><img class=mr-3 src=/octicons/note.svg width=32px height=32px><div class=media-body><h2 class=mt-0><a href=/2012/02/kyua-weekly-status-report_21.html>Kyua: Weekly status report</a></h2><p>This comes two days late... but anyway, I felt like posting it now instead of waiting until next Sunday/Monday.<br><br>The activity past week focused mostly on implementing support for the <tt>require.memory</tt> test-case metadata property recently introduced into ATF. This was non-trivial due to the need to write some tricky Autoconf code to make this "slightly portable".&nbsp;Seriously: It's scary to see how hard it is to perform, in a portable manner, an operation as simple as "query the amount of physical memory"... but oh well, such are the native Unix APIs...<br><br>I later spent the weekend on Lutok, preparing and publishing the project's first release and writing my first RPM library spec for it. This was a prerequisite for the upcoming 0.3 release of Kyua and thus deserved special attention!</p><p class=text-muted>February 1, 2012
&#183;
Tags:
<a href=/tags/kyua>kyua</a>, <a href=/tags/lutok>lutok</a>, <a href=/tags/report>report</a><br><a class=text-reset href=/2012/02/kyua-weekly-status-report_21.html>Continue reading (about
1 minute)</a></p></div></div><div class="media my-4"><img class=mr-3 src=/octicons/note.svg width=32px height=32px><div class=media-body><h2 class=mt-0><a href=/2012/01/lutok-01-available.html>Lutok 0.1 available</a></h2><p>A few months ago, I <a href=/2011/09/introducing-lutok-lightweight-c-api-for.html>introduced the Lutok project</a>,&nbsp;a simple C++ API for Lua. To recap: the major goal of this API, which does not mimic the Lua C API bit by bit, is to enforce correct coding practices on the client side. This is done by (ab)using the RAII programming pattern to automatically free resources when not needed and to ensure that the Lua stack is correctly managed. The library also adheres to common C++ programming idioms and exposes exceptions for error management and uses the pimpl idiom to completely hide the Lua C API from clients of Lutok (unless you use the <tt>c_gate</tt> backdoor!).<br><br>Today, I am pleased to announce that the first formal release of Lutok, obviously named 0.1, is available for download! You can obtain this release by visiting the <a href="http://code.google.com/p/lutok/downloads/detail?name=lutok-0.1.tar.gz">lutok-0.1.tar.gz download page</a>.<br><br>Also, in preparation for this release, I have spent the weekend writing <a href=http://code.google.com/p/lutok/wiki/Examples>some little example programs</a> to demonstrate the usage of Lutok, and also some&nbsp;<a href=http://code.google.com/p/lutok/wiki/Installation>installation instructions</a>.<br><br>Hope you find this release useful and please do send me any comments you may have!<br><br>Hint: Yes, releasing Lutok 0.1 was a prerequisite for Kyua 0.3. So stay tuned ;-)</p><p class=text-muted>January 29, 2012
&#183;
Tags:
<a href=/tags/lutok>lutok</a>, <a href=/tags/release>release</a><br><a class=text-reset href=/2012/01/lutok-01-available.html>Continue reading (about
1 minute)</a></p></div></div><div class="media my-4"><img class=mr-3 src=/octicons/note.svg width=32px height=32px><div class=media-body><h2 class=mt-0><a href=/2011/09/kyua-weekly-status-report-db-designdoc.html>Kyua: Weekly status report (db designdoc edition!)</a></h2><p><ul><li>Moved the code of <tt>utils::lua</tt> to a new project, <a href=http://code.google.com/p/lutok/>Lutok</a>.</li><li>Attempted to integrate a copy of Lutok into the Kyua source code to simplify installing Kyua. I have been playing with Subversion externals and Autoconf/Automake hacks to make this happen, but unfortunately haven't got a pleasant solution yet.</li><li>Modified Lutok to not expose the Lua C API at all from header files and cleaned up the Kyua code to cope with the changes.</li><li>Been chewing through the first chapters of the "<a href=http://www.amazon.com/Using-SQLite-Jay-Kreibich/dp/0596521189>Using SQLite</a>" book to refresh my SQL skills.</li><li>And, most importantly, wrote a <a href=http://code.google.com/p/kyua/wiki/DatabaseDesign>preliminary design document for the database store</a> of Kyua and the reporting features. Comments certainly welcome! Be aware that this is how <tt>atf-report</tt> will be replaced, so once this is done we should be able to finally kill <tt>atf-run</tt> and <tt>atf-report</tt> altogether :-)</li></ul></p><p class=text-muted>September 18, 2011
&#183;
Tags:
<a href=/tags/kyua>kyua</a>, <a href=/tags/lutok>lutok</a>, <a href=/tags/report>report</a><br><a class=text-reset href=/2011/09/kyua-weekly-status-report-db-designdoc.html>Continue reading (about
1 minute)</a></p></div></div><div class="media my-4"><img class=mr-3 src=/octicons/note.svg width=32px height=32px><div class=media-body><h2 class=mt-0><a href=/2011/09/name-your-c-auto-cleaners.html>Name your C++ auto-cleaners</a></h2><p>As you may already know, RAII is a very powerful and popular pattern in the C++ language. With RAII, you can wrap non-stack-managed resources into a stack-managed object such that, when the stack-managed object goes out of scope, it releases the corresponding non-stack-managed object. <a href="http://onlamp.com/pub/a/onlamp/2006/05/04/smart-pointers.html?page=1">Smart pointers</a> are just one example of this technique, but so are IO streams too.<br><br>Before getting into the point of the article, bear with me for a second while I explain what the&nbsp; <a href=http://code.google.com/p/lutok/source/browse/trunk/stack_cleaner.hpp><tt>stack_cleaner</tt></a> object of <a href=http://code.google.com/p/lutok/>Lutok</a> is. The "stack cleaner" takes a reference to a Lua state and records the height of the Lua stack on creation. When the object is destroyed (which happens when the declaring function exits), the stack is returned to its previous height thus ensuring it is clean. It is always a good idea for a function to prevent side-effects by leaving its outside world as it was — and, like it or not, the Lua state is part of the outside world because it is an input/output parameter to many functions.<br><br>Let's consider a piece of code <i>without</i> using the stack cleaner:<br><br><pre>void<br>my_function(lutok::state&amp; state, const int foo)<br>{<br>&nbsp;&nbsp;&nbsp; state.push_integer(foo);</pre><pre>&nbsp;&nbsp;&nbsp; ... do something else in the state ...<br>&nbsp;&nbsp;&nbsp; const int bar = state.to_integer();<br>&nbsp;&nbsp;&nbsp; if (bar != 3) {<br>&nbsp; &nbsp; &nbsp; &nbsp; state.pop(1); <br>&nbsp; &nbsp; &nbsp; &nbsp; throw std::runtime_error("Invalid data!");<br>&nbsp; &nbsp; }<br>&nbsp; &nbsp; state.pop(1);<br><br>}</pre><br>Note that we have had to call <tt>state.pop(1)</tt> from "all" exit points of the function to ensure that the stack is left unmodified upon return of <tt>my_function</tt>. Also note that "all exit points" may not be accurate: in a language that supports exceptions, any statement may potentially raise an exception so to be really safe we should do:<br><br><pre>void<br>my_function(lutok::state&amp; state, const int foo)<br>{<br>&nbsp;&nbsp;&nbsp; state.push_integer(foo);<br>&nbsp; &nbsp; try { <br>&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; ... do something else in the state ...<br>&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; const int bar = state.to_integer();<br>&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (bar != 3 <br>&nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp; throw std::runtime_error("Invalid data!");<br>&nbsp; &nbsp; } catch (...) {<br>&nbsp; &nbsp; &nbsp; &nbsp; state.pop(1);<br>&nbsp; &nbsp; &nbsp; &nbsp; throw;<br>&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp; state.pop(1);<br>}</pre><br>... which gets old very quickly. Writing this kind of code is error-prone and boring.<br><br>With an "auto-cleaner" object such as the <tt>stack_cleaner</tt>, we can simplify our code like this:<br><br><pre>void<br>my_function(lutok::state&amp; state, const int foo)<br>{<br>&nbsp; &nbsp; lutok::stack_cleaner cleaner(state);<br><br>&nbsp;&nbsp;&nbsp; state.push_integer(foo);<br>&nbsp;&nbsp;&nbsp; ... do something else in the state ...<br>&nbsp;&nbsp;&nbsp; const int bar = state.to_integer();<br>&nbsp;&nbsp;&nbsp; if (bar != 3) <br>&nbsp; &nbsp; &nbsp; &nbsp; throw std::runtime_error("Invalid data!"); <br>}</pre><br>And we leave the boring task of determining when to actually call <tt>state.pop(1)</tt> to the compiler and the runtime environment. In this particular case, no matter how the <tt>my_function</tt> terminates, we ensure that the Lua stack will be left as the same size as it was before.<br><br>But, as I said earlier, all this was just an introduction to the idea that made me write this post.<br><br>When you declare an auto-cleaner object of any kind, <i>be sure to give it a name</i>. It has happened to me a few times already that I have written the following construct:<br><br><pre>lutok::stack_cleaner(state);</pre><br>... which is syntactically correct, harmless and "looks good" if you don't look closely. The compiler will chew along just fine because, even though we are declaring an anonymous object, its constructor and destructor may be doing who-knows-what, so their code must be called and thus the "unused variable" warning cannot really be raised.<br><br><b>However</b> this does not give us the desired behavior. The cleaner object will be constructed and destructed in the same statement without having a chance to wrap any of the following code, because its scope is just the statement in which it was defined. In other words, the cleaner will have absolutely no effect on the rest of the function and thus will be useless.<br><br>So, moral of the story: always give a name to your auto-cleaner objects so that their scope is correctly defined and their destructor is run when you actually expect:<br><br><pre>lutok::stack_cleaner ANY_NAME_HERE(state);</pre></p><p class=text-muted>September 17, 2011
&#183;
Tags:
<a href=/tags/cxx>cxx</a>, <a href=/tags/lua>lua</a>, <a href=/tags/lutok>lutok</a><br><a class=text-reset href=/2011/09/name-your-c-auto-cleaners.html>Continue reading (about
4 minutes)</a></p></div></div><div class="media my-4"><img class=mr-3 src=/octicons/note.svg width=32px height=32px><div class=media-body><h2 class=mt-0><a href=/2011/09/introducing-lutok-lightweight-c-api-for.html>Introducing Lutok: A lightweight C++ API for Lua</a></h2><p>It has finally happened. <a href=http://code.google.com/p/lutok/>Lutok</a> is the result of what was promised in the "<a href=/2011/09/splitting-utilslua-from-kyua.html>Splitting utils::lua from Kyua</a>" web post.<br><br>Quoting the project web page:<br><blockquote>Lutok provides thin C++ wrappers around the Lua C API to ease the interaction between C++ and Lua. These wrappers make intensive use of RAII to prevent resource leakage, expose C++-friendly data types, report errors by means of exceptions and ensure that the Lua stack is always left untouched in the face of errors. The library also provides a small subset of miscellaneous utility functions built on top of the wrappers.<br><br>Lutok focuses on providing a clean and safe C++ interface; the drawback is that it is not suitable for performance-critical environments. In order to implement error-safe C++ wrappers on top of a Lua C binary library, Lutok adds several layers or abstraction and error checking that go against the original spirit of the Lua C API and thus degrade performance.<br><br>Lutok was originally developed within Kyua but was later split into its own project to make it available to general developers.</blockquote>Coming up with a name for this project was quite an odyssey, and is what has delayed is release more than I wanted. My original candidate was "luawrap" which, although not very original, was to-the-point and easy to understand. Unfortunately, that name did not clear with the legal department and I had to propose several other names, some of which were not acceptable either. Eventually, I settled with "Lutok", which comes from "LUa TOolKit".<br><br>At this point, the source tree of Lutok provides pretty much the same code as the <tt>utils::lua</tt> module of Kyua. While it may be enough to get you started, I'm pretty sure you will lack some functions in the <tt>state</tt> class. If that is the case, don't hesitate to file a bug report to let me know what is missing.<br><br>In case you missed the link above, the project page is here: <a href=http://code.google.com/p/lutok/>Lutok in Google Code</a>.</p><p class=text-muted>September 15, 2011
&#183;
Tags:
<a href=/tags/announce>announce</a>, <a href=/tags/cxx>cxx</a>, <a href=/tags/kyua>kyua</a>, <a href=/tags/lua>lua</a>, <a href=/tags/lutok>lutok</a><br><a class=text-reset href=/2011/09/introducing-lutok-lightweight-c-api-for.html>Continue reading (about
2 minutes)</a></p></div></div></div><div class="col-md-3 sidebar d-none d-md-block"><div class=row><div class="col text-center p-2"><p><a href=/about.html class=clear-link><img src=/images/avatars/20181124-snow.jpg class="rounded-circle shadow my-2" style=width:100px><br><b>Julio Merino</b><br>A blog on operating systems, programming languages, testing, build systems, my own software
projects and even personal productivity. Specifics include FreeBSD, Linux, Rust, Bazel and
EndBASIC.</a></p><div class=row><div class=col><div class=form-group><form action=https://endtracker.azurewebsites.net/api/sites/e8da9f62-b7ac-4fe9-bf20-7c527199a376/subscribers/add method=post><input type=text name=email placeholder="Enter your email" class="form-control input-sm text-center my-1">
<button type=submit class="btn btn-primary btn-block my-1">Subscribe</button></form></div></div></div><div class="row px-2"><div class="col-sm-5 text-left"><small><span class=subscriber-count>0</span> subscribers</small></div><div class="col-sm-7 text-right"><p><a rel=me href=https://mastodon.online/@jmmv><img src=/images/badges/mastodon-logo.svg width=32px height=32px alt="Follow @jmmv on Mastodon">
</a><a href="https://twitter.com/intent/follow?original_referer=https%3A%2F%2Fjmmv.dev%2F&amp;screen_name=jmmv"><img src=/images/badges/Twitter_logo_blue.svg width=32px height=32px alt="Follow @jmmv on Twitter">
</a><a href=/feed.xml><img src=/images/badges/feed-icon-28x28.png alt="RSS feed"></a></p></div></div></div></div><div class=row><div class=col><h2>Featured software</h2><ul><li class=overflow-ellipsis><a href=https://www.endbasic.dev/ target=_blank>EndBASIC: Online BASIC+DOS env</a></li><li class=overflow-ellipsis><a href=https://endtracker.azurewebsites.net/ target=_blank>EndTRACKER: Services for static sites</a></li></ul></div></div><div class=row><div class=col><h2>Featured posts</h2><ul><li class=overflow-ellipsis><a href=/2023/06/fast-machines-slow-machines.html>Fast machines, slow machines</a></li><li class=overflow-ellipsis><a href=/2022/12/endbasic-0.10.html>EndBASIC 0.10: Core language, evolved</a></li><li class=overflow-ellipsis><a href=/2022/10/bye-microsoft-hi-snowflake.html>Farewell, Microsoft; hello, Snowflake!</a></li><li class=overflow-ellipsis><a href=/2022/05/rust-is-hard-but-does-it-matter.html>Rust is hard, yes, but does it matter?</a></li><li class=overflow-ellipsis><a href=/2022/04/rust-traits-and-dependency-injection.html>Rust traits and dependency injection</a></li><li class=overflow-ellipsis><a href=/2022/03/a-year-on-windows-intro.html>A year on Windows: Introduction</a></li><li class=overflow-ellipsis><a href=/2021/04/always-be-quitting.html>Always be quitting</a></li><li class=overflow-ellipsis><a href=/2021/02/google-monorepos-and-caching.html>How does Google keep build times low?</a></li><li class=overflow-ellipsis><a href=/2020/12/google-no-clean-builds.html>How does Google avoid clean builds?</a></li><li class=overflow-ellipsis><a href=/2020/12/unit-testing-a-console-app.html>Unit-testing a console app (a text editor)</a></li><li class=overflow-ellipsis><a href=/essays.html#featured>More...</a></li></ul></div></div></div></div></div><footer class=container-fluid><div class=row><div class="col-4 order-2 text-right"><p class=float-right><a href=#>Back to top</a></p></div><div class="col-8 order-1 mr-auto"><p>Copyright 2004&ndash;2025
Julio Merino</p></div></div></footer><script type=module>
  import { addAnchorsToHeaders, addElementClasses, BatchClient } from "\/js\/main.0de73782e9e0fbcb4184fb5793949b3b0d0ada16455df89320415b4dcc052f88.js";

  var batchClient = new BatchClient(SITE_ID);
  batchClient.doAll({
    put_request: true, get_comments: true, get_subscriber_count: true, get_votes: true });

  window.voteThumbsUp = function() { batchClient.voteThumbsUp(); }
  window.voteThumbsDown = function() { batchClient.voteThumbsDown(); }

  window.postComment = function(...args) {
    batchClient.postComment(...args);
  };

  addAnchorsToHeaders();
  addElementClasses();
</script><noscript><img src="https://hugo-dynamic.jmmv.dev/api/sites/e8da9f62-b7ac-4fe9-bf20-7c527199a376/pages/aHR0cHM6Ly9qbW12LmRldi90YWdzL2x1dG9rL2luZGV4Lmh0bWw=/stamp.gif" style=display:none></noscript></body></html>