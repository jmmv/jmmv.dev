<!DOCTYPE html>
<html>
  <head>
    

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<!-- The above 3 meta tags *must* come first in the head; any other head
      content must come *after* these tags -->

<meta name="description"
      content="I don't know about other linkers, but GNU ld provides a very useful feature: link sets.  A link set is a list of symbols constructed during link time which c...">
<meta name="author" content="Julio Merino">

<meta content="http://julio.meroh.net/2005/09/linkers-link-sets.html" property="og:url">

<link rel="canonical" href="http://julio.meroh.net/2005/09/linkers-link-sets.html">
<link rel="alternate" type="application/rss+xml" title="Julio Merino" href="http://julio.meroh.net/feed.xml" />

<link rel="stylesheet" href="/css/main.css">

<!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
<!--[if lt IE 9]>
  <script src="/js/html5shiv-3.7.2.min.js"></script>
  <script src="/js/respond-1.4.2.min.js"></script>
<![endif]-->

    <title>Linker's link sets - Julio Merino</title>
    <meta content="Linker's link sets - Julio Merino" property="og:title">
  </head>

  <body>
    <header class="site-header">

<nav class="navbar navbar-default navbar-fixed-top">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed"
              data-toggle="collapse" data-target="#navbar"
              aria-expanded="false" aria-controls="navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">Julio Merino</a>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        
          
            
              
                <li><a class="page-link"
                href="/about/"
                >About</a></li>
              
            
          
        
          
            
              
                <li><a class="page-link"
                href="/essays/"
                >Essays</a></li>
              
            
          
        
          
            
              
                <li><a class="page-link"
                href="/software/"
                >Software</a></li>
              
            
          
        
          
            
              
                <li><a class="page-link"
                href="/work/"
                >Work</a></li>
              
            
          
        
      </ul>

      <form class="navbar-form navbar-right" method="get" role="search"
            action="http://www.google.com/search">
          <div class="form-group">
            <input type="text" name="query" class="form-control"
                   placeholder="Search">
            <input type="hidden" name="sitesearch" value="http://julio.meroh.net">
          </div>
          <button type="submit" value="Search" class="btn btn-default">
            <span class="glyphicon glyphicon-search" aria-hidden="true"></span>
          </button>
      </form>
    </div>
  </div>
</nav>

</header>


    <div class="page-header">
      <div class="container">
        <h1>Linker's link sets</h1>

        <p>Sun, 18 Sep 2005 12:19:00 +0000</p>

        
      </div>
    </div>

    <div class="container">
      <article>
        <p>I don't know about other linkers, but GNU ld provides a very useful feature: <i>link sets</i>.  A link set is a list of symbols constructed during <i>link time</i> which can then be inspected in regular code. This is very interesting in situations when you want to initialize several subsystems from a centralized place but don't know which of these will be available; that is, you don't know which ones will be in the final binary.</p>  <p>To illustrate this feature, let's see how NetBSD manages file system initialization. In NetBSD, you can configure which file systems you want in your kernel binary and which not. Each file system has a <tt>vfs_init</tt> hook that must be called during system initialization but... how to do this in a clean and extensible way? For a moment, imagine we didn't have link sets. In this case, NetBSD would need a function similar to the following:</p>  <pre>void<br />init_file_systems(void)<br />{<br />#ifdef UFS<br />   ufs_init();<br />#endif <p>#ifdef MSDOSFS<br />   msdosfs_init();<br />#endif </p><p>...</p>#ifdef TMPFS<br />   tmpfs_init();<br />#endif<br />}</pre><p></p>  <p>Isn't this ugly? Very much, although one might support the visual ugliness. However, the real problem is that, in order to add a new file system, you need to edit other parts of the system; this might seem acceptable in an open source project, but what if the initialization code was closed source? You couldn't add your file system. This clearly goes against extensibility.</p>  <p>Using link sets, this problem goes away: each independent module is able to add itself to a global list of symbols. Continuing our file systems example, take a look to the <tt>vfsinit</tt> function in <tt>kern/vfs_init.c</tt>.  The first thing you see there is the declaration (<tt>__link_set_decl</tt>) of a new link set, called <tt>vfsops</tt>, that will hold pointers to <tt>struct vfsops</tt> objects.  Then, the code uses the <tt>__link_set_foreach</tt> construction to iterate over the list, correctly initializing all the file systems.  The following is an extract of this, with <i>many</i> details removed:</p>  <pre>void<br />vfsinit(void)<br />{<br />   __link_set_decl(vfsops, struct vfsops);<br />   struct vfsops * const *vfsp;  /* Iterator */<br /><br />   __link_set_foreach(vfsp, vfsops) {<br />       (*vfsp)-&gt;vfs_init();<br />   }<br />}</pre><p></p>  <p>At last, how does a module add itself to the link set?  Using the <tt>__link_set_add_data</tt> operation, which takes the name of the link set as its first argument and the object to be added as the second one.  E.g.:</p>  <pre>struct vfsops barops = {<br />   ...<br />   ufs_init,<br />   ...<br />};<br />__link_set_add_data(vfsops, barops);</pre><p></p>  <p>As you can see, using link sets the kernel does not need to know at all which file systems are compiled into it, yet the initialization code will be executed.</p><p class="mobile-post"></p>

      </article>

      <div class="post-links">
        <p>
          

          

          <a href="/feed.xml">Subscribe
          via RSS</a>
          &middot;
          <a href="/blog/">Go to posts index</a>
        </p>

        <form class="form-inline"
            action="https://feedburner.google.com/fb/a/mailverify"
            method="post"
            target="popupwindow"
            onsubmit="window.open('https://feedburner.google.com/fb/a/mailverify?uri=jmmv', 'popupwindow', 'scrollbars=yes,width=550,height=520');return true">
          <div class="form-group form-group-sm">
            <input type="text" style="width: 400px" name="email"
                    placeholder="Enter your email to subscribe to new posts"
                    class="form-control input-sm"/>
          </div>
          <button type="submit" value="Subscribe"
                  class="btn btn-default btn-sm">
            <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>
          </button>
          &nbsp;&nbsp;&nbsp;Delivered by
          <input type="hidden" value="jmmv" name="uri"/>
          <input type="hidden" name="loc" value="en_US"/>
          <a href="https://feedburner.google.com" target="_blank">FeedBurner</a>
        </form>
      </div>

      
      <div id="disqus_thread">
        <script>
          var disqus_config = function () {
            this.page.url = "http://julio.meroh.net/2005/09/linkers-link-sets.html";
            this.page.identifier = "/2005/09/linkers-link-sets";
          };
          (function() { // DON'T EDIT BELOW THIS LINE
            var d = document, s = d.createElement('script');

            s.src = '//jmmv.disqus.com/embed.js';

            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
          })();
        </script>
        <noscript>Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments
          powered by Disqus.</a>
        </noscript>
      </div>
      
      <p>Comments from the original Blogger-hosted post:</p>
      <script src="https://apis.google.com/js/plusone.js"></script>
      <div class="g-comments"
           data-href="http://julipedia.meroh.net/2005/09/linkers-link-sets.html"
           data-first_party_property="BLOGGER"
           data-view_type="FILTERED_POSTMOD">
      </div>
      
      
    </div>

    <div class="container">
  <footer>
    <p class="pull-right"><a href="#">Back to top</a></p>
    <p>Copyright 2018 Julio Merino</p>
  </footer>
</div>

<script src="/js/jquery-1.11.2.min.js">
</script>
<script
  src="/css/bootstrap.min.js">
</script>

<script src="/js/auto-toc-1.0.0.dist.js">
</script>

<script>
$("p:contains('NOTE: ')").addClass("callout callout-info");
$("p:contains('IMPORTANT: ')").addClass("callout callout-info");
$("p:contains('WARNING: ')").addClass("callout callout-warning");
$("p:contains('DANGER: ')").addClass("callout callout-danger");
</script>


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;
  m.parentNode.insertBefore(a,m)})(window,document,'script',
  '//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-63557333-1', 'auto');
  ga('send', 'pageview');
</script>


  </body>
</html>
