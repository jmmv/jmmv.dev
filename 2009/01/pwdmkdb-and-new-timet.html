<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  

  <title>pwd_mkdb and the new time_t - Julio Merino</title>
  <meta content="pwd_mkdb and the new time_t - Julio Merino" property="og:title">

  
  <meta name="description" content="NetBSD-current has recently switched time_t to be a 64-bit type on all platforms to cope with the year-2038 problem. This is causing all sorts of trouble, and a problem I found yesterday was that, after a clean install of NetBSD/amd64, it was impossible to change the data of any user through chfn. The command failed with:
chfn: /etc/master.passwd: entry root inconsistent expire
chfn: /etc/master.passwd: unchanged
Suspiciously, the data presented by chfn showed an expiration date for root set in a seemingly-random day (October 14th, 2021).">
  <meta name="author" content="Julio Merino">
  <meta name="generator" content="Hugo 0.36.1" />

  <meta content="http://julio.meroh.net/2009/01/pwdmkdb-and-new-timet.html" property="og:url">

  <link rel="canonical" href="http://julio.meroh.net/2009/01/pwdmkdb-and-new-timet.html">
  <link rel="alternate" type="application/rss+xml"
        title="Julio Merino" href="/feed.xml" />

  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/chroma.css">

  
  <!--[if lt IE 9]>
    <script src="/js/html5shiv-3.7.2.min.js"></script>
    <script src="/js/respond-1.4.2.min.js"></script>
  <![endif]-->
</head>


  <body>
    <header class="site-header">

<nav class="navbar navbar-default navbar-fixed-top">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed"
              data-toggle="collapse" data-target="#navbar"
              aria-expanded="false" aria-controls="navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">Julio Merino</a>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        
          
            <li><a class="page-link" href="/about.html" >About</a></li>
          
        
          
            <li><a class="page-link" href="/essays.html" >Essays</a></li>
          
        
          
            <li><a class="page-link" href="/software.html" >Software</a></li>
          
        
          
            <li><a class="page-link" href="/work.html" >Work</a></li>
          
        
      </ul>

      <form class="navbar-form navbar-right" method="get" role="search"
            action="http://www.google.com/search">
          <div class="form-group">
            <input type="text" name="query" class="form-control"
                   placeholder="Search">
            <input type="hidden" name="sitesearch" value="http://julio.meroh.net/">
          </div>
          <button type="submit" value="Search" class="btn btn-default">
            <span class="glyphicon glyphicon-search" aria-hidden="true"></span>
          </button>
      </form>
    </div>
  </div>
</nav>

</header>


    <div class="page-header">
      <div class="container">
        <h1>pwd_mkdb and the new time_t</h1>

        <p>January 15, 2009</p>

        
      </div>
    </div>

    <div class="container">
      <article>
        NetBSD-current has recently switched time_t to be a 64-bit type on all platforms to cope with the year-2038 problem.  This is causing all sorts of trouble, and a problem I found yesterday was that, after a clean install of NetBSD/amd64, it was impossible to change the data of any user through chfn.  The command failed with:<br /><br /><tt>chfn: /etc/master.passwd: entry root inconsistent expire<br />chfn: /etc/master.passwd: unchanged</tt><br /><br />Suspiciously, the data presented by chfn showed an expiration date for root set in a seemingly-random day (October 14th, 2021).  That seemed like some part of the system not parsing the user database correctly and generating random values.  A sample test program that walked through the passwords database with <tt>getpwent(3)</tt> showed an invalid expiration date for root, even when <tt>/etc/master.passwd</tt> had a 0 in that field.<br /><br />After some debugging, I found out that libc tries to be compatible with old-format binary password databases (those generated by pwd_mkdb).  In order to deal with compatibility, libc checks to see if the database has a VERSION field set in it.  If not, it assumes it is an old version and thus time_t may not be 64-bit.  If the VERSION field is set, it uses the new time_t.<br /><br />So what was the problem?  pwd_mkdb did not set the VERSION field even though it wrote a new-format database.  libc assumed it was laid out according to the old format but it was not, so it got garbage data during parsing.  After some hacking, I fixed it as described <a href="http://mail-index.netbsd.org/current-users/2009/01/14/msg007274.html">in a post to current-users</a>.<br /><br />Soon after, Christos Zoulas (the one who did all the time_t work) told me that he had already done these changes in his branch but forgot to merge them.  He did now, and the code in the main branch should work fine.  I still think there is a <a href="http://mail-index.netbsd.org/current-users/2009/01/15/msg007292.html">minor problem</a> in it, but the major issue after installation should be gone.

      </article>

      <div class="post-links">
        <p>
          

          

          <a href="/feed.xml">Subscribe via RSS</a>
          &middot;
          <a href="/blog">Go to posts index</a>
        </p>

        <form class="form-inline"
            action="https://feedburner.google.com/fb/a/mailverify"
            method="post"
            target="popupwindow"
            onsubmit="window.open('https://feedburner.google.com/fb/a/mailverify?uri=jmmv', 'popupwindow', 'scrollbars=yes,width=550,height=520');return true">
          <div class="form-group form-group-sm">
            <input type="text" style="width: 400px" name="email"
                    placeholder="Enter your email to subscribe to new posts"
                    class="form-control input-sm"/>
          </div>
          <button type="submit" value="Subscribe"
                  class="btn btn-default btn-sm">
            <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>
          </button>
          &nbsp;&nbsp;&nbsp;Delivered by
          <input type="hidden" value="jmmv" name="uri"/>
          <input type="hidden" name="loc" value="en_US"/>
          <a href="https://feedburner.google.com" target="_blank">FeedBurner</a>
        </form>
      </div>

      <div id="disqus_thread">
        <script>
          var disqus_config = function () {
            this.page.url = "http:\/\/julio.meroh.net\/2009\/01\/pwdmkdb-and-new-timet.html";
            this.page.identifier = "2009-01-15-pwdmkdb-and-new-timet";
          };
          (function() { 
            var d = document, s = d.createElement('script');

            s.src = '//jmmv.disqus.com/embed.js';

            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
          })();
        </script>
        <noscript>Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments
          powered by Disqus.</a>
        </noscript>
      </div>
      
      <p>Comments from the original Blogger-hosted post:</p>
      <script src="https://apis.google.com/js/plusone.js"></script>
      <div class="g-comments"
           data-href="http://julipedia.meroh.net/2009/01/pwdmkdb-and-new-timet.html"
           data-first_party_property="BLOGGER"
           data-view_type="FILTERED_POSTMOD">
      </div>
      
    </div>

    <div class="container">
  <footer>
    <p class="pull-right"><a href="#">Back to top</a></p>
    <p>Copyright 2018 Julio Merino</p>
  </footer>
</div>

<script src="/js/jquery-1.11.2.min.js"></script>
<script src="/css/bootstrap.min.js"></script>

<script>
$("p:contains('NOTE: ')").addClass("callout callout-info");
$("p:contains('IMPORTANT: ')").addClass("callout callout-info");
$("p:contains('WARNING: ')").addClass("callout callout-warning");
$("p:contains('DANGER: ')").addClass("callout callout-danger");
</script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;
  m.parentNode.insertBefore(a,m)})(window,document,'script',
  '//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-63557333-1', 'auto');
  ga('send', 'pageview');
</script>

  </body>
</html>
