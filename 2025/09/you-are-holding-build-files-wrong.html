<!doctype html><html lang=en xmlns=http://www.w3.org/1999/xhtml xmlns:fb=http://ogp.me/ns/fb#><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta property="og:site_name" content="Julio Merino (jmmv.dev)"><meta property="twitter:site" content="@jmmv"><title>You are holding BUILD files wrong - Julio Merino (jmmv.dev)</title>
<meta property="og:title" content="You are holding BUILD files wrong - Julio Merino (jmmv.dev)"><meta property="twitter:title" content="You are holding BUILD files wrong - Julio Merino (jmmv.dev)"><meta name=description content="I&rsquo;ve heard it from people new to Bazel but also from people very familiar with the Bazel ecosystem: BUILD files must go away. And they must go away because they are redundant: they just repeat the dependency information that&rsquo;s already encoded in the in-code import/use statements.
Hearing this from newcomers to Bazel isn&rsquo;t surprising: after all, most newcomers are used to build tools that provide zero facilities to express dependencies across the sources of your own project. Hearing it from old-timers, however, is disappointing because it misses the point of what BUILD files can truly offer.
"><meta property="og:description" content="I&rsquo;ve heard it from people new to Bazel but also from people very familiar with the Bazel ecosystem: BUILD files must go away. And they must go away because they are redundant: they just repeat the dependency information that&rsquo;s already encoded in the in-code import/use statements.
Hearing this from newcomers to Bazel isn&rsquo;t surprising: after all, most newcomers are used to build tools that provide zero facilities to express dependencies across the sources of your own project. Hearing it from old-timers, however, is disappointing because it misses the point of what BUILD files can truly offer.
"><meta property="twitter:description" content="I&rsquo;ve heard it from people new to Bazel but also from people very familiar with the Bazel ecosystem: BUILD files must go away. And they must go away because they are redundant: they just repeat ‚Ä¶"><meta name=author content="Julio Merino"><meta property="twitter:creator" content="@jmmv"><meta name=generator content="Hugo 0.145.0"><meta property="og:url" content="https://jmmv.dev/2025/09/you-are-holding-build-files-wrong.html"><meta property="og:type" content="blog"><meta property="twitter:card" content="summary"><link rel=canonical href=https://jmmv.dev/2025/09/you-are-holding-build-files-wrong.html><link rel=alternate type=application/rss+xml title="Julio Merino (jmmv.dev)" href=/feed.xml><link rel=stylesheet href=/sass/main.min.cb91349cd93211a37e7d5dc131c35a170fc795721c03373cd05571327eea206b.css><link rel=stylesheet href=/css/chroma.css><link rel=icon type=image/png href=/images/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/images/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicons/favicon-96x96.png sizes=96x96><meta property="og:image" content="/images/2025-09-26-you-are-holding-build-files-wrong.jpg"><meta property="twitter:image" content="https://jmmv.dev/images/2025-09-26-you-are-holding-build-files-wrong.jpg"><script>const SITE_ID="e8da9f62-b7ac-4fe9-bf20-7c527199a376",BASE_URL="https://jmmv.dev/"</script></head><body><img src=https://hugo-dynamic.jmmv.dev/api/sites/e8da9f62-b7ac-4fe9-bf20-7c527199a376/pages/aHR0cHM6Ly9qbW12LmRldi8yMDI1LzA5L3lvdS1hcmUtaG9sZGluZy1idWlsZC1maWxlcy13cm9uZy5odG1s/stamp.gif style=display:none>
<script>window.location.replace("https://blogsystem5.substack.com/p/you-are-holding-build-files-wrong")</script><header class=site-header><nav class="navbar navbar-expand-md fixed-top navbar-dark bg-primary"><a class=navbar-brand href=/><img src=/images/favicons/favicon-30x30.png width=30 height=30 class="d-inline-block align-top" alt>
&nbsp;jmmv.dev
</a><button class=navbar-toggler type=button data-toggle=collapse data-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarSupportedContent><ul class="navbar-nav mr-auto"><li class=nav-item><a class=nav-link href=/about.html>About</a></li><li class=nav-item><a class=nav-link href=/blog.html>Blog</a></li><li class=nav-item><a class=nav-link href=/resume.html>Resume</a></li><li class=nav-item><a class=nav-link href=/software.html>Software</a></li></ul><ul class="navbar-nav mr-4"><li class=nav-item><a class=nav-link href=/archive.html>Archive</a></li><li class=nav-item><a class=nav-link href=/series.html>Series</a></li><li class=nav-item><a class=nav-link href=/tags.html>Tags</a></li></ul><form class=form-inline method=get role=search action=https://www.google.com/search><div class=input-group><input type=search name=query class=form-control placeholder=Search aria-label=Search><div class=input-group-append><button type=submit value=Search class="btn btn-light">
<img src=/octicons/search.svg></button></div></div><input type=hidden name=sitesearch value=https://jmmv.dev/></form></div></nav></header><div class=page-header><div class=container><h1>You are holding BUILD files wrong</h1><p>September 26, 2025 &#183;
About 7 minutes
&#183;
Tags:
<a href=/tags/bazel>bazel</a>, <a href=/tags/blogsystem5>blogsystem5</a>, <a href=/tags/opinion>opinion</a></p><p class=post-meta-p>This article was
<a href=https://blogsystem5.substack.com/p/you-are-holding-build-files-wrong>originally published
on Substack</a>
in the <a href=https://blogsystem5.substack.com/>Blog System/5 newsletter</a>
and is replicated here for archival purposes.</p><figure class=cover-image><img src=/images/2025-09-26-you-are-holding-build-files-wrong.jpg style=max-width:100%></figure></div></div><div class="container post-body"><div class=row><div class=col-md-9><div class=row><div class=col><article><p>I&rsquo;ve heard it from people new to Bazel but also from people very familiar with the Bazel ecosystem: BUILD files must go away. And they must go away because they are redundant: they just repeat the dependency information that&rsquo;s already encoded in the in-code import/use statements.</p><p>Hearing this from newcomers to Bazel isn&rsquo;t surprising: after all, most newcomers are used to build tools that provide zero facilities to express dependencies across the sources of your own project. Hearing it from old-timers, however, is disappointing because it misses the point of what BUILD files can truly offer.</p><p>In my opinion: if that&rsquo;s how you are writing BUILD files, you are holding them wrong. There is much more to BUILD files than mindlessly repeating import statement dependencies. Let&rsquo;s see why.</p><h1 id=the-problem>The problem</h1><p>Suppose you are given the following change to review:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-diff data-lang=diff><span class=line><span class=cl><span class=gd>--- a/src/main/com/example/compiler/parser/Parser.java
</span></span></span><span class=line><span class=cl><span class=gd></span><span class=gi>+++ b/src/main/com/example/compiler/parser/Parser.java
</span></span></span><span class=line><span class=cl><span class=gi></span><span class=gu>@@ -1,8 +1,10 @@
</span></span></span><span class=line><span class=cl><span class=gu></span> package com.example.compiler.parser;
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> import com.example.compiler.ast.Ast;
</span></span><span class=line><span class=cl><span class=gi>+import com.example.compiler.ast.Statement;
</span></span></span><span class=line><span class=cl><span class=gi></span> import com.example.compiler.lexer.Lexer;
</span></span><span class=line><span class=cl> import com.example.compiler.lexer.Token;
</span></span><span class=line><span class=cl><span class=gi>+import com.example.compiler.utils.FileReader;
</span></span></span><span class=line><span class=cl><span class=gi></span> 
</span></span><span class=line><span class=cl> // Parser for a simple language.
</span></span><span class=line><span class=cl> class Parser {
</span></span></code></pre></div><p>By looking at this diff, possibly from a Pull Request (PR) review, you can <em>guess</em> the following:</p><ul><li><p>The <code>com.example.compiler.parser</code> Java package already depends on the <code>com.example.compiler.ast</code> package.</p></li><li><p>The <code>com.example.compiler.parser</code> Java package already depends on the <code>com.example.compiler.lexer</code> package.</p></li><li><p>The addition of the <code>import com.example.compiler.ast.Statement</code> line does not modify the dependency graph: the edge from the <code>parser</code> package to the <code>ast</code> package existed beforehand, and this new import statement is just leveraging it.</p></li><li><p>The addition of the <code>import com.example.compiler.utils.FileReader</code> line is&mldr; uh, well, given this limited context, you just can&rsquo;t tell! Is it OK or is it not? Did <code>com.example.compiler.parser</code> <em>already depend on</em> <code>com.example.compiler.utils</code> via some other file in the same package&mdash;in which case this new import changes nothing dependency-wise&mdash;or did it not&mdash;in which case this new import deserves questioning from a high-level architecture perspective?</p></li></ul><h1 id=software-architecture>Software architecture</h1><p>The snippet I presented above is for Java but, in reality, the problem I described applies to every other language: all languages out there have some sort of import/use statements and all languages have some sort of mechanism to group code in module-like entities. By inspecting standalone changes at the file level, we cannot tell whether new cross-module dependencies are being introduced or not.</p><p>And being able to reason about modules is critical: we humans work best when we can reason about higher level relationships than files. We think of software as a collection of modules with layered dependencies and constraints that should not be violated. Enforcing these conceptual models via import/use statements is impossible, but the build graph&mdash;the very thing that BUILD files define&mdash;is the best place to encode them in a programmatic manner.</p><p>So: my point is that BUILD files give you a chance to encode the high-level architecture of your software project as a graph of dependencies that lives outside of the code. If you keep your BUILD files lean and human-managed, you have a good chance of detecting invalid dependencies from a layering perspective as soon as they are introduced.</p><p>The word &ldquo;lean&rdquo; in the previous paragraph is doing a lot of the heavy lifting though because by &ldquo;lean&rdquo; I mean simple BUILD files that define targets that map to concepts. This bypasses &ldquo;best practices&rdquo; that dictate one BUILD file per directory because you may need to use recursive globs to group sources into larger conceptual units, and this can also result in reduced build performance because you end up with fewer, larger targets. And that&rsquo;s fine.</p><p>For one, if recursive globs are a problem because they end up bundling too many related concepts in one target, you have got a problem with your directory structure and you should fix that. And for another, if larger targets end up hurting build performance, you have got a problem with your modularity and you should work towards breaking those big targets apart. At the end of the day, these two issues are symptoms of having too many unrelated concepts in one module. Simplifying the build structure may result in a transient performance regression, but working towards breaking those apart will help everyone in your organization.</p><p>None of this is novel though, as these ideas can be found outside of Bazel. Think about shared libraries in large C or C++ projects, multiple Maven modules in a large Java code base, or multiple crates in a large Rust project. If you have ever done any of these, you <em>know</em> that manually defining modules is useful because it forces you and your fellow developers to think in terms of APIs at the module boundaries.</p><p>Changing the module-level architecture of a project is something that happens infrequently and, when it does, you want the more senior people in the team to question and review such changes. And, for that, you must make these changes visible as soon as they happen.</p><h1 id=reverse-dependencies>Reverse dependencies</h1><p>Expressing modules in your build graph is great, but people seem to like having tools to automatically update dependencies based on code changes. This is not incompatible with what I have said so far, but in order to keep a clean software architecture, you will need to have a strong code review culture because any undesirable new edges introduced in a change will have to be vetted up at code review. But&mldr; what if they aren&rsquo;t? Can we do better?</p><p>Of course we can! Bazel gives us a way to express restrictions via reverse dependencies: aka <em>visibility rules</em>. When you maintain a conceptual dependency graph by hand, you will find cases where you want to express things like:</p><ul><li><p><code>com.example.compiler.utils</code> can be consumed from <code>com.example.compiler.lexer</code>, which is the lowest level layer of the compiler.</p></li><li><p><code>com.example.compiler.utils</code> cannot be consumed from any other layer unless we discuss the implications.</p></li></ul><p>Visibility rules allow you to express these restrictions programmatically. The difference with forward dependencies is that, if you ever wanted to use <code>com.example.compiler.utils</code> from a module that has not been pre-declared as an allowed consumer, you would need to modify the BUILD file definitions in <code>com.example.compiler.utils</code> to widen the visibility rules. This would require <em>talking</em> to the owners of such module, either in person or via the code review, to be allowed as a consumer of those APIs.</p><h1 id=putting-it-all-together>Putting it all together</h1><p>Now that we know the theory behind my proposal, let&rsquo;s revisit the <code>utils</code> package from the earlier example. To enforce our desired architecture, the <code>BUILD</code> file in <code>src/main/com/example/compiler/utils/BUILD</code> might look like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>java_library</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>name</span> <span class=o>=</span> <span class=s2>&#34;utils&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>srcs</span> <span class=o>=</span> <span class=n>glob</span><span class=p>([</span><span class=s2>&#34;*.java&#34;</span><span class=p>]),</span>
</span></span><span class=line><span class=cl>    <span class=n>visibility</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;//src/main/com/example/compiler/lexer:__pkg__&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>],</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></div><p>This is a &ldquo;lean&rdquo; <code>BUILD</code> file. It defines a single, conceptual <code>utils</code> library, and doesn&rsquo;t bother about specifying source files: it trusts that whatever you throw into the <code>com/example/compiler/utils/</code> directory truly belongs to that module. Most importantly, the <code>visibility</code> attribute declares that <em>only</em> code within the <code>lexer</code> package is allowed to depend on this <code>utils</code> library.</p><p>With this rule in place, the problematic code change we saw earlier (adding an <code>import</code> of <code>FileReader</code> to the <code>parser</code>) would no longer be a silent, ambiguous change. The moment the developer (or the CI system) tries to build the code, they would get an immediate, explicit error from Bazel stating that the <code>parser</code> target is not allowed to see the <code>utils</code> target.</p><p>The architectural violation is caught automatically. The desired conversation with the module owners is now forced to happen, exactly as intended.</p><h1 id=helping-ai-models>Helping AI models</h1><p>Finally, we get to the most hyped topic of all times: AI agents. Remember when I said above that a clean conceptual module-based architecture is critical for humans to understand how a project works? Well, guess what, the same applies to AI models.</p><p>If you try to use AI agents on an existing codebase, you will notice that they try to reason about the current architecture by reading individual file names and their contents, and then chasing through their file-level dependencies.</p><p>But what if you could make these AI agents to follow your conceptual dependency chain by teaching them, via an <a href=https://modelcontextprotocol.io/>MCP server</a>, to follow your build graph? Presumably, their ability to reason would increase because they&rsquo;d be faced with cleaner concepts that explain the story behind your codebase in big blocks.</p><h1 id=your-turn>Your turn</h1><p>I hope to have convinced you that manually managing your BUILD files in a Bazel project is <em>a good idea</em> for long-term maintainability and for the successful use of AI tools. For this to be possible, you have to forego the &ldquo;standard practice&rdquo; of having very small BUILD targets and instead capture your conceptual modular architecture in the build graph. And once you do that, BUILD files magically become manageable by humans, without the need for fancy automation that pushes complexity under the rug.</p><p>But that&rsquo;s just my opinion.</p></article></div></div><div class="container post-links"><div class=row><div class="col mr-auto text-left"><span><a href=https://jmmv.dev/2025/09/glibc-versions-bazel.html>&#171; Previous</a></span></div><div class="col text-center"><span><a href=/archive.html>All posts</a></span></div><div class="col ml-auto text-right"><span><a href=https://jmmv.dev/2025/11/bazelcon-2025-recap.html>Next &#187;</a></span></div></div></div><div class="container post-votes"><div class=row><div class="col-lg-4 my-2"><div class=row><div class=col><a onclick=voteThumbsUp() class="btn btn-block btn-outline-success" id=thumbs-up-btn>üëç
(<span id=thumbs-up-count>0</span>)</a></div><div class=col><a onclick=voteThumbsDown() class="btn btn-block btn-outline-danger" id=thumbs-down-btn>üëé
(<span id=thumbs-down-count>0</span>)</a></div></div></div><div class="col-lg-8 my-2 d-none d-sm-block"><div class=row><div class="col-md-4 text-center"><a href="https://www.reddit.com/submit?title=You+are+holding+BUILD+files+wrong&amp;url=https%3A%2F%2Fjmmv.dev%2F2025%2F09%2Fyou-are-holding-build-files-wrong.html" class="btn btn-block btn-outline-primary">Share on
<img src=/images/badges/reddit.png alt=Reddit width=24 height=24></a></div><div class="col-md-4 text-center"><a href="https://news.ycombinator.com/submitlink?t=You+are+holding+BUILD+files+wrong&amp;u=https%3A%2F%2Fjmmv.dev%2F2025%2F09%2Fyou-are-holding-build-files-wrong.html" class="btn btn-block btn-outline-primary">Share on
<img src=/images/badges/ycombinator.png alt="Hacker News" width=24 height=24></a></div><div class="col-md-4 text-center"><a href="https://twitter.com/intent/tweet?status=You+are+holding+BUILD+files+wrong+%E2%80%94+https%3A%2F%2Fjmmv.dev%2F2025%2F09%2Fyou-are-holding-build-files-wrong.html+%E2%80%94+cc+%40jmmv" class="btn btn-block btn-outline-primary">Share on
<img src=/images/badges/Twitter_Social_Icon_Circle_Color.png alt=Twitter width=24 height=24></a></div></div></div></div><div class="row my-4" id=postCommentRow><div class=col><div class=media><img class=mr-3 src=/octicons/pencil.svg width=32px height=32px><div class="media-body container"><form method=post id=newPost><div class=row><div class="col my-1"><textarea class=form-control rows=1 id=postCommentContent onclick=showPostComment() placeholder="Leave a comment"></textarea></div></div><div class="row newPostControls" style=display:none><div class="col my-1 form-group"><label for=postCommentAuthor>Your name (optional):</label>
<input type=text class=form-control id=postCommentAuthor></div></div><div class="row newPostControls" style=display:none><div class="col my-1 form-group"><label for=postCommentEmail>Your email (optional):</label>
<input type=text class=form-control type=email id=postCommentEmail>
<small class="form-text text-muted">Invisible to all readers; if provided, you will receive notifications when replied to (not implemented yet)</small></div></div><div class=row id=postCommentError style=display:none><div class="col mt-1 alert-danger"><p></p></div></div><div class="row newPostControls" style=display:none><button class="col-md-3 my-1 btn btn-primary" type=submit id=submitCommentButton>Post</button>
<small class="col-md-9 my-1 text-muted">Comments are subject to moderation. This feature is experimental and is powered by <a href=/software/endtracker.html>EndTRACKER</a>. If you experience any issues, please <a href=/about.html#contact>contact me off-band</a>.</small></div></form></div></div></div></div><script>function hidePostComment(){var t,e=document.getElementById("postCommentContent");e.rows=1,e.value="",t=document.getElementsByClassName("newPostControls"),Array.prototype.forEach.call(t,function(e){e.style.display="none"})}function showPostComment(){var e,t=document.getElementById("postCommentContent");t.rows=5,e=document.getElementsByClassName("newPostControls"),Array.prototype.forEach.call(e,function(e){e.style.display=""})}const form=document.querySelector("#newPost");form.onsubmit=function(e){e.preventDefault();let t=document.getElementById("postCommentAuthor").value,n=document.getElementById("postCommentEmail").value,s=document.getElementById("postCommentContent").value;postComment(t,n,s,hidePostComment)}</script></div></div><div class="col-md-3 sidebar d-none d-md-block"><div class=row><div class="col text-center p-2"><p><a href=/about.html class=clear-link><img src=/images/avatars/20181124-snow.jpg class="rounded-circle shadow my-2" style=width:100px><br><b>Julio Merino</b><br>A blog on operating systems, programming languages, testing, build systems, my own software
projects and even personal productivity. Specifics include FreeBSD, Linux, Rust, Bazel and
EndBASIC.</a></p><div class=row><div class=col><div class=form-group><form action=https://endtracker.jmmv.dev/api/sites/e8da9f62-b7ac-4fe9-bf20-7c527199a376/subscribers/add method=post><input type=text name=email placeholder="Enter your email" class="form-control input-sm text-center my-1">
<button type=submit class="btn btn-primary btn-block my-1">Subscribe</button></form></div></div></div><div class="row px-2"><div class="col-sm-5 text-left"><small><span class=subscriber-count>0</span> subscribers</small></div><div class="col-sm-7 text-right"><p><a rel=me href=https://mastodon.online/@jmmv><img src=/images/badges/mastodon-logo.svg width=32px height=32px alt="Follow @jmmv on Mastodon">
</a><a href="https://twitter.com/intent/follow?original_referer=https%3A%2F%2Fjmmv.dev%2F&amp;screen_name=jmmv"><img src=/images/badges/Twitter_logo_blue.svg width=32px height=32px alt="Follow @jmmv on Twitter">
</a><a href=/feed.xml><img src=/images/badges/feed-icon-28x28.png alt="RSS feed"></a></p></div></div></div></div><div class=row><div class=col><h2>Featured software</h2><ul><li class=overflow-ellipsis><a href=https://www.endbasic.dev/ target=_blank>EndBASIC: Online BASIC+DOS env</a></li><li class=overflow-ellipsis><a href=https://endtracker.jmmv.dev/ target=_blank>EndTRACKER: Services for static sites</a></li></ul></div></div><div class=row><div class=col><h2>Featured posts</h2><ul><li class=overflow-ellipsis><a href=/2023/06/fast-machines-slow-machines.html>Fast machines, slow machines</a></li><li class=overflow-ellipsis><a href=/2022/12/endbasic-0.10.html>EndBASIC 0.10: Core language, evolved</a></li><li class=overflow-ellipsis><a href=/2022/10/bye-microsoft-hi-snowflake.html>Farewell, Microsoft; hello, Snowflake!</a></li><li class=overflow-ellipsis><a href=/2022/05/rust-is-hard-but-does-it-matter.html>Rust is hard, yes, but does it matter?</a></li><li class=overflow-ellipsis><a href=/2022/04/rust-traits-and-dependency-injection.html>Rust traits and dependency injection</a></li><li class=overflow-ellipsis><a href=/2022/03/a-year-on-windows-intro.html>A year on Windows: Introduction</a></li><li class=overflow-ellipsis><a href=/2021/04/always-be-quitting.html>Always be quitting</a></li><li class=overflow-ellipsis><a href=/2021/02/google-monorepos-and-caching.html>How does Google keep build times low?</a></li><li class=overflow-ellipsis><a href=/2020/12/google-no-clean-builds.html>How does Google avoid clean builds?</a></li><li class=overflow-ellipsis><a href=/2020/12/unit-testing-a-console-app.html>Unit-testing a console app (a text editor)</a></li><li class=overflow-ellipsis><a href=/essays.html#featured>More...</a></li></ul></div></div></div></div></div><footer class=container-fluid><div class=row><div class="col-4 order-2 text-right"><p class=float-right><a href=#>Back to top</a></p></div><div class="col-8 order-1 mr-auto"><p>Copyright 2004&ndash;2025
Julio Merino</p></div></div></footer><script type=module>
  import { addAnchorsToHeaders, addElementClasses, BatchClient } from "\/js\/main.0de73782e9e0fbcb4184fb5793949b3b0d0ada16455df89320415b4dcc052f88.js";

  var batchClient = new BatchClient(SITE_ID);
  batchClient.doAll({
    put_request: true, get_comments: true, get_subscriber_count: true, get_votes: true });

  window.voteThumbsUp = function() { batchClient.voteThumbsUp(); }
  window.voteThumbsDown = function() { batchClient.voteThumbsDown(); }

  window.postComment = function(...args) {
    batchClient.postComment(...args);
  };

  addAnchorsToHeaders();
  addElementClasses();
</script></body></html>