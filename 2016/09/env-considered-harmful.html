<!DOCTYPE html>
<html>
  <head>
    

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<!-- The above 3 meta tags *must* come first in the head; any other head
      content must come *after* these tags -->

<meta name="description"
      content="Many programming guides recommend to begin scripts with the #! /usr/bin/env shebang in order to to automatically locate the necessary interpreter. For exampl...">
<meta name="author" content="Julio Merino">

<meta content="http://julio.meroh.net/2016/09/env-considered-harmful.html" property="og:url">

<link rel="canonical" href="http://julio.meroh.net/2016/09/env-considered-harmful.html">
<link rel="alternate" type="application/rss+xml" title="Julio Merino" href="http://julio.meroh.net/feed.xml" />

<link rel="stylesheet" href="/css/main.css">

<!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
<!--[if lt IE 9]>
  <script src="/js/html5shiv-3.7.2.min.js"></script>
  <script src="/js/respond-1.4.2.min.js"></script>
<![endif]-->

    <title>#! /usr/bin/env considered harmful - Julio Merino</title>
    <meta content="#! /usr/bin/env considered harmful - Julio Merino" property="og:title">
  </head>

  <body>
    <header class="site-header">

<nav class="navbar navbar-default navbar-fixed-top">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed"
              data-toggle="collapse" data-target="#navbar"
              aria-expanded="false" aria-controls="navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">Julio Merino</a>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        
          
            
              
                <li><a class="page-link"
                href="/about/"
                >About</a></li>
              
            
          
        
          
            
          
        
          
            
          
        
          
            
              
                <li><a class="page-link"
                href="/essays/"
                >Essays</a></li>
              
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
              
                <li><a class="page-link"
                href="/software/"
                >Software</a></li>
              
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
              
                <li><a class="page-link"
                href="/work/"
                >Work</a></li>
              
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
      </ul>

      <form class="navbar-form navbar-right" method="get" role="search"
            action="http://www.google.com/search">
          <div class="form-group">
            <input type="text" name="query" class="form-control"
                   placeholder="Search">
            <input type="hidden" name="sitesearch" value="http://julio.meroh.net">
          </div>
          <button type="submit" value="Search" class="btn btn-default">
            <span class="glyphicon glyphicon-search" aria-hidden="true"></span>
          </button>
      </form>
    </div>
  </div>
</nav>

</header>


    <div class="page-header">
      <div class="container">
        <h1>#! /usr/bin/env considered harmful</h1>

        <p><!-- From http://alanwsmith.com/jekyll-liquid-date-formatting-examples -->

September

14th,
  
2016
at
11:07 UTC
        
        </p>

        
      </div>
    </div>

    <div class="container">
      <article>
        <p>Many programming guides recommend to begin scripts with the <code class="highlighter-rouge">#! /usr/bin/env</code> <a href="https://en.wikipedia.org/wiki/Shebang_(Unix)">shebang</a> in order to to automatically locate the necessary interpreter. For example, for a Python script you would use <code class="highlighter-rouge"><span class="c">#! /usr/bin/env python</span></code>, and then the saying goes, the script would “just work” on any machine with Python installed.</p>

<p>The reason for this recommendation is that <code class="highlighter-rouge">/usr/bin/env python</code> will search the <code class="highlighter-rouge">PATH</code> for a program called <code class="highlighter-rouge">python</code> and execute the first one found… and that usually works fine <em>on one’s own machine</em>.</p>

<p>Unfortunately, this advice is plagued with problems and assuming it will work is wishful thinking. Let me elaborate. I’ll use Python below for illustration purposes but <strong>the following applies equally to any other interpreted language.</strong></p>

<h2 id="problems">Problems</h2>

<p><em>i)</em> The first problem is that <strong>using <code class="highlighter-rouge">#! /usr/bin/env</code> lets you find <em>an</em> interpreter but not necessarily the <em>correct</em> interpreter</strong>. In our example above, we told the system to look for an interpreter called <code class="highlighter-rouge">python</code>… but we did not say <em>anything</em> about the compatible versions. Did you want Python 2.x or 3.x? Or maybe “exactly 2.7”? Or “at least 3.2”? You can’t tell right? So the the computer can’t tell either; regardless, the script <em>will</em> probably run with whichever version happens to be called <code class="highlighter-rouge">python</code>–which could be <em>any</em> thanks to the <a href="https://wiki.debian.org/DebianAlternatives">alternatives system</a>. The danger is that, if the version is mismatched, the script will fail and the failure can manifest itself at a much later stage (e.g. a syntax error in an infrequent code path) under obscure circumstances.</p>

<p><em>ii)</em> The second problem, assuming you ignore the version problem above because your script is compatible with all possible versions (hah), is that <strong>you may pick up an interpreter that does not have all prerequisite dependencies installed</strong>. Say your script decides to import a bunch of third-party modules: where are those modules located? Typically, the modules exist in a centralized repository that is specific to the interpreter installation (e.g. a <code class="highlighter-rouge">.../lib/python2.7/site-packages/</code> directory that lives alongside the interpreter binary). So maybe your program found a Python 2.7 under <code class="highlighter-rouge">/usr/local/bin/</code> but in reality you needed it to find the one in <code class="highlighter-rouge">/usr/bin/</code> because that’s where all your Python modules are. If that happens, you’ll receive an obscure error that doesn’t properly describe the exact cause of the problem you got.</p>

<p><em>iii)</em> The third problem, assuming your script is portable to all versions (hah again) and that you don’t need any modules (really?), is that <strong>you are assuming that the interpreter is available via a specific name</strong>. Unfortunately, the name of the interpreter can vary. For example: pkgsrc installs all <code class="highlighter-rouge">python</code> binaries with explicitly-versioned names (e.g. <code class="highlighter-rouge">python2.7</code> and <code class="highlighter-rouge">python3.0</code>) to avoid ambiguity, and no <code class="highlighter-rouge">python</code> symlink is created by default… which means your script won’t run at all even when Python is seemingly installed.</p>

<p><em>iv)</em> The fourth problem is that <strong>you cannot pass flags to the interpreter</strong>. The shebang line is intended to contain the name of the interpreter plus a single argument to it. Using <code class="highlighter-rouge">/usr/bin/env</code> as the interpreter name consumes the first slot and the name of the interpreter consumes the second, so there is no room to pass additional flags to the program. What happens with the rest of the arguments is platform-dependent: they may be all passed as a single string to <code class="highlighter-rouge">env</code> or they may be tokenized as individual arguments. This is not a huge deal though: one argument for flags is too restricted anyway and you can usually set up the interpreter later from within the script.</p>

<p><em>v)</em> The fifth and worst problem is that <strong>your script is at the mercy of the user’s <em>environment</em> configuration</strong>. If the user has a “misconfigured” <code class="highlighter-rouge">PATH</code>, your script will mysteriously fail at run time in ways that you cannot expect and in ways that may be very difficult to troubleshoot later on. I quote “misconfigured” because the problem here is very subtle. For example: I do have a shell configuration that I carry across many different machines and various operating systems; such configuration has complex logic to determine a sane <code class="highlighter-rouge">PATH</code> regardless of the system I’m in… but this, in turn, means that the <code class="highlighter-rouge">PATH</code> can end up containing more than one version of the same program. This is fine for interactive shell use, but it’s not OK for any program to assume that my <code class="highlighter-rouge">PATH</code> will match their expectations.</p>

<p><em>vi)</em> The sixth and last problem is that <strong>a script prefixed with <code class="highlighter-rouge">#! /usr/bin/env</code> is not suitable to being installed</strong>. This is justified by all the other points illustrated above: once a program is installed on the system, it must behave deterministically no matter how it is invoked. More importantly, when you install a program, you do so under a set of assumptions gathered by a <code class="highlighter-rouge">configure</code>-like script or prespecified by a package manager. To ensure things work, the installed script must see the exact same environment that was specified at installation time. In particular, the script must point at the correct interpreter version and at the interpreter that has access to all package dependencies.</p>

<h2 id="so-what-to-do">So what to do?</h2>

<p>All this considered, you may still use <code class="highlighter-rouge">#! /usr/bin/env</code> for the <strong>convenience of your own throwaway scripts</strong> (those that don’t leave your machine) and also <strong>for documentation purposes and as a placeholder for a better default</strong>.</p>

<p>For anything else, here are some possible alternatives to using this harmful shebang:</p>

<ul>
  <li>
    <p>Patch up the scripts during the “build” of your software to point to the specific chosen interpreter based on a setting the user provided at <code class="highlighter-rouge">configure</code> time or one that you detected automatically. Yes, this means you need <code class="highlighter-rouge">make</code> or similar for a simple script, but these are the realities of the environment they’ll run under…</p>
  </li>
  <li>
    <p>Rely on the packaging system do the patching, which is pretty much what pkgsrc does automatically (and I suppose pretty much any other packaging system out there).</p>
  </li>
</ul>

<p><strong>Just don’t assume that the magic <code class="highlighter-rouge">#! /usr/bin/env foo</code> is sufficient or even correct</strong> for the final installed program.</p>

<p><em>Bonus chatter:</em> There is a myth that the original shebang prefix was <code class="highlighter-rouge">#! /</code> so that the kernel could look for it as a 32-bit magic cookie at the beginning of an executable file. I actually believed this myth for a long time… until today, as a couple of readers pointed me at <a href="http://www.in-ulm.de/~mascheck/various/shebang/">The <code class="highlighter-rouge">#!</code> magic, details about the shebang/hash-bang mechanism on various Unix flavours</a> with interesting background that contradicts this.</p>

      </article>

      <div class="post-links">
        <p>
          

          

          <a href="/feed.xml">Subscribe
          via RSS</a>
          &middot;
          <a href="/blog/">Go to posts index</a>
        </p>

        <form class="form-inline"
            action="https://feedburner.google.com/fb/a/mailverify"
            method="post"
            target="popupwindow"
            onsubmit="window.open('https://feedburner.google.com/fb/a/mailverify?uri=jmmv', 'popupwindow', 'scrollbars=yes,width=550,height=520');return true">
          <div class="form-group form-group-sm">
            <input type="text" style="width: 400px" name="email"
                    placeholder="Enter your email to subscribe to new posts"
                    class="form-control input-sm"/>
          </div>
          <button type="submit" value="Subscribe"
                  class="btn btn-default btn-sm">
            <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>
          </button>
          &nbsp;&nbsp;&nbsp;Delivered by
          <input type="hidden" value="jmmv" name="uri"/>
          <input type="hidden" name="loc" value="en_US"/>
          <a href="https://feedburner.google.com" target="_blank">FeedBurner</a>
        </form>
      </div>

      
      <div id="disqus_thread">
        <script>
          var disqus_config = function () {
            this.page.url = "http://julio.meroh.net/2016/09/env-considered-harmful.html";
            this.page.identifier = "/2016/09/env-considered-harmful";
          };
          (function() { // DON'T EDIT BELOW THIS LINE
            var d = document, s = d.createElement('script');

            s.src = '//jmmv.disqus.com/embed.js';

            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
          })();
        </script>
        <noscript>Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments
          powered by Disqus.</a>
        </noscript>
      </div>
      
      
    </div>

    <div class="container">
  <footer>
    <p class="pull-right"><a href="#">Back to top</a></p>
    <p>Copyright 2016 Julio Merino</p>
  </footer>
</div>

<script src="/js/jquery-1.11.2.min.js">
</script>
<script
  src="/css/bootstrap.min.js">
</script>

<script src="/js/auto-toc-1.0.0.dist.js">
</script>

<script>
$("p:contains('NOTE: ')").addClass("callout callout-info");
$("p:contains('IMPORTANT: ')").addClass("callout callout-info");
$("p:contains('WARNING: ')").addClass("callout callout-warning");
$("p:contains('DANGER: ')").addClass("callout callout-danger");
</script>


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;
  m.parentNode.insertBefore(a,m)})(window,document,'script',
  '//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-63557333-1', 'auto');
  ga('send', 'pageview');
</script>


  </body>
</html>
