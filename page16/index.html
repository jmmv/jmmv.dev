<!DOCTYPE html>
<html>
  <head>
    

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<!-- The above 3 meta tags *must* come first in the head; any other head
      content must come *after* these tags -->

<meta name="description"
      content="This is Julio Merino's homepage.  This site is primarily my personal blog and, secondarily, a gateway to my presence in the web.
">
<meta name="author" content="Julio Merino">

<meta content="http://julio.meroh.net/page16/" property="og:url">

<link rel="canonical" href="http://julio.meroh.net/page16/">
<link rel="alternate" type="application/rss+xml" title="Julio Merino" href="http://julio.meroh.net/feed.xml" />

<link rel="stylesheet" href="/css/main.css">

<!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
<!--[if lt IE 9]>
  <script src="/js/html5shiv-3.7.2.min.js"></script>
  <script src="/js/respond-1.4.2.min.js"></script>
<![endif]-->

    <title>Julio Merino</title>
    <meta content="Julio Merino" property="og:title">
  </head>

  <body>
    <header class="site-header">

<nav class="navbar navbar-default navbar-fixed-top">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed"
              data-toggle="collapse" data-target="#navbar"
              aria-expanded="false" aria-controls="navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">Julio Merino</a>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        
          
            
              
                <li><a class="page-link"
                href="/about/"
                >About</a></li>
              
            
          
        
          
            
          
        
          
            
          
        
          
            
              
                <li><a class="page-link"
                href="/essays/"
                >Essays</a></li>
              
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
              
                <li><a class="page-link"
                href="/software/"
                >Software</a></li>
              
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
              
                <li><a class="page-link"
                href="/work/"
                >Work</a></li>
              
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
      </ul>

      <form class="navbar-form navbar-right" method="get" role="search"
            action="http://www.google.com/search">
          <div class="form-group">
            <input type="text" name="query" class="form-control"
                   placeholder="Search">
            <input type="hidden" name="sitesearch" value="http://julio.meroh.net">
          </div>
          <button type="submit" value="Search" class="btn btn-default">
            <span class="glyphicon glyphicon-search" aria-hidden="true"></span>
          </button>
      </form>
    </div>
  </div>
</nav>

</header>


    <!-- We need these to be present early during load so we can avoid hiding
     or showing elements once the page has already been rendered. -->
<script src="/js/jquery-1.11.2.min.js">
</script>
<script src="/js/js.cookie-2.1.1.min.js">
</script>

<script>
  function loadMarketing() {
      var cookie = Cookies.get("marketing-visible");
      if (cookie === undefined || cookie === "true") {
        toggleMarketing(true);
      } else {
        toggleMarketing(false);
      }
  }

  function toggleMarketing(action) {
    if (action) {
      $("#collapse-row").show();
      $("#buttons").show();
      $("#expand-row").hide();
      Cookies.set("marketing-visible", "true", {path: ""});
    } else {
      $("#expand-row").show();
      $("#buttons").hide();
      $("#collapse-row").hide();
      Cookies.set("marketing-visible", "false", {path: ""});
    }
  }
</script>

<div class="page-header">
  <div class="container">
    <h1>Julio Merino</h1>

    <p>Software artist.  Writer aficionado.  Open source enthusiast.
    Runner.  Father of two.<br/>
    <strong>Currently:</strong> Senior Software Engineer at Google,
    New York City.</p>

    <div class="marketing row" style="display: none" id="buttons">
      <div class="col-md-3">
        <a href="/essays/">
          <span class="glyphicon glyphicon-print" aria-hidden="true"></span>
        </a>
        <h2>Author</h2>

        <p>Writer by hobby, typically covering programming topics.
        No fiction.  Find below for the most recent posts or
        open this section for general highlights.</p>
      </div>

      <div class="col-md-3">
        <a href="/software/">
          <span class="glyphicon glyphicon-cog" aria-hidden="true"></span>
        </a>
        <h2>Developer</h2>

        <p>Author of various Open Source projects and contributor to many
        more.  BSD enthusiast.  Motto: production software can be
        beautiful.</p>
      </div>

      <div class="col-md-3">
        <a href="/work/">
          <span class="glyphicon glyphicon-briefcase" aria-hidden="true"></span>
        </a>
        <h2>Engineer</h2>

        <p>Senior Software Engineer (and, previously, Senior Site Reliability
        Engineer) at Google in New York City.</p>
      </div>

      <div class="col-md-3">
        <a href="/about/">
          <span class="glyphicon glyphicon-envelope" aria-hidden="true"></span>
        </a>
        <h2>Social</h2>

        <p>Reachable via all the traditional contact mechanisms and the major
        social networks.  See my about page for all the references.</p>
      </div>
    </div>

    <div class="row" style="display: none" id="collapse-row">
      <p class="text-center"><small>
        <a href="javascript:toggleMarketing(false)">
          <span class="glyphicon glyphicon-chevron-up"
                aria-hidden="true"></span>
          Collapse
          <span class="glyphicon glyphicon-chevron-up"
                aria-hidden="true"></span>
        </a>
      </small></p>
    </div>

    <div class="row" style="display: none" id="expand-row">
      <p class="text-center"><small>
        <a href="javascript:toggleMarketing(true)">
          <span class="glyphicon glyphicon-chevron-down"
                aria-hidden="true"></span>
          Expand
          <span class="glyphicon glyphicon-chevron-down"
                aria-hidden="true"></span>
        </a>
      </small></p>
    </div>

    <!-- All the rows above were loaded hidden, so display only the needed
         ones now.  This ensures that we are able to render the page
         sequentially and prevent strange jumps during rendering. -->
    <script>loadMarketing();</script>
  </div>
</div>

<div class="container">
  <div class="row">
    <div class="col-md-9">
      

<ul class="post-list">
  
    <li>
      <h2>
        <a class="post-link" href="/2012/08/introducing-sysupgrade.html">Introducing sysupgrade for NetBSD</a>
      </h2>
      <span class="post-meta"><!-- From http://alanwsmith.com/jekyll-liquid-date-formatting-examples -->

August

6th,
  
2012
at
17:32 UTC
        &middot;
        <a href="/2012/08/introducing-sysupgrade.html#disqus_thread">
          <span class="disqus-comment-count"
                data-disqus-url="http://julio.meroh.net/2012/08/introducing-sysupgrade.html">Comments</span>
        </a>
      </span>
      
      <p>
        Over the last two weeks, you might have had fun rolling your own NetBSD binary releases with sysbuild. But what fun is that if you have no trivial way of upgrading your existing NetBSD installation to a newer version?Upgrading NetBSD to a newer version from distribution sets generally looks like the following;Fetch new distribution sets (or roll your own).Upgrade the kernel.Unpack the distribution sets over the root directory, without fat-fingering the command and unpacking etc.tgz along the way.Use etcupdate to merge new changes to configuration files.Use postinstall to validate the upgraded system.Simple? Yes. Easy? No. The above procedure is obscure to anyone new to NetBSD. (Actually, if you tell anybody that the way to upgrade your machine is by unpacking tarballs over / will stare at you thinking you are kidding. It's 2012.) "Jokes" aside, what is worse is that the procedure is quite monotonous and, therefore, it is very easy for the administrator to make a trivial mistake along the way and screw up a running system. (Been there, done that... multiple times.)Machines are made to automate trivial and repetitive tasks like the above, and they are actually very good at that. Over the years, I have performed NetBSD updates manually and later written crappy, unreliable scripts to do the upgrades for me. These scripts have never been reusable and they haven't dealt with error conditions gracefully. Furthermore, because these scripts live in my home directory, I have to remember to carry them around every time I set up a new NetBSD box.It was about time I sat down and rewrote my custom scripts into something more "decent". Something with documentation, with a configuration file, and with tests.So today, and for all the reason above, I am introducing sysupgrade.sysupgrade is a script that automates (trivializes) the whole process of upgrading an existing NetBSD installation to a newer release,&nbsp;be it the currently-running system or a non-live system. sysupgrade does so by following the steps outlined above and is coordinated by a configuration file. You can find the tool in pkgsrc/sysutils/sysupgrade, next to sysbuild. The bundled sysupgrade(8) and sysupgrade.conf(5) manual pages, and the default sysupgrade.conf configuration file should get you started and hopefully answer most of your questions.For the impatient, the following command would upgrade your machine to the specified version target:$ sysupgrade auto &nbsp; &nbsp; ftp://ftp.NetBSD.org/pub/NetBSD/NetBSD-&lt;X.Y.Z&gt;/$(uname -m)At the moment, please consider sysupgrade to be experimental. It works well for me on my various machines (running both NetBSD 6.0 BETA and -current), and I have been using the upgrade procedure outlined above for years without issues. However, as with any shiny-new software, be careful. If you use NetBSD on a virtual machine, take a snapshot before running this tool; I don't think your machine is going to blow up, but better safe than sorry!Enjoy, and feedback very welcome!PS: There is lots of room for improvement. The TODO file in the package directory includes some of the ideas I'd like to work on later.

        <a href="/2012/08/introducing-sysupgrade.html">[Continue reading]</a>
      </p>
      
    </li>
  
    <li>
      <h2>
        <a class="post-link" href="/2012/07/introducing-sysbuild-for-netbsd.html">Introducing sysbuild for NetBSD</a>
      </h2>
      <span class="post-meta"><!-- From http://alanwsmith.com/jekyll-liquid-date-formatting-examples -->

July

25th,
  
2012
at
12:26 UTC
        &middot;
        <a href="/2012/07/introducing-sysbuild-for-netbsd.html#disqus_thread">
          <span class="disqus-comment-count"
                data-disqus-url="http://julio.meroh.net/2012/07/introducing-sysbuild-for-netbsd.html">Comments</span>
        </a>
      </span>
      
      <p>
        NetBSD's build system is close to awesome: after checking a source tree out from CVS on virtually any Unix-like operating sytem, building a full NetBSD release for any of the supported platforms is as simple as running the build.sh script with the right arguments.There are, however, a few things that would deserve automation in this process, but that are not in build.sh's domain to solve. These are:Fetching and keeping the source tree up to date: interacting with CVS is still the responsibility of the user.Simplifying the call to build.sh: this script takes a ton of arguments, and running it by hand quickly becomes "annoying". It would be nice if all the desired values to its arguments where stored elsewhere and picked up automatically. (mk.conf may not always be the right choice.)Plugging into your crontab(5) for easy periodic rebuilds of NetBSD, with proper reporting of failures. Upgrading a live system from source is a major supported mechanism (particularly for NetBSD-current), so having a way to keep fresh release files around is welcome.Performing such daily rebuilds of NetBSD as a dedicated unprivileged user.To anybody familiar with NetBSD, it is obvious that all the above items are "simple enough" to solve one by one; however, doing them by hand gets old very quickly — machines exist to make our life easier, don't they? I know I am not the only one that has custom local wrapper scripts around build.sh, and I also know that my scripts were ad-hoc, ugly and non-reusable. (Also, of course, anybody new to NetBSD will certainly not find any of the above trivial, but that's secondary.)To this end, I have written a script that automates all the aforementioned steps in a single tool, driven by configuration files that specify what to do. Enter sysbuild. My setupThese days, my main NetBSD development box is a virtual machine. For a couple of years, I have been carrying around this virtual machine across machines and slowly tuning its configuration to suit my needs. The way I work is the following:I keep a read-write copy of the sources under my home directory, which is the one I use for my development work. This copy is accompanied by&nbsp;a script in my home directory that, given a machine type, updates the sources and rebuilds NetBSD for that machine type, using a known directory layout within my home directory.I also&nbsp;keep a read-only copy of the sources under /usr/src, checked out from anoncvs.&nbsp;This copy is used by the dedicated "builder" system user to perform dedicated rebuilds of NetBSD.&nbsp;The "builder" user also has a custom script (but different than the other one!) that updates /usr/src, rebuilds NetBSD for the machine types I am interested in, records full logs to files and places the build results into a shared network drive. Lastly, the dedicated "builder" user has a cron job that runs the previous script overnight.The purpose of this dual setup is to always have a fresh release build somewhere in the system, built from pristine sources, while at the same time allowing me to do my development work in a tree that I could break at any time.Unfortunately, the size of the virtual disk of my development box has become too small for my current needs, and in order to fix this I prefer to start afresh. The thought of having to set up this whole scheme all over again, by hand, is what triggered the creation of sysbuild. Getting startedsysbuild lives in pkgsrc under the pkgsrc/sysutils/sysbuild directory. This package provides the main script, tests, sample configuration files and the extensive manual page. Installing the script is as easy as installing any other package, and I would recommend reading its documentation now.Once installed, sysbuild should be ready to use out of the box assuming that you have write access to /usr/src. Simply typing sysbuild build from anywhere in the system will cause the source tree to be updated and a release for your current platform to be built.If you wish to customize the behavior of sysbuild, copy /usr/pkg/etc/sysbuild/default.conf to ~/.sysbuild/default.conf and edit the latter. The tool will pick it up on the next execution and use your new configuration settings. You can, of course, manage a variety of configurations in case you want to do different builds (say -current and 6.x). Setting up a daily cron jobThe&nbsp;pkgsrc/sysutils/sysbuild-user&nbsp;package is a convenience bundle that manages a "sysbuild" unprivileged user in the system and installs a sample crontab to perform the desired periodic rebuilds of NetBSD. This crontab uses the sysbuild4cron script, which is a very simple utility to run sysbuild, store its output in a file, and send an error report any time the execution fails.Simply installing the package will cause the creation of the "sysbuild" user and the configuration of this sample cron job. Follow the instructions provided by the package in its MESSAGE file to tune the behavior of any of these. Concluding triviaYes, these scripts are extremely tied to my particular workflow and use cases, although I don't think my needs are that special. However, I have attempted to come up with a generic-enough script and configuration file to allow the addition of new features.You may notice that sysbuild's version is 2.0 and not 1.0. While preparing the script for addition to pkgsrc, cvs add barfed that I was re-adding previously-deleted files. Uh hum, what a surprise! Upon reading the CVS log of the package's Makefile, I found that 10 years ago I already wrote this exact same script and that two years after it got deleted because it stopped working. I had completely forgotten about this! However, seeing pkg_comp's messy code (which was written around the same time), I imagine that the previous implementation of this idea was messy; I don't dare to look at the previous code.Enjoy!

        <a href="/2012/07/introducing-sysbuild-for-netbsd.html">[Continue reading]</a>
      </p>
      
    </li>
  
    <li>
      <h2>
        <a class="post-link" href="/2012/07/getting-rid-of-publictalkgooglecom.html">Getting rid of @public.talk.google.com GTalk contacts</a>
      </h2>
      <span class="post-meta"><!-- From http://alanwsmith.com/jekyll-liquid-date-formatting-examples -->

July

5th,
  
2012
at
13:38 UTC
        &middot;
        <a href="/2012/07/getting-rid-of-publictalkgooglecom.html#disqus_thread">
          <span class="disqus-comment-count"
                data-disqus-url="http://julio.meroh.net/2012/07/getting-rid-of-publictalkgooglecom.html">Comments</span>
        </a>
      </span>
      
      <p>
        If you use a native IM client to connect to Google Talk and also have a Google+ account, you probably have noticed by now that your contacts list is polluted by tons of addresses of the form annoyinghash@public.talk.google.com. Attempting to talk to these people from the native IM client does not work (maybe it does in some specific situations? I don't know.), so these contacts only add noise and annoyance.It turns out that these "spurious" contacts are the people that you have in your Google+ circles, and I suppose allows such people to talk to you when you are logged into Google+. Me, I don't necessarily want to allow all of these people in my chat list.After a bit of searching around, I have found that it is possible to remove them completely from your Google Talk list. Because all the answers I could find were incomplete and/or vague replies to forum questions, I'm writing the procedure down here for posterity.&nbsp;Do as follows:Log into your Google+ account.Sign into the builtin chat client on the right-hand side panel.Open the drop-down menu next to your name within the chat client and select Privacy settings.In the Choose who can chat with you option, select Custom.Unselect all the circle names in the checkboxes that appear.Click save.Witness all those useless contacts vanish from your IM clients! (Both native and web based.)

        <a href="/2012/07/getting-rid-of-publictalkgooglecom.html">[Continue reading]</a>
      </p>
      
    </li>
  
    <li>
      <h2>
        <a class="post-link" href="/2012/06/kyua-gets-its-own-blog.html">Kyua gets its own blog</a>
      </h2>
      <span class="post-meta"><!-- From http://alanwsmith.com/jekyll-liquid-date-formatting-examples -->

June

4th,
  
2012
at
22:25 UTC
        &middot;
        <a href="/2012/06/kyua-gets-its-own-blog.html#disqus_thread">
          <span class="disqus-comment-count"
                data-disqus-url="http://julio.meroh.net/2012/06/kyua-gets-its-own-blog.html">Comments</span>
        </a>
      </span>
      
      <p>
        For the last couple of weeks, I have been pondering the creation of a Kyua-specific blog. And, after a lot of consideration, I have finally taken the plunge. Say hello to Engineering Kyua!From now on, all Kyua-related posts (as well as ATF posts) will go to the new blog.&nbsp;I recommend you to subscribe to&nbsp;Engineering Kyua's Atom feed&nbsp;right now to not miss a beat! &nbsp;If you care enough about Kyua, that is...I may still post Kyua-related stuff in here once in a while, but you should assume that all news and, in particular, weekly status reports will be sent to the new blog."Why?" Well, The Julipedia is supposed to be (and always has) my personal blog. Looking back at all the recent posts, they almost univocally are about Kyua and there is no personal content in them. In respect for the readers of this blog (who may not care about Kyua at all) and in order to attempt to give Kyua a more definite identity, it makes sense to move the posts to their own blog.Also, by having a blog dedicated to Kyua, I will not feel uncomfortable about publishing weekly status reports again. I previously felt that they were adding too much noise to this blog, and is the main reason behind why I stopped posting them at some point. Weekly reports have their value, mostly to keep myself focused and to allow outsiders to know what the project is up to (particularly in a world of DVCSs, where code changes may be kept private for weeks at a time).And you may wonder: "will you continue to post content here?" Sure I will, but I need ideas (suggestions welcome)! Today's social ecosystem makes it difficult for me to decide whether a post belongs in a blog, in Google+, in Twitter... and updating them all at once to provide the same content is pointless.Here is my take: for most of the irrelevant stuff that one may want to share at a personal level (photos, videos, arbitrary thoughts), social networks seem to provide a better platform. The blog seems a place more suited for short essays that should be indexable and be accessible by users across the web; for example, these include how-tos, technical explanations for a particular concept, or opinion articles. And, finally, Twitter seems like the place to throw pointers to longer articles elsewhere and very short opinion comments. I think this summarizes pretty well what my current "practices" around these systems follow. And, as you can deduce, this also explains (as you have experienced) why the blog gets fewer content than ever because most things are better suited for a social network.

        <a href="/2012/06/kyua-gets-its-own-blog.html">[Continue reading]</a>
      </p>
      
    </li>
  
    <li>
      <h2>
        <a class="post-link" href="/2012/06/exposing-configuration-tree-through-lua.html">Exposing a configuration tree through Lua</a>
      </h2>
      <span class="post-meta"><!-- From http://alanwsmith.com/jekyll-liquid-date-formatting-examples -->

June

3rd,
  
2012
at
00:47 UTC
        &middot;
        <a href="/2012/06/exposing-configuration-tree-through-lua.html#disqus_thread">
          <span class="disqus-comment-count"
                data-disqus-url="http://julio.meroh.net/2012/06/exposing-configuration-tree-through-lua.html">Comments</span>
        </a>
      </span>
      
      <p>
        In the previous post, I discussed the&nbsp;type-safe tree data structure&nbsp;that is now in the Kyua codebase, aimed at representing the configuration of the program. In this post, we'll see how this data structure ties to the parsing of the configuration file.One goal in the design of the configuration file was to make its contents a simple key/value association (i.e. assigning values to predetermined configuration variables). Of course, the fact that the configuration file is just a Lua script means that additional constructions (conditionals, functions, etc.) can be used to compute these values before assignment, but in the end all we want to have is a collection of values for known keys. The tree data structure does exactly the latter: maintain the mapping of keys to values, and ensuring that only a set of "valid" keys can be set. But, as a data structure, it does not contain any of the "logic" involved in computing those values: that is the job of the script.Now, consider that we have the possible following syntaxes in the configuration file:simple_variable = "the value"complex.nested.variable = "some other value"These assignments map, exactly, to a tree::set() function call: the name of the key is passed as the first argument to tree::set() and the value is passed as the second argument. (Let's omit types for simplicity.) What we want to do is modify the Lua environment so that these assignments are possible, and that when such assignments happen, the internal tree object gets updated with the new values.In order to achieve this, the configuration library modifies the Lua environment as follows:The newindex metatable method of _G is overridden so that an assignment causes a direct call to the set method of the referenced key.  The key name is readily available in the newindex arguments, so no further magic is needed.  This handles the case of "a = b" (top-level variables).The index metatable method of _G is overridden so that, if the indexed element is not found, a new table is generated and injected into _G.  This new table has a metatable of its own that performs the same operations as the newindex and index herein described.  This handles the case of "a.b = c", as this trick causes the intermediate tables (in this case "a") to be transparently created.Each of the tables created by index has a "key" metatable field that contains the fully qualified key of the node the table corresponds to.  This is necessary to be able to construct the full key to pass to the set method.There is further magic to ensure that values pre-populated in the tree (aka default values) can be queried from within Lua, and that variables can be set more than once. These details are uninteresting though.At the moment, we deny setting variables that have not been pre-defined in the tree structure, which means that if the user wants to define auxiliary variables or functions, these must be declared local to prevent calling into the _G hooks. This is quite nice, but we may need to change this later on if we want to export the standard Lua modules to the configuration files.

        <a href="/2012/06/exposing-configuration-tree-through-lua.html">[Continue reading]</a>
      </p>
      
    </li>
  
    <li>
      <h2>
        <a class="post-link" href="/2012/05/type-safe-dynamic-tree-data-type.html">Type-safe, dynamic tree data type</a>
      </h2>
      <span class="post-meta"><!-- From http://alanwsmith.com/jekyll-liquid-date-formatting-examples -->

May

29th,
  
2012
at
23:06 UTC
        &middot;
        <a href="/2012/05/type-safe-dynamic-tree-data-type.html#disqus_thread">
          <span class="disqus-comment-count"
                data-disqus-url="http://julio.meroh.net/2012/05/type-safe-dynamic-tree-data-type.html">Comments</span>
        </a>
      </span>
      
      <p>
        The core component of the new configuration library in Kyua is the utils::config::tree class: a type-safe, dynamic tree data type.  This class provides a mapping of string keys to arbitrary types: all the nodes of the tree have a textual name, and they can either be inner nodes (no value attached to them), or leaf nodes (an arbitrary type attached as a value to them). The keys represent traversals through such tree, and do this by separating the node names with dots (things of the form root.inner1.innerN.leaf).The tree class is the in-memory representation of a configuration file, and is the data structure passed around methods and algorithms to tune their behavior. It replaces the previous config static structure.The following highlights describe the tree class:Keys are (and thus the tree layout is) pre-registered. One side-effect of moving away from a static C++ structure as the representation of the configuration to a dynamic structure such as a tree is that the compiler cannot longer validate the name of the configuration settings when they are queried.  In the past, doing something like config.architecture would only compile if architecture was a valid structure defined... but now, code like config["architecture"] cannot be validated during the build.In order to overcome this limitation, trees must have their keys pre-defined.  Pre-defining the keys declares their type within the tree. &nbsp;Accesses to unknown keys results in an error right away, and accesses to pre-defined keys must always happen with their pre-recorded types.Note that pre-defined nodes can, or cannot, hold a value. The concept of "being set" is different than "being defined".Some nodes can be dynamic. Sometimes we do not know what particular keys are valid within a context. For example, the test_suites subtree of the configuration can contain arbitrary test suite names and properties within it, and there is no way for Kyua (at the moment) to know what keys are valid or not.As a result, the tree class allows defining a particular node as "dynamic", at which point accesses to any undefined keys below that node result in the creation of the node.Type safety. Every node has a type attached to it. The base configuration library provides common types such as bool_node, int_node and string_node, but the consumer can define its own node types to hold any other kind of data type.  (It'd be possible, for example, to define a map_node to hold a full map as a tree leaf.)The "tricky" (and cool) part of type safety in this context is to avoid exposing type casts to the caller: the caller always knows what type corresponds to every key (because, remember, the caller had to predefine them!), so it knows what type to expect from every node. The tree class achieves this by using template methods, which just query the generic internal nodes and cast them out (after validation) to the requested type.Plain string representations. The end user has to be able to provide overrides to configuration properties through the command line... and the command line is untyped: everything is a string.  The tree library, therefore, needs a mechanism to internalize strings (after validation) and convert them to the particular node types.  Similarly, it is interesting to have a way to export the contents of a tree to strings so that they can be shown to the user.With that said, let's see a couple of examples.  First, a simple one. Let's create a tree with a couple of fictitious nodes (one a string, one an integer), set some values and then query such values:config::tree tree;// Predefine the valid keys.tree.define&lt; config::string_node &gt;("kyua.architecture");tree.define&lt; config::int_node &gt;("kyua.timeout");// Populate the tree with some sample values.tree.set&lt; config::string_node &gt;("kyua.architecture", "powerpc");tree.set&lt; config::int_node &gt;("kyua.timeout", 300);// Query the sample values.const std::string architecture =    tree.lookup&lt; config::string_node &gt;("kyua.architecture");const int timeout =    tree.lookup&lt; config::int_node &gt;("kyua.timeout");Yep, that's it.  Note how the code just knows about keys and their types, but does not have to mess around with type casts nor tree nodes. And, if there is any typo in the property names or if there is a type mismatch between the property and its requested node type, the code will fail early. This, coupled with extensive unit tests, ensures that configuration keys are always queried consistently.Note that we'd also have set the keys above as follows:tree.set_string("kyua.architecture", "powerpc");tree.set_string("kyua.timeout", "300");... which would result in the validation of "300" as a proper integer, conversion of it to a native integer, and storing the resulting number as the integer node it corresponds to.  This is useful, again, when reading configuration overrides from the command line as types are not known in that context yet we want to store their values in the same data structure as the values read from the configuration file.Let's now see another very simple example showcasing dynamic nodes (which is a real-life example from the current Kyua configuration file):config::tree tree;// Predefine a subtree as dynamic.tree.define_dynamic("test_suites");// Populate the subtree with fictitious values.tree.set&lt; config::string_node &gt;("test_suites.NetBSD.ffs", "ext2fs");tree.set&lt; config::int_node &gt;("test_suites.NetBSD.iterations", 5);// And the querying would happen exactly as above with lookup().Indeed, it'd be very cool if this tree type followed more standard STL conventions (iterators, for example).  But I didn't really think about this when I started writing this class and, to be honest, I don't need this functionality.Now, if you paid close attention to the above, you can start smelling the relation of this structure to the syntax of configuration files. I'll tell you how this ties together with Lua in a later post. (Which may also explain why I chose this particular representation.)

        <a href="/2012/05/type-safe-dynamic-tree-data-type.html">[Continue reading]</a>
      </p>
      
    </li>
  
    <li>
      <h2>
        <a class="post-link" href="/2012/05/rethinking-kyuas-configuration-system.html">Rethinking Kyua's configuration system</a>
      </h2>
      <span class="post-meta"><!-- From http://alanwsmith.com/jekyll-liquid-date-formatting-examples -->

May

28th,
  
2012
at
23:48 UTC
        &middot;
        <a href="/2012/05/rethinking-kyuas-configuration-system.html#disqus_thread">
          <span class="disqus-comment-count"
                data-disqus-url="http://julio.meroh.net/2012/05/rethinking-kyuas-configuration-system.html">Comments</span>
        </a>
      </span>
      
      <p>
        In the&nbsp;previous blog post, I described the problems that the implementation of the Kyua configuration file parsing and in-memory representation posed. I also hinted that some new code was coming and, after weeks of work, I'm happy to say that it has just landed in the tree!I really want to get to explaining the nitty-gritty details of the implementation, but I'll keep these for later. Let's focus first on what the goals for the new configuration module were, as these drove a lot of the implementation details:Key/value pairs representation: The previous configuration system did this already, and it is a pretty good form for a configuration file because it is a simple, understandable and widespread format. Note that I have not said anything yet about the types&nbsp;of the values.Tree-like representation: The previous configuration schema grouped test-suite specific properties under a "test_suites" map while it left internal run-time properties in the global namespace. The former is perfect and the latter was done just for simplicity. I want to move towards a tree of properties to give context to each of them so that they can be grouped semantically (e.g. kyua.report.*, kyua.runtime.*, etc.). The new code has not changed the structure of the properties yet (to remain compatible with previous files), but it adds very simple support to change this in the shortcoming future.Single-place parsing and validation: A configuration file is an external representation of a set of properties. This data is read (parsed) once and converted into an in-memory representation. All validation of the values of the properties must happen at this stage, and not when the properties are queried. The reason is that validation of external values must be consistent and has to happen in a controlled location (so that errors can all be reported at the same time).I have seen code in other projects where the configuration file is stored in memory as a set of key/value string pairs and parsing to other types (such as integers, etc.) is delayed until the values are used. The result is that, if a property is queried more than once, the validation will be implemented in different forms, each with its own bugs, which will result in dangerous inconsistencies.Type safety: This is probably the trickiest bit. Every configuration node must be stored in the type that makes most sense for its value. For example: a timeout in seconds is an integer, so the in-memory representation must be an integer. Or another example: the type describing the "unprivileged user" is a data structure that maps to a system user, yet the configuration file just specifies either a username or a UID.Keeping strict type validation in the code is interesting because it helps to ensure that parsing and validation happen in just a single place: whenever the configuration file is read, every property will have to be converted to its in-memory type, and this means that the validation can only happen at that particular time. Once the data is in memory, we can and have to assume that it is valid. Additionally, strict types ensure that the code querying such properties uses the values as intended, without having to do additional magic to map them to other types.Extensibility: Parsing a configuration file is a very generic concept, yet the previous code made the mistake of tying this logic with the specific details of Kyua configuration files. A goal of the new code has been to write a library that parses configuration files, and allows the Kyua-specific code to define the schema of the configuration file separately. (No, the library is not shipped separately at this point; it's placed in its own utils::config module.)With all this code in place, there are a bunch of things that can now be easily implemented. Consider the following:Properties to define the timeout of test cases depending on their size (long-standing issue 5).Properties to tune the UI behavior: width of the screen, whether to use color or not (no, there is no color support yet), etc.Properties to configure how reports look like "by default": if you generate reports of any form frequently, it is very likely that you will want them to look the same every time and hence you will want to define the report settings once in the configuration file.Hooks: one of the reasons for using Lua-based configuration files was to allow providing extra customization abilities to the user. Kyua could theoretically call back into Lua code to perform particular actions, and such actions could be explicitly stated by the user in the form of Lua functions. Neither the current configuration code nor Kyua has support for hooks, but the new implementation makes it rather easy to add them.And that's all for today. Now that you know what the current code is trying to achieve and why, we will be able to look at how the implementation does all this in the next posts.

        <a href="/2012/05/rethinking-kyuas-configuration-system.html">[Continue reading]</a>
      </p>
      
    </li>
  
</ul>


<script id="dsq-count-scr" src="//jmmv.disqus.com/count.js" async></script>



      <div class="pagination">
        
          <span class="previous"><a
          href="/page15">&laquo;
          Newer posts</a></span>
        

        <!-- Disabled to not show a page count, which is meaningless.
        <span class="current">Page 16 of
        101</span>
        -->

        
          <span class="next"><a
          href="/page17">Older posts
          &raquo;</a></span>
        
      </div>
    </div>
    <div class="col-md-3 sidebar">
      <div class="row">
  <h2>Blog subscription</h2>

  <form class="feedburner form-horizontal"
        action="https://feedburner.google.com/fb/a/mailverify"
        method="post"
        target="popupwindow"
        onsubmit="window.open('https://feedburner.google.com/fb/a/mailverify?uri=jmmv', 'popupwindow', 'scrollbars=yes,width=550,height=520');return true">
    <div class="form-group">
      <div class="col-sm-10">
        <input type="text" name="email"
               placeholder="Enter your email" class="form-control"/>
      </div>
      <button type="submit" value="Subscribe" class="btn btn-default col-sm-2">
        <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>
      </button>
    </div>
    <input type="hidden" value="jmmv" name="uri"/>
    <input type="hidden" name="loc" value="en_US"/>
    <p>
      <small>Subscription by
      <a href="https://feedburner.google.com"
      target="_blank">FeedBurner</a></small>
    </p>
  </form>

  <p class="text-center"><a
  href="/feed.xml">RSS feed</a></p>

  <p class="text-center">
    <a href="https://twitter.com/jmmv"
    class="twitter-follow-button"
    data-show-count="false"
    data-size="large">Follow @jmmv</a>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
  </p>
</div>

<div class="row archive">
  <h2>Archive</h2>

  

  <ul>
  <li>
    <a data-toggle="collapse" href="#archive-year-2017">2017</a> (2)
     
    <ul id="archive-year-2017" class="collapse">
     
      <li><a href="/2017/02">February 2017</a> (2)</li>
      <li><a href="/2017">All year</a></li>
    </ul>
  </li>
  <li>
    <a data-toggle="collapse" href="#archive-year-2016">2016</a> (8)
     
    <ul id="archive-year-2016" class="collapse">
     
      <li><a href="/2016/09">September 2016</a> (1)</li>
      <li><a href="/2016/05">May 2016</a> (1)</li>
      <li><a href="/2016/04">April 2016</a> (1)</li>
      <li><a href="/2016/03">March 2016</a> (2)</li>
      <li><a href="/2016/02">February 2016</a> (1)</li>
      <li><a href="/2016/01">January 2016</a> (2)</li>
      <li><a href="/2016">All year</a></li>
    </ul>
  </li>
  <li>
    <a data-toggle="collapse" href="#archive-year-2015">2015</a> (17)
     
    <ul id="archive-year-2015" class="collapse">
     
      <li><a href="/2015/12">December 2015</a> (2)</li>
      <li><a href="/2015/10">October 2015</a> (2)</li>
      <li><a href="/2015/09">September 2015</a> (3)</li>
      <li><a href="/2015/06">June 2015</a> (2)</li>
      <li><a href="/2015/05">May 2015</a> (3)</li>
      <li><a href="/2015/04">April 2015</a> (1)</li>
      <li><a href="/2015/03">March 2015</a> (1)</li>
      <li><a href="/2015/02">February 2015</a> (3)</li>
      <li><a href="/2015">All year</a></li>
    </ul>
  </li>
  <li>
    <a data-toggle="collapse" href="#archive-year-2014">2014</a> (12)
     
    <ul id="archive-year-2014" class="collapse">
     
      <li><a href="/2014/11">November 2014</a> (2)</li>
      <li><a href="/2014/06">June 2014</a> (1)</li>
      <li><a href="/2014/05">May 2014</a> (2)</li>
      <li><a href="/2014/03">March 2014</a> (1)</li>
      <li><a href="/2014/02">February 2014</a> (3)</li>
      <li><a href="/2014/01">January 2014</a> (3)</li>
      <li><a href="/2014">All year</a></li>
    </ul>
  </li>
  <li>
    <a data-toggle="collapse" href="#archive-year-2013">2013</a> (62)
     
    <ul id="archive-year-2013" class="collapse">
     
      <li><a href="/2013/12">December 2013</a> (7)</li>
      <li><a href="/2013/11">November 2013</a> (7)</li>
      <li><a href="/2013/10">October 2013</a> (7)</li>
      <li><a href="/2013/09">September 2013</a> (13)</li>
      <li><a href="/2013/08">August 2013</a> (9)</li>
      <li><a href="/2013/07">July 2013</a> (10)</li>
      <li><a href="/2013/06">June 2013</a> (9)</li>
      <li><a href="/2013">All year</a></li>
    </ul>
  </li>
  <li>
    <a data-toggle="collapse" href="#archive-year-2012">2012</a> (29)
     
    <ul id="archive-year-2012" class="collapse">
     
      <li><a href="/2012/10">October 2012</a> (1)</li>
      <li><a href="/2012/09">September 2012</a> (1)</li>
      <li><a href="/2012/08">August 2012</a> (3)</li>
      <li><a href="/2012/07">July 2012</a> (2)</li>
      <li><a href="/2012/06">June 2012</a> (2)</li>
      <li><a href="/2012/05">May 2012</a> (3)</li>
      <li><a href="/2012/04">April 2012</a> (1)</li>
      <li><a href="/2012/03">March 2012</a> (1)</li>
      <li><a href="/2012/02">February 2012</a> (10)</li>
      <li><a href="/2012/01">January 2012</a> (5)</li>
      <li><a href="/2012">All year</a></li>
    </ul>
  </li>
  <li>
    <a data-toggle="collapse" href="#archive-year-2011">2011</a> (60)
     
    <ul id="archive-year-2011" class="collapse">
     
      <li><a href="/2011/12">December 2011</a> (4)</li>
      <li><a href="/2011/11">November 2011</a> (4)</li>
      <li><a href="/2011/10">October 2011</a> (5)</li>
      <li><a href="/2011/09">September 2011</a> (11)</li>
      <li><a href="/2011/08">August 2011</a> (6)</li>
      <li><a href="/2011/07">July 2011</a> (4)</li>
      <li><a href="/2011/06">June 2011</a> (6)</li>
      <li><a href="/2011/05">May 2011</a> (6)</li>
      <li><a href="/2011/04">April 2011</a> (5)</li>
      <li><a href="/2011/03">March 2011</a> (2)</li>
      <li><a href="/2011/01">January 2011</a> (7)</li>
      <li><a href="/2011">All year</a></li>
    </ul>
  </li>
  <li>
    <a data-toggle="collapse" href="#archive-year-2010">2010</a> (26)
     
    <ul id="archive-year-2010" class="collapse">
     
      <li><a href="/2010/12">December 2010</a> (7)</li>
      <li><a href="/2010/09">September 2010</a> (1)</li>
      <li><a href="/2010/07">July 2010</a> (1)</li>
      <li><a href="/2010/06">June 2010</a> (2)</li>
      <li><a href="/2010/05">May 2010</a> (5)</li>
      <li><a href="/2010/04">April 2010</a> (5)</li>
      <li><a href="/2010/03">March 2010</a> (3)</li>
      <li><a href="/2010/01">January 2010</a> (2)</li>
      <li><a href="/2010">All year</a></li>
    </ul>
  </li>
  <li>
    <a data-toggle="collapse" href="#archive-year-2009">2009</a> (31)
     
    <ul id="archive-year-2009" class="collapse">
     
      <li><a href="/2009/10">October 2009</a> (1)</li>
      <li><a href="/2009/09">September 2009</a> (1)</li>
      <li><a href="/2009/08">August 2009</a> (3)</li>
      <li><a href="/2009/07">July 2009</a> (2)</li>
      <li><a href="/2009/06">June 2009</a> (4)</li>
      <li><a href="/2009/05">May 2009</a> (6)</li>
      <li><a href="/2009/04">April 2009</a> (2)</li>
      <li><a href="/2009/03">March 2009</a> (4)</li>
      <li><a href="/2009/01">January 2009</a> (8)</li>
      <li><a href="/2009">All year</a></li>
    </ul>
  </li>
  <li>
    <a data-toggle="collapse" href="#archive-year-2008">2008</a> (61)
     
    <ul id="archive-year-2008" class="collapse">
     
      <li><a href="/2008/12">December 2008</a> (1)</li>
      <li><a href="/2008/11">November 2008</a> (4)</li>
      <li><a href="/2008/10">October 2008</a> (6)</li>
      <li><a href="/2008/09">September 2008</a> (1)</li>
      <li><a href="/2008/08">August 2008</a> (6)</li>
      <li><a href="/2008/07">July 2008</a> (14)</li>
      <li><a href="/2008/06">June 2008</a> (3)</li>
      <li><a href="/2008/05">May 2008</a> (1)</li>
      <li><a href="/2008/04">April 2008</a> (3)</li>
      <li><a href="/2008/03">March 2008</a> (3)</li>
      <li><a href="/2008/02">February 2008</a> (9)</li>
      <li><a href="/2008/01">January 2008</a> (10)</li>
      <li><a href="/2008">All year</a></li>
    </ul>
  </li>
  <li>
    <a data-toggle="collapse" href="#archive-year-2007">2007</a> (85)
     
    <ul id="archive-year-2007" class="collapse">
     
      <li><a href="/2007/12">December 2007</a> (4)</li>
      <li><a href="/2007/11">November 2007</a> (7)</li>
      <li><a href="/2007/10">October 2007</a> (2)</li>
      <li><a href="/2007/09">September 2007</a> (8)</li>
      <li><a href="/2007/08">August 2007</a> (6)</li>
      <li><a href="/2007/07">July 2007</a> (15)</li>
      <li><a href="/2007/06">June 2007</a> (15)</li>
      <li><a href="/2007/05">May 2007</a> (4)</li>
      <li><a href="/2007/04">April 2007</a> (10)</li>
      <li><a href="/2007/03">March 2007</a> (7)</li>
      <li><a href="/2007/02">February 2007</a> (1)</li>
      <li><a href="/2007/01">January 2007</a> (6)</li>
      <li><a href="/2007">All year</a></li>
    </ul>
  </li>
  <li>
    <a data-toggle="collapse" href="#archive-year-2006">2006</a> (102)
     
    <ul id="archive-year-2006" class="collapse">
     
      <li><a href="/2006/12">December 2006</a> (4)</li>
      <li><a href="/2006/11">November 2006</a> (3)</li>
      <li><a href="/2006/10">October 2006</a> (7)</li>
      <li><a href="/2006/09">September 2006</a> (6)</li>
      <li><a href="/2006/08">August 2006</a> (13)</li>
      <li><a href="/2006/07">July 2006</a> (4)</li>
      <li><a href="/2006/06">June 2006</a> (13)</li>
      <li><a href="/2006/05">May 2006</a> (6)</li>
      <li><a href="/2006/04">April 2006</a> (9)</li>
      <li><a href="/2006/03">March 2006</a> (6)</li>
      <li><a href="/2006/02">February 2006</a> (13)</li>
      <li><a href="/2006/01">January 2006</a> (18)</li>
      <li><a href="/2006">All year</a></li>
    </ul>
  </li>
  <li>
    <a data-toggle="collapse" href="#archive-year-2005">2005</a> (126)
     
    <ul id="archive-year-2005" class="collapse">
     
      <li><a href="/2005/12">December 2005</a> (9)</li>
      <li><a href="/2005/11">November 2005</a> (7)</li>
      <li><a href="/2005/10">October 2005</a> (22)</li>
      <li><a href="/2005/09">September 2005</a> (10)</li>
      <li><a href="/2005/08">August 2005</a> (14)</li>
      <li><a href="/2005/07">July 2005</a> (5)</li>
      <li><a href="/2005/06">June 2005</a> (12)</li>
      <li><a href="/2005/05">May 2005</a> (6)</li>
      <li><a href="/2005/04">April 2005</a> (5)</li>
      <li><a href="/2005/03">March 2005</a> (12)</li>
      <li><a href="/2005/02">February 2005</a> (11)</li>
      <li><a href="/2005/01">January 2005</a> (13)</li>
      <li><a href="/2005">All year</a></li>
    </ul>
  </li>
  <li>
    <a data-toggle="collapse" href="#archive-year-2004">2004</a> (84)
     
    <ul id="archive-year-2004" class="collapse">
     
      <li><a href="/2004/12">December 2004</a> (9)</li>
      <li><a href="/2004/11">November 2004</a> (6)</li>
      <li><a href="/2004/10">October 2004</a> (11)</li>
      <li><a href="/2004/09">September 2004</a> (19)</li>
      <li><a href="/2004/07">July 2004</a> (29)</li>
      <li><a href="/2004/06">June 2004</a> (10)</li>
      <li><a href="/2004">All year</a></li>
    </ul>
  </li>
</ul>

</div>

    </div>
  </div>
</div>


    <div class="container">
  <footer>
    <p class="pull-right"><a href="#">Back to top</a></p>
    <p>Copyright 2016 Julio Merino</p>
  </footer>
</div>

<script src="/js/jquery-1.11.2.min.js">
</script>
<script
  src="/css/bootstrap.min.js">
</script>

<script src="/js/auto-toc-1.0.0.dist.js">
</script>

<script>
$("p:contains('NOTE: ')").addClass("callout callout-info");
$("p:contains('IMPORTANT: ')").addClass("callout callout-info");
$("p:contains('WARNING: ')").addClass("callout callout-warning");
$("p:contains('DANGER: ')").addClass("callout callout-danger");
</script>


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;
  m.parentNode.insertBefore(a,m)})(window,document,'script',
  '//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-63557333-1', 'auto');
  ga('send', 'pageview');
</script>


  </body>
</html>
