<!doctype html><html lang=en xmlns=http://www.w3.org/1999/xhtml xmlns:fb=http://ogp.me/ns/fb#><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta property="og:site_name" content="Julio Merino (jmmv.dev)"><meta property="twitter:site" content="@jmmv"><title>Fixing xv problems - Julio Merino (jmmv.dev)</title>
<meta property="og:title" content="Fixing xv problems - Julio Merino (jmmv.dev)"><meta property="twitter:title" content="Fixing xv problems - Julio Merino (jmmv.dev)"><meta name=description content='As you may already know I bought a BenQ FP202W flat panel two months ago, which made me switch from a rather small resolution (1024x768) to a much bigger one: 1680x1050 at 24bpp running on a NVIDIA GeForce 6600GT with the free nv driver. As I did the switch I lost the ability to play videos in X11 full screen mode because the Xvideo refused to work. As you can imagine, this was extremely annoying.
For example, mplayer spit out the following:
X11 error: BadAlloc (insufficient resources for operation)?,?% 0 0
Similarly, xawtv couldn&#39;t set up an overlay window due to the lack of the xv extension thus becoming completely unusable.
Based on a suggestion from someone I don&#39;t remember, I decided yesterday to replace my XFree86 4.5.0 installation with X.Org 6.9 hoping that its nv driver could work better. Guess what, it didn&#39;t.
But after the installation, and just out of curiosity, I started looking at nv&#39;s sources to see if I could discover the problem. I was hopeless to find a solution but I had to try.
First of all, I grepped for BadAlloc in the nv directory, something that quickly drove me to the NVAllocateOverlayMemory function. Based on the name, this seemed like a logic place for the failure. I added some debugging messages, reinstalled the driver and effectively this function was being called and returned a null pointer.
Some more printf&#39;s told me that the problem was being raised by xf86AllocateOffscreenLinear. "Ouch... looks as if the driver cannot allocate enough video memory for such a big resolution... may be difficult to fix", I though. Nevertheless, I continued my quest inspecting this other function and many other code in xf86fbman.c. Along the process, I discovered a minor, unrelated bug probably caused due to a pasto. Overall, the code is quite confusing if you are X-clueless, just as I am.
After a couple of hours or so I was looking at the localAllocateOffscreenLinear function. I saw that the first call to AllocateLinear was returning a null pointer, which made me think that the problem was there, continuing the inspection in that direction. That lead to nowhere.
At last, and tired of try & error cycles, I returned to the NVAllocateOverlayMemory function. I saw there that calls to xf86AllocateOffscreenLinear function were passing a 32 value, which seemed like a bpp. "Hmm... if I decrease it to, say, 24, it may need less memory and it might work." And indeed it did! That little change enabled xv again in my machine.
But the rationale behind the change was wrong. It happens to be that that parameter is not a bpp; it is a granularity. Therefore I assume that the less its value, the better. Some other greps "confirmed" this, as other drivers such as radeon are using a value of 16 (or even less) for that call.
Some time later and with xv working properly, I came back to the localAllocateOffscreenLinear function. This made me see that it was always falling back to the second case (below the "NOPE, ALLOCATING AREA" message). "Stupid me; I should have looked there before." This is part of the function:if(gran && ((gran &gt; pitch) || (pitch % gran))) {
/* we can&#39;t match the specified alignment
with XY allocations */
xfree(link);
return NULL;
}gran is the granularity passed in by the driver and pitch seems to be the screen&#39;s horizontal resolution. So, doing some numbers we see that pitch % gran = 1680 % 32 = 16 != 0. Voila! There it is, the real problem. Well, I think this is the problem, but I may be wrong.
After all, it looks like as if the problem was a simple bug rather than something related to the card&#39;s memory. You can follow this bug for more information as well as to retrieve the proposed patch.
Edit (March 6, 21:38): It turns out my patch was not really correct. For more information just check out the bug&#39;s audit trail.'><meta property="og:description" content='As you may already know I bought a BenQ FP202W flat panel two months ago, which made me switch from a rather small resolution (1024x768) to a much bigger one: 1680x1050 at 24bpp running on a NVIDIA GeForce 6600GT with the free nv driver. As I did the switch I lost the ability to play videos in X11 full screen mode because the Xvideo refused to work. As you can imagine, this was extremely annoying.
For example, mplayer spit out the following:
X11 error: BadAlloc (insufficient resources for operation)?,?% 0 0
Similarly, xawtv couldn&#39;t set up an overlay window due to the lack of the xv extension thus becoming completely unusable.
Based on a suggestion from someone I don&#39;t remember, I decided yesterday to replace my XFree86 4.5.0 installation with X.Org 6.9 hoping that its nv driver could work better. Guess what, it didn&#39;t.
But after the installation, and just out of curiosity, I started looking at nv&#39;s sources to see if I could discover the problem. I was hopeless to find a solution but I had to try.
First of all, I grepped for BadAlloc in the nv directory, something that quickly drove me to the NVAllocateOverlayMemory function. Based on the name, this seemed like a logic place for the failure. I added some debugging messages, reinstalled the driver and effectively this function was being called and returned a null pointer.
Some more printf&#39;s told me that the problem was being raised by xf86AllocateOffscreenLinear. "Ouch... looks as if the driver cannot allocate enough video memory for such a big resolution... may be difficult to fix", I though. Nevertheless, I continued my quest inspecting this other function and many other code in xf86fbman.c. Along the process, I discovered a minor, unrelated bug probably caused due to a pasto. Overall, the code is quite confusing if you are X-clueless, just as I am.
After a couple of hours or so I was looking at the localAllocateOffscreenLinear function. I saw that the first call to AllocateLinear was returning a null pointer, which made me think that the problem was there, continuing the inspection in that direction. That lead to nowhere.
At last, and tired of try & error cycles, I returned to the NVAllocateOverlayMemory function. I saw there that calls to xf86AllocateOffscreenLinear function were passing a 32 value, which seemed like a bpp. "Hmm... if I decrease it to, say, 24, it may need less memory and it might work." And indeed it did! That little change enabled xv again in my machine.
But the rationale behind the change was wrong. It happens to be that that parameter is not a bpp; it is a granularity. Therefore I assume that the less its value, the better. Some other greps "confirmed" this, as other drivers such as radeon are using a value of 16 (or even less) for that call.
Some time later and with xv working properly, I came back to the localAllocateOffscreenLinear function. This made me see that it was always falling back to the second case (below the "NOPE, ALLOCATING AREA" message). "Stupid me; I should have looked there before." This is part of the function:if(gran && ((gran &gt; pitch) || (pitch % gran))) {
/* we can&#39;t match the specified alignment
with XY allocations */
xfree(link);
return NULL;
}gran is the granularity passed in by the driver and pitch seems to be the screen&#39;s horizontal resolution. So, doing some numbers we see that pitch % gran = 1680 % 32 = 16 != 0. Voila! There it is, the real problem. Well, I think this is the problem, but I may be wrong.
After all, it looks like as if the problem was a simple bug rather than something related to the card&#39;s memory. You can follow this bug for more information as well as to retrieve the proposed patch.
Edit (March 6, 21:38): It turns out my patch was not really correct. For more information just check out the bug&#39;s audit trail.'><meta property="twitter:description" content="As you may already know I bought a BenQ FP202W flat panel two months ago, which made me switch from a rather small resolution (1024x768) to a much bigger one: 1680x1050 at 24bpp running on a NVIDIA …"><meta name=author content="Julio Merino"><meta property="twitter:creator" content="@jmmv"><meta name=generator content="Hugo 0.136.5"><meta property="og:url" content="https://jmmv.dev/2006/03/fixing-xv-problems.html"><meta property="og:type" content="blog"><meta property="twitter:card" content="summary"><link rel=canonical href=https://jmmv.dev/2006/03/fixing-xv-problems.html><link rel=alternate type=application/rss+xml title="Julio Merino (jmmv.dev)" href=/feed.xml><link rel=stylesheet href=/sass/main.min.cb91349cd93211a37e7d5dc131c35a170fc795721c03373cd05571327eea206b.css><link rel=stylesheet href=/css/chroma.css><link rel=icon type=image/png href=/images/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/images/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicons/favicon-96x96.png sizes=96x96><meta property="og:image" content="/images/favicons/favicon-1200x1200.png"><meta property="twitter:image" content="https://jmmv.dev/images/favicons/favicon-1200x1200.png"><script>const SITE_ID="e8da9f62-b7ac-4fe9-bf20-7c527199a376",BASE_URL="https://jmmv.dev/"</script></head><body><header class=site-header><nav class="navbar navbar-expand-md fixed-top navbar-dark bg-primary"><a class=navbar-brand href=/><img src=/images/favicons/favicon-30x30.png width=30 height=30 class="d-inline-block align-top" alt>
&nbsp;jmmv.dev
</a><button class=navbar-toggler type=button data-toggle=collapse data-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarSupportedContent><ul class="navbar-nav mr-auto"><li class=nav-item><a class=nav-link href=/about.html>About</a></li><li class=nav-item><a class=nav-link href=/blog.html>Blog</a></li><li class=nav-item><a class=nav-link href=/resume.html>Resume</a></li><li class=nav-item><a class=nav-link href=/software.html>Software</a></li></ul><ul class="navbar-nav mr-4"><li class=nav-item><a class=nav-link href=/archive.html>Archive</a></li><li class=nav-item><a class=nav-link href=/series.html>Series</a></li><li class=nav-item><a class=nav-link href=/tags.html>Tags</a></li></ul><form class=form-inline method=get role=search action=https://www.google.com/search><div class=input-group><input type=search name=query class=form-control placeholder=Search aria-label=Search><div class=input-group-append><button type=submit value=Search class="btn btn-light">
<img src=/octicons/search.svg></button></div></div><input type=hidden name=sitesearch value=https://jmmv.dev/></form></div></nav></header><div class=page-header><div class=container><h1>Fixing xv problems</h1><p>March 5, 2006 &#183;
About 4 minutes
&#183;</p></div></div><div class="container post-body"><div class=row><div class=col-md-9><div class=row><div class=col><article>As you may already know I <a href=http://julipedia.blogspot.com/2006/01/got-benq-fp202w-flat-panel.html>bought a BenQ FP202W</a> flat panel two months ago, which made me switch from a rather small resolution (1024x768) to a much bigger one: 1680x1050 at 24bpp running on a NVIDIA GeForce 6600GT with the free nv driver. As I did the switch I lost the ability to play videos in X11 full screen mode because the Xvideo refused to work. As you can imagine, this was <i>extremely annoying</i>.<br><br>For example, mplayer spit out the following:<br><br><tt>X11 error: BadAlloc (insufficient resources for operation)?,?% 0 0</tt><br><br>Similarly, xawtv couldn't set up an overlay window due to the lack of the xv extension thus becoming completely unusable.<br><br>Based on a suggestion from someone I don't remember, I decided yesterday to replace my XFree86 4.5.0 installation with X.Org 6.9 hoping that its nv driver could work better. Guess what, it didn't.<br><br>But after the installation, and just out of curiosity, I started looking at nv's sources to see if I could discover the problem. I was hopeless to find a solution but I had to try.<br><br>First of all, I grepped for <tt>BadAlloc</tt> in the nv directory, something that quickly drove me to the <tt>NVAllocateOverlayMemory</tt> function. Based on the name, this seemed like a logic place for the failure. I added some debugging messages, reinstalled the driver and effectively this function was being called and returned a null pointer.<br><br>Some more printf's told me that the problem was being raised by <tt>xf86AllocateOffscreenLinear</tt>. "Ouch... looks as if the driver cannot allocate enough video memory for such a big resolution... may be difficult to fix", I though. Nevertheless, I continued my quest inspecting this other function and many other code in xf86fbman.c. Along the process, I discovered a <a href="https://bugs.freedesktop.org/show_bug.cgi?id=6150">minor, unrelated bug</a> probably caused due to a pasto. Overall, the code is quite confusing if you are X-clueless, just as I am.<br><br>After a couple of hours or so I was looking at the <tt>localAllocateOffscreenLinear</tt> function. I saw that the first call to <tt>AllocateLinear</tt> was returning a null pointer, which made me think that the problem was there, continuing the inspection in that direction. That lead to nowhere.<br><br>At last, and tired of try & error cycles, I returned to the <tt>NVAllocateOverlayMemory</tt> function. I saw there that calls to <tt>xf86AllocateOffscreenLinear</tt> function were passing a 32 value, which seemed like a bpp. "Hmm... if I decrease it to, say, 24, it may need less memory and it might work." And indeed it did! That little change enabled xv again in my machine.<br><br>But the rationale behind the change was wrong. It happens to be that that parameter is not a bpp; it is a <i>granularity</i>. Therefore I assume that the less its value, the better. Some other greps "confirmed" this, as other drivers such as radeon are using a value of 16 (or even less) for that call.<br><br>Some time later and with xv working properly, I came back to the <tt>localAllocateOffscreenLinear</tt> function. This made me see that it was always falling back to the second case (below the "NOPE, ALLOCATING AREA" message). "Stupid me; I should have looked there before." This is part of the function:<pre>if(gran && ((gran > pitch) || (pitch % gran))) {<br>   /* we can't match the specified alignment<br>      with XY allocations */<br>   xfree(link);<br>   return NULL;<br>}</pre><tt>gran</tt> is the granularity passed in by the driver and <tt>pitch</tt> seems to be the screen's horizontal resolution. So, doing some numbers we see that <tt>pitch % gran = 1680 % 32 = 16 != 0</tt>. Voila! There it is, the real problem. Well, I <i>think</i> this is the problem, but I may be wrong.<br><br>After all, it looks like as if the problem was a simple bug rather than something related to the card's memory. You can <a href="https://bugs.freedesktop.org/show_bug.cgi?id=6151">follow this bug</a> for more information as well as to retrieve the proposed patch.<br><br><b>Edit (March 6, 21:38)</b>: It turns out my patch was not really correct. For more information just check out the bug's audit trail.</article></div></div><div class="container post-links"><div class=row><div class="col mr-auto text-left"><span><a href=https://jmmv.dev/2006/02/vigipac-dead-and-reborn.html>&#171; Previous</a></span></div><div class="col text-center"><span><a href=/archive.html>All posts</a></span></div><div class="col ml-auto text-right"><span><a href=https://jmmv.dev/2006/03/linux-problems-binary-redistribution.html>Next &#187;</a></span></div></div></div><div class="container post-votes"><div class=row><div class="col-lg-4 my-2"><div class=row><div class=col><a onclick=voteThumbsUp() class="btn btn-block btn-outline-success" id=thumbs-up-btn>👍
(<span id=thumbs-up-count>0</span>)</a></div><div class=col><a onclick=voteThumbsDown() class="btn btn-block btn-outline-danger" id=thumbs-down-btn>👎
(<span id=thumbs-down-count>0</span>)</a></div></div></div><div class="col-lg-8 my-2 d-none d-sm-block"><div class=row><div class="col-md-4 text-center"><a href="https://www.reddit.com/submit?title=Fixing+xv+problems&amp;url=https%3A%2F%2Fjmmv.dev%2F2006%2F03%2Ffixing-xv-problems.html" class="btn btn-block btn-outline-primary">Share on
<img src=/images/badges/reddit.png alt=Reddit width=24 height=24></a></div><div class="col-md-4 text-center"><a href="https://news.ycombinator.com/submitlink?t=Fixing+xv+problems&amp;u=https%3A%2F%2Fjmmv.dev%2F2006%2F03%2Ffixing-xv-problems.html" class="btn btn-block btn-outline-primary">Share on
<img src=/images/badges/ycombinator.png alt="Hacker News" width=24 height=24></a></div><div class="col-md-4 text-center"><a href="https://twitter.com/intent/tweet?status=Fixing+xv+problems+%E2%80%94+https%3A%2F%2Fjmmv.dev%2F2006%2F03%2Ffixing-xv-problems.html+%E2%80%94+cc+%40jmmv" class="btn btn-block btn-outline-primary">Share on
<img src=/images/badges/Twitter_Social_Icon_Circle_Color.png alt=Twitter width=24 height=24></a></div></div></div></div><div class="row my-4" id=postCommentRow><div class=col><div class=media><img class=mr-3 src=/octicons/pencil.svg width=32px height=32px><div class="media-body container"><form method=post id=newPost><div class=row><div class="col my-1"><textarea class=form-control rows=1 id=postCommentContent onclick=showPostComment() placeholder="Leave a comment"></textarea></div></div><div class="row newPostControls" style=display:none><div class="col my-1 form-group"><label for=postCommentAuthor>Your name (optional):</label>
<input type=text class=form-control id=postCommentAuthor></div></div><div class="row newPostControls" style=display:none><div class="col my-1 form-group"><label for=postCommentEmail>Your email (optional):</label>
<input type=text class=form-control type=email id=postCommentEmail>
<small class="form-text text-muted">Invisible to all readers; if provided, you will receive notifications when replied to (not implemented yet)</small></div></div><div class=row id=postCommentError style=display:none><div class="col mt-1 alert-danger"><p></p></div></div><div class="row newPostControls" style=display:none><button class="col-md-3 my-1 btn btn-primary" type=submit id=submitCommentButton>Post</button>
<small class="col-md-9 my-1 text-muted">Comments are subject to moderation. This feature is experimental and is powered by <a href=/software/endtracker.html>EndTRACKER</a>. If you experience any issues, please <a href=/about.html#contact>contact me off-band</a>.</small></div></form></div></div></div></div><script>function hidePostComment(){var t,e=document.getElementById("postCommentContent");e.rows=1,e.value="",t=document.getElementsByClassName("newPostControls"),Array.prototype.forEach.call(t,function(e){e.style.display="none"})}function showPostComment(){var e,t=document.getElementById("postCommentContent");t.rows=5,e=document.getElementsByClassName("newPostControls"),Array.prototype.forEach.call(e,function(e){e.style.display=""})}const form=document.querySelector("#newPost");form.onsubmit=function(e){e.preventDefault();let t=document.getElementById("postCommentAuthor").value,n=document.getElementById("postCommentEmail").value,s=document.getElementById("postCommentContent").value;postComment(t,n,s,hidePostComment)}</script></div></div><div class="col-md-3 sidebar d-none d-md-block"><div class=row><div class="col text-center p-2"><p><a href=/about.html class=clear-link><img src=/images/avatars/20181124-snow.jpg class="rounded-circle shadow my-2" style=width:100px><br><b>Julio Merino</b><br>A blog on operating systems, programming languages, testing, build systems, my own software
projects and even personal productivity. Specifics include FreeBSD, Linux, Rust, Bazel and
EndBASIC.</a></p><div class=row><div class=col><div class=form-group><form action=https://endtracker.azurewebsites.net/api/sites/e8da9f62-b7ac-4fe9-bf20-7c527199a376/subscribers/add method=post><input type=text name=email placeholder="Enter your email" class="form-control input-sm text-center my-1">
<button type=submit class="btn btn-primary btn-block my-1">Subscribe</button></form></div></div></div><div class="row px-2"><div class="col-sm-5 text-left"><small><span class=subscriber-count>0</span> subscribers</small></div><div class="col-sm-7 text-right"><p><a rel=me href=https://mastodon.online/@jmmv><img src=/images/badges/mastodon-logo.svg width=32px height=32px alt="Follow @jmmv on Mastodon">
</a><a href="https://twitter.com/intent/follow?original_referer=https%3A%2F%2Fjmmv.dev%2F&amp;screen_name=jmmv"><img src=/images/badges/Twitter_logo_blue.svg width=32px height=32px alt="Follow @jmmv on Twitter">
</a><a href=/feed.xml><img src=/images/badges/feed-icon-28x28.png alt="RSS feed"></a></p></div></div></div></div><div class=row><div class=col><h2>Featured software</h2><ul><li class=overflow-ellipsis><a href=https://www.endbasic.dev/ target=_blank>EndBASIC: Online BASIC+DOS env</a></li><li class=overflow-ellipsis><a href=https://endtracker.azurewebsites.net/ target=_blank>EndTRACKER: Services for static sites</a></li></ul></div></div><div class=row><div class=col><h2>Featured posts</h2><ul><li class=overflow-ellipsis><a href=/2023/06/fast-machines-slow-machines.html>Fast machines, slow machines</a></li><li class=overflow-ellipsis><a href=/2022/12/endbasic-0.10.html>EndBASIC 0.10: Core language, evolved</a></li><li class=overflow-ellipsis><a href=/2022/10/bye-microsoft-hi-snowflake.html>Farewell, Microsoft; hello, Snowflake!</a></li><li class=overflow-ellipsis><a href=/2022/05/rust-is-hard-but-does-it-matter.html>Rust is hard, yes, but does it matter?</a></li><li class=overflow-ellipsis><a href=/2022/04/rust-traits-and-dependency-injection.html>Rust traits and dependency injection</a></li><li class=overflow-ellipsis><a href=/2022/03/a-year-on-windows-intro.html>A year on Windows: Introduction</a></li><li class=overflow-ellipsis><a href=/2021/04/always-be-quitting.html>Always be quitting</a></li><li class=overflow-ellipsis><a href=/2021/02/google-monorepos-and-caching.html>How does Google keep build times low?</a></li><li class=overflow-ellipsis><a href=/2020/12/google-no-clean-builds.html>How does Google avoid clean builds?</a></li><li class=overflow-ellipsis><a href=/2020/12/unit-testing-a-console-app.html>Unit-testing a console app (a text editor)</a></li><li class=overflow-ellipsis><a href=/essays.html#featured>More...</a></li></ul></div></div></div></div></div><footer class=container-fluid><div class=row><div class="col-4 order-2 text-right"><p class=float-right><a href=#>Back to top</a></p></div><div class="col-8 order-1 mr-auto"><p>Copyright 2004&ndash;2025
Julio Merino</p></div></div></footer><script type=module>
  import { addAnchorsToHeaders, addElementClasses, BatchClient } from "\/js\/main.0de73782e9e0fbcb4184fb5793949b3b0d0ada16455df89320415b4dcc052f88.js";

  var batchClient = new BatchClient(SITE_ID);
  batchClient.doAll({
    put_request: true, get_comments: true, get_subscriber_count: true, get_votes: true });

  window.voteThumbsUp = function() { batchClient.voteThumbsUp(); }
  window.voteThumbsDown = function() { batchClient.voteThumbsDown(); }

  window.postComment = function(...args) {
    batchClient.postComment(...args);
  };

  addAnchorsToHeaders();
  addElementClasses();
</script><noscript><img src=https://hugo-dynamic.jmmv.dev/api/sites/e8da9f62-b7ac-4fe9-bf20-7c527199a376/pages/aHR0cHM6Ly9qbW12LmRldi8yMDA2LzAzL2ZpeGluZy14di1wcm9ibGVtcy5odG1s/stamp.gif style=display:none></noscript></body></html>