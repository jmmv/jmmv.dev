<!doctype html><html lang=en xmlns=http://www.w3.org/1999/xhtml xmlns:fb=http://ogp.me/ns/fb#><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta property="og:site_name" content="Julio Merino (jmmv.dev)"><meta property="twitter:site" content="@jmmv"><title>Seeding a file server quickly - Julio Merino (jmmv.dev)</title><meta property="og:title" content="Seeding a file server quickly - Julio Merino (jmmv.dev)"><meta property="twitter:title" content="Seeding a file server quickly - Julio Merino (jmmv.dev)"><meta name=description content="Say you want to copy a large collection of files to a file server on your same network. What&amp;rsquo;s the fastest way to do this initial copy? Physically attaching the drive to the server? Maybe, but will the file systems be compatible? What about using the network? If so, which protocol? Read on for more details and how tar plus Netcat delivered the best results."><meta property="og:description" content="Say you want to copy a large collection of files to a file server on your same network. What&amp;rsquo;s the fastest way to do this initial copy? Physically attaching the drive to the server? Maybe, but will the file systems be compatible? What about using the network? If so, which protocol? Read on for more details and how tar plus Netcat delivered the best results."><meta property="twitter:description" content="Say you want to copy a large collection of files to a file server on your same network. What&amp;rsquo;s the fastest way to do this initial copy? Physically attaching the drive to the server? Maybe, but …"><meta name=author content="Julio Merino"><meta property="twitter:creator" content="@jmmv"><meta name=generator content="Hugo 0.111.3"><meta property="og:url" content="https://jmmv.dev/2021/02/seeding-a-file-server.html"><meta property="og:type" content="blog"><meta property="twitter:card" content="summary"><link rel=canonical href=https://jmmv.dev/2021/02/seeding-a-file-server.html><link rel=alternate type=application/rss+xml title="Julio Merino (jmmv.dev)" href=/feed.xml><link rel=stylesheet href=/sass/main.min.cb91349cd93211a37e7d5dc131c35a170fc795721c03373cd05571327eea206b.css><link rel=stylesheet href=/css/chroma.css><link rel=icon type=image/png href=/images/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/images/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicons/favicon-96x96.png sizes=96x96><meta property="og:image" content="/images/favicons/favicon-1200x1200.png"><meta property="twitter:image" content="https://jmmv.dev/images/favicons/favicon-1200x1200.png"><script>const SITE_ID="e8da9f62-b7ac-4fe9-bf20-7c527199a376",BASE_URL="https://jmmv.dev/"</script></head><body><header class=site-header><nav class="navbar navbar-expand-lg fixed-top navbar-dark bg-primary"><a class=navbar-brand href=/><img src=/images/favicons/favicon-30x30.png width=30 height=30 class="d-inline-block align-top" alt>
&nbsp;jmmv.dev</a>
<button class=navbar-toggler type=button data-toggle=collapse data-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarSupportedContent><ul class="navbar-nav mr-auto"><li class=nav-item><a class=nav-link href=/about.html>About</a></li><li class=nav-item><a class=nav-link href=/blog.html>Blog</a></li><li class=nav-item><a class=nav-link href=/resume.html>Resume</a></li><li class=nav-item><a class=nav-link href=/software.html>Software</a></li></ul><ul class="navbar-nav mr-4"><li class=nav-item><a class=nav-link href=/archive.html>Archive</a></li><li class=nav-item><a class=nav-link href=/series.html>Series</a></li><li class=nav-item><a class=nav-link href=/tags.html>Tags</a></li></ul><form class=form-inline method=get role=search action=https://www.google.com/search><div class=input-group><input type=search name=query class=form-control placeholder=Search aria-label=Search><div class=input-group-append><button type=submit value=Search class="btn btn-light">
<img src=/octicons/search.svg></button></div></div><input type=hidden name=sitesearch value=https://jmmv.dev/></form></div></nav></header><div class=page-header><div class=container><h1>Seeding a file server quickly</h1><p>February 5, 2021 &#183;
About 6 minutes
&#183;
Tags:
<a href=/tags/sre>sre</a></p></div></div><div class="container post-body"><div class=row><div class=col-md-9><div class=row><div class=col><article><p><em>&mldr; or, how to upload lots of data to the file server for the first time using the fastest possible mechanism.</em></p><hr><p>I recently got<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup> an old PowerMac G5 to play with and installed FreeBSD 12 on it. At this point in time, FreeBSD seems to be the only moden OS that fully works on this machine, which is great given my OS preferences but sad overall. (<a href=/2013/07/putting-powermac-g5-to-good-use.html>Things were different in 2013</a>.)</p><p>The PowerMac had been sitting under my desk since early January, but it&rsquo;s noisier than I&rsquo;d like and I only access it over SSH<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>&mldr; so I spent last weekend setting up space in the garage to host the machine. As part of this, I extended my physical network leveraging the already-existing coax wiring in the house, using an extra <a href=https://www.amazon.com/goCoax-Adapter-2-5Gbps-Ethernet-WF-803M/dp/B07XYDG7WN>goCoax MoCA 2.5 adapter</a> (non-affiliate link). And just yesterday, I got a second-hand 4TB drive to see how well this machine can act as a file server.</p><p>In particular, I would like to host pictures and videos on the machine so that they can be accessed from multiple devices at home. All of these files currently reside on an external USB 3.0 drive on my Mac Pro and amount to about 2TB of storage.</p><p>So the question was: how can I seed the contents of the G5 with these files?</p><h1 id=physical-links>Physical links</h1><p>The first thought that you might have is: well, the data currently lives on a USB drive. Just attach it to the PowerMac and copy the data! Unfortunately, it&rsquo;s not that easy. First of all, the drive is using APFS and I can&rsquo;t imagine this file system being accessible from FreeBSD. But I didn&rsquo;t bother to look because there was one more important issue: while the drive is USB 3.0, the PowerMac only sports USB 2.0, which means the transfer rates I&rsquo;d see would be around 20MB/s. Not great.</p><p>The second thought is to leverage the network, of course. A transfer rate test shows that my connection from the Mac Pro to the PowerMac can sustain 70MB/s, which is almost three times as fast as the USB 2.0 option&mdash;and 2TB of data are <em>a lot</em> to copy. (Yes, yes, 70MB/s is shy of what the Gigabit equipment involved in the connection should reach. I still have to diagnose where the inefficiencies lie and fix those.)</p><p>The third thought is to take the external drive out of its USB enclosure and attach it to the SATA bus on the PowerMac. That&rsquo;d be the fastest indeed, but I&rsquo;d encounter the issue with APFS&mldr; and the lack of SATA ports on the machine.</p><p>So, we are left with network transfers and a limit of 70MB/s.</p><h1 id=transfer-protocols>Transfer protocols</h1><p>But I measured those 70MB/s with a synthetic test using Netcat: in other words, a simple socket without encryption nor a complex server processes backing it up. Could I reach these same transfer speeds during the data copies? Copying data usually involves more-complex protocols so there can be other inefficiencies.</p><p>The first obvious choice we have is to use scp. Using scp involes encryption (high CPU usage) and the scp protocol doesn&rsquo;t seem to be very friendly to lots of small files. The maximum rates I saw using this mechanism where about 30MB/s, which are very far from the maximum limit I had measured.</p><p>The second obvious choice is rsync. But it isn&rsquo;t, because rsync is backed by SSH and suffers from the same issues as scp. Yes, I know rsync can be configured to <em>not</em> use SSH (as it used to do in the distant past), but I was lazy to set things up for this.</p><p>The third obvious choice was to rely on the Samba service I had already set up on the G5. Large file copies over this protocol were able to reach the peak rates I had measured, but transferring lots of small files (the Lightroom catalog, for example) was excruciatingly slow. I still wonder how NFS might stack to this test but, as before, I have been lazy to set it up.</p><p>So we get to the fourth, not-so-obvious choice. If Netcat was the thing that reached the fastest transfer rates, can we use it to copy the files? Yes, we can! So, how?</p><h1 id=copying-files-with-tar-and-netcat>Copying files with tar and Netcat</h1><p>On the server, open a socket and pipe its output to <code>tar</code> so that it unpacks the contents on the external drive (which I&rsquo;ve mounted under <code>/depot</code>):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ <span class=nb>cd</span> /depot/jmmv
</span></span><span class=line><span class=cl>$ nc -l <span class=m>1234</span> <span class=p>|</span> tar xvf -
</span></span></code></pre></div><p>And on the client, upload all contents using <code>tar</code> and piping the output to Netcat:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ <span class=nb>cd</span> /Volumes/Data
</span></span><span class=line><span class=cl>$ tar cvf - Pictures <span class=p>|</span> nc g5 <span class=m>1234</span>
</span></span></code></pre></div><p>Voilà. A sustained 70MB/s during large file transfers. (Small file transfer are still slower due to inefficiencies involving file seeks on the local and remote machines.)</p><p>I believe this is the fastest you are going to get for a bulk file copy:</p><ol><li><p>We are using a single socket and streaming all files as &ldquo;just a bunch of bytes&rdquo;. <code>tar</code> packs the data in a very simple sequential format and the network connection does <em>not</em> interpret it. In particular, there is no cross-machine protocol overhead to communicate that different files are being transfered (which is what killed Samba performance with small files).</p></li><li><p>We are not using compression because most files are already compressed (pictures and videos) and we&rsquo;d be burning CPU for no reason. The CPUs on the G5 are relatively strong but no need to stress them.</p></li><li><p>We are not using encryption because, well, I&rsquo;m assuming my network is secure (I know, I know&mldr;), which is what was killing scp and rsync performance. If you are worried about data integrity, you can run a follow-up rsync over SSH once the initial seeding is complete to ensure the data in the destination is good. And if you are worried about data snooping&mldr; well, then use encryption and pay the cost.</p></li></ol><p>So that&rsquo;s about it. We&rsquo;ll see how well this experiment with the G5 goes. The file server isn&rsquo;t going to be faster than the locally-attached USB drive I was using, but I don&rsquo;t think that&rsquo;s going to be noticeable given my simplistic usage patterns.</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>Yes, I already had one of these machines a few years ago, but I stupidly sold it so I had to buy it again. I just like this machine. I guess the second one I got is better because it is liquid cooled so it is generally silent and it&rsquo;s slightly more modern.&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p>I had wanted to use this machine as a desktop&mldr; but, unfortunately, the NVIDIA card it includes is not well-supported, the machine doesn&rsquo;t have AGP, and finding a PCI Express ATI card for this machine seems impossible.&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></article></div></div><div class="container post-links"><div class=row><div class="col mr-auto text-left"><span><a href=https://jmmv.dev/2021/01/embedding-endbasic.html>&#171; Previous</a></span></div><div class="col text-center"><span><a href=/archive.html>All posts</a></span></div><div class="col ml-auto text-right"><span><a href=https://jmmv.dev/2021/02/endbasic-0.6.html>Next &#187;</a></span></div></div></div><div class="container post-votes"><div class=row><div class="col-lg-4 my-2"><div class=row><div class=col><a onclick=voteThumbsUp() class="btn btn-block btn-outline-success" id=thumbs-up-btn>👍
(<span id=thumbs-up-count>0</span>)</a></div><div class=col><a onclick=voteThumbsDown() class="btn btn-block btn-outline-danger" id=thumbs-down-btn>👎
(<span id=thumbs-down-count>0</span>)</a></div></div></div><div class="col-lg-8 my-2 d-none d-sm-block"><div class=row><div class="col-md-4 text-center"><a href="https://www.reddit.com/submit?title=Seeding+a+file+server+quickly&amp;url=https%3A%2F%2Fjmmv.dev%2F2021%2F02%2Fseeding-a-file-server.html" class="btn btn-block btn-outline-primary">Share on
<img src=/images/badges/reddit.png alt=Reddit width=24 height=24></a></div><div class="col-md-4 text-center"><a href="https://news.ycombinator.com/submitlink?t=Seeding+a+file+server+quickly&amp;u=https%3A%2F%2Fjmmv.dev%2F2021%2F02%2Fseeding-a-file-server.html" class="btn btn-block btn-outline-primary">Share on
<img src=/images/badges/ycombinator.png alt="Hacker News" width=24 height=24></a></div><div class="col-md-4 text-center"><a href="https://twitter.com/intent/tweet?status=Seeding+a+file+server+quickly+%E2%80%94+https%3A%2F%2Fjmmv.dev%2F2021%2F02%2Fseeding-a-file-server.html+%E2%80%94+cc+%40jmmv" class="btn btn-block btn-outline-primary">Share on
<img src=/images/badges/Twitter_Social_Icon_Circle_Color.png alt=Twitter width=24 height=24></a></div></div></div></div><div class="row my-4" id=postCommentRow><div class=col><div class=media><img class=mr-3 src=/octicons/pencil.svg width=32px height=32px><div class="media-body container"><form method=post id=newPost><div class=row><div class="col my-1"><textarea class=form-control rows=1 id=postCommentContent onclick=showPostComment() placeholder="Leave a comment"></textarea></div></div><div class="row newPostControls" style=display:none><div class="col my-1 form-group"><label for=postCommentAuthor>Your name (optional):</label>
<input type=text class=form-control id=postCommentAuthor></div></div><div class="row newPostControls" style=display:none><div class="col my-1 form-group"><label for=postCommentEmail>Your email (optional):</label>
<input type=text class=form-control type=email id=postCommentEmail>
<small class="form-text text-muted">Invisible to all readers; if provided, you will receive notifications when replied to (not implemented yet)</small></div></div><div class=row id=postCommentError style=display:none><div class="col mt-1 alert-danger"><p></p></div></div><div class="row newPostControls" style=display:none><button class="col-md-3 my-1 btn btn-primary" type=submit id=submitCommentButton>Post</button>
<small class="col-md-9 my-1 text-muted">Comments are subject to moderation. This feature is experimental and is powered by <a href=/software/endtracker.html>EndTRACKER</a>. If you experience any issues, please <a href=/about.html#contact>contact me off-band</a>.</small></div></form></div></div></div></div><script>function hidePostComment(){var t,e=document.getElementById("postCommentContent");e.rows=1,e.value="",t=document.getElementsByClassName("newPostControls"),Array.prototype.forEach.call(t,function(e){e.style.display="none"})}function showPostComment(){var e,t=document.getElementById("postCommentContent");t.rows=5,e=document.getElementsByClassName("newPostControls"),Array.prototype.forEach.call(e,function(e){e.style.display=""})}const form=document.querySelector("#newPost");form.onsubmit=function(e){e.preventDefault();let t=document.getElementById("postCommentAuthor").value,n=document.getElementById("postCommentEmail").value,s=document.getElementById("postCommentContent").value;postComment(t,n,s,hidePostComment)}</script></div></div><div class="col-md-3 sidebar d-none d-md-block"><div class=row><div class="col text-center p-2"><p><a href=/about.html class=clear-link><img src=/images/avatars/20181124-snow.jpg class="rounded-circle shadow my-2" style=width:100px><br><b>Julio Merino</b><br>A blog on operating systems, programming languages, testing, build systems, my own software
projects and even personal productivity. Specifics include FreeBSD, Linux, Rust, Bazel and
EndBASIC.</a></p><div class=row><div class=col><div class=form-group><form action=https://endtracker.azurewebsites.net/api/sites/e8da9f62-b7ac-4fe9-bf20-7c527199a376/subscribers/add method=post><input type=text name=email placeholder="Enter your email" class="form-control input-sm text-center my-1">
<button type=submit class="btn btn-primary btn-block my-1">Subscribe</button></form></div></div></div><div class="row px-2"><div class="col-sm-5 text-left"><small><span class=subscriber-count>0</span> subscribers</small></div><div class="col-sm-7 text-right"><p><a rel=me href=https://mastodon.online/@jmmv><img src=/images/badges/mastodon-logo.svg width=32px height=32px alt="Follow @jmmv on Mastodon"></a>
<a href="https://twitter.com/intent/follow?original_referer=https%3A%2F%2Fjmmv.dev%2F&amp;screen_name=jmmv"><img src=/images/badges/Twitter_logo_blue.svg width=32px height=32px alt="Follow @jmmv on Twitter"></a>
<a href=/feed.xml><img src=/images/badges/feed-icon-28x28.png alt="RSS feed"></a></p></div></div></div></div><div class=row><div class=col><h2>Featured software</h2><ul><li class=overflow-ellipsis><a href=https://www.endbasic.dev/ target=_blank>EndBASIC: Online BASIC+DOS env</a></li><li class=overflow-ellipsis><a href=https://endtracker.azurewebsites.net/ target=_blank>EndTRACKER: Services for static sites</a></li></ul></div></div><div class=row><div class=col><h2>Featured posts</h2><ul><li class=overflow-ellipsis><a href=/2023/06/fast-machines-slow-machines.html>Fast machines, slow machines</a></li><li class=overflow-ellipsis><a href=/2022/12/endbasic-0.10.html>EndBASIC 0.10: Core language, evolved</a></li><li class=overflow-ellipsis><a href=/2022/10/bye-microsoft-hi-snowflake.html>Farewell, Microsoft; hello, Snowflake!</a></li><li class=overflow-ellipsis><a href=/2022/05/rust-is-hard-but-does-it-matter.html>Rust is hard, yes, but does it matter?</a></li><li class=overflow-ellipsis><a href=/2022/04/rust-traits-and-dependency-injection.html>Rust traits and dependency injection</a></li><li class=overflow-ellipsis><a href=/2022/03/a-year-on-windows-intro.html>A year on Windows: Introduction</a></li><li class=overflow-ellipsis><a href=/2021/04/always-be-quitting.html>Always be quitting</a></li><li class=overflow-ellipsis><a href=/2021/02/google-monorepos-and-caching.html>How does Google keep build times low?</a></li><li class=overflow-ellipsis><a href=/2020/12/google-no-clean-builds.html>How does Google avoid clean builds?</a></li><li class=overflow-ellipsis><a href=/2020/12/unit-testing-a-console-app.html>Unit-testing a console app (a text editor)</a></li><li class=overflow-ellipsis><a href=/essays.html#featured>More...</a></li></ul></div></div></div></div></div><footer class=container-fluid><div class=row><div class="col-4 order-2 text-right"><p class=float-right><a href=#>Back to top</a></p></div><div class="col-8 order-1 mr-auto"><p>Copyright 2004&ndash;2023 Julio Merino</p></div></div></footer><script type=module>
  import { addAnchorsToHeaders, addElementClasses, BatchClient } from "\/js\/main.d30f168b11d80082408f4a983af9a626c6e57d58f7846b2174bac40d43be33e3.js";

  var batchClient = new BatchClient(SITE_ID);
  batchClient.doAll({
    put_request: true, get_comments: true, get_subscriber_count: true, get_votes: true });

  window.voteThumbsUp = function() { batchClient.voteThumbsUp(); }
  window.voteThumbsDown = function() { batchClient.voteThumbsDown(); }

  window.postComment = function(...args) {
    batchClient.postComment(...args);
  };

  addAnchorsToHeaders();
  addElementClasses();
</script><noscript><img src=https://hugo-dynamic.jmmv.dev/api/sites/e8da9f62-b7ac-4fe9-bf20-7c527199a376/pages/aHR0cHM6Ly9qbW12LmRldi8yMDIxLzAyL3NlZWRpbmctYS1maWxlLXNlcnZlci5odG1s/stamp.gif style=display:none></noscript></body></html>