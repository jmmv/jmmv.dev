<!doctype html><html lang=en xmlns=http://www.w3.org/1999/xhtml xmlns:fb=http://ogp.me/ns/fb#>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta property="og:site_name" content="Julio Merino (jmmv.dev)">
<title>Bazel UI locking and file downloads - Julio Merino (jmmv.dev)</title>
<meta property="og:title" content="Bazel UI locking and file downloads - Julio Merino (jmmv.dev)">
<meta name=description content="About a month ago, I was benchmarking the impact of a new Bazel feature and I noticed that a test build that should have taken only a few seconds took almost 10 minutes. My Internet connection was flaking out indeed, but something else didn&amp;rsquo;t seem right. So I looked and found that Bazel was doing network calls within a critical section, and these were the root cause behind the massive slowdown. But how did we get such an obvious no-no into the codebase? Read on to see how this happened and how gnarly it was to fix!
">
<meta property="og:description" content="About a month ago, I was benchmarking the impact of a new Bazel feature and I noticed that a test build that should have taken only a few seconds took almost 10 minutes. My Internet connection was flaking out indeed, but something else didn&amp;rsquo;t seem right. So I looked and found that Bazel was doing network calls within a critical section, and these were the root cause behind the massive slowdown. But how did we get such an obvious no-no into the codebase? Read on to see how this happened and how gnarly it was to fix!
">
<meta name=author content="Julio Merino">
<meta name=generator content="Hugo 0.92.1">
<meta property="og:url" content="https://jmmv.dev/2020/09/bazel-ui-locking.html">
<meta property="og:type" content="blog">
<link rel=canonical href=https://jmmv.dev/2020/09/bazel-ui-locking.html>
<link rel=alternate type=application/rss+xml title="Julio Merino (jmmv.dev)" href=/feed.xml>
<link rel=stylesheet href=/sass/main.min.fcc0c3ac24aaeb89fcb92a6ad071a76e1f7cb4657f630c136e97fd0eda279808.css>
<link rel=stylesheet href=/css/chroma.css>
<meta property="og:image" content="/images/favicons/favicon-1200x1200.png">
<link rel=icon type=image/png href=/images/favicons/favicon-16x16.png sizes=16x16>
<link rel=icon type=image/png href=/images/favicons/favicon-32x32.png sizes=32x32>
<link rel=icon type=image/png href=/images/favicons/favicon-96x96.png sizes=96x96><!--[if lt IE 9]><script src=/js/html5shiv-3.7.2.min.js></script>
<script src=/js/respond-1.4.2.min.js></script><![endif]-->
<script>const SITE_ID='e8da9f62-b7ac-4fe9-bf20-7c527199a376',BASE_URL='https://jmmv.dev/'</script>
</head>
<body>
<header class=site-header>
<nav class="navbar navbar-expand-lg fixed-top navbar-dark bg-primary">
<a class=navbar-brand href=/>
<img src=/images/favicons/favicon-30x30.png width=30 height=30 class="d-inline-block align-top" alt>
&nbsp;Julio Merino
</a>
<button class=navbar-toggler type=button data-toggle=collapse data-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span>
</button>
<div class="collapse navbar-collapse" id=navbarSupportedContent>
<ul class="navbar-nav mr-auto">
<li class=nav-item>
<a class=nav-link href=/about.html>About</a>
</li>
<li class=nav-item>
<a class=nav-link href=/essays.html>Essays</a>
</li>
<li class=nav-item>
<a class=nav-link href=/resume.html>Resume</a>
</li>
<li class=nav-item>
<a class=nav-link href=/software.html>Software</a>
</li>
</ul>
<ul class="navbar-nav mr-4">
<li class=nav-item>
<a class=nav-link href=/stats.html>Analytics</a>
</li>
<li class=nav-item>
<a class=nav-link href=/archive.html>Archive</a>
</li>
<li class=nav-item>
<a class=nav-link href=/series.html>Series</a>
</li>
<li class=nav-item>
<a class=nav-link href=/tags.html>Tags</a>
</li>
</ul>
<form class=form-inline method=get role=search action=https://www.google.com/search>
<div class=input-group>
<input type=search name=query class=form-control placeholder=Search aria-label=Search>
<div class=input-group-append>
<button type=submit value=Search class="btn btn-light">
<img src=/octicons/search.svg>
</button>
</div>
</div>
<input type=hidden name=sitesearch value=https://jmmv.dev/>
</form>
</div>
</nav>
</header>
<div class=page-header>
<div class=container>
<h1>Bazel UI locking and file downloads</h1>
<p>September 1, 2020 &#183;
About 12 minutes
&#183;
Tags:
<a class=text-reset href=/tags/bazel>bazel</a>, <a class=text-reset href=/tags/bug>bug</a></p>
</div>
</div>
<div class=container>
<div class=row>
<div class=col-md-9>
<div class=row>
<div class=col>
<article><p>About a month ago, I was benchmarking the impact of a new Bazel feature and I noticed that a test build that should have taken only a few seconds took almost 10 minutes. My Internet connection was flaking out indeed, but something else didn&rsquo;t seem right. So I looked and found that Bazel was doing network calls within a critical section, and these were the root cause behind the massive slowdown. But how did we get such an obvious no-no into the codebase? Read on to see how this happened and how gnarly it was to fix!</p>
<hr>
<p>If you are a Bazel user, you know that we at Google use remote build services for pretty much all of our builds. (And by the way: <a href=https://docs.bazel.build/versions/master/remote-execution.html>you can&mdash;and should&mdash;do too</a>!)</p>
<p>Remote-based builds work great when the client machine is attached to a high speed/low latency network&mdash;which was the common scenario for us in the office, pre-COVID-19. But with an increasing <em>working from home (WFH)</em> scenario&mldr; we now face less-than-deal Internet connections, and these are surfacing subtle long-standing issues throughout.</p>
<p>One of these issues became visible about a month ago when I was benchmarking the behavior of a new feature. To measure that feature&rsquo;s impact, I was running a build at home and noticed that the build progressed at a glacial pace. I guessed my network connection was misbehaving&mdash;and it was. But things didn&rsquo;t add up. Even under those conditions, the build seemed much slower than it should have been. In particular, all build actions appeared to complete sequentially despite the large number of <code>--jobs</code> (hundreds) we use for remote builds.</p>
<h1 id=first-analysis>First analysis</h1>
<p>Seeing actions print messages to the terminal in slow succession made me go <em>&ldquo;huh, that&rsquo;s interesting&rdquo;</em>&mdash;which, you know, is how many <del>horror movies</del> troubleshooting scenarios and great discoveries start.</p>
<p>My instinctive reaction was to grab a thread dump from the slow Bazel instance with <code>jstack</code> while it was still running. The dump was insightful because all Skyframe threads look identical in it:</p>
<pre tabindex=0><code>&quot;skyframe-evaluator-23&quot; #1425 daemon prio=5 os_prio=0 cpu=9.67ms elapsed=6.10s tid=0x0000073ef9a2c000 nid=0xd1ad1 waiting for monitor entry  [0x00007f7673746000]
   java.lang.Thread.State: BLOCKED (on object monitor)
        at com.google.devtools.build.lib.runtime.UiEventHandler.actuallyHandle(UiEventHandler.java:286)
        - waiting to lock &lt;0x00000005b2b58248&gt; (a com.google.devtools.build.lib.runtime.UiEventHandler)
        at com.google.devtools.build.lib.runtime.UiEventHandler.handleInternal(UiEventHandler.java:390)
        at com.google.devtools.build.lib.runtime.UiEventHandler.handle(UiEventHandler.java:409)
        at com.google.devtools.build.lib.events.Reporter.handle(Reporter.java:142)
        at com.google.devtools.build.lib.skyframe.SkyframeActionExecutor.dumpRecordedOutErr(SkyframeActionExecutor.java:1646)
        at com.google.devtools.build.lib.skyframe.SkyframeActionExecutor.dumpRecordedOutErr(SkyframeActionExecutor.java:1629)
        at com.google.devtools.build.lib.skyframe.SkyframeActionExecutor.access$1800(SkyframeActionExecutor.java:131)
        at com.google.devtools.build.lib.skyframe.SkyframeActionExecutor$ActionRunner.actuallyCompleteAction(SkyframeActionExecutor.java:1094)
        at com.google.devtools.build.lib.skyframe.SkyframeActionExecutor$ActionRunner.continueAction(SkyframeActionExecutor.java:1065)
        at com.google.devtools.build.lib.skyframe.SkyframeActionExecutor$ActionRunner.run(SkyframeActionExecutor.java:975)
        at com.google.devtools.build.lib.skyframe.ActionExecutionState.runStateMachine(ActionExecutionState.java:129)
        at com.google.devtools.build.lib.skyframe.ActionExecutionState.getResultOrDependOnFuture(ActionExecutionState.java:81)
        at com.google.devtools.build.lib.skyframe.SkyframeActionExecutor.executeAction(SkyframeActionExecutor.java:464)
        at com.google.devtools.build.lib.skyframe.ActionExecutionFunction.checkCacheAndExecuteIfNeeded(ActionExecutionFunction.java:842)
        at com.google.devtools.build.lib.skyframe.ActionExecutionFunction.compute(ActionExecutionFunction.java:312)
        at com.google.devtools.build.skyframe.AbstractParallelEvaluator$Evaluate.run(AbstractParallelEvaluator.java:438)
        at com.google.devtools.build.lib.concurrent.AbstractQueueVisitor$WrappedRunnable.run(AbstractQueueVisitor.java:398)
        at java.util.concurrent.ForkJoinTask$AdaptedRunnableAction.exec(java.base@11/ForkJoinTask.java:1407)
        at java.util.concurrent.ForkJoinTask.doExec(java.base@11/ForkJoinTask.java:290)
        at java.util.concurrent.ForkJoinPool$WorkQueue.topLevelExec(java.base@11/ForkJoinPool.java:1020)
        at java.util.concurrent.ForkJoinPool.scan(java.base@11/ForkJoinPool.java:1656)
        at java.util.concurrent.ForkJoinPool.runWorker(java.base@11/ForkJoinPool.java:1594)
        at java.util.concurrent.ForkJoinWorkerThread.run(java.base@11/ForkJoinWorkerThread.java:177)

... and hundreds more &quot;skyframe-evaluator N&quot; entries like this ...
</code></pre><p>In other words: all Skyframe threads are waiting on a lock to enter the gigantic critical section in <a href="https://cs.opensource.google/bazel/bazel/+/master:src/main/java/com/google/devtools/build/lib/runtime/UiEventHandler.java;l=285;drc=5bb3becc09ef535276576a31d98d8686b248bbea"><code>UiEventHandler#actuallyHandle</code> (rev <code>5bb3bec</code>)</a>.</p>
<p>IMPORTANT: What&rsquo;s critical to know at this point is that <em>there is one Skyframe thread for every concurrent <code>--jobs</code></em>: in other words, these are the threads executing actions, so if they are all waiting on the same lock, parallel execution is worthless.</p>
<p>The lock all these threads are waiting on belongs in the UI. Wait, what? That sounds dumb. Why are the Skyframe threads locking <em>in the UI</em>? Sure, this is not a graphical application, but <a href=/2013/08/cli-design-cli-is-presentation-layer.html>it still has a UI</a>&mdash;and haven&rsquo;t we learn by now, in this day and age, that the UI must be decoupled from actual processing?</p>
<p>Alright, alright, so they are all blocked in the same way. But blocked <em>on what</em>? As it turns out, they are all waiting for <em>one other</em> Skyframe thread to complete:</p>
<pre tabindex=0><code>&quot;skyframe-evaluator-178&quot; #1612 daemon prio=5 os_prio=0 cpu=7.42ms elapsed=5.94s tid=0x0000073ef973c000 nid=0xd1bda runnable  [0x00007f766c984000]
   java.lang.Thread.State: RUNNABLE
        at java.io.FileInputStream.readBytes(java.base@11/Native Method)
        at java.io.FileInputStream.read(java.base@11/FileInputStream.java:279)
        at com.google.common.io.ByteStreams.toByteArrayInternal(ByteStreams.java:181)
        at com.google.common.io.ByteStreams.toByteArray(ByteStreams.java:221)
        at com.google.devtools.build.lib.util.io.FileOutErr$FileOutputReference.getFinalBytes(FileOutErr.java:555)
        at com.google.devtools.build.lib.runtime.UiEventHandler.writeToStream(UiEventHandler.java:415)
        at com.google.devtools.build.lib.runtime.UiEventHandler.actuallyHandle(UiEventHandler.java:368)
        - locked &lt;0x00000005b2b58248&gt; (a com.google.devtools.build.lib.runtime.UiEventHandler)
        at com.google.devtools.build.lib.runtime.UiEventHandler.handleInternal(UiEventHandler.java:390)
        at com.google.devtools.build.lib.runtime.UiEventHandler.handle(UiEventHandler.java:409)
        at com.google.devtools.build.lib.events.Reporter.handle(Reporter.java:142)
        at com.google.devtools.build.lib.skyframe.SkyframeActionExecutor.dumpRecordedOutErr(SkyframeActionExecutor.java:1646)
        at com.google.devtools.build.lib.skyframe.SkyframeActionExecutor.dumpRecordedOutErr(SkyframeActionExecutor.java:1629)
        at com.google.devtools.build.lib.skyframe.SkyframeActionExecutor.access$1800(SkyframeActionExecutor.java:131)
        at com.google.devtools.build.lib.skyframe.SkyframeActionExecutor$ActionRunner.actuallyCompleteAction(SkyframeActionExecutor.java:1094)
        at com.google.devtools.build.lib.skyframe.SkyframeActionExecutor$ActionRunner.continueAction(SkyframeActionExecutor.java:1065)
        at com.google.devtools.build.lib.skyframe.SkyframeActionExecutor$ActionRunner.run(SkyframeActionExecutor.java:975)
        at com.google.devtools.build.lib.skyframe.ActionExecutionState.runStateMachine(ActionExecutionState.java:129)
        at com.google.devtools.build.lib.skyframe.ActionExecutionState.getResultOrDependOnFuture(ActionExecutionState.java:81)
        at com.google.devtools.build.lib.skyframe.SkyframeActionExecutor.executeAction(SkyframeActionExecutor.java:464)
        at com.google.devtools.build.lib.skyframe.ActionExecutionFunction.checkCacheAndExecuteIfNeeded(ActionExecutionFunction.java:842)
        at com.google.devtools.build.lib.skyframe.ActionExecutionFunction.compute(ActionExecutionFunction.java:312)
        at com.google.devtools.build.skyframe.AbstractParallelEvaluator$Evaluate.run(AbstractParallelEvaluator.java:438)
        at com.google.devtools.build.lib.concurrent.AbstractQueueVisitor$WrappedRunnable.run(AbstractQueueVisitor.java:398)
        at java.util.concurrent.ForkJoinTask$AdaptedRunnableAction.exec(java.base@11/ForkJoinTask.java:1407)
        at java.util.concurrent.ForkJoinTask.doExec(java.base@11/ForkJoinTask.java:290)
        at java.util.concurrent.ForkJoinPool$WorkQueue.topLevelExec(java.base@11/ForkJoinPool.java:1020)
        at java.util.concurrent.ForkJoinPool.scan(java.base@11/ForkJoinPool.java:1656)
        at java.util.concurrent.ForkJoinPool.runWorker(java.base@11/ForkJoinPool.java:1594)
        at java.util.concurrent.ForkJoinWorkerThread.run(java.base@11/ForkJoinWorkerThread.java:177)
</code></pre><p>&mldr; and this thread that holds the lock is doing I/O as we can see from the top of the stacktrace. The thread is busy reading from a stream, and it all happens deep inside <code>UiEventHandler#actuallyHandle</code>. Sounds like a pretty obvious problem: I/O inside a critical section.</p>
<p>But if this was such an &ldquo;obvious&rdquo; performance problem, how come I was the first one to notice?</p>
<p>There are a couple of reasons. First, I&rsquo;m in the team that supports builds from home, so I get to run a lot of these on a suboptimal network link. And, second, this problematic build I encountered spews tons of warning messages from the Objective C compiler. Comparing the behavior of this build to any other well-behaved build (one that <em>doesn&rsquo;t</em> generate thousands of warnings) didn&rsquo;t show the problem.</p>
<h1 id=remote-execution-fuse-and-outputs>Remote execution, FUSE, and outputs</h1>
<p>So far we have diagnosed the potential problem: we have a critical section that does some I/O and all Skyframe threads have to go through it. Why is this specific I/O problematic and why are all threads trying to enter it?</p>
<p>To reach an answer, we must first understand how Bazel runs actions&mdash;and, in particular, how Bazel prints the output of an action to the local console when the action has run on a different, remote machine.</p>
<p>When an action runs remotely, the stdout/stderr streams of the action are generated remotely, obviously. If Bazel wants to show them to the user, it has to explicitly download them from the remote service. Users typically expect a build system to print the stdout/stderr streams of any actions it runs because they typically contain warnings and errors, so Bazel does download these files at all times.</p>
<p>Typically, network calls look very obvious in code because they look different than everything else. If you are writing a network call, you are very aware that you are doing it. And if you are reading code, network calls are painfully visible because they aren&rsquo;t simple function calls (as much as gRPC and the like want to make you believe).</p>
<p>WARNING: If you are writing or reviewing code and you notice a network call inside a critical section (<code>synchronized</code> block in Java), all alarms should go off.</p>
<p>But things are more subtle in our stack at Google. As you may know, we have a FUSE file system to lazily fetch outputs from the remote execution service: Bazel can simply assume that such files are on disk and thus can access them via regular POSIX calls. The stdout/stderr outputs of remote actions are no exception: these are exposed via this FUSE file system too and Bazel can read them as necessary with regular file system operations.</p>
<p>To make things more obscure, Bazel has high-level abstractions on top of these streams (the <a href="https://cs.opensource.google/bazel/bazel/+/master:src/main/java/com/google/devtools/build/lib/util/io/OutErr.java;drc=5bb3becc09ef535276576a31d98d8686b248bbea"><code>OutErr</code></a> and <a href="https://cs.opensource.google/bazel/bazel/+/master:src/main/java/com/google/devtools/build/lib/util/io/FileOutErr.java;drc=5bb3becc09ef535276576a31d98d8686b248bbea"><code>FileOutErr</code></a> classes). I say obscure because, the more abstractions you have between the code and its side-effects, the harder it is to spot what is happening under the hood.</p>
<p>By this point you should start piecing things together: the critical section in <code>UiEventHandler#actuallyHandle</code> was hiding both file I/O via <code>OutErr</code> and network calls via FUSE. These two became pathological under specific conditions.</p>
<p>That&rsquo;s a problem, but it still doesn&rsquo;t explain why the Skyframe threads would choke on <em>the UI</em> code. Yes, we need to print the stdout and stderr of any action we run, but why weren&rsquo;t the individual Skyframe threads downloading those files without holding a lock? After all, they do precisely this for regular file outputs, so they might as well download the stdout/stderr first and then feed them to the UI, right?</p>
<p>Enter another abstraction layer: the <a href="https://cs.opensource.google/bazel/bazel/+/master:src/main/java/com/google/devtools/build/lib/events/Reporter.java;drc=5bb3becc09ef535276576a31d98d8686b248bbea"><code>Reporter</code></a>, which is used to communicate user-visible events across modules. The <code>Reporter</code> has a method called <code>handle</code> that runs arbitrary code and does so synchronously. Each Skyframe thread calls this method to report the stdout and stderr of an action on completion via <a href="https://cs.opensource.google/bazel/bazel/+/master:src/main/java/com/google/devtools/build/lib/skyframe/SkyframeActionExecutor.java;l=1646;drc=5bb3becc09ef535276576a31d98d8686b248bbea"><code>SkyframeActionExecutor#dumpRecordedOutErr</code></a>.</p>
<p>And finally we reach the true problem. The <code>Reporter</code> is just an interface so the caller has no idea about the implementation it uses. As it turns out&mldr; the <code>UiEventHandler</code> class we&rsquo;ve been talking about <em>is</em> a <code>Reporter</code> and its synchronous <code>handle</code> method calls that huge critical section that reads stdout/stderr from within, potentially faulting remote files in via FUSE.</p>
<h1 id=reproduction-scenario>Reproduction scenario</h1>
<p>To verify this theory and quantify the seriousness of the bug, I wrote a trivial <code>BUILD</code> rule like this:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=n>TSID</span> <span class=o>=</span> <span class=s2>&#34;1234567909&#34;</span>
<span class=p>[</span><span class=n>genrule</span><span class=p>(</span>
    <span class=n>name</span> <span class=o>=</span> <span class=s2>&#34;foo-</span><span class=si>%d</span><span class=s2>&#34;</span> <span class=o>%</span> <span class=n>i</span><span class=p>,</span>
    <span class=n>outs</span> <span class=o>=</span> <span class=p>[(</span><span class=s2>&#34;foo-</span><span class=si>%d</span><span class=s2>.txt&#34;</span><span class=p>)</span> <span class=o>%</span> <span class=n>i</span><span class=p>],</span>
    <span class=n>cmd</span> <span class=o>=</span> <span class=p>(</span><span class=s2>&#34;echo </span><span class=si>%s</span><span class=s2> - </span><span class=si>%d</span><span class=s2>; echo </span><span class=si>%d</span><span class=s2> &gt;$@&#34;</span><span class=p>)</span> <span class=o>%</span> <span class=p>(</span><span class=n>TSID</span><span class=p>,</span> <span class=n>i</span><span class=p>,</span> <span class=n>i</span><span class=p>),</span>
<span class=p>)</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>10000</span><span class=p>)]</span>
</code></pre></div><p>&mldr; and I ran it like this, where I used the <code>TSID</code> trick to generate unique actions (which are important to reproduce this scenario!) in each attempt:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell>sed -itmp -e <span class=s2>&#34;/^TSID =/s/\&#34;.*</span>$<span class=s2>/\&#34;</span><span class=k>$(</span>date +%s<span class=k>)</span><span class=s2>\&#34;/&#34;</span> pkg/BUILD
bazel clean
bazel build //pkg/...
</code></pre></div><p>The goal of this test is to see what happens when we have thousands of uncached and independent actions, each writing a novel and unique message to its stdout. Under these conditions, we expect Bazel to run as many actions concurrently as allowed by <code>--jobs</code> given that they do not depend on each other. We also expect Bazel to print the outputs of each action in no particular order. And because we are generating novel outputs on each run thanks to the <code>TSID</code> changes, we know that those outputs will not be cached in any layer: not in the local page cache, not in the remote build system&rsquo;s cache, and not in the local FUSE daemon.</p>
<p>Voilà. Running this test took almost 10 minutes! Yes&mldr; 10 minutes to run a build that creates 10,000 different files with one line of text each. For comparison, my 2013 Mac Pro can create these files in 4 seconds with a parallelism of 12. How can Bazel behave so poorly then? Essentially because every stdout read blocks on a network call via the lazy FUSE file system. If we count, this translates to about 60ms per file, which isn&rsquo;t terrible, but 60ms times 10,000 is 10 minutes.</p>
<h1 id=coming-up-with-a-fix>Coming up with a fix</h1>
<p>When I found this bug over a month ago, I was very excited because I was convinced that this was a contributing factor to our still-ugly build tail latency, especially on WFH environments. But fixing the problem has proven to be much more complicated&mdash;and frustrating&mdash;than I had hoped.</p>
<p>At first, I toyed with the idea of delivering events to the UI asynchronously so as to not block the Skyframe threads. In other words, make <code>Reporter#handle()</code> queue events instead of blocking. Fancy, right? This quickly turned into a pretty complex solution and stabilizing it would have required a ton of effort. Sure, this would have looked <em>cool</em> from a coding perspective, but the increasing complexity wasn&rsquo;t warranted.</p>
<p>As a second approach, I added code to prefetch the stdout/stderr of actions outside of the synchronized block by doing dummy reads of the files. The intent was to cause our FUSE daemon to do the downloads first, so that the I/O calls within the critical section didn&rsquo;t have to touch the network. This worked but, as you can imagine, <a href=https://github.com/janakdr/>janakdr@</a> pointed out that removing the I/O from within the critical section would be the right thing to do. Of course, I thought&mldr; but this comes with a trade off.</p>
<p>You might be wondering why the I/O happened inside the critical section in the first place. There were two reasons:</p>
<ol>
<li>
<p>The UI tried to dynamically limit the amount of data printed to the console based on a concept of &ldquo;remaining capacity&rdquo;. And because of this, we couldn&rsquo;t know how much data to read from the output files before grabbing the state lock.</p>
<p><a href=https://github.com/michajlo>michajlo@</a>, who reviewed my code, raised the very good point that the current design of the UI looked overly complicated and that some features were getting in the way of fixing the issue described here. So we teamed up and simplified things, first by <a href=https://github.com/bazelbuild/bazel/commit/a6935cd0857a2008f7957b663ba1c7364ee9c0dc>removing message deduplication</a> and then by <a href=https://github.com/bazelbuild/bazel/commit/5bb3becc09ef535276576a31d98d8686b248bbea>removing the dynamic capacity limiting logic</a>.</p>
</li>
<li>
<p>The UI doesn&rsquo;t want to mess its own console state tracking, which is super complicated, with the printing of a file. Printing the file should not interfere with the multi-line status display, and the outputs of different actions shouldn&rsquo;t be intermixed. By doing the I/O in the critical section, then, we know we are the only writer to the console so we know dumping a large file won&rsquo;t corrupt any other state. This is a property we have chosen to maintain for now.</p>
</li>
</ol>
<p>As a consequence of these two, we can move all I/O outside of the critical section, but we still need to do the console writes <em>inside</em> the critical section to respect the properties mentioned above. The downside of doing this is that we need to buffer more data in memory (because we need to read the outputs before grabbing the lock, which means we might have <code>--jobs</code> concurrent threads doing that).</p>
<h1 id=imposing-sensible-limits>Imposing sensible limits</h1>
<p>Buffering the output of hundreds of concurrent actions could increase our high watermark memory usage. We had to add a limit to prevent memory blowups given that we know there are misbehaved actions out there generating MiBs of useless output.</p>
<p>The first suggestion was to add a flag to cap the maximum memory usage by the UI and use a semaphore to track usage. Think of each semaphore permit as a &ldquo;used byte&rdquo;. Neat design, but implementing this still required dealing with files larger than the configured flag, and printing only part of their contents was still deemed as too complex.</p>
<p>The second suggestion was to be more aggressive: cap how much a given action can print and not worry about tracking aggregate usage. After all, if an action is printing more than, say, a few hundred KiBs of data to the console, it&rsquo;s already &ldquo;misbehaving&rdquo; in the sense that nobody will possibly want to read such data. By setting this flag to a more conservative value, like 1 MiB, we know we are limiting aggregate memory usage too, and we also have a straightforward implementation.</p>
<p>So in the end, we chose to go this second route in <a href=https://cs.opensource.google/bazel/bazel/+/ca2f946e1cd259903ea29ba2fe0adc6619ac39e0>rev <code>ca2f946</code></a>.</p>
<p>The new flag <code>--experimental_ui_max_stdouterr_memory_bytes</code> caps the size of the stdout/stderr Bazel will print for any given action.</p>
<h1 id=results>Results</h1>
<p>How does our fix perform?</p>
<p>For the pathological build described above, the fix reduces execution time from 6 minutes to 27 seconds on a machine I have in the office (great Internet connection). On my home machine with a more modest connection, the execution time goes from 12 minutes to 60 seconds. These numbers do not match the 10 minutes I mentioned earlier, but these timings are pretty variable and different across runs.</p>
<p>The more interesting result will be to see how this improves overall build time latencies. As mentioned in the opening, I&rsquo;m certain this bug is slowing down some of our interactive builds&mdash;and those are where you want to have the fastest possible edit/build/test cycle. Unfortunately, the fix has just been submitted today so it&rsquo;ll still take a few weeks for me to have that kind of proof!</p>
<p>Wow, this turned out to be much longer than anticipated. Hope you enjoyed the tour.</p></article>
</div>
</div>
<div class="container post-votes">
<div class=row>
<div class=col-md-6>
<p id=vote-request>
<b>What did you think about this article?</b><small>
<i>(Experimental)</i></small>
<br>
<b><span id=first-vote></span></b>
</p>
</div>
<div class=col-md-3>
<a onclick=voteThumbsUp() class="btn btn-block btn-outline-success" id=thumbs-up-btn>👍
(<span id=thumbs-up-count>0</span>)</a>
</div>
<div class=col-md-3>
<a onclick=voteThumbsDown() class="btn btn-block btn-outline-danger" id=thumbs-down-btn>👎
(<span id=thumbs-down-count>0</span>)</a>
</div>
</div>
<div class="row mt-3">
<div class="col-md-4 text-center"><a href="https://www.reddit.com/submit?title=Bazel+UI+locking+and+file+downloads&url=https%3A%2F%2Fjmmv.dev%2F2020%2F09%2Fbazel-ui-locking.html" class="btn btn-outline-primary">
<img src=/images/badges/reddit.png alt="Reddit logo" width=24 height=24>
Share on Reddit
</a>
</div>
<div class="col-md-4 text-center"><a href="https://news.ycombinator.com/submitlink?t=Bazel+UI+locking+and+file+downloads&u=https%3A%2F%2Fjmmv.dev%2F2020%2F09%2Fbazel-ui-locking.html" class="btn btn-outline-primary">
<img src=/images/badges/ycombinator.png alt="Hacker News logo" width=24 height=24>
Share on Hacker News
</a>
</div>
<div class="col-md-4 text-center"><a href="https://twitter.com/intent/tweet?status=Bazel+UI+locking+and+file+downloads+%E2%80%94+https%3A%2F%2Fjmmv.dev%2F2020%2F09%2Fbazel-ui-locking.html+%E2%80%94+cc+%40jmmv" class="btn btn-outline-primary">
<img src=/images/badges/Twitter_Social_Icon_Circle_Color.png alt="Twitter logo" width=24 height=24>
Share on Twitter
</a>
</div>
</div>
</div>
<div class="container post-links">
<div class=row>
<div class="col-md-12 text-center">
<p><b>Want more posts like this one? Take a moment to subscribe.</b></p>
</div>
</div>
<div class=row>
<div class=col-md-10>
<form action="https://api.follow.it/subscription-form/WWZwVlFmTks4enBrYytaNHorbE4zSnpRTTBoTy9PcXNsZjdQbVpmWDJDemwyVW9rc2llZHNxQW9iUGdXNG83dm11SWZDM0NKSlQ5Qm1LTUpJZnF2b0Z5WDE3UUtvaEgzTWRWUFBQWEo4RUxyNUt5UW4xN3VZaW9paEd1UUFCL1J8YStTYmVCc3VoVGhCeENNSVZHSmEyUk1hejZWaEZkT1M1WTVkSXdBY1Q5cz0=/8" method=post>
<div class="form-group row px-md-4">
<input type=text name=email placeholder="Enter your email" class="form-control input-sm col-md-9 text-center">
<button type=submit class="btn btn-primary col-md-3">Subscribe</button>
</div>
</form>
</div>
<div class="col-md-1 text-center">
<p>
<a href="https://twitter.com/intent/follow?original_referer=https%3A%2F%2Fjmmv.dev%2F&screen_name=jmmv">
<img src=/images/badges/Twitter_logo_blue.svg width=32px height=32px alt="Follow @jmmv on Twitter">
</a>
</p>
</div>
<div class="col-md-1 text-center">
<p><a href=/feed.xml><img src=/images/badges/feed-icon-28x28.png alt="RSS feed"></a></p>
</div>
</div>
</div>
<div class="container post-links">
<div class=row>
<div class="col mr-auto text-left">
<span><a href=https://jmmv.dev/2020/08/pkgdb-libdata-var.html>&#171; Previous post</a></span>
</div>
<div class="col text-center">
<span><a href=/archive.html>All posts</a></span>
</div>
<div class="col ml-auto text-right">
<span><a href=https://jmmv.dev/2020/09/bazel-test-streaming-bug.html>Next post &#187;</a></span>
</div>
</div>
</div>
</div>
<div class="col-md-3 sidebar d-none d-md-block">
<div class=row>
<div class="col text-center p-2">
<p><a href=/about.html class=clear-link>
<img src=/images/avatars/20181124-snow.jpg class="rounded-circle shadow my-2" style=width:100px><br>
<b>Julio Merino</b><br>
Principal Software Engineer<br>
<small>#FreeBSD, #Unix, #Rust, #Bazel, #blogger</small><br>
<small>From Barcelona, living in Seattle</small>
</a></p>
<div class=row>
<div class="col-sm-6 text-center">
<p>
<a href="https://twitter.com/intent/follow?original_referer=https%3A%2F%2Fjmmv.dev%2F&screen_name=jmmv">
<img src=/images/badges/Twitter_logo_blue.svg width=32px height=32px alt="Follow @jmmv on Twitter">
</a>
</p>
</div>
<div class="col-sm-6 text-center">
<p><a href=/feed.xml><img src=/images/badges/feed-icon-28x28.png alt="RSS feed"></a></p>
</div>
</div>
<form action="https://api.follow.it/subscription-form/WWZwVlFmTks4enBrYytaNHorbE4zSnpRTTBoTy9PcXNsZjdQbVpmWDJDemwyVW9rc2llZHNxQW9iUGdXNG83dm11SWZDM0NKSlQ5Qm1LTUpJZnF2b0Z5WDE3UUtvaEgzTWRWUFBQWEo4RUxyNUt5UW4xN3VZaW9paEd1UUFCL1J8YStTYmVCc3VoVGhCeENNSVZHSmEyUk1hejZWaEZkT1M1WTVkSXdBY1Q5cz0=/8" method=post>
<div class=form-group>
<input type=text name=email placeholder="Enter your email" class="form-control input-sm text-center">
<button type=submit class="btn btn-primary btn-block">Subscribe</button>
</div>
</form>
</div>
</div>
<div class=row>
<div class=col>
<h2>Featured posts</h2>
<ul>
<li class=indent-wrapped-lines><a href=/2021/11/endbasic-0.8.html>EndBASIC 0.8: Now, with graphics!</a></li>
<li class=indent-wrapped-lines><a href=/2021/07/endbasic-0.7.html>EndBASIC 0.7: Hello, cloud!</a></li>
<li class=indent-wrapped-lines><a href=/2021/04/always-be-quitting.html>Always be quitting</a></li>
<li class=indent-wrapped-lines><a href=/2021/02/google-monorepos-and-caching.html>How does Google keep build times low?</a></li>
<li class=indent-wrapped-lines><a href=/2020/12/google-no-clean-builds.html>How does Google avoid clean builds?</a></li>
<li class=indent-wrapped-lines><a href=/2020/12/unit-testing-a-console-app.html>Unit-testing a console app (a text editor)</a></li>
<li class=indent-wrapped-lines><a href=/2020/11/wsl-lost-potential.html>Windows Subsystem for Linux: The lost potential</a></li>
<li class=indent-wrapped-lines><a href=/2020/10/bye-google-hi-microsoft.html>Farewell, Google; hello, Microsoft!</a></li>
<li class=indent-wrapped-lines><a href=/2020/08/config-files-vs-directories.html>Configuration files and .d directories</a></li>
<li class=indent-wrapped-lines><a href=/2020/05/bridging-the-web-gap-endbasic.html>Bridging the web gap in EndBASIC</a></li>
<li class=indent-wrapped-lines><a href=/essays.html#featured>More...</a></li>
</ul>
</div>
</div>
<div class=row>
<div class=col>
<h2>Archive</h2>
<ul>
<li>
<a data-toggle=collapse href=#archive-year-2022>2022</a> (1)
<ul id=archive-year-2022 class=collapse>
<li><a href=/archive.html#2022-01>January 2022</a> (1)</li>
</ul>
</li>
<li>
<a data-toggle=collapse href=#archive-year-2021>2021</a> (22)
<ul id=archive-year-2021 class=collapse>
<li><a href=/archive.html#2021-11>November 2021</a> (2)</li>
<li><a href=/archive.html#2021-08>August 2021</a> (2)</li>
<li><a href=/archive.html#2021-07>July 2021</a> (5)</li>
<li><a href=/archive.html#2021-06>June 2021</a> (1)</li>
<li><a href=/archive.html#2021-04>April 2021</a> (2)</li>
<li><a href=/archive.html#2021-03>March 2021</a> (2)</li>
<li><a href=/archive.html#2021-02>February 2021</a> (3)</li>
<li><a href=/archive.html#2021-01>January 2021</a> (5)</li>
</ul>
</li>
<li>
<a data-toggle=collapse href=#archive-year-2020>2020</a> (36)
<ul id=archive-year-2020 class=collapse>
<li><a href=/archive.html#2020-12>December 2020</a> (4)</li>
<li><a href=/archive.html#2020-11>November 2020</a> (5)</li>
<li><a href=/archive.html#2020-10>October 2020</a> (5)</li>
<li><a href=/archive.html#2020-09>September 2020</a> (2)</li>
<li><a href=/archive.html#2020-08>August 2020</a> (6)</li>
<li><a href=/archive.html#2020-07>July 2020</a> (2)</li>
<li><a href=/archive.html#2020-06>June 2020</a> (2)</li>
<li><a href=/archive.html#2020-05>May 2020</a> (3)</li>
<li><a href=/archive.html#2020-04>April 2020</a> (2)</li>
<li><a href=/archive.html#2020-03>March 2020</a> (2)</li>
<li><a href=/archive.html#2020-02>February 2020</a> (1)</li>
<li><a href=/archive.html#2020-01>January 2020</a> (2)</li>
</ul>
</li>
<li>
<a data-toggle=collapse href=#archive-year-2019>2019</a> (24)
<ul id=archive-year-2019 class=collapse>
<li><a href=/archive.html#2019-12>December 2019</a> (8)</li>
<li><a href=/archive.html#2019-11>November 2019</a> (6)</li>
<li><a href=/archive.html#2019-10>October 2019</a> (1)</li>
<li><a href=/archive.html#2019-09>September 2019</a> (2)</li>
<li><a href=/archive.html#2019-03>March 2019</a> (2)</li>
<li><a href=/archive.html#2019-02>February 2019</a> (3)</li>
<li><a href=/archive.html#2019-01>January 2019</a> (2)</li>
</ul>
</li>
<li>
<a data-toggle=collapse href=#archive-year-2018>2018</a> (25)
<ul id=archive-year-2018 class=collapse>
<li><a href=/archive.html#2018-07>July 2018</a> (3)</li>
<li><a href=/archive.html#2018-06>June 2018</a> (7)</li>
<li><a href=/archive.html#2018-05>May 2018</a> (2)</li>
<li><a href=/archive.html#2018-04>April 2018</a> (2)</li>
<li><a href=/archive.html#2018-03>March 2018</a> (8)</li>
<li><a href=/archive.html#2018-02>February 2018</a> (3)</li>
</ul>
</li>
<li>
<a data-toggle=collapse href=#archive-year-2017>2017</a> (6)
<ul id=archive-year-2017 class=collapse>
<li><a href=/archive.html#2017-10>October 2017</a> (1)</li>
<li><a href=/archive.html#2017-08>August 2017</a> (1)</li>
<li><a href=/archive.html#2017-07>July 2017</a> (1)</li>
<li><a href=/archive.html#2017-02>February 2017</a> (3)</li>
</ul>
</li>
<li>
<a data-toggle=collapse href=#archive-year-2016>2016</a> (8)
<ul id=archive-year-2016 class=collapse>
<li><a href=/archive.html#2016-09>September 2016</a> (1)</li>
<li><a href=/archive.html#2016-05>May 2016</a> (1)</li>
<li><a href=/archive.html#2016-04>April 2016</a> (1)</li>
<li><a href=/archive.html#2016-03>March 2016</a> (2)</li>
<li><a href=/archive.html#2016-02>February 2016</a> (1)</li>
<li><a href=/archive.html#2016-01>January 2016</a> (2)</li>
</ul>
</li>
<li>
<a data-toggle=collapse href=#archive-year-2015>2015</a> (17)
<ul id=archive-year-2015 class=collapse>
<li><a href=/archive.html#2015-12>December 2015</a> (2)</li>
<li><a href=/archive.html#2015-10>October 2015</a> (2)</li>
<li><a href=/archive.html#2015-09>September 2015</a> (3)</li>
<li><a href=/archive.html#2015-06>June 2015</a> (2)</li>
<li><a href=/archive.html#2015-05>May 2015</a> (3)</li>
<li><a href=/archive.html#2015-04>April 2015</a> (1)</li>
<li><a href=/archive.html#2015-03>March 2015</a> (1)</li>
<li><a href=/archive.html#2015-02>February 2015</a> (3)</li>
</ul>
</li>
<li>
<a data-toggle=collapse href=#archive-year-2014>2014</a> (12)
<ul id=archive-year-2014 class=collapse>
<li><a href=/archive.html#2014-11>November 2014</a> (2)</li>
<li><a href=/archive.html#2014-05>May 2014</a> (3)</li>
<li><a href=/archive.html#2014-03>March 2014</a> (1)</li>
<li><a href=/archive.html#2014-02>February 2014</a> (3)</li>
<li><a href=/archive.html#2014-01>January 2014</a> (3)</li>
</ul>
</li>
<li>
<a data-toggle=collapse href=#archive-year-2013>2013</a> (62)
<ul id=archive-year-2013 class=collapse>
<li><a href=/archive.html#2013-12>December 2013</a> (7)</li>
<li><a href=/archive.html#2013-11>November 2013</a> (7)</li>
<li><a href=/archive.html#2013-10>October 2013</a> (7)</li>
<li><a href=/archive.html#2013-09>September 2013</a> (13)</li>
<li><a href=/archive.html#2013-08>August 2013</a> (9)</li>
<li><a href=/archive.html#2013-07>July 2013</a> (10)</li>
<li><a href=/archive.html#2013-06>June 2013</a> (9)</li>
</ul>
</li>
<li>
<a data-toggle=collapse href=#archive-year-2012>2012</a> (29)
<ul id=archive-year-2012 class=collapse>
<li><a href=/archive.html#2012-10>October 2012</a> (1)</li>
<li><a href=/archive.html#2012-09>September 2012</a> (1)</li>
<li><a href=/archive.html#2012-08>August 2012</a> (3)</li>
<li><a href=/archive.html#2012-07>July 2012</a> (2)</li>
<li><a href=/archive.html#2012-06>June 2012</a> (2)</li>
<li><a href=/archive.html#2012-05>May 2012</a> (3)</li>
<li><a href=/archive.html#2012-04>April 2012</a> (1)</li>
<li><a href=/archive.html#2012-03>March 2012</a> (1)</li>
<li><a href=/archive.html#2012-02>February 2012</a> (10)</li>
<li><a href=/archive.html#2012-01>January 2012</a> (5)</li>
</ul>
</li>
<li>
<a data-toggle=collapse href=#archive-year-2011>2011</a> (60)
<ul id=archive-year-2011 class=collapse>
<li><a href=/archive.html#2011-12>December 2011</a> (4)</li>
<li><a href=/archive.html#2011-11>November 2011</a> (4)</li>
<li><a href=/archive.html#2011-10>October 2011</a> (5)</li>
<li><a href=/archive.html#2011-09>September 2011</a> (11)</li>
<li><a href=/archive.html#2011-08>August 2011</a> (6)</li>
<li><a href=/archive.html#2011-07>July 2011</a> (4)</li>
<li><a href=/archive.html#2011-06>June 2011</a> (6)</li>
<li><a href=/archive.html#2011-05>May 2011</a> (6)</li>
<li><a href=/archive.html#2011-04>April 2011</a> (5)</li>
<li><a href=/archive.html#2011-03>March 2011</a> (2)</li>
<li><a href=/archive.html#2011-01>January 2011</a> (7)</li>
</ul>
</li>
<li>
<a data-toggle=collapse href=#archive-year-2010>2010</a> (26)
<ul id=archive-year-2010 class=collapse>
<li><a href=/archive.html#2010-12>December 2010</a> (7)</li>
<li><a href=/archive.html#2010-09>September 2010</a> (1)</li>
<li><a href=/archive.html#2010-07>July 2010</a> (1)</li>
<li><a href=/archive.html#2010-06>June 2010</a> (2)</li>
<li><a href=/archive.html#2010-05>May 2010</a> (5)</li>
<li><a href=/archive.html#2010-04>April 2010</a> (5)</li>
<li><a href=/archive.html#2010-03>March 2010</a> (3)</li>
<li><a href=/archive.html#2010-01>January 2010</a> (2)</li>
</ul>
</li>
<li>
<a data-toggle=collapse href=#archive-year-2009>2009</a> (31)
<ul id=archive-year-2009 class=collapse>
<li><a href=/archive.html#2009-10>October 2009</a> (1)</li>
<li><a href=/archive.html#2009-09>September 2009</a> (1)</li>
<li><a href=/archive.html#2009-08>August 2009</a> (3)</li>
<li><a href=/archive.html#2009-07>July 2009</a> (2)</li>
<li><a href=/archive.html#2009-06>June 2009</a> (4)</li>
<li><a href=/archive.html#2009-05>May 2009</a> (6)</li>
<li><a href=/archive.html#2009-04>April 2009</a> (2)</li>
<li><a href=/archive.html#2009-03>March 2009</a> (4)</li>
<li><a href=/archive.html#2009-01>January 2009</a> (8)</li>
</ul>
</li>
<li>
<a data-toggle=collapse href=#archive-year-2008>2008</a> (61)
<ul id=archive-year-2008 class=collapse>
<li><a href=/archive.html#2008-12>December 2008</a> (1)</li>
<li><a href=/archive.html#2008-11>November 2008</a> (4)</li>
<li><a href=/archive.html#2008-10>October 2008</a> (6)</li>
<li><a href=/archive.html#2008-09>September 2008</a> (1)</li>
<li><a href=/archive.html#2008-08>August 2008</a> (6)</li>
<li><a href=/archive.html#2008-07>July 2008</a> (14)</li>
<li><a href=/archive.html#2008-06>June 2008</a> (3)</li>
<li><a href=/archive.html#2008-05>May 2008</a> (1)</li>
<li><a href=/archive.html#2008-04>April 2008</a> (3)</li>
<li><a href=/archive.html#2008-03>March 2008</a> (3)</li>
<li><a href=/archive.html#2008-02>February 2008</a> (9)</li>
<li><a href=/archive.html#2008-01>January 2008</a> (10)</li>
</ul>
</li>
<li>
<a data-toggle=collapse href=#archive-year-2007>2007</a> (86)
<ul id=archive-year-2007 class=collapse>
<li><a href=/archive.html#2007-12>December 2007</a> (4)</li>
<li><a href=/archive.html#2007-11>November 2007</a> (7)</li>
<li><a href=/archive.html#2007-10>October 2007</a> (2)</li>
<li><a href=/archive.html#2007-09>September 2007</a> (8)</li>
<li><a href=/archive.html#2007-08>August 2007</a> (6)</li>
<li><a href=/archive.html#2007-07>July 2007</a> (15)</li>
<li><a href=/archive.html#2007-06>June 2007</a> (15)</li>
<li><a href=/archive.html#2007-05>May 2007</a> (4)</li>
<li><a href=/archive.html#2007-04>April 2007</a> (10)</li>
<li><a href=/archive.html#2007-03>March 2007</a> (8)</li>
<li><a href=/archive.html#2007-02>February 2007</a> (1)</li>
<li><a href=/archive.html#2007-01>January 2007</a> (6)</li>
</ul>
</li>
<li>
<a data-toggle=collapse href=#archive-year-2006>2006</a> (103)
<ul id=archive-year-2006 class=collapse>
<li><a href=/archive.html#2006-12>December 2006</a> (4)</li>
<li><a href=/archive.html#2006-11>November 2006</a> (3)</li>
<li><a href=/archive.html#2006-10>October 2006</a> (7)</li>
<li><a href=/archive.html#2006-09>September 2006</a> (6)</li>
<li><a href=/archive.html#2006-08>August 2006</a> (13)</li>
<li><a href=/archive.html#2006-07>July 2006</a> (4)</li>
<li><a href=/archive.html#2006-06>June 2006</a> (13)</li>
<li><a href=/archive.html#2006-05>May 2006</a> (7)</li>
<li><a href=/archive.html#2006-04>April 2006</a> (9)</li>
<li><a href=/archive.html#2006-03>March 2006</a> (6)</li>
<li><a href=/archive.html#2006-02>February 2006</a> (13)</li>
<li><a href=/archive.html#2006-01>January 2006</a> (18)</li>
</ul>
</li>
<li>
<a data-toggle=collapse href=#archive-year-2005>2005</a> (129)
<ul id=archive-year-2005 class=collapse>
<li><a href=/archive.html#2005-12>December 2005</a> (9)</li>
<li><a href=/archive.html#2005-11>November 2005</a> (7)</li>
<li><a href=/archive.html#2005-10>October 2005</a> (23)</li>
<li><a href=/archive.html#2005-09>September 2005</a> (10)</li>
<li><a href=/archive.html#2005-08>August 2005</a> (14)</li>
<li><a href=/archive.html#2005-07>July 2005</a> (5)</li>
<li><a href=/archive.html#2005-06>June 2005</a> (12)</li>
<li><a href=/archive.html#2005-05>May 2005</a> (6)</li>
<li><a href=/archive.html#2005-04>April 2005</a> (6)</li>
<li><a href=/archive.html#2005-03>March 2005</a> (13)</li>
<li><a href=/archive.html#2005-02>February 2005</a> (11)</li>
<li><a href=/archive.html#2005-01>January 2005</a> (13)</li>
</ul>
</li>
<li>
<a data-toggle=collapse href=#archive-year-2004>2004</a> (84)
<ul id=archive-year-2004 class=collapse>
<li><a href=/archive.html#2004-12>December 2004</a> (9)</li>
<li><a href=/archive.html#2004-11>November 2004</a> (6)</li>
<li><a href=/archive.html#2004-10>October 2004</a> (11)</li>
<li><a href=/archive.html#2004-09>September 2004</a> (19)</li>
<li><a href=/archive.html#2004-07>July 2004</a> (29)</li>
<li><a href=/archive.html#2004-06>June 2004</a> (10)</li>
</ul>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<footer class=container>
<div class=row>
<div class="col order-2 texr-right">
<p class=float-right><a href=#>Back to top</a></p>
</div>
<div class="col order-1 mr-auto">
<p>Copyright 2004&ndash;2022 Julio Merino</p>
</div>
</div>
</footer>
<script type=module>
  import {
    addAnchorsToHeaders, addElementClasses, RequestsClient, VotingClient,
  } from "\/js\/main.aee647bfe5a34964b54a0af95b6ee9adcc386076450856981743dbba0fe1cf36.js";

  new RequestsClient(SITE_ID).saveRequest();

  var client = new VotingClient(SITE_ID);
  client.loadVotes();
  window.voteThumbsUp = function() { client.voteThumbsUp(); }
  window.voteThumbsDown = function() { client.voteThumbsDown(); }

  addAnchorsToHeaders();
  addElementClasses();
</script>
<noscript>
<img src="https://api.jmmv.dev/api/sites/e8da9f62-b7ac-4fe9-bf20-7c527199a376/pages/aHR0cHM6Ly9qbW12LmRldi8yMDIwLzA5L2JhemVsLXVpLWxvY2tpbmcuaHRtbA==/stamp.gif" style=display:none>
</noscript>
</body>
</html>