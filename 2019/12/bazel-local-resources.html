<!doctype html><html lang=en xmlns=http://www.w3.org/1999/xhtml xmlns:fb=http://ogp.me/ns/fb#><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta property="og:site_name" content="Julio Merino (jmmv.dev)"><meta property="twitter:site" content="@jmmv"><title>How does Bazel track local resource usage? - Julio Merino (jmmv.dev)</title><meta property="og:title" content="How does Bazel track local resource usage? - Julio Merino (jmmv.dev)"><meta property="twitter:title" content="How does Bazel track local resource usage? - Julio Merino (jmmv.dev)"><meta name=description content="How does Bazel avoid melting your workstation with concurrent subprocesses? Or&amp;hellip; tries to, because I know it still does that sometimes? There are two mechanisms as play: the jobs number and the local resources tracker. Let&amp;rsquo;s dive into them.
The jobs number, given by the --jobs flag, configures the number of concurrent Skyframe evaluators during the execution phase1. What a mouthful. What this essentially means is that jobs indicates the number of threads used to walk the graph looking for actions to execute&amp;mdash;and also executing them."><meta property="og:description" content="How does Bazel avoid melting your workstation with concurrent subprocesses? Or&amp;hellip; tries to, because I know it still does that sometimes? There are two mechanisms as play: the jobs number and the local resources tracker. Let&amp;rsquo;s dive into them.
The jobs number, given by the --jobs flag, configures the number of concurrent Skyframe evaluators during the execution phase1. What a mouthful. What this essentially means is that jobs indicates the number of threads used to walk the graph looking for actions to execute&amp;mdash;and also executing them."><meta property="twitter:description" content="How does Bazel avoid melting your workstation with concurrent subprocesses? Or&amp;hellip; tries to, because I know it still does that sometimes? There are two mechanisms as play: the jobs number and the ‚Ä¶"><meta name=author content="Julio Merino"><meta property="twitter:creator" content="@jmmv"><meta name=generator content="Hugo 0.111.3"><meta property="og:url" content="https://jmmv.dev/2019/12/bazel-local-resources.html"><meta property="og:type" content="blog"><meta property="twitter:card" content="summary"><link rel=canonical href=https://jmmv.dev/2019/12/bazel-local-resources.html><link rel=alternate type=application/rss+xml title="Julio Merino (jmmv.dev)" href=/feed.xml><link rel=stylesheet href=/sass/main.min.cb91349cd93211a37e7d5dc131c35a170fc795721c03373cd05571327eea206b.css><link rel=stylesheet href=/css/chroma.css><link rel=icon type=image/png href=/images/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/images/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicons/favicon-96x96.png sizes=96x96><meta property="og:image" content="/images/favicons/favicon-1200x1200.png"><meta property="twitter:image" content="https://jmmv.dev/images/favicons/favicon-1200x1200.png"><script>const SITE_ID="e8da9f62-b7ac-4fe9-bf20-7c527199a376",BASE_URL="https://jmmv.dev/"</script></head><body><header class=site-header><nav class="navbar navbar-expand-lg fixed-top navbar-dark bg-primary"><a class=navbar-brand href=/><img src=/images/favicons/favicon-30x30.png width=30 height=30 class="d-inline-block align-top" alt>
&nbsp;jmmv.dev</a>
<button class=navbar-toggler type=button data-toggle=collapse data-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarSupportedContent><ul class="navbar-nav mr-auto"><li class=nav-item><a class=nav-link href=/about.html>About</a></li><li class=nav-item><a class=nav-link href=/blog.html>Blog</a></li><li class=nav-item><a class=nav-link href=/resume.html>Resume</a></li><li class=nav-item><a class=nav-link href=/software.html>Software</a></li></ul><ul class="navbar-nav mr-4"><li class=nav-item><a class=nav-link href=/archive.html>Archive</a></li><li class=nav-item><a class=nav-link href=/series.html>Series</a></li><li class=nav-item><a class=nav-link href=/tags.html>Tags</a></li></ul><form class=form-inline method=get role=search action=https://www.google.com/search><div class=input-group><input type=search name=query class=form-control placeholder=Search aria-label=Search><div class=input-group-append><button type=submit value=Search class="btn btn-light">
<img src=/octicons/search.svg></button></div></div><input type=hidden name=sitesearch value=https://jmmv.dev/></form></div></nav></header><div class=page-header><div class=container><h1>How does Bazel track local resource usage?</h1><p>December 23, 2019 &#183;
About 5 minutes
&#183;
Tags:
<a href=/tags/bazel>bazel</a></p></div></div><div class="container post-body"><div class=row><div class=col-md-9><div class=row><div class=col><article><p>How does Bazel avoid melting your workstation with concurrent subprocesses? Or&mldr; tries to, because I know it still does that sometimes? There are two mechanisms as play: the jobs number and the local resources tracker. Let&rsquo;s dive into them.</p><p>The <strong>jobs number</strong>, given by the <code>--jobs</code> flag, configures the number of concurrent Skyframe evaluators during the execution phase<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>. What a mouthful. What this essentially means is that <code>jobs</code> indicates the number of threads used to walk the graph looking for actions to execute&mdash;and also executing them. So if we have <code>N</code> threads, each of which processes one node of the graph at a time, and we know that the most nodes trigger process executions, we have at most <code>N</code> concurrent spawns.</p><p>Which works well, but it&rsquo;s not sufficient. Not all actions are equally costly: some may require more than one CPU and this model doesn&rsquo;t account for RAM usage at all. Also, with remote execution, the number of jobs has to be increased to the hundreds to reap its benefits, so if you have set <code>--jobs=300</code> and configured all actions to run remotely except for a few mnemonics, the latter could still run en masse.</p><p>To control this, Bazel has another mechanism known as the <strong>local resources</strong> tracker. To summarize what this does, know that Bazel has its own idea of the resources available on the machine and each spawn has an associated cost. Whenever Bazel has to run a spawn, Bazel subtracts the spawn&rsquo;s cost from the tracker if resources are available or waits until they are, and then returns the resources once the spawn completes.</p><p>The key concepts and code references to navigate how this works are:</p><ul><li><p>The amount of resources, be them the total available resources of the machine or the cost attached to an action, are modeled by the <a href="https://source.bazel.build/bazel/+/master:src/main/java/com/google/devtools/build/lib/actions/ResourceSet.java;l=33;drc=dc71d401efe8c227dbb84e3101255086d70d5a92"><code>ResourceSet</code> class</a>, which essentially is a value class that specifies a CPU and RAM quantity.</p></li><li><p>The resource tracker is implemented by the <a href="https://source.bazel.build/bazel/+/master:src/main/java/com/google/devtools/build/lib/actions/ResourceManager.java;l=62;drc=dc71d401efe8c227dbb84e3101255086d70d5a92"><code>ResourceManager</code> class</a> class, which provides convenient methods like <code>acquireResources</code> to either deduct or wait for resources. The tracker is <a href="https://source.bazel.build/bazel/+/master:src/main/java/com/google/devtools/build/lib/buildtool/ExecutionTool.java;l=679;drc=dc71d401efe8c227dbb84e3101255086d70d5a92">initialized</a> at the beginning of the build with the values of <code>--local_cpu_resources</code> and <code>--local_ram_resources</code> if provided. The default value of these flags is <code>auto</code>, which means to use a quantity derived from the machine running Bazel as exposed via the <a href="https://source.bazel.build/bazel/+/master:src/main/java/com/google/devtools/build/lib/actions/LocalHostCapacity.java;l=25;drc=dc71d401efe8c227dbb84e3101255086d70d5a92"><code>LocalHostCapacity</code> class</a>.</p></li><li><p>Each action (or, really, each spawn) carries a resource cost with it, which is assigned at creation time by the rule creating the action. Such resources are available via the <a href="https://source.bazel.build/bazel/+/master:src/main/java/com/google/devtools/build/lib/actions/Spawn.java;l=107;drc=dc71d401efe8c227dbb84e3101255086d70d5a92"><code>getResources()</code> method</a>.</p></li><li><p>And finally, each spawn runner (see <a href=/2019/12/bazel-strategies.html>What are Bazel strategies?</a> for details) that executes things locally ends up requesting the necessary resources from the <code>ResourceManager</code> <a href="https://source.bazel.build/bazel/+/master:src/main/java/com/google/devtools/build/lib/exec/local/LocalSpawnRunner.java;l=168;drc=dc71d401efe8c227dbb84e3101255086d70d5a92">right at <code>exec()</code> time</a> to gate the execution of a spawn.</p></li></ul><p>That&rsquo;s it. Those are all the pieces you need to know to puzzle together how local resource tracking works.</p><p>So now let&rsquo;s analyze why this local resource tracking mechanism is&mldr; very rudimentary:</p><ul><li><p>First of all, Bazel is not the only process running in the machine&mdash;yet the <code>ResourceManager</code> assumes it has all machine resources available to itself by default. This works as long as you don&rsquo;t do anything else on the machine, like using <em>cough</em> Chrome <em>cough</em>, or if your build is primarily remote-only, but breaks badly on busy machines.</p></li><li><p>Resource modeling for actions is&mldr; inaccurate. Most actions have a requirement of a single CPU and an almost-arbitrary RAM reservation. Some others, like C++ linking, attempt to model RAM consumption <a href="https://source.bazel.build/bazel/+/master:src/main/java/com/google/devtools/build/lib/rules/cpp/CppLinkAction.java;l=138;drc=dc71d401efe8c227dbb84e3101255086d70d5a92">based on the number of inputs</a>&mldr; which I guess &ldquo;works&rdquo; but is so tied to the behavior of a specific linker that encoding this in the Java code is plain wrong.</p></li><li><p>And this is hard to reason about. Most people are used to the <code>--jobs=N</code> model as they have almost-certainly played with <code>make -jN</code> at some point, but understanding what&rsquo;s happening in Bazel is hard.</p></li></ul><p>That said, after a couple of refinements we made (like removing completely-broken I/O tracking and forcing all actions to request at <em>least</em> 1 CPU), this model works pretty well. In fact, because of the latter:</p><blockquote><p><strong><code>--local_cpu_resources</code> essentially acts as <code>--jobs</code> to control the number of concurrent local processes</strong>, with only a few exceptions.</p></blockquote><p>But of course there is room for improvement. Here are a couple of ideas that would make all of this better:</p><ul><li><p><a href=https://github.com/bazelbuild/bazel/issues/6477>bazelbuild/bazel #6477</a>: Allow rules defined in Starlark to specify action costs. At the moment this is only possible from rules defined in Java or via undocumented tags in some cases, yet this would be very useful for rule maintainers.</p></li><li><p><a href=https://github.com/bazelbuild/bazel/issues/10443>bazelbuild/bazel #10443</a>: Allow Bazel to dynamically determine the resources given to a spawn, not the other way around. Suppose you have a multithreaded compiler like <code>swiftc</code> or are wrapping another build system like <code>cargo</code>. At the moment, you are forced to configure these tools with a fixed number of threads, and this number should match the resource cost attached to the action. This is fine when your dependency graph is broad enough to fill all cores with work. But what happens if you reach a choke point in the dependency graph and all you can do is issue that one <code>swiftc</code> or <code>cargo</code> invocation before anything else can run? In this case, you&rsquo;d want Bazel to configure the invocation to use all available resources, and only Bazel knows what those are based on current machine usage and available Skyframe parallelism.</p></li></ul><p>Do these ideas sound interesting? I&rsquo;d really appreciate help in addressing these, so drop me a note!</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>If you are extra curious, <code>--loading_phase_threads</code> is essentially the same as <code>--jobs</code>. The small difference is that the former controls the number of Skyframe evaluators during the combined loading/analysis phase while the latter does that for the execution phase. If we can get to interleaving all phases one day, we could possibly remove the former.&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></article></div></div><div class="container post-links"><div class=row><div class="col mr-auto text-left"><span><a href=https://jmmv.dev/2019/12/bazel-dynamic-execution-introduction.html>&#171; Previous</a></span></div><div class="col text-center"><span><a href=/archive.html>All posts</a></span></div><div class="col ml-auto text-right"><span><a href=https://jmmv.dev/2019/12/bazel-dynamic-execution-strategy.html>Next &#187;</a></span></div></div></div><div class="container post-votes"><div class=row><div class="col-lg-4 my-2"><div class=row><div class=col><a onclick=voteThumbsUp() class="btn btn-block btn-outline-success" id=thumbs-up-btn>üëç
(<span id=thumbs-up-count>0</span>)</a></div><div class=col><a onclick=voteThumbsDown() class="btn btn-block btn-outline-danger" id=thumbs-down-btn>üëé
(<span id=thumbs-down-count>0</span>)</a></div></div></div><div class="col-lg-8 my-2 d-none d-sm-block"><div class=row><div class="col-md-4 text-center"><a href="https://www.reddit.com/submit?title=How+does+Bazel+track+local+resource+usage%3F&amp;url=https%3A%2F%2Fjmmv.dev%2F2019%2F12%2Fbazel-local-resources.html" class="btn btn-block btn-outline-primary">Share on
<img src=/images/badges/reddit.png alt=Reddit width=24 height=24></a></div><div class="col-md-4 text-center"><a href="https://news.ycombinator.com/submitlink?t=How+does+Bazel+track+local+resource+usage%3F&amp;u=https%3A%2F%2Fjmmv.dev%2F2019%2F12%2Fbazel-local-resources.html" class="btn btn-block btn-outline-primary">Share on
<img src=/images/badges/ycombinator.png alt="Hacker News" width=24 height=24></a></div><div class="col-md-4 text-center"><a href="https://twitter.com/intent/tweet?status=How+does+Bazel+track+local+resource+usage%3F+%E2%80%94+https%3A%2F%2Fjmmv.dev%2F2019%2F12%2Fbazel-local-resources.html+%E2%80%94+cc+%40jmmv" class="btn btn-block btn-outline-primary">Share on
<img src=/images/badges/Twitter_Social_Icon_Circle_Color.png alt=Twitter width=24 height=24></a></div></div></div></div><div class="row my-4" id=postCommentRow><div class=col><div class=media><img class=mr-3 src=/octicons/pencil.svg width=32px height=32px><div class="media-body container"><form method=post id=newPost><div class=row><div class="col my-1"><textarea class=form-control rows=1 id=postCommentContent onclick=showPostComment() placeholder="Leave a comment"></textarea></div></div><div class="row newPostControls" style=display:none><div class="col my-1 form-group"><label for=postCommentAuthor>Your name (optional):</label>
<input type=text class=form-control id=postCommentAuthor></div></div><div class="row newPostControls" style=display:none><div class="col my-1 form-group"><label for=postCommentEmail>Your email (optional):</label>
<input type=text class=form-control type=email id=postCommentEmail>
<small class="form-text text-muted">Invisible to all readers; if provided, you will receive notifications when replied to (not implemented yet)</small></div></div><div class=row id=postCommentError style=display:none><div class="col mt-1 alert-danger"><p></p></div></div><div class="row newPostControls" style=display:none><button class="col-md-3 my-1 btn btn-primary" type=submit id=submitCommentButton>Post</button>
<small class="col-md-9 my-1 text-muted">Comments are subject to moderation. This feature is experimental and is powered by <a href=/software/endtracker.html>EndTRACKER</a>. If you experience any issues, please <a href=/about.html#contact>contact me off-band</a>.</small></div></form></div></div></div></div><script>function hidePostComment(){var t,e=document.getElementById("postCommentContent");e.rows=1,e.value="",t=document.getElementsByClassName("newPostControls"),Array.prototype.forEach.call(t,function(e){e.style.display="none"})}function showPostComment(){var e,t=document.getElementById("postCommentContent");t.rows=5,e=document.getElementsByClassName("newPostControls"),Array.prototype.forEach.call(e,function(e){e.style.display=""})}const form=document.querySelector("#newPost");form.onsubmit=function(e){e.preventDefault();let t=document.getElementById("postCommentAuthor").value,n=document.getElementById("postCommentEmail").value,s=document.getElementById("postCommentContent").value;postComment(t,n,s,hidePostComment)}</script></div></div><div class="col-md-3 sidebar d-none d-md-block"><div class=row><div class="col text-center p-2"><p><a href=/about.html class=clear-link><img src=/images/avatars/20181124-snow.jpg class="rounded-circle shadow my-2" style=width:100px><br><b>Julio Merino</b><br>A blog on operating systems, programming languages, testing, build systems, my own software
projects and even personal productivity. Specifics include FreeBSD, Linux, Rust, Bazel and
EndBASIC.</a></p><div class=row><div class=col><div class=form-group><form action=https://endtracker.azurewebsites.net/api/sites/e8da9f62-b7ac-4fe9-bf20-7c527199a376/subscribers/add method=post><input type=text name=email placeholder="Enter your email" class="form-control input-sm text-center my-1">
<button type=submit class="btn btn-primary btn-block my-1">Subscribe</button></form></div></div></div><div class="row px-2"><div class="col-sm-5 text-left"><small><span class=subscriber-count>0</span> subscribers</small></div><div class="col-sm-7 text-right"><p><a rel=me href=https://mastodon.online/@jmmv><img src=/images/badges/mastodon-logo.svg width=32px height=32px alt="Follow @jmmv on Mastodon"></a>
<a href="https://twitter.com/intent/follow?original_referer=https%3A%2F%2Fjmmv.dev%2F&amp;screen_name=jmmv"><img src=/images/badges/Twitter_logo_blue.svg width=32px height=32px alt="Follow @jmmv on Twitter"></a>
<a href=/feed.xml><img src=/images/badges/feed-icon-28x28.png alt="RSS feed"></a></p></div></div></div></div><div class=row><div class=col><h2>Featured software</h2><ul><li class=overflow-ellipsis><a href=https://www.endbasic.dev/ target=_blank>EndBASIC: Online BASIC+DOS env</a></li><li class=overflow-ellipsis><a href=https://endtracker.azurewebsites.net/ target=_blank>EndTRACKER: Services for static sites</a></li></ul></div></div><div class=row><div class=col><h2>Featured posts</h2><ul><li class=overflow-ellipsis><a href=/2023/06/fast-machines-slow-machines.html>Fast machines, slow machines</a></li><li class=overflow-ellipsis><a href=/2022/12/endbasic-0.10.html>EndBASIC 0.10: Core language, evolved</a></li><li class=overflow-ellipsis><a href=/2022/10/bye-microsoft-hi-snowflake.html>Farewell, Microsoft; hello, Snowflake!</a></li><li class=overflow-ellipsis><a href=/2022/05/rust-is-hard-but-does-it-matter.html>Rust is hard, yes, but does it matter?</a></li><li class=overflow-ellipsis><a href=/2022/04/rust-traits-and-dependency-injection.html>Rust traits and dependency injection</a></li><li class=overflow-ellipsis><a href=/2022/03/a-year-on-windows-intro.html>A year on Windows: Introduction</a></li><li class=overflow-ellipsis><a href=/2021/04/always-be-quitting.html>Always be quitting</a></li><li class=overflow-ellipsis><a href=/2021/02/google-monorepos-and-caching.html>How does Google keep build times low?</a></li><li class=overflow-ellipsis><a href=/2020/12/google-no-clean-builds.html>How does Google avoid clean builds?</a></li><li class=overflow-ellipsis><a href=/2020/12/unit-testing-a-console-app.html>Unit-testing a console app (a text editor)</a></li><li class=overflow-ellipsis><a href=/essays.html#featured>More...</a></li></ul></div></div></div></div></div><footer class=container-fluid><div class=row><div class="col-4 order-2 text-right"><p class=float-right><a href=#>Back to top</a></p></div><div class="col-8 order-1 mr-auto"><p>Copyright 2004&ndash;2023 Julio Merino</p></div></div></footer><script type=module>
  import { addAnchorsToHeaders, addElementClasses, BatchClient } from "\/js\/main.d30f168b11d80082408f4a983af9a626c6e57d58f7846b2174bac40d43be33e3.js";

  var batchClient = new BatchClient(SITE_ID);
  batchClient.doAll({
    put_request: true, get_comments: true, get_subscriber_count: true, get_votes: true });

  window.voteThumbsUp = function() { batchClient.voteThumbsUp(); }
  window.voteThumbsDown = function() { batchClient.voteThumbsDown(); }

  window.postComment = function(...args) {
    batchClient.postComment(...args);
  };

  addAnchorsToHeaders();
  addElementClasses();
</script><noscript><img src=https://hugo-dynamic.jmmv.dev/api/sites/e8da9f62-b7ac-4fe9-bf20-7c527199a376/pages/aHR0cHM6Ly9qbW12LmRldi8yMDE5LzEyL2JhemVsLWxvY2FsLXJlc291cmNlcy5odG1s/stamp.gif style=display:none></noscript></body></html>