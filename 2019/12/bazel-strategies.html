<!doctype html><html lang=en xmlns=http://www.w3.org/1999/xhtml xmlns:fb=http://ogp.me/ns/fb#><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta property="og:site_name" content="Julio Merino (jmmv.dev)"><meta property="twitter:site" content="@jmmv"><title>What are Bazel's strategies? - Julio Merino (jmmv.dev)</title><meta property="og:title" content="What are Bazel's strategies? - Julio Merino (jmmv.dev)"><meta property="twitter:title" content="What are Bazel's strategies? - Julio Merino (jmmv.dev)"><meta name=description content="&amp;ldquo;Strategies? Will you talk about Bazel&amp;rsquo;s strategy for world domination üôÄ?&amp;rdquo; No&amp;hellip; not exactly that.
Dynamic execution has been quite a hot topic in my work over the last few months and I am getting ready to publish a series of posts on it soon. But before I do that, I need to first review Bazel&amp;rsquo;s execution strategies because they play a big role in understanding what dynamic execution is and how it&amp;rsquo;s implemented."><meta property="og:description" content="&amp;ldquo;Strategies? Will you talk about Bazel&amp;rsquo;s strategy for world domination üôÄ?&amp;rdquo; No&amp;hellip; not exactly that.
Dynamic execution has been quite a hot topic in my work over the last few months and I am getting ready to publish a series of posts on it soon. But before I do that, I need to first review Bazel&amp;rsquo;s execution strategies because they play a big role in understanding what dynamic execution is and how it&amp;rsquo;s implemented."><meta property="twitter:description" content="&amp;ldquo;Strategies? Will you talk about Bazel&amp;rsquo;s strategy for world domination üôÄ?&amp;rdquo; No&amp;hellip; not exactly that.
Dynamic execution has been quite a hot topic in my work over the last few ‚Ä¶"><meta name=author content="Julio Merino"><meta property="twitter:creator" content="@jmmv"><meta name=generator content="Hugo 0.111.3"><meta property="og:url" content="https://jmmv.dev/2019/12/bazel-strategies.html"><meta property="og:type" content="blog"><meta property="twitter:card" content="summary"><link rel=canonical href=https://jmmv.dev/2019/12/bazel-strategies.html><link rel=alternate type=application/rss+xml title="Julio Merino (jmmv.dev)" href=/feed.xml><link rel=stylesheet href=/sass/main.min.161663676cac4bf21abc8967ec3267c26026aa58e9f392c5f3427e0ef089fe6b.css><link rel=stylesheet href=/css/chroma.css><link rel=icon type=image/png href=/images/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/images/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicons/favicon-96x96.png sizes=96x96><meta property="og:image" content="/images/favicons/favicon-1200x1200.png"><meta property="twitter:image" content="https://jmmv.dev/images/favicons/favicon-1200x1200.png"><script>const SITE_ID="e8da9f62-b7ac-4fe9-bf20-7c527199a376",BASE_URL="https://jmmv.dev/"</script></head><body><header class=site-header><nav class="navbar navbar-expand-lg fixed-top navbar-dark bg-primary"><a class=navbar-brand href=/><img src=/images/favicons/favicon-30x30.png width=30 height=30 class="d-inline-block align-top" alt>
&nbsp;Julio Merino</a>
<button class=navbar-toggler type=button data-toggle=collapse data-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarSupportedContent><ul class="navbar-nav mr-auto"><li class=nav-item><a class=nav-link href=/about.html>About</a></li><li class=nav-item><a class=nav-link href=/essays.html>Essays</a></li><li class=nav-item><a class=nav-link href=/resume.html>Resume</a></li><li class=nav-item><a class=nav-link href=/software.html>Software</a></li></ul><ul class="navbar-nav mr-4"><li class=nav-item><a class=nav-link href=/archive.html>Archive</a></li><li class=nav-item><a class=nav-link href=/series.html>Series</a></li><li class=nav-item><a class=nav-link href=/tags.html>Tags</a></li></ul><form class=form-inline method=get role=search action=https://www.google.com/search><div class=input-group><input type=search name=query class=form-control placeholder=Search aria-label=Search><div class=input-group-append><button type=submit value=Search class="btn btn-light">
<img src=/octicons/search.svg></button></div></div><input type=hidden name=sitesearch value=https://jmmv.dev/></form></div></nav></header><div class=page-header><div class=container><h1>What are Bazel's strategies?</h1><p>December 14, 2019 &#183;
About 6 minutes
&#183;
Tags:
<a href=/tags/bazel>bazel</a>, <a href=/tags/sandboxfs>sandboxfs</a></p></div></div><div class="container post-body"><div class=row><div class=col-md-9><div class=row><div class=col><article><p>&ldquo;Strategies? Will you talk about Bazel&rsquo;s strategy for world domination üôÄ?&rdquo; No&mldr; not exactly that.</p><p>Dynamic execution has been quite a hot topic in my work over the last few months and I am getting ready to publish a series of posts on it soon. But before I do that, I need to first review Bazel&rsquo;s execution strategies because they play a big role in understanding what dynamic execution <em>is</em> and how it&rsquo;s <em>implemented</em>.</p><p>Simply put, <strong>strategies</strong> are Bazel&rsquo;s abstraction over the mechanism to run a subprocess as part of an action (think compiler invocation). In essence, they are a glorified <code>exec()</code> system call in Unix or <code>CreateProcess</code> in Windows and supercharge them to run subprocesses under <em>very</em> different environments.</p><p>The invariant, however, is that strategies do <em>not</em> affect the semantics of the execution: that is, running the same command line on strategy <code>A</code> and strategy <code>B</code> must yield the same output files. As a consequence, changing strategies does not invalidate the analysis graph.</p><p>Because of the previous invariant, we can mix and match strategies at run time without affecting the output behavior. This is exposed via the repeated <code>--strategy</code> flag, which takes arguments of the form <code>[mnemonic]=strategy</code>. With this flag, you can tell Bazel to run certain classes of actions under a specific strategy. For example, you might say <code>--strategy=remote --strategy=Javac=worker</code> to set the default strategy to <code>remote</code> and to override it with <code>worker</code> for Java compiles alone. There also is the <code>--strategy_regexp</code> flag to select strategies based on action messages, but I&rsquo;ll leave the &ldquo;magic&rdquo; of that aside. And there is also some fancy support for <a href=https://blog.bazel.build/2019/06/19/list-strategy.html>automatic strategy selection</a>.</p><p>Regarding implementation, all strategies are classes that implement the <a href="https://source.bazel.build/bazel/+/master:src/main/java/com/google/devtools/build/lib/actions/SpawnActionContext.java;l=22;drc=b202e1b026cea27d4939f1782c66f9e5f3b1cd06"><code>SpawnActionContext</code></a> interface. Overly simplifying, they must provide an <code>exec()</code> method that takes a <code>Spawn</code> (essentially a command line description) and returns a collection of <code>SpawnResult</code>s. Why a collection? Because a strategy may implement retries, and their failed results are exposed as part of the return value.</p><p>Looking further into their implementation, strategies wrap a <a href="https://source.bazel.build/bazel/+/master:src/main/java/com/google/devtools/build/lib/exec/SpawnRunner.java;l=92;drc=b202e1b026cea27d4939f1782c66f9e5f3b1cd06"><code>SpawnRunner</code></a>, which is the thing that actually knows how to run a spawn. You will notice that this interface&rsquo;s <code>exec()</code> returns a single <code>SpawnResult</code>, which helps understand how the strategy and its spawn runner relate: the strategy contains higher-level logic around the spawn runner and the spawn runner is in charge of the execution details.</p><p>With that, let&rsquo;s now review the primary strategies in Bazel.</p><h1 id=the-standalone-strategy>The <code>standalone</code> strategy</h1><p>The standalone (aka local) strategy is the simplest you can have, and is a good starting point to learn more about the internals of strategies and process execution in Bazel.</p><p>This strategy executes spawns directly <em>on</em> the output tree. That is: the commands are run with a current working directory that resides inside the output tree and all file references are within that directory. There are no restrictions on what the process can do, so the process can inadvertently have side-effects on unrelated files.</p><p>This strategy is at <a href="https://source.bazel.build/bazel/+/master:src/main/java/com/google/devtools/build/lib/standalone/StandaloneSpawnStrategy.java;l=25;drc=b202e1b026cea27d4939f1782c66f9e5f3b1cd06"><code>StandaloneSpawnStrategy</code></a> and uses the <a href="https://source.bazel.build/bazel/+/master:src/main/java/com/google/devtools/build/lib/exec/local/LocalSpawnRunner.java;l=71;drc=b202e1b026cea27d4939f1782c66f9e5f3b1cd06"><code>LocalSpawnRunner</code></a>.</p><h1 id=the-sandboxed-strategy>The <code>sandboxed</code> strategy</h1><p>The sandboxed strategy exists to support Bazel&rsquo;s promise of correct builds and is the default strategy for any local action (which means all actions unless you are doing any customization).</p><p>This strategy runs each spawn under a controlled environment that is isolated from the output tree and that is prevented from interacting with the system in certain ways (e.g. no networking access).</p><p>During an <code>exec()</code>, the sandbox strategy performs these steps:</p><ol><li>Create a directory outside of the output tree that exclusively contains the inputs required by the spawn as read-only files. This is currently done in the form of a symlink forest.</li><li>Execute the spawn under that separate directory, using system-specific technologies like namespaces on Linux and <a href=/2019/11/macos-sandbox-exec.html><code>sandbox-exec</code> on macOS</a> to constrain what the process can do.</li><li>Move the outputs out of the sandbox and into the output tree.</li><li>Delete the sandbox.</li></ol><p>This approach works&mldr; but can have a significant penalty on action execution performance. This has been a pet peeve of mine and I&rsquo;ve been trying to <a href=https://blog.bazel.build/2018/04/13/preliminary-sandboxfs-support.html>improve it for a long time with sandboxfs</a>, though I haven&rsquo;t gotten to major breakthroughs just yet.</p><p>This strategy is implemented as one class per supported operating system and all of them live under the <a href="https://source.bazel.build/bazel/+/master:src/main/java/com/google/devtools/build/lib/sandbox/;drc=b202e1b026cea27d4939f1782c66f9e5f3b1cd06"><code>sandbox</code></a> subdirectory.</p><h1 id=the-worker-strategy>The <code>worker</code> strategy</h1><p>The worker strategy exists to speed up the edit/build/test cycle of languages whose compiler is costly to start or whose compiler keeps state around to optimize incremental builds. The strategy communicates with a long-lived <a href=https://blog.bazel.build/2015/12/10/java-workers.html><em>persistent worker</em> process</a> and essentially sends the command lines to execute to that separate process.</p><p>For example: in the case of Java, the persistent worker avoids the penalty of JVM startup and JIT warmup times; and in the case of Dart, the persistent worker allows the compiler to keep file state in memory so that subsequent compilations are much faster.</p><p>The risk of allowing workers is that they can introduce correctness issues more easily than the typical startup/shutdown process: any bugs while processing an action, which may be harmless if the compiler is shut down immediately afterwards, can have cascading effects if the compiler is kept around for a long time and reused for other files. (Yes, we have hit these kind of issues in e.g. the Swift worker.)</p><p>Additionally, worker management in Bazel is currently very rudimentary so blindly enabling workers can make your machine melt due to memory pressure. We have plans to improve this significantly but haven&rsquo;t gotten to them just yet.</p><p>This strategy is at <a href="https://source.bazel.build/bazel/+/master:src/main/java/com/google/devtools/build/lib/worker/WorkerSpawnStrategy.java;l=29;drc=b202e1b026cea27d4939f1782c66f9e5f3b1cd06"><code>WorkerSpawnStrategy</code></a> and uses the <a href="https://source.bazel.build/bazel/+/master:src/main/java/com/google/devtools/build/lib/worker/WorkerSpawnRunner.java;l=65;drc=b202e1b026cea27d4939f1782c66f9e5f3b1cd06"><code>WorkerSpawnRunner</code></a>.</p><h1 id=the-remote-strategy>The <code>remote</code> strategy</h1><p>The remote strategy is the crown jewel of Bazel. This strategy is what allows Bazel to execute processes on remote machines thus letting your project break loose of the constraints of a single machine&rsquo;s build power.</p><p>This is the most complex strategy of all if only because of the need to coordinate with remote machines over gRPC, having to multiplex requests, and having to deal with networking hiccups. I will not dive into any of its details here.</p><p>This strategy is at <a href="https://source.bazel.build/bazel/+/master:src/main/java/com/google/devtools/build/lib/remote/RemoteSpawnStrategy.java;l=30;drc=b202e1b026cea27d4939f1782c66f9e5f3b1cd06"><code>RemoteSpawnStrategy</code></a> and uses the <a href="https://source.bazel.build/bazel/+/master:src/main/java/com/google/devtools/build/lib/remote/RemoteSpawnRunner.java;l=99;drc=b202e1b026cea27d4939f1782c66f9e5f3b1cd06"><code>RemoteSpawnRunner</code></a>.</p><hr><p>That&rsquo;s all for today. In the coming posts, I&rsquo;ll cover dynamic execution in detail and will likely refer to this post in multiple occasions.</p><p>Be aware, however, that a lot of the details on how strategies are defined and registered in Bazel are about to change as part of the ongoing <a href=https://groups.google.com/forum/#!topic/bazel-dev/SJyIAtJ6lIQ>Platforms & Toolchains work</a>. The specifics behind strategy implementation should not change, though.</p></article></div></div><div class="container post-links"><div class=row><div class="col mr-auto text-left"><span><a href=https://jmmv.dev/2019/11/macos-bash-baggage.html>&#171; Previous</a></span></div><div class="col text-center"><span><a href=/archive.html>All posts</a></span></div><div class="col ml-auto text-right"><span><a href=https://jmmv.dev/2019/12/bazel-dynamic-execution-introduction.html>Next &#187;</a></span></div></div></div><div class="container post-votes"><div class=row><div class="col-lg-4 my-2"><div class=row><div class=col><a onclick=voteThumbsUp() class="btn btn-block btn-outline-success" id=thumbs-up-btn>üëç
(<span id=thumbs-up-count>0</span>)</a></div><div class=col><a onclick=voteThumbsDown() class="btn btn-block btn-outline-danger" id=thumbs-down-btn>üëé
(<span id=thumbs-down-count>0</span>)</a></div></div></div><div class="col-lg-8 my-2 d-none d-sm-block"><div class=row><div class="col-md-4 text-center"><a href="https://www.reddit.com/submit?title=What+are+Bazel%27s+strategies%3F&amp;url=https%3A%2F%2Fjmmv.dev%2F2019%2F12%2Fbazel-strategies.html" class="btn btn-block btn-outline-primary">Share on
<img src=/images/badges/reddit.png alt=Reddit width=24 height=24></a></div><div class="col-md-4 text-center"><a href="https://news.ycombinator.com/submitlink?t=What+are+Bazel%27s+strategies%3F&amp;u=https%3A%2F%2Fjmmv.dev%2F2019%2F12%2Fbazel-strategies.html" class="btn btn-block btn-outline-primary">Share on
<img src=/images/badges/ycombinator.png alt="Hacker News" width=24 height=24></a></div><div class="col-md-4 text-center"><a href="https://twitter.com/intent/tweet?status=What+are+Bazel%27s+strategies%3F+%E2%80%94+https%3A%2F%2Fjmmv.dev%2F2019%2F12%2Fbazel-strategies.html+%E2%80%94+cc+%40jmmv" class="btn btn-block btn-outline-primary">Share on
<img src=/images/badges/Twitter_Social_Icon_Circle_Color.png alt=Twitter width=24 height=24></a></div></div></div></div><div class="row my-4" id=postCommentRow><div class=col><div class=media><img class=mr-3 src=/octicons/pencil.svg width=32px height=32px><div class="media-body container"><form method=post id=newPost><div class=row><div class="col my-1"><textarea class=form-control rows=1 id=postCommentContent onclick=showPostComment() placeholder="Leave a comment"></textarea></div></div><div class="row newPostControls" style=display:none><div class="col my-1 form-group"><label for=postCommentAuthor>Your name (optional):</label>
<input type=text class=form-control id=postCommentAuthor></div></div><div class="row newPostControls" style=display:none><div class="col my-1 form-group"><label for=postCommentEmail>Your email (optional):</label>
<input type=text class=form-control type=email id=postCommentEmail>
<small class="form-text text-muted">Invisible to all readers; if provided, you will receive notifications when replied to (not implemented yet)</small></div></div><div class=row id=postCommentError style=display:none><div class="col mt-1 alert-danger"><p></p></div></div><div class="row newPostControls" style=display:none><button class="col-md-3 my-1 btn btn-primary" type=submit id=submitCommentButton>Post</button>
<small class="col-md-9 my-1 text-muted">Comments are subject to moderation. This feature is experimental and is powered by <a href=/software/endtracker.html>EndTRACKER</a>. If you experience any issues, please <a href=/about.html#contact>contact me off-band</a>.</small></div></form></div></div></div></div><script>function hidePostComment(){var t,e=document.getElementById("postCommentContent");e.rows=1,e.value="",t=document.getElementsByClassName("newPostControls"),Array.prototype.forEach.call(t,function(e){e.style.display="none"})}function showPostComment(){var e,t=document.getElementById("postCommentContent");t.rows=5,e=document.getElementsByClassName("newPostControls"),Array.prototype.forEach.call(e,function(e){e.style.display=""})}const form=document.querySelector("#newPost");form.onsubmit=function(e){e.preventDefault();let t=document.getElementById("postCommentAuthor").value,n=document.getElementById("postCommentEmail").value,s=document.getElementById("postCommentContent").value;postComment(t,n,s,hidePostComment)}</script></div></div><div class="col-md-3 sidebar d-none d-md-block"><div class=row><div class="col text-center p-2"><p><a href=/about.html class=clear-link><img src=/images/avatars/20181124-snow.jpg class="rounded-circle shadow my-2" style=width:100px><br><b>Julio Merino</b><br>A blog on operating systems, programming languages, testing, build systems, my own software
projects and even personal productivity. Specifics include FreeBSD, Linux, Rust, Bazel and
EndBASIC.</a></p><div class=row><div class=col><div class=form-group><form action=https://endtracker.azurewebsites.net/api/sites/e8da9f62-b7ac-4fe9-bf20-7c527199a376/subscribers/add method=post><input type=text name=email placeholder="Enter your email" class="form-control input-sm text-center my-1">
<button type=submit class="btn btn-primary btn-block my-1">Subscribe</button></form></div></div></div><div class="row px-2"><div class="col-sm-5 text-left"><small><span class=subscriber-count>0</span> subscribers</small></div><div class="col-sm-7 text-right"><p><a rel=me href=https://mastodon.online/@jmmv><img src=/images/badges/mastodon-logo.svg width=32px height=32px alt="Follow @jmmv on Mastodon"></a>
<a href="https://twitter.com/intent/follow?original_referer=https%3A%2F%2Fjmmv.dev%2F&amp;screen_name=jmmv"><img src=/images/badges/Twitter_logo_blue.svg width=32px height=32px alt="Follow @jmmv on Twitter"></a>
<a href=/feed.xml><img src=/images/badges/feed-icon-28x28.png alt="RSS feed"></a></p></div></div></div></div><div class=row><div class=col><h2>Featured software</h2><ul><li class=overflow-ellipsis><a href=https://www.endbasic.dev/ target=_blank>EndBASIC: Online BASIC+DOS env</a></li><li class=overflow-ellipsis><a href=https://endtracker.azurewebsites.net/ target=_blank>EndTRACKER: Services for static sites</a></li></ul></div></div><div class=row><div class=col><h2>Featured posts</h2><ul><li class=overflow-ellipsis><a href=/2023/06/fast-machines-slow-machines.html>Fast machines, slow machines</a></li><li class=overflow-ellipsis><a href=/2022/12/endbasic-0.10.html>EndBASIC 0.10: Core language, evolved</a></li><li class=overflow-ellipsis><a href=/2022/10/bye-microsoft-hi-snowflake.html>Farewell, Microsoft; hello, Snowflake!</a></li><li class=overflow-ellipsis><a href=/2022/05/rust-is-hard-but-does-it-matter.html>Rust is hard, yes, but does it matter?</a></li><li class=overflow-ellipsis><a href=/2022/04/rust-traits-and-dependency-injection.html>Rust traits and dependency injection</a></li><li class=overflow-ellipsis><a href=/2022/03/a-year-on-windows-intro.html>A year on Windows: Introduction</a></li><li class=overflow-ellipsis><a href=/2021/04/always-be-quitting.html>Always be quitting</a></li><li class=overflow-ellipsis><a href=/2021/02/google-monorepos-and-caching.html>How does Google keep build times low?</a></li><li class=overflow-ellipsis><a href=/2020/12/google-no-clean-builds.html>How does Google avoid clean builds?</a></li><li class=overflow-ellipsis><a href=/2020/12/unit-testing-a-console-app.html>Unit-testing a console app (a text editor)</a></li><li class=overflow-ellipsis><a href=/essays.html#featured>More...</a></li></ul></div></div></div></div></div><footer class=container><div class=row><div class="col-4 order-2 texr-right"><p class=float-right><a href=#>Back to top</a></p></div><div class="col-8 order-1 mr-auto"><p>Copyright 2004&ndash;2023 Julio Merino</p></div></div></footer><script type=module>
  import { addAnchorsToHeaders, addElementClasses, BatchClient } from "\/js\/main.d30f168b11d80082408f4a983af9a626c6e57d58f7846b2174bac40d43be33e3.js";

  var batchClient = new BatchClient(SITE_ID);
  batchClient.doAll({
    put_request: true, get_comments: true, get_subscriber_count: true, get_votes: true });

  window.voteThumbsUp = function() { batchClient.voteThumbsUp(); }
  window.voteThumbsDown = function() { batchClient.voteThumbsDown(); }

  window.postComment = function(...args) {
    batchClient.postComment(...args);
  };

  addAnchorsToHeaders();
  addElementClasses();
</script><noscript><img src="https://hugo-dynamic.jmmv.dev/api/sites/e8da9f62-b7ac-4fe9-bf20-7c527199a376/pages/aHR0cHM6Ly9qbW12LmRldi8yMDE5LzEyL2JhemVsLXN0cmF0ZWdpZXMuaHRtbA==/stamp.gif" style=display:none></noscript></body></html>