<!doctype html><html lang=en xmlns=http://www.w3.org/1999/xhtml xmlns:fb=http://ogp.me/ns/fb#><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta property="og:site_name" content="Julio Merino (jmmv.dev)"><meta property="twitter:site" content="@jmmv"><title>Bazel's process-wrapper helper tool - Julio Merino (jmmv.dev)</title>
<meta property="og:title" content="Bazel's process-wrapper helper tool - Julio Merino (jmmv.dev)"><meta property="twitter:title" content="Bazel's process-wrapper helper tool - Julio Merino (jmmv.dev)"><meta name=description content="As strange as it may sound, a very important job of any build tool is to orchestrate the execution of lots of other programs&mdash;and Bazel is no exception.
Once Bazel has finished loading and analyzing the build graph, Bazel enters the execution phase. In this phase, the primary thing that Bazel does is walk the graph looking for actions to execute. Then, for each action, Bazel invokes its commands&mdash;things like compiler and linker invocations&mdash;as subprocesses. Under the default configuration1, all of these commands run on your machine.
"><meta property="og:description" content="As strange as it may sound, a very important job of any build tool is to orchestrate the execution of lots of other programs&mdash;and Bazel is no exception.
Once Bazel has finished loading and analyzing the build graph, Bazel enters the execution phase. In this phase, the primary thing that Bazel does is walk the graph looking for actions to execute. Then, for each action, Bazel invokes its commands&mdash;things like compiler and linker invocations&mdash;as subprocesses. Under the default configuration1, all of these commands run on your machine.
"><meta property="twitter:description" content="As strange as it may sound, a very important job of any build tool is to orchestrate the execution of lots of other programs&mdash;and Bazel is no exception.
Once Bazel has finished loading and …"><meta name=author content="Julio Merino"><meta property="twitter:creator" content="@jmmv"><meta name=generator content="Hugo 0.136.5"><meta property="og:url" content="https://jmmv.dev/2019/11/bazel-process-wrapper.html"><meta property="og:type" content="blog"><meta property="twitter:card" content="summary"><link rel=canonical href=https://jmmv.dev/2019/11/bazel-process-wrapper.html><link rel=alternate type=application/rss+xml title="Julio Merino (jmmv.dev)" href=/feed.xml><link rel=stylesheet href=/sass/main.min.cb91349cd93211a37e7d5dc131c35a170fc795721c03373cd05571327eea206b.css><link rel=stylesheet href=/css/chroma.css><link rel=icon type=image/png href=/images/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/images/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicons/favicon-96x96.png sizes=96x96><meta property="og:image" content="/images/favicons/favicon-1200x1200.png"><meta property="twitter:image" content="https://jmmv.dev/images/favicons/favicon-1200x1200.png"><script>const SITE_ID="e8da9f62-b7ac-4fe9-bf20-7c527199a376",BASE_URL="https://jmmv.dev/"</script></head><body><header class=site-header><nav class="navbar navbar-expand-md fixed-top navbar-dark bg-primary"><a class=navbar-brand href=/><img src=/images/favicons/favicon-30x30.png width=30 height=30 class="d-inline-block align-top" alt>
&nbsp;jmmv.dev
</a><button class=navbar-toggler type=button data-toggle=collapse data-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarSupportedContent><ul class="navbar-nav mr-auto"><li class=nav-item><a class=nav-link href=/about.html>About</a></li><li class=nav-item><a class=nav-link href=/blog.html>Blog</a></li><li class=nav-item><a class=nav-link href=/resume.html>Resume</a></li><li class=nav-item><a class=nav-link href=/software.html>Software</a></li></ul><ul class="navbar-nav mr-4"><li class=nav-item><a class=nav-link href=/archive.html>Archive</a></li><li class=nav-item><a class=nav-link href=/series.html>Series</a></li><li class=nav-item><a class=nav-link href=/tags.html>Tags</a></li></ul><form class=form-inline method=get role=search action=https://www.google.com/search><div class=input-group><input type=search name=query class=form-control placeholder=Search aria-label=Search><div class=input-group-append><button type=submit value=Search class="btn btn-light">
<img src=/octicons/search.svg></button></div></div><input type=hidden name=sitesearch value=https://jmmv.dev/></form></div></nav></header><div class=page-header><div class=container><h1>Bazel's process-wrapper helper tool</h1><p>November 8, 2019 &#183;
About 6 minutes
&#183;
Tags:
<a href=/tags/bazel>bazel</a>, <a href=/tags/internals>internals</a>, <a href=/tags/unix>unix</a></p></div></div><div class="container post-body"><div class=row><div class=col-md-9><div class=row><div class=col><article><p>As strange as it may sound, a very important job of any build tool is to orchestrate the execution of lots of other programs&mdash;and <a href=https://bazel.build/>Bazel</a> is no exception.</p><p>Once Bazel has finished <em>loading</em> and <em>analyzing</em> the build graph, Bazel enters the <em>execution phase</em>. In this phase, the primary thing that Bazel does is walk the graph looking for actions to execute. Then, for each action, Bazel invokes its commands&mdash;things like compiler and linker invocations&mdash;as subprocesses. Under the default configuration<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>, all of these commands run on your machine.</p><p>Running a subprocess is easy, but running thousands of them in an efficient and controlled manner is not. Yet every build tool has to do this. And every build tool has to come up with some form of process control to prevent processes from going rogue. In particular, Bazel ensures that its direct child processes do not leave other grandchild processes behind when terminated (especially on Ctrl+C<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>) and imposes a deadline for their execution.</p><p>On Unix systems, we have been made to believe that <code>fork</code> and <code>exec</code> are the pinnacle of simplicity and flexibility for a process-management API&mldr; and they might be so for trivial cases. But they definitely come with a lot of problems as explained in the criticized <a href=https://www.microsoft.com/en-us/research/uploads/prod/2019/04/fork-hotos19.pdf>A <code>fork()</code> in the road</a> paper. Unfortunately, some features are only available via this mechanism (not via the alternate <code>posix_spawn</code>), so we must use these two primitives.</p><p>But Bazel is written in Java, and the Java APIs for process management only support the basics to start and stop subprocesses. These APIs do not allow handling signals or dealing with process groups, both of which are crucial for the process control features required by Bazel.</p><p>You might say that JNI should be sufficient to fix this, but that&rsquo;s not the case. If we were to implement these features in JNI, we&rsquo;d need to have code that <code>fork</code>s subprocesses from JNI&mldr; and that&rsquo;d be very problematic. By the time Bazel starts the execution phase, the Bazel process is massively multi-threaded, and you should be aware that <a href=https://thorstenball.com/blog/2014/10/13/why-threads-cant-fork/><code>fork</code>ing a multi-threaded program is not safe</a>. We can trust that Java&rsquo;s own <a href=https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/lang/ProcessBuilder.html><code>ProcessBuilder</code></a> does the right thing, but we may not implement our own.</p><p>So how does Bazel solve this problem? By using separate helper binaries<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup> written in C++ (well, an ugly hybrid of C and C++). These helper binaries wrap the execution of the arbitrary commands that Bazel really wants to run and perform the necessary low-level process manipulation. Then, Bazel can use the simpler <code>ProcessBuilder</code> API to spawn these processes, trusting that the wrappers are well-behaved and don&rsquo;t require careful process control.</p><p>There are two of these binaries: the <strong>process wrapper</strong> and the <strong>Linux sandbox</strong>, but I&rsquo;m going to focus on the former for the rest of this post.</p><p>The <strong>process wrapper</strong>, located at <a href="https://source.bazel.build/bazel/+/master:src/main/tools/process-wrapper.cc;drc=9d9ac15b69530edd83c1b95f98a70efa8f98a27a"><code>src/main/tools/process-wrapper.cc</code></a>, is a very simple tool with the following functionality:</p><ol><li>Runs a subprocess with an optional timeout,</li><li>redirects stdout and stderr to optionally-provided files,</li><li>ensures the subprocess and all of its children are terminated on exit,</li><li>and optionally collects runtime metrics from the subprocess.</li></ol><p>Once built, the tool is bundled into the Bazel executable and is placed in the install base at startup time. You can invoke it by hand if you wish to inspect its features:</p><pre tabindex=0><code>.../some/workspace$ &#34;$(bazel info install_base)&#34;/_embedded_binaries/process-wrapper
No command specified.
Usage: /var/tmp/_bazel_jmmv/install/154077aea4bc476f9086f48e48456396/_embedded_binaries/process-wrapper -- command arg1 @args

Possible arguments:
  -t/--timeout &lt;timeout&gt;  timeout after which the child process will be terminated with SIGTERM
  -k/--kill_delay &lt;timeout&gt;  in case timeout occurs, how long to wait before killing the child with SIGKILL
  -o/--stdout &lt;file&gt;  redirect stdout to a file
  -e/--stderr &lt;file&gt;  redirect stderr to a file
  -s/--stats &lt;file&gt;  if set, write stats in protobuf format to a file
  -d/--debug  if set, debug info will be printed
  --  command to run inside sandbox, followed by arguments
</code></pre><p>Feel free to play around with the flags for a little bit.</p><p>Going back to the list of features, the most interesting one is terminating the subprocess and all of its (transitive) children. And this is, in my opinion, the most important feature. For example: if Bazel runs a test program and said test program decides to spawn a second program, Bazel must ensure that both of these terminate once the test completes (either successfully, due to a failure, or on an interrupt).</p><p>For example, if you run this command:</p><pre tabindex=0><code>.../some/workspace$ /bin/sh -c &#39;/bin/sh -c &#34;sleep 5; echo 2&#34; &amp; echo 1&#39;
1
.../some/workspace$ 2
</code></pre><p>you will see that the number <code>2</code> appears after a 5-second delay even if the shell already regained control. But if you run the exact same command via the process wrapper:</p><pre tabindex=0><code>.../some/workspace$ &#34;$(bazel info install_base)&#34;/_embedded_binaries/process-wrapper /bin/sh -c &#39;/bin/sh -c &#34;sleep 5; echo 2&#34; &amp; echo 1&#39;
1
.../some/workspace$
</code></pre><p>the number <code>2</code> won&rsquo;t appear because the process wrapper will have cleaned up the stray subprocess on exit.</p><p>The way this works is by placing the first subprocess under a new process group and then making the process wrapper terminate this whole group in unison. Yes, process groups are not infallible because a process can trivially escape them (e.g. by creating its own process group or by starting a new session). But the process wrapper does not intend to be bullet-proof in this regard: first, it&rsquo;s not a security mechanism; and, second, it just <em>can&rsquo;t</em> do so in a portable manner.</p><p>But we can do better if we are willing to introduce system-specific code. On Linux, we can handle this with <a href=http://man7.org/linux/man-pages/man7/pid_namespaces.7.html>PID namespaces</a>, which the aforementioned Linux sandbox wrapper does, and with the child subreaper feature. On macOS, we can do some tricks by walking the process table. And I hear the native process-management APIs on Windows are much better in this regard.</p><p>Stay tuned; more on these topics in upcoming posts!</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>Local-only builds are the default in Bazel&mdash;but not in Blaze, the Google-internal variant of Bazel. Blaze has relied on the Google-internal distributed build system for many years and, as a result, the local execution aspects of Bazel have been &ldquo;neglected&rdquo; for quite a while. But don&rsquo;t panic. Local actions are something that I&rsquo;m actively trying to improve because they are making a comeback due to <a href=https://blog.bazel.build/2019/02/01/dynamic-spawn-scheduler.html>dynamic scheduling</a>.&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p>You might have experienced cases where you Ctrl+C a <code>make</code> invocation and the build commands are left behind, which is definitely not what you want to happen. As far as I know, this is still a problem with <code>bmake</code> on macOS.&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p>Trust me, the helper binaries approach is infinitely easier to implement and reason about than trying to multiplex subprocess handling within a single process. I did the latter in Kyua and it was&mldr; complicated&mldr;&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></article></div></div><div class="container post-links"><div class=row><div class="col mr-auto text-left"><span><a href=https://jmmv.dev/2019/11/macos-sandbox-exec.html>&#171; Previous</a></span></div><div class="col text-center"><span><a href=/archive.html>All posts</a></span></div><div class="col ml-auto text-right"><span><a href=https://jmmv.dev/2019/11/wait-for-process-group.html>Next &#187;</a></span></div></div></div><div class="container post-votes"><div class=row><div class="col-lg-4 my-2"><div class=row><div class=col><a onclick=voteThumbsUp() class="btn btn-block btn-outline-success" id=thumbs-up-btn>👍
(<span id=thumbs-up-count>0</span>)</a></div><div class=col><a onclick=voteThumbsDown() class="btn btn-block btn-outline-danger" id=thumbs-down-btn>👎
(<span id=thumbs-down-count>0</span>)</a></div></div></div><div class="col-lg-8 my-2 d-none d-sm-block"><div class=row><div class="col-md-4 text-center"><a href="https://www.reddit.com/submit?title=Bazel%27s+process-wrapper+helper+tool&amp;url=https%3A%2F%2Fjmmv.dev%2F2019%2F11%2Fbazel-process-wrapper.html" class="btn btn-block btn-outline-primary">Share on
<img src=/images/badges/reddit.png alt=Reddit width=24 height=24></a></div><div class="col-md-4 text-center"><a href="https://news.ycombinator.com/submitlink?t=Bazel%27s+process-wrapper+helper+tool&amp;u=https%3A%2F%2Fjmmv.dev%2F2019%2F11%2Fbazel-process-wrapper.html" class="btn btn-block btn-outline-primary">Share on
<img src=/images/badges/ycombinator.png alt="Hacker News" width=24 height=24></a></div><div class="col-md-4 text-center"><a href="https://twitter.com/intent/tweet?status=Bazel%27s+process-wrapper+helper+tool+%E2%80%94+https%3A%2F%2Fjmmv.dev%2F2019%2F11%2Fbazel-process-wrapper.html+%E2%80%94+cc+%40jmmv" class="btn btn-block btn-outline-primary">Share on
<img src=/images/badges/Twitter_Social_Icon_Circle_Color.png alt=Twitter width=24 height=24></a></div></div></div></div><div class="row my-4" id=postCommentRow><div class=col><div class=media><img class=mr-3 src=/octicons/pencil.svg width=32px height=32px><div class="media-body container"><form method=post id=newPost><div class=row><div class="col my-1"><textarea class=form-control rows=1 id=postCommentContent onclick=showPostComment() placeholder="Leave a comment"></textarea></div></div><div class="row newPostControls" style=display:none><div class="col my-1 form-group"><label for=postCommentAuthor>Your name (optional):</label>
<input type=text class=form-control id=postCommentAuthor></div></div><div class="row newPostControls" style=display:none><div class="col my-1 form-group"><label for=postCommentEmail>Your email (optional):</label>
<input type=text class=form-control type=email id=postCommentEmail>
<small class="form-text text-muted">Invisible to all readers; if provided, you will receive notifications when replied to (not implemented yet)</small></div></div><div class=row id=postCommentError style=display:none><div class="col mt-1 alert-danger"><p></p></div></div><div class="row newPostControls" style=display:none><button class="col-md-3 my-1 btn btn-primary" type=submit id=submitCommentButton>Post</button>
<small class="col-md-9 my-1 text-muted">Comments are subject to moderation. This feature is experimental and is powered by <a href=/software/endtracker.html>EndTRACKER</a>. If you experience any issues, please <a href=/about.html#contact>contact me off-band</a>.</small></div></form></div></div></div></div><script>function hidePostComment(){var t,e=document.getElementById("postCommentContent");e.rows=1,e.value="",t=document.getElementsByClassName("newPostControls"),Array.prototype.forEach.call(t,function(e){e.style.display="none"})}function showPostComment(){var e,t=document.getElementById("postCommentContent");t.rows=5,e=document.getElementsByClassName("newPostControls"),Array.prototype.forEach.call(e,function(e){e.style.display=""})}const form=document.querySelector("#newPost");form.onsubmit=function(e){e.preventDefault();let t=document.getElementById("postCommentAuthor").value,n=document.getElementById("postCommentEmail").value,s=document.getElementById("postCommentContent").value;postComment(t,n,s,hidePostComment)}</script></div></div><div class="col-md-3 sidebar d-none d-md-block"><div class=row><div class="col text-center p-2"><p><a href=/about.html class=clear-link><img src=/images/avatars/20181124-snow.jpg class="rounded-circle shadow my-2" style=width:100px><br><b>Julio Merino</b><br>A blog on operating systems, programming languages, testing, build systems, my own software
projects and even personal productivity. Specifics include FreeBSD, Linux, Rust, Bazel and
EndBASIC.</a></p><div class=row><div class=col><div class=form-group><form action=https://endtracker.azurewebsites.net/api/sites/e8da9f62-b7ac-4fe9-bf20-7c527199a376/subscribers/add method=post><input type=text name=email placeholder="Enter your email" class="form-control input-sm text-center my-1">
<button type=submit class="btn btn-primary btn-block my-1">Subscribe</button></form></div></div></div><div class="row px-2"><div class="col-sm-5 text-left"><small><span class=subscriber-count>0</span> subscribers</small></div><div class="col-sm-7 text-right"><p><a rel=me href=https://mastodon.online/@jmmv><img src=/images/badges/mastodon-logo.svg width=32px height=32px alt="Follow @jmmv on Mastodon">
</a><a href="https://twitter.com/intent/follow?original_referer=https%3A%2F%2Fjmmv.dev%2F&amp;screen_name=jmmv"><img src=/images/badges/Twitter_logo_blue.svg width=32px height=32px alt="Follow @jmmv on Twitter">
</a><a href=/feed.xml><img src=/images/badges/feed-icon-28x28.png alt="RSS feed"></a></p></div></div></div></div><div class=row><div class=col><h2>Featured software</h2><ul><li class=overflow-ellipsis><a href=https://www.endbasic.dev/ target=_blank>EndBASIC: Online BASIC+DOS env</a></li><li class=overflow-ellipsis><a href=https://endtracker.azurewebsites.net/ target=_blank>EndTRACKER: Services for static sites</a></li></ul></div></div><div class=row><div class=col><h2>Featured posts</h2><ul><li class=overflow-ellipsis><a href=/2023/06/fast-machines-slow-machines.html>Fast machines, slow machines</a></li><li class=overflow-ellipsis><a href=/2022/12/endbasic-0.10.html>EndBASIC 0.10: Core language, evolved</a></li><li class=overflow-ellipsis><a href=/2022/10/bye-microsoft-hi-snowflake.html>Farewell, Microsoft; hello, Snowflake!</a></li><li class=overflow-ellipsis><a href=/2022/05/rust-is-hard-but-does-it-matter.html>Rust is hard, yes, but does it matter?</a></li><li class=overflow-ellipsis><a href=/2022/04/rust-traits-and-dependency-injection.html>Rust traits and dependency injection</a></li><li class=overflow-ellipsis><a href=/2022/03/a-year-on-windows-intro.html>A year on Windows: Introduction</a></li><li class=overflow-ellipsis><a href=/2021/04/always-be-quitting.html>Always be quitting</a></li><li class=overflow-ellipsis><a href=/2021/02/google-monorepos-and-caching.html>How does Google keep build times low?</a></li><li class=overflow-ellipsis><a href=/2020/12/google-no-clean-builds.html>How does Google avoid clean builds?</a></li><li class=overflow-ellipsis><a href=/2020/12/unit-testing-a-console-app.html>Unit-testing a console app (a text editor)</a></li><li class=overflow-ellipsis><a href=/essays.html#featured>More...</a></li></ul></div></div></div></div></div><footer class=container-fluid><div class=row><div class="col-4 order-2 text-right"><p class=float-right><a href=#>Back to top</a></p></div><div class="col-8 order-1 mr-auto"><p>Copyright 2004&ndash;2024
Julio Merino</p></div></div></footer><script type=module>
  import { addAnchorsToHeaders, addElementClasses, BatchClient } from "\/js\/main.0de73782e9e0fbcb4184fb5793949b3b0d0ada16455df89320415b4dcc052f88.js";

  var batchClient = new BatchClient(SITE_ID);
  batchClient.doAll({
    put_request: true, get_comments: true, get_subscriber_count: true, get_votes: true });

  window.voteThumbsUp = function() { batchClient.voteThumbsUp(); }
  window.voteThumbsDown = function() { batchClient.voteThumbsDown(); }

  window.postComment = function(...args) {
    batchClient.postComment(...args);
  };

  addAnchorsToHeaders();
  addElementClasses();
</script><noscript><img src=https://hugo-dynamic.jmmv.dev/api/sites/e8da9f62-b7ac-4fe9-bf20-7c527199a376/pages/aHR0cHM6Ly9qbW12LmRldi8yMDE5LzExL2JhemVsLXByb2Nlc3Mtd3JhcHBlci5odG1s/stamp.gif style=display:none></noscript></body></html>