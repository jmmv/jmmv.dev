<!doctype html><html lang=en xmlns=http://www.w3.org/1999/xhtml xmlns:fb=http://ogp.me/ns/fb#><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta property="og:site_name" content="Julio Merino (jmmv.dev)"><meta property="twitter:site" content="@jmmv"><title>Encode your assumptions - Julio Merino (jmmv.dev)</title>
<meta property="og:title" content="Encode your assumptions - Julio Merino (jmmv.dev)"><meta property="twitter:title" content="Encode your assumptions - Julio Merino (jmmv.dev)"><meta name=description content="The point of this post is simple and I&rsquo;ll spoil it from the get go: every time you make an assumption in a piece of code, make such assumption explicit in the form of an assertion or error check. If you cannot do that (are you sure?), then write a detailed comment.
In fact, I&rsquo;m exceedingly convinced that the amount of assertion-like checks in a piece of code is a good indicator of the programmer&rsquo;s expertise.
"><meta property="og:description" content="The point of this post is simple and I&rsquo;ll spoil it from the get go: every time you make an assumption in a piece of code, make such assumption explicit in the form of an assertion or error check. If you cannot do that (are you sure?), then write a detailed comment.
In fact, I&rsquo;m exceedingly convinced that the amount of assertion-like checks in a piece of code is a good indicator of the programmer&rsquo;s expertise.
"><meta property="twitter:description" content="The point of this post is simple and I&rsquo;ll spoil it from the get go: every time you make an assumption in a piece of code, make such assumption explicit in the form of an assertion or error …"><meta name=author content="Julio Merino"><meta property="twitter:creator" content="@jmmv"><meta name=generator content="Hugo 0.136.5"><meta property="og:url" content="https://jmmv.dev/2019/02/encode-your-assumptions.html"><meta property="og:type" content="blog"><meta property="twitter:card" content="summary"><link rel=canonical href=https://jmmv.dev/2019/02/encode-your-assumptions.html><link rel=alternate type=application/rss+xml title="Julio Merino (jmmv.dev)" href=/feed.xml><link rel=stylesheet href=/sass/main.min.cb91349cd93211a37e7d5dc131c35a170fc795721c03373cd05571327eea206b.css><link rel=stylesheet href=/css/chroma.css><link rel=icon type=image/png href=/images/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/images/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicons/favicon-96x96.png sizes=96x96><meta property="og:image" content="/images/favicons/favicon-1200x1200.png"><meta property="twitter:image" content="https://jmmv.dev/images/favicons/favicon-1200x1200.png"><script>const SITE_ID="e8da9f62-b7ac-4fe9-bf20-7c527199a376",BASE_URL="https://jmmv.dev/"</script></head><body><header class=site-header><nav class="navbar navbar-expand-md fixed-top navbar-dark bg-primary"><a class=navbar-brand href=/><img src=/images/favicons/favicon-30x30.png width=30 height=30 class="d-inline-block align-top" alt>
&nbsp;jmmv.dev
</a><button class=navbar-toggler type=button data-toggle=collapse data-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarSupportedContent><ul class="navbar-nav mr-auto"><li class=nav-item><a class=nav-link href=/about.html>About</a></li><li class=nav-item><a class=nav-link href=/blog.html>Blog</a></li><li class=nav-item><a class=nav-link href=/resume.html>Resume</a></li><li class=nav-item><a class=nav-link href=/software.html>Software</a></li></ul><ul class="navbar-nav mr-4"><li class=nav-item><a class=nav-link href=/archive.html>Archive</a></li><li class=nav-item><a class=nav-link href=/series.html>Series</a></li><li class=nav-item><a class=nav-link href=/tags.html>Tags</a></li></ul><form class=form-inline method=get role=search action=https://www.google.com/search><div class=input-group><input type=search name=query class=form-control placeholder=Search aria-label=Search><div class=input-group-append><button type=submit value=Search class="btn btn-light">
<img src=/octicons/search.svg></button></div></div><input type=hidden name=sitesearch value=https://jmmv.dev/></form></div></nav></header><div class=page-header><div class=container><h1>Encode your assumptions</h1><p>February 7, 2019 &#183;
About 4 minutes
&#183;
Tags:
<a href=/tags/bazel>bazel</a>, <a href=/tags/production-software>production-software</a>, <a href=/tags/readability>readability</a>, <a href=/tags/software>software</a></p></div></div><div class="container post-body"><div class=row><div class=col-md-9><div class=row><div class=col><article><p>The point of this post is simple and I&rsquo;ll spoil it from the get go: <strong>every time you make an assumption in a piece of code, make such assumption explicit in the form of an assertion or error check</strong>. If you cannot do that (are you sure?), then write a detailed comment.</p><p>In fact, I&rsquo;m exceedingly convinced that the amount of assertion-like checks in a piece of code is a good indicator of the programmer&rsquo;s expertise.</p><p>But&mldr; why? Story time!</p><h1 id=the-bug>The bug</h1><p>Bazel has a progress reporting message that says how many build actions are currently runnable and how many are actually running. For example, given a <code>--jobs=16</code> setting on a machine with 12 cores and assuming your build graph has sufficient parallelism, there can be 16 active actions but only 12 can run because that&rsquo;s what the machine&rsquo;s resources allow: the other 4 are waiting on those resources. Under these conditions, the progress reporting message would say: <code>16 actions, 12 running</code>.</p><p>Bazel also has a feature known as dynamic scheduling, which we <a href=https://blog.bazel.build/2019/02/01/dynamic-spawn-scheduler.html>recently announced</a>. With this feature, all actions allowed by the <code>--jobs</code> concurrency degree are sent to a remote execution service and a subset of those actions, as allowed by the machine&rsquo;s resources, are <em>also</em> executed on the local machine. In other words: a subset of actions run in two places <em>at the same time</em>.</p><p>One of our initial adopters for this dynamic scheduling feature reported that Bazel often said <code>100 actions, 24 running</code>, with varying counts of <code>24</code>. They were curious to know why this implied that 100 actions (as specified by our <code>--jobs=100</code> setting) were runnable but only ~24 were truly running. This made no sense because we have sufficient remote execution capacity to allow those 100 actions to run at the same time. Furthermore, the low running counts had no relation to the number of CPUs on their machine.</p><p>I wanted to track this down to understand what these numbers were really counting. To do this, I searched for the progress message with the regexp <code>actions,.*running</code>, which quickly yielded <a href="https://source.bazel.build/bazel/+/d1f28833a90a7b2f67a91d33bc375a68d9aae5db:src/main/java/com/google/devtools/build/lib/runtime/ExperimentalStateTracker.java;l=563?q=actions,.*running"><code>ExperimentalStateTracker.java:563</code></a>. From there, it didn&rsquo;t take long to understand what was going on.</p><h1 id=some-details-on-bazels-architecture>Some details on Bazel&rsquo;s architecture</h1><p>But before we continue, it is important to understand a couple of concepts of behind Bazel&rsquo;s design:</p><ol><li><p>Bazel is implemented as a loosely-coupled collection of modules, defined by the <a href=https://source.bazel.build/bazel/+/d1f28833a90a7b2f67a91d33bc375a68d9aae5db:src/main/java/com/google/devtools/build/lib/runtime/BlazeModule.java><code>BlazeModule</code></a> interface.</p></li><li><p>To keep the coupling low, Bazel uses <a href=https://github.com/google/guava/wiki/EventBusExplained>Guava&rsquo;s event bus</a> to post state change notifications across modules.</p></li></ol><p>This all sounds good on paper, but the problem is that the possible set of messages, the conditions in which they get sent, and their relative ordering is&mldr; under-specified (which is a mild way of saying &ldquo;not specified at all&rdquo;).</p><h1 id=understanding-the-bug>Understanding the bug</h1><p>Why is any of this related? Well, as it turns out, the progress reporting code in <a href=https://source.bazel.build/bazel/+/d1f28833a90a7b2f67a91d33bc375a68d9aae5db:src/main/java/com/google/devtools/build/lib/runtime/ExperimentalStateTracker.java><code>ExperimentalStateTracker</code></a> extensively relies on processing events to process what is going on in Bazel. In particular, this code receives <a href=https://source.bazel.build/bazel/+/d1f28833a90a7b2f67a91d33bc375a68d9aae5db:src/main/java/com/google/devtools/build/lib/actions/ActionStatusMessage.java><code>ActionStatusMessage</code></a> notifications, which indicate action status changes. These messages are &ldquo;keyed&rdquo; by the action identifier and are posted, for example, when an action becomes runnable or when an action is truly running.</p><p>You may start to see where the pieces fall together. As I said above, dynamic scheduling causes some actions to run twice concurrently&mldr; which means we end up with &ldquo;conflicting&rdquo; <a href=https://source.bazel.build/bazel/+/d1f28833a90a7b2f67a91d33bc375a68d9aae5db:src/main/java/com/google/devtools/build/lib/actions/ActionStatusMessage.java><code>ActionStatusMessage</code></a> events for the action. It is possible for an action to start running remotely, at which point it is counted by the tracker as runnable and running&mldr; but once we try to run the action locally and realize we don&rsquo;t have enough spare resources, its local counterpart blocks on the scheduling stage and is reported as runnable, not running. From the tracker&rsquo;s perspective, the action &ldquo;regressed&rdquo; and went from running to runnable, which is something that should never happen&mldr; and miscounts actions.</p><h1 id=conclusion>Conclusion</h1><p>Alright, so how does this relate, at all, to my initial claim? Well, the author of the status tracker mentioned that, yes, the tracker <em>assumes</em> that actions are unique. This is a perfectly reasonable thing to assume. But this assumption was&mldr; nowhere. Not in the code, not in comments. Which means that the bug in action counting manifested itself when the assumptions were violated and we only knew about it because of an avid user.</p><p>Now imagine: if the tracker had validated this assumption, say with an assertion, Bazel would have crashed the moment it detected this action miscounting. Given that this behavior is triggered by a new feature, the developer of the new feature would have immediately noticed the breakage in progress reporting: CI pre-submit tests would have failed and would not have let them check the code in. But instead, the bug persisted and it took some curiosity and digging after-the-fact to find out the issue. Which luckily gave me enough material for a post 😉</p><p>This bug is tracked at <a href=https://github.com/bazelbuild/bazel/issues/7345>https://github.com/bazelbuild/bazel/issues/7345</a>.</p><p>Fixing this bug seems like a nice starter project to get into the core of Bazel&rsquo;s architecture! Let me know if you are interested in helping.</p></article></div></div><div class="container post-links"><div class=row><div class="col mr-auto text-left"><span><a href=https://jmmv.dev/2019/02/sandboxfs-0-1-0.html>&#171; Previous</a></span></div><div class="col text-center"><span><a href=/archive.html>All posts</a></span></div><div class="col ml-auto text-right"><span><a href=https://jmmv.dev/2019/02/setenv-and-global-variables.html>Next &#187;</a></span></div></div></div><div class="container post-votes"><div class=row><div class="col-lg-4 my-2"><div class=row><div class=col><a onclick=voteThumbsUp() class="btn btn-block btn-outline-success" id=thumbs-up-btn>👍
(<span id=thumbs-up-count>0</span>)</a></div><div class=col><a onclick=voteThumbsDown() class="btn btn-block btn-outline-danger" id=thumbs-down-btn>👎
(<span id=thumbs-down-count>0</span>)</a></div></div></div><div class="col-lg-8 my-2 d-none d-sm-block"><div class=row><div class="col-md-4 text-center"><a href="https://www.reddit.com/submit?title=Encode+your+assumptions&amp;url=https%3A%2F%2Fjmmv.dev%2F2019%2F02%2Fencode-your-assumptions.html" class="btn btn-block btn-outline-primary">Share on
<img src=/images/badges/reddit.png alt=Reddit width=24 height=24></a></div><div class="col-md-4 text-center"><a href="https://news.ycombinator.com/submitlink?t=Encode+your+assumptions&amp;u=https%3A%2F%2Fjmmv.dev%2F2019%2F02%2Fencode-your-assumptions.html" class="btn btn-block btn-outline-primary">Share on
<img src=/images/badges/ycombinator.png alt="Hacker News" width=24 height=24></a></div><div class="col-md-4 text-center"><a href="https://twitter.com/intent/tweet?status=Encode+your+assumptions+%E2%80%94+https%3A%2F%2Fjmmv.dev%2F2019%2F02%2Fencode-your-assumptions.html+%E2%80%94+cc+%40jmmv" class="btn btn-block btn-outline-primary">Share on
<img src=/images/badges/Twitter_Social_Icon_Circle_Color.png alt=Twitter width=24 height=24></a></div></div></div></div><div class="row my-4" id=postCommentRow><div class=col><div class=media><img class=mr-3 src=/octicons/pencil.svg width=32px height=32px><div class="media-body container"><form method=post id=newPost><div class=row><div class="col my-1"><textarea class=form-control rows=1 id=postCommentContent onclick=showPostComment() placeholder="Leave a comment"></textarea></div></div><div class="row newPostControls" style=display:none><div class="col my-1 form-group"><label for=postCommentAuthor>Your name (optional):</label>
<input type=text class=form-control id=postCommentAuthor></div></div><div class="row newPostControls" style=display:none><div class="col my-1 form-group"><label for=postCommentEmail>Your email (optional):</label>
<input type=text class=form-control type=email id=postCommentEmail>
<small class="form-text text-muted">Invisible to all readers; if provided, you will receive notifications when replied to (not implemented yet)</small></div></div><div class=row id=postCommentError style=display:none><div class="col mt-1 alert-danger"><p></p></div></div><div class="row newPostControls" style=display:none><button class="col-md-3 my-1 btn btn-primary" type=submit id=submitCommentButton>Post</button>
<small class="col-md-9 my-1 text-muted">Comments are subject to moderation. This feature is experimental and is powered by <a href=/software/endtracker.html>EndTRACKER</a>. If you experience any issues, please <a href=/about.html#contact>contact me off-band</a>.</small></div></form></div></div></div></div><script>function hidePostComment(){var t,e=document.getElementById("postCommentContent");e.rows=1,e.value="",t=document.getElementsByClassName("newPostControls"),Array.prototype.forEach.call(t,function(e){e.style.display="none"})}function showPostComment(){var e,t=document.getElementById("postCommentContent");t.rows=5,e=document.getElementsByClassName("newPostControls"),Array.prototype.forEach.call(e,function(e){e.style.display=""})}const form=document.querySelector("#newPost");form.onsubmit=function(e){e.preventDefault();let t=document.getElementById("postCommentAuthor").value,n=document.getElementById("postCommentEmail").value,s=document.getElementById("postCommentContent").value;postComment(t,n,s,hidePostComment)}</script></div></div><div class="col-md-3 sidebar d-none d-md-block"><div class=row><div class="col text-center p-2"><p><a href=/about.html class=clear-link><img src=/images/avatars/20181124-snow.jpg class="rounded-circle shadow my-2" style=width:100px><br><b>Julio Merino</b><br>A blog on operating systems, programming languages, testing, build systems, my own software
projects and even personal productivity. Specifics include FreeBSD, Linux, Rust, Bazel and
EndBASIC.</a></p><div class=row><div class=col><div class=form-group><form action=https://endtracker.azurewebsites.net/api/sites/e8da9f62-b7ac-4fe9-bf20-7c527199a376/subscribers/add method=post><input type=text name=email placeholder="Enter your email" class="form-control input-sm text-center my-1">
<button type=submit class="btn btn-primary btn-block my-1">Subscribe</button></form></div></div></div><div class="row px-2"><div class="col-sm-5 text-left"><small><span class=subscriber-count>0</span> subscribers</small></div><div class="col-sm-7 text-right"><p><a rel=me href=https://mastodon.online/@jmmv><img src=/images/badges/mastodon-logo.svg width=32px height=32px alt="Follow @jmmv on Mastodon">
</a><a href="https://twitter.com/intent/follow?original_referer=https%3A%2F%2Fjmmv.dev%2F&amp;screen_name=jmmv"><img src=/images/badges/Twitter_logo_blue.svg width=32px height=32px alt="Follow @jmmv on Twitter">
</a><a href=/feed.xml><img src=/images/badges/feed-icon-28x28.png alt="RSS feed"></a></p></div></div></div></div><div class=row><div class=col><h2>Featured software</h2><ul><li class=overflow-ellipsis><a href=https://www.endbasic.dev/ target=_blank>EndBASIC: Online BASIC+DOS env</a></li><li class=overflow-ellipsis><a href=https://endtracker.azurewebsites.net/ target=_blank>EndTRACKER: Services for static sites</a></li></ul></div></div><div class=row><div class=col><h2>Featured posts</h2><ul><li class=overflow-ellipsis><a href=/2023/06/fast-machines-slow-machines.html>Fast machines, slow machines</a></li><li class=overflow-ellipsis><a href=/2022/12/endbasic-0.10.html>EndBASIC 0.10: Core language, evolved</a></li><li class=overflow-ellipsis><a href=/2022/10/bye-microsoft-hi-snowflake.html>Farewell, Microsoft; hello, Snowflake!</a></li><li class=overflow-ellipsis><a href=/2022/05/rust-is-hard-but-does-it-matter.html>Rust is hard, yes, but does it matter?</a></li><li class=overflow-ellipsis><a href=/2022/04/rust-traits-and-dependency-injection.html>Rust traits and dependency injection</a></li><li class=overflow-ellipsis><a href=/2022/03/a-year-on-windows-intro.html>A year on Windows: Introduction</a></li><li class=overflow-ellipsis><a href=/2021/04/always-be-quitting.html>Always be quitting</a></li><li class=overflow-ellipsis><a href=/2021/02/google-monorepos-and-caching.html>How does Google keep build times low?</a></li><li class=overflow-ellipsis><a href=/2020/12/google-no-clean-builds.html>How does Google avoid clean builds?</a></li><li class=overflow-ellipsis><a href=/2020/12/unit-testing-a-console-app.html>Unit-testing a console app (a text editor)</a></li><li class=overflow-ellipsis><a href=/essays.html#featured>More...</a></li></ul></div></div></div></div></div><footer class=container-fluid><div class=row><div class="col-4 order-2 text-right"><p class=float-right><a href=#>Back to top</a></p></div><div class="col-8 order-1 mr-auto"><p>Copyright 2004&ndash;2025
Julio Merino</p></div></div></footer><script type=module>
  import { addAnchorsToHeaders, addElementClasses, BatchClient } from "\/js\/main.0de73782e9e0fbcb4184fb5793949b3b0d0ada16455df89320415b4dcc052f88.js";

  var batchClient = new BatchClient(SITE_ID);
  batchClient.doAll({
    put_request: true, get_comments: true, get_subscriber_count: true, get_votes: true });

  window.voteThumbsUp = function() { batchClient.voteThumbsUp(); }
  window.voteThumbsDown = function() { batchClient.voteThumbsDown(); }

  window.postComment = function(...args) {
    batchClient.postComment(...args);
  };

  addAnchorsToHeaders();
  addElementClasses();
</script><noscript><img src="https://hugo-dynamic.jmmv.dev/api/sites/e8da9f62-b7ac-4fe9-bf20-7c527199a376/pages/aHR0cHM6Ly9qbW12LmRldi8yMDE5LzAyL2VuY29kZS15b3VyLWFzc3VtcHRpb25zLmh0bWw=/stamp.gif" style=display:none></noscript></body></html>