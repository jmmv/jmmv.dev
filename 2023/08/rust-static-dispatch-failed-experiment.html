<!doctype html><html lang=en xmlns=http://www.w3.org/1999/xhtml xmlns:fb=http://ogp.me/ns/fb#><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta property="og:site_name" content="Julio Merino (jmmv.dev)"><meta property="twitter:site" content="@jmmv"><title>A failed experiment with Rust static dispatch - Julio Merino (jmmv.dev)</title><meta property="og:title" content="A failed experiment with Rust static dispatch - Julio Merino (jmmv.dev)"><meta property="twitter:title" content="A failed experiment with Rust static dispatch - Julio Merino …"><meta name=description content="Initial versions of the EndBASIC Service, and therefore initial versions of EndTRACKER, used dynamic dispatch to support abstract definitions of system services such as the database they talk to and the clock they use. This looked like a bunch of Arc objects passed around and was done to support extremely fast unit testing.
When I generalized the core logic of these services into the III-IV framework, I decided to experiment with a switch to static dispatch. The rationale was that using static dispatch better aligns with the design of well-regarded crates in the Rust ecosystem, and also because I wanted to avoid unnecessary runtime costs in the foundational pieces of my web services.
Let me tell you that this decision was a huge mistake and that the experiment has utterly failed. Using static dispatch has been a constant source of frustration due to the difficulty in passing types around and reasoning about trait bounds. The situation had gotten so bad that I dreaded adding new functionality to my services whenever a change to a statically-typed struct was needed, because that meant adding yet another type parameter and plumbing it through tens of source files.
In lieu of the difficulties, which eventually turned into blockers to implementing new features, I made the choice of going back to dynamic dispatch. The goal was to gain ergonomics at the expense of a supposedly-negligible runtime cost. Let me tell you about the problems I faced, the refactoring journey, and some measurements I gathered after the rewrite.
"><meta property="og:description" content="Initial versions of the EndBASIC Service, and therefore initial versions of EndTRACKER, used dynamic dispatch to support abstract definitions of system services such as the database they talk to and the clock they use. This looked like a bunch of Arc objects passed around and was done to support extremely fast unit testing.
When I generalized the core logic of these services into the III-IV framework, I decided to experiment with a switch to static dispatch. The rationale was that using static dispatch better aligns with the design of well-regarded crates in the Rust ecosystem, and also because I wanted to avoid unnecessary runtime costs in the foundational pieces of my web services.
Let me tell you that this decision was a huge mistake and that the experiment has utterly failed. Using static dispatch has been a constant source of frustration due to the difficulty in passing types around and reasoning about trait bounds. The situation had gotten so bad that I dreaded adding new functionality to my services whenever a change to a statically-typed struct was needed, because that meant adding yet another type parameter and plumbing it through tens of source files.
In lieu of the difficulties, which eventually turned into blockers to implementing new features, I made the choice of going back to dynamic dispatch. The goal was to gain ergonomics at the expense of a supposedly-negligible runtime cost. Let me tell you about the problems I faced, the refactoring journey, and some measurements I gathered after the rewrite.
"><meta property="twitter:description" content="Initial versions of the EndBASIC Service, and therefore initial versions of EndTRACKER, used dynamic dispatch to support abstract definitions of system services such as the database they talk to and …"><meta name=author content="Julio Merino"><meta property="twitter:creator" content="@jmmv"><meta name=generator content="Hugo 0.111.3"><meta property="og:url" content="https://jmmv.dev/2023/08/rust-static-dispatch-failed-experiment.html"><meta property="og:type" content="blog"><meta property="twitter:card" content="summary"><link rel=canonical href=https://jmmv.dev/2023/08/rust-static-dispatch-failed-experiment.html><link rel=alternate type=application/rss+xml title="Julio Merino (jmmv.dev)" href=/feed.xml><link rel=stylesheet href=/sass/main.min.52b548e9c069c09e7522318b2cf209296e28a38aa2739ce528e6f9a488ce0797.css><link rel=stylesheet href=/css/chroma.css><link rel=icon type=image/png href=/images/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/images/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicons/favicon-96x96.png sizes=96x96><meta property="og:image" content="/images/favicons/favicon-1200x1200.png"><meta property="twitter:image" content="https://jmmv.dev/images/favicons/favicon-1200x1200.png"><script>const SITE_ID="e8da9f62-b7ac-4fe9-bf20-7c527199a376",BASE_URL="https://jmmv.dev/"</script></head><body><header class=site-header><nav class="navbar navbar-expand-lg fixed-top navbar-dark bg-primary"><a class=navbar-brand href=/><img src=/images/favicons/favicon-30x30.png width=30 height=30 class="d-inline-block align-top" alt>
&nbsp;Julio Merino</a>
<button class=navbar-toggler type=button data-toggle=collapse data-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarSupportedContent><ul class="navbar-nav mr-auto"><li class=nav-item><a class=nav-link href=/about.html>About</a></li><li class=nav-item><a class=nav-link href=/essays.html>Essays</a></li><li class=nav-item><a class=nav-link href=/resume.html>Resume</a></li><li class=nav-item><a class=nav-link href=/software.html>Software</a></li></ul><ul class="navbar-nav mr-4"><li class=nav-item><a class=nav-link href=/archive.html>Archive</a></li><li class=nav-item><a class=nav-link href=/series.html>Series</a></li><li class=nav-item><a class=nav-link href=/tags.html>Tags</a></li></ul><form class=form-inline method=get role=search action=https://www.google.com/search><div class=input-group><input type=search name=query class=form-control placeholder=Search aria-label=Search><div class=input-group-append><button type=submit value=Search class="btn btn-light">
<img src=/octicons/search.svg></button></div></div><input type=hidden name=sitesearch value=https://jmmv.dev/></form></div></nav></header><div class=page-header><div class=container><h1>A failed experiment with Rust static dispatch</h1><p>August 6, 2023 &#183;
About 13 minutes
&#183;
Tags:
<a href=/tags/endtracker>endtracker</a>, <a href=/tags/iii-iv>iii-iv</a>, <a href=/tags/programming>programming</a>, <a href=/tags/rust>rust</a></p></div></div><div class="container post-body"><div class=row><div class=col-md-9><div class=row><div class=col><article><p>Initial versions of the EndBASIC Service, and therefore initial versions of EndTRACKER, used dynamic dispatch to support abstract definitions of system services such as the database they talk to and the clock they use. This looked like a bunch of <code>Arc&lt;dyn Foo></code> objects passed around and was done to <a href=/2023/07/unit-testing-a-web-service.html>support extremely fast unit testing</a>.</p><p>When I generalized the core logic of these services into the <a href=/2023/03/introducing-iii-iv.html>III-IV framework</a>, I decided to experiment with a switch to static dispatch. The rationale was that using static dispatch better aligns with the design of well-regarded crates in the Rust ecosystem, and also because I wanted to avoid unnecessary runtime costs in the foundational pieces of my web services.</p><p>Let me tell you that this decision was a huge mistake and that the experiment has utterly failed. Using static dispatch has been a constant source of frustration due to the difficulty in passing types around and reasoning about trait bounds. The situation had gotten so bad that I dreaded adding new functionality to my services whenever a change to a statically-typed <code>struct</code> was needed, because that meant adding yet another type parameter and plumbing it through tens of source files.</p><p>In lieu of the difficulties, which eventually turned into blockers to implementing new features, I made the choice of going back to dynamic dispatch. The goal was to gain ergonomics at the expense of a supposedly-negligible runtime cost. Let me tell you about the problems I faced, the refactoring journey, and some measurements I gathered after the rewrite.</p><h1 id=initial-impressions>Initial impressions</h1><p>The adoption of static dispatch in III-IV started pretty simple and it did the job well. Even though it took me days of fighting with the Rust type system, I eventually got it to work. The production binary was statically bound to the PostgreSQL database backend and the unit tests were bound to SQLite, all while respecting the type safety offered by <code>sqlx</code> and without having virtual function calls anywhere.</p><p>Let&rsquo;s take a peek at what the <a href=https://github.com/jmmv/iii-iv/tree/cba6775e489d2e015a5919b086278ee486589ee5/example/src>sample key/value store</a> core pieces looked like by going through the architectural layers described in <a href=/2023/06/mvc-non-ui-apps.html>MVC but for non-UI apps</a>.</p><p>At the bottom layer, the database, there was a transaction trait to supply the operations required by the business logic layer:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=cp>#[async_trait]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>trait</span><span class=w> </span><span class=n>Tx</span>: <span class=nc>BareTx</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>get_keys</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>DbResult</span><span class=o>&lt;</span><span class=n>BTreeSet</span><span class=o>&lt;</span><span class=n>Key</span><span class=o>&gt;&gt;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ... more database operations ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>This trait was separately implemented for PostgreSQL and SQLite by providing separate <code>PostgresTx</code> and <code>SqliteTx</code> specific types, and both the specific transaction type and the database backing it were chosen at build time where the database connection was established.</p><p>Moving up to the business-logic layer, the <code>Driver</code> was parameterized on the domain-specific <code>Tx</code> so that it could have access to those operations (and only those):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=cp>#[derive(Clone)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>struct</span> <span class=nc>Driver</span><span class=o>&lt;</span><span class=n>D</span><span class=o>&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>where</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>D</span>: <span class=nc>Db</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Clone</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Send</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Sync</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>&#39;static</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>D</span>::<span class=n>Tx</span>: <span class=nc>Tx</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Send</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Sync</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>&#39;static</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>db</span>: <span class=nc>D</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>impl</span><span class=o>&lt;</span><span class=n>D</span><span class=o>&gt;</span><span class=w> </span><span class=n>Driver</span><span class=o>&lt;</span><span class=n>D</span><span class=o>&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>where</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>D</span>: <span class=nc>Db</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Clone</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Send</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Sync</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>&#39;static</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>D</span>::<span class=n>Tx</span>: <span class=nc>Tx</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Send</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Sync</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>&#39;static</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>get_keys</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>DriverResult</span><span class=o>&lt;</span><span class=n>BTreeSet</span><span class=o>&lt;</span><span class=n>Key</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>tx</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>db</span><span class=p>.</span><span class=n>begin</span><span class=p>().</span><span class=k>await</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>keys</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tx</span><span class=p>.</span><span class=n>get_keys</span><span class=p>().</span><span class=k>await</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>tx</span><span class=p>.</span><span class=n>commit</span><span class=p>().</span><span class=k>await</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nb>Ok</span><span class=p>(</span><span class=n>keys</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// ... more impl blocks for different driver operations ...
</span></span></span></code></pre></div><p>Note how, in the above, the <code>db.begin()</code> method call returns an instance of a <code>Tx</code> right away, ensuring that callers always issue database operations as part of a transaction. This had been a deliberate decision from the very beginning to prevent issuing standalone database calls that could compromise the correctness of the data, because there was no scenario in which a transaction was <em>not</em> necessary.</p><p>Finally, the upper REST layer took a <code>Driver</code> as the engine to run the API requests through and, as a consequence, the REST handlers all had to be parameterized like the underlying <code>Driver</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>handler</span><span class=o>&lt;</span><span class=n>D</span><span class=o>&gt;</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>State</span><span class=p>(</span><span class=n>driver</span><span class=p>)</span>: <span class=nc>State</span><span class=o>&lt;</span><span class=n>Driver</span><span class=o>&lt;</span><span class=n>D</span><span class=o>&gt;&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=k>impl</span><span class=w> </span><span class=n>IntoResponse</span><span class=p>,</span><span class=w> </span><span class=n>RestError</span><span class=o>&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>where</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>D</span>: <span class=nc>Db</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Clone</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Send</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Sync</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>&#39;static</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>D</span>::<span class=n>Tx</span>: <span class=nc>Tx</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Send</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Sync</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>&#39;static</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>keys</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>driver</span><span class=p>.</span><span class=n>get_keys</span><span class=p>().</span><span class=k>await</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nb>Ok</span><span class=p>(</span><span class=n>Json</span><span class=p>(</span><span class=n>keys</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>This is where things started to look finicky because the REST layer now had to spell out the internals of the <code>Driver</code>&mldr; but it didn&rsquo;t look so bad at the beginning. Combining this, the <a href=https://en.wikipedia.org/wiki/Sunk_cost>sunken cost fallacy</a>&mdash;it had taken me days to devise how to make the above work&mdash;and the idea of avoiding an unnecessary abstraction at runtime made me plough ahead with this implementation.</p><h1 id=the-problems>The problems</h1><p>It soon wasn&rsquo;t all roses. What you could see above was an extremely simplified view of how things ended looking like in a real service with more than just the database dependency. Without further ado, let me present to you the monstrosity that I ended up with in EndTRACKER. Here is the <code>Driver</code> definition for the data plane microservice:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=cp>#[derive(Derivative)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[derivative(Clone(bound = </span><span class=s>&#34;&#34;</span><span class=cp>))]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>struct</span> <span class=nc>Driver</span><span class=o>&lt;</span><span class=n>A</span><span class=p>,</span><span class=w> </span><span class=n>C</span><span class=p>,</span><span class=w> </span><span class=n>D</span><span class=p>,</span><span class=w> </span><span class=n>G</span><span class=p>,</span><span class=w> </span><span class=no>QD</span><span class=o>&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>where</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>A</span>: <span class=nc>AbusePolicy</span><span class=o>&lt;</span><span class=n>D</span>::<span class=n>Tx</span><span class=o>&gt;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Clone</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Send</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Sync</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>&#39;static</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>C</span>: <span class=nc>Clock</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Clone</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Send</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Sync</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>&#39;static</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>D</span>: <span class=nc>Db</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Clone</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Send</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Sync</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>&#39;static</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>D</span>::<span class=n>Tx</span>: <span class=nc>DataTx</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>From</span><span class=o>&lt;</span><span class=n>D</span>::<span class=n>SqlxTx</span><span class=o>&gt;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Send</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Sync</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>&#39;static</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>G</span>: <span class=nc>GeoLocator</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Clone</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Send</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Sync</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>&#39;static</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=no>QD</span>: <span class=nc>Db</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Clone</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Send</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Sync</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>&#39;static</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=no>QD</span>::<span class=n>Tx</span>: <span class=nc>ClientTx</span><span class=o>&lt;</span><span class=n>T</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>BatchTask</span><span class=o>&gt;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>From</span><span class=o>&lt;</span><span class=no>QD</span>::<span class=n>SqlxTx</span><span class=o>&gt;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Send</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Sync</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>&#39;static</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>db</span>: <span class=nc>D</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>clock</span>: <span class=nc>C</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ... more fields ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>But that&rsquo;s not all, oh no. This chunk also infected the REST layer, which in theory should not care about the specifics of the driver layer. Here, look at this <code>RestState</code> type, which is a wrapper over the data that the REST API handlers need to operate:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=cp>#[derive(Derivative)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[derivative(Clone(bound = </span><span class=s>&#34;&#34;</span><span class=cp>))]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>struct</span> <span class=nc>RestState</span><span class=o>&lt;</span><span class=n>A</span><span class=p>,</span><span class=w> </span><span class=n>C</span><span class=p>,</span><span class=w> </span><span class=n>D</span><span class=p>,</span><span class=w> </span><span class=n>G</span><span class=p>,</span><span class=w> </span><span class=no>QD</span><span class=o>&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>where</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>A</span>: <span class=nc>AbusePolicy</span><span class=o>&lt;</span><span class=n>D</span>::<span class=n>Tx</span><span class=o>&gt;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Clone</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Send</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Sync</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>&#39;static</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>C</span>: <span class=nc>Clock</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Clone</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Send</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Sync</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>&#39;static</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>D</span>: <span class=nc>Db</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Clone</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Send</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Sync</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>&#39;static</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>D</span>::<span class=n>Tx</span>: <span class=nc>DataTx</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>From</span><span class=o>&lt;</span><span class=n>D</span>::<span class=n>SqlxTx</span><span class=o>&gt;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Send</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Sync</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>&#39;static</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>G</span>: <span class=nc>GeoLocator</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Clone</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Send</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Sync</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>&#39;static</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=no>QD</span>: <span class=nc>Db</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Clone</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Send</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Sync</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>&#39;static</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=no>QD</span>::<span class=n>Tx</span>: <span class=nc>ClientTx</span><span class=o>&lt;</span><span class=n>T</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>BatchTask</span><span class=o>&gt;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>From</span><span class=o>&lt;</span><span class=no>QD</span>::<span class=n>SqlxTx</span><span class=o>&gt;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Send</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Sync</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>&#39;static</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>driver</span>: <span class=nc>Driver</span><span class=o>&lt;</span><span class=n>A</span><span class=p>,</span><span class=w> </span><span class=n>C</span><span class=p>,</span><span class=w> </span><span class=n>D</span><span class=p>,</span><span class=w> </span><span class=n>G</span><span class=p>,</span><span class=w> </span><span class=no>QD</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ... more fields ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>There are several problems with the above:</p><ol><li><p>It is Super Ugly (TM). There is no other way to put it. As much as I like Rust, things like this are painful and scary&mdash;but not as painful as deranged modern C++.</p></li><li><p>These <code>where</code> declarations where repeated 44 times in 37 different files (that is, almost <em>all</em> files). This polluted source files with details they don&rsquo;t care about. Any small change to the <code>Driver</code> required updating all these repeated chunks in sync. I&rsquo;m not even sure why Rust requires the duplication and why it&rsquo;s sometimes OK for the trait bounds to diverge among the various <code>impl</code> blocks, but the duplication is necessary.</p></li><li><p>It poisoned the REST layer. As mentioned above, the REST layer wants to pass around a <code>RestState</code> object that contains the <code>Driver</code> and other data fields that are only necessary at that level. Yet&mldr; to achieve this the <code>REST</code> layer had to replicate all of the internal details of the <code>Driver</code>.</p></li><li><p>I had to use <code>derivative</code> to remove unnecessary (?) clone trait bounds. The need to have a cloneable <code>Driver</code> and <code>RestState</code> comes from how the <code>axum</code> HTTP framework dispatches route execution, and figuring this out took quite a while. Furthermore&mldr; the way this &ldquo;works&rdquo; is still obscure to me.</p></li><li><p>It became impossible to compose transaction types. This is a problem with my design and not an inherent issue with static dispatch, but the use of static dispatch guided me towards this design. Note that, in the above, there are two database instances: <code>D</code> and <code>QD</code>, each with a different associated <code>Tx</code> type. While I wrote some contortions to support sharing the same underlying database connection between them, I never got to replicating those to also share an open transaction. The complexity was already at unmanageable levels to push this design any further. But I needed a solution to this problem.</p></li></ol><p>All in all, the use of static dispatch was slowing me down in building new features as these constructs made me dread modifying certain aspects of the code. And what&rsquo;s worse: certain initial design choices started showing up as true inefficiencies in production like the inability to issue standalone database calls outside of a transaction. The original goal of minimizing runtime costs was made significantly <em>worse</em>. Fixing these issues required a redesign so it was time for a change.</p><h1 id=switching-to-dynamic-dispatch>Switching to dynamic dispatch</h1><p>The goal with the redesign was to drop all static type parameters and replace them with <code>dyn</code> trait objects. In this way, the <code>Driver</code> would encapsulate these details in just one place and all other code would not have to care about the specific field definitions within this type.</p><p>It is easier said than done, but the results speak for themselves. Here is how the new <code>Driver</code> for the <a href=https://github.com/jmmv/iii-iv/tree/ba7aaf151fab3ff7aa1defde2454eab1550bda32/example/src>simplified key/value store</a> looks like:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=cp>#[derive(Clone)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>struct</span> <span class=nc>Driver</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>db</span>: <span class=nc>Arc</span><span class=o>&lt;</span><span class=k>dyn</span><span class=w> </span><span class=n>Db</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Send</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Sync</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>impl</span><span class=w> </span><span class=n>Driver</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>get_keys</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>DriverResult</span><span class=o>&lt;</span><span class=n>BTreeSet</span><span class=o>&lt;</span><span class=n>Key</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>tx</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>db</span><span class=p>.</span><span class=n>begin</span><span class=p>().</span><span class=k>await</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>keys</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>db</span>::<span class=n>get_keys</span><span class=p>(</span><span class=n>tx</span><span class=p>.</span><span class=n>ex</span><span class=p>()).</span><span class=k>await</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>tx</span><span class=p>.</span><span class=n>commit</span><span class=p>().</span><span class=k>await</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nb>Ok</span><span class=p>(</span><span class=n>keys</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>And, similarly, this is how one of the REST API handlers looks like:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>handler</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>State</span><span class=p>(</span><span class=n>driver</span><span class=p>)</span>: <span class=nc>State</span><span class=o>&lt;</span><span class=n>Driver</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=k>impl</span><span class=w> </span><span class=n>IntoResponse</span><span class=p>,</span><span class=w> </span><span class=n>RestError</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>keys</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>driver</span><span class=p>.</span><span class=n>get_keys</span><span class=p>().</span><span class=k>await</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nb>Ok</span><span class=p>(</span><span class=n>Json</span><span class=p>(</span><span class=n>keys</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>That&rsquo;s it. This is the way to declare the <code>Driver</code> over a generic database, the way to write a business-logic operation on top of this database, and the way to write a REST API handler that calls into this operation. The <code>Arc</code>s and the <code>Send + Sync</code> annotations are somewhat ugly but they are nowhere as ugly as the previous disaster. In this version, there is no noise.</p><p>What&rsquo;s more: as part of the redesign, I could throw away the &ldquo;everything behind a transaction&rdquo; idea and allow the caller to choose the best execution mode for its needs. Note the <code>tx.ex()</code> call above, which obtains an &ldquo;executor&rdquo; from the database and that can be used to talk to the database. This specific call obtains an executor from a transaction, but the same <code>db.ex()</code> method also exists to obtain a standalone executor. Describing how this works is out of the scope of this post though.</p><h1 id=show-me-the-metrics>Show me the metrics</h1><p>The pervasiveness of static dispatch in the Rust ecosystem helps leverage &ldquo;zero-cost abstractions&rdquo;, but it <em>does</em> come with a cost. Namely: programming time cost. It is great to have a choice, and it is great that many general-purpose Rust crates use static dispatch so that you don&rsquo;t have to pay unnecessary taxes&mldr; but it was not the right choice for me. I might have done things really wrong in my original design and these measurements may not be sustained for other projects, but let&rsquo;s look at some numbers anyway.</p><ul><li><p><strong>Code size.</strong> This is how the refactoring looks like according to a <code>git diff --stat</code>:</p><table><thead><tr><th>Project</th><th style=text-align:right>Files changed</th><th style=text-align:right>Lines added</th><th style=text-align:right>Lines deleted</th><th style=text-align:right>Diff</th></tr></thead><tbody><tr><td>iii-iv</td><td style=text-align:right>32</td><td style=text-align:right>1691</td><td style=text-align:right>2115</td><td style=text-align:right>-242 (-3%)</td></tr><tr><td>endtracker</td><td style=text-align:right>74</td><td style=text-align:right>3751</td><td style=text-align:right>4963</td><td style=text-align:right>-1212 (-11%)</td></tr></tbody></table><p>The changes to the III-IV framework are small because the use of static typing within the framework itself wasn&rsquo;t pervasive: after all, the framework was just exposing the building blocks and not using them on its own. But the 11% code reduction in EndTRACKER alone is <em>very</em> significant.</p></li><li><p><strong>Binary size.</strong> Looking at the sizes of the main EndTRACKER binary and the supporting unit testing binaries, both under the <code>release</code> and <code>debug</code> configurations, we observe:</p><table><thead><tr><th>Binary</th><th>Mode</th><th style=text-align:right>Before (MBs)</th><th style=text-align:right>After (MBs)</th><th style=text-align:right>Diff</th></tr></thead><tbody><tr><td><strong>main binary</strong></td><td>release</td><td style=text-align:right>23.30</td><td style=text-align:right>26.47</td><td style=text-align:right>+3.17</td></tr><tr><td>common tests</td><td>release</td><td style=text-align:right>16.75</td><td style=text-align:right>17.11</td><td style=text-align:right>+0.36</td></tr><tr><td>batch tests</td><td>release</td><td style=text-align:right>25.45</td><td style=text-align:right>24.96</td><td style=text-align:right>-0.49</td></tr><tr><td>control tests</td><td>release</td><td style=text-align:right>19.10</td><td style=text-align:right>18.77</td><td style=text-align:right>-0.33</td></tr><tr><td>data tests</td><td>release</td><td style=text-align:right>20.90</td><td style=text-align:right>20.89</td><td style=text-align:right>-0.01</td></tr><tr><td><strong>main binary</strong></td><td>debug</td><td style=text-align:right>261.14</td><td style=text-align:right>280.62</td><td style=text-align:right>+19.48</td></tr><tr><td>common tests</td><td>debug</td><td style=text-align:right>169.27</td><td style=text-align:right>171.62</td><td style=text-align:right>+2.35</td></tr><tr><td>batch tests</td><td>debug</td><td style=text-align:right>239.72</td><td style=text-align:right>238.07</td><td style=text-align:right>-1.65</td></tr><tr><td>control tests</td><td>debug</td><td style=text-align:right>192.06</td><td style=text-align:right>192.21</td><td style=text-align:right>+0.15</td></tr><tr><td>data tests</td><td>debug</td><td style=text-align:right>208.40</td><td style=text-align:right>207.93</td><td style=text-align:right>-0.47</td></tr></tbody></table><p>I was expecting a slight increase in binary size with the move to dynamic dispatch because the compiler and linker don&rsquo;t have as many opportunities for inlining and optimizing code. While the results seem to be all over the place, they seem to agree with my expectations: the binary sizes are larger when using dynamic dispatch. Some test binaries are smaller indeed, but this is most likely due to how the tests changed and not necessarily because of the switch from static to dynamic dispatch.</p></li><li><p><strong>Compilation time.</strong> I measured an incremental build after modifying a core type in the EndTRACKER codebase to change its internal layout, starting from a <code>cargo clean</code> slate and using the mold linker. With static dispatch, the incremental build times of the binary and tests were somewhere between 12 to 13 seconds, and with dynamic dispatch they dropped to just below 12 seconds. The difference is minimal, and the codebase isn&rsquo;t large enough to obtain a good signal out of this metric.</p><p>To be honest, I was hoping for a much larger improvement in incremental compilation times. My reasoning was that dealing with the type constraints that existed before must have been expensive, so removing them should reduce compiler execution times. My measurements did not prove this true, unfortunately. Or if they did, the improvements are negligible in this small codebase.</p></li><li><p><strong>Refactoring effort.</strong> I spent a couple of days figuring out what the best abstraction was and then I spent many hours during a recent long flight doing all of the mostly-mechanical changes to the EndTRACKER codebase. As usual, updating the tests was the most painful part of all&mdash;but also the one that gave me confidence to deploy a new build to production with ease.</p></li><li><p><strong>Runtime cost.</strong> This one&mldr; well, I haven&rsquo;t been able to measure it. None of my web services are CPU-bound so the cost of the virtual function dispatch is negligible.</p></li></ul><p>To summarize: not much seems to have changed with this rewrite. Binaries are slightly larger indeed, but not by a lot. However&mldr; the benefits in productivity are massive already.</p><h1 id=productivity-benefits>Productivity benefits</h1><p>One of the benefits of this rewrite is that I&rsquo;ve been able to finally resolve a long-standing deficiency in test coverage, which I briefly mentioned it in the conclusion of the <a href=/2023/07/unit-testing-a-web-service.html>Unit testing a web service</a> post. This deficiency was that the test suites for the driver and the REST layer ran against SQLite unconditionally and I did not have a way to run them against a real PostgreSQL instance. Well, I have an answer now. All it took after the switch to dynamic dispatch was to introduce a helper function like this one:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>connect_to_test_db</span><span class=p>()</span><span class=w> </span>-&gt; <span class=nc>Arc</span><span class=o>&lt;</span><span class=k>dyn</span><span class=w> </span><span class=n>Db</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Send</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Sync</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>db</span>: <span class=nc>Arc</span><span class=o>&lt;</span><span class=k>dyn</span><span class=w> </span><span class=n>Db</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Send</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Sync</span><span class=o>&gt;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>get_optional_var</span>::<span class=o>&lt;</span><span class=nb>String</span><span class=o>&gt;</span><span class=p>(</span><span class=s>&#34;TEST&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;DB&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>expect</span><span class=p>(</span><span class=s>&#34;TEST_DB must be a string&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>match</span><span class=w> </span><span class=n>name</span><span class=p>.</span><span class=n>as_deref</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nb>Some</span><span class=p>(</span><span class=s>&#34;postgres&#34;</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=n>Arc</span>::<span class=n>from</span><span class=p>(</span><span class=n>postgres</span>::<span class=n>testutils</span>::<span class=n>setup</span><span class=p>().</span><span class=k>await</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nb>Some</span><span class=p>(</span><span class=s>&#34;sqlite&#34;</span><span class=p>)</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=nb>None</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=n>Arc</span>::<span class=n>from</span><span class=p>(</span><span class=n>sqlite</span>::<span class=n>testutils</span>::<span class=n>setup</span><span class=p>().</span><span class=k>await</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nb>Some</span><span class=p>(</span><span class=n>name</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=fm>panic!</span><span class=p>(</span><span class=s>&#34;Invalid TEST_DB </span><span class=si>{}</span><span class=s>&#34;</span><span class=p>,</span><span class=w> </span><span class=n>name</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>super</span>::<span class=n>init_schema</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=n>db</span><span class=p>.</span><span class=n>ex</span><span class=p>()).</span><span class=k>await</span><span class=p>.</span><span class=n>unwrap</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>db</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>&mldr; use it to connect to the database in all tests, and configure a GitHub Actions job with <code>TEST_DB=postgres</code> to run the test suites against the production database.</p><p>Another benefit is that I have finally unstuck something I&rsquo;ve been working on-and-off for months and that I had been procrastinating on due to its difficulty. That is: I&rsquo;ve been trying to generalize the account creation and session management pieces of the EndBASIC Service into III-IV so that I can reuse those in EndTRACKER. This was made <em>really</em> difficult due to static dispatch, but now it&rsquo;s a piece of cake. Which means I should be able to add user accounts in EndTRACKER really soon now and maybe finally open it up to the public.</p><p>All in all, I&rsquo;m satisfied with the change. The code is much simpler now and I do not foresee the small costs at runtime nor in binary size to be problematic <em>at all</em> for my specific use cases.</p></article></div></div><div class="container post-links"><div class=row><div class="col mr-auto text-left"><span><a href=https://jmmv.dev/2023/07/unit-testing-a-web-service.html>&#171; Previous</a></span></div><div class="col text-center"><span><a href=/archive.html>All posts</a></span></div><div class="col ml-auto text-right"><span><a href=https://jmmv.dev/2023/08/rpi3-rfkill-root-causing.html>Next &#187;</a></span></div></div></div><div class="container post-votes"><div class=row><div class="col-lg-4 my-2"><div class=row><div class=col><a onclick=voteThumbsUp() class="btn btn-block btn-outline-success" id=thumbs-up-btn>👍
(<span id=thumbs-up-count>0</span>)</a></div><div class=col><a onclick=voteThumbsDown() class="btn btn-block btn-outline-danger" id=thumbs-down-btn>👎
(<span id=thumbs-down-count>0</span>)</a></div></div></div><div class="col-lg-8 my-2 d-none d-sm-block"><div class=row><div class="col-md-4 text-center"><a href="https://www.reddit.com/submit?title=A+failed+experiment+with+Rust+static+dispatch&amp;url=https%3A%2F%2Fjmmv.dev%2F2023%2F08%2Frust-static-dispatch-failed-experiment.html" class="btn btn-block btn-outline-primary">Share on
<img src=/images/badges/reddit.png alt=Reddit width=24 height=24></a></div><div class="col-md-4 text-center"><a href="https://news.ycombinator.com/submitlink?t=A+failed+experiment+with+Rust+static+dispatch&amp;u=https%3A%2F%2Fjmmv.dev%2F2023%2F08%2Frust-static-dispatch-failed-experiment.html" class="btn btn-block btn-outline-primary">Share on
<img src=/images/badges/ycombinator.png alt="Hacker News" width=24 height=24></a></div><div class="col-md-4 text-center"><a href="https://twitter.com/intent/tweet?status=A+failed+experiment+with+Rust+static+dispatch+%E2%80%94+https%3A%2F%2Fjmmv.dev%2F2023%2F08%2Frust-static-dispatch-failed-experiment.html+%E2%80%94+cc+%40jmmv" class="btn btn-block btn-outline-primary">Share on
<img src=/images/badges/Twitter_Social_Icon_Circle_Color.png alt=Twitter width=24 height=24></a></div></div></div></div><div class="row my-4" id=postCommentRow><div class=col><div class=media><img class=mr-3 src=/octicons/pencil.svg width=32px height=32px><div class="media-body container"><form method=post id=newPost><div class=row><div class="col my-1"><textarea class=form-control rows=1 id=postCommentContent onclick=showPostComment() placeholder="Leave a comment"></textarea></div></div><div class="row newPostControls" style=display:none><div class="col my-1 form-group"><label for=postCommentAuthor>Your name (optional):</label>
<input type=text class=form-control id=postCommentAuthor></div></div><div class="row newPostControls" style=display:none><div class="col my-1 form-group"><label for=postCommentEmail>Your email (optional):</label>
<input type=text class=form-control type=email id=postCommentEmail>
<small class="form-text text-muted">Invisible to all readers; if provided, you will receive notifications when replied to (not implemented yet)</small></div></div><div class=row id=postCommentError style=display:none><div class="col mt-1 alert-danger"><p></p></div></div><div class="row newPostControls" style=display:none><button class="col-md-3 my-1 btn btn-primary" type=submit id=submitCommentButton>Post</button>
<small class="col-md-9 my-1 text-muted">Comments are subject to moderation. This feature is experimental and is powered by <a href=/software/endtracker.html>EndTRACKER</a>. If you experience any issues, please <a href=/about.html#contact>contact me off-band</a>.</small></div></form></div></div></div></div><script>function hidePostComment(){var t,e=document.getElementById("postCommentContent");e.rows=1,e.value="",t=document.getElementsByClassName("newPostControls"),Array.prototype.forEach.call(t,function(e){e.style.display="none"})}function showPostComment(){var e,t=document.getElementById("postCommentContent");t.rows=5,e=document.getElementsByClassName("newPostControls"),Array.prototype.forEach.call(e,function(e){e.style.display=""})}const form=document.querySelector("#newPost");form.onsubmit=function(e){e.preventDefault();let t=document.getElementById("postCommentAuthor").value,n=document.getElementById("postCommentEmail").value,s=document.getElementById("postCommentContent").value;postComment(t,n,s,hidePostComment)}</script></div><div class="container post-subscribe d-block d-md-none"><div class="row text-center"><p>A blog on operating systems, programming languages, testing, build systems, my own software
projects and even personal productivity. Specifics include FreeBSD, Linux, Rust, Bazel and
EndBASIC.</p></div><div class=row><div class="col-sm-3 py-2"><div class=row><div class="col px-2 text-center"><a rel=me href=https://mastodon.online/@jmmv><img src=/images/badges/mastodon-logo.svg width=32px height=32px alt="Follow @jmmv on Mastodon"></a></div><div class="col px-2 text-center"><a href="https://twitter.com/intent/follow?original_referer=https%3A%2F%2Fjmmv.dev%2F&amp;screen_name=jmmv"><img src=/images/badges/Twitter_logo_blue.svg width=32px height=32px alt="Follow @jmmv on Twitter"></a></div><div class="col px-2 text-center"><a href=/feed.xml><img src=/images/badges/feed-icon-28x28.png alt="RSS feed"></a></div></div></div><div class="col-sm-9 py-2 text-center"><form action=https://endtracker.azurewebsites.net/api/sites/e8da9f62-b7ac-4fe9-bf20-7c527199a376/subscribers/add method=post><div class=form-group><div class=row><input type=text name=email placeholder="Enter your email" class="form-control input-sm col-8 text-center">
<button type=submit class="btn btn-primary col-4">Subscribe</button></div></div><small><span class=subscriber-count>0</span> subscribers</small></form></div></div></div></div><div class="col-md-3 sidebar d-none d-md-block"><div class=row><div class="col text-center p-2"><p><a href=/about.html class=clear-link><img src=/images/avatars/20181124-snow.jpg class="rounded-circle shadow my-2" style=width:100px><br><b>Julio Merino</b><br>A blog on operating systems, programming languages, testing, build systems, my own software
projects and even personal productivity. Specifics include FreeBSD, Linux, Rust, Bazel and
EndBASIC.</a></p><div class=row><div class="col-sm-4 text-center"><p><a rel=me href=https://mastodon.online/@jmmv><img src=/images/badges/mastodon-logo.svg width=32px height=32px alt="Follow @jmmv on Mastodon"></a></p></div><div class="col-sm-4 text-center"><p><a href="https://twitter.com/intent/follow?original_referer=https%3A%2F%2Fjmmv.dev%2F&amp;screen_name=jmmv"><img src=/images/badges/Twitter_logo_blue.svg width=32px height=32px alt="Follow @jmmv on Twitter"></a></p></div><div class="col-sm-4 text-center"><p><a href=/feed.xml><img src=/images/badges/feed-icon-28x28.png alt="RSS feed"></a></p></div></div><form action=https://endtracker.azurewebsites.net/api/sites/e8da9f62-b7ac-4fe9-bf20-7c527199a376/subscribers/add method=post><div class=form-group><input type=text name=email placeholder="Enter your email" class="form-control input-sm text-center">
<button type=submit class="btn btn-primary btn-block">Subscribe</button></div><small><span class=subscriber-count>0</span> subscribers</small></form></div></div><div class=row><div class=col><h2>Featured software</h2><ul><li class=overflow-ellipsis><a href=https://www.endbasic.dev/ target=_blank>EndBASIC: Online BASIC+DOS env</a></li><li class=overflow-ellipsis><a href=https://endtracker.azurewebsites.net/ target=_blank>EndTRACKER: Services for static sites</a></li></ul></div></div><div class=row><div class=col><h2>Featured posts</h2><ul><li class=overflow-ellipsis><a href=/2023/06/fast-machines-slow-machines.html>Fast machines, slow machines</a></li><li class=overflow-ellipsis><a href=/2022/12/endbasic-0.10.html>EndBASIC 0.10: Core language, evolved</a></li><li class=overflow-ellipsis><a href=/2022/10/bye-microsoft-hi-snowflake.html>Farewell, Microsoft; hello, Snowflake!</a></li><li class=overflow-ellipsis><a href=/2022/05/rust-is-hard-but-does-it-matter.html>Rust is hard, yes, but does it matter?</a></li><li class=overflow-ellipsis><a href=/2022/04/rust-traits-and-dependency-injection.html>Rust traits and dependency injection</a></li><li class=overflow-ellipsis><a href=/2022/03/a-year-on-windows-intro.html>A year on Windows: Introduction</a></li><li class=overflow-ellipsis><a href=/2021/04/always-be-quitting.html>Always be quitting</a></li><li class=overflow-ellipsis><a href=/2021/02/google-monorepos-and-caching.html>How does Google keep build times low?</a></li><li class=overflow-ellipsis><a href=/2020/12/google-no-clean-builds.html>How does Google avoid clean builds?</a></li><li class=overflow-ellipsis><a href=/2020/12/unit-testing-a-console-app.html>Unit-testing a console app (a text editor)</a></li><li class=overflow-ellipsis><a href=/essays.html#featured>More...</a></li></ul></div></div></div></div></div><footer class=container><div class=row><div class="col-4 order-2 texr-right"><p class=float-right><a href=#>Back to top</a></p></div><div class="col-8 order-1 mr-auto"><p>Copyright 2004&ndash;2023 Julio Merino</p></div></div></footer><script type=module>
  import { addAnchorsToHeaders, addElementClasses, BatchClient } from "\/js\/main.d30f168b11d80082408f4a983af9a626c6e57d58f7846b2174bac40d43be33e3.js";

  var batchClient = new BatchClient(SITE_ID);
  batchClient.doAll({
    put_request: true, get_comments: true, get_subscriber_count: true, get_votes: true });

  window.voteThumbsUp = function() { batchClient.voteThumbsUp(); }
  window.voteThumbsDown = function() { batchClient.voteThumbsDown(); }

  window.postComment = function(...args) {
    batchClient.postComment(...args);
  };

  addAnchorsToHeaders();
  addElementClasses();
</script><noscript><img src="https://hugo-dynamic.jmmv.dev/api/sites/e8da9f62-b7ac-4fe9-bf20-7c527199a376/pages/aHR0cHM6Ly9qbW12LmRldi8yMDIzLzA4L3J1c3Qtc3RhdGljLWRpc3BhdGNoLWZhaWxlZC1leHBlcmltZW50Lmh0bWw=/stamp.gif" style=display:none></noscript></body></html>