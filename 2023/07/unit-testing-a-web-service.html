<!doctype html><html lang=en xmlns=http://www.w3.org/1999/xhtml xmlns:fb=http://ogp.me/ns/fb#><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta property="og:site_name" content="Julio Merino (jmmv.dev)"><meta property="twitter:site" content="@jmmv"><title>Unit-testing a web service in Rust - Julio Merino (jmmv.dev)</title><meta property="og:title" content="Unit-testing a web service in Rust - Julio Merino (jmmv.dev)"><meta property="twitter:title" content="Unit-testing a web service in Rust - Julio Merino (jmmv.dev)"><meta name=description content="One of the things I'm most proud of the Rust web services I have written is how I can run their tests with zero setup and within milliseconds, all while making me confident that &#34;main&#34; can always be shipped to production. I've previously touched upon how this all works in other articles, but it's time for a deep dive.
To make things specific, I'll be describing the testing infrastructure of EndTRACKER, the EndBASIC Service, and the sample key/value store app of III-IV. These services are all structured in three separate layers, and I'll be covering the testing strategy for each of them.
"><meta property="og:description" content="One of the things I'm most proud of the Rust web services I have written is how I can run their tests with zero setup and within milliseconds, all while making me confident that &#34;main&#34; can always be shipped to production. I've previously touched upon how this all works in other articles, but it's time for a deep dive.
To make things specific, I'll be describing the testing infrastructure of EndTRACKER, the EndBASIC Service, and the sample key/value store app of III-IV. These services are all structured in three separate layers, and I'll be covering the testing strategy for each of them.
"><meta property="twitter:description" content="One of the things I'm most proud of the Rust web services I have written is how I can run their tests with zero setup and within milliseconds, all while making me confident that &#34;main&#34; can always be …"><meta name=author content="Julio Merino"><meta property="twitter:creator" content="@jmmv"><meta name=generator content="Hugo 0.111.3"><meta property="og:url" content="https://jmmv.dev/2023/07/unit-testing-a-web-service.html"><meta property="og:type" content="blog"><meta property="twitter:card" content="summary"><link rel=canonical href=https://jmmv.dev/2023/07/unit-testing-a-web-service.html><link rel=alternate type=application/rss+xml title="Julio Merino (jmmv.dev)" href=/feed.xml><link rel=stylesheet href=/sass/main.min.244f75538d445abb6425c819ef7becf7887c40085396245bec813abd42d0a72d.css><link rel=stylesheet href=/css/chroma.css><meta property="og:image" content="/images/favicons/favicon-1200x1200.png"><link rel=icon type=image/png href=/images/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/images/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicons/favicon-96x96.png sizes=96x96><meta property="twitter:image" content="https://jmmv.dev/images/favicons/favicon-1200x1200.png"><script>const SITE_ID="e8da9f62-b7ac-4fe9-bf20-7c527199a376",BASE_URL="https://jmmv.dev/"</script></head><body><header class=site-header><nav class="navbar navbar-expand-lg fixed-top navbar-dark bg-primary"><a class=navbar-brand href=/><img src=/images/favicons/favicon-30x30.png width=30 height=30 class="d-inline-block align-top" alt>
&nbsp;Julio Merino</a>
<button class=navbar-toggler type=button data-toggle=collapse data-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarSupportedContent><ul class="navbar-nav mr-auto"><li class=nav-item><a class=nav-link href=/about.html>About</a></li><li class=nav-item><a class=nav-link href=/essays.html>Essays</a></li><li class=nav-item><a class=nav-link href=/resume.html>Resume</a></li><li class=nav-item><a class=nav-link href=/software.html>Software</a></li></ul><ul class="navbar-nav mr-4"><li class=nav-item><a class=nav-link href=/archive.html>Archive</a></li><li class=nav-item><a class=nav-link href=/series.html>Series</a></li><li class=nav-item><a class=nav-link href=/tags.html>Tags</a></li></ul><form class=form-inline method=get role=search action=https://www.google.com/search><div class=input-group><input type=search name=query class=form-control placeholder=Search aria-label=Search><div class=input-group-append><button type=submit value=Search class="btn btn-light">
<img src=/octicons/search.svg></button></div></div><input type=hidden name=sitesearch value=https://jmmv.dev/></form></div></nav></header><div class=page-header><div class=container><h1>Unit-testing a web service in Rust</h1><p>July 7, 2023 &#183;
About 19 minutes
&#183;
Tags:
<a class=text-reset href=/tags/endbasic>endbasic</a>, <a class=text-reset href=/tags/endtracker>endtracker</a>, <a class=text-reset href=/tags/iii-iv>iii-iv</a>, <a class=text-reset href=/tags/programming>programming</a>, <a class=text-reset href=/tags/rust>rust</a></p></div></div><div class=container><div class=row><div class=col-md-9><div class=row><div class=col><article><p>One of the things I&rsquo;m most proud of the Rust web services I have written is how I can run their tests with zero setup and within milliseconds, all while making me confident that <code>main</code> can always be shipped to production. I&rsquo;ve previously touched upon how this all works in other articles, but it&rsquo;s time for a deep dive.</p><p>To make things specific, I&rsquo;ll be describing the testing infrastructure of <a href=/software/endtracker.html>EndTRACKER</a>, the <a href=/2021/07/endbasic-0.7.html>EndBASIC Service</a>, and the <a href=https://github.com/jmmv/iii-iv/tree/eec320cd02149f223d8a9c7f8d697845ec2114d8/example/>sample key/value store app of III-IV</a>. These services are all structured in three separate layers, and I&rsquo;ll be covering the testing strategy for each of them.</p><p>But before getting into how each layer is exercised on its way to production, let&rsquo;s talk about external dependencies&mldr; because dependencies are the root of all evil when it comes to the usual poor testing strategies you may encounter.</p><h1 id=interacting-with-dependencies>Interacting with dependencies</h1><p>Pretty much any web service relies on other services, which I&rsquo;ll call <em>dependencies</em>. These include databases, queuing systems, distributed storage, remote logging&mldr; you name it. The list of dependencies may be long, and their direct use in tests is typically where the friction in testing comes from: most service implementations are unable to stub their dependencies out, so the developers end up having to run the real dependencies to execute any test.</p><p>If you have worked on the development of any modern web service, particularly in a corporate environment, you&rsquo;ve witnessed the issues that running real dependencies causes:</p><ul><li><p>You have had to carefully set up your development environment with the right versions of tools and services, wasting hours (or days!) of productive time.</p></li><li><p>You have had to troubleshoot test failures caused by problems in your development environment. Any small deviation from the blessed configuration can lead to mysterious problems and you are on your own to figure them out. &ldquo;Works on my machine!&rdquo; is a common excuse to not get involved in solving a coworker&rsquo;s issue.</p></li><li><p>You have had to rely on overly powerful machines to run the tests because all the dependencies are huge and consume large amounts of RAM and CPU. After all, each dependency assumes it will be running on its own server(s) and is likely written in a language different from all other dependencies, thus requiring its own heavy runtime. <a href=/2023/06/fast-machines-slow-machines.html>Talk about waste, huh.</a></p></li><li><p>You have had to patiently wait for many minutes every time you run tests while Docker downloads multi-GB images, starts the dependencies, and waits for them to be ready to serve requests after (re)starting from scratch.</p></li><li><p>You have had to suffer from flaky tests because the connections to the dependent services sometimes fail or the state of the dependent services has somehow been polluted by other tests.</p></li><li><p>You have had to witness entire teams being spun up and funded to deal with slow CI runs and flaky tests, all while spending countless machines to support these resource-hungry tests.</p></li></ul><p>These issues are all avoidable with proper <em>upfront care</em>. I&rsquo;m convinced that most developers want to do the right thing, but: one, many times they don&rsquo;t <em>know</em> what the right thing <em>even is</em>; and, two, the pressure to &ldquo;launch and iterate&rdquo; often comes with an empty promise that there will be time &ldquo;later&rdquo; to address past cut corners. And you well know that automated tests are often ignored until they become truly necessary&mdash;that is, when the product is crashing left and right and customers are threatening to leave&mdash;at which point a solid testing infrastructure is non-existent and cannot be easily retrofit.</p><p>A key foundation to avoid these problems is to architect the system in a way that puts all external dependencies behind interfaces from the ground up. These interfaces then let you plug in different implementations of the dependencies such that most tests can skip using the real dependencies. In other words, the key foundation is <strong>Dependency Injection (DI)</strong>. And no, I&rsquo;m not talking about fancy DI frameworks: all I&rsquo;m talking about is the very basics of defining interfaces or traits and passing instances of those to constructors and functions.</p><p>Now, of course, there is a balance between A) fast and deterministic tests that rely on fake services and B) slow and accurate tests that rely on real services: the more you stub out real dependencies, the less accurate tests become. The idea, though, is to have the <em>choice</em> to pick one or the other on a test by test basis depending on the scenario to validate. And to make that choice, the system architecture must be in place to support it from the very beginning. With that in place, you can come up with the best testing strategy for each scenario, and you can choose how much of test collateral has to run every time you run tests and how much of it can be postponed to PR merge time or nightly runs.</p><p>In my services, my goal is to make the vast majority of tests run with a simple <code>cargo test</code> after a <code>git clone</code>. No configuration necessary. A small subset of tests <em>do</em> talk to the real dependencies and require configuration but, while these can run locally, I rarely need to do so because they are automated to run in CI at PR merge time.</p><p>Let&rsquo;s dive into the different layers of the architecture to see how these ideas play out. The layers are one for database access, one for business logic, and one for REST handling. You may want to read <a href=/2023/03/introducing-iii-iv.html>&ldquo;Introducing III-IV&rdquo;</a> and <a href=/2023/06/mvc-non-ui-apps.html>&ldquo;MVC but for non-UI apps&rdquo;</a> beforehand, both of which describe the general architecture of these services.</p><h1 id=database-layer-testing>Database layer testing</h1><p>My services use PostgreSQL in production. While setting up a local instance of this database is not difficult and it doesn&rsquo;t consume any meaningful resources when idle, it&rsquo;s still far from the zero setup experience I strive to achieve. So the first thing I had to do was hide the database queries behind an interface. The basic building blocks look like this and can be found in the <a href=https://github.com/jmmv/iii-iv/blob/eec320cd02149f223d8a9c7f8d697845ec2114d8/core/src/db.rs><code>iii_iv_core::db</code></a> module:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=sd>/// Abstraction over the database connection.
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=cp>#[async_trait]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>trait</span><span class=w> </span><span class=n>Db</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=sd>/// Type of the transaction wrapper type to generate.
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=k>type</span> <span class=nc>Tx</span>: <span class=nc>BareTx</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Send</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Sync</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>&#39;static</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=sd>/// Begins a transaction.
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>begin</span><span class=p>(</span><span class=o>&amp;</span><span class=bp>self</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>DbResult</span><span class=o>&lt;</span><span class=bp>Self</span>::<span class=n>Tx</span><span class=o>&gt;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=sd>/// Common operations for all transactions.
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=cp>#[async_trait]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>trait</span><span class=w> </span><span class=n>BareTx</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=sd>/// Commits the transaction.
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>commit</span><span class=p>(</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>DbResult</span><span class=o>&lt;</span><span class=p>()</span><span class=o>&gt;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>The <code>Db</code> trait exposes a generic mechanism to open a transaction against a database via its <code>begin</code> method. The returned transaction type is parameterized on <code>Db::Tx</code>, which has to be a subtrait of <code>BareTx</code>. In turn, <code>BareTx</code> represents the common operations one can do with a generic transaction but does not have any domain-specific knowledge.</p><p>Each web service is responsible for supplying its own transaction trait that extends <code>BareTx</code> with the operations that make sense in its domain. For example, here is how the sample key/value store service that ships with III-IV exposes the database operations needed to implement the key retrieval and storage operations. Note that the upstream code uses the name <code>Tx</code> for this trait, but I&rsquo;ve renamed it to <code>KVStoreTx</code> in this text for clarity:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=cp>#[async_trait]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>trait</span><span class=w> </span><span class=n>KVStoreTx</span>: <span class=nc>BareTx</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=sd>/// Gets the current value of the given `key`.
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>get_key</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>,</span><span class=w> </span><span class=n>key</span>: <span class=kp>&amp;</span><span class=nc>Key</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>DbResult</span><span class=o>&lt;</span><span class=n>Entry</span><span class=o>&gt;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=sd>/// Sets `key` to `entry`, which includes its value and version.
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=w>    </span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>set_key</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>,</span><span class=w> </span><span class=n>key</span>: <span class=kp>&amp;</span><span class=nc>Key</span><span class=p>,</span><span class=w> </span><span class=n>entry</span>: <span class=kp>&amp;</span><span class=nc>Entry</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>DbResult</span><span class=o>&lt;</span><span class=p>()</span><span class=o>&gt;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ... and several more ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>There is nothing in these interfaces that points to database-specific behavior, which is intentional. The only thing that client code is allowed to do is create a transaction and call the business-specific methods on it, without knowing what the transaction is talking to. Going back to the example above, this snippet would fetch the value of a key from the key/value store:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>tx</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>db</span><span class=p>.</span><span class=n>begin</span><span class=p>().</span><span class=k>await</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>let</span><span class=w> </span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tx</span><span class=p>.</span><span class=n>get_key</span><span class=p>(</span><span class=n>key</span><span class=p>).</span><span class=k>await</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>tx</span><span class=p>.</span><span class=n>commit</span><span class=p>().</span><span class=k>await</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>With the service-specific transaction type in place (<code>KVStoreTx</code>), the service is also responsible for supplying separate implementations of it for all databases the service wishes to support. As mentioned earlier, this means providing a variant for PostgreSQL for production usage. But what about tests? Tests could use their own database-less implementation&mdash;for this trivial example, a <code>HashMap</code> would suffice&mdash;but going this route becomes tricky once you want to reproduce more realistic OLTP database behavior, especially when concurrent operations take place. The other obvious alternative is to use SQLite: a real database that requires zero configuration, which fits the perfect bill for unit tests.</p><p>As a result, I end up with the following types in the system:</p><ul><li>A generic <code>PostgresDb</code> (provided by <a href=https://github.com/jmmv/iii-iv/tree/eec320cd02149f223d8a9c7f8d697845ec2114d8/postgres/><code>iii_iv_postgres</code></a>) and a service-specific <code>PostgresKVStoreTx</code> for production.</li><li>A generic <code>SqliteDb</code> (provided by <a href=https://github.com/jmmv/iii-iv/tree/eec320cd02149f223d8a9c7f8d697845ec2114d8/sqlite/><code>iii_iv_sqlite</code></a>) and service-specific <code>SqliteKVStoreTx</code> for tests.</li></ul><p>Implementing the same database queries against two different database systems is annoying indeed, but forcing myself to do this keeps me honest in maintaining true abstractions. However, it is critical that these implementations behave as similarly as possible and, to guarantee this, I write extensive unit tests in a separate <code>db/tests.rs</code> file. These tests look like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>test_simplified_get_after_set</span><span class=o>&lt;</span><span class=n>D</span><span class=o>&gt;</span><span class=p>(</span><span class=n>db</span>: <span class=nc>D</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>where</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>D</span>: <span class=nc>Db</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>D</span>::<span class=n>Tx</span>: <span class=nc>KVStoreTx</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>tx</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>db</span><span class=p>.</span><span class=n>begin</span><span class=p>().</span><span class=k>await</span><span class=p>.</span><span class=n>unwrap</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>key</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Key</span>::<span class=n>new</span><span class=p>(</span><span class=s>&#34;the-key&#34;</span><span class=p>.</span><span class=n>to_owned</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>entry</span><span class=w> </span><span class=o>=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Entry</span>::<span class=n>new</span><span class=p>(</span><span class=s>&#34;insert&#34;</span><span class=p>.</span><span class=n>to_owned</span><span class=p>(),</span><span class=w> </span><span class=n>Version</span>::<span class=n>from_u32</span><span class=p>(</span><span class=mi>1</span><span class=p>).</span><span class=n>unwrap</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>tx</span><span class=p>.</span><span class=n>set_key</span><span class=p>(</span><span class=o>&amp;</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>entry</span><span class=p>).</span><span class=k>await</span><span class=p>.</span><span class=n>unwrap</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>assert_eq!</span><span class=p>(</span><span class=n>entry</span><span class=p>,</span><span class=w> </span><span class=n>tx</span><span class=p>.</span><span class=n>get_key</span><span class=p>(</span><span class=o>&amp;</span><span class=n>key</span><span class=p>).</span><span class=k>await</span><span class=p>.</span><span class=n>unwrap</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>tx</span><span class=p>.</span><span class=n>commit</span><span class=p>().</span><span class=k>await</span><span class=p>.</span><span class=n>unwrap</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>As you can see, each tests is parameterized on a <code>D</code> type. The <code>D</code> type is an implementation of the <code>Db</code> trait presented earlier, whose only purpose is to yield new transactions of its inner <code>D::Tx</code> type based on a pre-established connection. The <code>D::Tx</code> type is mapped to the domain-specific <code>KVStoreTx</code> type so that tests have access to the primitives to be tested. Notably, though, the tests have no way of knowing which database they are talking to.</p><p>With these generic tests in place, the question is: how are they executed against the individual database implementations? The <code>db/postgres.rs</code> and <code>db/sqlite.rs</code> modules of each service define <code>#[test]</code> entry points for each test. These entry points are thin wrappers for the common test code in <code>db/tests.rs</code> and their sole purpose is to establish a connection to the database and then delegate to the test implementation. Basically, each wrapper looks like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=sd>/// This is the specialization of a test for SQLite.
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=cp>#[tokio::test]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>test_simplified_get_after_set</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Create a connection to the SQLite in-memory database.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>db</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>iii_iv_sqlite</span>::<span class=n>testutils</span>::<span class=n>setup</span>::<span class=o>&lt;</span><span class=n>SqliteKVStoreTX</span><span class=o>&gt;</span><span class=p>().</span><span class=k>await</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Delegate to the common test code.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=k>crate</span>::<span class=n>db</span>::<span class=n>tests</span>::<span class=n>test_simplified_get_after_set</span><span class=p>(</span><span class=n>db</span><span class=p>).</span><span class=k>await</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=sd>/// This is the specialization of a test for PostgreSQL.
</span></span></span><span class=line><span class=cl><span class=sd>///
</span></span></span><span class=line><span class=cl><span class=sd>/// Note how the test is marked `ignore`.  We&#39;ll see why that is later on.
</span></span></span><span class=line><span class=cl><span class=sd></span><span class=cp>#[tokio::test]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[ignore = </span><span class=s>&#34;Requires environment configuration and is expensive&#34;</span><span class=cp>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>test_simplified_get_after_set</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Create a connection to PostgreSQL using the configuration specified via
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=c1>// environment variables.  The connection is set up to use a temporary
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=c1>// schema so that tests are isolated from each other and don&#39;t leave garbage
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=c1>// behind.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>db</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>iii_iv_postgres</span>::<span class=n>testutils</span>::<span class=n>setup</span>::<span class=o>&lt;</span><span class=n>PostgresKVStoreTx</span><span class=o>&gt;</span><span class=p>().</span><span class=k>await</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Delegate to the common test code.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=k>crate</span>::<span class=n>db</span>::<span class=n>tests</span>::<span class=n>test_simplified_get_after_set</span><span class=p>(</span><span class=n>db</span><span class=p>).</span><span class=k>await</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>For a long while, this is actually how the test wrappers looked like and&mldr; they were written by hand. At some point, I grew tired of copy/pasting these snippets over and over again and invested a wee bit of time learning how to leverage macros to cut down the repetition. It wasn&rsquo;t as difficult as I imagined. You can see how this works in practice in the sample key/value store <a href=https://github.com/jmmv/iii-iv/blob/eec320cd02149f223d8a9c7f8d697845ec2114d8/example/src/db/tests.rs>tests</a> and their <a href=https://github.com/jmmv/iii-iv/blob/eec320cd02149f223d8a9c7f8d697845ec2114d8/example/src/db/sqlite.rs#L150>instantiation for SQLite</a>.</p><h1 id=driver-layer-testing>Driver layer testing</h1><p>Let&rsquo;s jump one level up and look at the testing approach for the driver layer.</p><p>The driver layer of each service typically exposes a single <code>Driver</code> type. The <code>Driver</code> maintains the state of the application and provides entry points for all REST operations, usually with a 1:1 mapping between REST API and driver method.</p><p>To instantiate a <code>Driver</code>, all service dependencies are injected at creation time. Here is an example of how the <code>Driver</code> constructor looks like for the EndTRACKER data plane service, which is more interesting to analyze than the driver for the sample key/value store:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>pub</span><span class=p>(</span><span class=k>crate</span><span class=p>)</span><span class=w> </span><span class=k>fn</span> <span class=nf>new</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>db</span>: <span class=nc>D</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>clock</span>: <span class=nc>C</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>geolocator</span>: <span class=nc>G</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>abuse_policy</span>: <span class=nc>A</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>queue_client</span>: <span class=nc>Client</span><span class=o>&lt;</span><span class=n>BatchTask</span><span class=p>,</span><span class=w> </span><span class=n>C</span><span class=p>,</span><span class=w> </span><span class=no>QD</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>Self</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=bp>Self</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>db</span><span class=p>,</span><span class=w> </span><span class=n>clock</span><span class=p>,</span><span class=w> </span><span class=n>geolocator</span><span class=p>,</span><span class=w> </span><span class=n>abuse_policy</span><span class=p>,</span><span class=w> </span><span class=n>queue_client</span><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>See? A trivial constructor that <em>does no work</em>, as it shall be done. Neat&mldr; but what are all these type parameters? These type parameters are what allow injecting the different implementations of each dependency into the service for testing purposes.</p><p>Now, why are they are type parameters? Simply because I wanted to <em>try</em> using static dispatch, and&mldr; things have gotten unwieldy. All references to the <code>Driver</code> type in <code>impl</code> blocks look like this awful chunk:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>impl</span><span class=o>&lt;</span><span class=n>A</span><span class=p>,</span><span class=w> </span><span class=n>C</span><span class=p>,</span><span class=w> </span><span class=n>D</span><span class=p>,</span><span class=w> </span><span class=n>G</span><span class=p>,</span><span class=w> </span><span class=no>QD</span><span class=o>&gt;</span><span class=w> </span><span class=n>Driver</span><span class=o>&lt;</span><span class=n>A</span><span class=p>,</span><span class=w> </span><span class=n>C</span><span class=p>,</span><span class=w> </span><span class=n>D</span><span class=p>,</span><span class=w> </span><span class=n>G</span><span class=p>,</span><span class=w> </span><span class=no>QD</span><span class=o>&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>where</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>A</span>: <span class=nc>AbusePolicy</span><span class=o>&lt;</span><span class=n>D</span>::<span class=n>Tx</span><span class=o>&gt;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Clone</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Send</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Sync</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>&#39;static</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>C</span>: <span class=nc>Clock</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Clone</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Send</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Sync</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>&#39;static</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>D</span>: <span class=nc>Db</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Clone</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Send</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Sync</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>&#39;static</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>D</span>::<span class=n>Tx</span>: <span class=nc>DataTx</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>From</span><span class=o>&lt;</span><span class=n>D</span>::<span class=n>SqlxTx</span><span class=o>&gt;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Send</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Sync</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>&#39;static</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>G</span>: <span class=nc>GeoLocator</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Clone</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Send</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Sync</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>&#39;static</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=no>QD</span>: <span class=nc>Db</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Clone</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Send</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Sync</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>&#39;static</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=no>QD</span>::<span class=n>Tx</span>: <span class=nc>ClientTx</span><span class=o>&lt;</span><span class=n>T</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>BatchTask</span><span class=o>&gt;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>From</span><span class=o>&lt;</span><span class=no>QD</span>::<span class=n>SqlxTx</span><span class=o>&gt;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Send</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>Sync</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nb>&#39;static</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>If I had to write this monstrosity <em>just once</em>, it could be tolerable. But because I split the implementation of the <code>Driver</code> across different files to keep them short&mldr; this chunk is repeated across many files and keeping them in sync is a humongous hassle. I&rsquo;m&mldr; not happy. Fear not though: the alternative is to use <code>Arc&lt;Mutex&lt;T>></code> everywhere with <code>T</code> being a type alias over the trait, which keeps the noise down significantly. Mind you, I used to do this and I&rsquo;m not sure the switch to static dispatch was worth it. But I digress&mldr;</p><p>Because all these types are parameterized, it means I can instantiate a <code>Driver</code> and back it by different implementations of each dependency. For example:</p><ul><li>The <code>db</code> can be backed by PostgreSQL in production and SQLite in tests as I have already covered in the database layer section.</li><li>The <code>clock</code> can be backed by a <code>SystemClock</code> that returns the system time, and also by a <code>MonotonicClock</code> that exposes fake (and deterministic!) time.</li><li>The <code>geolocator</code> can be backed by an <code>AzureGeoLocator</code> that talks to Azure Maps, and also by a <code>MockGeoLocator</code> that returns pre-configured results and errors.</li></ul><p>&mldr; and similarly for any other resource needed by the <code>Driver</code>.</p><p>This, once again, allows: writing super-fast non-flaky unit tests because they do not reach out to real resources; running the tests with zero configuration; and avoiding the need to spawn resource-hungry dependencies on the local machine.</p><p>So what do tests in the driver layer actually test? These tests are mostly responsible for validating the business logic. They cover all happy paths but, critically, they <em>also</em> cover all error paths I can think about&mdash;something that&rsquo;s made trivial by the use of fake dependencies. These tests do not cover any HTTP interactions though; for those, we have to move up one layer.</p><h1 id=rest-layer-testing>REST layer testing</h1><p>The REST layer is the one interfacing with the user of the web services via the network. This is the layer where requests are deserialized, validated, routed to the driver, and where responses or errors are serialized back to the user with the correct HTTP status codes.</p><p>This layer is currently written using the <code>axum</code> web framework, whose fundamental building block is the <code>Router</code>. Each web service creates a new <code>Router</code> and registers all API endpoints plus an instance of the <code>Driver</code> that gets passed to the API handlers as a state parameter. Take a look at the <a href=https://github.com/jmmv/iii-iv/blob/eec320cd02149f223d8a9c7f8d697845ec2114d8/example/src/rest/mod.rs#L37>sample key/value store router creation</a>.</p><p>Because the <code>Driver</code> is injected into the REST <code>Router</code>, it can be parameterized with all the non-production dependencies as described earlier&mdash;and it is. Now, the question is: what do the tests of the REST layer look like and what do they do?</p><p>For these, I used to spawn a local instance of the HTTP server, listening on a random unused port, and then made the tests call HTTP endpoints over the loopback interface with the <code>reqwest</code> crate. Once I moved to <code>axum</code> from <code>warp</code>, things improved. I could start relying on the one-shot testing feature exposed by this framework, which allows calling the router endpoints without going through the network. Not a revolutionary change, but a nice improvement for simplicity indeed.</p><p>To test this layer, I apply the <a href=/2020/12/builder-pattern-for-tests.html>builder pattern to define test scenarios</a>. With this idiom, I can capture the parameters to an API call and the expectations of what it should return in a declarative manner. Here is one example of a test for the &ldquo;put key&rdquo; operation of the sample key/value store:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>fn</span> <span class=nf>route</span><span class=p>(</span><span class=n>key</span>: <span class=kp>&amp;</span><span class=kt>str</span><span class=p>)</span><span class=w> </span>-&gt; <span class=p>(</span><span class=n>http</span>::<span class=n>Method</span><span class=p>,</span><span class=w> </span><span class=nb>String</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=n>http</span>::<span class=n>Method</span>::<span class=no>PUT</span><span class=p>,</span><span class=w> </span><span class=fm>format!</span><span class=p>(</span><span class=s>&#34;/api/v1/keys/</span><span class=si>{}</span><span class=s>&#34;</span><span class=p>,</span><span class=w> </span><span class=n>key</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[tokio::test]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>test_create</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>context</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>TestContext</span>::<span class=n>setup</span><span class=p>().</span><span class=k>await</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>response</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>OneShotBuilder</span>::<span class=n>new</span><span class=p>(</span><span class=n>context</span><span class=p>.</span><span class=n>app</span><span class=p>(),</span><span class=w> </span><span class=n>route</span><span class=p>(</span><span class=s>&#34;first&#34;</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>send_text</span><span class=p>(</span><span class=s>&#34;new value&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=k>await</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>expect_status</span><span class=p>(</span><span class=n>http</span>::<span class=n>StatusCode</span>::<span class=no>CREATED</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>expect_json</span>::<span class=o>&lt;</span><span class=n>Entry</span><span class=o>&gt;</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=k>await</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>exp_response</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Entry</span>::<span class=n>new</span><span class=p>(</span><span class=s>&#34;new value&#34;</span><span class=p>.</span><span class=n>to_owned</span><span class=p>(),</span><span class=w> </span><span class=n>Version</span>::<span class=n>initial</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>assert_eq!</span><span class=p>(</span><span class=n>exp_response</span><span class=p>,</span><span class=w> </span><span class=n>response</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>assert_eq!</span><span class=p>(</span><span class=n>exp_response</span><span class=p>,</span><span class=w> </span><span class=n>context</span><span class=p>.</span><span class=n>get_key</span><span class=p>(</span><span class=s>&#34;first&#34;</span><span class=p>).</span><span class=k>await</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>In this test, <code>TestContext</code> is a container that helps set up the <code>Driver</code> with fake dependencies and instantiates the <code>Router</code> around it. The most interesting part is the use of my own <a href=https://github.com/jmmv/iii-iv/blob/eec320cd02149f223d8a9c7f8d697845ec2114d8/core/src/rest.rs#L223><code>OneShotBuilder</code></a>, which implements the builder pattern for one-shot calls. With this at hand, the test says that it has to send a specific text document to a specific <code>PUT</code> endpoint and then expects that the HTTP API call returns a <code>CREATED</code> status code with a valid JSON response of type <code>Entry</code>. Finally, the <code>context.get_key</code> call is a helper method that <em>pokes directly into the database</em> to see if the key is set, which validates the side-effects of the API call on persistent storage.</p><p>The tests in this layer are responsible for validating anything that&rsquo;s specific to the interactions with the user over HTTP, but these tests assume that both the driver and database layers work correctly. This is why these tests do not validate in excruciating detail all the possible corner cases that we can face in the driver or its interactions with external dependencies: the driver tests have that responsibility.</p><h1 id=fidelity-problems>Fidelity problems</h1><p>Alright, so that&rsquo;s the majority of the current testing approach. We have seen how the foundational database layer is architected to support dual implementations via PostgreSQL and SQLite, how other supporting services are modeled with the same duality, and how the driver and REST layers leverage the in-memory / fake implementations to provide logical test coverage at all layers. As is, these provide very good coverage of the functionality of the web services and give me almost full confidence that <code>main</code> is release-quality at any given time.</p><p>But there are still some risks.</p><p>The major risk in using SQLite for tests vs. PostgreSQL for production is that they are very different databases. Sure, they are both OLTP SQL databases, but their SQL languages are distinct dialects and SQLite is in-process whereas PostgreSQL runs on a server. Dealing with slightly-different SQL queries is easy because the differences are obvious, but there are subtle differences in behavior that influence how calls behave, especially in error conditions. For example: you will never experience a &ldquo;maximum connections reached&rdquo; error with SQLite, but you surely will with PostgreSQL. Similarly, SQLite might give you trouble with concurrent writes while PostgreSQL won&rsquo;t. There are also risks when replacing the clock with a fake one, or when replacing other services such as the Azure Maps or SMTP clients with stub implementations.</p><p>Now, you&rsquo;d say: <em>&ldquo;Well, you are facing these fidelity issues because you don&rsquo;t test against the real thing, duh. If all your tests used the real dependencies, then you&rsquo;d be fine!&rdquo;</em> Except&mldr; that&rsquo;s not how testing works. When writing a test, you can do two things:</p><ul><li><p>You can write tests for the &ldquo;known knowns&rdquo;: the happy and failure paths that you know can happen.</p></li><li><p>You can write tests for the &ldquo;known unknowns&rdquo;: the scenarios you think might happen but for which you have no good answers and you need to discover what their behavior is.</p></li></ul><p>These are easy to model in tests, and if you are writing these tests, then you can make sure your real and fake dependencies behave in the same way.</p><p>But there is another class of failures that you cannot test for with unit tests: the &ldquo;unknown unknowns&rdquo;. These are the situations you do not anticipate, and because you do not anticipate them, you cannot write tests for them. It doesn&rsquo;t matter that you are using the real dependencies or fake dependencies. If you cannot imagine these scenarios, no test will cover them. And this is where I have encountered interesting bugs in production before.</p><h1 id=real-system-testing>Real system testing</h1><p>Thus, even though most of the testing I do in the web services is fast and requires no setup, there is still a need to validate &ldquo;the real thing&rdquo;: that is, the service talking to the real dependencies under real world conditions and usage.</p><p>To accomplish this, I do two things.</p><p>The first is I write tests that actually talk to the real services (oops). These tests all require manual configuration and are marked with <code>#[ignore]</code> as we saw earlier so that a <code>cargo test</code> won&rsquo;t pick them up by default. The CI jobs are configured to supply the right settings for these tests, and the PR merge checks forcibly run these ignored tests. It is also possible to run these tests locally by manually configuring the environment in a <code>config.env</code> file and using a trivial <code>test.sh</code> script that hooks things up with <code>cargo test</code>, but as said earlier, I rarely have to do so.</p><p>The second is I deploy to a staging environment and do manual testing on it. Every commit merged into <code>main</code> gets automatically deployed to a staging instance of the service (which is made easy by Azure Functions&rsquo; slot feature), and I do some manual validation that things work. I could automate this testing, of course, but it is something that can still wait.</p><h1 id=is-this-enough>Is this enough?</h1><p>I know this is an overly simplistic view of the world, and that this testing approach can let some subtle bugs slip through. It has actually happened before. But thanks to this testing approach&mdash;and Rust&rsquo;s type system, whose help cannot be overstated&mdash;every new feature I have launched <em>has worked on the first try</em> and the web services have kept happily chugging along the years. This is critical to me because these web services are just side projects of mine, so I must ensure they cause me the least trouble possible in production.</p><p>Finally, let me clarify one thing: I&rsquo;ve been talking about &ldquo;unit tests&rdquo; throughout this post, but if we want to be pedantic, almost nothing of what I described are pure unit tests. Every test at every layer relies on the layers below it to behave correctly: the service&rsquo;s own code is never stubbed out so, for example, a test for the REST layer will run code in the driver and database layers. The only thing that&rsquo;s stubbed out are the connections to external services. I believe this style of testing provides much more realistic scenarios at the expense of making them more subtle to breakage when code changes.</p><p>And that&rsquo;s it for today. If you liked this post, you may also enjoy <a href=/2020/12/unit-testing-a-console-app.html>&ldquo;Unit-testing a console app (a text editor)&rdquo;</a> from over 2 years ago. It is then that I came up with the idea of using the builder pattern to define tests, and that idea still proves very useful to this day.</p></article></div></div><div class="container post-links"><div class=row><div class="col mr-auto text-left"><span><a href=https://jmmv.dev/2023/07/ldd-untrusted-binaries.html>&#171; Previous</a></span></div><div class="col text-center"><span><a href=/archive.html>All posts</a></span></div><div class="col ml-auto text-right"><span><a href=https://jmmv.dev/2023/08/rust-static-dispatch-failed-experiment.html>Next &#187;</a></span></div></div></div><div class="container post-votes"><div class=row><div class="col-lg-4 my-2"><div class=row><div class=col><a onclick=voteThumbsUp() class="btn btn-block btn-outline-success" id=thumbs-up-btn>👍
(<span id=thumbs-up-count>0</span>)</a></div><div class=col><a onclick=voteThumbsDown() class="btn btn-block btn-outline-danger" id=thumbs-down-btn>👎
(<span id=thumbs-down-count>0</span>)</a></div></div></div><div class="col-lg-8 my-2 d-none d-sm-block"><div class=row><div class="col-md-4 text-center"><a href="https://www.reddit.com/submit?title=Unit-testing+a+web+service+in+Rust&amp;url=https%3A%2F%2Fjmmv.dev%2F2023%2F07%2Funit-testing-a-web-service.html" class="btn btn-block btn-outline-primary">Share on
<img src=/images/badges/reddit.png alt=Reddit width=24 height=24></a></div><div class="col-md-4 text-center"><a href="https://news.ycombinator.com/submitlink?t=Unit-testing+a+web+service+in+Rust&amp;u=https%3A%2F%2Fjmmv.dev%2F2023%2F07%2Funit-testing-a-web-service.html" class="btn btn-block btn-outline-primary">Share on
<img src=/images/badges/ycombinator.png alt="Hacker News" width=24 height=24></a></div><div class="col-md-4 text-center"><a href="https://twitter.com/intent/tweet?status=Unit-testing+a+web+service+in+Rust+%E2%80%94+https%3A%2F%2Fjmmv.dev%2F2023%2F07%2Funit-testing-a-web-service.html+%E2%80%94+cc+%40jmmv" class="btn btn-block btn-outline-primary">Share on
<img src=/images/badges/Twitter_Social_Icon_Circle_Color.png alt=Twitter width=24 height=24></a></div></div></div></div><div class="row my-4" id=postCommentRow><div class=col><div class=media><img class=mr-3 src=/octicons/pencil.svg width=32px height=32px><div class="media-body container"><form method=post id=newPost><div class=row><div class="col my-1"><textarea class=form-control rows=1 id=postCommentContent onclick=showPostComment() placeholder="Leave a comment"></textarea></div></div><div class="row newPostControls" style=display:none><div class="col my-1 form-group"><label for=postCommentAuthor>Your name (optional):</label>
<input type=text class=form-control id=postCommentAuthor></div></div><div class="row newPostControls" style=display:none><div class="col my-1 form-group"><label for=postCommentEmail>Your email (optional):</label>
<input type=text class=form-control type=email id=postCommentEmail>
<small class="form-text text-muted">Invisible to all readers; if provided, you will receive notifications when replied to (not implemented yet)</small></div></div><div class=row id=postCommentError style=display:none><div class="col mt-1 alert-danger"><p></p></div></div><div class="row newPostControls" style=display:none><button class="col-md-3 my-1 btn btn-primary" type=submit id=submitCommentButton>Post</button>
<small class="col-md-9 my-1 text-muted">Comments are subject to moderation. This feature is experimental and is powered by <a href=/software/endtracker.html>EndTRACKER</a>. If you experience any issues, please <a href=/about.html#contact>contact me off-band</a>.</small></div></form></div></div></div></div><script>function hidePostComment(){var t,e=document.getElementById("postCommentContent");e.rows=1,e.value="",t=document.getElementsByClassName("newPostControls"),Array.prototype.forEach.call(t,function(e){e.style.display="none"})}function showPostComment(){var e,t=document.getElementById("postCommentContent");t.rows=5,e=document.getElementsByClassName("newPostControls"),Array.prototype.forEach.call(e,function(e){e.style.display=""})}const form=document.querySelector("#newPost");form.onsubmit=function(e){e.preventDefault();let t=document.getElementById("postCommentAuthor").value,n=document.getElementById("postCommentEmail").value,s=document.getElementById("postCommentContent").value;postComment(t,n,s,hidePostComment)}</script></div><div class="container post-subscribe"><div class=row><div class="col-sm-3 py-2"><div class=row><div class="col px-2 text-center"><a rel=me href=https://mastodon.online/@jmmv><img src=/images/badges/mastodon-logo.svg width=32px height=32px alt="Follow @jmmv on Mastodon"></a></div><div class="col px-2 text-center"><a href="https://twitter.com/intent/follow?original_referer=https%3A%2F%2Fjmmv.dev%2F&amp;screen_name=jmmv"><img src=/images/badges/Twitter_logo_blue.svg width=32px height=32px alt="Follow @jmmv on Twitter"></a></div><div class="col px-2 text-center"><a href=/feed.xml><img src=/images/badges/feed-icon-28x28.png alt="RSS feed"></a></div></div></div><div class="col-sm-9 py-2 text-center"><form action=https://endtracker.azurewebsites.net/api/sites/e8da9f62-b7ac-4fe9-bf20-7c527199a376/subscribers/add method=post><div class=form-group><div class=row><input type=text name=email placeholder="Enter your email" class="form-control input-sm col-8 text-center">
<button type=submit class="btn btn-primary col-4">Subscribe</button></div></div><small><span class=subscriber-count>0</span> subscribers</small></form></div></div></div></div><div class="col-md-3 sidebar d-none d-md-block"><div class=row><div class="col text-center p-2"><p><a href=/about.html class=clear-link><img src=/images/avatars/20181124-snow.jpg class="rounded-circle shadow my-2" style=width:100px><br><b>Julio Merino</b><br>A blog on operating systems, programming languages, testing, build systems, my own software
projects and even personal productivity. Specifics include FreeBSD, Linux, Rust, Bazel and
EndBASIC.</a></p><div class=row><div class="col-sm-4 text-center"><p><a rel=me href=https://mastodon.online/@jmmv><img src=/images/badges/mastodon-logo.svg width=32px height=32px alt="Follow @jmmv on Mastodon"></a></p></div><div class="col-sm-4 text-center"><p><a href="https://twitter.com/intent/follow?original_referer=https%3A%2F%2Fjmmv.dev%2F&amp;screen_name=jmmv"><img src=/images/badges/Twitter_logo_blue.svg width=32px height=32px alt="Follow @jmmv on Twitter"></a></p></div><div class="col-sm-4 text-center"><p><a href=/feed.xml><img src=/images/badges/feed-icon-28x28.png alt="RSS feed"></a></p></div></div><form action=https://endtracker.azurewebsites.net/api/sites/e8da9f62-b7ac-4fe9-bf20-7c527199a376/subscribers/add method=post><div class=form-group><input type=text name=email placeholder="Enter your email" class="form-control input-sm text-center">
<button type=submit class="btn btn-primary btn-block">Subscribe</button></div><small><span class=subscriber-count>0</span> subscribers</small></form></div></div><div class=row><div class=col><h2>Featured posts</h2><ul><li class=overflow-ellipsis><a href=/2023/06/fast-machines-slow-machines.html>Fast machines, slow machines</a></li><li class=overflow-ellipsis><a href=/2022/12/endbasic-0.10.html>EndBASIC 0.10: Core language, evolved</a></li><li class=overflow-ellipsis><a href=/2022/10/bye-microsoft-hi-snowflake.html>Farewell, Microsoft; hello, Snowflake!</a></li><li class=overflow-ellipsis><a href=/2022/05/rust-is-hard-but-does-it-matter.html>Rust is hard, yes, but does it matter?</a></li><li class=overflow-ellipsis><a href=/2022/04/rust-traits-and-dependency-injection.html>Rust traits and dependency injection</a></li><li class=overflow-ellipsis><a href=/2022/03/a-year-on-windows-intro.html>A year on Windows: Introduction</a></li><li class=overflow-ellipsis><a href=/2021/04/always-be-quitting.html>Always be quitting</a></li><li class=overflow-ellipsis><a href=/2021/02/google-monorepos-and-caching.html>How does Google keep build times low?</a></li><li class=overflow-ellipsis><a href=/2020/12/google-no-clean-builds.html>How does Google avoid clean builds?</a></li><li class=overflow-ellipsis><a href=/2020/12/unit-testing-a-console-app.html>Unit-testing a console app (a text editor)</a></li><li class=overflow-ellipsis><a href=/essays.html#featured>More...</a></li></ul></div></div><div class=row><div class=col><h2>Archive</h2><ul><li><a data-toggle=collapse href=#archive-year-2023>2023</a> (10)<ul id=archive-year-2023 class=collapse><li><a href=/archive.html#2023-08>August 2023</a> (1)</li><li><a href=/archive.html#2023-07>July 2023</a> (2)</li><li><a href=/archive.html#2023-06>June 2023</a> (4)</li><li><a href=/archive.html#2023-03>March 2023</a> (2)</li><li><a href=/archive.html#2023-01>January 2023</a> (1)</li></ul></li><li><a data-toggle=collapse href=#archive-year-2022>2022</a> (32)<ul id=archive-year-2022 class=collapse><li><a href=/archive.html#2022-12>December 2022</a> (1)</li><li><a href=/archive.html#2022-11>November 2022</a> (1)</li><li><a href=/archive.html#2022-10>October 2022</a> (1)</li><li><a href=/archive.html#2022-07>July 2022</a> (1)</li><li><a href=/archive.html#2022-06>June 2022</a> (2)</li><li><a href=/archive.html#2022-05>May 2022</a> (2)</li><li><a href=/archive.html#2022-04>April 2022</a> (4)</li><li><a href=/archive.html#2022-03>March 2022</a> (15)</li><li><a href=/archive.html#2022-02>February 2022</a> (4)</li><li><a href=/archive.html#2022-01>January 2022</a> (1)</li></ul></li><li><a data-toggle=collapse href=#archive-year-2021>2021</a> (22)<ul id=archive-year-2021 class=collapse><li><a href=/archive.html#2021-11>November 2021</a> (2)</li><li><a href=/archive.html#2021-08>August 2021</a> (2)</li><li><a href=/archive.html#2021-07>July 2021</a> (5)</li><li><a href=/archive.html#2021-06>June 2021</a> (1)</li><li><a href=/archive.html#2021-04>April 2021</a> (2)</li><li><a href=/archive.html#2021-03>March 2021</a> (2)</li><li><a href=/archive.html#2021-02>February 2021</a> (3)</li><li><a href=/archive.html#2021-01>January 2021</a> (5)</li></ul></li><li><a data-toggle=collapse href=#archive-year-2020>2020</a> (36)<ul id=archive-year-2020 class=collapse><li><a href=/archive.html#2020-12>December 2020</a> (4)</li><li><a href=/archive.html#2020-11>November 2020</a> (5)</li><li><a href=/archive.html#2020-10>October 2020</a> (5)</li><li><a href=/archive.html#2020-09>September 2020</a> (2)</li><li><a href=/archive.html#2020-08>August 2020</a> (6)</li><li><a href=/archive.html#2020-07>July 2020</a> (2)</li><li><a href=/archive.html#2020-06>June 2020</a> (2)</li><li><a href=/archive.html#2020-05>May 2020</a> (3)</li><li><a href=/archive.html#2020-04>April 2020</a> (2)</li><li><a href=/archive.html#2020-03>March 2020</a> (2)</li><li><a href=/archive.html#2020-02>February 2020</a> (1)</li><li><a href=/archive.html#2020-01>January 2020</a> (2)</li></ul></li><li><a data-toggle=collapse href=#archive-year-2019>2019</a> (24)<ul id=archive-year-2019 class=collapse><li><a href=/archive.html#2019-12>December 2019</a> (8)</li><li><a href=/archive.html#2019-11>November 2019</a> (6)</li><li><a href=/archive.html#2019-10>October 2019</a> (1)</li><li><a href=/archive.html#2019-09>September 2019</a> (2)</li><li><a href=/archive.html#2019-03>March 2019</a> (2)</li><li><a href=/archive.html#2019-02>February 2019</a> (3)</li><li><a href=/archive.html#2019-01>January 2019</a> (2)</li></ul></li><li><a data-toggle=collapse href=#archive-year-2018>2018</a> (25)<ul id=archive-year-2018 class=collapse><li><a href=/archive.html#2018-07>July 2018</a> (3)</li><li><a href=/archive.html#2018-06>June 2018</a> (7)</li><li><a href=/archive.html#2018-05>May 2018</a> (2)</li><li><a href=/archive.html#2018-04>April 2018</a> (2)</li><li><a href=/archive.html#2018-03>March 2018</a> (8)</li><li><a href=/archive.html#2018-02>February 2018</a> (3)</li></ul></li><li><a data-toggle=collapse href=#archive-year-2017>2017</a> (6)<ul id=archive-year-2017 class=collapse><li><a href=/archive.html#2017-10>October 2017</a> (1)</li><li><a href=/archive.html#2017-08>August 2017</a> (1)</li><li><a href=/archive.html#2017-07>July 2017</a> (1)</li><li><a href=/archive.html#2017-02>February 2017</a> (3)</li></ul></li><li><a data-toggle=collapse href=#archive-year-2016>2016</a> (8)<ul id=archive-year-2016 class=collapse><li><a href=/archive.html#2016-09>September 2016</a> (1)</li><li><a href=/archive.html#2016-05>May 2016</a> (1)</li><li><a href=/archive.html#2016-04>April 2016</a> (1)</li><li><a href=/archive.html#2016-03>March 2016</a> (2)</li><li><a href=/archive.html#2016-02>February 2016</a> (1)</li><li><a href=/archive.html#2016-01>January 2016</a> (2)</li></ul></li><li><a data-toggle=collapse href=#archive-year-2015>2015</a> (17)<ul id=archive-year-2015 class=collapse><li><a href=/archive.html#2015-12>December 2015</a> (2)</li><li><a href=/archive.html#2015-10>October 2015</a> (2)</li><li><a href=/archive.html#2015-09>September 2015</a> (3)</li><li><a href=/archive.html#2015-06>June 2015</a> (2)</li><li><a href=/archive.html#2015-05>May 2015</a> (3)</li><li><a href=/archive.html#2015-04>April 2015</a> (1)</li><li><a href=/archive.html#2015-03>March 2015</a> (1)</li><li><a href=/archive.html#2015-02>February 2015</a> (3)</li></ul></li><li><a data-toggle=collapse href=#archive-year-2014>2014</a> (12)<ul id=archive-year-2014 class=collapse><li><a href=/archive.html#2014-11>November 2014</a> (2)</li><li><a href=/archive.html#2014-05>May 2014</a> (3)</li><li><a href=/archive.html#2014-03>March 2014</a> (1)</li><li><a href=/archive.html#2014-02>February 2014</a> (3)</li><li><a href=/archive.html#2014-01>January 2014</a> (3)</li></ul></li><li><a data-toggle=collapse href=#archive-year-2013>2013</a> (62)<ul id=archive-year-2013 class=collapse><li><a href=/archive.html#2013-12>December 2013</a> (7)</li><li><a href=/archive.html#2013-11>November 2013</a> (7)</li><li><a href=/archive.html#2013-10>October 2013</a> (7)</li><li><a href=/archive.html#2013-09>September 2013</a> (13)</li><li><a href=/archive.html#2013-08>August 2013</a> (9)</li><li><a href=/archive.html#2013-07>July 2013</a> (10)</li><li><a href=/archive.html#2013-06>June 2013</a> (9)</li></ul></li><li><a data-toggle=collapse href=#archive-year-2012>2012</a> (29)<ul id=archive-year-2012 class=collapse><li><a href=/archive.html#2012-10>October 2012</a> (1)</li><li><a href=/archive.html#2012-09>September 2012</a> (1)</li><li><a href=/archive.html#2012-08>August 2012</a> (3)</li><li><a href=/archive.html#2012-07>July 2012</a> (2)</li><li><a href=/archive.html#2012-06>June 2012</a> (2)</li><li><a href=/archive.html#2012-05>May 2012</a> (3)</li><li><a href=/archive.html#2012-04>April 2012</a> (1)</li><li><a href=/archive.html#2012-03>March 2012</a> (1)</li><li><a href=/archive.html#2012-02>February 2012</a> (10)</li><li><a href=/archive.html#2012-01>January 2012</a> (5)</li></ul></li><li><a data-toggle=collapse href=#archive-year-2011>2011</a> (60)<ul id=archive-year-2011 class=collapse><li><a href=/archive.html#2011-12>December 2011</a> (4)</li><li><a href=/archive.html#2011-11>November 2011</a> (4)</li><li><a href=/archive.html#2011-10>October 2011</a> (5)</li><li><a href=/archive.html#2011-09>September 2011</a> (11)</li><li><a href=/archive.html#2011-08>August 2011</a> (6)</li><li><a href=/archive.html#2011-07>July 2011</a> (4)</li><li><a href=/archive.html#2011-06>June 2011</a> (6)</li><li><a href=/archive.html#2011-05>May 2011</a> (6)</li><li><a href=/archive.html#2011-04>April 2011</a> (5)</li><li><a href=/archive.html#2011-03>March 2011</a> (2)</li><li><a href=/archive.html#2011-01>January 2011</a> (7)</li></ul></li><li><a data-toggle=collapse href=#archive-year-2010>2010</a> (26)<ul id=archive-year-2010 class=collapse><li><a href=/archive.html#2010-12>December 2010</a> (7)</li><li><a href=/archive.html#2010-09>September 2010</a> (1)</li><li><a href=/archive.html#2010-07>July 2010</a> (1)</li><li><a href=/archive.html#2010-06>June 2010</a> (2)</li><li><a href=/archive.html#2010-05>May 2010</a> (5)</li><li><a href=/archive.html#2010-04>April 2010</a> (5)</li><li><a href=/archive.html#2010-03>March 2010</a> (3)</li><li><a href=/archive.html#2010-01>January 2010</a> (2)</li></ul></li><li><a data-toggle=collapse href=#archive-year-2009>2009</a> (31)<ul id=archive-year-2009 class=collapse><li><a href=/archive.html#2009-10>October 2009</a> (1)</li><li><a href=/archive.html#2009-09>September 2009</a> (1)</li><li><a href=/archive.html#2009-08>August 2009</a> (3)</li><li><a href=/archive.html#2009-07>July 2009</a> (2)</li><li><a href=/archive.html#2009-06>June 2009</a> (4)</li><li><a href=/archive.html#2009-05>May 2009</a> (6)</li><li><a href=/archive.html#2009-04>April 2009</a> (2)</li><li><a href=/archive.html#2009-03>March 2009</a> (4)</li><li><a href=/archive.html#2009-01>January 2009</a> (8)</li></ul></li><li><a data-toggle=collapse href=#archive-year-2008>2008</a> (61)<ul id=archive-year-2008 class=collapse><li><a href=/archive.html#2008-12>December 2008</a> (1)</li><li><a href=/archive.html#2008-11>November 2008</a> (4)</li><li><a href=/archive.html#2008-10>October 2008</a> (6)</li><li><a href=/archive.html#2008-09>September 2008</a> (1)</li><li><a href=/archive.html#2008-08>August 2008</a> (6)</li><li><a href=/archive.html#2008-07>July 2008</a> (14)</li><li><a href=/archive.html#2008-06>June 2008</a> (3)</li><li><a href=/archive.html#2008-05>May 2008</a> (1)</li><li><a href=/archive.html#2008-04>April 2008</a> (3)</li><li><a href=/archive.html#2008-03>March 2008</a> (3)</li><li><a href=/archive.html#2008-02>February 2008</a> (9)</li><li><a href=/archive.html#2008-01>January 2008</a> (10)</li></ul></li><li><a data-toggle=collapse href=#archive-year-2007>2007</a> (86)<ul id=archive-year-2007 class=collapse><li><a href=/archive.html#2007-12>December 2007</a> (4)</li><li><a href=/archive.html#2007-11>November 2007</a> (7)</li><li><a href=/archive.html#2007-10>October 2007</a> (2)</li><li><a href=/archive.html#2007-09>September 2007</a> (8)</li><li><a href=/archive.html#2007-08>August 2007</a> (6)</li><li><a href=/archive.html#2007-07>July 2007</a> (15)</li><li><a href=/archive.html#2007-06>June 2007</a> (15)</li><li><a href=/archive.html#2007-05>May 2007</a> (4)</li><li><a href=/archive.html#2007-04>April 2007</a> (10)</li><li><a href=/archive.html#2007-03>March 2007</a> (8)</li><li><a href=/archive.html#2007-02>February 2007</a> (1)</li><li><a href=/archive.html#2007-01>January 2007</a> (6)</li></ul></li><li><a data-toggle=collapse href=#archive-year-2006>2006</a> (103)<ul id=archive-year-2006 class=collapse><li><a href=/archive.html#2006-12>December 2006</a> (4)</li><li><a href=/archive.html#2006-11>November 2006</a> (3)</li><li><a href=/archive.html#2006-10>October 2006</a> (7)</li><li><a href=/archive.html#2006-09>September 2006</a> (6)</li><li><a href=/archive.html#2006-08>August 2006</a> (13)</li><li><a href=/archive.html#2006-07>July 2006</a> (4)</li><li><a href=/archive.html#2006-06>June 2006</a> (13)</li><li><a href=/archive.html#2006-05>May 2006</a> (7)</li><li><a href=/archive.html#2006-04>April 2006</a> (9)</li><li><a href=/archive.html#2006-03>March 2006</a> (6)</li><li><a href=/archive.html#2006-02>February 2006</a> (13)</li><li><a href=/archive.html#2006-01>January 2006</a> (18)</li></ul></li><li><a data-toggle=collapse href=#archive-year-2005>2005</a> (129)<ul id=archive-year-2005 class=collapse><li><a href=/archive.html#2005-12>December 2005</a> (9)</li><li><a href=/archive.html#2005-11>November 2005</a> (7)</li><li><a href=/archive.html#2005-10>October 2005</a> (23)</li><li><a href=/archive.html#2005-09>September 2005</a> (10)</li><li><a href=/archive.html#2005-08>August 2005</a> (14)</li><li><a href=/archive.html#2005-07>July 2005</a> (5)</li><li><a href=/archive.html#2005-06>June 2005</a> (12)</li><li><a href=/archive.html#2005-05>May 2005</a> (6)</li><li><a href=/archive.html#2005-04>April 2005</a> (6)</li><li><a href=/archive.html#2005-03>March 2005</a> (13)</li><li><a href=/archive.html#2005-02>February 2005</a> (11)</li><li><a href=/archive.html#2005-01>January 2005</a> (13)</li></ul></li><li><a data-toggle=collapse href=#archive-year-2004>2004</a> (84)<ul id=archive-year-2004 class=collapse><li><a href=/archive.html#2004-12>December 2004</a> (9)</li><li><a href=/archive.html#2004-11>November 2004</a> (6)</li><li><a href=/archive.html#2004-10>October 2004</a> (11)</li><li><a href=/archive.html#2004-09>September 2004</a> (19)</li><li><a href=/archive.html#2004-07>July 2004</a> (29)</li><li><a href=/archive.html#2004-06>June 2004</a> (10)</li></ul></li></ul></div></div></div></div></div><footer class=container><div class=row><div class="col-4 order-2 texr-right"><p class=float-right><a href=#>Back to top</a></p></div><div class="col-8 order-1 mr-auto"><p>Copyright 2004&ndash;2023 Julio Merino</p></div></div></footer><script type=module>
  import { addAnchorsToHeaders, addElementClasses, BatchClient } from "\/js\/main.d30f168b11d80082408f4a983af9a626c6e57d58f7846b2174bac40d43be33e3.js";

  var batchClient = new BatchClient(SITE_ID);
  batchClient.doAll({
    put_request: true, get_comments: true, get_subscriber_count: true, get_votes: true });

  window.voteThumbsUp = function() { batchClient.voteThumbsUp(); }
  window.voteThumbsDown = function() { batchClient.voteThumbsDown(); }

  window.postComment = function(...args) {
    batchClient.postComment(...args);
  };

  addAnchorsToHeaders();
  addElementClasses();
</script><noscript><img src="https://hugo-dynamic.jmmv.dev/api/sites/e8da9f62-b7ac-4fe9-bf20-7c527199a376/pages/aHR0cHM6Ly9qbW12LmRldi8yMDIzLzA3L3VuaXQtdGVzdGluZy1hLXdlYi1zZXJ2aWNlLmh0bWw=/stamp.gif" style=display:none></noscript></body></html>