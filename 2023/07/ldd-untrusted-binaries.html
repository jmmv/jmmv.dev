<!doctype html><html lang=en xmlns=http://www.w3.org/1999/xhtml xmlns:fb=http://ogp.me/ns/fb#><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta property="og:site_name" content="Julio Merino (jmmv.dev)"><meta property="twitter:site" content="@jmmv"><title>ldd(1) and untrusted binaries - Julio Merino (jmmv.dev)</title><meta property="og:title" content="ldd(1) and untrusted binaries - Julio Merino (jmmv.dev)"><meta property="twitter:title" content="ldd(1) and untrusted binaries - Julio Merino (jmmv.dev)"><meta name=description content="While diagnosing a non-determinism Bazel issue at work, I had to compare the dynamic libraries used by two builds of the same binary. To do so, I used ldd(1) and I had to refer to its manual page to understand details of the output I had never paid attention to before. What I saw will surprise you: ldd can end up running the binary given to it, thus making it unsafe against untrusted binaries. Read on for the history I could find around this issue and what alternatives you have."><meta property="og:description" content="While diagnosing a non-determinism Bazel issue at work, I had to compare the dynamic libraries used by two builds of the same binary. To do so, I used ldd(1) and I had to refer to its manual page to understand details of the output I had never paid attention to before. What I saw will surprise you: ldd can end up running the binary given to it, thus making it unsafe against untrusted binaries. Read on for the history I could find around this issue and what alternatives you have."><meta property="twitter:description" content="While diagnosing a non-determinism Bazel issue at work, I had to compare the dynamic libraries used by two builds of the same binary. To do so, I used ldd(1) and I had to refer to its manual page to …"><meta name=author content="Julio Merino"><meta property="twitter:creator" content="@jmmv"><meta name=generator content="Hugo 0.111.3"><meta property="og:url" content="https://jmmv.dev/2023/07/ldd-untrusted-binaries.html"><meta property="og:type" content="blog"><meta property="twitter:card" content="summary"><link rel=canonical href=https://jmmv.dev/2023/07/ldd-untrusted-binaries.html><link rel=alternate type=application/rss+xml title="Julio Merino (jmmv.dev)" href=/feed.xml><link rel=stylesheet href=/sass/main.min.161663676cac4bf21abc8967ec3267c26026aa58e9f392c5f3427e0ef089fe6b.css><link rel=stylesheet href=/css/chroma.css><link rel=icon type=image/png href=/images/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/images/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicons/favicon-96x96.png sizes=96x96><meta property="og:image" content="/images/favicons/favicon-1200x1200.png"><meta property="twitter:image" content="https://jmmv.dev/images/favicons/favicon-1200x1200.png"><script>const SITE_ID="e8da9f62-b7ac-4fe9-bf20-7c527199a376",BASE_URL="https://jmmv.dev/"</script></head><body><header class=site-header><nav class="navbar navbar-expand-lg fixed-top navbar-dark bg-primary"><a class=navbar-brand href=/><img src=/images/favicons/favicon-30x30.png width=30 height=30 class="d-inline-block align-top" alt>
&nbsp;Julio Merino</a>
<button class=navbar-toggler type=button data-toggle=collapse data-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarSupportedContent><ul class="navbar-nav mr-auto"><li class=nav-item><a class=nav-link href=/about.html>About</a></li><li class=nav-item><a class=nav-link href=/essays.html>Essays</a></li><li class=nav-item><a class=nav-link href=/resume.html>Resume</a></li><li class=nav-item><a class=nav-link href=/software.html>Software</a></li></ul><ul class="navbar-nav mr-4"><li class=nav-item><a class=nav-link href=/archive.html>Archive</a></li><li class=nav-item><a class=nav-link href=/series.html>Series</a></li><li class=nav-item><a class=nav-link href=/tags.html>Tags</a></li></ul><form class=form-inline method=get role=search action=https://www.google.com/search><div class=input-group><input type=search name=query class=form-control placeholder=Search aria-label=Search><div class=input-group-append><button type=submit value=Search class="btn btn-light">
<img src=/octicons/search.svg></button></div></div><input type=hidden name=sitesearch value=https://jmmv.dev/></form></div></nav></header><div class=page-header><div class=container><h1>ldd(1) and untrusted binaries</h1><p>July 1, 2023 &#183;
About 6 minutes
&#183;
Tags:
<a href=/tags/linux>linux</a>, <a href=/tags/security>security</a></p></div></div><div class="container post-body"><div class=row><div class=col-md-9><div class=row><div class=col><article><p>While diagnosing a non-determinism Bazel issue at work, I had to compare the dynamic libraries used by two builds of the same binary. To do so, I used <code>ldd(1)</code>. The list of libraries printed by the tool was the same between the two builds, but the numbers next to them were different. Which numbers, you ask? Well, take a look at this sample output:</p><pre tabindex=0><code>$ ldd /bin/ls
	linux-vdso.so.1 (0x00007fff5bbed000)
	libselinux.so.1 =&gt; /lib64/libselinux.so.1 (0x00007f7786f48000)
	libcap.so.2 =&gt; /lib64/libcap.so.2 (0x00007f7786f3e000)
	libc.so.6 =&gt; /lib64/libc.so.6 (0x00007f7786d60000)
	libpcre2-8.so.0 =&gt; /lib64/libpcre2-8.so.0 (0x00007f7786cc6000)
	/lib64/ld-linux-x86-64.so.2 (0x00007f7786fad000)
</code></pre><p>Without prior knowledge, the numbers next to each library seemed to be the base addresses of the libraries once loaded into memory, and they probably differed across builds because of <a href=https://en.wikipedia.org/wiki/Address_space_layout_randomization>ASLR</a>. If this was true, it meant that the differences were irrelevant from a build determinism perspective, but I had to confirm this claim because I had never given these numbers a second thought.</p><div class="container action-highlight p-4 my-4 d-md-none"><div class="row text-center"><p>A blog on operating systems, programming languages, testing, build systems, my own software
projects and even personal productivity. Specifics include FreeBSD, Linux, Rust, Bazel and
EndBASIC.</p></div><div class=row><div class=col><div class=form-group><form action=https://endtracker.azurewebsites.net/api/sites/e8da9f62-b7ac-4fe9-bf20-7c527199a376/subscribers/add method=post><input type=text name=email placeholder="Enter your email" class="form-control input-sm text-center my-1">
<button type=submit class="btn btn-primary btn-block my-1">Subscribe</button></form></div></div></div><div class="row px-2"><div class="col col-sm-5 text-left"><small><span class=subscriber-count>0</span> subscribers</small></div><div class="col col-sm-7 text-right"><p><a rel=me href=https://mastodon.online/@jmmv><img src=/images/badges/mastodon-logo.svg width=32px height=32px alt="Follow @jmmv on Mastodon"></a>
<a href="https://twitter.com/intent/follow?original_referer=https%3A%2F%2Fjmmv.dev%2F&amp;screen_name=jmmv"><img src=/images/badges/Twitter_logo_blue.svg width=32px height=32px alt="Follow @jmmv on Twitter"></a>
<a href=/feed.xml><img src=/images/badges/feed-icon-28x28.png alt="RSS feed"></a></p></div></div></div><p>To answer the question, I did what one should always do: read the official documentation. I typed <code>man ldd</code> and was greeted by the following on the CentOS 7 machine I was working on:</p><figure><img src=/images/2023-07-01-ldd-manpage.png width=100%><figcaption>Screenshot of the beginning of the <tt>ldd(1)</tt> manual page on CentOS 7 with the following text highlighted by me: "<i>Be aware, however, that in some circumestances, some versions of <tt>ldd</tt> may attempt to obtain the dependency information by directly executing the program. Thus, you should <b>never</b> employ <tt>ldd</tt> on an untrusted executable</i>."</figcaption></figure><p>Wait, what? Under some circumstances (which ones?) and with some versions of <code>ldd</code> (which ones again?<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>), <code>ldd</code> may <em>execute</em> the given binary to determine the libraries it uses. Which means that running <code>ldd</code> on an untrusted binary could compromise your system. The manual page goes on to say that you should never run <code>ldd</code> against untrusted binaries.</p><p>Needless to say, this was really surprising to see. Why would <code>ldd</code> execute <em>anything</em> to print details about a file? I quickly posted this on <a href=https://twitter.com/jmmv/status/1674889696294621184>Twitter</a> and <a href=https://mastodon.online/@jmmv/110635380384812322>Mastodon</a>, and the higher-than-usual engagement made me think that many more people than I weren&rsquo;t aware of this behavior&mldr; so I had to investigate a bit more.</p><hr><p>This behavior was originally reported as a security vulnerability in <a href=https://www.cvedetails.com/cve/CVE-2009-5064/>CVE-2009-5064</a> and the report was closed with the rationale: <em>&ldquo;not a security vulnerability because <code>ldd</code> must not be run on untrusted binaries&rdquo;</em>. While this may be literally true, I find the answer quite dismissive: how does one <em>know</em> that, say, <code>readelf</code> or <code>objdump</code> can be run against untrusted binaries but <code>ldd</code> cannot? When giving a file to a tool, the common expectation is that the tool will read and parse the file<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>, not <em>run</em> it. This violates the <a href=https://en.wikipedia.org/wiki/Principle_of_least_astonishment>Principle of least astonishment (POLA)</a>, for me at least.</p><p>Even though upstream did not agree to the security vulnerability report, various people thought there was a real problem, so some Linux distributions <em>did</em> patch <code>ldd</code> to not execute binaries directly. I do not have access to an old-enough unpatched Linux system to verify this surprising behavior, but there is a trivial repro in the <a href=https://www.openwall.com/lists/oss-security/2011/03/07/13>&ldquo;ldd can execute an app unexpectedly&rdquo;</a> email thread along with a simple fix.</p><p>And if my reading is correct, this surprising behavior was removed from the upstream sources back in 2017 (eight years after the original report) in commit <a href="https://sourceware.org/git/?p=glibc.git;a=commit;h=eedca9772e99c72ab4c3c34e43cc764250aa3e3c"><code>eedca9772e</code></a>. It&rsquo;s quite hard to tell if this change was addressing the reported security issue because the commit has no written rationale nor reference to the CVE. Which makes the whole thing feel worse: what I sense is a security-fix-in-disguise begrudgingly accepted after many years of saying this was not a problem&mldr; which is never great. But that&rsquo;s just my read of the whole thing and I&rsquo;m probably wrong.</p><p>In any case, even if <em>this</em> particular issue is fixed, <strong>it is still unsafe to run <code>ldd</code> against untrusted binaries</strong>. <code>ldd</code> uses the dynamic linker to <em>load</em> the binary and its dependencies into memory, and then relies on the dynamic linker itself to print details to the console. And because of this, this process can be abused in other working-as-intended ways to trigger code injection as explained in <a href=https://www.cvedetails.com/cve/CVE-2019-1010023>CVE-2019-1010023</a>. All of these require social engineering though&mldr; but we all know that humans are often the weakest link in security.</p><hr><p>So why does <code>ldd</code> look so problematic anyway? Let&rsquo;s look at the internals of this tool.</p><p>My first surprise was to see that, on Linux, <code>ldd</code> is a shell script<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>&mdash;and a very simple one at that. Poking through <a href="https://sourceware.org/git/?p=glibc.git;a=blob;f=elf/ldd.bash.in;h=e45dec5894fe561585da01ea64b651663128e8d5;hb=HEAD">the contents of <code>/usr/bin/ldd</code></a>, you&rsquo;ll notice that all this script does is pass the given binary to a collection of built-in dynamic linkers (stored in <code>RTLDLIST</code>) and, once it finds a dynamic linker that can process the binary, it runs the linker against the binary with the <code>LD_TRACE_LOADED_OBJECTS=1</code> setting. The linker then lays out the binary inside a new process along <em>all</em> the direct and indirect libraries it requires, dumps information to the console, and exits.</p><p>We can do the same by hand:</p><pre tabindex=0><code>$ /lib64/ld-linux-x86-64.so.2 --verify /bin/ls &amp;&amp; echo &#39;Supported!&#39;
Supported!

$ LD_TRACE_LOADED_OBJECTS=1 /lib64/ld-linux-x86-64.so.2 /bin/ls
	linux-vdso.so.1 (0x00007ffd28dc4000)
	libselinux.so.1 =&gt; /lib64/libselinux.so.1 (0x00007feb357d8000)
	libcap.so.2 =&gt; /lib64/libcap.so.2 (0x00007feb357ce000)
	libc.so.6 =&gt; /lib64/libc.so.6 (0x00007feb355f0000)
	libpcre2-8.so.0 =&gt; /lib64/libpcre2-8.so.0 (0x00007feb35556000)
	/lib64/ld-linux-x86-64.so.2 (0x00007feb3583d000)
</code></pre><p>Voila! We get the exact same output that <code>ldd</code> would produce modulo differences in the addresses across different executions.</p><hr><p>I&rsquo;ll probably continue to use <code>ldd</code> because it is very convenient and I rarely face situations where I have to analyze untrusted binaries. But if those situations ever arise, here are some alternatives:</p><ul><li><a href=https://github.com/haampie/libtree><code>libtree the-binary</code></a>, which displays the direct and indirect libraries required by a binary as a tree.</li><li><code>objdump -p the-binary | grep NEEDED</code>, which is the solution provided in the <code>ldd(1)</code> manual page I quoted earlier but is not equivalent to <code>ldd</code> because it can only handle direct dependencies.</li><li><code>readelf -d the-binary | grep NEEDED</code>, which is a similar solution to the previous one with the same caveats.</li></ul><p>Before parting, the question I have is: why doesn&rsquo;t <code>ldd</code> walk the library tree by inspecting ELF headers instead of loading the libraries into a process? The answer might be in the name: I&rsquo;m guessing that <code>ldd</code> stands for &ldquo;<code>ld</code> dump&rdquo; and thus it is <em>supposed</em> to run the dynamic linker.</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>This type of unspecific language is what you get when the manual pages are written by a different set of people than those that write the code and when the manual pages are shipped separately from the tools they document. Thanks Linux. This type of nonsense does not happen on the BSDs.&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p>There is always the risk that the parser has bugs that can be exploited by a malicious file, resulting in untrusted code execution, but that&rsquo;s a different class of issue than &ldquo;let&rsquo;s just run the binary!&rdquo;.&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p>This might help explain my long-standing question on why macOS does not ship with <code>ldd</code> and why I always had to use <code>otool</code>.&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></article></div></div><div class="container post-links"><div class=row><div class="col mr-auto text-left"><span><a href=https://jmmv.dev/2023/06/fast-machines-slow-machines.html>&#171; Previous</a></span></div><div class="col text-center"><span><a href=/archive.html>All posts</a></span></div><div class="col ml-auto text-right"><span><a href=https://jmmv.dev/2023/07/unit-testing-a-web-service.html>Next &#187;</a></span></div></div></div><div class="container post-votes"><div class=row><div class="col-lg-4 my-2"><div class=row><div class=col><a onclick=voteThumbsUp() class="btn btn-block btn-outline-success" id=thumbs-up-btn>👍
(<span id=thumbs-up-count>0</span>)</a></div><div class=col><a onclick=voteThumbsDown() class="btn btn-block btn-outline-danger" id=thumbs-down-btn>👎
(<span id=thumbs-down-count>0</span>)</a></div></div></div><div class="col-lg-8 my-2 d-none d-sm-block"><div class=row><div class="col-md-4 text-center"><a href="https://www.reddit.com/submit?title=ldd%281%29+and+untrusted+binaries&amp;url=https%3A%2F%2Fjmmv.dev%2F2023%2F07%2Fldd-untrusted-binaries.html" class="btn btn-block btn-outline-primary">Share on
<img src=/images/badges/reddit.png alt=Reddit width=24 height=24></a></div><div class="col-md-4 text-center"><a href="https://news.ycombinator.com/submitlink?t=ldd%281%29+and+untrusted+binaries&amp;u=https%3A%2F%2Fjmmv.dev%2F2023%2F07%2Fldd-untrusted-binaries.html" class="btn btn-block btn-outline-primary">Share on
<img src=/images/badges/ycombinator.png alt="Hacker News" width=24 height=24></a></div><div class="col-md-4 text-center"><a href=https://twitter.com/jmmv/status/1674889696294621184 class="btn btn-block btn-outline-primary">Go to
<img src=/images/badges/Twitter_Social_Icon_Circle_Color.png alt=Twitter width=24 height=24></a></div></div></div></div><div class="row my-4" id=postCommentRow><div class=col><div class=media><img class=mr-3 src=/octicons/pencil.svg width=32px height=32px><div class="media-body container"><form method=post id=newPost><div class=row><div class="col my-1"><textarea class=form-control rows=1 id=postCommentContent onclick=showPostComment() placeholder="Leave a comment"></textarea></div></div><div class="row newPostControls" style=display:none><div class="col my-1 form-group"><label for=postCommentAuthor>Your name (optional):</label>
<input type=text class=form-control id=postCommentAuthor></div></div><div class="row newPostControls" style=display:none><div class="col my-1 form-group"><label for=postCommentEmail>Your email (optional):</label>
<input type=text class=form-control type=email id=postCommentEmail>
<small class="form-text text-muted">Invisible to all readers; if provided, you will receive notifications when replied to (not implemented yet)</small></div></div><div class=row id=postCommentError style=display:none><div class="col mt-1 alert-danger"><p></p></div></div><div class="row newPostControls" style=display:none><button class="col-md-3 my-1 btn btn-primary" type=submit id=submitCommentButton>Post</button>
<small class="col-md-9 my-1 text-muted">Comments are subject to moderation. This feature is experimental and is powered by <a href=/software/endtracker.html>EndTRACKER</a>. If you experience any issues, please <a href=/about.html#contact>contact me off-band</a>.</small></div></form></div></div></div></div><script>function hidePostComment(){var t,e=document.getElementById("postCommentContent");e.rows=1,e.value="",t=document.getElementsByClassName("newPostControls"),Array.prototype.forEach.call(t,function(e){e.style.display="none"})}function showPostComment(){var e,t=document.getElementById("postCommentContent");t.rows=5,e=document.getElementsByClassName("newPostControls"),Array.prototype.forEach.call(e,function(e){e.style.display=""})}const form=document.querySelector("#newPost");form.onsubmit=function(e){e.preventDefault();let t=document.getElementById("postCommentAuthor").value,n=document.getElementById("postCommentEmail").value,s=document.getElementById("postCommentContent").value;postComment(t,n,s,hidePostComment)}</script></div></div><div class="col-md-3 sidebar d-none d-md-block"><div class=row><div class="col text-center p-2"><p><a href=/about.html class=clear-link><img src=/images/avatars/20181124-snow.jpg class="rounded-circle shadow my-2" style=width:100px><br><b>Julio Merino</b><br>A blog on operating systems, programming languages, testing, build systems, my own software
projects and even personal productivity. Specifics include FreeBSD, Linux, Rust, Bazel and
EndBASIC.</a></p><div class=row><div class=col><div class=form-group><form action=https://endtracker.azurewebsites.net/api/sites/e8da9f62-b7ac-4fe9-bf20-7c527199a376/subscribers/add method=post><input type=text name=email placeholder="Enter your email" class="form-control input-sm text-center my-1">
<button type=submit class="btn btn-primary btn-block my-1">Subscribe</button></form></div></div></div><div class="row px-2"><div class="col-sm-5 text-left"><small><span class=subscriber-count>0</span> subscribers</small></div><div class="col-sm-7 text-right"><p><a rel=me href=https://mastodon.online/@jmmv><img src=/images/badges/mastodon-logo.svg width=32px height=32px alt="Follow @jmmv on Mastodon"></a>
<a href="https://twitter.com/intent/follow?original_referer=https%3A%2F%2Fjmmv.dev%2F&amp;screen_name=jmmv"><img src=/images/badges/Twitter_logo_blue.svg width=32px height=32px alt="Follow @jmmv on Twitter"></a>
<a href=/feed.xml><img src=/images/badges/feed-icon-28x28.png alt="RSS feed"></a></p></div></div></div></div><div class=row><div class=col><h2>Featured software</h2><ul><li class=overflow-ellipsis><a href=https://www.endbasic.dev/ target=_blank>EndBASIC: Online BASIC+DOS env</a></li><li class=overflow-ellipsis><a href=https://endtracker.azurewebsites.net/ target=_blank>EndTRACKER: Services for static sites</a></li></ul></div></div><div class=row><div class=col><h2>Featured posts</h2><ul><li class=overflow-ellipsis><a href=/2023/06/fast-machines-slow-machines.html>Fast machines, slow machines</a></li><li class=overflow-ellipsis><a href=/2022/12/endbasic-0.10.html>EndBASIC 0.10: Core language, evolved</a></li><li class=overflow-ellipsis><a href=/2022/10/bye-microsoft-hi-snowflake.html>Farewell, Microsoft; hello, Snowflake!</a></li><li class=overflow-ellipsis><a href=/2022/05/rust-is-hard-but-does-it-matter.html>Rust is hard, yes, but does it matter?</a></li><li class=overflow-ellipsis><a href=/2022/04/rust-traits-and-dependency-injection.html>Rust traits and dependency injection</a></li><li class=overflow-ellipsis><a href=/2022/03/a-year-on-windows-intro.html>A year on Windows: Introduction</a></li><li class=overflow-ellipsis><a href=/2021/04/always-be-quitting.html>Always be quitting</a></li><li class=overflow-ellipsis><a href=/2021/02/google-monorepos-and-caching.html>How does Google keep build times low?</a></li><li class=overflow-ellipsis><a href=/2020/12/google-no-clean-builds.html>How does Google avoid clean builds?</a></li><li class=overflow-ellipsis><a href=/2020/12/unit-testing-a-console-app.html>Unit-testing a console app (a text editor)</a></li><li class=overflow-ellipsis><a href=/essays.html#featured>More...</a></li></ul></div></div></div></div></div><footer class=container><div class=row><div class="col-4 order-2 texr-right"><p class=float-right><a href=#>Back to top</a></p></div><div class="col-8 order-1 mr-auto"><p>Copyright 2004&ndash;2023 Julio Merino</p></div></div></footer><script type=module>
  import { addAnchorsToHeaders, addElementClasses, BatchClient } from "\/js\/main.d30f168b11d80082408f4a983af9a626c6e57d58f7846b2174bac40d43be33e3.js";

  var batchClient = new BatchClient(SITE_ID);
  batchClient.doAll({
    put_request: true, get_comments: true, get_subscriber_count: true, get_votes: true });

  window.voteThumbsUp = function() { batchClient.voteThumbsUp(); }
  window.voteThumbsDown = function() { batchClient.voteThumbsDown(); }

  window.postComment = function(...args) {
    batchClient.postComment(...args);
  };

  addAnchorsToHeaders();
  addElementClasses();
</script><noscript><img src="https://hugo-dynamic.jmmv.dev/api/sites/e8da9f62-b7ac-4fe9-bf20-7c527199a376/pages/aHR0cHM6Ly9qbW12LmRldi8yMDIzLzA3L2xkZC11bnRydXN0ZWQtYmluYXJpZXMuaHRtbA==/stamp.gif" style=display:none></noscript></body></html>