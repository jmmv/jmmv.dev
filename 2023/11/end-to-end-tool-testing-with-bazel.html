<!doctype html><html lang=en xmlns=http://www.w3.org/1999/xhtml xmlns:fb=http://ogp.me/ns/fb#><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta property="og:site_name" content="Julio Merino (jmmv.dev)"><meta property="twitter:site" content="@jmmv"><title>End-to-end tool testing with Bazel and shtk - Julio Merino (jmmv.dev)</title><meta property="og:title" content="End-to-end tool testing with Bazel and shtk - Julio Merino (jmmv.dev)"><meta property="twitter:title" content="End-to-end tool testing with Bazel and shtk - Julio Merino (jmmv.dev)"><meta name=description content="If you use Bazel, your project is of moderate size. And because your project is of moderate size, it almost-certainly builds one or more binaries, at least one of which is a CLI tool. But let&amp;rsquo;s face it: you don&amp;rsquo;t have end-to-end testing for those tools, do you?
I&amp;rsquo;m sure you have split the binary&amp;rsquo;s main function into its own file so that the rest of the tool can be put in a library, and I&amp;rsquo;m extra-sure that you have unit tests for such library. But&amp;hellip; those tests do little to verify the functionality and quality of the tool as experienced by the end user. Consider: What exactly does the tool print to the console on success? Does it show errors nicely when they happen, or does it dump internal stack traces? How does it handle unknown flags or bad arguments? Is the built-in help message nicely rendered when your terminal is really wide? What if the terminal is narrow?
You must write end-to-end tests for your tools but, usually, that isn’t easy to do. Until today. Combining shtk with Bazel via the new rules_shtk ruleset makes it trivial to write tests that verify the behavior of your CLI tools&amp;mdash;no matter what language they are written in&amp;mdash;and in this article I’m going to show you how.
"><meta property="og:description" content="If you use Bazel, your project is of moderate size. And because your project is of moderate size, it almost-certainly builds one or more binaries, at least one of which is a CLI tool. But let&amp;rsquo;s face it: you don&amp;rsquo;t have end-to-end testing for those tools, do you?
I&amp;rsquo;m sure you have split the binary&amp;rsquo;s main function into its own file so that the rest of the tool can be put in a library, and I&amp;rsquo;m extra-sure that you have unit tests for such library. But&amp;hellip; those tests do little to verify the functionality and quality of the tool as experienced by the end user. Consider: What exactly does the tool print to the console on success? Does it show errors nicely when they happen, or does it dump internal stack traces? How does it handle unknown flags or bad arguments? Is the built-in help message nicely rendered when your terminal is really wide? What if the terminal is narrow?
You must write end-to-end tests for your tools but, usually, that isn’t easy to do. Until today. Combining shtk with Bazel via the new rules_shtk ruleset makes it trivial to write tests that verify the behavior of your CLI tools&amp;mdash;no matter what language they are written in&amp;mdash;and in this article I’m going to show you how.
"><meta property="twitter:description" content="If you use Bazel, your project is of moderate size. And because your project is of moderate size, it almost-certainly builds one or more binaries, at least one of which is a CLI tool. But let&amp;rsquo;s …"><meta name=author content="Julio Merino"><meta property="twitter:creator" content="@jmmv"><meta name=generator content="Hugo 0.111.3"><meta property="og:url" content="https://jmmv.dev/2023/11/end-to-end-tool-testing-with-bazel.html"><meta property="og:type" content="blog"><meta property="twitter:card" content="summary"><link rel=canonical href=https://jmmv.dev/2023/11/end-to-end-tool-testing-with-bazel.html><link rel=alternate type=application/rss+xml title="Julio Merino (jmmv.dev)" href=/feed.xml><link rel=stylesheet href=/sass/main.min.cb91349cd93211a37e7d5dc131c35a170fc795721c03373cd05571327eea206b.css><link rel=stylesheet href=/css/chroma.css><link rel=icon type=image/png href=/images/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/images/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicons/favicon-96x96.png sizes=96x96><meta property="og:image" content="/images/2023-11-04-bazel-clamp.jpg"><meta property="twitter:image" content="https://jmmv.dev/images/2023-11-04-bazel-clamp.jpg"><meta property="og:image:alt" content="Bazel logo held by a clamp."><meta property="twitter:image:alt" content="Bazel logo held by a clamp."><script>const SITE_ID="e8da9f62-b7ac-4fe9-bf20-7c527199a376",BASE_URL="https://jmmv.dev/"</script></head><body><img src="https://hugo-dynamic.jmmv.dev/api/sites/e8da9f62-b7ac-4fe9-bf20-7c527199a376/pages/aHR0cHM6Ly9qbW12LmRldi8yMDIzLzExL2VuZC10by1lbmQtdG9vbC10ZXN0aW5nLXdpdGgtYmF6ZWwuaHRtbA==/stamp.gif" style=display:none>
<script>window.location.replace("https://blogsystem5.substack.com/p/end-to-end-tool-testing-with-bazel")</script><header class=site-header><nav class="navbar navbar-expand-md fixed-top navbar-dark bg-primary"><a class=navbar-brand href=/><img src=/images/favicons/favicon-30x30.png width=30 height=30 class="d-inline-block align-top" alt>
&nbsp;jmmv.dev</a>
<button class=navbar-toggler type=button data-toggle=collapse data-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarSupportedContent><ul class="navbar-nav mr-auto"><li class=nav-item><a class=nav-link href=/about.html>About</a></li><li class=nav-item><a class=nav-link href=/blog.html>Blog</a></li><li class=nav-item><a class=nav-link href=/resume.html>Resume</a></li><li class=nav-item><a class=nav-link href=/software.html>Software</a></li></ul><ul class="navbar-nav mr-4"><li class=nav-item><a class=nav-link href=/archive.html>Archive</a></li><li class=nav-item><a class=nav-link href=/series.html>Series</a></li><li class=nav-item><a class=nav-link href=/tags.html>Tags</a></li></ul><form class=form-inline method=get role=search action=https://www.google.com/search><div class=input-group><input type=search name=query class=form-control placeholder=Search aria-label=Search><div class=input-group-append><button type=submit value=Search class="btn btn-light">
<img src=/octicons/search.svg></button></div></div><input type=hidden name=sitesearch value=https://jmmv.dev/></form></div></nav></header><div class=page-header><div class=container><h1>End-to-end tool testing with Bazel and shtk</h1><p>November 4, 2023 &#183;
About 7 minutes
&#183;
Tags:
<a href=/tags/bazel>bazel</a>, <a href=/tags/blogsystem5>blogsystem5</a>, <a href=/tags/shell>shell</a>, <a href=/tags/shtk>shtk</a>, <a href=/tags/testing>testing</a></p><p class=post-meta-p>This article was
<a href=https://blogsystem5.substack.com/p/end-to-end-tool-testing-with-bazel>originally published
on Substack</a>
in the <a href=https://blogsystem5.substack.com/>Blog System/5 newsletter</a>
and is replicated here for archival purposes.</p><figure class=cover-image><img src=/images/2023-11-04-bazel-clamp.jpg style=max-width:100%><figcaption>Bazel logo held by a clamp.</figcaption></figure></div></div><div class="container post-body"><div class=row><div class=col-md-9><div class=row><div class=col><article><p>If you use Bazel, your project is of moderate size. And because your project is of moderate size, it almost-certainly builds one or more binaries, at least one of which is a CLI tool. But let&rsquo;s face it: you don&rsquo;t have end-to-end testing for those tools, do you?</p><p>I&rsquo;m <em>sure</em> you have split the binary&rsquo;s <code>main</code> function into its own file so that the rest of the tool can be put in a library, and I&rsquo;m <em>extra-sure</em> that you have unit tests for such library. But&mldr; those tests do little to verify the functionality and quality of the tool <em>as experienced by the end user</em>. Consider: What exactly does the tool print to the console on success? Does it show errors nicely when they happen, or does it dump internal stack traces? How does it handle unknown flags or bad arguments? Is the built-in help message nicely rendered when your terminal is really wide? What if the terminal is narrow?</p><p>You must write end-to-end tests for your tools but, usually, that isn’t easy to do. Until today. Combining shtk with Bazel via the new <code>rules_shtk</code> ruleset makes it trivial to write tests that verify the behavior of your CLI tools&mdash;no matter what language they are written in&mdash;and in this article I’m going to show you how.</p><h1 id=scenario>Scenario</h1><p>To put things in perspective, we&rsquo;ll be adding tests to a trivial demo tool written in C (<em>not</em> shell) that simply adds two numbers and prints the result to the standard output. You can find all of the code for this scenario under <a href=https://github.com/jmmv/rules_shtk/tree/d490cc9fc43cff3db83d12b5dc1a1c6b90ed50c3/examples/test><code>rules_shtk/examples/test</code></a>.</p><p>Here is how the demo tool behaves after we build the <code>//:adder</code> target:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> ./bazel-bin/adder <span class=m>123</span> <span class=m>456</span>
</span></span><span class=line><span class=cl><span class=go>The sum of 123 and 456 is 579
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=gp>$</span> ./bazel-bin/adder
</span></span><span class=line><span class=cl><span class=go>adder: Requires two integer arguments
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=gp>$</span> ./bazel-bin/adder <span class=m>10000000</span> <span class=m>345</span>
</span></span><span class=line><span class=cl><span class=go>adder: Invalid first operand: out of range
</span></span></span></code></pre></div><p>Our mission is to add an <code>//:adder_test</code> target that depends on <code>//:adder</code> and that exercises the tool <em>exactly as when a user runs it by hand</em>. We&rsquo;ll create an <code>adder_test.sh</code> file that uses the <a href=/2023/10/unit-testing-with-shtk.html>shtk testing library</a> and hook it into the build as an <code>shtk_test</code> target.</p><h1 id=depending-on-rules_shtk>Depending on rules_shtk</h1><p><code>rules_shtk</code> is a shiny new ruleset (released just yesterday) and because Bazel 7 is around the corner, I&rsquo;ve opted to go all in for <a href=https://bazel.build/external/overview#bzlmod>bzlmod</a>. Thanks to bzlmod, setting up a project to use these rules is trivial. All you need is to add the following line to your <code>MODULE.bazel</code> file:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># Add this to MODULE.bazel.</span>
</span></span><span class=line><span class=cl><span class=n>bazel_dep</span><span class=p>(</span><span class=n>name</span> <span class=o>=</span> <span class=s2>&#34;rules_shtk&#34;</span><span class=p>,</span> <span class=n>version</span> <span class=o>=</span> <span class=s2>&#34;1.7&#34;</span><span class=p>)</span>
</span></span></code></pre></div><p>&mldr; but you&rsquo;ll need to wait until <a href=https://github.com/bazelbuild/bazel-central-registry/pull/1095>bazelbuild/bazel-central-registry#1095</a> is reviewed and merged. (I don&rsquo;t understand why this choke point exists in the new bzlmod ecosystem; Rust&rsquo;s crates.io doesn&rsquo;t have it, for example.)</p><p>In the meantime, or if you are not yet ready to upgrade to bzlmod, you can obviously use the old-fashioned and yucky <code>WORKSPACE.bazel</code> file to pull <code>rules_shtk</code> in:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># Add this to WORKSPACE or WORKSPACE.bazel if you don&#39;t use bzlmod yet.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>load</span><span class=p>(</span><span class=s2>&#34;@bazel_tools//tools/build_defs/repo:http.bzl&#34;</span><span class=p>,</span> <span class=s2>&#34;http_archive&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>http_archive</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>name</span> <span class=o>=</span> <span class=s2>&#34;bazel_skylib&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>sha256</span> <span class=o>=</span> <span class=s2>&#34;66ffd9315665bfaafc96b52278f57c7e2dd09f5ede279ea6d39b2be471e7e3aa&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>urls</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;https://mirror.bazel.build/github.com/bazelbuild/bazel-skylib/releases/download/1.4.2/bazel-skylib-1.4.2.tar.gz&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;https://github.com/bazelbuild/bazel-skylib/releases/download/1.4.2/bazel-skylib-1.4.2.tar.gz&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>],</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>load</span><span class=p>(</span><span class=s2>&#34;@bazel_skylib//:workspace.bzl&#34;</span><span class=p>,</span> <span class=s2>&#34;bazel_skylib_workspace&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>bazel_skylib_workspace</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>http_archive</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>name</span> <span class=o>=</span> <span class=s2>&#34;rules_shtk&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>sha256</span> <span class=o>=</span> <span class=s2>&#34;fa47891f27d8d59609732b34dc88020331b81b9767cbd72094fec1be8af4adfc&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>urls</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;https://github.com/jmmv/rules_shtk/releases/download/rules_shtk-1.7.0/rules_shtk-1.7.0.tar.gz&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>strip_prefix</span> <span class=o>=</span> <span class=s2>&#34;rules_shtk-1.7.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></div><h1 id=requesting-an-shtk-toolchain>Requesting an shtk toolchain</h1><p>Once you have added <code>rules_shtk</code> to your project, either via bzlmod or the <code>WORKSPACE.bazel</code>, you need to tell Bazel which shtk toolchain to use:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># Add this to WORKSPACE or WORKSPACE.bazel.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>load</span><span class=p>(</span><span class=s2>&#34;@rules_shtk//:repositories.bzl&#34;</span><span class=p>,</span> <span class=s2>&#34;shtk_dist&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>shtk_dist</span><span class=p>()</span>
</span></span></code></pre></div><p>The parameterless <code>shtk_dist</code> macro makes Bazel download <a href=https://github.com/jmmv/shtk/releases/tag/shtk-1.7>shtk 1.7</a> (because we requested the 1.7.x rules) and puts it to use for all tests that we later build. You cannot configure which version of shtk to download because, so far, all shtk versions are backwards-compatible and this won&rsquo;t change in the 1.x series.</p><p>There is also an <code>shtk_sytem</code> macro that makes Bazel discover the shtk toolchain installed in the system, say via your local package manager. This does not make sense for our use case (because we are only running tests within Bazel), but it can be useful if you want to build a script with <code>shtk_binary</code> that can later be taken out of <code>bazel-bin</code> and installed into the host system.</p><h1 id=writing-the-test-rule>Writing the test rule</h1><p>We now have the rules and a toolchain in place so we can proceed to add an <code>shtk_test</code> target. Our goal is to test <code>adder.c</code> with a new <code>adder_test.sh</code> sibling file, so we can put the test target next to the binary target:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>load</span><span class=p>(</span><span class=s2>&#34;@rules_shtk//:rules.bzl&#34;</span><span class=p>,</span> <span class=s2>&#34;shtk_test&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>cc_binary</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>name</span> <span class=o>=</span> <span class=s2>&#34;adder&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>srcs</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;adder.c&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>shtk_test</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>name</span> <span class=o>=</span> <span class=s2>&#34;adder_test&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>src</span> <span class=o>=</span> <span class=s2>&#34;adder_test.sh&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;:adder&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></div><p>There are different opinions on where tests should live but, personally, I want them as close to the code they test as possible. This makes tests discoverable when editing code, which increases the odds that developers will remember to update them. Also, nobody likes dealing with parallel deep directory hierarchies when working on a piece of code&mldr; thank you, <code>java</code> and <code>javatests</code>.</p><h1 id=writing-the-test-program>Writing the test program</h1><p>All that&rsquo;s left to do is an <a href=https://en.wikipedia.org/wiki/Small_matter_of_programming>SMOP</a>. We need to write the tests in <code>adder_test.sh</code>. Here are just a couple of examples:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># This is a portion of adder_test.sh.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>shtk_import unittest
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>shtk_unittest_add_test addition_works
</span></span><span class=line><span class=cl>addition_works_test<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    expect_command <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>        -o inline:<span class=s2>&#34;The sum of 2 and 3 is 5\n&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>        ../adder <span class=m>2</span> <span class=m>3</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>shtk_unittest_add_test bad_arguments
</span></span><span class=line><span class=cl>bad_arguments_test<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    expect_command <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>        -s <span class=m>1</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>        -e inline:<span class=s2>&#34;adder: Requires two integer arguments\n&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>        ../adder
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>I don&rsquo;t want to dive into the shtk APIs too much, but I want to highlight the <code>expect_command</code> calls in here. This assertion is the salient feature of shtk&rsquo;s unit-testing module and is what makes testing tools a breeze. Take a look at the <a href=https://shtk.jmmv.dev/shtk_unittest_assert_command.3.html><code>assert_command</code></a> and <a href=https://shtk.jmmv.dev/shtk_unittest_assert_file.3.html><code>assert_file</code></a> documentation to demystify the <code>-s</code>, <code>-o</code>, and <code>-e</code> flags shown above.</p><p>One thing that needs explaining is the <code>../adder</code> reference to the tool. If we look at the runfiles tree that Bazel creates when building the <code>//:adder_test</code> target, we see:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> ls -l bazel-bin/adder_test.runfiles/_main/
</span></span><span class=line><span class=cl><span class=go>total 8K
</span></span></span><span class=line><span class=cl><span class=go>lrwxrwxrwx. 1 jmmv jmmv 116 Nov  4 06:17 adder -&gt; /home/jmmv/.cache/bazel/_bazel_jmmv/916b9cbf147e00ff01b88519fdb0f294/execroot/_main/bazel-out/k8-fastbuild/bin/adder
</span></span></span><span class=line><span class=cl><span class=go>lrwxrwxrwx. 1 jmmv jmmv 121 Nov  4 06:17 adder_test -&gt; /home/jmmv/.cache/bazel/_bazel_jmmv/916b9cbf147e00ff01b88519fdb0f294/execroot/_main/bazel-out/k8-fastbuild/bin/adder_test
</span></span></span></code></pre></div><p>There are no directories in there. So, where does that <code>..</code> come from in the <code>../adder</code> reference? Well&mldr; shtk&rsquo;s unit-testing execution engine creates a disposable subdirectory for each test it runs. The reason for this is that, when writing shell tests, it is extremely common to have to create auxiliary files, and shtk accounts for that by cleaning up whichever files you create in the current directory of a test. This is a little oddity you&rsquo;ll have to keep in mind.</p><h1 id=running-the-test>Running the test</h1><p>All done. We can finally run the end-to-end test for our demo tool:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> bazel <span class=nb>test</span> --nocache_test_results --test_output<span class=o>=</span>streamed //:adder_test
</span></span><span class=line><span class=cl><span class=go>WARNING: Streamed test output requested. All tests will be run locally, without sharding, one at a time
</span></span></span><span class=line><span class=cl><span class=go>INFO: Analyzed target //:adder_test (0 packages loaded, 139 targets configured).
</span></span></span><span class=line><span class=cl><span class=go>INFO: Found 1 test target...
</span></span></span><span class=line><span class=cl><span class=go>adder_test: I: Testing addition_works...
</span></span></span><span class=line><span class=cl><span class=go>Running checked command: ../adder 2 3
</span></span></span><span class=line><span class=cl><span class=go>Running checked command: ../adder -12345 12345
</span></span></span><span class=line><span class=cl><span class=go>adder_test: I: Testing addition_works... PASSED
</span></span></span><span class=line><span class=cl><span class=go>adder_test: I: Testing bad_first_operand...
</span></span></span><span class=line><span class=cl><span class=go>Running checked command: ../adder 123456789 0
</span></span></span><span class=line><span class=cl><span class=go>Running checked command: ../adder  0
</span></span></span><span class=line><span class=cl><span class=go>Running checked command: ../adder 123x 0
</span></span></span><span class=line><span class=cl><span class=go>Running checked command: ../adder -123456789 0
</span></span></span><span class=line><span class=cl><span class=go>adder_test: I: Testing bad_first_operand... PASSED
</span></span></span><span class=line><span class=cl><span class=go>adder_test: I: Testing bad_second_operand...
</span></span></span><span class=line><span class=cl><span class=go>Running checked command: ../adder 0 123456789
</span></span></span><span class=line><span class=cl><span class=go>Running checked command: ../adder 0 
</span></span></span><span class=line><span class=cl><span class=go>Running checked command: ../adder 0 123x
</span></span></span><span class=line><span class=cl><span class=go>Running checked command: ../adder 0 -123456789
</span></span></span><span class=line><span class=cl><span class=go>adder_test: I: Testing bad_second_operand... PASSED
</span></span></span><span class=line><span class=cl><span class=go>adder_test: I: Testing bad_arguments...
</span></span></span><span class=line><span class=cl><span class=go>Running checked command: ../adder
</span></span></span><span class=line><span class=cl><span class=go>Running checked command: ../adder 1
</span></span></span><span class=line><span class=cl><span class=go>Running checked command: ../adder 1 2 3
</span></span></span><span class=line><span class=cl><span class=go>adder_test: I: Testing bad_arguments... PASSED
</span></span></span><span class=line><span class=cl><span class=go>adder_test: I: Ran 4 tests; ALL PASSED
</span></span></span><span class=line><span class=cl><span class=go>Target //:adder_test up-to-date:
</span></span></span><span class=line><span class=cl><span class=go>  bazel-bin/adder_test
</span></span></span><span class=line><span class=cl><span class=go>INFO: Elapsed time: 0.504s, Critical Path: 0.33s
</span></span></span><span class=line><span class=cl><span class=go>INFO: 2 processes: 2 linux-sandbox.
</span></span></span><span class=line><span class=cl><span class=go>INFO: Build completed successfully, 2 total actions
</span></span></span><span class=line><span class=cl><span class=go>//:adder_test                                                            PASSED in 0.2s
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Executed 1 out of 1 test: 1 test passes.
</span></span></span><span class=line><span class=cl><span class=go>There were tests whose specified size is too big. Use the --test_verbose_timeout_warnings command line option to see which ones these are.
</span></span></span></code></pre></div><hr><p>As much hate as &ldquo;large&rdquo; shell scripts get, the shell is a uniquely-positioned language to help you write end-to-end tests for your tools. After all, the shell is what you use to <em>run</em> those precious tools, so the shell is also what you should use to run them in an automated fashion for testing purposes.</p><p>It&rsquo;s your turn now. Go read the <a href=https://shtk.jmmv.dev>online documentation</a> for shtk, the previous introductory blog post, and get testing! Your users will be much happier if your tools offer excellent interfaces. And if you need ideas on what to test or how to improve the interface of your tools, take a look at the <a href="/series.html#CLI design">CLI design series</a> from 2013.</p></article></div></div><div class="container post-links"><div class=row><div class="col mr-auto text-left"><span><a href=https://jmmv.dev/2023/10/links-october-2023-edition.html>&#171; Previous</a></span></div><div class="col text-center"><span><a href=/archive.html>All posts</a></span></div><div class="col ml-auto text-right"><span><a href=https://jmmv.dev/2023/11/why-do-i-know-shell-and-how-can-you.html>Next &#187;</a></span></div></div></div><div class="container post-votes"><div class=row><div class="col-lg-4 my-2"><div class=row><div class=col><a onclick=voteThumbsUp() class="btn btn-block btn-outline-success" id=thumbs-up-btn>👍
(<span id=thumbs-up-count>0</span>)</a></div><div class=col><a onclick=voteThumbsDown() class="btn btn-block btn-outline-danger" id=thumbs-down-btn>👎
(<span id=thumbs-down-count>0</span>)</a></div></div></div><div class="col-lg-8 my-2 d-none d-sm-block"><div class=row><div class="col-md-4 text-center"><a href="https://www.reddit.com/submit?title=End-to-end+tool+testing+with+Bazel+and+shtk&amp;url=https%3A%2F%2Fjmmv.dev%2F2023%2F11%2Fend-to-end-tool-testing-with-bazel.html" class="btn btn-block btn-outline-primary">Share on
<img src=/images/badges/reddit.png alt=Reddit width=24 height=24></a></div><div class="col-md-4 text-center"><a href="https://news.ycombinator.com/submitlink?t=End-to-end+tool+testing+with+Bazel+and+shtk&amp;u=https%3A%2F%2Fjmmv.dev%2F2023%2F11%2Fend-to-end-tool-testing-with-bazel.html" class="btn btn-block btn-outline-primary">Share on
<img src=/images/badges/ycombinator.png alt="Hacker News" width=24 height=24></a></div><div class="col-md-4 text-center"><a href="https://twitter.com/intent/tweet?status=End-to-end+tool+testing+with+Bazel+and+shtk+%E2%80%94+https%3A%2F%2Fjmmv.dev%2F2023%2F11%2Fend-to-end-tool-testing-with-bazel.html+%E2%80%94+cc+%40jmmv" class="btn btn-block btn-outline-primary">Share on
<img src=/images/badges/Twitter_Social_Icon_Circle_Color.png alt=Twitter width=24 height=24></a></div></div></div></div><div class="row my-4" id=postCommentRow><div class=col><div class=media><img class=mr-3 src=/octicons/pencil.svg width=32px height=32px><div class="media-body container"><form method=post id=newPost><div class=row><div class="col my-1"><textarea class=form-control rows=1 id=postCommentContent onclick=showPostComment() placeholder="Leave a comment"></textarea></div></div><div class="row newPostControls" style=display:none><div class="col my-1 form-group"><label for=postCommentAuthor>Your name (optional):</label>
<input type=text class=form-control id=postCommentAuthor></div></div><div class="row newPostControls" style=display:none><div class="col my-1 form-group"><label for=postCommentEmail>Your email (optional):</label>
<input type=text class=form-control type=email id=postCommentEmail>
<small class="form-text text-muted">Invisible to all readers; if provided, you will receive notifications when replied to (not implemented yet)</small></div></div><div class=row id=postCommentError style=display:none><div class="col mt-1 alert-danger"><p></p></div></div><div class="row newPostControls" style=display:none><button class="col-md-3 my-1 btn btn-primary" type=submit id=submitCommentButton>Post</button>
<small class="col-md-9 my-1 text-muted">Comments are subject to moderation. This feature is experimental and is powered by <a href=/software/endtracker.html>EndTRACKER</a>. If you experience any issues, please <a href=/about.html#contact>contact me off-band</a>.</small></div></form></div></div></div></div><script>function hidePostComment(){var t,e=document.getElementById("postCommentContent");e.rows=1,e.value="",t=document.getElementsByClassName("newPostControls"),Array.prototype.forEach.call(t,function(e){e.style.display="none"})}function showPostComment(){var e,t=document.getElementById("postCommentContent");t.rows=5,e=document.getElementsByClassName("newPostControls"),Array.prototype.forEach.call(e,function(e){e.style.display=""})}const form=document.querySelector("#newPost");form.onsubmit=function(e){e.preventDefault();let t=document.getElementById("postCommentAuthor").value,n=document.getElementById("postCommentEmail").value,s=document.getElementById("postCommentContent").value;postComment(t,n,s,hidePostComment)}</script></div></div><div class="col-md-3 sidebar d-none d-md-block"><div class=row><div class="col text-center p-2"><p><a href=/about.html class=clear-link><img src=/images/avatars/20181124-snow.jpg class="rounded-circle shadow my-2" style=width:100px><br><b>Julio Merino</b><br>A blog on operating systems, programming languages, testing, build systems, my own software
projects and even personal productivity. Specifics include FreeBSD, Linux, Rust, Bazel and
EndBASIC.</a></p><div class=row><div class=col><div class=form-group><form action=https://endtracker.azurewebsites.net/api/sites/e8da9f62-b7ac-4fe9-bf20-7c527199a376/subscribers/add method=post><input type=text name=email placeholder="Enter your email" class="form-control input-sm text-center my-1">
<button type=submit class="btn btn-primary btn-block my-1">Subscribe</button></form></div></div></div><div class="row px-2"><div class="col-sm-5 text-left"><small><span class=subscriber-count>0</span> subscribers</small></div><div class="col-sm-7 text-right"><p><a rel=me href=https://mastodon.online/@jmmv><img src=/images/badges/mastodon-logo.svg width=32px height=32px alt="Follow @jmmv on Mastodon"></a>
<a href="https://twitter.com/intent/follow?original_referer=https%3A%2F%2Fjmmv.dev%2F&amp;screen_name=jmmv"><img src=/images/badges/Twitter_logo_blue.svg width=32px height=32px alt="Follow @jmmv on Twitter"></a>
<a href=/feed.xml><img src=/images/badges/feed-icon-28x28.png alt="RSS feed"></a></p></div></div></div></div><div class=row><div class=col><h2>Featured software</h2><ul><li class=overflow-ellipsis><a href=https://www.endbasic.dev/ target=_blank>EndBASIC: Online BASIC+DOS env</a></li><li class=overflow-ellipsis><a href=https://endtracker.azurewebsites.net/ target=_blank>EndTRACKER: Services for static sites</a></li></ul></div></div><div class=row><div class=col><h2>Featured posts</h2><ul><li class=overflow-ellipsis><a href=/2023/06/fast-machines-slow-machines.html>Fast machines, slow machines</a></li><li class=overflow-ellipsis><a href=/2022/12/endbasic-0.10.html>EndBASIC 0.10: Core language, evolved</a></li><li class=overflow-ellipsis><a href=/2022/10/bye-microsoft-hi-snowflake.html>Farewell, Microsoft; hello, Snowflake!</a></li><li class=overflow-ellipsis><a href=/2022/05/rust-is-hard-but-does-it-matter.html>Rust is hard, yes, but does it matter?</a></li><li class=overflow-ellipsis><a href=/2022/04/rust-traits-and-dependency-injection.html>Rust traits and dependency injection</a></li><li class=overflow-ellipsis><a href=/2022/03/a-year-on-windows-intro.html>A year on Windows: Introduction</a></li><li class=overflow-ellipsis><a href=/2021/04/always-be-quitting.html>Always be quitting</a></li><li class=overflow-ellipsis><a href=/2021/02/google-monorepos-and-caching.html>How does Google keep build times low?</a></li><li class=overflow-ellipsis><a href=/2020/12/google-no-clean-builds.html>How does Google avoid clean builds?</a></li><li class=overflow-ellipsis><a href=/2020/12/unit-testing-a-console-app.html>Unit-testing a console app (a text editor)</a></li><li class=overflow-ellipsis><a href=/essays.html#featured>More...</a></li></ul></div></div></div></div></div><footer class=container-fluid><div class=row><div class="col-4 order-2 text-right"><p class=float-right><a href=#>Back to top</a></p></div><div class="col-8 order-1 mr-auto"><p>Copyright 2004&ndash;2023 Julio Merino</p></div></div></footer><script type=module>
  import { addAnchorsToHeaders, addElementClasses, BatchClient } from "\/js\/main.d30f168b11d80082408f4a983af9a626c6e57d58f7846b2174bac40d43be33e3.js";

  var batchClient = new BatchClient(SITE_ID);
  batchClient.doAll({
    put_request: true, get_comments: true, get_subscriber_count: true, get_votes: true });

  window.voteThumbsUp = function() { batchClient.voteThumbsUp(); }
  window.voteThumbsDown = function() { batchClient.voteThumbsDown(); }

  window.postComment = function(...args) {
    batchClient.postComment(...args);
  };

  addAnchorsToHeaders();
  addElementClasses();
</script></body></html>