<!doctype html><html lang=en xmlns=http://www.w3.org/1999/xhtml xmlns:fb=http://ogp.me/ns/fb#><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta property="og:site_name" content="Julio Merino (jmmv.dev)"><meta property="twitter:site" content="@jmmv"><title>Unit-testing shell scripts and tools with shtk - Julio Merino (jmmv.dev)</title><meta property="og:title" content="Unit-testing shell scripts and tools with shtk - Julio Merino (jmmv.dev)"><meta property="twitter:title" content="Unit-testing shell scripts and tools with shtk - Julio Merino …"><meta name=description content="While working on this static blog a few days ago, I made a change to its templates that warranted an automated test. I could have written a trivial shell script to do it, but instead I reached out for shtk&amp;rsquo;s unit-testing module. I tweeted about it right away to just say that you can, in fact, write tests in shell because lots of developers are skeptical about any script longer than 10 lines of code.
Interestingly, this reply came through: a pointer to a contemporary, under-development library for writing tests in Bash. Which made me think: &amp;ldquo;Hey, I had already done that years ago&amp;hellip; but nobody knows about it. Gotta fix that with a blog post!&amp;rdquo; But first, I had to bring shtk back from its ashes because I had not touched it for more than 6 years and it wasn&amp;rsquo;t read for show and tell. So I did something that I wanted to do back in the day but never did: I put together a website for shtk to host its reference manual and I fixed a few obvious rough edges.
With those tweaks out of the way, we come to this article. In here, I want to show you how writing decent tests in shell is entirely possible and how shtk&amp;rsquo;s testing platform provides unique features to do integration testing of CLI apps written in any language.
"><meta property="og:description" content="While working on this static blog a few days ago, I made a change to its templates that warranted an automated test. I could have written a trivial shell script to do it, but instead I reached out for shtk&amp;rsquo;s unit-testing module. I tweeted about it right away to just say that you can, in fact, write tests in shell because lots of developers are skeptical about any script longer than 10 lines of code.
Interestingly, this reply came through: a pointer to a contemporary, under-development library for writing tests in Bash. Which made me think: &amp;ldquo;Hey, I had already done that years ago&amp;hellip; but nobody knows about it. Gotta fix that with a blog post!&amp;rdquo; But first, I had to bring shtk back from its ashes because I had not touched it for more than 6 years and it wasn&amp;rsquo;t read for show and tell. So I did something that I wanted to do back in the day but never did: I put together a website for shtk to host its reference manual and I fixed a few obvious rough edges.
With those tweaks out of the way, we come to this article. In here, I want to show you how writing decent tests in shell is entirely possible and how shtk&amp;rsquo;s testing platform provides unique features to do integration testing of CLI apps written in any language.
"><meta property="twitter:description" content="While working on this static blog a few days ago, I made a change to its templates that warranted an automated test. I could have written a trivial shell script to do it, but instead I reached out for …"><meta name=author content="Julio Merino"><meta property="twitter:creator" content="@jmmv"><meta name=generator content="Hugo 0.111.3"><meta property="og:url" content="https://jmmv.dev/2023/10/unit-testing-with-shtk.html"><meta property="og:type" content="blog"><meta property="twitter:card" content="summary"><link rel=canonical href=https://jmmv.dev/2023/10/unit-testing-with-shtk.html><link rel=alternate type=application/rss+xml title="Julio Merino (jmmv.dev)" href=/feed.xml><link rel=stylesheet href=/sass/main.min.161663676cac4bf21abc8967ec3267c26026aa58e9f392c5f3427e0ef089fe6b.css><link rel=stylesheet href=/css/chroma.css><link rel=icon type=image/png href=/images/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/images/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicons/favicon-96x96.png sizes=96x96><meta property="og:image" content="/images/2023-10-11-shell-hammer-wrench.jpg"><meta property="twitter:image" content="https://jmmv.dev/images/2023-10-11-shell-hammer-wrench.jpg"><meta property="og:image:alt" content="A seashell next to a hammer and a wrench."><meta property="twitter:image:alt" content="A seashell next to a hammer and a wrench."><script>const SITE_ID="e8da9f62-b7ac-4fe9-bf20-7c527199a376",BASE_URL="https://jmmv.dev/"</script></head><body><header class=site-header><nav class="navbar navbar-expand-lg fixed-top navbar-dark bg-primary"><a class=navbar-brand href=/><img src=/images/favicons/favicon-30x30.png width=30 height=30 class="d-inline-block align-top" alt>
&nbsp;Julio Merino</a>
<button class=navbar-toggler type=button data-toggle=collapse data-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarSupportedContent><ul class="navbar-nav mr-auto"><li class=nav-item><a class=nav-link href=/about.html>About</a></li><li class=nav-item><a class=nav-link href=/essays.html>Essays</a></li><li class=nav-item><a class=nav-link href=/resume.html>Resume</a></li><li class=nav-item><a class=nav-link href=/software.html>Software</a></li></ul><ul class="navbar-nav mr-4"><li class=nav-item><a class=nav-link href=/archive.html>Archive</a></li><li class=nav-item><a class=nav-link href=/series.html>Series</a></li><li class=nav-item><a class=nav-link href=/tags.html>Tags</a></li></ul><form class=form-inline method=get role=search action=https://www.google.com/search><div class=input-group><input type=search name=query class=form-control placeholder=Search aria-label=Search><div class=input-group-append><button type=submit value=Search class="btn btn-light">
<img src=/octicons/search.svg></button></div></div><input type=hidden name=sitesearch value=https://jmmv.dev/></form></div></nav></header><div class=page-header><div class=container><h1>Unit-testing shell scripts and tools with shtk</h1><p>October 11, 2023 &#183;
About 12 minutes
&#183;
Tags:
<a href=/tags/shell>shell</a>, <a href=/tags/shtk>shtk</a>, <a href=/tags/testing>testing</a></p><figure class=cover-image><img src=/images/2023-10-11-shell-hammer-wrench.jpg width=100%><figcaption>A seashell next to a hammer and a wrench.</figcaption></figure></div></div><div class="container post-body"><div class=row><div class=col-md-9><div class=row><div class=col><article><p>While working on this static blog a few days ago, I made a change to its templates that warranted an automated test. I could have written a trivial shell script to do it, but instead I reached out for shtk&rsquo;s unit-testing module. I <a href=https://twitter.com/jmmv/status/1710309896670081083>tweeted about it</a> right away to just say that you can, in fact, write tests in shell because lots of developers are skeptical about any script longer than 10 lines of code.</p><p>Interestingly, this reply came through: a pointer to a contemporary, under-development library for writing tests in Bash. Which made me think: &ldquo;Hey, I had already done that years ago&mldr; but nobody knows about it. Gotta fix that with a blog post!&rdquo; But first, I had to bring shtk back from its ashes because I had not touched it for more than 6 years and it wasn&rsquo;t read for show and tell. So I did something that I wanted to do back in the day but never did: I put together <a href=https://shtk.jmmv.dev/>a website for shtk</a> to host its <a href=https://shtk.jmmv.dev/docs.html>reference manual</a> and I fixed a few obvious rough edges.</p><p>With those tweaks out of the way, we come to this article. In here, I want to show you how writing decent tests in shell is entirely possible and how shtk&rsquo;s testing platform provides unique features to do integration testing of CLI apps written in any language.</p><div class="container action-highlight p-4 my-4 d-md-none"><div class="row text-center"><p>A blog on operating systems, programming languages, testing, build systems, my own software
projects and even personal productivity. Specifics include FreeBSD, Linux, Rust, Bazel and
EndBASIC.</p></div><div class=row><div class=col><div class=form-group><form action=https://endtracker.azurewebsites.net/api/sites/e8da9f62-b7ac-4fe9-bf20-7c527199a376/subscribers/add method=post><input type=text name=email placeholder="Enter your email" class="form-control input-sm text-center my-1">
<button type=submit class="btn btn-primary btn-block my-1">Subscribe</button></form></div></div></div><div class="row px-2"><div class="col col-sm-5 text-left"><small><span class=subscriber-count>0</span> subscribers</small></div><div class="col col-sm-7 text-right"><p><a rel=me href=https://mastodon.online/@jmmv><img src=/images/badges/mastodon-logo.svg width=32px height=32px alt="Follow @jmmv on Mastodon"></a>
<a href="https://twitter.com/intent/follow?original_referer=https%3A%2F%2Fjmmv.dev%2F&amp;screen_name=jmmv"><img src=/images/badges/Twitter_logo_blue.svg width=32px height=32px alt="Follow @jmmv on Twitter"></a>
<a href=/feed.xml><img src=/images/badges/feed-icon-28x28.png alt="RSS feed"></a></p></div></div></div><h1 id=what-is-shtk-anyway>What is shtk anyway?</h1><p>The Shell Toolkit, or shtk for short, is a collection of libraries to support the writing of portable shell scripts. shtk grew out of <a href=http://blog.netbsd.org/tnf/entry/introducing_sysbuild_and_sysupgrade>sysbuild and sysupgrade</a>&rsquo;s common code, a couple of tools I wrote over 10 years ago for NetBSD and that are fully written in shell because of the constraints of the NetBSD base system. In turn, this means that shtk is <em>not</em> Bash-specific so it avoids imposing a <a href=/2021/08/useless-use-of-gnu.html>useless use of GNU</a>.</p><p>From the get go, all of shtk, sysbuild, and sysupgrade had unit tests written with atf-sh, the shell testing library of the <a href=/software/atf.html>Automated Testing Framework</a>. atf-sh was a rather simplistic library created by yours truly in 2007 and required a complex runtime (atf-run or, later, <a href=/software/kyua.html>Kyua</a>) to be functional. By 2014, while working at Google, I had been exposed to better ways of writing tests that blended better with the languages they supported (pyUnit and JUnit), and I knew that I needed a replacement for atf-sh.</p><p>Hence, in 2014, I took the best parts of atf-sh, the core concepts of the xUnit test frameworks, and I created shtk&rsquo;s <code>unittest</code> module. I then proceeded to migrate all existing tests to this new framework and also used shtk to <a href=/2017/02/introducing-pkg_comp-2.0.html>build pkg_comp 2.x later on in 2017</a>. But I failed to publicize the library because I didn&rsquo;t quite know how to put together a cool-looking website and I didn&rsquo;t have a good platform to talk about it&mdash;both of which are fixed now.</p><h1 id=installing-shtk>Installing shtk</h1><p>If you are on NetBSD or on FreeBSD, you are in luck! There are packages for shtk ready to install, so go ahead and use those.</p><p>On any other system, you&rsquo;ll have to build shtk from source. Fear not, it&rsquo;s easy:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>$ curl -LO https://github.com/jmmv/shtk/releases/download/shtk-1.7/shtk-1.7.tar.gz
</span></span><span class=line><span class=cl>$ tar xzf shtk-1.7.tar.gz
</span></span><span class=line><span class=cl>$ cd shtk-1.7
</span></span><span class=line><span class=cl>$ ./configure --prefix ~/.local
</span></span><span class=line><span class=cl>$ make
</span></span><span class=line><span class=cl>$ make install
</span></span></code></pre></div><p>After a successful installation, you should have the <code>shtk</code> tool in your path. If that&rsquo;s not the case, do this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>$ PATH=&#34;${HOME}/.local/bin:${PATH}&#34;
</span></span><span class=line><span class=cl>$ export MANPATH=&#34;${HOME}/.local/share/man:${MANPATH}&#34;
</span></span></code></pre></div><p>Setting up the <code>MANPATH</code> is important. shtk&rsquo;s official documentation is written as manual pages to seamlessly integrate with the Unix-y environment it&rsquo;s intended to complement, so you&rsquo;ll want <code>man</code> invocations to work. If you are curious, start by peeking into <a href=https://shtk.jmmv.dev/shtk.1.html><code>shtk(1)</code></a> and <a href=https://shtk.jmmv.dev/shtk.3.html><code>shtk(3)</code></a>.</p><h1 id=creating-our-first-test>Creating our first test</h1><p>Now that we have shtk up and running, let&rsquo;s create a test. Write the following contents to a file named <code>demo_test.sh</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>shtk_import unittest
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>shtk_unittest_add_test always_fails
</span></span><span class=line><span class=cl>always_fails_test<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    assert_equal <span class=m>2</span> <span class=m>3</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;NOT REACHED!&#34;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>Done? OK. Something looks funny, doesn&rsquo;t it? <code>shtk_import</code> is a shell function that brings the <code>unittest</code> module into scope. But&mldr; where does that function come from? Well, here is the thing: shtk scripts need to be &ldquo;built&rdquo; before they can run. In order for the above to become a runnable test program, you have to do the following:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>$ shtk build -m shtk_unittest_main demo_test.sh
</span></span></code></pre></div><p>After running the above, you&rsquo;ll end up with a <code>demo_test</code> executable. This &ldquo;executable&rdquo; is essentially the same as <code>demo_test.sh</code> but with some preamble code to set up the module import features and a call to the <code>shtk_unittest_main</code> entry point to execute the tests.</p><p>Once the script is built, run it and see the single test fail:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>$ ./demo_test
</span></span><span class=line><span class=cl>demo_test: I: Testing always_fails...
</span></span><span class=line><span class=cl>demo_test: E: Expected value 2 but got 3
</span></span><span class=line><span class=cl>demo_test: W: Testing always_fails... FAILED
</span></span><span class=line><span class=cl>demo_test: W: Ran 1 tests; 1 FAILED
</span></span></code></pre></div><h1 id=advanced-xunit-like-features>Advanced xUnit-like features</h1><p>The above is nice but&mldr; pretty&mldr; simple? Anyone can write a conditional to check if two values are equal without the need for &ldquo;fancy frameworks&rdquo;, right? Right. But shtk provides much more.</p><p>Just like asserts, shtk also comes with expects to record soft failures: all <code>assert_*</code> functions have an <code>expect_*</code> counterpart. If we tweak our previous test to look like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>shtk_import unittest
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>shtk_unittest_add_test always_fails
</span></span><span class=line><span class=cl>always_fails_test<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    expect_equal <span class=m>2</span> <span class=m>3</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;REACHED!&#34;</span>
</span></span><span class=line><span class=cl>    expect_equal <span class=m>4</span> <span class=m>5</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>We get the following, which shows how the two expect commands ran and detected a failure but didn&rsquo;t stop execution:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>$ shtk build -m shtk_unittest_main demo_test.sh
</span></span><span class=line><span class=cl>$ ./demo_test
</span></span><span class=line><span class=cl>demo_test: I: Testing always_fails...
</span></span><span class=line><span class=cl>demo_test: W: Delayed failure: Expected value 2 but got 3
</span></span><span class=line><span class=cl>REACHED!
</span></span><span class=line><span class=cl>demo_test: W: Delayed failure: Expected value 4 but got 5
</span></span><span class=line><span class=cl>demo_test: W: Testing always_fails... FAILED (2 delayed failures)
</span></span><span class=line><span class=cl>demo_test: W: Ran 1 tests; 1 FAILED
</span></span></code></pre></div><p>In general, when writing a test, you use asserts for any step that prepares the test scenario, and you use expects for the test scenario itself. This way, the test fails early if it is unable to set up the scenario (because it makes no sense to continue if the scenario is not set up), but it prints as much diagnostic information as possible if the actual test detects problems half-way through.</p><p>What about fixtures? Setup and teardown routines? shtk has got you covered too:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>shtk_import unittest
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>shtk_unittest_add_fixture sample
</span></span><span class=line><span class=cl>sample_fixture<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    setup<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=nb>echo</span> <span class=s2>&#34;Common setup code&#34;</span>
</span></span><span class=line><span class=cl>        <span class=nb>echo</span> <span class=m>123</span> &gt;data.txt
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    teardown<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=nb>echo</span> <span class=s2>&#34;Common cleanup code&#34;</span>
</span></span><span class=line><span class=cl>        rm -f data.txt
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    shtk_unittest_add_test ok
</span></span><span class=line><span class=cl>    ok_test<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        assert_equal <span class=m>123</span> <span class=s2>&#34;</span><span class=k>$(</span>cat data.txt<span class=k>)</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=nb>echo</span> <span class=m>125</span> &gt;data.txt  <span class=c1># Overwrites transient file.</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    shtk_unittest_add_test not_ok
</span></span><span class=line><span class=cl>    not_ok_test<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        assert_equal <span class=m>125</span> <span class=s2>&#34;</span><span class=k>$(</span>cat data.txt<span class=k>)</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>Running the above does as you would expect:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>$ shtk build -m shtk_unittest_main demo_test.sh
</span></span><span class=line><span class=cl>$ ./demo_test
</span></span><span class=line><span class=cl>demo_test: I: Testing sample__ok...
</span></span><span class=line><span class=cl>Common setup code
</span></span><span class=line><span class=cl>Common cleanup code
</span></span><span class=line><span class=cl>demo_test: I: Testing sample__ok... PASSED
</span></span><span class=line><span class=cl>demo_test: I: Testing sample__not_ok...
</span></span><span class=line><span class=cl>Common setup code
</span></span><span class=line><span class=cl>demo_test: E: Expected value 125 but got 123
</span></span><span class=line><span class=cl>Common cleanup code
</span></span><span class=line><span class=cl>demo_test: W: Testing sample__not_ok... FAILED
</span></span><span class=line><span class=cl>demo_test: W: Ran 2 tests; 1 FAILED
</span></span></code></pre></div><p>Note how the setup and teardown routines were executed for each test, which means that the <code>data.txt</code> file was recreated for every test case and the modifications to the file from one test didn&rsquo;t impact the outcome of the other.</p><h1 id=the-secret-sauce-assert_command>The secret sauce: assert_command</h1><p>So far, everything looks very xUnit-like. We have asserts and expects; we have test setup and teardown hooks; we have fixtures. But shell scripts are uniquely suited to test the user interface of a CLI app: after all, users interact with CLI apps from the shell, so it&rsquo;s only natural to use the shell to test arbitrary tools no matter what language they are written in. This is where shtk&rsquo;s magic sauce comes into play.</p><p>shtk&rsquo;s <code>assert_command</code> check allows you to run an arbitrary command and to declaratively check its exit condition and its side-effects on stdout and stderr. The feature is inspired by <a href=https://www.gnu.org/software/autoconf/manual/autoconf-2.68/html_node/Writing-Testsuites.html><code>AT_CHECK</code> in GNU Autoconf</a>, to which I was exposed even longer ago (circa 2005) while working on the Monotone project.</p><p>Take a look at these tests that exercise the <code>cp</code> tool and pay close attention to the <code>assert_command</code> calls:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>shtk_import unittest
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>shtk_unittest_add_test cp_ok
</span></span><span class=line><span class=cl>cp_ok_test<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    touch a
</span></span><span class=line><span class=cl>    assert_command cp a b
</span></span><span class=line><span class=cl>    <span class=o>[</span> -f b <span class=o>]</span> <span class=o>||</span> fail <span class=s2>&#34;b was not created&#34;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>shtk_unittest_add_test cp_missing_source
</span></span><span class=line><span class=cl>cp_missing_source_test<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    assert_command -s exit:1 -e match:<span class=s2>&#34;No such file&#34;</span> cp a b
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>shtk_unittest_add_test cp_unexpected_output
</span></span><span class=line><span class=cl>cp_unexpected_output_test<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    assert_command -s exit:1 -o match:<span class=s2>&#34;Hello&#34;</span> cp a b
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>In the first test, <code>cp_ok</code>, the call to <code>assert_command</code> has no flags. This means that we expect the command given to the assert to finish successfully and quietly: the exit code of <code>cp a b</code> should be 0, and both stdout and stderr should be silent.</p><p>In the second test, <code>cp_missing_source</code>, the call to <code>assert_command</code> specifies that the command under test has to terminate with an exit code of 1, and that stderr has match the <code>No such file</code> regular expression.</p><p>In the third test, <code>cp_unexpected_output</code>, the call to <code>assert_command</code> expects a message to stdout that <code>cp</code> will not print, and also implies that stderr should be empty.</p><p>When we run the above after compilation, we get:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>$ shtk build -m shtk_unittest_main demo_test.sh
</span></span><span class=line><span class=cl>$ ./demo_test
</span></span><span class=line><span class=cl>demo_test: I: Testing cp_ok...
</span></span><span class=line><span class=cl>Running checked command: cp a b
</span></span><span class=line><span class=cl>demo_test: I: Testing cp_ok... PASSED
</span></span><span class=line><span class=cl>demo_test: I: Testing cp_missing_source...
</span></span><span class=line><span class=cl>Running checked command: cp a b
</span></span><span class=line><span class=cl>demo_test: I: Testing cp_missing_source... PASSED
</span></span><span class=line><span class=cl>demo_test: I: Testing cp_unexpected_output...
</span></span><span class=line><span class=cl>Running checked command: cp a b
</span></span><span class=line><span class=cl>Expected regexp &#39;Hello&#39; not found in standard output:
</span></span><span class=line><span class=cl>Expected standard error to be empty; found:
</span></span><span class=line><span class=cl>cp: a: No such file or directory
</span></span><span class=line><span class=cl>demo_test: E: Check of &#39;cp a b&#39; failed; see stdout for details
</span></span><span class=line><span class=cl>demo_test: W: Testing cp_unexpected_output... FAILED
</span></span><span class=line><span class=cl>demo_test: W: Ran 3 tests; 1 FAILED
</span></span></code></pre></div><p>Note that the first two tests passed, but pay attention to the output of the third failed test: the call to <code>assert_command</code> reports that neither stdout nor stderr matched what we expected and provides details on why.</p><p>I invite you to take a look at the documentation in <a href=https://shtk.jmmv.dev/shtk_unittest_assert_command.3.html><code>shtk_unittest_assert_command(3)</code></a> and its supporting <a href=https://shtk.jmmv.dev/shtk_unittest_assert_file.3.html><code>shtk_unittest_assert_file(3)</code></a> as the features they provide are too numerous to be captured in this post.</p><h1 id=using-gnu-automake-as-a-test-runner>Using GNU Automake as a test runner</h1><p>Up until here, I have shown you the features that the shtk library itself provides&mldr; but a testing library to write test programs with is not very useful on its own. What happens when you want to run more than one test program at once? How do you set up the test environment so that tests always run in a consistent manner, free from side-effects? How do you collect results for reporting?</p><p>This is where test runners come into play, and there are many to choose from. But again, given the nature of shtk and its desire to blend into Unix-y environments, integrating with the de-facto build system of all foundational software is important. So, yes, shtk tests can run via GNU Automake. The test runner provided by this build system isn&rsquo;t state-of-the-art, but it is more than enough for most situations.</p><p>Here is all it takes to hook the earlier <code>demo_test.sh</code> shtk-based test into an Automake project:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-makefile data-lang=makefile><span class=line><span class=cl><span class=nv>TESTS</span> <span class=o>=</span> demo_test
</span></span><span class=line><span class=cl><span class=nv>check_SCRIPTS</span> <span class=o>=</span> demo_test
</span></span><span class=line><span class=cl><span class=nv>CLEANFILES</span> <span class=o>+=</span> demo_test
</span></span><span class=line><span class=cl><span class=nv>EXTRA_DIST</span> <span class=o>+=</span> demo_test.sh
</span></span><span class=line><span class=cl><span class=nf>demo_test</span><span class=o>:</span> <span class=k>$(</span><span class=nv>srcdir</span><span class=k>)</span>/<span class=n>demo_test</span>.<span class=n>sh</span>
</span></span><span class=line><span class=cl>        <span class=k>$(</span>AM_V_GEN<span class=k>)</span>shtk build -m shtk_unittest_main -o <span class=nv>$@</span> $&lt;
</span></span></code></pre></div><p>You&rsquo;d probably want to add a pkg-config check in <code>configure.ac</code> to load the path to shtk from the provided <code>shtk.pc</code> and reference it from here as <code>$(SHTK)</code>, but I&rsquo;ll leave that as an exercise for you, dear reader.</p><p>After that, if we run <code>make check</code>, we&rsquo;ll see something like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>make  check-TESTS
</span></span><span class=line><span class=cl>PASS: demo_test
</span></span><span class=line><span class=cl>============================================================================
</span></span><span class=line><span class=cl>Testsuite summary for Demo
</span></span><span class=line><span class=cl>============================================================================
</span></span><span class=line><span class=cl># TOTAL: 1
</span></span><span class=line><span class=cl># PASS:  1
</span></span><span class=line><span class=cl># SKIP:  0
</span></span><span class=line><span class=cl># XFAIL: 0
</span></span><span class=line><span class=cl># FAIL:  0
</span></span><span class=line><span class=cl># XPASS: 0
</span></span><span class=line><span class=cl># ERROR: 0
</span></span><span class=line><span class=cl>============================================================================
</span></span></code></pre></div><p>Neat. Take a look at the <a href=https://www.gnu.org/software/automake/manual/html_node/Tests.html>test suites documentation for GNU Automake</a> for more details on how to communicate specific return codes (such as &ldquo;skip&rdquo;) to the runner.</p><h1 id=integrating-with-bazel>Integrating with Bazel</h1><p>GNU Automake is the de-facto build system for open source projects but it&rsquo;s also&mldr; far from great. This is why I <a href=/2022/05/remembering-buildtool.html>created Buildtool eons ago</a> and why I got interested in Bazel in the first place. So the question is: can we integrate shtk with Bazel? Of course we can!</p><p>For the purposes of this post, I hacked up a Bazel rule to show off how running shtk tests with it would look like. And it looks exactly like you would expect:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>load</span><span class=p>(</span><span class=s2>&#34;shtk.bzl&#34;</span><span class=p>,</span> <span class=s2>&#34;shtk_test&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>shtk_test</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>name</span> <span class=o>=</span> <span class=s2>&#34;demo_test&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>src</span> <span class=o>=</span> <span class=s2>&#34;demo_test.sh&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></div><p>Followed by:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>$ bazel test --test_output=streamed :faulty_test
</span></span><span class=line><span class=cl>WARNING: Streamed test output requested. All tests will be run locally, without sharding, one at a time
</span></span><span class=line><span class=cl>INFO: Analyzed target //:faulty_test (0 packages loaded, 2 targets configured).
</span></span><span class=line><span class=cl>INFO: Found 1 test target...
</span></span><span class=line><span class=cl>faulty_test: I: Testing faulty...
</span></span><span class=line><span class=cl>faulty_test: E: This test fails
</span></span><span class=line><span class=cl>faulty_test: W: Testing faulty... FAILED
</span></span><span class=line><span class=cl>faulty_test: W: Ran 1 tests; 1 FAILED
</span></span><span class=line><span class=cl>FAIL: //:faulty_test (see /home/jmmv/.cache/bazel/_bazel_jmmv/828d51923bded9f03acff0119df51adc/execroot/demo/bazel-out/k8-fastbuild/testlogs/faulty_test/test.log)
</span></span><span class=line><span class=cl>Target //:faulty_test up-to-date:
</span></span><span class=line><span class=cl>  bazel-bin/faulty_test
</span></span><span class=line><span class=cl>INFO: Elapsed time: 0.355s, Critical Path: 0.14s
</span></span><span class=line><span class=cl>INFO: 2 processes: 2 linux-sandbox.
</span></span><span class=line><span class=cl>INFO: Build completed, 1 test FAILED, 2 total actions
</span></span><span class=line><span class=cl>//:faulty_test                                                           FAILED in 0.0s
</span></span><span class=line><span class=cl>  /home/jmmv/.cache/bazel/_bazel_jmmv/828d51923bded9f03acff0119df51adc/execroot/demo/bazel-out/k8-fastbuild/testlogs/faulty_test/test.log
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Executed 1 out of 1 test: 1 fails locally.
</span></span></code></pre></div><p>Some of the benefits of the Bazel test runner over GNU Automake&rsquo;s are that Bazel adds proper test isolation and cleanup via its local sandboxing feature and that Bazel provides fine-grained test invalidation when dependencies change. These are the two primary properties you want in a modern test runner because they ensure that only the minimum subset of tests run on a given source code change, and that the test results are deterministic across invocations and machines.</p><h1 id=the-future>The future</h1><p>Despite its many haters, the shell is a pretty OK language <em>if you treat it as such</em>. You must learn its syntax and its oddities, but once you do, you can write maintainable and moderately-long programs that are, often enough, much simpler than their Python counterparts. These programs have few dependencies and, given sufficient test coverage, can be as robust as other tools. shtk is just an ingredient that can help you in writing such large scripts in a principled manner and, especially, in testing them.</p><p>As for what the future will bring for shtk&mldr; <strong>you tell me!</strong> I had not worked on this project for 6 years and absolutely nobody asked about it during this time. But&mldr; things have changed a lot since then and there might actually be some interest out there. In preparation for this blog post, I migrated shtk&rsquo;s CI system from Travis to GitHub Actions, created a simple website to serve the API documentation&mdash;which was previously locked behind <code>man</code> invocations in a terminal&mdash;and moved off from Kyua to GNU Automake as the test runner for simplicity.</p><p>Some ideas about what could be done: additional library modules/functions; a &ldquo;static build&rdquo; feature where the built scripts don&rsquo;t require shtk to be pre-installed; and real Bazel rules (what I showed above was a macro-based hack) to incorporate shtk into your projects so that you can test your command-line tools end-to-end no matter what language they are written in.</p><p>Please let me know if you have any interest by either voting/replying below or reaching out via social media! And don&rsquo;t forget to visit the brand-new homepage at <a href=https://shtk.jmmv.dev/>https://shtk.jmmv.dev/</a> to read the documentation.</p></article></div></div><div class="container post-links"><div class=row><div class="col mr-auto text-left"><span><a href=https://jmmv.dev/2023/10/analyzing-ooms-in-intellij-with-bazel.html>&#171; Previous</a></span></div><div class="col text-center"><span><a href=/archive.html>All posts</a></span></div><div class="col ml-auto text-right"><span><a href=https://jmmv.dev/2023/10/hello-blog-system5.html>Next &#187;</a></span></div></div></div><div class="container post-votes"><div class=row><div class="col-lg-4 my-2"><div class=row><div class=col><a onclick=voteThumbsUp() class="btn btn-block btn-outline-success" id=thumbs-up-btn>👍
(<span id=thumbs-up-count>0</span>)</a></div><div class=col><a onclick=voteThumbsDown() class="btn btn-block btn-outline-danger" id=thumbs-down-btn>👎
(<span id=thumbs-down-count>0</span>)</a></div></div></div><div class="col-lg-8 my-2 d-none d-sm-block"><div class=row><div class="col-md-4 text-center"><a href="https://www.reddit.com/submit?title=Unit-testing+shell+scripts+and+tools+with+shtk&amp;url=https%3A%2F%2Fjmmv.dev%2F2023%2F10%2Funit-testing-with-shtk.html" class="btn btn-block btn-outline-primary">Share on
<img src=/images/badges/reddit.png alt=Reddit width=24 height=24></a></div><div class="col-md-4 text-center"><a href="https://news.ycombinator.com/submitlink?t=Unit-testing+shell+scripts+and+tools+with+shtk&amp;u=https%3A%2F%2Fjmmv.dev%2F2023%2F10%2Funit-testing-with-shtk.html" class="btn btn-block btn-outline-primary">Share on
<img src=/images/badges/ycombinator.png alt="Hacker News" width=24 height=24></a></div><div class="col-md-4 text-center"><a href="https://twitter.com/intent/tweet?status=Unit-testing+shell+scripts+and+tools+with+shtk+%E2%80%94+https%3A%2F%2Fjmmv.dev%2F2023%2F10%2Funit-testing-with-shtk.html+%E2%80%94+cc+%40jmmv" class="btn btn-block btn-outline-primary">Share on
<img src=/images/badges/Twitter_Social_Icon_Circle_Color.png alt=Twitter width=24 height=24></a></div></div></div></div><div class="row my-4" id=postCommentRow><div class=col><div class=media><img class=mr-3 src=/octicons/pencil.svg width=32px height=32px><div class="media-body container"><form method=post id=newPost><div class=row><div class="col my-1"><textarea class=form-control rows=1 id=postCommentContent onclick=showPostComment() placeholder="Leave a comment"></textarea></div></div><div class="row newPostControls" style=display:none><div class="col my-1 form-group"><label for=postCommentAuthor>Your name (optional):</label>
<input type=text class=form-control id=postCommentAuthor></div></div><div class="row newPostControls" style=display:none><div class="col my-1 form-group"><label for=postCommentEmail>Your email (optional):</label>
<input type=text class=form-control type=email id=postCommentEmail>
<small class="form-text text-muted">Invisible to all readers; if provided, you will receive notifications when replied to (not implemented yet)</small></div></div><div class=row id=postCommentError style=display:none><div class="col mt-1 alert-danger"><p></p></div></div><div class="row newPostControls" style=display:none><button class="col-md-3 my-1 btn btn-primary" type=submit id=submitCommentButton>Post</button>
<small class="col-md-9 my-1 text-muted">Comments are subject to moderation. This feature is experimental and is powered by <a href=/software/endtracker.html>EndTRACKER</a>. If you experience any issues, please <a href=/about.html#contact>contact me off-band</a>.</small></div></form></div></div></div></div><script>function hidePostComment(){var t,e=document.getElementById("postCommentContent");e.rows=1,e.value="",t=document.getElementsByClassName("newPostControls"),Array.prototype.forEach.call(t,function(e){e.style.display="none"})}function showPostComment(){var e,t=document.getElementById("postCommentContent");t.rows=5,e=document.getElementsByClassName("newPostControls"),Array.prototype.forEach.call(e,function(e){e.style.display=""})}const form=document.querySelector("#newPost");form.onsubmit=function(e){e.preventDefault();let t=document.getElementById("postCommentAuthor").value,n=document.getElementById("postCommentEmail").value,s=document.getElementById("postCommentContent").value;postComment(t,n,s,hidePostComment)}</script></div></div><div class="col-md-3 sidebar d-none d-md-block"><div class=row><div class="col text-center p-2"><p><a href=/about.html class=clear-link><img src=/images/avatars/20181124-snow.jpg class="rounded-circle shadow my-2" style=width:100px><br><b>Julio Merino</b><br>A blog on operating systems, programming languages, testing, build systems, my own software
projects and even personal productivity. Specifics include FreeBSD, Linux, Rust, Bazel and
EndBASIC.</a></p><div class=row><div class=col><div class=form-group><form action=https://endtracker.azurewebsites.net/api/sites/e8da9f62-b7ac-4fe9-bf20-7c527199a376/subscribers/add method=post><input type=text name=email placeholder="Enter your email" class="form-control input-sm text-center my-1">
<button type=submit class="btn btn-primary btn-block my-1">Subscribe</button></form></div></div></div><div class="row px-2"><div class="col-sm-5 text-left"><small><span class=subscriber-count>0</span> subscribers</small></div><div class="col-sm-7 text-right"><p><a rel=me href=https://mastodon.online/@jmmv><img src=/images/badges/mastodon-logo.svg width=32px height=32px alt="Follow @jmmv on Mastodon"></a>
<a href="https://twitter.com/intent/follow?original_referer=https%3A%2F%2Fjmmv.dev%2F&amp;screen_name=jmmv"><img src=/images/badges/Twitter_logo_blue.svg width=32px height=32px alt="Follow @jmmv on Twitter"></a>
<a href=/feed.xml><img src=/images/badges/feed-icon-28x28.png alt="RSS feed"></a></p></div></div></div></div><div class=row><div class=col><h2>Featured software</h2><ul><li class=overflow-ellipsis><a href=https://www.endbasic.dev/ target=_blank>EndBASIC: Online BASIC+DOS env</a></li><li class=overflow-ellipsis><a href=https://endtracker.azurewebsites.net/ target=_blank>EndTRACKER: Services for static sites</a></li></ul></div></div><div class=row><div class=col><h2>Featured posts</h2><ul><li class=overflow-ellipsis><a href=/2023/06/fast-machines-slow-machines.html>Fast machines, slow machines</a></li><li class=overflow-ellipsis><a href=/2022/12/endbasic-0.10.html>EndBASIC 0.10: Core language, evolved</a></li><li class=overflow-ellipsis><a href=/2022/10/bye-microsoft-hi-snowflake.html>Farewell, Microsoft; hello, Snowflake!</a></li><li class=overflow-ellipsis><a href=/2022/05/rust-is-hard-but-does-it-matter.html>Rust is hard, yes, but does it matter?</a></li><li class=overflow-ellipsis><a href=/2022/04/rust-traits-and-dependency-injection.html>Rust traits and dependency injection</a></li><li class=overflow-ellipsis><a href=/2022/03/a-year-on-windows-intro.html>A year on Windows: Introduction</a></li><li class=overflow-ellipsis><a href=/2021/04/always-be-quitting.html>Always be quitting</a></li><li class=overflow-ellipsis><a href=/2021/02/google-monorepos-and-caching.html>How does Google keep build times low?</a></li><li class=overflow-ellipsis><a href=/2020/12/google-no-clean-builds.html>How does Google avoid clean builds?</a></li><li class=overflow-ellipsis><a href=/2020/12/unit-testing-a-console-app.html>Unit-testing a console app (a text editor)</a></li><li class=overflow-ellipsis><a href=/essays.html#featured>More...</a></li></ul></div></div></div></div></div><footer class=container><div class=row><div class="col-4 order-2 texr-right"><p class=float-right><a href=#>Back to top</a></p></div><div class="col-8 order-1 mr-auto"><p>Copyright 2004&ndash;2023 Julio Merino</p></div></div></footer><script type=module>
  import { addAnchorsToHeaders, addElementClasses, BatchClient } from "\/js\/main.d30f168b11d80082408f4a983af9a626c6e57d58f7846b2174bac40d43be33e3.js";

  var batchClient = new BatchClient(SITE_ID);
  batchClient.doAll({
    put_request: true, get_comments: true, get_subscriber_count: true, get_votes: true });

  window.voteThumbsUp = function() { batchClient.voteThumbsUp(); }
  window.voteThumbsDown = function() { batchClient.voteThumbsDown(); }

  window.postComment = function(...args) {
    batchClient.postComment(...args);
  };

  addAnchorsToHeaders();
  addElementClasses();
</script><noscript><img src="https://hugo-dynamic.jmmv.dev/api/sites/e8da9f62-b7ac-4fe9-bf20-7c527199a376/pages/aHR0cHM6Ly9qbW12LmRldi8yMDIzLzEwL3VuaXQtdGVzdGluZy13aXRoLXNodGsuaHRtbA==/stamp.gif" style=display:none></noscript></body></html>