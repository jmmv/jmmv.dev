<!doctype html><html lang=en xmlns=http://www.w3.org/1999/xhtml xmlns:fb=http://ogp.me/ns/fb#><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta property="og:site_name" content="Julio Merino (jmmv.dev)"><meta property="twitter:site" content="@jmmv"><title>5 ways to instantiate Rust structs in tests - Julio Merino (jmmv.dev)</title><meta property="og:title" content="5 ways to instantiate Rust structs in tests - Julio Merino (jmmv.dev)"><meta property="twitter:title" content="5 ways to instantiate Rust structs in tests - Julio Merino (jmmv.dev)"><meta name=description content="I&amp;rsquo;m a big fan of static typing and I&amp;rsquo;ve found that using narrow types for each entity in the object model of my programs reduces errors. Rust is particularly well-suited at this task: its lack of implicit type conversions eliminates surprises, and its ownership semantics allow type transformations with zero cost.
Unfortunately, (ab)using narrow types in an app&amp;rsquo;s domain is really annoying when writing tests. While non-test code rarely instantiates new objects&amp;mdash;in the case of a REST service, this would only happen at the service&amp;rsquo;s boundaries&amp;mdash;tests instantiate objects infinitely more times than non-test code. Code patterns that may seem reasonable in non-test code can become unbearable in tests.
In this post, I want to look into the various ways in which you can instantiate strongly-typed objects. For each, I show examples and describe their pros and cons. And yes, as a matter of fact, I have tried them all before&amp;hellip; and I can&amp;rsquo;t yet make my mind as to which one is best.
"><meta property="og:description" content="I&amp;rsquo;m a big fan of static typing and I&amp;rsquo;ve found that using narrow types for each entity in the object model of my programs reduces errors. Rust is particularly well-suited at this task: its lack of implicit type conversions eliminates surprises, and its ownership semantics allow type transformations with zero cost.
Unfortunately, (ab)using narrow types in an app&amp;rsquo;s domain is really annoying when writing tests. While non-test code rarely instantiates new objects&amp;mdash;in the case of a REST service, this would only happen at the service&amp;rsquo;s boundaries&amp;mdash;tests instantiate objects infinitely more times than non-test code. Code patterns that may seem reasonable in non-test code can become unbearable in tests.
In this post, I want to look into the various ways in which you can instantiate strongly-typed objects. For each, I show examples and describe their pros and cons. And yes, as a matter of fact, I have tried them all before&amp;hellip; and I can&amp;rsquo;t yet make my mind as to which one is best.
"><meta property="twitter:description" content="I&amp;rsquo;m a big fan of static typing and I&amp;rsquo;ve found that using narrow types for each entity in the object model of my programs reduces errors. Rust is particularly well-suited at this task: its …"><meta name=author content="Julio Merino"><meta property="twitter:creator" content="@jmmv"><meta name=generator content="Hugo 0.111.3"><meta property="og:url" content="https://jmmv.dev/2023/10/rust-test-structs.html"><meta property="og:type" content="blog"><meta property="twitter:card" content="summary"><link rel=canonical href=https://jmmv.dev/2023/10/rust-test-structs.html><link rel=alternate type=application/rss+xml title="Julio Merino (jmmv.dev)" href=/feed.xml><link rel=stylesheet href=/sass/main.min.161663676cac4bf21abc8967ec3267c26026aa58e9f392c5f3427e0ef089fe6b.css><link rel=stylesheet href=/css/chroma.css><link rel=icon type=image/png href=/images/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/images/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicons/favicon-96x96.png sizes=96x96><meta property="og:image" content="/images/2023-10-06-rust-test-structs.png"><meta property="twitter:image" content="https://jmmv.dev/images/2023-10-06-rust-test-structs.png"><meta property="og:image:alt" content="Brief list of the 5 different options presented in this post using a placeholder MyType struct with three fields."><meta property="twitter:image:alt" content="Brief list of the 5 different options presented in this post using a placeholder MyType struct with three fields."><script>const SITE_ID="e8da9f62-b7ac-4fe9-bf20-7c527199a376",BASE_URL="https://jmmv.dev/"</script></head><body><header class=site-header><nav class="navbar navbar-expand-lg fixed-top navbar-dark bg-primary"><a class=navbar-brand href=/><img src=/images/favicons/favicon-30x30.png width=30 height=30 class="d-inline-block align-top" alt>
&nbsp;Julio Merino</a>
<button class=navbar-toggler type=button data-toggle=collapse data-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarSupportedContent><ul class="navbar-nav mr-auto"><li class=nav-item><a class=nav-link href=/about.html>About</a></li><li class=nav-item><a class=nav-link href=/essays.html>Essays</a></li><li class=nav-item><a class=nav-link href=/resume.html>Resume</a></li><li class=nav-item><a class=nav-link href=/software.html>Software</a></li></ul><ul class="navbar-nav mr-4"><li class=nav-item><a class=nav-link href=/archive.html>Archive</a></li><li class=nav-item><a class=nav-link href=/series.html>Series</a></li><li class=nav-item><a class=nav-link href=/tags.html>Tags</a></li></ul><form class=form-inline method=get role=search action=https://www.google.com/search><div class=input-group><input type=search name=query class=form-control placeholder=Search aria-label=Search><div class=input-group-append><button type=submit value=Search class="btn btn-light">
<img src=/octicons/search.svg></button></div></div><input type=hidden name=sitesearch value=https://jmmv.dev/></form></div></nav></header><div class=page-header><div class=container><h1>5 ways to instantiate Rust structs in tests</h1><p>October 6, 2023 &#183;
About 10 minutes
&#183;
Tags:
<a href=/tags/programming>programming</a>, <a href=/tags/readability>readability</a>, <a href=/tags/rust>rust</a></p><figure class=cover-image><img src=/images/2023-10-06-rust-test-structs.png width=100%><figcaption>Brief list of the 5 different options presented in this post using a placeholder MyType struct with three fields.</figcaption></figure></div></div><div class="container post-body"><div class=row><div class=col-md-9><div class=row><div class=col><article><p>I&rsquo;m a big fan of static typing and I&rsquo;ve found that using narrow types for each entity in the object model of my programs reduces errors. Rust is particularly well-suited at this task: its lack of implicit type conversions eliminates surprises, and its ownership semantics allow type transformations with zero cost.</p><p>Unfortunately, (ab)using narrow types in an app&rsquo;s domain is <em>really</em> annoying when writing tests. While non-test code rarely instantiates new objects&mdash;in the case of a REST service, this would only happen at the service&rsquo;s boundaries&mdash;tests instantiate objects infinitely more times than non-test code. Code patterns that may seem reasonable in non-test code can become unbearable in tests.</p><p>In this post, I want to look into the various ways in which you can instantiate strongly-typed objects. For each, I show examples and describe their pros and cons. And yes, as a matter of fact, I have tried them all before&mldr; and I can&rsquo;t yet make my mind as to which one is best.</p><div class="container action-highlight p-4 my-4 d-md-none"><div class="row text-center"><p>A blog on operating systems, programming languages, testing, build systems, my own software
projects and even personal productivity. Specifics include FreeBSD, Linux, Rust, Bazel and
EndBASIC.</p></div><div class=row><div class=col><div class=form-group><form action=https://endtracker.azurewebsites.net/api/sites/e8da9f62-b7ac-4fe9-bf20-7c527199a376/subscribers/add method=post><input type=text name=email placeholder="Enter your email" class="form-control input-sm text-center my-1">
<button type=submit class="btn btn-primary btn-block my-1">Subscribe</button></form></div></div></div><div class="row px-2"><div class="col col-sm-5 text-left"><small><span class=subscriber-count>0</span> subscribers</small></div><div class="col col-sm-7 text-right"><p><a rel=me href=https://mastodon.online/@jmmv><img src=/images/badges/mastodon-logo.svg width=32px height=32px alt="Follow @jmmv on Mastodon"></a>
<a href="https://twitter.com/intent/follow?original_referer=https%3A%2F%2Fjmmv.dev%2F&amp;screen_name=jmmv"><img src=/images/badges/Twitter_logo_blue.svg width=32px height=32px alt="Follow @jmmv on Twitter"></a>
<a href=/feed.xml><img src=/images/badges/feed-icon-28x28.png alt="RSS feed"></a></p></div></div></div><h1 id=context-setting>Context-setting</h1><p>Let me introduce you to the <code>Comment</code> type from the EndTRACKER codebase&mdash;a type that represents a textual comment that someone left on a webpage. I&rsquo;ve simplified it a little for illustration purposes, but the core properties of the type remain:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>struct</span> <span class=nc>Comment</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>site_id</span>: <span class=nc>Uuid</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>path</span>: <span class=nc>Url</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>timestamp</span>: <span class=nc>OffsetDateTime</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>content</span>: <span class=nb>String</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>author</span>: <span class=nb>Option</span><span class=o>&lt;</span><span class=nb>String</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>email</span>: <span class=nb>Option</span><span class=o>&lt;</span><span class=n>EmailAddress</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>Said core properties are:</p><ul><li><p>Four required fields for every comment: <code>site_id</code>, <code>path</code>, <code>timestamp</code> and <code>content</code>.</p></li><li><p>Two optional fields that are only present if the user writing the comment chose to provide them: <code>author</code> and <code>email</code>.</p></li><li><p>Strongly-typed fields. Note that only two of them are raw strings; the rest are <em>narrower</em> types that enforce structure on their values.</p><p>This is important because, for example, while URLs can be represented as strings, they are <em>not</em> strings. The domain of all possible URLs is narrower than the domain of all possible strings because URLs have internal structure. Using a narrow type to represent URLs enforces that, once a URL object exists, we can pass it around and all consumers can assume it has undergone proper validation.</p><p>Note that strong typing can be done in pretty much any language, really, but Rust shines here. It also helps that using narrow types is common practice in this language: in JavaScript, for example, the above would probably have been represented as a loosely-typed <code>Object</code>; and in Python, it would have been shoehorned into a string-to-whatever dictionary.</p></li></ul><p>Let&rsquo;s look at the ways in which <code>Comment</code> objects can be constructed. Remember that I&rsquo;m focusing on object creation as part of tests. For this reason, it is not necessary to propagate errors to the caller: panicking internally to fail the test is just fine, which simplifies the design a lot.</p><h1 id=option-1-struct-literals>Option 1: Struct literals</h1><p>In the most simple form, a test instantiates a <code>Comment</code> object by specifying <em>all</em> fields:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=kd>let</span><span class=w> </span><span class=n>comment</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Comment</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>site_id</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>path</span>: <span class=nc>url</span><span class=o>!</span><span class=p>(</span><span class=s>&#34;http://example.com/post.html&#34;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>timestamp</span>: <span class=nc>datetime</span><span class=o>!</span><span class=p>(</span><span class=mi>2023</span><span class=o>-</span><span class=mi>10</span><span class=o>-</span><span class=mi>03</span><span class=w> </span><span class=mi>19</span>:<span class=mi>25</span>:<span class=mi>00</span><span class=w> </span><span class=no>UTC</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>content</span>: <span class=s>&#34;Irrelevant text&#34;</span><span class=p>.</span><span class=n>to_owned</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>author</span>: <span class=nb>Some</span><span class=p>(</span><span class=s>&#34;The Author&#34;</span><span class=p>.</span><span class=n>to_owned</span><span class=p>()),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>email</span>: <span class=nb>Some</span><span class=p>(</span><span class=s>&#34;the-email@example.com&#34;</span><span class=p>.</span><span class=n>into</span><span class=p>()),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>};</span><span class=w>
</span></span></span></code></pre></div><p>Pros:</p><ul><li><p><strong>Clarity.</strong> It&rsquo;s painfully obvious what each field contains in every test object.</p></li><li><p><strong>Refactor-proof.</strong> When modifying the <code>Comment</code> definition, you are forced to revise all places where the object is constructed. This makes you reassess whether existing tests need to care about the changes or not.</p></li></ul><p>Cons:</p><ul><li><p><strong>Lack of conciseness.</strong> Not all tests care about all possible fields of a type. Some tests may want to validate ordering, in which case they care about specific <code>timestamp</code> values, whereas other tests may want to check protections against HTML injection, in which case they care about <code>content</code>. But this is not clear in the test because the test is forced to specify values for all fields even if they are irrelevant.</p></li><li><p><strong>Refactoring difficulties.</strong> Even though I listed refactoring in the pros, refactoring is also a con. Having to adjust tens or hundreds of tests every time the struct definition changes is a daunting task, particularly when, in general, existing tests do not care about new fields.</p></li></ul><h1 id=option-2-the-default-trait>Option 2: The Default trait</h1><p>The standard answer to the cons listed above is to implement <code>Default</code> for the type and thus rely on default values for all fields that are irrelevant in a given context. Ideally, by deriving or implementing <code>Default</code>, we would do something like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=kd>let</span><span class=w> </span><span class=n>comment</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Comment</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>site_id</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>path</span>: <span class=nc>url</span><span class=o>!</span><span class=p>(</span><span class=s>&#34;http://example.com/post.html&#34;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>..</span><span class=nb>Default</span>::<span class=nb>Default</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>};</span><span class=w>
</span></span></span></code></pre></div><p>Unfortunately, this does not work other than for trivial structs. The problem here is that not all types in the <code>Comment</code> struct implement <code>Default</code>, and this problem compounds with any additional type you nest. In this particular example, a <code>Url</code> cannot be empty and an <code>OffsetDateTime</code> does not have a reasonable zero value.</p><p>One possible solution to this issue is fabricate fake values for all fields. To do this, you can rely on the <code>derivative</code> crate and use it to supply alternate default values for those fields that don&rsquo;t have one of their own. It is critical to do this <em>only</em> for debug builds so that these fake definitions never taint production. Here is how this would look like:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=cp>#[cfg_attr(test, derive(Derivative))]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[cfg_attr(test, derivative(Default))]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>struct</span> <span class=nc>Comment</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cp>#[cfg_attr(test, derivative(Default(value = </span><span class=s>&#34;Uuid::new_v4()&#34;</span><span class=cp>)))]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>site_id</span>: <span class=nc>Uuid</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cp>#[cfg_attr(test, derivative(Default(value = r#</span><span class=s>&#34;url!(&#34;</span><span class=cp>https://UNSET/</span><span class=s>&#34;)&#34;</span><span class=cp>#)))]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>path</span>: <span class=nc>Url</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cp>#[cfg_attr(test, derivative(Default(value = </span><span class=s>&#34;OffsetDateTime::UNIX_EPOCH&#34;</span><span class=cp>)))]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>timestamp</span>: <span class=nc>OffsetDateTime</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cp>#[cfg_attr(test, derivative(Default(value = r#</span><span class=s>&#34;&#34;</span><span class=cp>Irrelevant</span><span class=s>&#34;.to_owned()&#34;</span><span class=cp>#)))]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>content</span>: <span class=nb>String</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>author</span>: <span class=nb>Option</span><span class=o>&lt;</span><span class=nb>String</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>email</span>: <span class=nb>Option</span><span class=o>&lt;</span><span class=n>EmailAddress</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>With this, the above instantiation of a <code>Comment</code> with partial defaults becomes possible.</p><p>Pros:</p><ul><li><p><strong>Concise and refactor-friendly.</strong> Tests can now declare objects with only the few properties they care about. Due to this, adding new fields to the <code>Comment</code> struct does not require modifying the majority of existing tests.</p></li><li><p><strong>Standard.</strong> Deriving <code>Default</code> is a common idiom in Rust, so this leads to few surprises.</p></li></ul><p>Cons:</p><ul><li><p><strong>Complexity.</strong> The type definitions are quite convoluted, particularly due to the need to couple these fake values to debug builds only.</p></li><li><p><strong>Noisy.</strong> Having to call <code>..Default::default()</code> each time we instantiate a struct is annoying and adds a lot of visual noise.</p></li></ul><h1 id=option-3-macros>Option 3: Macros</h1><p>Using macros to instantiate test data is a common idiom in Rust: the macros provide a simpler syntax to instantiate objects and they forcibly unwrap result values because it&rsquo;s OK to panic tests on invalid data. In fact, note that in the above examples I&rsquo;ve already used two macros: <code>url!</code> to construct <code>Url</code> values from hardcoded strings assumed to be valid, and <code>datetime!</code> to construct <code>OffsetDateTime</code> values from a readable mini-DSL.</p><p>We could define a <code>comment!</code> macro that allowed &ldquo;keyword-like&rdquo; arguments to instantiate a test <code>Comment</code> object, like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=kd>let</span><span class=w> </span><span class=n>comment</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=fm>comment!</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>site_id</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>path</span>: <span class=nc>url</span><span class=o>!</span><span class=p>(</span><span class=s>&#34;http://example.com/post.html&#34;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><p>Pros:</p><ul><li><strong>Concise.</strong> Same as the <code>Default</code> approach: tests only declare the properties they must declare for the test to pass.</li></ul><p>Cons:</p><ul><li><strong>Refactoring-unfriendly.</strong> The Rust auto-formatter does not reformat code inside macros. I rely on this feature too much these days because it&rsquo;s very liberating to not have to care about manual formatting, so this is a non-option for me.</li></ul><h1 id=option-4-the-builder-pattern>Option 4: The builder pattern</h1><p>The next possibility is to use the builder pattern, which I have <a href=/2020/12/builder-pattern-for-tests.html>previously leveraged to define declarative tests</a>. Constructing a <code>Comment</code> would then look something like this and, in fact, that&rsquo;s what I had in the code for a little while:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=kd>let</span><span class=w> </span><span class=n>comment</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>CommentBuilder</span>::<span class=n>new</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>site_id</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>url!</span><span class=p>(</span><span class=s>&#34;https://example.com/page.html&#34;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>datetime!</span><span class=p>(</span><span class=mi>2023</span><span class=o>-</span><span class=mi>10</span><span class=o>-</span><span class=mi>03</span><span class=w> </span><span class=mi>19</span>:<span class=mi>25</span>:<span class=mi>00</span><span class=w> </span><span class=no>UTC</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s>&#34;Irrelevant text&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>.</span><span class=n>unwrap</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>.</span><span class=n>with_author</span><span class=p>(</span><span class=s>&#34;The author&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>.</span><span class=n>unwrap</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>.</span><span class=n>with_email</span><span class=p>(</span><span class=s>&#34;the-email@example.com&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>.</span><span class=n>unwrap</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>.</span><span class=n>build</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></div><p>This usage of a builder is a bit unorthodox and&mldr; really ugly: the constructor takes positional arguments for all required fields and the various setters return errors when the input values cannot be converted to the inner types that back them. These design decisions came from the fact that I used this builder in non-test code too, so errors had to be propagated.</p><p>But this is not the only way to define a builder. A more traditional application of the builder pattern would result in:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=kd>let</span><span class=w> </span><span class=n>comment</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>CommentBuilder</span>::<span class=n>default</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=n>site_id</span><span class=p>(</span><span class=n>site_id</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=n>url</span><span class=p>(</span><span class=fm>url!</span><span class=p>(</span><span class=s>&#34;https://example.com/page.html&#34;</span><span class=p>)))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=n>timestamp</span><span class=p>(</span><span class=fm>datetime!</span><span class=p>(</span><span class=mi>2023</span><span class=o>-</span><span class=mi>10</span><span class=o>-</span><span class=mi>03</span><span class=w> </span><span class=mi>19</span>:<span class=mi>25</span>:<span class=mi>00</span><span class=w> </span><span class=no>UTC</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=n>content</span><span class=p>(</span><span class=s>&#34;Irrelevant text&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=n>author</span><span class=p>(</span><span class=s>&#34;The author&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=n>email</span><span class=p>(</span><span class=s>&#34;the-email@example.com&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=n>build</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=n>unwrap</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></div><p>This second version of the pattern looks better in general (and you could argue that the original version was a mistake). So let&rsquo;s analyze this second version.</p><p>Pros:</p><ul><li><p><strong>Automatic type conversions.</strong> The setters can <a href=/2020/04/rust-into-trait.html>leverage <code>Into</code></a> and <code>AsRef</code>, making it possible to call them quite naturally without needing to create auxiliary types by hand. Note how, for example, <code>email()</code> takes a string even if the backing type is <code>EmailAddress</code> because the setter accepts <code>Into&lt;EmailAddress></code> and the type implements <code>From&lt;&'static str></code> (in test builds <em>only</em>).</p></li><li><p><strong>Conciseness.</strong> As is the case for the <code>Default</code> and the macro options, this solution also accepts specifying only the fields that are required for each test. The builder can set defaults for everything else.</p></li></ul><p>Cons:</p><ul><li><p><strong>Verbosity.</strong> This is no simpler than the <code>Default</code> option and requires non-trivial code to implement the builder itself.</p></li><li><p><strong>Delayed validation.</strong> Delaying validation until the call to <code>build()</code> isn&rsquo;t always easy. Consider <code>email</code> again: if we make the <code>email()</code> setter construct the internal <code>EmailAddress</code> object, then <code>email()</code> has to either return an error (a requirement for production usage) or panic (if the builder is exclusively for tests). But if we try to delay error reporting until <code>build()</code> is called, then the setter cannot leverage <code>Into</code> and needs to either accept strings alone or already-constructed <code>EmailAddress</code> objects.</p></li></ul><h1 id=option-5-helper-functions>Option 5: Helper functions</h1><p>The final possibility is to define helper functions to instantiate our test objects. And if we are defining helper functions, those can do additional work like storing the objects in a database (which is what most of my tests need to do anyway). Here is an example of such a function:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>context</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>TestContext</span>::<span class=n>setup</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>let</span><span class=w> </span><span class=n>comment</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>context</span><span class=p>.</span><span class=n>put_comment</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>site_id</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>url!</span><span class=p>(</span><span class=s>&#34;https://example.com/page.html&#34;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>datetime!</span><span class=p>(</span><span class=mi>2023</span><span class=o>-</span><span class=mi>10</span><span class=o>-</span><span class=mi>03</span><span class=w> </span><span class=mi>19</span>:<span class=mi>25</span>:<span class=mi>00</span><span class=w> </span><span class=no>UTC</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=s>&#34;Hello&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nb>None</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>.</span><span class=k>await</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>Pros:</p><ul><li><strong>Extra logic.</strong> A helper function can take care of instantiating the test object, but can <em>also</em> perform other operations such as persisting the object. For tests, this can turn out to be very useful in encapsulating sequences of operations.</li></ul><p>Cons:</p><ul><li><strong>Inflexibility.</strong> Helper functions sound nice at first because they only take the fewest arguments possible to satisfy the needs of the tests. But things get unwieldy quickly: in the example above, you can already see a wart in the API because there is a confusing <code>None</code> that should probably not be there. This ends happening because different tests need different properties to be set and a single function won&rsquo;t satisfy them all, so you end up with parameterized helper functions that contain superfluous in the common case, or with multiple helper functions targeted at different test scenarios.</li></ul><p>This approach is very tempting to use because declaring new functions is easy and looks simple, but I&rsquo;ve <em>never ever</em> seen it evolve well long-term in any language. Stay away except for the most trivial cases.</p><h1 id=whats-best>What&rsquo;s best?</h1><p>To be honest&mldr; I do not know. I have tried all of the above and I&rsquo;m not completely satisfied with any option. To let you into a secret, the EndTRACKER data model currently contains a mishmash of all these options because I&rsquo;ve been experimenting with new ideas over time and haven&rsquo;t yet settled on the one I like the best. (Yes, yes, I know. Consistency should have trumped &ldquo;prettiness&rdquo;, but hey, I write side projects because I enjoy exploring different dark corners of my tech of choice.)</p><p>Right now my thoughts are these: the builder pattern seems to be the nicest option <em>if</em> you restrict it to tests, because then the builder can encapsulate error unwrapping and callers set all fields by name. However, I&rsquo;m having a hard time justifying this option in favor of the <code>Default</code> option, because callers look equally complex and the builder option requires a lot of boilerplate to write the builders themselves. And I kinda would like to use the macro option, but the fact that it doesn&rsquo;t work well with auto-formatting is a deal breaker.</p><p>What are <em>your</em> thoughts?</p></article></div></div><div class="container post-links"><div class=row><div class="col mr-auto text-left"><span><a href=https://jmmv.dev/2023/09/performance-is-not-big-o.html>&#171; Previous</a></span></div><div class="col text-center"><span><a href=/archive.html>All posts</a></span></div><div class="col ml-auto text-right"><span><a href=https://jmmv.dev/2023/10/unit-testing-with-shtk.html>Next &#187;</a></span></div></div></div><div class="container post-votes"><div class=row><div class="col-lg-4 my-2"><div class=row><div class=col><a onclick=voteThumbsUp() class="btn btn-block btn-outline-success" id=thumbs-up-btn>👍
(<span id=thumbs-up-count>0</span>)</a></div><div class=col><a onclick=voteThumbsDown() class="btn btn-block btn-outline-danger" id=thumbs-down-btn>👎
(<span id=thumbs-down-count>0</span>)</a></div></div></div><div class="col-lg-8 my-2 d-none d-sm-block"><div class=row><div class="col-md-4 text-center"><a href="https://www.reddit.com/submit?title=5+ways+to+instantiate+Rust+structs+in+tests&amp;url=https%3A%2F%2Fjmmv.dev%2F2023%2F10%2Frust-test-structs.html" class="btn btn-block btn-outline-primary">Share on
<img src=/images/badges/reddit.png alt=Reddit width=24 height=24></a></div><div class="col-md-4 text-center"><a href="https://news.ycombinator.com/submitlink?t=5+ways+to+instantiate+Rust+structs+in+tests&amp;u=https%3A%2F%2Fjmmv.dev%2F2023%2F10%2Frust-test-structs.html" class="btn btn-block btn-outline-primary">Share on
<img src=/images/badges/ycombinator.png alt="Hacker News" width=24 height=24></a></div><div class="col-md-4 text-center"><a href="https://twitter.com/intent/tweet?status=5+ways+to+instantiate+Rust+structs+in+tests+%E2%80%94+https%3A%2F%2Fjmmv.dev%2F2023%2F10%2Frust-test-structs.html+%E2%80%94+cc+%40jmmv" class="btn btn-block btn-outline-primary">Share on
<img src=/images/badges/Twitter_Social_Icon_Circle_Color.png alt=Twitter width=24 height=24></a></div></div></div></div><div class="row my-4" id=postCommentRow><div class=col><div class=media><img class=mr-3 src=/octicons/pencil.svg width=32px height=32px><div class="media-body container"><form method=post id=newPost><div class=row><div class="col my-1"><textarea class=form-control rows=1 id=postCommentContent onclick=showPostComment() placeholder="Leave a comment"></textarea></div></div><div class="row newPostControls" style=display:none><div class="col my-1 form-group"><label for=postCommentAuthor>Your name (optional):</label>
<input type=text class=form-control id=postCommentAuthor></div></div><div class="row newPostControls" style=display:none><div class="col my-1 form-group"><label for=postCommentEmail>Your email (optional):</label>
<input type=text class=form-control type=email id=postCommentEmail>
<small class="form-text text-muted">Invisible to all readers; if provided, you will receive notifications when replied to (not implemented yet)</small></div></div><div class=row id=postCommentError style=display:none><div class="col mt-1 alert-danger"><p></p></div></div><div class="row newPostControls" style=display:none><button class="col-md-3 my-1 btn btn-primary" type=submit id=submitCommentButton>Post</button>
<small class="col-md-9 my-1 text-muted">Comments are subject to moderation. This feature is experimental and is powered by <a href=/software/endtracker.html>EndTRACKER</a>. If you experience any issues, please <a href=/about.html#contact>contact me off-band</a>.</small></div></form></div></div></div></div><script>function hidePostComment(){var t,e=document.getElementById("postCommentContent");e.rows=1,e.value="",t=document.getElementsByClassName("newPostControls"),Array.prototype.forEach.call(t,function(e){e.style.display="none"})}function showPostComment(){var e,t=document.getElementById("postCommentContent");t.rows=5,e=document.getElementsByClassName("newPostControls"),Array.prototype.forEach.call(e,function(e){e.style.display=""})}const form=document.querySelector("#newPost");form.onsubmit=function(e){e.preventDefault();let t=document.getElementById("postCommentAuthor").value,n=document.getElementById("postCommentEmail").value,s=document.getElementById("postCommentContent").value;postComment(t,n,s,hidePostComment)}</script></div></div><div class="col-md-3 sidebar d-none d-md-block"><div class=row><div class="col text-center p-2"><p><a href=/about.html class=clear-link><img src=/images/avatars/20181124-snow.jpg class="rounded-circle shadow my-2" style=width:100px><br><b>Julio Merino</b><br>A blog on operating systems, programming languages, testing, build systems, my own software
projects and even personal productivity. Specifics include FreeBSD, Linux, Rust, Bazel and
EndBASIC.</a></p><div class=row><div class=col><div class=form-group><form action=https://endtracker.azurewebsites.net/api/sites/e8da9f62-b7ac-4fe9-bf20-7c527199a376/subscribers/add method=post><input type=text name=email placeholder="Enter your email" class="form-control input-sm text-center my-1">
<button type=submit class="btn btn-primary btn-block my-1">Subscribe</button></form></div></div></div><div class="row px-2"><div class="col-sm-5 text-left"><small><span class=subscriber-count>0</span> subscribers</small></div><div class="col-sm-7 text-right"><p><a rel=me href=https://mastodon.online/@jmmv><img src=/images/badges/mastodon-logo.svg width=32px height=32px alt="Follow @jmmv on Mastodon"></a>
<a href="https://twitter.com/intent/follow?original_referer=https%3A%2F%2Fjmmv.dev%2F&amp;screen_name=jmmv"><img src=/images/badges/Twitter_logo_blue.svg width=32px height=32px alt="Follow @jmmv on Twitter"></a>
<a href=/feed.xml><img src=/images/badges/feed-icon-28x28.png alt="RSS feed"></a></p></div></div></div></div><div class=row><div class=col><h2>Featured software</h2><ul><li class=overflow-ellipsis><a href=https://www.endbasic.dev/ target=_blank>EndBASIC: Online BASIC+DOS env</a></li><li class=overflow-ellipsis><a href=https://endtracker.azurewebsites.net/ target=_blank>EndTRACKER: Services for static sites</a></li></ul></div></div><div class=row><div class=col><h2>Featured posts</h2><ul><li class=overflow-ellipsis><a href=/2023/06/fast-machines-slow-machines.html>Fast machines, slow machines</a></li><li class=overflow-ellipsis><a href=/2022/12/endbasic-0.10.html>EndBASIC 0.10: Core language, evolved</a></li><li class=overflow-ellipsis><a href=/2022/10/bye-microsoft-hi-snowflake.html>Farewell, Microsoft; hello, Snowflake!</a></li><li class=overflow-ellipsis><a href=/2022/05/rust-is-hard-but-does-it-matter.html>Rust is hard, yes, but does it matter?</a></li><li class=overflow-ellipsis><a href=/2022/04/rust-traits-and-dependency-injection.html>Rust traits and dependency injection</a></li><li class=overflow-ellipsis><a href=/2022/03/a-year-on-windows-intro.html>A year on Windows: Introduction</a></li><li class=overflow-ellipsis><a href=/2021/04/always-be-quitting.html>Always be quitting</a></li><li class=overflow-ellipsis><a href=/2021/02/google-monorepos-and-caching.html>How does Google keep build times low?</a></li><li class=overflow-ellipsis><a href=/2020/12/google-no-clean-builds.html>How does Google avoid clean builds?</a></li><li class=overflow-ellipsis><a href=/2020/12/unit-testing-a-console-app.html>Unit-testing a console app (a text editor)</a></li><li class=overflow-ellipsis><a href=/essays.html#featured>More...</a></li></ul></div></div></div></div></div><footer class=container><div class=row><div class="col-4 order-2 texr-right"><p class=float-right><a href=#>Back to top</a></p></div><div class="col-8 order-1 mr-auto"><p>Copyright 2004&ndash;2023 Julio Merino</p></div></div></footer><script type=module>
  import { addAnchorsToHeaders, addElementClasses, BatchClient } from "\/js\/main.d30f168b11d80082408f4a983af9a626c6e57d58f7846b2174bac40d43be33e3.js";

  var batchClient = new BatchClient(SITE_ID);
  batchClient.doAll({
    put_request: true, get_comments: true, get_subscriber_count: true, get_votes: true });

  window.voteThumbsUp = function() { batchClient.voteThumbsUp(); }
  window.voteThumbsDown = function() { batchClient.voteThumbsDown(); }

  window.postComment = function(...args) {
    batchClient.postComment(...args);
  };

  addAnchorsToHeaders();
  addElementClasses();
</script><noscript><img src="https://hugo-dynamic.jmmv.dev/api/sites/e8da9f62-b7ac-4fe9-bf20-7c527199a376/pages/aHR0cHM6Ly9qbW12LmRldi8yMDIzLzEwL3J1c3QtdGVzdC1zdHJ1Y3RzLmh0bWw=/stamp.gif" style=display:none></noscript></body></html>