<!DOCTYPE html>
<html>
  <head>
    

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<!-- The above 3 meta tags *must* come first in the head; any other head
      content must come *after* these tags -->

<meta name="description"
      content="In a dynamically-typed language, it is common for the scoping semantics of a variable to be wider than a single code block.  For example: in at least Python ...">
<meta name="author" content="Julio Merino">

<meta content="http://julio.meroh.net/2013/06/readability-blocks-and-variable-scoping.html" property="og:url">

<link rel="canonical" href="http://julio.meroh.net/2013/06/readability-blocks-and-variable-scoping.html">
<link rel="alternate" type="application/rss+xml" title="Julio Merino" href="http://julio.meroh.net/feed.xml" />

<link rel="stylesheet" href="/css/main.css">

<!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
<!--[if lt IE 9]>
  <script src="/js/html5shiv-3.7.2.min.js"></script>
  <script src="/js/respond-1.4.2.min.js"></script>
<![endif]-->

    <title>Readability: Blocks and variable scoping - Julio Merino</title>
    <meta content="Readability: Blocks and variable scoping - Julio Merino" property="og:title">
  </head>

  <body>
    <header class="site-header">

<nav class="navbar navbar-default navbar-fixed-top">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed"
              data-toggle="collapse" data-target="#navbar"
              aria-expanded="false" aria-controls="navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">Julio Merino</a>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        
          
            
              
                <li><a class="page-link"
                href="/about/"
                >About</a></li>
              
            
          
        
          
            
          
        
          
            
          
        
          
            
              
                <li><a class="page-link"
                href="/essays/"
                >Essays</a></li>
              
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
              
                <li><a class="page-link"
                href="/software/"
                >Software</a></li>
              
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
              
                <li><a class="page-link"
                href="/work/"
                >Work</a></li>
              
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
      </ul>

      <form class="navbar-form navbar-right" method="get" role="search"
            action="http://www.google.com/search">
          <div class="form-group">
            <input type="text" name="query" class="form-control"
                   placeholder="Search">
            <input type="hidden" name="sitesearch" value="http://julio.meroh.net">
          </div>
          <button type="submit" value="Search" class="btn btn-default">
            <span class="glyphicon glyphicon-search" aria-hidden="true"></span>
          </button>
      </form>
    </div>
  </div>
</nav>

</header>


    <div class="page-header">
      <div class="container">
        <h1>Readability: Blocks and variable scoping</h1>

        <p><!-- From http://alanwsmith.com/jekyll-liquid-date-formatting-examples -->

June

6th,
  
2013
at
16:00 UTC
        
        </p>

        
      </div>
    </div>

    <div class="container">
      <article>
        <p>In a dynamically-typed language, it is common for the scoping semantics of a variable to be wider than a single code block.  For example: in at least Python and the shell, it is the case that a variable defined <i>anywhere</i> within a function —even inside conditionals or loops— is reachable anywhere in the function from there on.</p> <p>To illustrate what this means, consider this snippet in which we define a function to compute the CPU requirements needed in a database system to support a set of tables:</p> <pre>def cpu_requirements(database):<br />    disk_bytes, tables_count = calculate_summaries(database)<br />    if disk_bytes &gt; 0:<br />        cpu = cpu_favoring_disk_bytes(disk_bytes)<br />    elif tables_count &gt; 0:<br />        cpu = cpu_favoring_tables_count(tables_count)<br />    else:<br />        cpu = 0<br /><br />    ... various tens of lines of code ...<br /><br />    return cpu + SAFETY_MARGIN</pre> <p>The thing I want you to note in this code snippet is that we are defining the <tt>cpu</tt> variable in all code paths of the conditional and later using the computed value <i>outside</i> the conditional, possibly after tens of lines of code.  Practically, there is nothing wrong with this as long as the code works as intended, but I personally find this style to be confusing: the code does not show the <i>intent</i> of the programmer regarding where a variable is going to be used.</p> <p>As a guideline, define a variable in the outmost block where it is used.  Visually, this means defining the variable at the leftmost indentation level in which it is going to be referenced later.</p> <p>The code above would be rewritten as follows:</p> <pre>def cpu_requirements(tables_info):<br />    disk_bytes, tables_count = calculate_summaries(database)<br />    <b>cpu = None</b><br />    if disk_bytes &gt; 0:<br />        cpu = cpu_favoring_disk_bytes(disk_bytes)<br />    elif tables_count &gt; 0:<br />        cpu = cpu_favoring_tables_count(tables_count)<br />    else:<br />        cpu = 0<br />    <b>assert cpu is not None, 'cpu not defined in a code path'</b><br /><br />    ... various tens of lines of code ...<br /><br />    return cpu + SAFETY_MARGIN</pre> <p>There are two key ideas behind these tiny adjustments:</p> <ul> <li>First, the scope of the <tt>cpu</tt> variable is explicitly declared to be outside of the conditional.  This happens right before entering the alternative code paths, so there is a clear expectation that this variable <i>will</i> be used later on outside of the conditional statement.</li> <li>And second, the expectation that the <tt>cpu</tt> variable has been assigned a value in all possible code paths is explicitly coded by an assertion.  This is important.  Consider that the code in each branch of the conditional could be multiple lines long, and the assignment of a value to our variable might be buried among those lines.  With the assertion, we want to ensure that whatever happens to the contents of the conditional branches in future revisions does not mean that the initialization of the variable is lost (by mistake).</li> </ul> <p>Everything mentioned here applies to loops and other higher-level constructs as well, particularly <tt>try</tt>/<tt>catch</tt> blocks.  Consider this code:</p> <pre>def get_current_user_data():<br />    try:<br />        user_data = helper_module.get_user_data(os.getuid())<br />    except helper_module.UserQueryError, e:<br />        raise BackendError(e)<br /><br />    try:<br />        group_data = helper_module.get_group_data(os.getgid())<br />    except helper_module.GroupQueryError, e:<br />        raise BackendError(e)<br /><br />    return user_data, group_data</pre> <p>The code in this example performs two separate queries via a helper module, and these queries raise exceptions defined in the helper module.  To be self-contained, our <tt>get_current_user_data()</tt> rewrites these exceptions as a generic exception defined in the current module.  The issue, however, is that the variables defined within the <tt>try</tt> block are accessed later separately.  I would instead do:</p> <pre>def get_current_user_data():<br />    <b>user_data = None</b><br />    try:<br />        user_data = helper_module.get_user_data(os.getuid())<br />    except helper_module.UserQueryError, e:<br />        raise BackendError(e)<br />    <b>assert user_data is not None</b><br /><br />    <b>group_data = None</b><br />    try:<br />        group_data = helper_module.get_group_data(os.getgid())<br />    except helper_module.GroupQueryError, e:<br />        raise BackendError(e)<br />    <b>assert group_data is not None</b><br /><br />    return user_data, group_data</pre> <p>Which is very similar to what we did above for conditionals.</p> <p>To wrap everything up, keep these guidelines in mind:</p> <ul><li>Define variables in the outmost block where they are referenced.</li><li>If you don't have a good default value to which to initialize the variable to —because, for example, its value is computed in a conditional path— set it to <tt>None</tt> and later assert that it has been set to something different.</li></ul>

      </article>

      <div class="post-links">
        <p>
          

          
          <a href="http://julipedia.meroh.net/2013/06/readability-blocks-and-variable-scoping.html">Posted on
          The Julipedia</a>
          &middot;
          

          

          <a href="/feed.xml">Subscribe
          via RSS</a>
          &middot;
          <a href="/blog/">Go to posts index</a>
        </p>

        <form class="form-inline"
            action="https://feedburner.google.com/fb/a/mailverify"
            method="post"
            target="popupwindow"
            onsubmit="window.open('https://feedburner.google.com/fb/a/mailverify?uri=jmmv', 'popupwindow', 'scrollbars=yes,width=550,height=520');return true">
          <div class="form-group form-group-sm">
            <input type="text" style="width: 400px" name="email"
                    placeholder="Enter your email to subscribe to new posts"
                    class="form-control input-sm"/>
          </div>
          <button type="submit" value="Subscribe"
                  class="btn btn-default btn-sm">
            <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>
          </button>
          &nbsp;&nbsp;&nbsp;Delivered by
          <input type="hidden" value="jmmv" name="uri"/>
          <input type="hidden" name="loc" value="en_US"/>
          <a href="https://feedburner.google.com" target="_blank">FeedBurner</a>
        </form>
      </div>

      
      <div id="disqus_thread">
        <script>
          var disqus_config = function () {
            this.page.url = "http://julio.meroh.net/2013/06/readability-blocks-and-variable-scoping.html";
            this.page.identifier = "/2013/06/readability-blocks-and-variable-scoping";
          };
          (function() { // DON'T EDIT BELOW THIS LINE
            var d = document, s = d.createElement('script');

            s.src = '//jmmv.disqus.com/embed.js';

            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
          })();
        </script>
        <noscript>Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments
          powered by Disqus.</a>
        </noscript>
      </div>
      
    </div>

    <div class="container">
  <footer>
    <p class="pull-right"><a href="#">Back to top</a></p>
    <p>Copyright 2016 Julio Merino</p>
  </footer>
</div>

<script src="/js/jquery-1.11.2.min.js">
</script>
<script
  src="/css/bootstrap.min.js">
</script>

<script src="/js/auto-toc-1.0.0.dist.js">
</script>

<script>
$("p:contains('NOTE: ')").addClass("callout callout-info");
$("p:contains('IMPORTANT: ')").addClass("callout callout-info");
$("p:contains('WARNING: ')").addClass("callout callout-warning");
$("p:contains('DANGER: ')").addClass("callout callout-danger");
</script>


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;
  m.parentNode.insertBefore(a,m)})(window,document,'script',
  '//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-63557333-1', 'auto');
  ga('send', 'pageview');
</script>


  </body>
</html>
