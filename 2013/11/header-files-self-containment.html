<!doctype html><html lang=en xmlns=http://www.w3.org/1999/xhtml xmlns:fb=http://ogp.me/ns/fb#><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta property="og:site_name" content="Julio Merino (jmmv.dev)"><meta property="twitter:site" content="@jmmv"><title>Header files: Self-containment - Julio Merino (jmmv.dev)</title>
<meta property="og:title" content="Header files: Self-containment - Julio Merino (jmmv.dev)"><meta property="twitter:title" content="Header files: Self-containment - Julio Merino (jmmv.dev)"><meta name=description content="The rule The mere fact of including a given header file, without including any other beforehand, should not be enough of a reason for the build to break. This means that the header file should be self-contained, and for this to be the case, such header file has to pull in any dependencies that it explicitly requires (and no more).
Interestingly, note that this does not mean that a header file must include everything it may ever need to be fully usable.
"><meta property="og:description" content="The rule The mere fact of including a given header file, without including any other beforehand, should not be enough of a reason for the build to break. This means that the header file should be self-contained, and for this to be the case, such header file has to pull in any dependencies that it explicitly requires (and no more).
Interestingly, note that this does not mean that a header file must include everything it may ever need to be fully usable.
"><meta property="twitter:description" content="The rule The mere fact of including a given header file, without including any other beforehand, should not be enough of a reason for the build to break. This means that the header file should be ‚Ä¶"><meta name=author content="Julio Merino"><meta property="twitter:creator" content="@jmmv"><meta name=generator content="Hugo 0.145.0"><meta property="og:url" content="https://jmmv.dev/2013/11/header-files-self-containment.html"><meta property="og:type" content="blog"><meta property="twitter:card" content="summary"><link rel=canonical href=https://jmmv.dev/2013/11/header-files-self-containment.html><link rel=alternate type=application/rss+xml title="Julio Merino (jmmv.dev)" href=/feed.xml><link rel=stylesheet href=/sass/main.min.cb91349cd93211a37e7d5dc131c35a170fc795721c03373cd05571327eea206b.css><link rel=stylesheet href=/css/chroma.css><link rel=icon type=image/png href=/images/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/images/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicons/favicon-96x96.png sizes=96x96><meta property="og:image" content="/images/favicons/favicon-1200x1200.png"><meta property="twitter:image" content="https://jmmv.dev/images/favicons/favicon-1200x1200.png"><script>const SITE_ID="e8da9f62-b7ac-4fe9-bf20-7c527199a376",BASE_URL="https://jmmv.dev/"</script></head><body><header class=site-header><nav class="navbar navbar-expand-md fixed-top navbar-dark bg-primary"><a class=navbar-brand href=/><img src=/images/favicons/favicon-30x30.png width=30 height=30 class="d-inline-block align-top" alt>
&nbsp;jmmv.dev
</a><button class=navbar-toggler type=button data-toggle=collapse data-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarSupportedContent><ul class="navbar-nav mr-auto"><li class=nav-item><a class=nav-link href=/about.html>About</a></li><li class=nav-item><a class=nav-link href=/blog.html>Blog</a></li><li class=nav-item><a class=nav-link href=/resume.html>Resume</a></li><li class=nav-item><a class=nav-link href=/software.html>Software</a></li></ul><ul class="navbar-nav mr-4"><li class=nav-item><a class=nav-link href=/archive.html>Archive</a></li><li class=nav-item><a class=nav-link href=/series.html>Series</a></li><li class=nav-item><a class=nav-link href=/tags.html>Tags</a></li></ul><form class=form-inline method=get role=search action=https://www.google.com/search><div class=input-group><input type=search name=query class=form-control placeholder=Search aria-label=Search><div class=input-group-append><button type=submit value=Search class="btn btn-light">
<img src=/octicons/search.svg></button></div></div><input type=hidden name=sitesearch value=https://jmmv.dev/></form></div></nav></header><div class=page-header><div class=container><h1>Header files: Self-containment</h1><p>November 25, 2013 &#183;
About 4 minutes
&#183;
Tags:
<a href=/tags/header-files>header-files</a></p><p class=post-meta-p>This article is part number
3 of 9 of the
<a href=/series.html#Header%20files><b>Header files</b></a> series.</p></div></div><div class="container post-body"><div class=row><div class=col-md-9><div class=row><div class=col><article><h1 id=the-rule>The rule</h1><p>The mere fact of <em>including</em> a given header file, without including any other beforehand, should not be enough of a reason for the <em>build</em> to break. This means that the header file should be self-contained, and for this to be the case, such header file has to pull in any dependencies that it <strong>explicitly requires</strong> (and no more).</p><p>Interestingly, note that this does <em>not</em> mean that a header file must include <em>everything</em> it may ever need to be fully <em>usable</em>.</p><h1 id=the-example>The example</h1><p>Let&rsquo;s take a look at an example to give some meaning to the above. Consider a <code>thelog</code> library that implements functionality to write to a log file and provides various supporting data types. This library is composed of the following files:</p><ul><li><code>thelog/delta.h</code>: Defines the <code>struct delta</code> type. Includes no other header file.</li><li><code>thelog/log_entry.h</code>: Defines the <code>struct log_entry</code> type and helper functions.</li><li><code>thelog/timestamp.h</code>: Defines the <code>struct timestamp</code> type. Includes no other header file.</li><li><code>thelog/user.h</code>: Defines the <code>struct user</code> type. Includes no other header file.</li></ul><p>With these types in mind, the <code>thelog/log_entry.h</code> file could look like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#if !defined(THELOG_LOG_ENTRY_H)
</span></span></span><span class=line><span class=cl><span class=cp>#define THELOG_LOG_ENTRY_H
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;thelog/user.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;thelog/timestamp.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=n>log_entry</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>user</span> <span class=n>caller</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>timestamp</span> <span class=n>start_time</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>timestamp</span> <span class=n>end_time</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=n>delta</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=n>delta</span><span class=o>*</span> <span class=nf>log_entry_length</span><span class=p>(</span><span class=k>const</span> <span class=k>struct</span> <span class=n>log_entry</span><span class=o>*</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>#endif  </span><span class=cm>/* !defined(THELOG_LOG_ENTRY_H) */</span><span class=cp>
</span></span></span></code></pre></div><p>Take a close look at the highlighted types and compare those to the included header files. Notice anything? We are only including header files for 2 out of the 3 referenced types and using a forward declaration for the third. Why is that?</p><p>Simple. The <code>struct user</code> and <code>struct timestamp</code> data types are instantiated in this header file and determine the size of the log entry. In order to ever instantiate such a structure, you must know what all of its dependencies are, so for the build to work, you have to pull in their definitions which conveniently live in separate header files.</p><p>On the other hand, the prototype definition of <code>log_entry_length</code> does not require any knowledge of the <em>specifics</em> of its return type: knowing only that the type exists is enough to yield a valid function declaration, and thus a forward declaration is <em>sufficient</em> to fulfill the build requirements.</p><p>So what&rsquo;s up with that <code>struct delta</code>? If the user ever calls the <code>log_entry_length</code> function, he will have to include <code>thelog/delta.h</code> on his own as a hidden dependency anyway and thus encapsulation is broken! <strong>False.</strong> The user will only need to include this other header file if he wishes to mess around with the <em>internals</em> of the type itself. And if he ever does that, then the user code gains a <em>direct</em> dependency on this other data type and thus the user code should be explicitly including the other header file anyway. See &ldquo;<a href=https://code.google.com/p/include-what-you-use/wiki/WhyIWYU>Why Include What You Use?</a>&rdquo; for some details on this.</p><h1 id=the-exception>The exception</h1><p>The exception? There <em>should</em> be none (in my opinion), but they exist. Traditionally, and unfortunately, many files under <code>sys/</code> are <em>not</em> self-contained. This has been a common source of <a href=http://bikeshed.org/>bikesheds</a> in NetBSD (and possibly elsewhere) although I&rsquo;m having trouble now finding a reference.</p><p>When you use symbols in any of these special header files, make sure to check the relevant manual pages to see which dependent header files you require. And&mldr; beware that these dependencies vary across operating systems, so you are in for a portability nightmare.</p><h1 id=the-trick>The trick</h1><p>There is a very simple trick to routinely ensure your header files are self-contained.</p><p>In the past, I used very complex approaches to validate this which ranged from building one-liner source files with the inclusion of the desired header file to plugging these into ATF-based test cases. The boilerplate required to perform this validation was astonishing and a waste of time. As it turns out, there is a much simpler approach ‚Äî and, to tell you the truth, writing about this little trick is what triggered <a href=http://julipedia.meroh.net/search/label/header-files>this whole series on header files</a>!</p><p>So what is it? Easy: <em>include the header file for the module you are implementing at the very beginning of your module</em>. That&rsquo;s it! No more no less. For example: in the implementation of a module <code>resources.c</code>, make sure to include its corresponding <code>resources.h</code> before anything else. By doing this, you have one test case for every header file to ensure that the header file is self-contained. If any of your header files is not self-contained, the build will fail as soon as you compile the offending module.</p><p>In the case of header-only modules, you can achieve this same effect by following this trick in the test program corresponding the header file. Actually, if you have one test program per every module (which you <em>do</em> have, right?) you should apply the trick mentioned here both to the <code>.c</code> implementation and to the test program.</p></article><p class=post-meta-p>This article is part number
3 of 9 of the
<a href=/series.html#Header%20files><b>Header files</b></a> series.</p></div></div><div class="container post-links"><div class=row><div class="col mr-auto text-left"><span><a href=https://jmmv.dev/2013/11/header-files-multiple-inclusion.html>&#171; Previous</a></span></div><div class="col text-center"><span><a href=/archive.html>All posts</a></span></div><div class="col ml-auto text-right"><span><a href=https://jmmv.dev/2013/11/three-productive-days-on-kyua-front.html>Next &#187;</a></span></div></div></div><div class="container post-votes"><div class=row><div class="col-lg-4 my-2"><div class=row><div class=col><a onclick=voteThumbsUp() class="btn btn-block btn-outline-success" id=thumbs-up-btn>üëç
(<span id=thumbs-up-count>0</span>)</a></div><div class=col><a onclick=voteThumbsDown() class="btn btn-block btn-outline-danger" id=thumbs-down-btn>üëé
(<span id=thumbs-down-count>0</span>)</a></div></div></div><div class="col-lg-8 my-2 d-none d-sm-block"><div class=row><div class="col-md-4 text-center"><a href="https://www.reddit.com/submit?title=Header+files%3A+Self-containment&amp;url=https%3A%2F%2Fjmmv.dev%2F2013%2F11%2Fheader-files-self-containment.html" class="btn btn-block btn-outline-primary">Share on
<img src=/images/badges/reddit.png alt=Reddit width=24 height=24></a></div><div class="col-md-4 text-center"><a href="https://news.ycombinator.com/submitlink?t=Header+files%3A+Self-containment&amp;u=https%3A%2F%2Fjmmv.dev%2F2013%2F11%2Fheader-files-self-containment.html" class="btn btn-block btn-outline-primary">Share on
<img src=/images/badges/ycombinator.png alt="Hacker News" width=24 height=24></a></div><div class="col-md-4 text-center"><a href="https://twitter.com/intent/tweet?status=Header+files%3A+Self-containment+%E2%80%94+https%3A%2F%2Fjmmv.dev%2F2013%2F11%2Fheader-files-self-containment.html+%E2%80%94+cc+%40jmmv" class="btn btn-block btn-outline-primary">Share on
<img src=/images/badges/Twitter_Social_Icon_Circle_Color.png alt=Twitter width=24 height=24></a></div></div></div></div><div class="row my-4" id=postCommentRow><div class=col><div class=media><img class=mr-3 src=/octicons/pencil.svg width=32px height=32px><div class="media-body container"><form method=post id=newPost><div class=row><div class="col my-1"><textarea class=form-control rows=1 id=postCommentContent onclick=showPostComment() placeholder="Leave a comment"></textarea></div></div><div class="row newPostControls" style=display:none><div class="col my-1 form-group"><label for=postCommentAuthor>Your name (optional):</label>
<input type=text class=form-control id=postCommentAuthor></div></div><div class="row newPostControls" style=display:none><div class="col my-1 form-group"><label for=postCommentEmail>Your email (optional):</label>
<input type=text class=form-control type=email id=postCommentEmail>
<small class="form-text text-muted">Invisible to all readers; if provided, you will receive notifications when replied to (not implemented yet)</small></div></div><div class=row id=postCommentError style=display:none><div class="col mt-1 alert-danger"><p></p></div></div><div class="row newPostControls" style=display:none><button class="col-md-3 my-1 btn btn-primary" type=submit id=submitCommentButton>Post</button>
<small class="col-md-9 my-1 text-muted">Comments are subject to moderation. This feature is experimental and is powered by <a href=/software/endtracker.html>EndTRACKER</a>. If you experience any issues, please <a href=/about.html#contact>contact me off-band</a>.</small></div></form></div></div></div></div><script>function hidePostComment(){var t,e=document.getElementById("postCommentContent");e.rows=1,e.value="",t=document.getElementsByClassName("newPostControls"),Array.prototype.forEach.call(t,function(e){e.style.display="none"})}function showPostComment(){var e,t=document.getElementById("postCommentContent");t.rows=5,e=document.getElementsByClassName("newPostControls"),Array.prototype.forEach.call(e,function(e){e.style.display=""})}const form=document.querySelector("#newPost");form.onsubmit=function(e){e.preventDefault();let t=document.getElementById("postCommentAuthor").value,n=document.getElementById("postCommentEmail").value,s=document.getElementById("postCommentContent").value;postComment(t,n,s,hidePostComment)}</script></div></div><div class="col-md-3 sidebar d-none d-md-block"><div class=row><div class="col text-center p-2"><p><a href=/about.html class=clear-link><img src=/images/avatars/20181124-snow.jpg class="rounded-circle shadow my-2" style=width:100px><br><b>Julio Merino</b><br>A blog on operating systems, programming languages, testing, build systems, my own software
projects and even personal productivity. Specifics include FreeBSD, Linux, Rust, Bazel and
EndBASIC.</a></p><div class=row><div class=col><div class=form-group><form action=https://endtracker.azurewebsites.net/api/sites/e8da9f62-b7ac-4fe9-bf20-7c527199a376/subscribers/add method=post><input type=text name=email placeholder="Enter your email" class="form-control input-sm text-center my-1">
<button type=submit class="btn btn-primary btn-block my-1">Subscribe</button></form></div></div></div><div class="row px-2"><div class="col-sm-5 text-left"><small><span class=subscriber-count>0</span> subscribers</small></div><div class="col-sm-7 text-right"><p><a rel=me href=https://mastodon.online/@jmmv><img src=/images/badges/mastodon-logo.svg width=32px height=32px alt="Follow @jmmv on Mastodon">
</a><a href="https://twitter.com/intent/follow?original_referer=https%3A%2F%2Fjmmv.dev%2F&amp;screen_name=jmmv"><img src=/images/badges/Twitter_logo_blue.svg width=32px height=32px alt="Follow @jmmv on Twitter">
</a><a href=/feed.xml><img src=/images/badges/feed-icon-28x28.png alt="RSS feed"></a></p></div></div></div></div><div class=row><div class=col><h2>Featured software</h2><ul><li class=overflow-ellipsis><a href=https://www.endbasic.dev/ target=_blank>EndBASIC: Online BASIC+DOS env</a></li><li class=overflow-ellipsis><a href=https://endtracker.azurewebsites.net/ target=_blank>EndTRACKER: Services for static sites</a></li></ul></div></div><div class=row><div class=col><h2>Featured posts</h2><ul><li class=overflow-ellipsis><a href=/2023/06/fast-machines-slow-machines.html>Fast machines, slow machines</a></li><li class=overflow-ellipsis><a href=/2022/12/endbasic-0.10.html>EndBASIC 0.10: Core language, evolved</a></li><li class=overflow-ellipsis><a href=/2022/10/bye-microsoft-hi-snowflake.html>Farewell, Microsoft; hello, Snowflake!</a></li><li class=overflow-ellipsis><a href=/2022/05/rust-is-hard-but-does-it-matter.html>Rust is hard, yes, but does it matter?</a></li><li class=overflow-ellipsis><a href=/2022/04/rust-traits-and-dependency-injection.html>Rust traits and dependency injection</a></li><li class=overflow-ellipsis><a href=/2022/03/a-year-on-windows-intro.html>A year on Windows: Introduction</a></li><li class=overflow-ellipsis><a href=/2021/04/always-be-quitting.html>Always be quitting</a></li><li class=overflow-ellipsis><a href=/2021/02/google-monorepos-and-caching.html>How does Google keep build times low?</a></li><li class=overflow-ellipsis><a href=/2020/12/google-no-clean-builds.html>How does Google avoid clean builds?</a></li><li class=overflow-ellipsis><a href=/2020/12/unit-testing-a-console-app.html>Unit-testing a console app (a text editor)</a></li><li class=overflow-ellipsis><a href=/essays.html#featured>More...</a></li></ul></div></div></div></div></div><footer class=container-fluid><div class=row><div class="col-4 order-2 text-right"><p class=float-right><a href=#>Back to top</a></p></div><div class="col-8 order-1 mr-auto"><p>Copyright 2004&ndash;2025
Julio Merino</p></div></div></footer><script type=module>
  import { addAnchorsToHeaders, addElementClasses, BatchClient } from "\/js\/main.0de73782e9e0fbcb4184fb5793949b3b0d0ada16455df89320415b4dcc052f88.js";

  var batchClient = new BatchClient(SITE_ID);
  batchClient.doAll({
    put_request: true, get_comments: true, get_subscriber_count: true, get_votes: true });

  window.voteThumbsUp = function() { batchClient.voteThumbsUp(); }
  window.voteThumbsDown = function() { batchClient.voteThumbsDown(); }

  window.postComment = function(...args) {
    batchClient.postComment(...args);
  };

  addAnchorsToHeaders();
  addElementClasses();
</script><noscript><img src="https://hugo-dynamic.jmmv.dev/api/sites/e8da9f62-b7ac-4fe9-bf20-7c527199a376/pages/aHR0cHM6Ly9qbW12LmRldi8yMDEzLzExL2hlYWRlci1maWxlcy1zZWxmLWNvbnRhaW5tZW50Lmh0bWw=/stamp.gif" style=display:none></noscript></body></html>