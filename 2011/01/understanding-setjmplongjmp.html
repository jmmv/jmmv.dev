<!DOCTYPE html>
<html>
  <head>
    

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<!-- The above 3 meta tags *must* come first in the head; any other head
      content must come *after* these tags -->

<meta name="description"
      content="For a long time, I have been aware of the existence of the standard C functions setjmp and longjmp and that they can be used to simulate exceptions in C code...">
<meta name="author" content="Julio Merino">

<meta content="http://julio.meroh.net/2011/01/understanding-setjmplongjmp.html" property="og:url">

<link rel="canonical" href="http://julio.meroh.net/2011/01/understanding-setjmplongjmp.html">
<link rel="alternate" type="application/rss+xml" title="Julio Merino" href="http://julio.meroh.net/feed.xml" />

<link rel="stylesheet" href="/css/main.css">

<!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
<!--[if lt IE 9]>
  <script src="/js/html5shiv-3.7.2.min.js"></script>
  <script src="/js/respond-1.4.2.min.js"></script>
<![endif]-->

    <title>Understanding setjmp/longjmp - Julio Merino</title>
    <meta content="Understanding setjmp/longjmp - Julio Merino" property="og:title">
  </head>

  <body>
    <header class="site-header">

<nav class="navbar navbar-default navbar-fixed-top">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed"
              data-toggle="collapse" data-target="#navbar"
              aria-expanded="false" aria-controls="navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">Julio Merino</a>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        
          
            
              
                <li><a class="page-link"
                href="/about/"
                >About</a></li>
              
            
          
        
          
            
          
        
          
            
          
        
          
            
              
                <li><a class="page-link"
                href="/essays/"
                >Essays</a></li>
              
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
              
                <li><a class="page-link"
                href="/software/"
                >Software</a></li>
              
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
              
                <li><a class="page-link"
                href="/work/"
                >Work</a></li>
              
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
      </ul>

      <form class="navbar-form navbar-right" method="get" role="search"
            action="http://www.google.com/search">
          <div class="form-group">
            <input type="text" name="query" class="form-control"
                   placeholder="Search">
            <input type="hidden" name="sitesearch" value="http://julio.meroh.net">
          </div>
          <button type="submit" value="Search" class="btn btn-default">
            <span class="glyphicon glyphicon-search" aria-hidden="true"></span>
          </button>
      </form>
    </div>
  </div>
</nav>

</header>


    <div class="page-header">
      <div class="container">
        <h1>Understanding setjmp/longjmp</h1>

        <p><!-- From http://alanwsmith.com/jekyll-liquid-date-formatting-examples -->

January

2nd,
  
2011
at
08:22 UTC
        
        </p>

        
      </div>
    </div>

    <div class="container">
      <article>
        For a long time, I have been aware of the existence of the standard C functions <tt>setjmp</tt> and <tt>longjmp</tt> and that they can be used to simulate exceptions in C code. However, it wasn't until yesterday that I had to use them... and it was not trivial. The documentation for these functions tends to be confusing, and understanding them required looking for additional documents and a bit of experimentation. Let's see if this post helps in clarifying how these functions work.<br /><br />The first call to <tt>setjmp</tt> causes the process state (stack, CPU registers, etc.) to be saved in the provided <tt>jmp_buf</tt> structure and, <i>then</i>, a value of 0 to be returned. A subsequent call to <tt>longjmp</tt> with the same <tt>jmp_buf</tt> structure causes the process to go "back in time" to the state stored in said structure. The way this is useful is that, when going back in time, we tweak the return value of the <tt>setjmp</tt> call so we can actually run a second (or third or more) path as if nothing had happened.<br /><br />Let's see an example:<pre>#include &lt;setjmp.h&gt;<br />#include &lt;stdio.h&gt;<br />#include &lt;stdlib.h&gt;<br /><br />static jmp_buf buf;<br /><br />static void<br />myfunc(void)<br />{<br />   printf("In the function.n");<br /><br />   ... do some complex stuff ...<br /><br />   /* Go back in time: restore the execution context of setjmp<br />    * but make the call return 1 instead of 0. */<br />   longjmp(buf, 1);<br /><br />   printf("Not reached.n");<br />}<br /><br />int<br />main(void) {<br />   if (setjmp(buf) == 0) {<br />       /* Try block. */<br />       printf("Trying some function that may throw.n");<br />       myfunc();<br />       printf("Not reached.n");<br />   } else {<br />       /* Catch block. */<br />       printf("Exception caught.n");<br />   }<br />   return EXIT_SUCCESS;<br />}</pre>The example above shows the following when executed:<pre>Trying some function that may throw.<br />In the function.<br />Exception caught.</pre>So, what happened above? The code starts by calling <tt>setjmp</tt> to record the execution state and the call returns 0, which causes the first part of the conditional to run. You can think of this clause as the "try" part of an exception-based code. At some point during the execution of <tt>myfunc</tt>, an error is detected and is "thrown" by a call to <tt>longjmp</tt> and a value of 1. This causes the process to go back to the execution of <tt>setjmp</tt> but this time the call returns 1, which causes the second part of the conditional to run. You can think of this second clause as the "catch" part of an exception-based code.<div><br /></div><div>It is still unclear to me what the "execution context" stored in <tt>jmp_buf</tt> is: the documentation does not explain what kind of resources are correctly unwinded when the call to <tt>longjmp</tt> is made... which makes me wary of using this technique for exception-like handling purposes. Oh, and this is even less clear in the context of C++ code and, e.g. calls to destructors. Would be nice to expand the description of these APIs in the manual pages.</div>

      </article>

      <div class="post-links">
        <p>
          

          
          <a href="http://julipedia.meroh.net/2011/01/understanding-setjmplongjmp.html">Posted on
          The Julipedia</a>
          &middot;
          

          

          <a href="/feed.xml">Subscribe
          via RSS</a>
          &middot;
          <a href="/blog/">Go to posts index</a>
        </p>

        <form class="form-inline"
            action="https://feedburner.google.com/fb/a/mailverify"
            method="post"
            target="popupwindow"
            onsubmit="window.open('https://feedburner.google.com/fb/a/mailverify?uri=jmmv', 'popupwindow', 'scrollbars=yes,width=550,height=520');return true">
          <div class="form-group form-group-sm">
            <input type="text" style="width: 400px" name="email"
                    placeholder="Enter your email to subscribe to new posts"
                    class="form-control input-sm"/>
          </div>
          <button type="submit" value="Subscribe"
                  class="btn btn-default btn-sm">
            <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>
          </button>
          &nbsp;&nbsp;&nbsp;Delivered by
          <input type="hidden" value="jmmv" name="uri"/>
          <input type="hidden" name="loc" value="en_US"/>
          <a href="https://feedburner.google.com" target="_blank">FeedBurner</a>
        </form>
      </div>

      
      <div id="disqus_thread">
        <script>
          var disqus_config = function () {
            this.page.url = "http://julio.meroh.net/2011/01/understanding-setjmplongjmp.html";
            this.page.identifier = "/2011/01/understanding-setjmplongjmp";
          };
          (function() { // DON'T EDIT BELOW THIS LINE
            var d = document, s = d.createElement('script');

            s.src = '//jmmv.disqus.com/embed.js';

            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
          })();
        </script>
        <noscript>Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments
          powered by Disqus.</a>
        </noscript>
      </div>
      
    </div>

    <div class="container">
  <footer>
    <p class="pull-right"><a href="#">Back to top</a></p>
    <p>Copyright 2016 Julio Merino</p>
  </footer>
</div>

<script src="/js/jquery-1.11.2.min.js">
</script>
<script
  src="/css/bootstrap.min.js">
</script>

<script src="/js/auto-toc-1.0.0.dist.js">
</script>

<script>
$("p:contains('NOTE: ')").addClass("callout callout-info");
$("p:contains('IMPORTANT: ')").addClass("callout callout-info");
$("p:contains('WARNING: ')").addClass("callout callout-warning");
$("p:contains('DANGER: ')").addClass("callout callout-danger");
</script>


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;
  m.parentNode.insertBefore(a,m)})(window,document,'script',
  '//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-63557333-1', 'auto');
  ga('send', 'pageview');
</script>


  </body>
</html>
