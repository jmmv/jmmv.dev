<!DOCTYPE html>
<html>
  <head>
    

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<!-- The above 3 meta tags *must* come first in the head; any other head
      content must come *after* these tags -->

<meta name="description"
      content="If you use #ifdef conditionals in your code to check for portability features, be sure to always define a catch-all else clause that actually does something,...">
<meta name="author" content="Julio Merino">

<meta content="http://julio.meroh.net/2010/04/always-define-else-clause-for.html" property="og:url">

<link rel="canonical" href="http://julio.meroh.net/2010/04/always-define-else-clause-for.html">
<link rel="alternate" type="application/rss+xml" title="Julio Merino" href="http://julio.meroh.net/feed.xml" />

<link rel="stylesheet" href="/css/main.css">

<!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
<!--[if lt IE 9]>
  <script src="/js/html5shiv-3.7.2.min.js"></script>
  <script src="/js/respond-1.4.2.min.js"></script>
<![endif]-->

    <title>Always define an else clause for portability #ifdefs - Julio Merino</title>
    <meta content="Always define an else clause for portability #ifdefs - Julio Merino" property="og:title">
  </head>

  <body>
    <header class="site-header">

<nav class="navbar navbar-default navbar-fixed-top">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed"
              data-toggle="collapse" data-target="#navbar"
              aria-expanded="false" aria-controls="navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">Julio Merino</a>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        
          
            
              
                <li><a class="page-link"
                href="/about/"
                >About</a></li>
              
            
          
        
          
            
          
        
          
            
          
        
          
            
              
                <li><a class="page-link"
                href="/essays/"
                >Essays</a></li>
              
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
              
                <li><a class="page-link"
                href="/software/"
                >Software</a></li>
              
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
              
                <li><a class="page-link"
                href="/work/"
                >Work</a></li>
              
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
          
            
          
        
      </ul>

      <form class="navbar-form navbar-right" method="get" role="search"
            action="http://www.google.com/search">
          <div class="form-group">
            <input type="text" name="query" class="form-control"
                   placeholder="Search">
            <input type="hidden" name="sitesearch" value="http://julio.meroh.net">
          </div>
          <button type="submit" value="Search" class="btn btn-default">
            <span class="glyphicon glyphicon-search" aria-hidden="true"></span>
          </button>
      </form>
    </div>
  </div>
</nav>

</header>


    <div class="page-header">
      <div class="container">
        <h1>Always define an else clause for portability #ifdefs</h1>

        <p><!-- From http://alanwsmith.com/jekyll-liquid-date-formatting-examples -->

April

22nd,
  
2010
at
13:51 UTC
        
        </p>

        
      </div>
    </div>

    <div class="container">
      <article>
        If you use <tt>#ifdef</tt> conditionals in your code to check for portability features, be sure to always define a catch-all else clause that actually does something, even if this something is to error out.<br /><br />Consider the following code snippet, quoted from gamin's <tt>tests/testing.c</tt> file:<pre>if (arg != NULL) {<br />#ifdef HAVE_SETENV<br />  setenv("GAM_CLIENT_ID", arg, 1);<br />#elif HAVE_PUTENV<br />  char *client_id = malloc (strlen (arg) + sizeof "GAM_CLIENT_ID=");<br />  if (client_id)<br />  {<br />      strcpy (client_id, "GAM_CLIENT_ID=");<br />      strcat (client_id, arg);<br />      putenv (client_id);<br />  }<br />#endif /* HAVE_SETENV */<br />}<br />ret = FAMOpen(&amp;(testState.fc));</pre>The <tt>FAMOpen</tt> method queries the <tt>GAM_CLIENT_ID</tt> environment variable to set up the connections parameters to the FAM server. If the variable is not defined, the connection will still work, even though it will use some default internal value. In the test code above, the variable is explicitly set to let the tests use a separate server instance.<br /><br />Now, did you notice that we have to conditional branches? One for <tt>setenv</tt> and one for <tt>putenv</tt>? It seems reasonable to assume that one or the other must be present on any Unix system. Unfortunately, this is flawed:<br /><ul><li>What happens if the code forgets to include <tt>config.h</tt>?</li><li>What happens if the configure script fails to detect <i>both</i> <tt>setenv</tt> and <tt>putenv</tt>? This is not that uncommon, given how some configure scripts are written.</li><li>What happens if neither <tt>setenv</tt> nor <tt>putenv</tt> are available?<br /></li></ul>The answer to the three questions is: in the above code snippet, the code <tt>builds just fine</tt> but will misbehave at run time: neither <tt>HAVE_SETENV</tt> nor <tt>HAVE_PUTENV</tt> are defined, so the code will not be able to define the required environment variable. However, <tt>FAMOpen</tt> will later be called and it will not behave as expected because the variable has not been set.<br /><br />Note that this code snippet is just an example. I have seen many more instances of this exact same problem with worse consequences than the above.  Read: they were not part of the test code, but just part of the regular code path.<br /><br />So how do you implement the above in a saner way? You have two alternatives:<br /><ul><li>Add an <tt>#else</tt> clause that contains a fallback implementation. In the case above, we could, for example, prefer to use <tt>setenv</tt> if present because it has a nicer interface, and fall back to <tt>putenv</tt> if not found.<br />This has a disadvantage though: if you forget to include <tt>config.h</tt> or the configure script cannot correctly detect one of the possible implementations (even when present), you will always use the fallback implementation.</li><li>Keep each possible implementation correctly protected by a conditional, but add a <tt>#else</tt> clause that raises an error at <i>build time</i>. This will make sure that you never forget to define at least one of the portability macros for any reason. This is the preferred approach.</li></ul>Following the second suggestion above, the code would get the following structure: <pre>#if defined(HAVE_SETENV)<br />setenv(...);<br />#elif defined(HAVE_PUTENV)<br />putenv(...);<br />#else<br />#   error "Don't know how to set environment variables."<br />#endif</pre>With this code, we can be sure that the code will not build if none of the possible implementations are selected. We can later proceed to investigate why that happened.

      </article>

      <div class="post-links">
        <p>
          

          

          <a href="/feed.xml">Subscribe
          via RSS</a>
          &middot;
          <a href="/blog/">Go to posts index</a>
        </p>

        <form class="form-inline"
            action="https://feedburner.google.com/fb/a/mailverify"
            method="post"
            target="popupwindow"
            onsubmit="window.open('https://feedburner.google.com/fb/a/mailverify?uri=jmmv', 'popupwindow', 'scrollbars=yes,width=550,height=520');return true">
          <div class="form-group form-group-sm">
            <input type="text" style="width: 400px" name="email"
                    placeholder="Enter your email to subscribe to new posts"
                    class="form-control input-sm"/>
          </div>
          <button type="submit" value="Subscribe"
                  class="btn btn-default btn-sm">
            <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>
          </button>
          &nbsp;&nbsp;&nbsp;Delivered by
          <input type="hidden" value="jmmv" name="uri"/>
          <input type="hidden" name="loc" value="en_US"/>
          <a href="https://feedburner.google.com" target="_blank">FeedBurner</a>
        </form>
      </div>

      
      <div id="disqus_thread">
        <script>
          var disqus_config = function () {
            this.page.url = "http://julio.meroh.net/2010/04/always-define-else-clause-for.html";
            this.page.identifier = "/2010/04/always-define-else-clause-for";
          };
          (function() { // DON'T EDIT BELOW THIS LINE
            var d = document, s = d.createElement('script');

            s.src = '//jmmv.disqus.com/embed.js';

            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
          })();
        </script>
        <noscript>Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments
          powered by Disqus.</a>
        </noscript>
      </div>
      
      <p>Comments from the original Blogger-hosted post:</p>
      <script src="https://apis.google.com/js/plusone.js"></script>
      <div class="g-comments"
           data-href="http://julipedia.meroh.net/2010/04/always-define-else-clause-for.html"
           data-first_party_property="BLOGGER"
           data-view_type="FILTERED_POSTMOD">
      </div>
      
      
    </div>

    <div class="container">
  <footer>
    <p class="pull-right"><a href="#">Back to top</a></p>
    <p>Copyright 2016 Julio Merino</p>
  </footer>
</div>

<script src="/js/jquery-1.11.2.min.js">
</script>
<script
  src="/css/bootstrap.min.js">
</script>

<script src="/js/auto-toc-1.0.0.dist.js">
</script>

<script>
$("p:contains('NOTE: ')").addClass("callout callout-info");
$("p:contains('IMPORTANT: ')").addClass("callout callout-info");
$("p:contains('WARNING: ')").addClass("callout callout-warning");
$("p:contains('DANGER: ')").addClass("callout callout-danger");
</script>


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;
  m.parentNode.insertBefore(a,m)})(window,document,'script',
  '//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-63557333-1', 'auto');
  ga('send', 'pageview');
</script>


  </body>
</html>
